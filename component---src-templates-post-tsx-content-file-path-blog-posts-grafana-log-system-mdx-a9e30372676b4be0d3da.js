"use strict";(self.webpackChunkhomepage=self.webpackChunkhomepage||[]).push([[9832],{5020:function(n,a,s){s.r(a),s.d(a,{Head:function(){return b},default:function(){return h}});var e=s(8453),t=s(6540);function p(n){const a=Object.assign({p:"p",span:"span",a:"a",h2:"h2",blockquote:"blockquote",h3:"h3"},(0,e.R)(),n.components);return t.createElement(t.Fragment,null,t.createElement(a.p,null,"新买了服务器果然能为自己创造一个又一个接连不断的需求。例如，笔者想到公网服务器上跑的定时脚本会把日志重定向到指定的文件里，但是并不会自动清理，意味着它们会在几十年后占满笔者的硬盘空间，这是不可接受不可妥协的！"),"\n",t.createElement(a.p,null,"因此在本篇博客里，笔者计划部署统一的日志管理服务，存储来自各个地方的日志信息，既方便管理，也方便快速发现并修复问题。"),"\n",t.createElement(a.p,null,"在 Github 上以 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">log</code>'}})," 为关键词，按星标数排序，目前排名第一的开源软件是 ",t.createElement(a.a,{href:"https://github.com/grafana/grafana"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">grafana/grafana</code>'}})),"。浏览使用文档后觉得它远远超出笔者的需要，但就笔者就爱用大炮打蚊子，遂决定在 Docker 上部署之，作为笔者的日志管理服务。"),"\n",t.createElement(a.h2,null,"部署 Grafana 和 Loki 容器"),"\n",t.createElement(a.p,null,t.createElement(a.a,{href:"https://grafana.org.cn/docs/grafana/latest/"},"Grafana")," 的定位是整合数据查询和展示的客户端，在它背后实际负责日志收集和存储的是 ",t.createElement(a.a,{href:"https://grafana.org.cn/docs/loki/latest/"},"Loki"),"。因此，首先我们需要部署 Grafana 和 Loki 这两个容器。"),"\n",t.createElement(a.blockquote,null,"\n",t.createElement(a.p,null,"笔者在撰写本文时，使用的 Grafana 的版本为 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">12.0</code>'}}),"，Loki 的版本为 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">3.5.x</code>'}}),"。"),"\n"),"\n",t.createElement(a.p,null,"参考 Loki 官方快速开始文档，精简示例里的 ",t.createElement(a.a,{href:"https://github.com/grafana/loki/blob/main/examples/getting-started/docker-compose.yaml"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">docker-compose.yaml</code>'}})," 文件"),"，只保留用于启动 Grafana 和 Loki 这两个服务和其他一些必要服务的容器的配置。简化后的 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">docker-compose.yaml</code>'}})," 配置文件如下："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>\n<span class="token key atrule">networks</span><span class="token punctuation">:</span>\n  <span class="token key atrule">loki</span><span class="token punctuation">:</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token comment"># Loki 日志读服务</span>\n  <span class="token key atrule">read</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/loki<span class="token punctuation">:</span>latest\n    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"-config.file=/etc/loki/config.yaml -target=read"</span>\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> 3101<span class="token punctuation">:</span><span class="token number">3100</span>\n      <span class="token punctuation">-</span> <span class="token number">7946</span>\n      <span class="token punctuation">-</span> <span class="token number">9095</span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> ./loki<span class="token punctuation">-</span>config.yaml<span class="token punctuation">:</span>/etc/loki/config.yaml\n    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> minio\n    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>\n      <span class="token key atrule">test</span><span class="token punctuation">:</span>\n        <span class="token punctuation">[</span>\n          <span class="token string">"CMD-SHELL"</span><span class="token punctuation">,</span>\n          <span class="token string">"wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"</span><span class="token punctuation">,</span>\n        <span class="token punctuation">]</span>\n      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s\n      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 5s\n      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">5</span>\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span> <span class="token important">&amp;loki-dns</span>\n      <span class="token key atrule">loki</span><span class="token punctuation">:</span>\n        <span class="token key atrule">aliases</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> loki\n\n  <span class="token comment"># Loki 日志写服务</span>\n  <span class="token key atrule">write</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/loki<span class="token punctuation">:</span>latest\n    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"-config.file=/etc/loki/config.yaml -target=write"</span>\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> 3102<span class="token punctuation">:</span><span class="token number">3100</span>\n      <span class="token punctuation">-</span> <span class="token number">7946</span>\n      <span class="token punctuation">-</span> <span class="token number">9095</span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> ./loki<span class="token punctuation">-</span>config.yaml<span class="token punctuation">:</span>/etc/loki/config.yaml\n    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>\n      <span class="token key atrule">test</span><span class="token punctuation">:</span>\n        <span class="token punctuation">[</span>\n          <span class="token string">"CMD-SHELL"</span><span class="token punctuation">,</span>\n          <span class="token string">"wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"</span><span class="token punctuation">,</span>\n        <span class="token punctuation">]</span>\n      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s\n      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 5s\n      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">5</span>\n    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> minio\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*loki-dns</span>\n\n  <span class="token comment"># MinIO 对象存储服务；负责持久化存储 Loki 的日志数据</span>\n  <span class="token key atrule">minio</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> minio/minio\n    <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> sh\n      <span class="token punctuation">-</span> <span class="token punctuation">-</span>euc\n      <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">\n        mkdir -p /data/loki-data &amp;&amp; \\\n        mkdir -p /data/loki-ruler &amp;&amp; \\\n        minio server /data --console-address ":9001"</span>\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> MINIO_ROOT_USER=loki <span class="token comment"># 数据库管理员用户名</span>\n      <span class="token punctuation">-</span> MINIO_ROOT_PASSWORD=supersecret <span class="token comment"># 数据库管理员用户登录密码</span>\n      <span class="token punctuation">-</span> MINIO_PROMETHEUS_AUTH_TYPE=public\n      <span class="token punctuation">-</span> MINIO_UPDATE=off\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token number">9000</span>\n      <span class="token punctuation">-</span> <span class="token number">9001</span> <span class="token comment"># 监听 Web UI 端口</span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> ./.data/minio<span class="token punctuation">:</span>/data\n    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>\n      <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"CMD"</span><span class="token punctuation">,</span> <span class="token string">"curl"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token string">"http://localhost:9000/minio/health/live"</span><span class="token punctuation">]</span>\n      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 15s\n      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 20s\n      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">5</span>\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> loki\n\n  <span class="token comment"># Grafana 日志可视化服务</span>\n  <span class="token key atrule">grafana</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/grafana<span class="token punctuation">:</span>latest\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> GF_PATHS_PROVISIONING=/etc/grafana/provisioning\n      <span class="token punctuation">-</span> GF_AUTH_ANONYMOUS_ENABLED=true <span class="token comment"># 允许匿名访问</span>\n      <span class="token punctuation">-</span> GF_AUTH_ANONYMOUS_ORG_ROLE=Admin <span class="token comment"># 匿名访问用户角色为 Admin，可以使用所有功能；如果控制台可以通过公网访问，应当对权限进行相应控制</span>\n    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> gateway\n    <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> sh\n      <span class="token punctuation">-</span> <span class="token punctuation">-</span>euc\n      <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">\n        mkdir -p /etc/grafana/provisioning/datasources\n        cat &lt;&lt;EOF > /etc/grafana/provisioning/datasources/ds.yaml\n        apiVersion: 1\n        datasources:\n          - name: Loki\n            type: loki\n            access: proxy\n            url: http://gateway:3100\n            jsonData:\n              httpHeaderName1: "X-Scope-OrgID"\n            secureJsonData:\n              httpHeaderValue1: "YOUR_TENANT_ID"\n        EOF\n        /run.sh</span>\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">"3000:3000"</span>\n    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>\n      <span class="token key atrule">test</span><span class="token punctuation">:</span>\n        <span class="token punctuation">[</span>\n          <span class="token string">"CMD-SHELL"</span><span class="token punctuation">,</span>\n          <span class="token string">"wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"</span><span class="token punctuation">,</span>\n        <span class="token punctuation">]</span>\n      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s\n      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 5s\n      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">5</span>\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> loki\n\n  <span class="token comment"># Loki 其它后端服务</span>\n  <span class="token key atrule">backend</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/loki<span class="token punctuation">:</span>latest\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> ./loki<span class="token punctuation">-</span>config.yaml<span class="token punctuation">:</span>/etc/loki/config.yaml\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">"3100"</span>\n      <span class="token punctuation">-</span> <span class="token string">"7946"</span>\n    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"-config.file=/etc/loki/config.yaml -target=backend -legacy-read-mode=false"</span>\n    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> gateway\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> loki\n\n  <span class="token comment"># Nginx 网关；负责转发请求到对应的 Loki 服务</span>\n  <span class="token key atrule">gateway</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest\n    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> read\n      <span class="token punctuation">-</span> write\n    <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> sh\n      <span class="token punctuation">-</span> <span class="token punctuation">-</span>euc\n      <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">\n        cat &lt;&lt;EOF > /etc/nginx/nginx.conf\n        user  nginx;\n        worker_processes  5;  ## Default: 1</span>\n\n        events <span class="token punctuation">{</span>\n          worker_connections   1000;\n        <span class="token punctuation">}</span>\n\n        http <span class="token punctuation">{</span>\n          resolver 127.0.0.11;\n\n          server <span class="token punctuation">{</span>\n            listen             3100;\n\n            location = / <span class="token punctuation">{</span>\n              return 200 \'OK\';\n              auth_basic off;\n            <span class="token punctuation">}</span>\n\n            location = /api/prom/push <span class="token punctuation">{</span>\n              proxy_pass       http<span class="token punctuation">:</span>//write<span class="token punctuation">:</span>3100\\$$request_uri;\n            <span class="token punctuation">}</span>\n\n            location = /api/prom/tail <span class="token punctuation">{</span>\n              proxy_pass       http<span class="token punctuation">:</span>//read<span class="token punctuation">:</span>3100\\$$request_uri;\n              proxy_set_header Upgrade \\$$http_upgrade;\n              proxy_set_header Connection "upgrade";\n            <span class="token punctuation">}</span>\n\n            location ~ /api/prom/.* <span class="token punctuation">{</span>\n              proxy_pass       http<span class="token punctuation">:</span>//read<span class="token punctuation">:</span>3100\\$$request_uri;\n            <span class="token punctuation">}</span>\n\n            location = /loki/api/v1/push <span class="token punctuation">{</span>\n              proxy_pass       http<span class="token punctuation">:</span>//write<span class="token punctuation">:</span>3100\\$$request_uri;\n            <span class="token punctuation">}</span>\n\n            location = /loki/api/v1/tail <span class="token punctuation">{</span>\n              proxy_pass       http<span class="token punctuation">:</span>//read<span class="token punctuation">:</span>3100\\$$request_uri;\n              proxy_set_header Upgrade \\$$http_upgrade;\n              proxy_set_header Connection "upgrade";\n            <span class="token punctuation">}</span>\n\n            location ~ /loki/api/.* <span class="token punctuation">{</span>\n              proxy_pass       http<span class="token punctuation">:</span>//read<span class="token punctuation">:</span>3100\\$$request_uri;\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        EOF\n        /docker<span class="token punctuation">-</span>entrypoint.sh nginx <span class="token punctuation">-</span>g "daemon off;"\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">"3100:3100"</span>\n    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>\n      <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"CMD"</span><span class="token punctuation">,</span> <span class="token string">"service"</span><span class="token punctuation">,</span> <span class="token string">"nginx"</span><span class="token punctuation">,</span> <span class="token string">"status"</span><span class="token punctuation">]</span>\n      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s\n      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 5s\n      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">5</span>\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> loki</code></pre></div>'}}),"\n",t.createElement(a.p,null,"在上面的配置里，Grafana 采用了租户控制，您需要手动替换 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">YOUR_TENANT_ID</code>'}})," 为您想要的租户名。如果想要添加其他租户，请按照格式添加新的 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">datasources</code>'}})," 数组项。如果你打算将 Grafana 暴露到公网访问，请务必修改权限控制的相关配置，阻止匿名用户访问或避免匿名用户权限过高。"),"\n",t.createElement(a.p,null,"启动 Loki 容器时还用到了对应的配置文件，直接使用示例里给出的 ",t.createElement(a.a,{href:"https://github.com/grafana/loki/blob/main/examples/getting-started/loki-config.yaml"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">loki-config.yaml</code>'}})," 文件"),"即可："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>\n<span class="token key atrule">server</span><span class="token punctuation">:</span>\n  <span class="token key atrule">http_listen_address</span><span class="token punctuation">:</span> 0.0.0.0\n  <span class="token key atrule">http_listen_port</span><span class="token punctuation">:</span> <span class="token number">3100</span>\n\n<span class="token key atrule">memberlist</span><span class="token punctuation">:</span>\n  <span class="token key atrule">join_members</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">,</span> <span class="token string">"write"</span><span class="token punctuation">,</span> <span class="token string">"backend"</span><span class="token punctuation">]</span>\n  <span class="token key atrule">dead_node_reclaim_time</span><span class="token punctuation">:</span> 30s\n  <span class="token key atrule">gossip_to_dead_nodes_time</span><span class="token punctuation">:</span> 15s\n  <span class="token key atrule">left_ingesters_timeout</span><span class="token punctuation">:</span> 30s\n  <span class="token key atrule">bind_addr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">]</span>\n  <span class="token key atrule">bind_port</span><span class="token punctuation">:</span> <span class="token number">7946</span>\n  <span class="token key atrule">gossip_interval</span><span class="token punctuation">:</span> 2s\n\n<span class="token key atrule">schema_config</span><span class="token punctuation">:</span>\n  <span class="token key atrule">configs</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span> <span class="token datetime number">2025-06-03</span>\n      <span class="token key atrule">store</span><span class="token punctuation">:</span> tsdb\n      <span class="token key atrule">object_store</span><span class="token punctuation">:</span> s3\n      <span class="token key atrule">schema</span><span class="token punctuation">:</span> v13\n      <span class="token key atrule">index</span><span class="token punctuation">:</span>\n        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> index_\n        <span class="token key atrule">period</span><span class="token punctuation">:</span> 24h\n\n<span class="token key atrule">common</span><span class="token punctuation">:</span>\n  <span class="token key atrule">path_prefix</span><span class="token punctuation">:</span> /loki\n  <span class="token key atrule">replication_factor</span><span class="token punctuation">:</span> <span class="token number">1</span>\n  <span class="token key atrule">compactor_address</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//backend<span class="token punctuation">:</span><span class="token number">3100</span>\n  <span class="token key atrule">storage</span><span class="token punctuation">:</span>\n    <span class="token key atrule">s3</span><span class="token punctuation">:</span>\n      <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> minio<span class="token punctuation">:</span><span class="token number">9000</span>\n      <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n      <span class="token key atrule">bucketnames</span><span class="token punctuation">:</span> loki<span class="token punctuation">-</span>data\n      <span class="token key atrule">access_key_id</span><span class="token punctuation">:</span> loki <span class="token comment"># MinIO 数据库管理员用户名，需要与 MinIO 容器环境变量里的配置保持一致</span>\n      <span class="token key atrule">secret_access_key</span><span class="token punctuation">:</span> supersecret <span class="token comment"># MinIO 数据库管理员用户登录密码，需要与 MinIO 容器环境变量里的配置保持一致</span>\n      <span class="token key atrule">s3forcepathstyle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n  <span class="token key atrule">ring</span><span class="token punctuation">:</span>\n    <span class="token key atrule">kvstore</span><span class="token punctuation">:</span>\n      <span class="token key atrule">store</span><span class="token punctuation">:</span> memberlist\n\n<span class="token key atrule">ruler</span><span class="token punctuation">:</span>\n  <span class="token key atrule">storage</span><span class="token punctuation">:</span>\n    <span class="token key atrule">s3</span><span class="token punctuation">:</span>\n      <span class="token key atrule">bucketnames</span><span class="token punctuation">:</span> loki<span class="token punctuation">-</span>ruler\n\n<span class="token key atrule">compactor</span><span class="token punctuation">:</span>\n  <span class="token key atrule">working_directory</span><span class="token punctuation">:</span> /tmp/compactor</code></pre></div>'}}),"\n",t.createElement(a.p,null,"对于笔者的实际使用需求来说，上面每个配置的具体含义并不需要清楚了解，让我们直接启动 Grafana 和 Loki 容器吧！"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">% <span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span>\n<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Running <span class="token number">18</span>/18\n ✔ gateway Pulled                                                                                                                                         <span class="token number">15</span>.0s\n ✔ minio Pulled                                                                                                                                            <span class="token number">9</span>.9s\n<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Running <span class="token number">7</span>/7\n ✔ Network grafana_loki         Created                                                                                                                    <span class="token number">0</span>.0s\n ✔ Container grafana-minio-1    Started                                                                                                                    <span class="token number">0</span>.5s\n ✔ Container grafana-write-1    Started                                                                                                                    <span class="token number">0</span>.6s\n ✔ Container grafana-read-1     Started                                                                                                                    <span class="token number">0</span>.6s\n ✔ Container grafana-gateway-1  Started                                                                                                                    <span class="token number">0</span>.7s\n ✔ Container grafana-backend-1  Started                                                                                                                    <span class="token number">0</span>.9s\n ✔ Container grafana-grafana-1  Started                                                                                                                    <span class="token number">0</span>.9s</code></pre></div>'}}),"\n",t.createElement(a.p,null,"验证 Grafana 容器是否启动成功，可以访问 Grafana 容器映射在机器上的端口（配置文件里默认为 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">3000</code>'}}),"）。如果成功的话，将正常显示控制台页面如下："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/b6199558d0d1ca4a552e386a9c211aab/c2d13/grafana-panel.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 48.07692307692307%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABqklEQVR42m2SaW7bMBCFdYgm2qiFiyiSWixblm0kcRG0QO9/o9cZui7spj8eJErDN98sibYjGmVRyw5lrVC1BmWl8JpXyMrmq4oaOT3TvMbLa3k7C/7XwoUZSasdGekYXEsLbQOkcVDGI6XgR3ESTqo6HwEaiq8JgCGKSsJYj0SaAXlt4gX+WDUagsQX2SAaPYgTF0TEsRyTCxmBRGPQ9QEJl/u3lMqQuSUjQZl7SO3REolULE1SEETVdDMqeausNxqDD7Au3Axz0SKjjEzTKIfl+I5W9+iHFcfLTxy2T/hpQ+9nKmmA6Scs6wfccIgJt+0Nu2WL7er9iOTe7DQ2t6X+hFhOmFacLp84nr+T6QfpijCuRNZFUx4mmyg7wbiZ3h1RDs+GWUGkmSBVdGGAHxea3A5+WKLCuMc4H7AczpiJyvnpz/kETYOS2j4bdv0YVRBpTmvApI/iad4ryASfHb13KGiouTCx30+GFU1KGh9L+bIy3BLSt5cUWVqio01wy4+osP6CCWei/Ifwvib/W2g2bOoWS7DY7emy22M9vVOfr9jOV+zXS9yG324kGCVRnrL2AAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="grafana-panel"\n        title=""\n        src="/static/b6199558d0d1ca4a552e386a9c211aab/39c09/grafana-panel.png"\n        srcset="/static/b6199558d0d1ca4a552e386a9c211aab/680fe/grafana-panel.png 156w,\n/static/b6199558d0d1ca4a552e386a9c211aab/17474/grafana-panel.png 312w,\n/static/b6199558d0d1ca4a552e386a9c211aab/39c09/grafana-panel.png 624w,\n/static/b6199558d0d1ca4a552e386a9c211aab/6d2da/grafana-panel.png 936w,\n/static/b6199558d0d1ca4a552e386a9c211aab/5a791/grafana-panel.png 1248w,\n/static/b6199558d0d1ca4a552e386a9c211aab/c2d13/grafana-panel.png 2560w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",t.createElement(a.p,null,"另外，可以分别访问 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">http://localhost:3101/ready</code>'}})," 和 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">http://localhost:3102/ready</code>'}}),"，来验证 Loki 的读写服务是否启动成功。如果成功的话，将返回 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ready</code>'}})," 字符串。"),"\n",t.createElement(a.p,null,"至此，前置工作就完成了。"),"\n",t.createElement(a.h2,null,"重定向日志信息到 Loki"),"\n",t.createElement(a.h3,null,"使用 Alloy 重定向常规日志信息"),"\n",t.createElement(a.p,null,"现在，我们拥有了 Loki 来收集日志，那么该拿什么负责在客户端转发日志呢？Loki 的官方文档里推荐使用 ",t.createElement(a.a,{href:"https://grafana.org.cn/docs/alloy/latest/"},"Alloy"),"，这里笔者也就沿用官方文档提供的方案了。"),"\n",t.createElement(a.blockquote,null,"\n",t.createElement(a.p,null,"笔者在撰写本文时，使用的 Alloy 的版本为 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">1.8</code>'}}),"。"),"\n"),"\n",t.createElement(a.p,null,"对于笔者的 CentOS 服务器，依次执行下面的命令来安装 Alloy："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">wget</span> <span class="token parameter variable">-q</span> <span class="token parameter variable">-O</span> gpg.key https://rpm.grafana.com/gpg.key\n<span class="token function">sudo</span> <span class="token function">rpm</span> <span class="token parameter variable">--import</span> gpg.key\n<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">\'[grafana]\\nname=grafana\\nbaseurl=https://rpm.grafana.com\\nrepo_gpgcheck=1\\nenabled=1\\ngpgcheck=1\\ngpgkey=https://rpm.grafana.com/gpg.key\\nsslverify=1\\nsslcacert=/etc/pki/tls/certs/ca-bundle.crt\'</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/yum.repos.d/grafana.repo\n\nyum update\n\n<span class="token function">sudo</span> yum <span class="token function">install</span> alloy</code></pre></div>'}}),"\n",t.createElement(a.p,null,"配置 Alloy 服务开机自启："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> alloy.service</code></pre></div>'}}),"\n",t.createElement(a.p,null,"配置 Alloy 服务采集日志，编辑 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/etc/alloy/config.alloy</code>'}})," 文件如下："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="alloy"><pre class="language-alloy"><code class="language-alloy">// 添加本地的日志文件源\nlocal.file_match &quot;local_files&quot; {\n  path_targets = [{&quot;__path__&quot; = &quot;/path/to/*.log&quot;}]\n  sync_period = &quot;5s&quot;\n}\n\n// 读取日志文件源并转发到处理器\nloki.source.file &quot;log_scrape&quot; {\n  targets = local.file_match.local_files.targets\n  forward_to = [loki.process.filter_logs.receiver]\n  tail_from_end = true\n}\n\n// 过滤日志数据并转发到接收器\nloki.process &quot;filter_logs&quot; {\n  // ...其它的过滤日志数据的配置\n  forward_to = [loki.write.grafana_loki.receiver]\n}\n\n// 将日志信息发送到 Loki 服务\nloki.write &quot;grafana_loki&quot; {\n  // 添加日志标签，方便在 Grafana 上过滤查看\n  external_labels = {\n    service_name = &quot;YOUR_SERVICE_NAME&quot;,\n  }\n  endpoint {\n    url = &quot;http://localhost:3100/loki/api/v1/push&quot;\n    // 必须配置租户 tenant_id 为 Grafana 容器配置中包含的租户 ID\n    tenant_id = &quot;YOUR_TENANT_ID&quot;\n  }\n}</code></pre></div>'}}),"\n",t.createElement(a.p,null,"启动 Alloy 服务："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl start alloy</code></pre></div>'}}),"\n",t.createElement(a.p,null,"验证 Alloy 服务的运行状态："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">sudo</span> systemctl status alloy\n● alloy.service - Vendor-agnostic OpenTelemetry Collector distribution with programmable pipelines\n   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/alloy.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>\n   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Tue <span class="token number">2025</span>-06-03 <span class="token number">21</span>:43:30 CST<span class="token punctuation">;</span> 21s ago\n     Docs: https://grafana.com/docs/alloy\n Main PID: <span class="token number">25555</span> <span class="token punctuation">(</span>alloy<span class="token punctuation">)</span>\n   CGroup: /system.slice/alloy.service\n           └─25555 /usr/bin/alloy run <span class="token parameter variable">--storage.path</span><span class="token operator">=</span>/var/lib/alloy/data /etc/alloy/config.alloy\n\nJun 03 <span class="token number">21</span>:43:30 iZ2vc17uca9zl48iicx7ojZ alloy<span class="token punctuation">[</span><span class="token number">25555</span><span class="token punctuation">]</span>: <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2025</span>-06-03T13:43:30.861446161Z <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"scheduling loaded com...ices"</span>\nJun 03 <span class="token number">21</span>:43:30 iZ2vc17uca9zl48iicx7ojZ alloy<span class="token punctuation">[</span><span class="token number">25555</span><span class="token punctuation">]</span>: <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2025</span>-06-03T13:43:30.861894177Z <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"starting cluster node...ut=0s\nJun 03 21:43:30 iZ2vc17uca9zl48iicx7ojZ alloy[25555]: ts=2025-06-03T13:43:30.862038357Z level=info msg="</span>peers changed<span class="token string">" servic...x7ojZ\nJun 03 21:43:30 iZ2vc17uca9zl48iicx7ojZ alloy[25555]: ts=2025-06-03T13:43:30.862410662Z level=info msg="</span><span class="token function">tail</span> routine: started<span class="token punctuation">..</span>.e.log\nJun 03 <span class="token number">21</span>:43:30 iZ2vc17uca9zl48iicx7ojZ alloy<span class="token punctuation">[</span><span class="token number">25555</span><span class="token punctuation">]</span>: <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2025</span>-06-03T13:43:30.862469331Z <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"tail routine: started...g.log\nJun 03 21:43:30 iZ2vc17uca9zl48iicx7ojZ alloy[25555]: ts=2025-06-03T13:43:30.862606748Z level=info msg="</span>Seeked /var/www/logs/<span class="token punctuation">..</span>.ailer\nJun 03 <span class="token number">21</span>:43:30 iZ2vc17uca9zl48iicx7ojZ alloy<span class="token punctuation">[</span><span class="token number">25555</span><span class="token punctuation">]</span>: <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2025</span>-06-03T13:43:30.862646605Z <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"Seeked /var/www/logs/...ailer\nJun 03 21:43:30 iZ2vc17uca9zl48iicx7ojZ alloy[25555]: ts=2025-06-03T13:43:30.862631467Z level=info msg="</span>now listening <span class="token keyword">for</span> htt<span class="token punctuation">..</span>.12345\nJun 03 <span class="token number">21</span>:43:30 iZ2vc17uca9zl48iicx7ojZ alloy<span class="token punctuation">[</span><span class="token number">25555</span><span class="token punctuation">]</span>: <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2025</span>-06-03T13:43:30.862724788Z <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"tail routine: started...e.log\nJun 03 21:43:30 iZ2vc17uca9zl48iicx7ojZ alloy[25555]: ts=2025-06-03T13:43:30.862774924Z level=info msg="</span>Seeked /var/www/logs/<span class="token punctuation">..</span>.aile</code></pre></div>'}}),"\n",t.createElement(a.p,null,"在 Grafana 查看收集到的日志信息："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/bd67fa2a4edfd62b6e39d3e7be780d81/c2d13/grafana-query-logs.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 48.07692307692307%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABl0lEQVR42m1SSXLkIBDUK9ytBRACISQk5F48PszB4U/M/3+Sk0W3HB0xc8hIliKrsoqqVhZ1Z6CMh+49Wu5PtULTWZxbU9b/Q6fcI6bWcPGG+fKNYVxQ+Tmj6x9iyjiYIcK6iBB5rj3OjfkHddujZ5yxkRww5i/k338wThsqOyY0rEpTTHhadizrjXwlLnAhw4eV2RMc4fmodzOsXwqkACnGDiPiklEZZjg1uuCt7vhoxbL/QtjuiPsnpvyBkYF+3uDJsnYhvWAtSYQnxlQ97dVdTysUbTWrSYjpHYGXHatuzYBG2yeGJ2xx06gBrXaM84VdmFFpGx7Np6AMRyyIUEnyHIxA7s5MeOwPVxLXMsmZfXVjRKXo/wgQlp6F5Z02Eu1dixWxJr21nv1iAQKpSmCG6ed+STuq14ySbdtvxAcSe5i2KwdEkCOTWD8/v9dYRBVZ3rzxG0kyL5YPQTkUTvmOdb9T5FLWUmmIG3uay+NTo37sHq6EDadcLB+CAvnUUlHKNyRWul8/i5BABiWDOERe8RAMRfAvMsEX5YVHj8EAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="grafana-query-logs"\n        title=""\n        src="/static/bd67fa2a4edfd62b6e39d3e7be780d81/39c09/grafana-query-logs.png"\n        srcset="/static/bd67fa2a4edfd62b6e39d3e7be780d81/680fe/grafana-query-logs.png 156w,\n/static/bd67fa2a4edfd62b6e39d3e7be780d81/17474/grafana-query-logs.png 312w,\n/static/bd67fa2a4edfd62b6e39d3e7be780d81/39c09/grafana-query-logs.png 624w,\n/static/bd67fa2a4edfd62b6e39d3e7be780d81/6d2da/grafana-query-logs.png 936w,\n/static/bd67fa2a4edfd62b6e39d3e7be780d81/5a791/grafana-query-logs.png 1248w,\n/static/bd67fa2a4edfd62b6e39d3e7be780d81/c2d13/grafana-query-logs.png 2560w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",t.createElement(a.p,null,"这样，远程服务器上的日志信息就顺利上传到 Loki 里，并可以通过 Grafana 查看了！之后，只需要定时清除本地的日志文件就可以了。"),"\n",t.createElement(a.h3,null,"使用 Docker 插件重定向容器日志信息"),"\n",t.createElement(a.p,null,"为了重定向 Docker 容器里的日志到 Loki 上，只需要安装 Loki 的 Docker 插件并为容器添加相应的 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">logging</code>'}})," 配置。"),"\n",t.createElement(a.p,null,"笔者的 Docker 服务部署在使用 ARM64 架构的机器上，因此执行如下命令安装 ",t.createElement(a.a,{href:"https://hub.docker.com/r/grafana/loki-docker-driver/tags"},"Loki 的 Docker 插件"),"："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">docker</span> plugin <span class="token function">install</span> grafana/loki-docker-driver:3.5.1-arm64 <span class="token parameter variable">--alias</span> loki --grant-all-permissions</code></pre></div>'}}),"\n",t.createElement(a.p,null,"在配置容器前，假如您忘记了最初用 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">docker run</code>'}})," 命令启动容器时后面的一串参数怎么办？用 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">docker inspect</code>'}})," 去找灵感也太麻烦了！这个问题也困扰了笔者一阵，幸运的是以前有人遇到这样的烦恼后，开发了 ",t.createElement(a.a,{href:"https://github.com/lavie/runlike"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">runlike</code>'}}))," 工具，它可以帮助打印出运行指定容器时可能使用到的参数。"),"\n",t.createElement(a.p,null,"拉取 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">assaflavie/runlike</code>'}})," 镜像："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">docker</span> pull assaflavie/runlike</code></pre></div>'}}),"\n",t.createElement(a.p,null,"编辑 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">~/.bashrc</code>'}})," 或 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">~/.zshrc</code>'}}),"，添加命令别名 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">runlike</code>'}}),"："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">runlike</span><span class="token operator">=</span><span class="token string">"docker run --rm -v /var/run/docker.sock:/var/run/docker.sock assaflavie/runlike"</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"重启终端，现在，执行 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">runlike &lt;container-name></code>'}})," 就可以查看启动容器 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">&lt;container-name></code>'}})," 时可能使用到的命令了。"),"\n",t.createElement(a.p,null,"以笔者部署的 AList 容器为例，查看它的启动命令："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># 添加 -p 以多行显示</span>\n% runlike <span class="token parameter variable">-p</span> alist\n<span class="token function">docker</span> run <span class="token parameter variable">--name</span><span class="token operator">=</span>alist <span class="token punctuation">\\</span>\n        <span class="token parameter variable">--hostname</span><span class="token operator">=</span>xxxxxx <span class="token punctuation">\\</span>\n        --mac-address<span class="token operator">=</span>xx:xx:xx:xx:xx:xx <span class="token punctuation">\\</span>\n        <span class="token parameter variable">--volume</span> /path/to/data:/opt/alist/data <span class="token punctuation">\\</span>\n        <span class="token parameter variable">--network</span><span class="token operator">=</span>bridge <span class="token punctuation">\\</span>\n        <span class="token parameter variable">--workdir</span><span class="token operator">=</span>/opt/alist/ <span class="token punctuation">\\</span>\n        <span class="token parameter variable">-p</span> <span class="token number">5244</span>:5244 <span class="token punctuation">\\</span>\n        <span class="token parameter variable">--expose</span><span class="token operator">=</span><span class="token number">5245</span> <span class="token punctuation">\\</span>\n        <span class="token parameter variable">--restart</span><span class="token operator">=</span>unless-stopped <span class="token punctuation">\\</span>\n        <span class="token parameter variable">--runtime</span><span class="token operator">=</span>runc <span class="token punctuation">\\</span>\n        <span class="token parameter variable">--detach</span><span class="token operator">=</span>true <span class="token punctuation">\\</span>\n        xhofe/alist <span class="token punctuation">\\</span>\n        /entrypoint.sh</code></pre></div>'}}),"\n",t.createElement(a.p,null,"摘取其中笔者确实使用到的参数，简洁的启动命令就是：",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">docker run --name=alist --volume /path/to/data:/opt/alist/data -p 5244:5244 --restart=unless-stopped xhofe/alist</code>'}}),"。"),"\n",t.createElement(a.p,null,"随着容器化和自动化技术的发展，",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">docker run</code>'}})," 也该被扫进历史的垃圾堆，用 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">docker-compose</code>'}})," 来替代了。趁着这次机会，笔者也将服务器上所有容器的启动方式替换为了 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">docker-compose</code>'}}),"，以后再遇到需要修改参数或更新镜像等的情况，就可以省时省力地一键启动新容器了。"),"\n",t.createElement(a.p,null,"对于笔者的 AList 容器，可以编写 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">docker-compose.yaml</code>'}})," 文件如下："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">alist</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> xhofe/alist\n    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> alist<span class="token punctuation">-</span>server\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> /path/to/data<span class="token punctuation">:</span>/opt/alist/data\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> 5244<span class="token punctuation">:</span><span class="token number">5244</span>\n    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped</code></pre></div>'}}),"\n",t.createElement(a.blockquote,null,"\n",t.createElement(a.p,null,"更进一步，您还可以选用 ",t.createElement(a.a,{href:"https://github.com/louislam/dockge"},"Dockge")," 等服务来统一管理系统上的所有 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">docker-compose.yaml</code>'}})," 文件，不再在此博客里赘述。"),"\n"),"\n",t.createElement(a.p,null,"重定向 AList 容器的日志信息到 Loki，完整的 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">docker-compose.yaml</code>'}})," 配置文件如下："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">alist</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> xhofe/alist\n    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> alist<span class="token punctuation">-</span>server\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> /path/to/AList/data<span class="token punctuation">:</span>/opt/alist/data\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> 5244<span class="token punctuation">:</span><span class="token number">5244</span>\n    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped\n    <span class="token key atrule">logging</span><span class="token punctuation">:</span>\n      <span class="token key atrule">driver</span><span class="token punctuation">:</span> loki\n      <span class="token key atrule">options</span><span class="token punctuation">:</span>\n        <span class="token key atrule">loki-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3100/loki/api/v1/push\n        <span class="token key atrule">loki-tenant-id</span><span class="token punctuation">:</span> YOUR_TENANT_ID</code></pre></div>'}}),"\n",t.createElement(a.p,null,"同样，您需要替换配置里的 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">YOUR_TENANT_ID</code>'}})," 为您指定的租户 ID。"),"\n",t.createElement(a.p,null,"最后，删除旧的使用 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">docker run</code>'}})," 命令启动的容器，执行命令启动新容器：",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">docker-compose up -d</code>'}}),"。"),"\n",t.createElement(a.p,null,"在 Grafana 查看收集到的日志信息："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/c84d7b223ab903a61f32d26f13de46e3/c2d13/grafana-query-docker-logs.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 48.07692307692307%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjklEQVR42n1SW5KjMAzkFDMQwsPGNti8AplXzf7uEfb+V+ltiWQquzU1H12yDWq1WsqKyqA41zg3DhVx4v25qHA6t8hPNZ54/g5lZfmPQc5zF1+Qrr9h/YjMxVXJjA1oWg/jIjqfENMFFe952aAo238gRG03KCTPT7+wfP5BGBZkxiUqNKxoNFke47ijCxM8i7l+gZFEFnrEnbARGIfWePRxRtaYoK09Kyg/zEiXd7i0I4wv8IzSyk+QHOsnBCGUKqJMCPOypqIJw3ih0hnn2h5eUf2B/89W/xHvy7qjVcNN4Y2w4CCkBfFUh1IeNuSnw0eJCn2rD4inOliDzvXIqtY9KGzghhX9uKHrZwwTW6anAlEt6m1IqClCt4JDsz7q++H9ikyrPSic1ivG9RXT9oF1e+P9Fev+wZ83Es+abBwHwekKsUQhFmGO5F+EslsSx2UnrphJtu7vmEm4XN6UqKM6iS6MnHCvOMh7emgPD++Exc2LPs26Ll3aMES2K0TcS2lRiuo23OMD5JsLEX8BOrsYixp5iEoAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="grafana-query-docker-logs"\n        title=""\n        src="/static/c84d7b223ab903a61f32d26f13de46e3/39c09/grafana-query-docker-logs.png"\n        srcset="/static/c84d7b223ab903a61f32d26f13de46e3/680fe/grafana-query-docker-logs.png 156w,\n/static/c84d7b223ab903a61f32d26f13de46e3/17474/grafana-query-docker-logs.png 312w,\n/static/c84d7b223ab903a61f32d26f13de46e3/39c09/grafana-query-docker-logs.png 624w,\n/static/c84d7b223ab903a61f32d26f13de46e3/6d2da/grafana-query-docker-logs.png 936w,\n/static/c84d7b223ab903a61f32d26f13de46e3/5a791/grafana-query-docker-logs.png 1248w,\n/static/c84d7b223ab903a61f32d26f13de46e3/c2d13/grafana-query-docker-logs.png 2560w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",t.createElement(a.p,null,"这样，Docker 容器的日志信息也顺利上传到了 Loki 里，并可以通过 Grafana 查看了！"),"\n",t.createElement(a.h2,null,"？"),"\n",t.createElement(a.p,null,"还有高手……！请看 VCR：",t.createElement(a.a,{href:"https://www.v2ex.com/t/1123367"},"《2999,入手 16+256G 内存的 macmini4，如何通过部署 50 个服务实现最大价值化》"),"。"))}var l=function(n){void 0===n&&(n={});const{wrapper:a}=Object.assign({},(0,e.R)(),n.components);return a?t.createElement(a,n,t.createElement(p,n)):p(n)},o=s(197),c=s(4353),u=s.n(c),r=s(4794),i=s(6947),k=s(4017),g=s(1042),d=s(1038);const m={a:n=>{let{href:a="",children:s}=n;const e=!(null!=a&&a.startsWith("#")),p=e?a:`#${encodeURIComponent(a.slice(1))}`;return t.createElement("a",{href:p,target:e?"_blank":void 0,rel:"noreferrer"},s)},img:n=>{const{alt:a="The author is too lazy to give an alt",src:s,...e}=n;return t.createElement("a",{href:s,"data-fancybox":"gallery","data-caption":a},t.createElement("img",Object.assign({src:s,alt:a},e)))},Card:i.A,Link:r.Link},y=n=>{let{children:a,data:s}=n;const{mdx:{fields:{isDraft:p},frontmatter:{title:l,date:c,updated:r,categories:i,tags:g,timeliness:y}}}=s,b=t.useRef(null),h=u()(c),f=r?u()(r):h,_=u()().diff(f,"days");return t.useEffect((()=>{var n;const a=null===(n=b.current)||void 0===n?void 0:n.querySelectorAll("a.gatsby-resp-image-link");return null==a||a.forEach((n=>{const a=n.children.item(1);n.setAttribute("data-fancybox","gallery"),n.setAttribute("data-caption",a.alt)})),o.lX.bind("[data-fancybox]"),()=>o.lX.unbind("[data-fancybox]")}),[]),t.createElement("div",{className:"mx-auto flex max-w-xl flex-col gap-y-12"},t.createElement("div",{className:"flex flex-col gap-4"},(null==i?void 0:i.length)&&t.createElement(k.A,{name:i[0],className:"item-selectable"}),t.createElement("h1",{className:"text-3xl font-bold"},l),t.createElement("div",{className:"item-secondary flex flex-col gap-2 lg:flex-row"},c&&t.createElement("span",{title:`首次发布于：${h.toString()}\n最后更新于：${f.toString()}`},h.format("MM 月 DD 日 YYYY 年")),(null==g?void 0:g.length)&&t.createElement("div",{className:"flex flex-1 flex-wrap gap-2 lg:before:content-['•']"},g.map((n=>t.createElement(d.A,{key:n,name:n,className:"item-secondary item-selectable"})))))),t.createElement("article",{ref:b,className:"heti post-entry"},p&&t.createElement("blockquote",{className:"!border-red-400"},"这是一篇",t.createElement("strong",null,"未正式发布"),"的博客，内容可能尚未撰写完全或存在一些纰漏，建议您仔细评估信息的有效性。"),!1!==y&&_>365&&t.createElement("blockquote",{className:"!border-orange-400"},"这是一篇",t.createElement("strong",null,"最后更新于 ",_," 天前"),"的博客，内容可能随着时间的推移而变得不再适用，建议您仔细评估信息的有效性。"),t.createElement(e.x,{components:m},a)))},b=n=>{let{data:a}=n;return t.createElement(g.A,{title:String(a.mdx.frontmatter.title)})};function h(n){return t.createElement(y,n,t.createElement(l,n))}}}]);
//# sourceMappingURL=component---src-templates-post-tsx-content-file-path-blog-posts-grafana-log-system-mdx-a9e30372676b4be0d3da.js.map