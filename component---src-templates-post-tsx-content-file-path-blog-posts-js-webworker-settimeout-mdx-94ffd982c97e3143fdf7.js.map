{"version":3,"file":"component---src-templates-post-tsx-content-file-path-blog-posts-js-webworker-settimeout-mdx-94ffd982c97e3143fdf7.js","mappings":"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","sources":["webpack://homepage/./blog/posts/js-webworker-settimeout.mdx","webpack://homepage/./src/templates/post.tsx"],"sourcesContent":["/*@jsxRuntime classic @jsx React.createElement @jsxFrag React.Fragment*/\nimport {useMDXComponents as _provideComponents} from \"@mdx-js/react\";\nimport React from \"react\";\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    p: \"p\",\n    span: \"span\",\n    h2: \"h2\",\n    strong: \"strong\",\n    h3: \"h3\",\n    a: \"a\",\n    ol: \"ol\",\n    li: \"li\",\n    blockquote: \"blockquote\",\n    ul: \"ul\"\n  }, _provideComponents(), props.components);\n  return React.createElement(React.Fragment, null, React.createElement(_components.p, null, \"业务上有这样一个需求：「若用户不活跃超过 12 个小时，自动退出当前页面，并切换路由到首页」。\"), \"\\n\", React.createElement(_components.p, null, \"想都没想，直接在 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">useEffect()</code>\"\n    }\n  }), \" 里用 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">setTimeout()</code>\"\n    }\n  }), \" 定个时，12 个小时后触发相应跳转事件：\"), \"\\n\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<div class=\\\"gatsby-highlight\\\" data-language=\\\"tsx\\\"><pre class=\\\"language-tsx\\\"><code class=\\\"language-tsx\\\"><span class=\\\"token keyword\\\">import</span> React<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">{</span> useEffect <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">\\\"react\\\"</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">const</span> <span class=\\\"token constant\\\">LEAVE_PAGE_COUNTDOWN</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token number\\\">12</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">60</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">60</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">1000</span><span class=\\\"token punctuation\\\">;</span> <span class=\\\"token comment\\\">// 12h</span>\\n\\n<span class=\\\"token comment\\\">/** 离开页面的方法 */</span>\\n<span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">leavePage</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token comment\\\">// ...离开当前页面的业务代码</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">default</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token function\\\">useEffect</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token comment\\\">// 初始化时设置定时器</span>\\n    <span class=\\\"token keyword\\\">const</span> timer <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">setTimeout</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token function\\\">leavePage</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token constant\\\">LEAVE_PAGE_COUNTDOWN</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token comment\\\">// 页面卸载时清除定时器</span>\\n      <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>timer<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token function\\\">clearTimeout</span><span class=\\\"token punctuation\\\">(</span>timer<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span></code></pre></div>\"\n    }\n  }), \"\\n\", React.createElement(_components.p, null, \"没想到，今天上班来，切换到没有关闭的标签页，发现还在当前页面，掐指一算怎么也有 12 个小时了，这是怎么一回事儿……？\"), \"\\n\", React.createElement(_components.p, null, \"昨天晚上走的时候还在和前辈探讨页面卸载（\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">unload</code>\"\n    }\n  }), \"）事件与浏览器后台优化的坑，于是首先就想到了可能是浏览器优化的缘故，导致定时器没有正常执行。以「setTimeout」和「后台失效」为搜索关键词，很快找到了原因和优化解决方案。\"), \"\\n\", React.createElement(_components.h2, null, \"失效原因\"), \"\\n\", React.createElement(_components.p, null, \"系现代浏览器为了节能与性能优化做的处理。\"), \"\\n\", React.createElement(_components.p, null, \"若页面处于非激活的状态，那么此页面中通过 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">setTimeout()</code>\"\n    }\n  }), \" 或 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">setInterval()</code>\"\n    }\n  }), \" 创建的定时器可能会\", React.createElement(_components.strong, null, \"停止工作\"), \"或\", React.createElement(_components.strong, null, \"以较慢的速度工作\"), \"。页面的非激活状态包括不限于：切换到其它标签页、最小化窗口和息屏等。在移动端，这样的性能优化尤为常见。\"), \"\\n\", React.createElement(_components.p, null, \"因此会发生另外一种常见的现象：如果浏览器页面里有一个基于 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">setInterval()</code>\"\n    }\n  }), \" 实现的计时器，当用户切换页面或回到桌面后，计时器将停止计时或计时频率减慢，导致计时功能异常。\"), \"\\n\", React.createElement(_components.h2, null, \"基于 SetTimeout / SetInterval 的解决方案\"), \"\\n\", React.createElement(_components.p, null, \"定时器失效带来的最直接影响是：JavaScript 代码不再能够正确获取定时器\", React.createElement(_components.strong, null, \"计划执行的时间\"), \"或\", React.createElement(_components.strong, null, \"已经执行的次数\"), \"。\"), \"\\n\", React.createElement(_components.p, null, \"一个很容易想到的解决方案是，当页面切回前台时，重新校准 SetTimeout 定时器时间。\"), \"\\n\", React.createElement(_components.h3, null, \"使用 SetTimeout + 监听 visibilitychange 事件\"), \"\\n\", React.createElement(_components.p, null, \"通过监听窗口的 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">visibilitychange</code>\"\n    }\n  }), \" 事件（兼容性\", React.createElement(_components.a, {\n    href: \"https://developer.mozilla.org/zh-CN/docs/Web/API/Document/visibilitychange_event#browser_compatibility\"\n  }, \"见于此\"), \"），可以判断页面是否切换到前台：\"), \"\\n\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<div class=\\\"gatsby-highlight\\\" data-language=\\\"ts\\\"><pre class=\\\"language-ts\\\"><code class=\\\"language-ts\\\">window<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">addEventListener</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"visibilitychange\\\"</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">switch</span> <span class=\\\"token punctuation\\\">(</span>document<span class=\\\"token punctuation\\\">.</span>visibilityState<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">case</span> <span class=\\\"token string\\\">\\\"visible\\\"</span><span class=\\\"token operator\\\">:</span>\\n      <span class=\\\"token comment\\\">// 当前页面被切换到前台（可见或部分可见）</span>\\n      <span class=\\\"token keyword\\\">break</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token keyword\\\">case</span> <span class=\\\"token string\\\">\\\"hidden\\\"</span><span class=\\\"token operator\\\">:</span>\\n      <span class=\\\"token comment\\\">// 当前页面被切换到后台（不可见）</span>\\n      <span class=\\\"token keyword\\\">break</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token keyword\\\">case</span> <span class=\\\"token string\\\">\\\"prerender\\\"</span><span class=\\\"token operator\\\">:</span>\\n      <span class=\\\"token comment\\\">// 当前页面被预渲染，且用户不可见</span>\\n      <span class=\\\"token keyword\\\">break</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token keyword\\\">case</span> <span class=\\\"token string\\\">\\\"unloaded\\\"</span><span class=\\\"token operator\\\">:</span>\\n      <span class=\\\"token comment\\\">// 当前页面被卸载</span>\\n      <span class=\\\"token keyword\\\">break</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span></code></pre></div>\"\n    }\n  }), \"\\n\", React.createElement(_components.p, null, \"对于这次业务上遇到的 12 小时自动切换路由这一需求，对即时性和定时器的精度要求并不高，且重新校准的逻辑容易编写，可以码出 React 代码如下：\"), \"\\n\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<div class=\\\"gatsby-highlight\\\" data-language=\\\"tsx\\\"><pre class=\\\"language-tsx\\\"><code class=\\\"language-tsx\\\"><span class=\\\"token keyword\\\">import</span> React<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">{</span> useEffect <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">\\\"react\\\"</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">const</span> <span class=\\\"token constant\\\">LEAVE_PAGE_TIMESTAMP</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token string\\\">\\\"__leave_page_timestamp\\\"</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">const</span> <span class=\\\"token constant\\\">LEAVE_PAGE_COUNTDOWN</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token number\\\">12</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">60</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">60</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">1000</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token comment\\\">/** 离开页面的方法 */</span>\\n<span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">leavePage</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token comment\\\">// ...离开当前页面的业务代码</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token comment\\\">/** 获得倒计时时间 */</span>\\n<span class=\\\"token keyword\\\">const</span> getLeavePageCountdown <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token operator\\\">:</span> <span class=\\\"token builtin\\\">number</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">const</span> timestamp <span class=\\\"token operator\\\">=</span> sessionStorage<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">getItem</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token constant\\\">LEAVE_PAGE_TIMESTAMP</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token keyword\\\">const</span> countdown <span class=\\\"token operator\\\">=</span> timestamp\\n    <span class=\\\"token operator\\\">?</span> <span class=\\\"token function\\\">Number</span><span class=\\\"token punctuation\\\">(</span>timestamp<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">-</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Date</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">getTime</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span>\\n    <span class=\\\"token operator\\\">:</span> <span class=\\\"token constant\\\">LEAVE_PAGE_COUNTDOWN</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token keyword\\\">return</span> countdown <span class=\\\"token operator\\\">></span> <span class=\\\"token number\\\">0</span> <span class=\\\"token operator\\\">?</span> countdown <span class=\\\"token operator\\\">:</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token comment\\\">/** 获得离开页面定时器 */</span>\\n<span class=\\\"token keyword\\\">const</span> getLeavePageTimeout <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token operator\\\">:</span> NodeJS<span class=\\\"token punctuation\\\">.</span>Timeout <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">return</span> <span class=\\\"token function\\\">setTimeout</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token function\\\">leavePage</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token function\\\">getLeavePageCountdown</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">default</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token function\\\">useEffect</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token comment\\\">// 初始化时设置离开页面的时间</span>\\n    sessionStorage<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">setItem</span><span class=\\\"token punctuation\\\">(</span>\\n      <span class=\\\"token constant\\\">LEAVE_PAGE_TIMESTAMP</span><span class=\\\"token punctuation\\\">,</span>\\n      <span class=\\\"token function\\\">String</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Date</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">getTime</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">+</span> <span class=\\\"token constant\\\">LEAVE_PAGE_COUNTDOWN</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token comment\\\">// 页面卸载时清除 SessionStorage</span>\\n      sessionStorage<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">removeItem</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token constant\\\">LEAVE_PAGE_TIMESTAMP</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n  <span class=\\\"token function\\\">useEffect</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token comment\\\">// 初始化时设置定时器</span>\\n    <span class=\\\"token keyword\\\">let</span> timer <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">getLeavePageTimeout</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    <span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">onWindowVisibilityChange</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token comment\\\">// 重新校准定时器</span>\\n      <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>document<span class=\\\"token punctuation\\\">.</span>visibilityState <span class=\\\"token operator\\\">===</span> <span class=\\\"token string\\\">\\\"visible\\\"</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token comment\\\">// 清除已有定时器</span>\\n        <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>timer<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token function\\\">clearTimeout</span><span class=\\\"token punctuation\\\">(</span>timer<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token comment\\\">// 设置新的定时器</span>\\n        timer <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">getLeavePageTimeout</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token comment\\\">// 添加页面可见性变化监听器</span>\\n    window<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">addEventListener</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"visibilitychange\\\"</span><span class=\\\"token punctuation\\\">,</span> onWindowVisibilityChange<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token comment\\\">// 页面卸载时清除定时器和监听器</span>\\n      <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>timer<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token function\\\">clearTimeout</span><span class=\\\"token punctuation\\\">(</span>timer<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      window<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">removeEventListener</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"visibilitychange\\\"</span><span class=\\\"token punctuation\\\">,</span> onWindowVisibilityChange<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span></code></pre></div>\"\n    }\n  }), \"\\n\", React.createElement(_components.p, null, \"上面的代码做了这些事情：\"), \"\\n\", React.createElement(_components.ol, null, \"\\n\", React.createElement(_components.li, null, \"当用户进入到页面时，在 SessionStorage 存储了应当执行业务需求的时间戳。\"), \"\\n\", React.createElement(_components.li, null, \"启动一个定时器，在指定时间以后执行业务需求。\"), \"\\n\", React.createElement(_components.li, null, \"启动一个监听器，当页面可见性发生改变，变为「可见」时，校准定时器：清除已有的定时器，然后启动一个新的定时器，在新的指定时间以后执行业务需求。其中，新的指定时间由存储的时间戳和当前的时间计算得来。\"), \"\\n\"), \"\\n\", React.createElement(_components.h3, null, \"使用 SetInterval 轮训\"), \"\\n\", React.createElement(_components.p, null, \"哇噻，有够麻烦。换一种思路，使用轮训的实现方式，基于 SetInterval 不断比较当前的时间戳和应当离开页面的时间戳，若当前的时间戳大于应当离开页面的时间戳，执行离开页面的业务方法就好了。这种实现方式无需费力地重新校准时间，是一个讨巧的选择：\"), \"\\n\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<div class=\\\"gatsby-highlight\\\" data-language=\\\"tsx\\\"><pre class=\\\"language-tsx\\\"><code class=\\\"language-tsx\\\"><span class=\\\"token keyword\\\">import</span> React<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">{</span> useEffect <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">\\\"react\\\"</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">const</span> <span class=\\\"token constant\\\">LEAVE_PAGE_COUNTDOWN</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token number\\\">12</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">60</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">60</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">1000</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token comment\\\">/** 离开页面的方法 */</span>\\n<span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">leavePage</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token comment\\\">// ...离开当前页面的业务代码</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">default</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token function\\\">useEffect</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token comment\\\">// 获取执行业务需求的时间戳</span>\\n    <span class=\\\"token keyword\\\">const</span> timestamp <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Date</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">getTime</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">+</span> <span class=\\\"token constant\\\">LEAVE_PAGE_COUNTDOWN</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    <span class=\\\"token comment\\\">// 初始化时设置轮询器</span>\\n    <span class=\\\"token keyword\\\">const</span> timer <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">setInterval</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">const</span> now <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Date</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">getTime</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>now <span class=\\\"token operator\\\">>=</span> timestamp<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token function\\\">leavePage</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token number\\\">1000</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token comment\\\">// 页面卸载时清除轮询器</span>\\n      <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>timer<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token function\\\">clearInterval</span><span class=\\\"token punctuation\\\">(</span>timer<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span></code></pre></div>\"\n    }\n  }), \"\\n\", React.createElement(_components.h3, null, \"似乎都不太优雅\"), \"\\n\", React.createElement(_components.p, null, \"但是，以上的实现都会导致一些体验上的问题：用户从后台切换到该页面时，若超过了 12 个小时，定时器或轮询器一运行，唰的一下子路由发生改变，用户会感到非常奇怪。\"), \"\\n\", React.createElement(_components.p, null, \"虽然加上一些 Notification 告知刚刚发生了啥会减少用户的不适，但终究我们还是会希望浏览器能\", React.createElement(_components.strong, null, \"完全正常\"), \"地运行定时器方法（这是我们不想要被后台优化的功能），而不需要做这些带来额外开销且\", React.createElement(_components.strong, null, \"不符合直觉\"), \"的适配（下一任程序员看到代码就头疼）。\"), \"\\n\", React.createElement(_components.p, null, \"此外，这样的做法并不能满足对\", React.createElement(_components.strong, null, \"准确度要求高\"), \"的定时器需求。\"), \"\\n\", React.createElement(_components.p, null, \"基于以上需求，本文的主角 \", React.createElement(_components.strong, null, \"Web Worker\"), \" 给出了现代、普适的解决方案。\"), \"\\n\", React.createElement(_components.h2, null, \"生产实践的解决方案：使用 Web Worker\"), \"\\n\", React.createElement(_components.blockquote, null, \"\\n\", React.createElement(_components.p, null, \"Web Worker 为 Web 内容在后台线程中运行脚本提供了一种简单的方法。线程可以执行任务而不干扰用户界面……一个 worker 是使用一个构造函数创建的一个对象运行一个命名的 JavaScript 文件：这个文件包含将在工作线程中运行的代码；workers 运行在另一个全局上下文中，不同于当前的 window。\"), \"\\n\", React.createElement(_components.p, null, \"-- \", React.createElement(_components.a, {\n    href: \"https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers\"\n  }, \"MDN\")), \"\\n\"), \"\\n\", React.createElement(_components.p, null, \"Web Worker 能够为 JavaScript 创建多线程环境，允许将主线程中的任务分配给 Worker 线程处理，主线程和 Worker 线程之间可以进行通信。当遇到计算密集型或高延迟的任务时，常使用 Web Worker 进行性能优化：在 Worker 线程进行复杂的计算操作，进而避免主线程阻塞或卡死。\"), \"\\n\", React.createElement(_components.p, null, \"Worker 线程一旦创建成功，将\", React.createElement(_components.strong, null, \"始终运行\"), \"，不会被主线程上的活动中断。但是，这也意味着 Worker 使用完毕后应当立即关闭，避免造成额外的系统开销。\"), \"\\n\", React.createElement(_components.p, null, \"只需要了解 Web Worker 的基本用法，就能很好地实现本次业务上的需求。将 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">setTimeout()</code>\"\n    }\n  }), \" 方法移动到 Worker 中去，只要浏览器不关闭，Worker 将保持运行的状态，在正确的时机向主线程返回离开页面的消息。\"), \"\\n\", React.createElement(_components.h3, null, \"Webpack 的方式\"), \"\\n\", React.createElement(_components.p, null, \"首先编写一个 Web Worker 脚本文件 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">leavePage.worker.js</code>\"\n    }\n  }), \"：\"), \"\\n\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<div class=\\\"gatsby-highlight\\\" data-language=\\\"js\\\"><pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token keyword\\\">let</span> timer<span class=\\\"token punctuation\\\">;</span>\\n\\nself<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function-variable function\\\">onmessage</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token parameter\\\">event</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token comment\\\">// console.log(\\\"Received message from main thread\\\", event.data);</span>\\n\\n  <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>timer<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token function\\\">clearTimeout</span><span class=\\\"token punctuation\\\">(</span>timer<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n\\n  timer <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">setTimeout</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token comment\\\">// 向主线程发出消息</span>\\n    self<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">postMessage</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token template-string\\\"><span class=\\\"token template-punctuation string\\\">`</span><span class=\\\"token string\\\">Time to leave page </span><span class=\\\"token interpolation\\\"><span class=\\\"token interpolation-punctuation punctuation\\\">${</span><span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Date</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token interpolation-punctuation punctuation\\\">}</span></span><span class=\\\"token template-punctuation string\\\">`</span></span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token comment\\\">// event.data 即离开页面的倒计时（ms）</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> event<span class=\\\"token punctuation\\\">.</span>data<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span></code></pre></div>\"\n    }\n  }), \"\\n\", React.createElement(_components.p, null, \"如果您的项目基于 Webpack 4.x，那么需要配置 \", React.createElement(_components.a, {\n    href: \"https://github.com/webpack-contrib/worker-loader\"\n  }, React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">worker-loader</code>\"\n    }\n  })), \" 或 \", React.createElement(_components.a, {\n    href: \"https://github.com/GoogleChromeLabs/worker-plugin\"\n  }, React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">worker-plugin</code>\"\n    }\n  })), \" 等 loader 或插件才能通过 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">new Worker(url)</code>\"\n    }\n  }), \" 的方式正常引入 Web Worker。\"), \"\\n\", React.createElement(_components.p, null, \"在 React 代码里读取脚本文件，即可创建 Worker 线程并监听它返回的消息：\"), \"\\n\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<div class=\\\"gatsby-highlight\\\" data-language=\\\"tsx\\\"><pre class=\\\"language-tsx\\\"><code class=\\\"language-tsx\\\"><span class=\\\"token keyword\\\">import</span> React<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">{</span> useEffect <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">\\\"react\\\"</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token comment\\\">/** 离开页面的方法 */</span>\\n<span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">leavePage</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token comment\\\">// ...离开当前页面的业务代码</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">default</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token function\\\">useEffect</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token comment\\\">// 新建 Worker 线程</span>\\n    <span class=\\\"token comment\\\">// const worker = new Worker(\\\"path/to/leavePage.worker.js\\\");</span>\\n\\n    <span class=\\\"token comment\\\">// 向 Worker 线程发出消息，设定 12h 后返回消息</span>\\n    worker<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">postMessage</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token number\\\">12</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">60</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">60</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">1000</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    <span class=\\\"token comment\\\">// 监听 Worker 返回的消息</span>\\n    worker<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function-variable function\\\">onmessage</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>event<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token comment\\\">// 一旦接收到消息，执行离开页面的业务代码</span>\\n      <span class=\\\"token builtin\\\">console</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">log</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"Received message from worker thread\\\"</span><span class=\\\"token punctuation\\\">,</span> event<span class=\\\"token punctuation\\\">.</span>data<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token function\\\">leavePage</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token comment\\\">// 一旦完成响应，关闭 Worker 线程</span>\\n      worker<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">terminate</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token comment\\\">// 页面卸载时关闭 Worker 线程</span>\\n      worker<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">terminate</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span></code></pre></div>\"\n    }\n  }), \"\\n\", React.createElement(_components.p, null, \"对于 Webpack 5.x 以上的项目，Webpack 已内置了对 Web Worker 的支持，可\", React.createElement(_components.a, {\n    href: \"https://webpack.js.org/guides/web-workers\"\n  }, \"查阅文档\"), \"使用。\"), \"\\n\", React.createElement(_components.h3, null, \"动态加载的方式\"), \"\\n\", React.createElement(_components.p, null, \"如果不想在 Webpack 上加 loader 或插件，也可以考虑「动态」地加载脚本文件，这需要一点点小技巧。首先将 Worker 包含的具体内容以字符串的形式导出：\"), \"\\n\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<div class=\\\"gatsby-highlight\\\" data-language=\\\"js\\\"><pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token comment\\\">// leavePage.worker.js</span>\\n<span class=\\\"token keyword\\\">const</span> leavePageWorker <span class=\\\"token operator\\\">=</span> <span class=\\\"token template-string\\\"><span class=\\\"token template-punctuation string\\\">`</span><span class=\\\"token string\\\">\\nvar timer;\\nself.onmessage = function (event) {\\n  // ...\\n};\\n</span><span class=\\\"token template-punctuation string\\\">`</span></span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">default</span> leavePageWorker<span class=\\\"token punctuation\\\">;</span></code></pre></div>\"\n    }\n  }), \"\\n\", React.createElement(_components.p, null, \"在主线程的代码里导入字符串并创建真正的 Worker 线程：\"), \"\\n\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<div class=\\\"gatsby-highlight\\\" data-language=\\\"ts\\\"><pre class=\\\"language-ts\\\"><code class=\\\"language-ts\\\"><span class=\\\"token keyword\\\">import</span> LeavePageWorker <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">\\\"path/to/leavePage.worker.js\\\"</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">const</span> loadWebWorker <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>code<span class=\\\"token operator\\\">:</span> <span class=\\\"token builtin\\\">string</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token operator\\\">:</span> Worker <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">const</span> blob <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Blob</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">[</span><span class=\\\"token string\\\">\\\"(\\\"</span> <span class=\\\"token operator\\\">+</span> code <span class=\\\"token operator\\\">+</span> <span class=\\\"token string\\\">\\\")()\\\"</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token keyword\\\">return</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">Worker</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token constant\\\">URL</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">createObjectURL</span><span class=\\\"token punctuation\\\">(</span>blob<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">const</span> leavePageWorker <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">loadWebWorker</span><span class=\\\"token punctuation\\\">(</span>LeavePageWorker<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span></code></pre></div>\"\n    }\n  }), \"\\n\", React.createElement(_components.p, null, \"需注意的是，使用动态加载的方式意味着 Worker 的代码将不经 Webpack 而直接调用，所以应当使用兼容性更好的「古早 JavaScript 语法」，例如 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">var</code>\"\n    }\n  }), \" \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">function(){}</code>\"\n    }\n  }), \" 等。\"), \"\\n\", React.createElement(_components.p, null, \"由于浏览器的 Content Security Policy (CSP) 策略，通过此方法创建 Worker 可能会失败，可以参考\", React.createElement(_components.a, {\n    href: \"https://stackoverflow.com/questions/30280370/how-does-content-security-policy-csp-work\"\n  }, \"此介绍\"), \"进行解决。\"), \"\\n\", React.createElement(_components.h3, null, \"Umi 项目的方式\"), \"\\n\", React.createElement(_components.p, null, \"根据 \", React.createElement(_components.a, {\n    href: \"https://v3.umijs.org/config#workerloader\"\n  }, \"Umi 文档\"), \"，对于 Umi 3.4.1+ 的项目，可以进行如下配置启用对 Web Worker 的支持：\"), \"\\n\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<div class=\\\"gatsby-highlight\\\" data-language=\\\"ts\\\"><pre class=\\\"language-ts\\\"><code class=\\\"language-ts\\\"><span class=\\\"token comment\\\">// config.ts</span>\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">default</span> <span class=\\\"token function\\\">defineConfig</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>\\n  workerLoader<span class=\\\"token operator\\\">:</span> <span class=\\\"token punctuation\\\">{</span><span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span></code></pre></div>\"\n    }\n  }), \"\\n\", React.createElement(_components.p, null, \"然而 Umi 文档并没有提 Web Worker 的引入方式，不过查阅 \", React.createElement(_components.a, {\n    href: \"https://github.com/umijs/umi/blob/3.x/packages/bundler-webpack/src/getConfig/getConfig.ts#L364-L372\"\n  }, \"Umi 源码\"), \"发现：\"), \"\\n\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<div class=\\\"gatsby-highlight\\\" data-language=\\\"ts\\\"><pre class=\\\"language-ts\\\"><code class=\\\"language-ts\\\"><span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span>config<span class=\\\"token punctuation\\\">.</span>workerLoader<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n  webpackConfig<span class=\\\"token punctuation\\\">.</span>module\\n    <span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">rule</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"worker\\\"</span><span class=\\\"token punctuation\\\">)</span>\\n    <span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">test</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token regex\\\"><span class=\\\"token regex-delimiter\\\">/</span><span class=\\\"token regex-source language-regex\\\">.*worker.(ts|js)</span><span class=\\\"token regex-delimiter\\\">/</span></span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token comment\\\">// Web Worker 文件命名规则</span>\\n    <span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">use</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"worker-loader\\\"</span><span class=\\\"token punctuation\\\">)</span>\\n    <span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">loader</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">require</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">resolve</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">\\\"@umijs/deps/compiled/worker-loader\\\"</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span>\\n    <span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">options</span><span class=\\\"token punctuation\\\">(</span>config<span class=\\\"token punctuation\\\">.</span>workerLoader<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span></code></pre></div>\"\n    }\n  }), \"\\n\", React.createElement(_components.p, null, \"可知 Umi 基于 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">worker-loader</code>\"\n    }\n  }), \"，将 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">worker.ts</code>\"\n    }\n  }), \" 或 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">worker.js</code>\"\n    }\n  }), \" 结尾的文件当作 Web Worker 处理。那么可以这样编写主线程的代码：\"), \"\\n\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<div class=\\\"gatsby-highlight\\\" data-language=\\\"tsx\\\"><pre class=\\\"language-tsx\\\"><code class=\\\"language-tsx\\\"><span class=\\\"token keyword\\\">import</span> React<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">{</span> useEffect <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">\\\"react\\\"</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> LeavePageWorker <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">\\\"path/to/leavePage.worker.js\\\"</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">default</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token function\\\">useEffect</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token comment\\\">// 新建 Worker 线程</span>\\n    <span class=\\\"token keyword\\\">const</span> worker<span class=\\\"token operator\\\">:</span> Worker <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">LeavePageWorker</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    <span class=\\\"token comment\\\">// 像之前一样监听 worker 事件即可</span>\\n    <span class=\\\"token comment\\\">// ...</span>\\n\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token comment\\\">// 别忘了使用完后关闭 Worker 线程</span>\\n      worker<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">terminate</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span></code></pre></div>\"\n    }\n  }), \"\\n\", React.createElement(_components.p, null, \"Worker 的编译和运行均在后台执行，这意味着即使出现报错也不会显式提醒您。您可以随时在开发者工具里找到编译得到的 Worker 的代码：\"), \"\\n\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<span\\n      class=\\\"gatsby-resp-image-wrapper\\\"\\n      style=\\\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; \\\"\\n    >\\n      <a\\n    class=\\\"gatsby-resp-image-link\\\"\\n    href=\\\"/static/a5564164559988f60d79f78896c14f68/2bfae/webworker-source.jpg\\\"\\n    style=\\\"display: block\\\"\\n    target=\\\"_blank\\\"\\n    rel=\\\"noopener\\\"\\n  >\\n    <span\\n    class=\\\"gatsby-resp-image-background-image\\\"\\n    style=\\\"padding-bottom: 87.17948717948718%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAeVc0iBQgP/EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEAAQUCH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CH//EABsQAAICAwEAAAAAAAAAAAAAAAEQACERMUFh/9oACAEBAAE/IezNIG4T6ht//9oADAMBAAIAAwAAABCoL77/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/EB//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/EB//xAAdEAACAgIDAQAAAAAAAAAAAAABEQAhMUEQUXFh/9oACAEBAAE/ELWwQsDUZAgfYz2vDDZGodqw+Hm2YZ//2Q=='); background-size: cover; display: block;\\\"\\n  ></span>\\n  <img\\n        class=\\\"gatsby-resp-image-image\\\"\\n        alt=\\\"在开发者工具中查看 Worker 源码\\\"\\n        title=\\\"\\\"\\n        src=\\\"/static/a5564164559988f60d79f78896c14f68/a3695/webworker-source.jpg\\\"\\n        srcset=\\\"/static/a5564164559988f60d79f78896c14f68/acd68/webworker-source.jpg 156w,\\n/static/a5564164559988f60d79f78896c14f68/f556e/webworker-source.jpg 312w,\\n/static/a5564164559988f60d79f78896c14f68/a3695/webworker-source.jpg 624w,\\n/static/a5564164559988f60d79f78896c14f68/38044/webworker-source.jpg 936w,\\n/static/a5564164559988f60d79f78896c14f68/9a8cd/webworker-source.jpg 1248w,\\n/static/a5564164559988f60d79f78896c14f68/2bfae/webworker-source.jpg 1654w\\\"\\n        sizes=\\\"(max-width: 624px) 100vw, 624px\\\"\\n        style=\\\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\\\"\\n        loading=\\\"lazy\\\"\\n        decoding=\\\"async\\\"\\n      />\\n  </a>\\n    </span>\"\n    }\n  }), \"\\n\", React.createElement(_components.p, null, \"对于 Umi 3.4.1 以前版本的项目，可以通过 \", React.createElement(_components.a, {\n    href: \"https://v3.umijs.org/config#chainwebpack\"\n  }, React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">chainWebpack</code>\"\n    }\n  })), \" 添加 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">worker-loader</code>\"\n    }\n  }), \" 或 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">worker-plugin</code>\"\n    }\n  }), \" 插件的支持。\"), \"\\n\", React.createElement(_components.p, null, \"Umi 4.x 内置 Webpack 5.x 作为默认 Bundler，因此\", React.createElement(_components.a, {\n    href: \"https://webpack.js.org/guides/web-workers\"\n  }, \"查阅文档\"), \"使用即可。\"), \"\\n\", React.createElement(_components.h3, null, \"三方库的方式\"), \"\\n\", React.createElement(_components.p, null, \"如果不介意 Web Worker 编写是否原生（笔者从不介意！），更推荐选用封装了 Web Worker 能力的三方库，例如 \", React.createElement(_components.a, {\n    href: \"https://github.com/alewin/useWorker\"\n  }, React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">alewin/useWorker</code>\"\n    }\n  })), \" 和 \", React.createElement(_components.a, {\n    href: \"https://github.com/developit/greenlet/\"\n  }, React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">developit/greenlet</code>\"\n    }\n  })), \" 等。\"), \"\\n\", React.createElement(_components.p, null, \"它们降低了使用 Web Worker 的心智成本，使得调用 Web Worker 就像编写普通的 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">async</code>\"\n    }\n  }), \" 异步函数一样；重要的是，不必再担心引入 Web Worker 时带来的各种各样的奇怪问题（CDN 部署时，可能发生同源问题）。\"), \"\\n\", React.createElement(_components.p, null, \"以 \", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<code class=\\\"language-text\\\">alewin/useWorker</code>\"\n    }\n  }), \" 为例，可以这样改进前面的代码：\"), \"\\n\", React.createElement(_components.span, {\n    dangerouslySetInnerHTML: {\n      __html: \"<div class=\\\"gatsby-highlight\\\" data-language=\\\"tsx\\\"><pre class=\\\"language-tsx\\\"><code class=\\\"language-tsx\\\"><span class=\\\"token keyword\\\">import</span> React<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">{</span> useEffect <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">\\\"react\\\"</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> <span class=\\\"token punctuation\\\">{</span> useWorker <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">\\\"@koale/useworker\\\"</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token comment\\\">/**\\n * 休眠 @timeout 毫秒\\n */</span>\\n<span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">setTimeoutAsync</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>timeout<span class=\\\"token operator\\\">:</span> <span class=\\\"token builtin\\\">number</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">return</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\"><span class=\\\"token builtin\\\">Promise</span><span class=\\\"token operator\\\">&lt;</span><span class=\\\"token keyword\\\">void</span><span class=\\\"token operator\\\">></span></span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span>resolve<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span>\\n    <span class=\\\"token function\\\">setTimeout</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token function\\\">resolve</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> timeout<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">export</span> <span class=\\\"token keyword\\\">default</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">const</span> <span class=\\\"token punctuation\\\">[</span>setTimeoutWorker<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">{</span> kill<span class=\\\"token operator\\\">:</span> killSetTimeoutWorker <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">]</span> <span class=\\\"token operator\\\">=</span>\\n    <span class=\\\"token function\\\">useWorker</span><span class=\\\"token punctuation\\\">(</span>setTimeoutAsync<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n  <span class=\\\"token function\\\">useEffect</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">runLeavePageWorker</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">async</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">await</span> <span class=\\\"token function\\\">setTimeoutWorker</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token number\\\">12</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">60</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">60</span> <span class=\\\"token operator\\\">*</span> <span class=\\\"token number\\\">1000</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token comment\\\">// ... 在此处执行离开页面的业务代码</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    <span class=\\\"token function\\\">runLeavePageWorker</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token function\\\">killSetTimeoutWorker</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span></code></pre></div>\"\n    }\n  }), \"\\n\", React.createElement(_components.h2, null, \"参考文章\"), \"\\n\", React.createElement(_components.ul, null, \"\\n\", React.createElement(_components.li, null, React.createElement(_components.a, {\n    href: \"https://www.ruanyifeng.com/blog/2018/07/web-worker.html\"\n  }, \"Web Worker 使用教程 - 阮一峰\")), \"\\n\", React.createElement(_components.li, null, React.createElement(_components.a, {\n    href: \"https://juejin.cn/post/6855583384375132174\"\n  }, \"记一次定时器问题的优雅解决\")), \"\\n\", React.createElement(_components.li, null, React.createElement(_components.a, {\n    href: \"https://stackoverflow.com/questions/49171791/web-worker-onmessage-uncaught-syntaxerror-unexpected-token\"\n  }, \"web worker onmessage - Uncaught SyntaxError: Unexpected token <\")), \"\\n\", React.createElement(_components.li, null, React.createElement(_components.a, {\n    href: \"https://stackoverflow.com/questions/33289726/combination-of-async-function-await-settimeout\"\n  }, \"Combination of async function + await + setTimeout\")), \"\\n\"));\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? React.createElement(MDXLayout, props, React.createElement(_createMdxContent, props)) : _createMdxContent(props);\n}\nexport default MDXContent;\n","import GATSBY_COMPILED_MDX from \"/home/runner/work/homepage/homepage/blog/posts/js-webworker-settimeout.mdx\";\nimport {Fancybox} from \"@fancyapps/ui\";\nimport {MDXProvider} from \"@mdx-js/react\";\nimport dayjs from \"dayjs\";\nimport {Link} from \"gatsby\";\nimport * as React from \"react\";\nimport Card from \"../components/card\";\nimport Category from \"../components/category\";\nimport SEO from \"../components/seo\";\nimport Tag from \"../components/tag\";\nconst FancyBoxImage = props => {\n  const {alt = \"The author is too lazy to give an alt\", src, ...restProps} = props;\n  return React.createElement(\"a\", {\n    href: src,\n    \"data-fancybox\": \"gallery\",\n    \"data-caption\": alt\n  }, React.createElement(\"img\", Object.assign({\n    src: src,\n    alt: alt\n  }, restProps)));\n};\nconst ALink = _ref => {\n  let {href = \"\", children} = _ref;\n  const isExternalHref = !(href !== null && href !== void 0 && href.startsWith(\"#\"));\n  const parsedHref = isExternalHref ? href : `#${encodeURIComponent(href.slice(1))}`;\n  return React.createElement(\"a\", {\n    href: parsedHref,\n    target: isExternalHref ? \"_blank\" : undefined,\n    rel: \"noreferrer\"\n  }, children);\n};\nconst components = {\n  a: ALink,\n  img: FancyBoxImage,\n  Card,\n  Link\n};\nconst PostTemplate = _ref2 => {\n  let {children, data} = _ref2;\n  const {mdx: {fields: {isDraft}, frontmatter: {title, date: dateString, updated: updatedDateString, categories, tags, timeliness}}} = data;\n  const articleRef = React.useRef(null);\n  const date = dayjs(dateString);\n  const updatedDate = updatedDateString ? dayjs(updatedDateString) : date;\n  const today = dayjs();\n  const diffDays = today.diff(updatedDate, \"days\");\n  React.useEffect(() => {\n    var _articleRef$current;\n    const optimizedImageLinks = (_articleRef$current = articleRef.current) === null || _articleRef$current === void 0 ? void 0 : _articleRef$current.querySelectorAll(\"a.gatsby-resp-image-link\");\n    optimizedImageLinks === null || optimizedImageLinks === void 0 ? void 0 : optimizedImageLinks.forEach(link => {\n      const image = link.children.item(1);\n      link.setAttribute(\"data-fancybox\", \"gallery\");\n      link.setAttribute(\"data-caption\", image.alt);\n    });\n    Fancybox.bind(\"[data-fancybox]\");\n    return () => Fancybox.unbind(\"[data-fancybox]\");\n  }, []);\n  return React.createElement(\"div\", {\n    className: \"mx-auto flex max-w-xl flex-col gap-y-12\"\n  }, React.createElement(\"div\", {\n    className: \"flex flex-col gap-4\"\n  }, (categories === null || categories === void 0 ? void 0 : categories.length) && React.createElement(Category, {\n    name: categories[0],\n    className: \"item-selectable\"\n  }), React.createElement(\"h1\", {\n    className: \"text-3xl font-bold\"\n  }, title), React.createElement(\"div\", {\n    className: \"item-secondary flex flex-col gap-2 lg:flex-row\"\n  }, dateString && React.createElement(\"span\", {\n    title: `首次发布于：${date.toString()}\\n最后更新于：${updatedDate.toString()}`\n  }, date.format(\"MM 月 DD 日 YYYY 年\")), (tags === null || tags === void 0 ? void 0 : tags.length) && React.createElement(\"div\", {\n    className: \"flex flex-1 flex-wrap gap-2 lg:before:content-['\\u2022']\"\n  }, tags.map(tag => React.createElement(Tag, {\n    key: tag,\n    name: tag,\n    className: \"item-secondary item-selectable\"\n  }))))), React.createElement(\"article\", {\n    ref: articleRef,\n    className: \"heti post-entry\"\n  }, isDraft && React.createElement(\"blockquote\", {\n    className: \"!border-red-400\"\n  }, \"\\u8FD9\\u662F\\u4E00\\u7BC7\", React.createElement(\"strong\", null, \"\\u672A\\u6B63\\u5F0F\\u53D1\\u5E03\"), \"\\u7684\\u535A\\u5BA2\\uFF0C\\u5185\\u5BB9\\u53EF\\u80FD\\u5C1A\\u672A\\u64B0\\u5199\\u5B8C\\u5168\\u6216\\u5B58\\u5728\\u4E00\\u4E9B\\u7EB0\\u6F0F\\uFF0C\\u5EFA\\u8BAE\\u60A8\\u4ED4\\u7EC6\\u8BC4\\u4F30\\u4FE1\\u606F\\u7684\\u6709\\u6548\\u6027\\u3002\"), timeliness !== false && diffDays > 365 && React.createElement(\"blockquote\", {\n    className: \"!border-orange-400\"\n  }, \"\\u8FD9\\u662F\\u4E00\\u7BC7\", React.createElement(\"strong\", null, \"\\u6700\\u540E\\u66F4\\u65B0\\u4E8E \", diffDays, \" \\u5929\\u524D\"), \"\\u7684\\u535A\\u5BA2\\uFF0C\\u5185\\u5BB9\\u53EF\\u80FD\\u968F\\u7740\\u65F6\\u95F4\\u7684\\u63A8\\u79FB\\u800C\\u53D8\\u5F97\\u4E0D\\u518D\\u9002\\u7528\\uFF0C\\u5EFA\\u8BAE\\u60A8\\u4ED4\\u7EC6\\u8BC4\\u4F30\\u4FE1\\u606F\\u7684\\u6709\\u6548\\u6027\\u3002\"), React.createElement(MDXProvider, {\n    components: components\n  }, children)));\n};\nconst query = \"2264136072\";\nexport const Head = _ref3 => {\n  let {data} = _ref3;\n  return React.createElement(SEO, {\n    title: String(data.mdx.frontmatter.title)\n  });\n};\nPostTemplate\nexport default function GatsbyMDXWrapper(props) {\n  return React.createElement(PostTemplate, props, React.createElement(GATSBY_COMPILED_MDX, props));\n}\n"],"names":["_createMdxContent","props","_components","Object","assign","p","span","h2","strong","h3","a","ol","li","blockquote","ul","_provideComponents","components","React","dangerouslySetInnerHTML","__html","href","wrapper","MDXLayout","_ref","children","isExternalHref","startsWith","parsedHref","encodeURIComponent","slice","target","undefined","rel","img","alt","src","restProps","Card","Link","PostTemplate","_ref2","data","mdx","fields","isDraft","frontmatter","title","date","dateString","updated","updatedDateString","categories","tags","timeliness","articleRef","dayjs","updatedDate","diffDays","diff","_articleRef$current","optimizedImageLinks","current","querySelectorAll","forEach","link","image","item","setAttribute","Fancybox","bind","unbind","className","length","Category","name","toString","format","map","tag","Tag","key","ref","MDXProvider","Head","_ref3","SEO","String","GatsbyMDXWrapper","GATSBY_COMPILED_MDX"],"sourceRoot":""}