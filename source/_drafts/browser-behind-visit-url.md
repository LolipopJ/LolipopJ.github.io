---
title: 在浏览器中输入 URL 到显示网页，背后发生了什么
date: 2021/7/8
updated: 2021/7/16
categories:
- 学习琐事
tags:
- 计算机网络
---
最近学习前端基础知识的时候，看到了这个问题和[一个回答](https://www.zhihu.com/question/34873227/answer/518086565)，非常生动有趣。遂抱着梳理的想法，将整个过程描述出来。

现在，假设您打开了浏览器，想要访问我的个人博客，您会在地址栏输入 `lolipopj.github.io` 这个 URL 然后敲下回车键。

从敲下回车键到最终顺利在浏览器显示我博客的主页，这个过程的背后发生了什么呢？

## 检查 URL 格式

别急，在正式驶入互联网的快车道之前，浏览器会首先检查输入的 URL 的格式是否正确。

例如，假如您输入的是 `lolipop j.github.io`，或是 `lolipopj.gith$ub.io`，浏览器将会判断它们为非 URL。在这种情况下，浏览器通常会将我们错误输入的 URL 作为搜索引擎的输入关键字，最终跳转到搜索结果界面。

### 什么是 URL

- [「标识互联网上的内容」](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/Identifying_resources_on_the_Web)，MDN

HTTP 请求的内容非常宽泛，统称为“资源”。“资源”可以是一份文档，一张图片，或所有您可以想象到的格式。而这样的每个“资源”，都由一个**统一资源定位符 URL** 标识。

通俗地讲，URL 可以叫作“网络地址”或“链接”，它是对指定计算机网络上某位置的**网络资源**的引用，以及检索它的机制。一个典型的 URL 可以采用 `http://www.example.com/index.html` 形式表示，它表明了使用的协议（http），访问的主机名（www.example.com）以及文件名（index.html）。

此外，URL 也可以用于文件传输（FTP），发送邮件（SMTP）和数据库访问（JDBC）等。

URL 是**统一资源标志符 URI** 的子集，由于早期 RFC 文档撰写的[一些混乱](https://danielmiessler.com/study/difference-between-uri-url/)，在实际使用中可能会发生混用的情况。在以 HTTP 为上下文的语境中，大多数情况使用 URL 即可。

### URL 格式

- [「URL」](https://en.wikipedia.org/wiki/URL)，Wikipedia

URL 符合通用 URI 语法，格式如下：

```plaintext
URI = scheme:[//authority]path[?query][#fragment]
```

其中，`authority` 部分可以划分为三个子模块：

```plaintext
authority = [userinfo@]host[:port]
```

URI 具体包括如下部分：

- **非空的** `scheme` 标识，后面跟着一个 `:`。由字母开头，后跟字母、数字、`+`、`.` 或连字符 `-` 的任意组合，规范建议使用小写格式。常见的例子有 `http:`，`https:` 和 `ftp:` 等。
- 可选的以 `//` 开头的 `authority` 权限组件，包括：
  - 可选的 `userinfo` 用户信息，可能包括用户名和用户密码，两者使用 `:` 分开。在后面跟着 `@`。出于安全考虑，应用程序不应当将用户密码部分用明文表示。
  - **非空的** `host` 主机，由注册名称（例如主机名）或 IP 地址组成。对于后者，如果是 IPv4 地址，需要使用十进制表示法；如果是 IPv6 地址，需要包括在方括号 `[]` 中。
  - 可选的以 `:` 开头的 `port` 端口号。
- **非空的** `path` 路径，由一系列 `/` 分隔的路径段组成。路径将类似或完全映射到文件系统中。此外，如果存在 `authority` 权限组件，则必须为空或以 `/` 开头；如果不存在，则不能以空路径段开头，因为这样实际上就是以 `//` 开头，将被解释为 `authority` 权限组件。
- 可选的以 `?` 开头的 `query` 查询。语法没有明确要求，通常采用键值对的形式。
- 可选的以 `#` 开头的 `fragment` 片段。用于提供对次要资源的指向，例如在 HTML 文档中，将指向包含对应 `id` 属性的元素。

## 补齐 URL

前面我们在使用 URL 时，并没有添加它的前缀例如 `https://`。那么我们具体使用的是 HTTP 协议还是 HTTPS 协议呢？

针对这种情况，浏览器有自己的预案，即默认使用 HTTP 协议。假如您是**第一次**访问我的博客（更严谨地说是第一次访问 `github.io` 域名下的网站），除非在输入的最开始就使用了 `https://lolipopj.github.io` 这个 URL，否则均会被默认补齐为 `http://lolipopj.github.io`。对于启用了 [HSTS 保护](#什么是-hsts为什么我们需要它)的网站，从第二次的访问开始，浏览器将根据第一次访问时得到的响应结果，自动补齐协议。

随着 HSTS 的推广使用，现代浏览器中还内置了一个列表 [Preload List](#hsts-的-preload-list-机制)，记录常用网站所使用的协议。对于这些网站，输入的 URL 将自动在前面补上记录的协议，再由浏览器发送请求。因此在实际情况中，第一次访问时，我们输入的 URL 就会被补齐为 **`https://lolipopj.github.io`**。

### HTTP 严格传输安全 HSTS

以下内容主要参考此文章：

- [「HSTS详解」](https://zhuanlan.zhihu.com/p/25537440)，2017-03-03

### 什么是 HSTS，为什么我们需要它

在过去，假如服务器使用的是 HTTPS 协议，当我们默认使用 `http://lolipopj.github.io` 发起请求时，也会在服务器端通过 301 重定向到 `https://lolipopj.github.io`。在这个过程中，浏览器首先使用了 HTTP 协议发起请求，得到重定向的响应后，浏览器会重新发起基于 HTTPS 协议的请求并最终与服务器建立通信。

这是一个存在风险的操作，因为在建立 HTTPS 通信之前，我们有一次明文的 HTTP 请求以及重定向操作。HTTP 主要有如下不足：

- 通信使用明文（不加密），内容可能会被窃听；
- 不验证通信方的身份，因此有可能遭遇伪装；
- 无法证明报文的完整性，所以有可能已遭篡改等。

中间人可以劫持 HTTP 请求并篡改响应，阻止建立 HTTPS 连接，跳转到钓鱼网站等。

可以想见，对于使用 HTTPS 协议的服务器，如果能从第一次开始就直接以 HTTPS 协议建立连接，跳过 HTTP + 301 重定向的步骤，便可以避免这个潜在风险了。那么，浏览器该如何知道对于哪些网站应该使用 HTTP 协议，哪些网站应该建立 HTTPS 请求呢？

这就不得不提到 **HSTS**（HTTP Strict-Transport-Security，即 HTTP 严格传输安全）了，它是一个 Web 安全策略机制。其最核心的实现，是一个 HTTP 响应头，正是它让浏览器得知，接下来的一段时间（通常设置为 1 年），对这个域名的访问都应基于 HTTPS 协议。

例如，当浏览器通过 HTTP/HTTPS 协议访问某网站，返回的响应头可能包括一项：

```plaintext
Strict-Transport-Security: max-age=31536000; includeSubDomains
```

浏览器就知道，在接下来的 31536000 秒（即 1 年）内，对该域名，以及子域名（includeSubDomains）的后续通信应该强制使用 HTTPS 进行，直到过了有效期（max-age）为止。每次相应都将刷新 HSTS 有效期；如果过了有效期，只要进行一次新的通信，又会开启一年的 HSTS 有效期。

### HSTS 加强浏览器连接保护

在 HSTS 出现以前，当浏览器发现当前网站的证书出现错误，或浏览器与服务器之间的通信不安全，或无法建立 HTTPS 连接时，浏览器会告警用户，但又允许用户继续不安全的访问。

从理论上来说，当出现此类告警时，用户应该提高警惕，终止后续的操作。然后现实是，绝大多数用户即使遇到这样的告警，也仍会继续访问。

HSTS 的出现使得事情出现了转机。对于启用了 HSTS 保护的网站，如果浏览器发现连接不安全，它将仅仅告警用户，**不再**提供继续访问的选择，进而避免后续的安全问题。

### HSTS 的 Preload List 机制

很容易发现，在第一次通过 URL 访问网站时（或浏览器没有当前网站的 HSTS 信息时），仍会默认使用明文的 HTTP 协议进行请求，然后重定向切换到 HTTPS，并刷新浏览器中的 HSTS 信息。这样，用户还是有受到中间人攻击的风险。

针对这种情况，HSTS 的应对方法是：在浏览器中内置一个列表，即 Preload List，在这个列表中的域名，无论何种情况，浏览器将**只使用** HTTPS 发起连接。

这个列表由 Google Chromium 维护。

### 加入到 HSTS Preload List

为了加入到此列表，您的站点必须满足以下需求：

1. 提供有效的证书。
2. 如果监听了 80 端口，则需要在同一主机上从 HTTP 重定向到 HTTPS。
3. 为所有子域名提供 HTTPS 服务。
4. 在根域名的 HTTP 响应头中添加 HSTS header。

您可以在 [HSTS Preload List 官网](https://hstspreload.org/)提交申请，或是了解更多相关内容。

## 通过 DNS 获取 IP 地址

TCP/IP 是能够在多个不同网络间实现信息传输的**协议簇**，它不仅仅指的是 TCP 和 IP 两个协议，而是指一个由 HTTP、HTTPS、FTP、SMTP、TCP、UDP 和 IP 等协议构成的协议簇。TCP/IP 定义了电子设备如何连入因特网，以及数据如何在它们之间传输的标准。

在 TCP/IP 概念层模型中，计算机网络体系结构自上而下分成了应用层、传输层、网络层和链路层。其中，HTTP 协议属于应用层。当客户端发出 HTTP 请求后，报文接下来将来到传输层和网络层进行处理。

浏览器会随机选用一个大于 1023（且 <= 65535）的端口号，作为当前页面通讯使用的端口，以及传输层的 TCP 协议头的 Source Port 部分，这很容易实现。

但问题是，运输层的 IP 协议需要**目标网站的 IP 地址**才能工作，而现在浏览器只有 `https://lolipopj.github.io` 这个 URL 链接，它完全无法理解。

因此，浏览器将首先联系**域名系统 DNS**（Domain Name System），一个将域名和 IP 地址相互映射的分布式数据库。我们可以通过 DNS 来查询一串 URL 链接所对应的 IP 地址。

DNS 由客户端和服务端两部分组成，其中，客户端发起查询请求，例如查询域名的 IP 地址，服务端则负责回答域名的真正 IP 地址。那么现在，DNS 客户端发起查询 `github.io` 域名 IP 地址的请求，可能经过如下步骤：

1. 首先检查本机的 DNS 缓存，没有该域名的 IP 地址信息！
2. 再查看本地硬盘中的 Host 文件，也没有！
3. 请求本地域名服务器或公共域名服务器记录的信息。这里也没有！
4. 此时，本地域名服务器或公共域名服务器会将查询请求发送给**根域名服务器**（Root name server）。根域名服务器会根据请求的 URL，将其对应的**顶级域名服务器**（Top-level domain server）的地址返回给本地域名服务器或公共域名服务器。例如，这里我们查询网址的顶级域名是 `.io`，则将此域名对应的顶级域名服务器的 IP 地址返回回来。
5. 接着，本地域名服务器或公共域名服务器会将查询请求发送给刚刚得到的顶级域名服务器。顶级域名服务器将返回管理 `github.io` 的**权威域名服务器**的 IP 地址，例如 `185.199.110.153`。继续请求此权威域名服务器，如果得知 `lolipopj.github.io` 为此域名下的 A 记录，那么此 IP 地址即为所求。
6. 查询的 IP 地址结果将缓存到本机以及本地域名服务器或公共域名服务器，用户下次查询时可以直接使用。

通常情况下，大型网站都会返回 CNAME 记录，传递给[全局流量管理 GTM 服务](#全局流量管理-gtm)，递归解析器将执行全新的 DNS 查找。通过 GTM 服务的负载均衡机制等，可以帮助用户找到最适合自己的访问的服务器 IP 地址；此外，大多数网站会做 CDN 缓存，GTM 服务也可以帮助用户找到最适合自己的 CDN 缓存服务器。

但无论如何，老天爷，浏览器可算是知道我博客的 IP 地址了。

### 递归解析器

也称为 “DNS 解析器”。

递归解析器是 DNS 查询中的第一站。递归解析器作为客户端与 DNS 域名服务器的中间人。从 Web 客户端收到 DNS 查询后，递归解析器将使用缓存的数据进行响应，或者将向根域名服务器发送请求，接着向顶级域名服务器发送另一个请求，然后向权威域名服务器发送最后一个请求。收到来自包含已请求 IP 地址的权威域名服务器的响应后，递归解析器将向客户端发送响应。

大多数用户使用他们的 ISP 提供的递归解析器，即本地域名服务器。但也可以指定公共域名服务器作为递归解析器，如 Google 的 `8.8.8.8` 或 Cloudflare 的 `1.1.1.1` 等。

### 根域名服务器

- [「根域名的知识」](https://www.ruanyifeng.com/blog/2018/05/root-domain.html)，2018-05-09

根域名服务器中记录了各个顶级域名服务器的 IP 地址信息。

由于早期的 DNS 查询结果是一个 512 字节的 UDP 数据包，这个包最多容纳 13 个服务器的地址，因此规定全世界有 13 台根域名服务器，编号从 `a.root-servers.net` 到 `m.root-servers.net`。

为了保证根域名服务器的可用性，每台服务器又有多个节点。根据[此网站](https://root-servers.org/)的统计，截止 2021 年 07 月 12 日，全球一共有 1403 台根域名服务器实例。

当需要通过根域名服务器查询顶级域名服务器时，进行请求的 DNS 服务器会向这 13 台服务器**同时**发出请求，哪一个返回的信息先到达，则使用哪一个查询得到的结果。

### 顶级域名服务器

也称为 “TLD 域名服务器”。

顶级域名服务器负责管理在该顶级域名下注册的所有二级域名。或者说，顶级域名服务器中记录了属于它的各个权威域名服务器的 IP 地址。

### 权威域名服务器

权威域名服务器是保存 DNS 名称记录（包括 A、AAAA 和 CNAME）的服务器。

权威域名服务器包含特定于其服务域名的信息。它可为递归解析器提供在 DNS A 记录中找到的服务器的 IP 地址；或者如果该域具有 CNAME 记录，它将为递归解析器提供一个别名域，这时递归解析器将必须执行全新 DNS 查找，以便从权威域名服务器获取记录（通常为包含 IP 地址的 A 记录）。

### DNS 支持 TCP 和 UDP 协议

- [「为什么 DNS 使用 UDP 协议」](https://draveness.me/whys-the-design-dns-udp-tcp/)

> 实际上，DNS 不仅使用了 UDP 协议，也使用了 TCP 协议，不过在具体介绍今天的问题之前，我们还是要对 DNS 协议进行简单的介绍：DNS 查询的类型不止包含 A 记录、CNAME 记录等常见查询，还包含 AXFR 类型的特殊查询，这种特殊查询主要用于 **DNS 区域传输**，它的作用就是在多个命名服务器之间快速迁移记录，由于查询返回的响应比较大，所以会使用 TCP 协议来传输数据包。
> ……
> 我们可以简单总结一下 DNS 的发展史，1987 年的 RFC1034 和 RFC1035 定义了最初版本的 DNS 协议，刚被设计出来的 DNS 就会同时使用 UDP 和 TCP 协议，对于绝大多数的 DNS 查询来说都会使用 UDP 数据报进行传输，TCP 协议只会在区域传输的场景中使用，其中 UDP 数据包只会传输最大 512 字节的数据，多余的会被截断；两年后发布的 RFC1123 预测了 DNS 记录中存储的数据会越来越多，同时也第一次显式的指出了**发现 UDP 包被截断时应该通过 TCP 协议重试**。
> 过了将近 20 年的时间，由于互联网的发展，人们发现 IPv4 已经不够分配了，所以**引入了更长的 IPv6**，DNS 也在 2003 年发布的 RFC3596 中进行了协议上的支持；随后发布的 RFC5011 和 RFC6376 增加了在鉴权和安全方面的支持，但是也带来了巨大的 DNS 记录，UDP 数据包被截断变得非常常见。
> RFC6891 提供的 DNS 扩展机制能够帮助我们在一定程度上解决大数据包被截断的问题，减少了使用 TCP 协议进行重试的需要，但是由于**最大传输单元的限制**，这并不能解决所有问题。
> DNS 出现之后的 30 多年，RFC7766 才终于提出了使用 TCP 协议作为主要协议来解决 UDP 无法解决的问题，TCP 协议也不再只是一种重试时使用的机制，随后出现的 DNS over TLS 和 DNS over HTTP 也都是对 DNS 协议的一种补充。

### 全局流量管理 GTM

- [「全局流量管理产品原理」](https://help.aliyun.com/document_detail/189591.html?spm=a2c4g.11186623.6.640.3198229dgDSHXU)，2020-12-11，阿里云

> 全局流量管理（GTM）支持用户就近接入、高并发负载均衡、健康检查与故障切换，可以帮助企业在短时间内构建同城多活与异地灾备的容灾架构。
> GTM 属于 DNS 级别的服务，使用 DNS 向向用户返回特定的服务地址，然后客户端用户直接连接到服务地址。

当递归解析器接收到响应的 CNAME 结果后，会再执行一遍 DNS 查找过程，得到 GTM 服务器的 IP 地址。递归解析器向 GTM 服务器发送请求，GTM 收到请求后，会根据运行机制和预配置策略向递归解析器响应最终应用服务的 IP 地址。

递归解析器将最后一次查询得到的 IP 地址作为访问 URL 的最终地址，返回给浏览器，同时缓存到本地。浏览器使用此 IP 地址直接向应用服务器发起网络连接，开始进行业务通信。

## 通过 ARP 获取 MAC 地址

- [「地址解析协议」](https://zh.wikipedia.org/wiki/%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE)，Wikipedia
- [「图解ARP协议（四）代理ARP：善意的欺骗」](https://blog.51cto.com/chenxinjie/1961255)，2017-09-01

经过传输层和网络层封装后的 HTTP 报文，现在来到了链路层。在这里，还将为它加上 MAC 头部。

> 在**以太网协议**（在点对点协议 PPP 中，知道 IP 地址就可以进行通信；本文的讨论基于以太网协议）中规定，同一局域网中的一台主机要和另一台主机进行直接通信，必须要知道目标主机的 MAC 地址……另外，当发送主机和目的主机不在同一个局域网中时，即便知道对方的 MAC 地址，两者也不能直接通信，必须经过**路由转发**才可以。

如何将已知的目标主机的 IP 地址，转换为数据链路传输需要的 MAC 地址？在 IPv4 中，这通过地址解析协议 ARP（Address Resolution Protocol）实现；在 IPv6 中，使用邻居发现协议 NDP（Neighbor Discovery Protocol）代替 ARP。

以 ARP 协议为例，它通过 ARP 请求和 ARP 响应报文确定 MAC 地址。ARP 请求报文是一种广播报文，**局域网内**的所有主机都可以收到。当某一个主机发现请求报文中的 IP 地址为自己的 IP 地址，就会发送 ARP 响应报文给发出请求报文的主机。

大多数情况下，我们需要与不在同一个局域网的主机通信，但由于每个网段都是独立的广播域，没法直接向互联网上的其它主机发送广播报文，该怎么办？网关设备就在这里大显身手了。

当主机**已设置网关**时，主机设置的网关设备将接收到 ARP 请求报文，以路由器为例：路由器发现 ARP 请求报文中的 IP 地址不属于当前局域网，就把自己的 MAC 地址响应给请求主机。后续请求主机直接使用这个 MAC 地址，将数据包传输给路由器。而数据包通过路由器的路由转发功能，最终顺利抵达互联网上对应 IP 地址的主机。

当主机**未设置网关**时，可以使用 **代理 ARP**（ARP Proxy）机制。局域网内的所有网关设备将接收到 ARP 请求报文，还是以路由器为例：路由器发现 ARP 请求报文中的 IP 地址不属于当前局域网，而是属于自己**已知的**另一个网段上的某台主机，就将自己作为代理，把自己的 MAC 地址响应给请求主机。后续请求主机直接使用这个 MAC 地址，通过路由器代理，就可以访问到局域网外的目标主机了。与 ARP 相比，代理 ARP 有如下局限：

- 代理 ARP 需要有目标网关的信息；
- 代理 ARP 每次访问新的外网地址时，都需要发送一次 ARP 请求；
- 代理 ARP 受限于沿途网络设备。例如部分路由器可能不支持此功能，而支持此功能的路由器在默认情况下一般没有启用代理 ARP。

在跨网段通信中，无论使用 ARP 还是代理 ARP，发出 ARP 请求的主机总会收到网关的 MAC 地址作为响应。

因此，在实际网络中，无论是局域网内通信，还是跨网段通信，绝大多数情况下还是使用的是 ARP，而非代理 ARP。代理 ARP 是对 ARP 的补充，是 ARP 的拓展使用。

言归正传，假如我们使用的是 IPv4 网络，通过 ARP 协议，我们将收到主机设置的网关设备的 MAC 地址，于是我们顺利为请求添加了 MAC 头部。数据包从主机传输到网关设备上，再由网关设备发出，驶入互联网的快车道。

### RARP 和 IARP

- [「图解ARP协议（六）RARP与IARP：被遗忘的兄弟协议」](https://zhuanlan.zhihu.com/p/29081692)，2017-09-05

RARP 即反向 ARP（Reverse ARP），功能与 ARP 恰巧相反，用来实现 MAC 地址到 IP 地址的映射。

一个简单的例子是，当一台主机刚刚接入网络，这时它还没有局域网分配的内网 IP 地址。通过 RARP，它可以向局域网发送广播，广播包含自己的 MAC 地址，如果局域网内有 RARP 服务器且**记录有此 MAC 地址的映射 IP 地址**，那么它将接收到 RARP 响应，于是主机就拥有了自己的 IP 地址。

RARP 有这些特性：

- RARP 服务器必须提前绑定 MAC 地址和 IP 地址。如果没有提前绑定，则服务器不会发回响应；
- RARP 服务器只能给请求的主机分配 IP 地址，不包括网关、DNS 等其它信息。

在后来，有了启动协议 BOOTP，又有了现在最常用的[动态主机设置协议 DHCP](https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol)。

> RARP 是一种逝去的地址分配技术，是 BOOTP 和 DHCP 的鼻祖，目前我们的电脑基本不会用到这个协议，只有部分无盘工作站等情况需要用到。

IARP 即逆向 ARP（Inverse ARP），在帧中继网络（广域网）中实现 DLCI 到 IP 地址的映射。在帧中继网络中，它的功能**类似于**以太网中 MAC 地址到 IP 地址的映射。

随着广域网技术的更迭，帧中继技术正慢慢被被其它技术所替代。因此 IARP 作为帧中继技术中的一环，在现实中的使用也愈来愈少。

## 通过 TCP/IP 连接服务器

在 TCP 传输数据之前，要先通过三次握手建立连接。

## 参考文章

除了正文中特别罗列出来的网站文章，还包括：

- [「在浏览器地址栏输入一个URL后回车，背后会进行哪些技术步骤？」](https://www.zhihu.com/question/34873227/answer/518086565)，2020-03-28
- [「上古面试题——浏览器地址栏输入后回车会发生什么」](https://segmentfault.com/a/1190000021000934)，2019-11-14
- [「搞懂这 9 步，DNS 访问原理就明明白白了」](https://segmentfault.com/a/1190000039650564)，2021-03-17
- [「DNS查询机制」](https://segmentfault.com/a/1190000039406281)，2021-03-13
- [「DNS 服务器有哪些不同类型？」](https://www.cloudflare.com/zh-cn/learning/dns/dns-server-types/)，Cloudflare
- [「36 张图详解 ARP ：网络世界没有我，你哪也别想去」](https://zhuanlan.zhihu.com/p/379015679)，2021-06-08
- 「图解HTTP」
