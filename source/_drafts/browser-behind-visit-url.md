---
title: 在浏览器中输入 URL 到显示网页，背后发生了什么
date: 2021/7/8
updated: 2021/7/8
categories:
- 学习琐事
tags:
- 浏览器
---
最近学习前端基础知识的时候，看到了这个问题和[一个回答](https://www.zhihu.com/question/34873227/answer/518086565)，非常生动有趣。遂抱着梳理的想法，将整个过程描述出来。

现在，假设您打开了浏览器，想要访问我的个人博客，您会在地址栏输入 `lolipopj.github.io` 这个 URL 然后敲下回车键。

从敲下回车键到最终顺利在浏览器显示我博客的主页，这个过程的背后发生了什么呢？

## 检查 URL 格式

别急，在正式驶入互联网的快车道之前，浏览器会首先检查输入的 URL 的格式是否正确。

例如，假如您输入的是 `lolipop j.github.io`，或是 `lolipopj.gith$ub.io`，浏览器将会判断它们为非 URL。在这种情况下，浏览器通常会将我们错误输入的 URL 作为搜索引擎的输入关键字，最终跳转到搜索结果界面。

### 什么是 URL

- [标识互联网上的内容](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/Identifying_resources_on_the_Web)，MDN

HTTP 请求的内容非常宽泛，统称为“资源”。“资源”可以是一份文档，一张图片，或所有您可以想象到的格式。而这样的每个“资源”，都由一个**统一资源定位符 URL** 标识。

通俗地讲，URL 可以叫作“网络地址”或“链接”，它是对指定计算机网络上某位置的**网络资源**的引用，以及检索它的机制。一个典型的 URL 可以采用 `http://www.example.com/index.html` 形式表示，它表明了使用的协议（http），访问的主机名（www.example.com）以及文件名（index.html）。

此外，URL 也可以用于文件传输（FTP），发送邮件（SMTP）和数据库访问（JDBC）等。

URL 是**统一资源标志符 URI** 的子集，由于早期 RFC 文档撰写的[一些混乱](https://danielmiessler.com/study/difference-between-uri-url/)，在实际使用中可能会发生混用的情况。在以 HTTP 为上下文的语境中，大多数情况使用 URL 即可。

### URL 格式

- [URL](https://en.wikipedia.org/wiki/URL)，Wikipedia

URL 符合通用 URI 语法，格式如下：

```plaintext
URI = scheme:[//authority]path[?query][#fragment]
```

其中，`authority` 部分可以划分为三个子模块：

```plaintext
authority = [userinfo@]host[:port]
```

URI 具体包括如下部分：

- **非空的** `scheme` 标识，后面跟着一个 `:`。由字母开头，后跟字母、数字、`+`、`.` 或连字符 `-` 的任意组合，规范建议使用小写格式。常见的例子有 `http:`，`https:` 和 `ftp:` 等。
- 可选的以 `//` 开头的 `authority` 权限组件，包括：
  - 可选的 `userinfo` 用户信息，可能包括用户名和用户密码，两者使用 `:` 分开。在后面跟着 `@`。出于安全考虑，应用程序不应当将用户密码部分用明文表示。
  - **非空的** `host` 主机，由注册名称（例如主机名）或 IP 地址组成。对于后者，如果是 IPv4 地址，需要使用十进制表示法；如果是 IPv6 地址，需要包括在方括号 `[]` 中。
  - 可选的以 `:` 开头的 `port` 端口号。
- **非空的** `path` 路径，由一系列 `/` 分隔的路径段组成。路径将类似或完全映射到文件系统中。此外，如果存在 `authority` 权限组件，则必须为空或以 `/` 开头；如果不存在，则不能以空路径段开头，因为这样实际上就是以 `//` 开头，将被解释为 `authority` 权限组件。
- 可选的以 `?` 开头的 `query` 查询。语法没有明确要求，通常采用键值对的形式。
- 可选的以 `#` 开头的 `fragment` 片段。用于提供对次要资源的指向，例如在 HTML 文档中，将指向包含对应 `id` 属性的元素。

## 补齐 URL

前面我们在使用 URL 时，并没有添加它的前缀例如 `https://`。那么我们具体使用的是 HTTP 协议还是 HTTPS 协议呢？

针对这种情况，浏览器有自己的预案，即默认使用 HTTP 协议。假如您是**第一次**访问我的博客（更严谨地说是第一次访问 `github.io` 域名下的网站），除非在输入的最开始就使用了 `https://lolipopj.github.io` 这个 URL，否则均会被默认补齐为 `http://lolipopj.github.io`。对于启用了 [HSTS 保护](#什么是-hsts为什么我们需要它)的网站，从第二次的访问开始，浏览器将根据第一次访问时得到的响应结果，自动补齐协议。

随着 HSTS 的推广使用，现代浏览器中还内置了一个列表 [Preload List](#hsts-的-preload-list-机制)，记录常用网站所使用的协议。对于这些网站，输入的 URL 将自动在前面补上记录的协议，再由浏览器发送请求。因此在实际情况中，第一次访问时，我们输入的 URL 就会被补齐为 **`https://lolipopj.github.io`**。

### HTTP 严格传输安全 HSTS

以下内容主要参考此文章：

- [HSTS详解](https://zhuanlan.zhihu.com/p/25537440)，2017-03-03，知乎

### 什么是 HSTS，为什么我们需要它

在过去，假如服务器使用的是 HTTPS 协议，当我们使用 `http://lolipopj.github.io` 发起请求时，也会在服务器端通过 301 重定向到 `https://lolipopj.github.io`。在这个过程中，我们首先使用了 HTTP 协议发起请求，得到重定向的响应后，浏览器会重新发起基于 HTTPS 协议的请求并最终与服务器建立通信。

这是一个存在风险的操作，因为在建立 HTTPS 通信之前，我们有一次明文的 HTTP 请求以及重定向操作。中间人可以劫持 HTTP 请求并篡改响应，阻止建立 HTTPS 连接，跳转到钓鱼网站等。

可以想见，对于使用 HTTPS 协议的服务器，如果能直接以 HTTPS 协议建立连接，跳过 HTTP + 301 重定向的步骤，就可以避免这个潜在风险了。那么，浏览器该如何知道对于哪些网站应该使用 HTTP 协议，哪些网站应该建立 HTTPS 请求呢？

这就不得不提到 HSTS（HTTP Strict-Transport-Security，即 HTTP 严格传输安全）了，它是一个 Web 安全策略机制。其最核心的实现，是一个 HTTP 响应头，正是它让浏览器得知，接下来的一段时间（通常设置为 1 年），对这个域名的访问都应基于 HTTPS 协议。

例如，当浏览器通过 HTTP/HTTPS 协议访问某网站，返回的响应头可能包括一项：

```plaintext
Strict-Transport-Security: max-age=31536000; includeSubDomains
```

浏览器就知道，在接下来的 31536000 秒（即 1 年）内，对该域名，以及子域名（includeSubDomains）的后续通信应该强制使用 HTTPS 进行，直到过了有效期（max-age）为止。每次相应都将刷新 HSTS 有效期；如果过了有效期，只要进行一次新的通信，又会开启一年的 HSTS 有效期。

### HSTS 加强浏览器连接保护

在 HSTS 出现以前，当浏览器发现当前网站的证书出现错误，或浏览器与服务器之间的通信不安全，或无法建立 HTTPS 连接时，浏览器会告警用户，但又允许用户继续不安全的访问。

从理论上来说，当出现此类告警时，用户应该提高警惕，终止后续的操作。然后现实是，绝大多数用户即使遇到这样的告警，也仍会继续访问。

HSTS 的出现使得事情出现了转机。对于启用了 HSTS 保护的网站，如果浏览器发现连接不安全，它将仅仅告警用户，**不再**提供继续访问的选择，进而避免后续的安全问题。

### HSTS 的 Preload List 机制

很容易发现，在第一次通过 URL 访问网站时（或浏览器没有当前网站的 HSTS 信息时），仍会默认使用明文的 HTTP 协议进行请求，然后重定向切换到 HTTPS，并刷新浏览器中的 HSTS 信息。这样，用户还是有受到中间人攻击的风险。

针对这种情况，HSTS 的应对方法是：在浏览器中内置一个列表，即 Preload List，在这个列表中的域名，无论何种情况，浏览器将**只使用** HTTPS 发起连接。

这个列表由 Google Chromium 维护。

### 加入到 HSTS Preload List

为了加入到此列表，您的站点必须满足以下需求：

1. 提供有效的证书。
2. 如果监听了 80 端口，则需要在同一主机上从 HTTP 重定向到 HTTPS。
3. 为所有子域名提供 HTTPS 服务。
4. 在根域名的 HTTP 响应头中添加 HSTS header。

您可以在 [HSTS Preload List 官网](https://hstspreload.org/)提交申请，或是了解更多相关内容。

## 通过 DNS 获取 IP 地址

在 TCP/IP 概念层模型中，计算机网络体系结构自上而下分成了应用层、传输层、网络层和链路层。其中，HTTP 协议属于应用层。当客户端发出 HTTP 请求后，报文接下来将来到传输层（这里使用 TCP 协议）和网络层（这里使用 IP 协议）进行处理。

TCP 协议将随机选用一个大于 1023 的端口号，作为当前网页通讯使用的端口，这很容易实现。

但问题是，IP 协议需要目标网站的 IP 地址才能工作，而现在浏览器只有 `https://lolipopj.github.io` 这个 URL 链接，它完全无法理解。

因此，浏览器将首先联系**域名系统 DNS**（Domain Name System），它将域名和 IP 地址相互映射的一个分布式数据库。我们可以通过 DNS 来查询一串 URL 链接所对应的 IP 地址。

DNS 由客户端和服务端两部分组成，其中，客户端发起查询请求，例如查询域名的 IP 地址，服务端则负责回答域名的真正 IP 地址。那么现在，DNS 客户端发起查询 `github.io` 域名 IP 地址的请求，可能经过如下步骤：

1. 首先检查本机的 DNS 缓存，没有该域名的 IP 地址信息！
2. 再查看本地硬盘中的 Host 文件，也没有！
3. 请求本地域名服务器或公共域名服务器记录的信息。这里也没有！
4. 此时，本地域名服务器或公共域名服务器会将查询请求发送给**根域名服务器**（Root name server）。根域名服务器会根据请求的 URL，将其对应的**顶级域名服务器**（Top-level domain server）的地址返回给本地域名服务器或公共域名服务器。例如，这里我们查询网址的顶级域名是 `.io`，则将此域名对应的顶级域名服务器的 IP 地址返回回来。
5. 接着，本地域名服务器或公共域名服务器会将查询请求发送给刚刚得到的顶级域名服务器。顶级域名服务器将返回管理 `github.io` 的**权威域名服务器**的 IP 地址，例如 `185.199.110.153`。继续请求此权威域名服务器，最终将得到 `lolipopj.github.io` 这个 URL 所对应的 IP 地址。

老天爷，浏览器可算是知道我博客的 IP 地址了。

### DNS 解析器

也称为“递归解析器”。

DNS 解析器是 DNS 查询中的第一站。递归解析器作为客户端与 DNS 域名服务器的中间人。从 Web 客户端收到 DNS 查询后，递归解析器将使用缓存的数据进行响应，或者将向根域名服务器发送请求，接着向顶级域名服务器发送另一个请求，然后向权威域名服务器发送最后一个请求。收到来自包含已请求 IP 地址的权威域名服务器的响应后，递归解析器将向客户端发送响应。

大多数用户使用他们的 ISP 提供的递归解析器，即本地域名服务器。但也可以指定公共域名服务器作为递归解析器，如 Google 的 `8.8.8.8` 或 Cloudflare 的 `1.1.1.1` 等。

### 根域名服务器

- [根域名的知识](https://www.ruanyifeng.com/blog/2018/05/root-domain.html)，2018-05-09

根域名服务器中记录了各个顶级域名服务器的 IP 地址信息。

由于早期的 DNS 查询结果是一个 512 字节的 UDP 数据包，这个包最多容纳 13 个服务器的地址，因此规定全世界有 13 台根域名服务器，编号从 `a.root-servers.net` 到 `m.root-servers.net`。

为了保证根域名服务器的可用性，每台服务器又有多个节点。根据[此网站](https://root-servers.org/)的统计，截止 2021 年 07 月 12 日，全球一共有 1403 台根域名服务器实例。

当需要通过根域名服务器查询顶级域名服务器时，进行请求的 DNS 服务器会向这 13 台服务器**同时**发出请求，哪一个返回的信息先到达，则使用哪一个查询得到的结果。

### 顶级域名服务器

也称为 “TLD 域名服务器”。

顶级域名服务器负责管理在该顶级域名下注册的所有二级域名。或者说，顶级域名服务器中记录了属于它的各个权威域名服务器的 IP 地址。

### 权威域名服务器

权威域名服务器是保存 DNS 名称记录（包括 A、AAAA 和 CNAME）的服务器。

权威域名服务器包含特定于其服务域名的信息。它可为递归解析器提供在 DNS A 记录中找到的服务器的 IP 地址；或者如果该域具有 CNAME 记录，它将为递归解析器提供一个别名域，这时递归解析器将必须执行全新 DNS 查找，以便从权威域名服务器获取记录（通常为包含 IP 地址的 A 记录）。

## 通过 TCP/IP 请求服务器

## 参考文章

除了正文中特别罗列出来的网站文章，还包括：

- [在浏览器地址栏输入一个URL后回车，背后会进行哪些技术步骤？](https://www.zhihu.com/question/34873227/answer/518086565)，2020-03-28，知乎
- [DNS查询机制](https://segmentfault.com/a/1190000039406281)，2021-03-13
- [DNS 服务器有哪些不同类型？](https://www.cloudflare.com/zh-cn/learning/dns/dns-server-types/)，Cloudflare
