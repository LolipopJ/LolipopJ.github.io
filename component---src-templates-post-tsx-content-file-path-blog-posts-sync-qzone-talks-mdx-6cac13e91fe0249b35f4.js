"use strict";(self.webpackChunkhomepage=self.webpackChunkhomepage||[]).push([[5458],{1173:function(n,s,a){a.r(s),a.d(s,{Head:function(){return f},default:function(){return h}});var t=a(8453),e=a(6540);function p(n){const s=Object.assign({p:"p",h2:"h2",h3:"h3",span:"span",a:"a",strong:"strong",ol:"ol",li:"li",blockquote:"blockquote"},(0,t.R)(),n.components);return e.createElement(e.Fragment,null,e.createElement(s.p,null,"最近在捣腾我的 Timeline 时间线项目，希望将我在不同平台上的发言和活跃记录同步过来，在独立的站点上按照创建时间倒序呈现。"),"\n",e.createElement(s.p,null,"过去，我尝试把这个想法放到 Telegram 上实现，把发言和记录同步到我的频道上。但是格式转换的繁杂以及自由度上的限制让我大费周章，加之增量开设的同步内容会以消息的方式一条一条添加到末尾，无法按时间排序，最终我放弃了这个方案。"),"\n",e.createElement(s.p,null,"言归正传，在项目开发的过程中，我遇到的一个相对复杂的场景即 QQ 空间说说的同步。本文事无巨细地记录下我在处理 QQ 空间说说同步的过程中，做了哪些工作，希望为有相应需求的厚米们带来一些灵感。"),"\n",e.createElement(s.h2,null,"同步 QQ 空间说说"),"\n",e.createElement(s.h3,null,"同步方案的探索与确定"),"\n",e.createElement(s.p,null,"非常自然而然的，笔者设想使用 Puppeteer 模拟用户操作，打开 QQ 空间网页端，输入账号和密码，进入到个人主页，根据 DOM 结构爬取得到说说的信息。同样非常自然而然的，在切换登录模式（从二维码登录到账号密码登录）步骤就卡着了，模拟点击切换登录模式按钮无效。笔者并非爬虫专家，没有此类问题的对抗经验，在搜索无果后无奈放弃。再想到后续可能还要处理登录安全验证，或处理别的防爬手段，判断 Puppeteer 的方案其实并不合适 QQ 空间说说的同步。"),"\n",e.createElement(s.p,null,"于是想到接口的方案，模拟登录请求，并把返回的 Cookies 塞给获取说说信息的请求。查看网络请求可知，H5 端的 QQ 空间使用 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://h5.qzone.qq.com/webapp/json/mqzone_feeds/getActiveFeeds</code>'}})," 接口拉取说说信息，然而同时也发现请求路径里包含了两个不存在于 Cookies 的参数：",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">qzonetoken</code>'}})," 和 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">g_tk</code>'}}),"，它是通过某种特殊算法在前端生成的！"),"\n",e.createElement(s.p,null,"既然是前端生成的，那么算法一定有迹可循，求助于搜索引擎果然找到了 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">g_tk</code>'}})," 的生成算法。"),"\n",e.createElement(s.p,null,"在搜索的过程中，还发现大家一般通过 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://user.qzone.qq.com/proxy/domain/taotao.qq.com/cgi-bin/emotion_cgi_msglist_v6</code>'}})," 接口拉取说说说信息；另外在 Github 上找到了一个高星标的 Python 实现 ",e.createElement(s.a,{href:"https://github.com/LibraHp/GetQzonehistory"},"GetQzonehistory"),"，可以基于它改巴改巴实现 Node.js 版本。"),"\n",e.createElement(s.p,null,"至此，同步方案得到了确定（毕竟实现好的 GetQzonehistory 珠玉在前），我们将通过接口的方式拉取说说信息。"),"\n",e.createElement(s.h3,null,"登录方案的确定与实现"),"\n",e.createElement(s.p,null,"现在开始实现 QQ 空间登录的功能，翻看 GetQzonehistory 源码，发现其采用了扫码登录的实现方式，这应当是有所考量的，可以绕过登录安全验证等棘手的问题，当然也存在无法自动化同步任务的问题。"),"\n",e.createElement(s.p,null,"考虑到发空间说说并不是一个高频行为，在想要同步时手动扫码是可接受的，遂沿用了",e.createElement(s.strong,null,"扫码登录"),"的实现。整体流程如下："),"\n",e.createElement(s.ol,null,"\n",e.createElement(s.li,null,"\n",e.createElement(s.p,null,"用户端：访问获取登录二维码页面。"),"\n"),"\n",e.createElement(s.li,null,"\n",e.createElement(s.p,null,"服务端：请求 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://ssl.ptlogin2.qq.com/ptqrshow</code>'}})," 接口获取登录二维码，从响应的 Cookies 里获取 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">qrsig</code>'}}),"。将登录二维码返回给用户。"),"\n"),"\n",e.createElement(s.li,null,"\n",e.createElement(s.p,null,"服务端：轮询请求 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://ssl.ptlogin2.qq.com/ptqrlogin</code>'}})," 得到扫码结果，请求的路径参数 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ptqrtoken</code>'}})," 基于上一步得到的 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">qrsig</code>'}})," 生成，生成算法如下："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token function-variable function">getPtqrToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span>qrSig<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> ptqrToken <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> qrSig<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ptqrToken <span class="token operator">+=</span> <span class="token punctuation">(</span>ptqrToken <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> qrSig<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token number">2147483647</span> <span class="token operator">&amp;</span> ptqrToken<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n"),"\n",e.createElement(s.li,null,"\n",e.createElement(s.p,null,"用户端：使用手机扫码并确认登录。"),"\n"),"\n",e.createElement(s.li,null,"\n",e.createElement(s.p,null,"服务端：轮询响应包含 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">登录成功</code>'}})," 字段，获取响应体里 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ptsigx</code>'}})," 和响应 Cookies 里键 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">uin</code>'}})," 的值。"),"\n"),"\n",e.createElement(s.li,null,"\n",e.createElement(s.p,null,"服务端：将上一步得到的 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ptsigx</code>'}})," 和 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">uin</code>'}})," 作为请求 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://ptlogin2.qzone.qq.com/check_sig</code>'}})," 的路径参数。请求成功，响应为 302 状态码，将响应的 Cookies 保存到本地，此即为所需的用户登录态 Cookies。"),"\n"),"\n"),"\n",e.createElement(s.h3,null,"同步方案的实现"),"\n",e.createElement(s.p,null,"登录态 Cookies 已解决，同步的具体实现也就轻而易举了。流程如下："),"\n",e.createElement(s.ol,null,"\n",e.createElement(s.li,null,"\n",e.createElement(s.p,null,"读取保存在本地的用户登录态 Cookies，获取 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">p_skey</code>'}})," 键对应的值，基于它生成 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">g_tk</code>'}}),"，生成算法如下："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token function-variable function">getGTk</span> <span class="token operator">=</span> <span class="token punctuation">(</span>pSkey<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> gTk <span class="token operator">=</span> <span class="token number">5381</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pSkey<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    gTk <span class="token operator">+=</span> <span class="token punctuation">(</span>gTk <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> pSkey<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> gTk <span class="token operator">&amp;</span> <span class="token number">2147483647</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n"),"\n",e.createElement(s.li,null,"\n",e.createElement(s.p,null,"请求 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://user.qzone.qq.com/proxy/domain/taotao.qq.com/cgi-bin/emotion_cgi_msglist_v6</code>'}})," 接口，将 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">g_tk</code>'}})," 作为路径参数。此外由 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">pos</code>'}})," 指定查询偏移量，",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">num</code>'}})," 指定查询条数。"),"\n"),"\n",e.createElement(s.li,null,"\n",e.createElement(s.p,null,"从响应里提取说说的具体信息，通过 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">JSON.parse()</code>'}})," 方法转换为 JSON 格式做进一步处理。其格式定义简略表示如下："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">QZoneInfo</span> <span class="token punctuation">{</span>\n  code<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n  logininfo<span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">/** 用户名 */</span>\n    name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n    <span class="token comment">/** QQ 号 */</span>\n    uin<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">/** 说说列表 */</span>\n  msglist<span class="token operator">:</span> QZoneTalk<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">/** 说说总数 */</span>\n  total<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">QZoneTalk</span> <span class="token punctuation">{</span>\n  <span class="token comment">/** 评论列表 */</span>\n  commentlist<span class="token operator">?</span><span class="token operator">:</span> QZoneTalkComment<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">/** 说说内容 */</span>\n  content<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n  <span class="token comment">/** 创建时间(s) */</span>\n  created_time<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n  <span class="token comment">/** 上次修改时间(s)。默认值为 0 */</span>\n  lastmodify<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n  <span class="token comment">/** 定位信息 */</span>\n  lbs<span class="token operator">:</span> <span class="token punctuation">{</span>\n    name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n    pos_x<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n    pos_y<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n  <span class="token comment">/** 说说图片附件（仅有图片或同时包含图片和视频时，使用该字段） */</span>\n  pic<span class="token operator">?</span><span class="token operator">:</span> QZoneTalkPic<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">/** 是否私密 */</span>\n  secret<span class="token operator">:</span> <span class="token number">0</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">;</span>\n  <span class="token comment">/** 说说 ID */</span>\n  tid<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n  uin<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n  <span class="token comment">/** 说说视频附件（仅有视频时，使用该字段） */</span>\n  video<span class="token operator">?</span><span class="token operator">:</span> QZoneTalkVideo<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n"),"\n",e.createElement(s.li,null,"\n",e.createElement(s.p,null,"根据自身需要处理得到的说说结果，完成同步的需求。"),"\n"),"\n"),"\n",e.createElement(s.h2,null,"说说视频播放优化"),"\n",e.createElement(s.p,null,"笔者心满意足地浏览着呈现在时间线项目里的 QQ 空间说说，兴趣盎然地点击了一个以前上传的视频，视频却在笔者焦虑地等待十多秒后才开始播放。这下子笔者知道又有新的问题要解决了 —— 怎么实现视频的边下载边播放？"),"\n",e.createElement(s.p,null,"求助于搜索引擎，得知 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.mp4</code>'}})," 格式的视频文件本来是可以边下载边播放的。如果不能边下载边播放，则说明描述它的",e.createElement(s.strong,null,"视频格式信息元数据"),"被放置到了视频文件的中间或末尾。一个简单且常用的处理方案是使用 ",e.createElement(s.a,{href:"https://github.com/danielgtaylor/qtfaststart"},e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">qt-faststart</code>'}}))," 工具，将这些元数据移动到视频文件的头部。"),"\n",e.createElement(s.p,null,"笔者在导出说说后，发现同时包含有 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.mp4</code>'}})," 和 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.m3u8</code>'}})," 两种格式的文件。其中 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.m3u8</code>'}})," 是播放列表文件，还需要把里面包含的视频片段文件下载到本地，不然无法正常播放。下面的代码片段供君参考："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">if</span> <span class="token punctuation">(</span>videoFilename<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".m3u8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> videoSliceFilenameMatches <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>responseData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span>\n    <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>videoFilename<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.+$</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">"gm"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> videoBaseUrl <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>videoUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>videoSliceFilenameMatches<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>videoSliceFilenameMatch<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> sliceFilename <span class="token operator">=</span> videoSliceFilenameMatch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> sliceDownloadUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>videoBaseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sliceFilename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> sliceSavePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>\n      videoSaveDir<span class="token punctuation">,</span>\n      sliceFilename<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"?"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    axios\n      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sliceDownloadUrl<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n        responseType<span class="token operator">:</span> <span class="token string">"arraybuffer"</span><span class="token punctuation">,</span>\n        maxContentLength<span class="token operator">:</span> <span class="token number">Infinity</span><span class="token punctuation">,</span> <span class="token comment">// 避免文件过大异常跳出；在下载原始视频时也应当配置此项</span>\n        maxBodyLength<span class="token operator">:</span> <span class="token number">Infinity</span><span class="token punctuation">,</span> <span class="token comment">// 同上</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>getSliceResponse<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>sliceSavePath<span class="token punctuation">,</span> getSliceResponse<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",e.createElement(s.blockquote,null,"\n",e.createElement(s.p,null,"与传统的视频格式不同，M3U8 视频格式将整个视频分成",e.createElement(s.strong,null,"多个小片段"),"进行传输，这些小片段可以根据网络情况自动调节其质量和大小。这种方式使得 M3U8 视频格式非常适合在网络环境不稳定或带宽不足的情况下播放视频。"),"\n"),"\n",e.createElement(s.p,null,"经过复杂且折腾的思想斗争后，笔者决定使用 ",e.createElement(s.a,{href:"https://ffmpeg.org"},e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ffmpeg</code>'}}))," 工具，将所有 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.mp4</code>'}})," 格式的视频文件转换为 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.m3u8</code>'}})," 格式，完成格式上的统一与边下载边播放的需求。"),"\n",e.createElement(s.h3,null,"服务端转换视频文件为 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.m3u8</code>'}})," 格式"),"\n",e.createElement(s.p,null,"服务端安装使用 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ffmpeg</code>'}})," 所需的依赖："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> fluent-ffmpeg ffmpeg-static</code></pre></div>'}}),"\n",e.createElement(s.p,null,"其中 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ffmpeg-static</code>'}})," 在安装时会自动下载一个编译好的 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ffmpeg</code>'}})," 二进制文件到本地，供 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">fluent-ffmpeg</code>'}})," 使用："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">import</span> pathToFfmpeg <span class="token keyword">from</span> <span class="token string">"ffmpeg-static"</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Ffmpeg <span class="token keyword">from</span> <span class="token string">"fluent-ffmpeg"</span><span class="token punctuation">;</span>\n\nFfmpeg<span class="token punctuation">.</span><span class="token function">setFfmpegPath</span><span class="token punctuation">(</span>pathToFfmpeg<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"将 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.mp4</code>'}})," 文件转换为 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.m3u8</code>'}})," 格式，可编写如下代码："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token function-variable function">convertVideoToM3u8</span> <span class="token operator">=</span> <span class="token punctuation">(</span>videoFilePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> outputFilePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token function">Ffmpeg</span><span class="token punctuation">(</span>videoFilePath<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">outputFormat</span><span class="token punctuation">(</span><span class="token string">"hls"</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">outputOptions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"-hls_list_size 0"</span><span class="token punctuation">,</span> <span class="token string">"-hls_allow_cache 1"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>outputFilePath<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"其中 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">outputOptions()</code>'}})," 的完整参数列表定义可以",e.createElement(s.a,{href:"https://ffmpeg.org/ffmpeg-formats.html#hls-2"},"在这里"),"找到。",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">-hls_list_size</code>'}})," 配置保留的视频片段数量，此处的视频格式转换并非直播场景，因此需要设为 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">0</code>'}}),"；",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">-hls_allow_cache</code>'}})," 即是否允许客户端缓视频片段，设为允许；另外 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">-hls_time</code>'}})," 可以配置每个视频片段的长度，默认值为 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">2</code>'}}),"（秒），此处保持默认。"),"\n",e.createElement(s.p,null,"转换后的结果如下图所示："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/f0cfb906268e9bed6d939ea3fae18181/9cea8/m3u8-results.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 55.769230769230774%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB0klEQVR42lVS2XLbMBDzj8SHZJ3URVGXJdmOHU876fT/fwfFLh03ecAsSVFYANyNm94xLh/YBhkOkfmBMCkRZQ0qN8P2K5puQdWetMq+Hc7cj4jzBkluEfCfTdsNcMQ2SLELM4Ws98fcXzQ1jmmNjo370w2WJKYZlSDieZT574IwqbBJihbNeNGuNZWIgtotKO0Jph55sdGL3XTDfP2N6+Mv1vdP3l9fRD8I35Iah+4GUzntnNe9r1VPdVaVBrzYn+443z4xX35hmO9sPKOhbREgzSWWtHAkjEvs6gVxViGiRYFYFSthUmAXJNq5Ha+Yzg8MzNtxXYqTzjsp7KT1P2F1Yh4ljjmlC3HmaxCTMEwR0nY/f1DhHyy0LQolHslTavmMSQkPcY6i7ajK6kHKTBPjIa/8RTgI4d0TylRIhna4KJHa5z4rO2y2VBE0My3XiJlZooRW8UUogbf8eVofGAlZF82kRAXzNvWgexHxzHCm5UItR0/bgkNsvin0j7IS+ihU9rJsv1l+iyvs3ZVzVVGd08NE5+9pmTMZZZYZ3nVcFsL2F6qTMVuZnycUtWnReYX7xr+y5ChWY9MoAr6yDLmcxzmj4A+J6XT9gnEeOYUYh3/0oFVAEap86AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="m3u8-results"\n        title=""\n        src="/static/f0cfb906268e9bed6d939ea3fae18181/39c09/m3u8-results.png"\n        srcset="/static/f0cfb906268e9bed6d939ea3fae18181/680fe/m3u8-results.png 156w,\n/static/f0cfb906268e9bed6d939ea3fae18181/17474/m3u8-results.png 312w,\n/static/f0cfb906268e9bed6d939ea3fae18181/39c09/m3u8-results.png 624w,\n/static/f0cfb906268e9bed6d939ea3fae18181/6d2da/m3u8-results.png 936w,\n/static/f0cfb906268e9bed6d939ea3fae18181/5a791/m3u8-results.png 1248w,\n/static/f0cfb906268e9bed6d939ea3fae18181/9cea8/m3u8-results.png 1278w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",e.createElement(s.p,null,"特别的，如果机器的运行内存不足够批量处理多个视频文件，建议封装一个串行执行 Promise 任务的方法（最近一次面试遇到的题目，居然即刻在自己的项目里用上👍🏼），依次执行转换任务，避免内存溢出导致的程序异常跳出。可参考笔者的实现："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token function-variable function">createPromiseQueue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> queue<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> isProcessing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">processQueue</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>isProcessing<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n    isProcessing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> task <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token keyword">await</span> task<span class="token operator">?.</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行任务</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Queue task failed:"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    isProcessing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 处理完成</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function-variable function">promiseFunction</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>promiseFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">processQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> addToConvertQueue <span class="token operator">=</span> <span class="token function">createPromiseQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">convertVideoToM3u8</span> <span class="token operator">=</span> <span class="token punctuation">(</span>videoFilePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> outputFilePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token function">addToConvertQueue</span><span class="token punctuation">(</span>\n    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token function">Ffmpeg</span><span class="token punctuation">(</span>videoFilePath<span class="token punctuation">)</span>\n          <span class="token punctuation">.</span><span class="token function">outputFormat</span><span class="token punctuation">(</span><span class="token string">"hls"</span><span class="token punctuation">)</span>\n          <span class="token punctuation">.</span><span class="token function">outputOptions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"-hls_list_size 0"</span><span class="token punctuation">,</span> <span class="token string">"-hls_allow_cache 1"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n          <span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>outputFilePath<span class="token punctuation">)</span>\n          <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span>\n          <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span>\n          <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.h3,null,"客户端播放 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.m3u8</code>'}})," 格式视频支持"),"\n",e.createElement(s.p,null,"浏览器自带的 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">&lt;video></code>'}})," 标签并不原生支持播放 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.m3u8</code>'}})," 格式的视频，这里笔者引入了 ",e.createElement(s.a,{href:"https://videojs.com/"},e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">video.js</code>'}}))," 库实现播放功能。基于官方提供的",e.createElement(s.a,{href:"https://videojs.com/guides/react/"},"组件实现"),"，改巴改巴实现为自己的："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="tsx"><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> videojs <span class="token keyword">from</span> <span class="token string">"video.js"</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Player <span class="token keyword">from</span> <span class="token string">"video.js/dist/types/player"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VideoPlayerProps</span> <span class="token punctuation">{</span>\n  id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n  options<span class="token operator">:</span> <span class="token punctuation">{</span>\n    sources<span class="token operator">:</span> <span class="token punctuation">{</span> src<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> type<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    controls<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n    poster<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n    preload<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">"auto"</span> <span class="token operator">|</span> <span class="token string">"metadata"</span> <span class="token operator">|</span> <span class="token string">"none"</span><span class="token punctuation">;</span>\n    <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  className<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n  onReady<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>player<span class="token operator">:</span> Player<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">/** https://videojs.com/guides/react/ */</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">VideoPlayer</span> <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token operator">:</span> VideoPlayerProps<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> options<span class="token punctuation">,</span> className <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> onReady <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> videoRef <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useRef</span><span class="token generic class-name"><span class="token operator">&lt;</span>HTMLDivElement<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> playerRef <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useRef</span><span class="token generic class-name"><span class="token operator">&lt;</span>Player<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>videoRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>playerRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> videoElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"video-js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      videoElement<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"vjs-default-skin"</span><span class="token punctuation">,</span> <span class="token string">"vjs-big-play-centered"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      videoElement<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>setup <span class="token operator">=</span> <span class="token string">\'{"fluid": true}\'</span><span class="token punctuation">;</span>\n      videoRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>videoElement<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// @ts-expect-error: playerRef is writable</span>\n      <span class="token keyword">const</span> player <span class="token operator">=</span> <span class="token punctuation">(</span>playerRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token function">videojs</span><span class="token punctuation">(</span>videoElement<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        videojs<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Video player for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is ready.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        onReady<span class="token operator">?.</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>id<span class="token punctuation">,</span> onReady<span class="token punctuation">,</span> options<span class="token punctuation">,</span> videoRef<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Dispose the Video.js player when the functional component unmounts</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> player <span class="token operator">=</span> playerRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>player <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>player<span class="token punctuation">.</span><span class="token function">isDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        player<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// @ts-expect-error: playerRef is writable</span>\n        playerRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        videojs<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Video player for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is disposed.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>id<span class="token punctuation">,</span> playerRef<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 离开视野后自动暂停播放</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> video <span class="token operator">=</span> videoRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> player <span class="token operator">=</span> playerRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>video <span class="token operator">&amp;&amp;</span> player<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> pauseObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>entry<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          player<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      pauseObserver<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        pauseObserver<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>videoRef<span class="token punctuation">,</span> playerRef<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">data-vjs-player</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>videoRef<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> VideoPlayer<span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"一切就绪，再次点击视频，缓冲条如预期般一节节加载，实现了视频的边下载边播放，可喜可贺可喜可贺！"),"\n",e.createElement(s.h3,null,"客户端构建体积（首屏速度）优化"),"\n",e.createElement(s.p,null,"如果您已经具备了一定的前端开发经验，就会对打包进项目的三方库非常敏感：打包未经（或无法）按需引入优化的三方库，意味着将三方库的全部代码塞到项目中，将导致项目的构建后体积大幅增长。在上一节中，笔者为了兼容 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.m3u8</code>'}})," 格式视频的播放，引入了广泛用于视频网站的 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">video.js</code>'}})," 库，构建播放说说视频的组件。而它就是无法按需引入的三方库，打包后的代码体积因而大幅增长："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="plaintext"><pre class="language-plaintext"><code class="language-plaintext">Route (app)                              Size     First Load JS\n┌ ○ /                                    217 kB          338 kB\n└ ○ /_not-found                          873 B          88.1 kB\n+ First Load JS shared by all            87.3 kB\n  ├ chunks/364-54e0b660da1a9f95.js       31.7 kB\n  ├ chunks/618f8807-5ab9f851e4f8eeba.js  53.6 kB\n  └ other shared chunks (total)          1.96 kB</code></pre></div>'}}),"\n",e.createElement(s.p,null,"并非每一个站长都会配置包含视频的时间线源（例如本文的 QQ 空间），首屏加载的时间线内容也并非一定包含视频内容，如果一股脑地将 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">video.js</code>'}})," 打包在首屏 JS 代码内，势必无法带来最好的访问体验。"),"\n",e.createElement(s.p,null,"幸运的是，",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">next.js</code>'}})," 已经内置了动态引入组件的方法 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">dynamic()</code>'}}),"，如果要动态引入使用到 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">video.js</code>'}})," 库的 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">&lt;VideoPlayer></code>'}})," 组件，只需要编写如下代码："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="tsx"><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> dynamic <span class="token keyword">from</span> <span class="token string">"next/dynamic"</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> VideoPlayer <span class="token operator">=</span> <span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"@/components/VideoPlayer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"如是优化后，首屏加载的 JS 体积自 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">338 kB</code>'}})," 降至 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">142 kB</code>'}}),"。等到用户遇到包含视频的时间线内容时，才会加载与视频播放相关的 JS 资源，实现了对访问体验的优化。"),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="plaintext"><pre class="language-plaintext"><code class="language-plaintext">Route (app)                              Size     First Load JS\n┌ ○ /                                    20.4 kB         142 kB\n└ ○ /_not-found                          873 B          88.2 kB\n+ First Load JS shared by all            87.4 kB\n  ├ chunks/364-54e0b660da1a9f95.js       31.7 kB\n  ├ chunks/618f8807-5ab9f851e4f8eeba.js  53.6 kB\n  └ other shared chunks (total)          2.06 kB</code></pre></div>'}}))}var o=function(n){void 0===n&&(n={});const{wrapper:s}=Object.assign({},(0,t.R)(),n.components);return s?e.createElement(s,n,e.createElement(p,n)):p(n)},c=a(197),l=a(4353),u=a.n(l),i=a(4794),r=a(6947),k=a(4017),d=a(1042),g=a(1038);const m={a:n=>{let{href:s="",children:a}=n;const t=!(null!=s&&s.startsWith("#")),p=t?s:`#${encodeURIComponent(s.slice(1))}`;return e.createElement("a",{href:p,target:t?"_blank":void 0,rel:"noreferrer"},a)},img:n=>{const{alt:s="The author is too lazy to give an alt",src:a,...t}=n;return e.createElement("a",{href:a,"data-fancybox":"gallery","data-caption":s},e.createElement("img",Object.assign({src:a,alt:s},t)))},Card:r.A,Link:i.Link},y=n=>{let{children:s,data:a}=n;const{mdx:{frontmatter:{title:p,date:o,updated:l,categories:i,tags:r,timeliness:d}}}=a,y=e.useRef(null),f=u()(o),h=l?u()(l):f,E=u()().diff(h,"days");return e.useEffect((()=>{var n;const s=null===(n=y.current)||void 0===n?void 0:n.querySelectorAll("a.gatsby-resp-image-link");return null==s||s.forEach((n=>{const s=n.children.item(1);n.setAttribute("data-fancybox","gallery"),n.setAttribute("data-caption",s.alt)})),c.lX.bind("[data-fancybox]"),()=>c.lX.unbind("[data-fancybox]")}),[]),e.createElement("div",{className:"mx-auto flex max-w-xl flex-col gap-y-12"},e.createElement("div",{className:"flex flex-col gap-4"},(null==i?void 0:i.length)&&e.createElement(k.A,{name:i[0],className:"item-selectable"}),e.createElement("h1",{className:"text-3xl font-bold"},p),e.createElement("div",{className:"item-secondary flex flex-col gap-2 lg:flex-row"},o&&e.createElement("span",{title:`首次发布于：${f.toString()}\n最后更新于：${h.toString()}`},f.format("MM 月 DD 日 YYYY 年")),(null==r?void 0:r.length)&&e.createElement("div",{className:"flex flex-1 flex-wrap gap-2 lg:before:content-['•']"},r.map((n=>e.createElement(g.A,{key:n,name:n,className:"item-secondary item-selectable"})))))),e.createElement("article",{ref:y,className:"heti post-entry"},!1!==d&&E>365&&e.createElement("blockquote",{className:"border-l-4 border-orange-400"},"这是一篇",e.createElement("strong",null,"最后更新于 ",E," 天前"),"的博客，内容可能随着时间的推移而变得不再适用，建议您仔细评估信息的有效性。"),e.createElement(t.x,{components:m},s)))},f=n=>{let{data:s}=n;return e.createElement(d.A,{title:String(s.mdx.frontmatter.title)})};function h(n){return e.createElement(y,n,e.createElement(o,n))}}}]);
//# sourceMappingURL=component---src-templates-post-tsx-content-file-path-blog-posts-sync-qzone-talks-mdx-6cac13e91fe0249b35f4.js.map