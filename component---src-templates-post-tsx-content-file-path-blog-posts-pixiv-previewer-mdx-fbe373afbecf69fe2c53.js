"use strict";(self.webpackChunkhomepage=self.webpackChunkhomepage||[]).push([[5319],{4071:function(n,a,s){s.r(a),s.d(a,{Head:function(){return h},default:function(){return f}});var e=s(8453),t=s(6540);function p(n){const a=Object.assign({p:"p",ol:"ol",li:"li",strong:"strong",a:"a",h2:"h2",h3:"h3",span:"span",ul:"ul"},(0,e.R)(),n.components);return t.createElement(t.Fragment,null,t.createElement(a.p,null,"笔者的业余爱好之一就是逛 Pixiv，收藏好看的插画等作品并下载到本地。油猴脚本 Pixiv Previewer 做了两个笔者很喜欢的便利性工作："),"\n",t.createElement(a.ol,null,"\n",t.createElement(a.li,null,t.createElement(a.strong,null,"作品预览"),"：鼠标悬浮在作品缩略图上时自动在当前页面显示大图，快速决定要不要点进作品页。"),"\n",t.createElement(a.li,null,t.createElement(a.strong,null,"作品排序"),"：作品搜索页可以按“排序”按钮，自动获取若干页的作品并按照收藏数排序，快速筛选优质作品。"),"\n"),"\n",t.createElement(a.p,null,"出于爱好，笔者去",t.createElement(a.a,{href:"https://github.com/Ocrosoft/PixivPreviewer"},"脚本仓库"),"翻阅了一下源码，觉得有一些可以改进的地方，遂 Fork 之，进行二次开发。"),"\n",t.createElement(a.h2,null,"工程化改造"),"\n",t.createElement(a.p,null,"首当其冲的自然是前端项目工程化改造。大多数油猴脚本仓库都是孤零零的一个 JavaScript 文件，Pixiv Previewer 也不例外。直接手搓 JavaScript 虽然很便利，但在项目长期的维护开发中多半会掩埋掉许多未曾留意的 Bug，同时由于缺少关联提示，开发效率也会大打折扣。作为前端工程师，这样可怕的事情自然是不能接受的。"),"\n",t.createElement(a.h3,null,"通过 tsup 构建项目"),"\n",t.createElement(a.p,null,"初始化 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">package.json</code>'}})," 等过程跳过不表，添加 TypeScript 支持自然是对项目进行二次开发的前置步骤。由于我们最后构建的产物将作为油猴脚本运行，即打包为库，因此笔者选择了开箱即用的 ",t.createElement(a.a,{href:"https://github.com/egoist/tsup"},"tsup"),"："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> <span class="token parameter variable">-D</span> tsup</code></pre></div>'}}),"\n",t.createElement(a.p,null,"添加 tsup 的配置文件 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">tsup.config.ts</code>'}}),"："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"tsup"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> packageJson <span class="token keyword">from</span> <span class="token string">"./package.json"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  entry<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"src/index.ts"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  target<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"chrome107"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  splitting<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  clean<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  env<span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token constant">VERSION</span><span class="token operator">:</span> packageJson<span class="token punctuation">.</span>version<span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  banner<span class="token operator">:</span> <span class="token punctuation">{</span>\n    js<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">// ==UserScript==\n// @name                PixivPreviewerL\n// @namespace           </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJson<span class="token punctuation">.</span>homepage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n// @version             </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJson<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n// @description         </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJson<span class="token punctuation">.</span>description<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n// @author              </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJson<span class="token punctuation">.</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n// @match               *://www.pixiv.net/*\n// @grant               unsafeWindow\n// @grant               GM.xmlHttpRequest\n// @grant               GM_xmlhttpRequest\n// @license             </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJson<span class="token punctuation">.</span>license<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n// @icon                https://t0.gstatic.com/faviconV2?client=SOCIAL&amp;type=FAVICON&amp;fallback_opts=TYPE,SIZE,URL&amp;size=32&amp;url=https://www.pixiv.net\n// @icon64              https://t0.gstatic.com/faviconV2?client=SOCIAL&amp;type=FAVICON&amp;fallback_opts=TYPE,SIZE,URL&amp;size=64&amp;url=https://www.pixiv.net\n// @require             https://raw.githubusercontent.com/Tampermonkey/utils/refs/heads/main/requires/gh_2215_make_GM_xhr_more_parallel_again.js\n// ==/UserScript==</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"上面的配置表示，tsup 将打包构建源文件 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">src/index.ts</code>'}})," 至默认产物文件 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">dist/index.js</code>'}}),"，保证兼容 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">Chrome >= 107</code>'}}),"。其中，笔者复用了 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">package.json</code>'}})," 里定义的若干字段，用于添加项目环境变量（脚本通过版本号判断是否显示更新日志框），以及生成油猴脚本顶部的配置项。"),"\n",t.createElement(a.p,null,"这样，当执行 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">tsup</code>'}})," 命令时，构建的产物形如："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// ==UserScript==</span>\n<span class="token comment">// @name                PixivPreviewerL</span>\n<span class="token comment">// @namespace           https://github.com/LolipopJ/PixivPreviewer</span>\n<span class="token comment">// @version             0.1.3-2025/3/17</span>\n<span class="token comment">// @description         Original project: https://github.com/Ocrosoft/PixivPreviewer.</span>\n<span class="token comment">// @author              Ocrosoft, LolipopJ</span>\n<span class="token comment">// @match               *://www.pixiv.net/*</span>\n<span class="token comment">// @grant               unsafeWindow</span>\n<span class="token comment">// @grant               GM.xmlHttpRequest</span>\n<span class="token comment">// @grant               GM_xmlhttpRequest</span>\n<span class="token comment">// @license             GPL-3.0</span>\n<span class="token comment">// @icon                https://t0.gstatic.com/faviconV2?client=SOCIAL&amp;type=FAVICON&amp;fallback_opts=TYPE,SIZE,URL&amp;size=32&amp;url=https://www.pixiv.net</span>\n<span class="token comment">// @icon64              https://t0.gstatic.com/faviconV2?client=SOCIAL&amp;type=FAVICON&amp;fallback_opts=TYPE,SIZE,URL&amp;size=64&amp;url=https://www.pixiv.net</span>\n<span class="token comment">// @require             https://raw.githubusercontent.com/Tampermonkey/utils/refs/heads/main/requires/gh_2215_make_GM_xhr_more_parallel_again.js</span>\n<span class="token comment">// ==/UserScript==</span>\n\n<span class="token comment">// ... 脚本构建后的代码</span></code></pre></div>'}}),"\n",t.createElement(a.h3,null,"代码质量检查与格式化工具"),"\n",t.createElement(a.p,null,"TypeScript 自身已包含类型检查等能力，但还可以引入更多质量检查的通用规范，提升项目的健壮性。对于 TypeScript 项目，目前来看最好的选择应当是 ",t.createElement(a.a,{href:"https://github.com/typescript-eslint/typescript-eslint"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">typescript-eslint</code>'}})),"，参考官方文档添加依赖并配置 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">eslint.config.mjs</code>'}}),"："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> <span class="token parameter variable">--dev</span> eslint @eslint/js typescript typescript-eslint</code></pre></div>'}}),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// @ts-check</span>\n\n<span class="token keyword">import</span> eslint <span class="token keyword">from</span> <span class="token string">"@eslint/js"</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> tseslint <span class="token keyword">from</span> <span class="token string">"typescript-eslint"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> tseslint<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span>\n  eslint<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>recommended<span class="token punctuation">,</span>\n  tseslint<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>recommended<span class="token punctuation">,</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"现在执行 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">eslint src --fix</code>'}})," 即可查找并尝试修复 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">src/</code>'}})," 目录下所有文件的质量问题。"),"\n",t.createElement(a.p,null,"接着为项目添加自动格式化能力，Prettier 是笔者最推荐的选项。此外，笔者喜欢将 Prettier 与 ESLint 结合起来一起使用，即在执行 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">eslint src --fix</code>'}})," 修复质量问题的同时，自动格式化代码。ESLint 的插件 ",t.createElement(a.a,{href:"https://github.com/prettier/eslint-plugin-prettier"},t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">eslint-plugin-prettier</code>'}}))," 可以实现如上能力，添加此插件作为依赖并进一步配置 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">eslint.config.mjs</code>'}}),"："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> <span class="token parameter variable">-D</span> prettier eslint-plugin-prettier eslint-config-prettier</code></pre></div>'}}),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// @ts-check</span>\n\n<span class="token keyword">import</span> eslint <span class="token keyword">from</span> <span class="token string">"@eslint/js"</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> tseslint <span class="token keyword">from</span> <span class="token string">"typescript-eslint"</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> eslintPluginPrettierRecommended <span class="token keyword">from</span> <span class="token string">"eslint-plugin-prettier/recommended"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> tseslint<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span>\n  eslint<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>recommended<span class="token punctuation">,</span>\n  tseslint<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>recommended<span class="token punctuation">,</span>\n  eslintPluginPrettierRecommended<span class="token punctuation">,</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"此外，Pixiv Previewer 项目依赖于 JQuery 来执行查找与修改 DOM 的操作，笔者添加了相应的类型提示："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> <span class="token parameter variable">-D</span> @types/jquery globals</code></pre></div>'}}),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// @ts-check</span>\n\n<span class="token keyword">import</span> eslint <span class="token keyword">from</span> <span class="token string">"@eslint/js"</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> tseslint <span class="token keyword">from</span> <span class="token string">"typescript-eslint"</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> eslintPluginPrettierRecommended <span class="token keyword">from</span> <span class="token string">"eslint-plugin-prettier/recommended"</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> globals <span class="token keyword">from</span> <span class="token string">"globals"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> tseslint<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span>\n  eslint<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>recommended<span class="token punctuation">,</span>\n  tseslint<span class="token punctuation">.</span>configs<span class="token punctuation">.</span>recommended<span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    <span class="token literal-property property">languageOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token literal-property property">globals</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token operator">...</span>globals<span class="token punctuation">.</span>browser<span class="token punctuation">,</span>\n        <span class="token operator">...</span>globals<span class="token punctuation">.</span>jquery<span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  eslintPluginPrettierRecommended<span class="token punctuation">,</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"至此，基本的项目工程化改造告一段落。项目可以基于 TypeScript 开发，并且拥有了质量检查和格式化能力。将原来的 JavaScript 代码放到 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">src/index.ts</code>'}})," 文件里，开始正式的二次开发吧！"),"\n",t.createElement(a.h2,null,"预览功能优化"),"\n",t.createElement(a.p,null,"笔者在阅读 Pixiv Previewer 源码时发现，原作者根据当前页面的不同，实现了不同的通过 DOM 节点寻找可预览作品的 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">&lt;img></code>'}})," 标签的方法，并为它添加监听事件，当鼠标悬浮在上面的时候显示预览。为了应对作品动态加载的情况，脚本设置了循环定时器，每隔一小段时间重新执行上述方法。"),"\n",t.createElement(a.p,null,"这种力大砖飞的实现方案存在一个不可忽视的缺陷：要考虑到每个页面里不同的作品 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">&lt;img></code>'}})," 标签的排布情况，为之实现绑定事件的方法。对于没有考虑到的作品 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">&lt;img></code>'}})," 标签，自然无法显示预览。例如，在当前的 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">Pixiv Previewer@3.7.32</code>'}})," 版本，主页“插画约稿作品”处的作品就无法显示预览："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/be36310c484497f2f0c9aa4d35ef38a9/9c1e6/unimplemented-preview.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 38.46153846153846%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABxUlEQVR42k2Sy2oUURCG+xV0pid9v5/uPn23Z5WNOEtBiCCZRAMudOE4QTQzRIgrs0tg1J3gagRBiAouXLjyNXyd36ozTHDxQ3XV+evU+aq1yWSCqqpgmiYcx1HyfR+e56nYdd3rPIvz29r/9SAIEEURtL4fo+s61bRpGtR1Dd/zVVOOWdsai01s5pjz2zNlWaq8VhQFclkgI8mSlBd0q4MwDNGSqSxK5HkOKaUy8XRJItC2LRIhkLM/y5CmqZpWc10PoeegSHwEtg1ROIhSm4ybZ1umAT8IaeJAYTFIkswxXSiiGJKay4aQWSZsy4Y2Go3w+N5dvD+Z4c2j+2izGAYXbeLjWJhO9/Fl/R2ri4/07VLexsgwcItecnX6Fl8XZ/i7/oFx00GnXppJExzsHWE+PcK7+QzjPMXNoU5GSzW9/PAZv69+4ez0nDAk2CHTjmGiTgW+nbzEz+USf5av0VcN+QbQPIJfCYm923ew2D/Ebt3gxmBwDf/Z02O8ePIc89mCGLfQ9aFaWEbPfvXgIVaHB/i0PEYtSwx1HRrD5iVExEM1IVb8G/R9r2CLdANc0mK4EYPv2gaCFhKHMSmic1QLNsz/AQIJ+lxCv4MMAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="“插画约稿作品”暂未实现预览功能"\n        title=""\n        src="/static/be36310c484497f2f0c9aa4d35ef38a9/39c09/unimplemented-preview.png"\n        srcset="/static/be36310c484497f2f0c9aa4d35ef38a9/680fe/unimplemented-preview.png 156w,\n/static/be36310c484497f2f0c9aa4d35ef38a9/17474/unimplemented-preview.png 312w,\n/static/be36310c484497f2f0c9aa4d35ef38a9/39c09/unimplemented-preview.png 624w,\n/static/be36310c484497f2f0c9aa4d35ef38a9/6d2da/unimplemented-preview.png 936w,\n/static/be36310c484497f2f0c9aa4d35ef38a9/5a791/unimplemented-preview.png 1248w,\n/static/be36310c484497f2f0c9aa4d35ef38a9/9c1e6/unimplemented-preview.png 1734w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",t.createElement(a.p,null,"另外，如果 Pixiv 前端页面某一天迭代更新，寻找作品 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">&lt;img></code>'}})," 标签的方法也可能需要大刀阔斧地修改。"),"\n",t.createElement(a.p,null,"笔者想到的改进方案是：把找作品 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">&lt;img></code>'}})," 标签的工作，从脚本手中移交到用户手中。即监听鼠标移动事件，当悬浮到可预览作品上时，显示预览。"),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token function-variable function">onMouseMove</span> <span class="token operator">=</span> <span class="token punctuation">(</span>mouseMoveEvent<span class="token operator">:</span> JQuery<span class="token punctuation">.</span>MouseMoveEvent<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token function">onMouseOverIllust</span><span class="token punctuation">(</span>mouseMoveEvent<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> onMouseMove<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"在上面的代码里，笔者为 Document 全局绑定了 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">mousemove</code>'}})," 监听事件，当鼠标移动时，调用 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">onMouseOverIllust(target)</code>'}})," 方法，其中 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">target</code>'}})," 是当前鼠标所悬浮的元素。如果监听的是 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">mouseover</code>'}})," 事件，脚本可以有更好的性能表现，但是笔者在测试过程中，发现 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">mouseover</code>'}})," 事件回调对象里的 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ctrlKey</code>'}})," 等值有时不能正确反映实际状态，所以这里选择了监听 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">mousemove</code>'}})," 事件。"),"\n",t.createElement(a.p,null,"接着，需要判断鼠标当前悬浮的元素是否为可预览的作品，如果是则显示预览。观察 DOM 节点："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/e23c9d6ac90d75299fec98ea1cfe8de9/d073d/hovered-illust.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 57.05128205128205%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACdklEQVR42m2SS2sTURiGsxHdSC+p1iRNm15IJslkMpM5k2TSZDKTaXpJbaVI0ZULL91IFxURiuBKdNFFd0UXCiKIIILQigsRusrvqG68gIuCy5THM6ktoh14OHOYM+/5vvd7Q7lcDrtSwRIWY2NjjI6OHpNIJBgZGSGVSqEoyjGpZApRyePNODQ9k4WpAi3fpFrNEdJ1nYbnYdt29+fh4bhc43Id7u7j8fj/gnJvllVqjodTn6JZr9GatDCFFIxGo/JQCkM38FyfWs2TN3n4/hRCCGKxGMlksityRFJWqFsZClYFYXuUijYVq4woZAkdtbZ6e5VvX3/y+csP9va+s7//i52dbQYHB1FVFU3TCOw5Qtg5SmYBt2zjlIuIUhXT0giNj48TiURZWblF8BwcdOh0Ot33drvdFcxms13RvwlaNkyBP71Ic/4y3twyFc8lFPgUDvczNbfIi7efePb6PU9ffeDBo00uzrcILPm35QCtkCSvF/BbyzjeLNN1H9cpE4pL8wfCfZS8Bdaf7HJnc5v7Wx9xL93gzOlTDJ0wlIC8lcZQFZyiYFKYNM0M1WImqDDBQH8vtdkr3NvaZW3jDRsv2yxdW6O/r7db4UmCmlDQNR3b0CnlpceZLLl8mlDgX7ivB1Ff4Objd9zd3OHh8zbL19fp7Tkr/Y2cEBuFQknBtCsY5SqGkcPQMghLTtmVGVSl6ROKSslfojIjPWldxSg6srrInxwmSafTh2QkUtSSuSvXbXlOleISkZFTVggFN05MTBAfihG9cI7I4AAXzvcTk2KJxGGkNNlaXWbU86clTRy3gd9cwG3MUq25uPJbtdEi31jiN91meok3JPzJAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="作品 DOM 节点"\n        title=""\n        src="/static/e23c9d6ac90d75299fec98ea1cfe8de9/39c09/hovered-illust.png"\n        srcset="/static/e23c9d6ac90d75299fec98ea1cfe8de9/680fe/hovered-illust.png 156w,\n/static/e23c9d6ac90d75299fec98ea1cfe8de9/17474/hovered-illust.png 312w,\n/static/e23c9d6ac90d75299fec98ea1cfe8de9/39c09/hovered-illust.png 624w,\n/static/e23c9d6ac90d75299fec98ea1cfe8de9/6d2da/hovered-illust.png 936w,\n/static/e23c9d6ac90d75299fec98ea1cfe8de9/5a791/hovered-illust.png 1248w,\n/static/e23c9d6ac90d75299fec98ea1cfe8de9/d073d/hovered-illust.png 1297w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",t.createElement(a.p,null,"如果当前鼠标悬浮在可预览的作品 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">&lt;img></code>'}})," 元素上，则本身包含了访问链接的 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">src</code>'}})," 属性，通过简单的正则表达式处理即可获取作品的 Pixiv ID 和大图链接。同时，外层还包裹着一层 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">&lt;a></code>'}})," 元素，包含跳转链接。"),"\n",t.createElement(a.p,null,"考虑到部分 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">&lt;img></code>'}})," 元素虽然包含作品缩略图的 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">src</code>'}})," 属性，但跳转的页面并不一定是作品页（",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://www.pixiv.net/artworks/artwork-id</code>'}}),"），而是别的页面，鼠标悬浮在这些 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">&lt;img></code>'}})," 元素上时不应当显示预览。因此笔者实现的判断方法，统一取当前悬浮元素的第一个父 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">&lt;a></code>'}})," 节点，当其 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">href</code>'}})," 值满足 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/\\/artworks\\/(\\d+)/</code>'}})," 时，显示预览："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token function-variable function">getIllustMetadata</span> <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> JQuery<span class="token operator">&lt;</span>HTMLElement<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> imgLink <span class="token operator">=</span> target<span class="token punctuation">;</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>imgLink<span class="token punctuation">.</span><span class="token keyword">is</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    imgLink <span class="token operator">=</span> imgLink<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imgLink<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> illustHref <span class="token operator">=</span> imgLink<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> illustHrefMatch <span class="token operator">=</span> illustHref<span class="token operator">?.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\/artworks\\/(\\d+)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>illustHrefMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">const</span> illustId <span class="token operator">=</span> illustHrefMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> ugoiraSvg <span class="token operator">=</span> imgLink<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token string">"div:first"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">"svg:first"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> illustType <span class="token operator">=</span>\n    ugoiraSvg<span class="token punctuation">.</span>length <span class="token operator">||</span> imgLink<span class="token punctuation">.</span><span class="token function">hasClass</span><span class="token punctuation">(</span><span class="token string">"ugoku-illust"</span><span class="token punctuation">)</span>\n      <span class="token operator">?</span> IllustType<span class="token punctuation">.</span><span class="token constant">UGOIRA</span> <span class="token comment">// 动图作品</span>\n      <span class="token operator">:</span> IllustType<span class="token punctuation">.</span><span class="token constant">ILLUST</span><span class="token punctuation">;</span> <span class="token comment">// 插画或漫画作品</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token comment">/** 作品 ID */</span>\n    illustId<span class="token punctuation">,</span>\n    <span class="token comment">/** 作品类型 */</span>\n    illustType<span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">onMouseOverIllust</span> <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> JQuery<span class="token operator">&lt;</span>HTMLElement<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token keyword">is</span><span class="token punctuation">(</span><span class="token string">"IMG"</span><span class="token punctuation">)</span> <span class="token operator">||</span> target<span class="token punctuation">.</span><span class="token keyword">is</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 当前当前鼠标悬浮元素不是作品或作品链接，跳过</span>\n    <span class="token keyword">return</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> illustId<span class="token punctuation">,</span> illustType <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getIllustMetadata</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>illustId <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> illustType <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 获取当前鼠标悬浮元素的元数据失败，跳过</span>\n    <span class="token keyword">return</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">previewIllust</span><span class="token punctuation">(</span><span class="token punctuation">{</span> target<span class="token punctuation">,</span> illustId<span class="token punctuation">,</span> illustType <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",t.createElement(a.p,null,"插画或漫画作品可能存在多页，处理时可以始终调用 Pixiv 官方的接口 ",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/ajax/illust/${artwork-id}/pages</code>'}}),"，获取指定作品包含的所有链接。"),"\n",t.createElement(a.p,null,"再修修补补，为事件加上节流函数，响应鼠标滚动切换页数等，实现了和原版并无二异的预览能力："),"\n",t.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/d209c773392509f97e2c18c952a1edac/04784/previewer.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 75.64102564102564%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEDUlEQVR42i2U20/TZxjHe4WHuAud0+Eo9AD2SJG29CQVKPTXc38UyqEtXWk5jJNVKAgSQU2ceJhbZF5MzWaii5IsqFmyZJEtokbd4qKbW1yiu1+WXbj/4LM3xotvnvfm/TyH75NHUVlZSUVFBUqlkkohlVrLO1u3s3nTJjZs2EBZWRkbN26k7O17y5YtbN68iR07d7Br1wdse28nKpWKqqqqN1JotVpMJhM6vR6NRk1FpQp1jQ6TYTc11Rr0NdVYzAbcVht7dptwWkQ0mDDUGKk1GdFqNG9AKtVboMVSSyLRjuSX0Ov0VO/W0ypJFDK99PUkhTrp7+hE9oVodPmwWxtJNMYY6hxgtj9PJCihVlej0xlQa6tRmIwG5HCASGsbLQ1e4k1+2uU4g5kecqluPkx1Md7RQ1DAbK5m6m0ePPUuFp1RJvsyBGMJ8oURVq5cIRhNoLDX1TKWSRJuaSHS2IK13kFHPEYxl2JUaDibYmIgi8/bzGiih/nCELLDT9LsoUskHh4YZKY4xe2rlynuHxXAWiNZqYlmm5MGAau1ukm1yxwZzjIpQBPZNMV8H/FAmExbnIPpDCGvD4PFgWNvE7OlGU7PzbOvKUSiK4nCabdxoHSEowdK5KIRWoMia2+SRQGcKWRERRk+6ozj2mOnTm9jSI4RaG7BKUZgtFiZmDvKg7XvWTp1hu7eXlGhzUZXXx57gxuHMMiyx0pBAM4WCyyNF5jskXGbzNRrjNTrLDR5vBiNddjFHCVhlNMXIBoJE5LaMJvNwmWDAZtYC2WlErVYgW073qfD38KRrMxUd4x0KEZbawyXyYqz1kU+m8fhcAu395JO5qhr8FChrEKp0or/WhSNXi9319e5du0abpeT4yc+ptDdweF0nJDbLdoLkQvHWZ4+SNwfp00YZ7facXraCEgJinNnWFt/yc07fzJ1bBlFMBji9ev/ePnqFYsLC9x/9JghsX8TXTKpcISYT2IqFmL12Cynpqdodu9Fo7ewzxfF0yQxXJikNHGSh/f+4uSFGyjCoRD//vM3K9evU8jn+fmXp4xkUpQyXSwO5Lg8P8NgIMiCHObW4iG+/ewTjDozbo8P2R+lPzPKpdkFHt35iU8/vyqAkSiPf39FcyDCpYtf8OTpr5xZOsHFw0XmM92cGOxnIpWmPxDg/FCOZ7dXkaUw5w4fIt3eQ7YwzfJYkWfrT1j55jYKq83OSGmegdH9jI2OEI7JHD92lLUbX7J68TwX5kssDA/R5/cR93r4Y+07frt3l+c/rrG8dJJQMove0ECivZu4LKOoMxvZ52pAr9dRJS7P1ne3c/rcOV68eM6Dh/f54dZ1To8VmC7k6AhJzIxPMjg8x/iBJb7+6iYDwvXy8p3i8pSLWM7/w8ZTI132ipsAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Pixiv 预览"\n        title=""\n        src="/static/d209c773392509f97e2c18c952a1edac/39c09/previewer.png"\n        srcset="/static/d209c773392509f97e2c18c952a1edac/680fe/previewer.png 156w,\n/static/d209c773392509f97e2c18c952a1edac/17474/previewer.png 312w,\n/static/d209c773392509f97e2c18c952a1edac/39c09/previewer.png 624w,\n/static/d209c773392509f97e2c18c952a1edac/6d2da/previewer.png 936w,\n/static/d209c773392509f97e2c18c952a1edac/04784/previewer.png 1174w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",t.createElement(a.p,null,"可喜可贺，可喜可贺！"),"\n",t.createElement(a.h2,null,"排序功能优化"),"\n",t.createElement(a.p,null,"原脚本的预览功能已经能够非常好地实现笔者需要的能力了，笔者想要在此基础上加入一些额外的能力或做一些优化，如："),"\n",t.createElement(a.ul,null,"\n",t.createElement(a.li,null,"Feature：支持按照发布日期排序（相当于过滤掉收藏量小于指定值的作品）。"),"\n",t.createElement(a.li,null,"Feature：支持在用户作品页进行排序。"),"\n",t.createElement(a.li,null,"Feature：排序结果高亮显示“优质作品”，即收藏量增长速率高的作品。需要定义并实现增长速率函数。"),"\n",t.createElement(a.li,null,"Performance：排序结果滑动到底部时加载更多，避免一次性渲染全部导致内存占用过大。"),"\n"),"\n",t.createElement(a.p,null,"但是目前仍处于咕咕咕状态，敬请期待 XD"))}var o=function(n){void 0===n&&(n={});const{wrapper:a}=Object.assign({},(0,e.R)(),n.components);return a?t.createElement(a,n,t.createElement(p,n)):p(n)},c=s(197),l=s(4353),i=s.n(l),r=s(4794),u=s(6947),k=s(4017),g=s(1042),d=s(1038);const m={a:n=>{let{href:a="",children:s}=n;const e=!(null!=a&&a.startsWith("#")),p=e?a:`#${encodeURIComponent(a.slice(1))}`;return t.createElement("a",{href:p,target:e?"_blank":void 0,rel:"noreferrer"},s)},img:n=>{const{alt:a="The author is too lazy to give an alt",src:s,...e}=n;return t.createElement("a",{href:s,"data-fancybox":"gallery","data-caption":a},t.createElement("img",Object.assign({src:s,alt:a},e)))},Card:u.A,Link:r.Link},y=n=>{let{children:a,data:s}=n;const{mdx:{frontmatter:{title:p,date:o,updated:l,categories:r,tags:u,timeliness:g=!0}}}=s,y=t.useRef(null),h=i()(o),f=l?i()(l):h,w=i()().diff(f,"days");return t.useEffect((()=>{var n;const a=null===(n=y.current)||void 0===n?void 0:n.querySelectorAll("a.gatsby-resp-image-link");return null==a||a.forEach((n=>{const a=n.children.item(1);n.setAttribute("data-fancybox","gallery"),n.setAttribute("data-caption",a.alt)})),c.lX.bind("[data-fancybox]"),()=>c.lX.unbind("[data-fancybox]")}),[]),t.createElement("div",{className:"mx-auto flex max-w-xl flex-col gap-y-12"},t.createElement("div",{className:"flex flex-col gap-4"},(null==r?void 0:r.length)&&t.createElement(k.A,{name:r[0],className:"item-selectable"}),t.createElement("h1",{className:"text-3xl font-bold"},p),t.createElement("div",{className:"item-secondary flex flex-col gap-2 lg:flex-row"},o&&t.createElement("span",{title:`首次发布于：${h.toString()}\n最后更新于：${f.toString()}`},h.format("MM 月 DD 日 YYYY 年")),(null==u?void 0:u.length)&&t.createElement("div",{className:"flex flex-1 flex-wrap gap-2 lg:before:content-['•']"},u.map((n=>t.createElement(d.A,{key:n,name:n,className:"item-secondary item-selectable"})))))),t.createElement("article",{ref:y,className:"heti post-entry"},g&&w>365&&t.createElement("blockquote",{className:"border-l-4 border-orange-400"},"这是一篇",t.createElement("strong",null,"最后更新于 ",w," 天前"),"的博客，内容可能随着时间的推移而变得不再适用，建议您仔细评估信息的有效性。"),t.createElement(e.x,{components:m},a)))},h=n=>{let{data:a}=n;return t.createElement(g.A,{title:String(a.mdx.frontmatter.title)})};function f(n){return t.createElement(y,n,t.createElement(o,n))}}}]);
//# sourceMappingURL=component---src-templates-post-tsx-content-file-path-blog-posts-pixiv-previewer-mdx-fbe373afbecf69fe2c53.js.map