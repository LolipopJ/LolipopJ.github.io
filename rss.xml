<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Lolipop's Studio | RSS Feed]]></title><description><![CDATA[Homepage and blog of Lolipop, share knowledge about software / frontend development.]]></description><link>https://blog.towind.fun</link><generator>GatsbyJS</generator><lastBuildDate>Mon, 02 Jun 2025 09:29:37 GMT</lastBuildDate><item><title><![CDATA[éƒ¨ç½²è‡ªå·±çš„ WebDAV æœåŠ¡ï¼ŒåŒæ­¥åº”ç”¨æ•°æ®ä¸è½¯ä»¶é…ç½®]]></title><description><![CDATA[ä»Šå¤©åœ¨ä½¿ç”¨ Next Chat æ—¶ï¼Œçªç„¶æƒ³åˆ°èŠå¤©æ•°æ®åº”è¯¥æ˜¯å¯ä»¥å¤‡ä»½çš„ï¼Œåœ¨è®¾ç½®é‡Œé¢å‘ç°å®ƒæ”¯æŒ WebDAV å’Œæ²¡å¬è¯´è¿‡çš„ UpStash ä¸¤ç§æ–‡ä»¶åè®®ï¼Œè€Œç¬”è€…ä½¿ç”¨çš„å…¶å®ƒè½¯ä»¶åˆå¹¿æ³›æ”¯æŒå‰è€…è¿›è¡Œå¤‡ä»½åŒæ­¥ã€‚äºæ˜¯ä»Šå¤©ä¾¿æ¥æ£è…¾ WebDAV å¹¶å®ç°æ•°æ®å¤‡ä»½ã€‚ Docker éƒ¨ç½² WebDAV æœåŠ¡

æ­¤ç« èŠ‚é‡Œç¬”è€…é€‰ç”¨äº†çº¯å‡€çš„ WebDAV æœåŠ¡é•œåƒã€‚å¦‚æœæƒ³è¦æ›´å‹å¥½çš„äº¤äº’ä½“éªŒï¼Œå¯ä»¥é€‰ç”¨æ”¯æŒ WebDAVâ€¦]]></description><link>https://blog.towind.fun/posts/private-webdav</link><guid isPermaLink="false">private-webdav</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Thu, 03 Apr 2025 00:00:00 GMT</pubDate><content:original-text>
ä»Šå¤©åœ¨ä½¿ç”¨ Next Chat æ—¶ï¼Œçªç„¶æƒ³åˆ°èŠå¤©æ•°æ®åº”è¯¥æ˜¯å¯ä»¥å¤‡ä»½çš„ï¼Œåœ¨è®¾ç½®é‡Œé¢å‘ç°å®ƒæ”¯æŒ WebDAV å’Œæ²¡å¬è¯´è¿‡çš„ UpStash ä¸¤ç§æ–‡ä»¶åè®®ï¼Œè€Œç¬”è€…ä½¿ç”¨çš„å…¶å®ƒè½¯ä»¶åˆå¹¿æ³›æ”¯æŒå‰è€…è¿›è¡Œå¤‡ä»½åŒæ­¥ã€‚äºæ˜¯ä»Šå¤©ä¾¿æ¥æ£è…¾ WebDAV å¹¶å®ç°æ•°æ®å¤‡ä»½ã€‚

## Docker éƒ¨ç½² WebDAV æœåŠ¡

&gt; æ­¤ç« èŠ‚é‡Œç¬”è€…é€‰ç”¨äº†çº¯å‡€çš„ WebDAV æœåŠ¡é•œåƒã€‚å¦‚æœæƒ³è¦æ›´å‹å¥½çš„äº¤äº’ä½“éªŒï¼Œå¯ä»¥é€‰ç”¨æ”¯æŒ WebDAV åè®®çš„æ–‡ä»¶æœåŠ¡å™¨é•œåƒï¼Œä¾‹å¦‚ [`drakkan/sftpgo`](https://github.com/drakkan/sftpgo) ä»¥åŠ [`sigoden/dufs`](https://github.com/sigoden/dufs) ç­‰ç­‰ã€‚

ä¸€æ—¦ä½¿ç”¨ä¸Šäº† Dockerï¼Œå°±å†ä¹Ÿä¸æƒ³å›å»é‚£ç§å°†æœåŠ¡è¿è¡Œåœ¨æœºå™¨æœ¬ä½“ä¸Šçš„æ—¶ä»£äº†ã€‚ç¬”è€…é¦–é€‰ä½¿ç”¨ Docker éƒ¨ç½² WebDAV æœåŠ¡ï¼Œåœ¨ Docker Hub ä»¥ `webdav` ä¸ºå…³é”®è¯æœç´¢ï¼Œæœ‰å¦‚ä¸‹ç»“æœï¼š

![WebDAV é•œåƒåˆ—è¡¨](./private-webdav/docker-hub-webdav.png)

ç¬”è€…å°è¯•äº†ä¸‹è½½é‡å’Œæ”¶è—æ•°æœ€é«˜çš„ `bytemark/webdav`ï¼Œä½†å‘ç°è®¾ç½®äº†æŒ‚è½½ç›®å½•åæ— æ³•æ­£å¸¸ä¸Šä¼ æ–‡ä»¶ï¼Œä»”ç»†é˜…è¯»è¯´æ˜æ–‡æ¡£æ‰çœ‹åˆ°ï¼Œå¿…é¡»è¦å°†å®¿ä¸»æœºçš„æŒ‚è½½ç›®å½•è®¾ç½®ä¸ºå†™æ­»çš„ `/srv/dav`ï¼Œæ„å‘³ç€å¦‚æœæƒ³è¦ç”¨å…¶å®ƒç›®å½•æ¥å­˜æ”¾ WebDAV é‡Œçš„æ–‡ä»¶çš„è¯ï¼Œè¿˜éœ€è¦é¢å¤–æ·»åŠ ä¸€ä¸ªè½¯é“¾æ¥ã€‚è¿™æ ·çš„é™åˆ¶æ„Ÿè§‰ç¬¨ç¬¨çš„ï¼Œå¾ˆä¸ä¼˜é›…ï¼Œäºæ˜¯æ‰¾äº†æ‰¾å®ƒçš„ [Github ä»“åº“](https://github.com/BytemarkHosting/docker-webdav)ï¼Œå‘ç°ä½œè€…åœ¨å†™å®Œè¿™ä¸ªé•œåƒï¼Œå‘äº†ä¸€ç¯‡[éƒ¨ç½²æ–‡æ¡£](https://docs.bytemark.co.uk/article/run-your-own-webdav-server-with-docker/)åå°±å†æ²¡æœ‰æ›´æ–°äº†ï¼Œä»£ç ä¹Ÿå°±åœç•™åœ¨äº† 2018 å¹´ã€‚ä¹Ÿè®¸ WebDAV åè®®å·²ç»ç›¸å½“ç¨³å®šäº†ï¼Œä½†æ˜¯ç¬”è€…è¿˜æ˜¯æƒ³è¦æ‰¾ä¸€ä¸ªä¸è¿™ä¹ˆåˆ«æ‰­çš„ WebDAV é•œåƒã€‚

æ¥ç€ï¼Œç¬”è€…å°è¯•åœ¨ Github ä¸Šä»¥ `webdav` ä¸ºå…³é”®è¯æœç´¢ï¼Œå‘ç°äº†å…³è”åº¦å’Œæ˜Ÿæ ‡å‡ä¸ºæœ€é«˜ï¼Œå¹¶ä¸”æ´»è·ƒæ›´æ–°çš„ [`hacdias/webdav`](https://github.com/hacdias/webdav)ã€‚å®ƒé’ˆå¯¹ä¸åŒç”¨æˆ·ç»„çš„æƒé™ç®¡ç†èƒ½åŠ›éå¸¸å¼ºï¼Œç¬”è€…å¾ˆå–œæ¬¢ã€‚ä½†ç¬”è€…é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå°†æœ¬åœ°çš„ `local/path/to/data` ç›®å½•å…³è”ç»™å®¹å™¨çš„ `/data` ç›®å½•åï¼ŒåŒæ­¥çš„æ•°æ®ä»ç„¶è¢«æ”¾ç½®åœ¨äº†å®¹å™¨çš„æ ¹ç›®å½•é‡Œï¼Œå¯¼è‡´æ— æ³•æŒä¹…åŒ–å¤‡ä»½æ–‡ä»¶ã€‚è¿™ä¹Ÿè®¸æ˜¯å½“å‰ç‰ˆæœ¬çš„ Bugï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ²¡é…ç½®å¯¹çš„åŸå› ï¼Œæ€»ä¹‹ç¬”è€…åˆç€çœ¼äºæ‰¾ä¸‹ä¸€ä¸ª WebDAV é•œåƒå»äº†ã€‚

æœ€åï¼Œç¬”è€…å°è¯•äº† Docker Hub ä¸Šç›®å‰ä¸‹è½½é‡å’Œæ”¶è—æ•°å‡ä¸ºç¬¬äºŒçš„ [`ugeek/webdav`](https://github.com/uGeek/docker-webdav)ï¼Œæ²¡æœ‰ä¸Šè¿°çš„é—®é¢˜ï¼Œæ»¡è¶³äº†ç¬”è€…çš„éœ€è¦ã€‚ç¬”è€…åœ¨ MacOS ç³»ç»Ÿä¸Šéƒ¨ç½² WebDAV æœåŠ¡ï¼Œå› æ­¤è¦æ‹‰å–å®ƒçš„ `arm64` ç‰ˆæœ¬ï¼š

```bash
docker pull ugeek/webdav:arm64
```

è¿è¡Œ WebDAV å®¹å™¨ï¼š

```bash
docker run --name webdav \
  --restart=unless-stopped \
  -p 3180:80 \
  -v $HOME/WebDAV/data:/media \
  -e USERNAME=YOUR_USERNAME \
  -e PASSWORD=YOUR_PASSWORD \
  -e TZ=Asia/Shanghai  \
  -e UDI=1000 \
  -e GID=1000 \
  -d  ugeek/webdav:arm64
```

ä¸Šé¢çš„é…ç½®è¡¨æ˜ï¼ŒWebDAV æœåŠ¡æš´éœ²åœ¨å®¿ä¸»æœºçš„ 3180 ç«¯å£ï¼Œæ•°æ®æŒä¹…åŒ–å­˜å‚¨åœ¨ `$HOME/WebDAV/data` ç›®å½•ä¸‹ã€‚è®¿é—® `127.0.0.1:3180`ï¼Œè¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œå³å¯çœ‹è§å½“å‰ WebDAV ä¸­åŒ…å«çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆå½“ç„¶æ­¤æ—¶ä¸ºç©ºï¼‰ã€‚

é€šè¿‡ frp å°†å†…ç½‘çš„æœåŠ¡æš´éœ²ç»™å…¬ç½‘æœåŠ¡å™¨ä¸Šï¼Œå†é€šè¿‡é…ç½®å…¬ç½‘æœåŠ¡å™¨çš„ Nginx é…ç½®ï¼Œç°åœ¨ WebDAV å°±å¯ä»¥é€šè¿‡åŸŸå `https://webdav.towind.fun` è®¿é—®äº†ï¼

## å›¾å½¢ç•Œé¢ç®¡ç† WebDAV

ç”¨ Postman æ¥å¯¹ WebDAV é‡Œçš„æ–‡ä»¶åš CRUD æ˜¾ç„¶ä¸ç¬¦åˆå®é™…éœ€è¦ã€‚åœ¨è¿™ä¸€ç« èŠ‚ï¼Œç¬”è€…å°†åˆ†åˆ«é€šè¿‡ AList å’Œ Windows æ¥è¿æ¥ WebDAVï¼Œæ–¹ä¾¿ä»¥åå®é™…çš„ç®¡ç†ä¸ä½¿ç”¨ã€‚

### AList æŒ‚è½½ WebDAV

ç¬”è€…ä¹‹å‰åœ¨ Docker ä¸Šéƒ¨ç½²äº† AList æœåŠ¡ï¼Œå®ƒä¹Ÿæ”¯æŒè¿æ¥å¹¶ç®¡ç† WebDAVã€‚è¿™ä¸€åˆ‡å°¤ä¸ºç®€å•ï¼Œåªéœ€è¦åœ¨â€œç®¡ç† - å­˜å‚¨â€é¡µé¢æ·»åŠ  WebDAV é©±åŠ¨ï¼Œè¾“å…¥è´¦å·å’Œå¯†ç å³å¯è¿æ¥ï¼š

![AList è¿æ¥åˆ° WebDAV](./private-webdav/alist-webdav-connect.png)

å›åˆ°ä¸»é¡µï¼ŒWebDAV å°±é¡ºåˆ©åœ°æŒ‚è½½åˆ°äº†æŒ‡å®šçš„è·¯ç”±ä¸Šã€‚è¿™æ ·ï¼Œå°±å¯ä»¥éšæ—¶éšåœ°é€šè¿‡æµè§ˆå™¨è®¿é—® AListï¼Œç®¡ç† WebDAV é‡Œçš„æ–‡ä»¶äº†ï¼

### Windows æŒ‚è½½ WebDAV

&gt; å¦‚æœé‡åˆ°æŠ¥é”™ï¼š`The network path was not found`ï¼Œå¯ä»¥å°è¯•å¤šè¿æ¥å‡ æ¬¡ï¼Œç›´åˆ°é¡ºåˆ©è®¿é—®ã€‚ç¬”è€…æš‚æ—¶æ²¡æœ‰æ‰¾åˆ°èƒ½å¤Ÿç¨³å®šè¿æ¥çš„æ–¹æ¡ˆï¼ŒDrive me crazyï¼Œæ›´æ¨èä½¿ç”¨å…¶å®ƒæ–¹æ¡ˆè®¿é—® WebDAVã€‚

ç¬”è€…çš„ WebDAV ç”± SSL åŠ å¯†ï¼Œå› æ­¤éœ€è¦é¦–å…ˆé…ç½® Windows Web Client çš„èº«ä»½éªŒè¯çº§åˆ«ï¼Œå³åœ¨â€œè¿è¡Œâ€é‡Œè¾“å…¥ `regedit` æ‰“å¼€æ³¨å†Œè¡¨ç¼–è¾‘å™¨ï¼Œæ‰¾åˆ° `Computer\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\WebClient\Parameters`ï¼Œä¿®æ”¹å…¶ä¸­é”® `BasicAuthLevel` çš„å€¼ä¸º `2`ã€‚

![ä¿®æ”¹ Windows Web Client èº«ä»½éªŒè¯çº§åˆ«](./private-webdav/windows-webdav-auth-level.png)

ç¬”è€…ç¿»é˜…æœ‰å…³ Windows ç³»ç»Ÿè¿æ¥ WebDAV çš„[å®˜æ–¹æ–‡æ¡£](https://learn.microsoft.com/zh-cn/iis/publish/using-webdav/using-the-webdav-redirector#webdav-redirector-registry-settings)å‘ç°ï¼Œ`BasicAuthLevel` é»˜è®¤å€¼ä¸º `1` çš„æ—¶å€™å°±å·²ç»å¯¹ SSL åŠ å¯†çš„è¿æ¥å¯ç”¨èº«ä»½éªŒè¯äº†ï¼Œä½†ç¬”è€…ä»…åœ¨å…¶å€¼ä¸º `2` çš„æ—¶å€™èƒ½é¡ºåˆ©è¿æ¥ä¸Šã€‚æš‚ä¸”è’™åœ¨é¼“é‡Œã€‚

å³é”®â€œæˆ‘çš„ç”µè„‘â€ï¼Œé€‰æ‹©â€œé€‰æ‹©æ˜ å°„ç½‘ç»œé©±åŠ¨å™¨â€ï¼Œè¾“å…¥ WebDAV çš„åœ°å€ï¼Œå†è¾“å…¥ç”¨æˆ·åå’Œå¯†ç å³å¯è¿æ¥åˆ°æœåŠ¡ï¼š

![Windows è¿æ¥åˆ° WebDAV](./private-webdav/windows-webdav-connect.png)

ç°åœ¨å°±å¯ä»¥åœ¨ Windows ç³»ç»Ÿä¸Šï¼Œåƒç®¡ç†å…¶å®ƒæœ¬åœ°æ–‡ä»¶ä¸€æ ·ç®¡ç† WebDAV é‡Œçš„æ–‡ä»¶äº†ï¼

## å¤‡ä»½åº”ç”¨æ•°æ®åˆ° WebDAV

### å¤‡ä»½ Obsidian ç¬”è®°åˆ° WebDAV

ç¬”è€…ä½¿ç”¨ Obsidian åŒæ­¥å¤šç«¯çš„ç¬”è®°ï¼Œè¿‡å»ä½¿ç”¨ OneDrive æ¥åŒæ­¥ç¬”è®°çš„æ•°æ®ï¼Œç°åœ¨å°±å¯ä»¥è¿ç§»åˆ° WebDAV ä¸Šäº†ã€‚åªéœ€è¦å®‰è£…æ’ä»¶å¸‚åœºé‡Œçš„ä¸‰æ–¹æ’ä»¶ Remotely Saveï¼Œé…ç½® WebDAV å³å¯ï¼š

![é…ç½® Obsidian æ’ä»¶ Remotely Save](./private-webdav/webdav-sync-obsidian.png)

ç‚¹å‡»åŒæ­¥æŒ‰é’®ï¼Œç¬”è®°æ•°æ®å°±å…‰é€Ÿä¿å­˜åˆ° WebDAV ä¸Šå•¦ï¼ç›¸æ¯” OneDriveï¼Œä½¿ç”¨ WebDAV åŒæ­¥çš„é€Ÿåº¦è¦æ˜¾è‘—æ›´å¿«ï¼Œä½†æ˜¯ä¹Ÿå¤±å»äº† OneDrive æä¾›çš„å†å²ç‰ˆæœ¬ç®¡ç†èƒ½åŠ›ï¼Œå¾—å¤±å…¼è€Œæœ‰ä¹‹ã€‚

å°½ç®¡ OneDrive çš„èƒ½åŠ›æ›´åŠ å¼ºå¤§ï¼Œä½†ç¬”è€…è¿˜æ˜¯å€¾å¿ƒäºç©å¼„è‡ªå·±çš„å°ç©å…·ï¼Œæš‚ä¸”ä¸ä¸ OneDrive åŒæ­¥äº† XDã€‚

### å¤‡ä»½ Next Chat æ•°æ®åˆ° WebDAV

ç¬”è€…æ’°å†™æ­¤æ–‡æ—¶ä½¿ç”¨çš„ Next Chat ç‰ˆæœ¬ä¸º `v2.15.8`ã€‚

å°½ç®¡åœ¨è®¾ç½®ä¸­å®ƒæä¾›äº†åŒæ­¥é…ç½®å’ŒèŠå¤©è®°å½•åˆ° WebDAV çš„èƒ½åŠ›ï¼Œä½†æ— è®ºæ€ä¹ˆé…ç½®ä¹Ÿæ— æ³•æˆåŠŸåŒæ­¥æ•°æ®ï¼Œç¿»çœ‹å¥½å¤š Issues å’Œç›¸å…³çš„å¸–å­æ‰ç»ˆäºç†å‡ºæ¥è¦å¦‚ä½•ä½¿ç”¨ã€‚

Next Chat è®¾è®¡ä¸º Web ç«¯ä½¿ç”¨ï¼Œéƒ¨ç½²æ—¶éœ€è¦é…ç½®ç¯å¢ƒå˜é‡ `WHITE_WEBDAV_ENDPOINTS` ä»¥æ·»åŠ  WebDAV ç»ˆç«¯ç™½åå•ã€‚å®˜æ–¹æ„å»ºç‰ˆæœ¬ä»…å¯¹ä¸€äº›å¸¸è§ WebDAV æœåŠ¡åŸŸåå¼€äº†ç™½åå•ï¼Œä½†åƒç¬”è€…è¿™æ ·çš„è‡ªå»º WebDAV æœåŠ¡è‡ªç„¶æ˜¯ä¸å¯èƒ½åœ¨åå•å†…ã€‚å› æ­¤éœ€è¦æ‰‹åŠ¨éƒ¨ç½²ä¸€ä¸ªå±äºè‡ªå·±çš„ Next Chat çš„ Web ç‰ˆæœ¬ï¼Œåœ¨ç¯å¢ƒå˜é‡ä¸­ä¸º WebDAV å¼€æ”¾ç™½åå•ã€‚è¿™æ ·ï¼Œåœ¨åŒæ­¥æ•°æ®æ—¶ï¼Œä½¿ç”¨è‡ªå»ºç«™ç‚¹çš„åŸŸåä½œä¸ºä»£ç†æœåŠ¡å™¨å°±å¯ä»¥äº†ã€‚

å‚è€ƒéƒ¨ç½² Next Chat åˆ° Vercel çš„[å®˜æ–¹æ–‡æ¡£](https://github.com/ChatGPTNextWeb/NextChat/blob/48469bd8ca4b29d40db0ade61b57f9be6f601e01/docs/vercel-cn.md)ï¼Œéƒ¨ç½²è‡ªå·±çš„ Next Chat ç«™ç‚¹ï¼Œå°† `WHITE_WEBDAV_ENDPOINTS=https://webdav.towind.fun` ä½œä¸ºæ„å»ºç¯å¢ƒå˜é‡ï¼š

![æ„å»º Next Chat ç¯å¢ƒå˜é‡](./private-webdav/next-chat-vercel-env.png)

ç°åœ¨ï¼Œç¬”è€…è‡ªå»ºçš„ Next Chat ç«™ç‚¹ä¾¿å…è®¸è¢«ä½œä¸ºè¯·æ±‚ `https://webdav.towind.fun` çš„ä»£ç†æœåŠ¡å™¨äº†ã€‚

é…ç½®äº‘åŒæ­¥ï¼Œæ£€æŸ¥å¯ç”¨æ€§ï¼ŒæˆåŠŸåœ¨ WebDAV çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºäº†æ–‡ä»¶å¤¹ `chatgpt-next-chat`ï¼š

![Next Chat äº‘åŒæ­¥æ£€æŸ¥ WebDAV å¯ç”¨æ€§](./private-webdav/next-chat-check-connection.png)

å°è¯•åˆæ¬¡åŒæ­¥ Next Chat çš„æ•°æ®ï¼šé¦–å…ˆå‘å‡ºè¯·æ±‚æ£€æŸ¥ WebDAV é‡Œæ˜¯å¦åŒ…å«äº‘ç«¯æ•°æ®ï¼Œå“åº”å€¼ä¸º 404 Not Foundï¼Œç¬¦åˆé¢„æœŸï¼›æ¥ç€å°†å¤‡ä»½çš„æ•°æ®ä¸Šä¼ åˆ° WebDAVï¼ŒæœåŠ¡ç«¯å“åº” 502 Bad Gatewayï¼š

![Next Chat åŒæ­¥å¤±è´¥ 502 Error](./private-webdav/webdav-sync-next-chat-failed.png)

æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—ï¼š

```bash
tail -n 10 /var/log/nginx/error.log
...
[error] 2107#2107: *36701359 client intended to send too large body: 1663429 bytes, client: xxx.xx.xxx.xxx, server: webdav.towind.fun, request: &quot;PUT /chatgpt-next-web/backup.json HTTP/2.0&quot;, host: &quot;webdav.towind.fun&quot;
```

å¯çŸ¥ Nginx æ‹’ç»äº†åŒ…å«è¶…è¿‡è®¾å®šå¤§å°æ•°æ®çš„è¯·æ±‚ï¼Œé‚£ä¹ˆåªéœ€è¦å°†è®¾å®šçš„å¤§å°æ”¾å¼€ä¸€ç‚¹å°±å¥½ã€‚ç¼–è¾‘å¯¹åº”çš„ Nginx é…ç½®ï¼Œä¾‹å¦‚è®¾ç½®å…è®¸çš„æœ€å¤§è¯·æ±‚ä½“ä¸º `50M`ï¼š

```nginx
server {
  server_name webdav.towind.fun;
  client_max_body_size 50M;
}
```

å†æ¬¡å°è¯•åŒæ­¥ Next Chat çš„æ•°æ®ï¼ŒæˆåŠŸä¸Šä¼ åˆ° WebDAVï¼š

![Next Chat åŒæ­¥æˆåŠŸ](./private-webdav/webdav-backup-next-chat.png)

æœªæ¥æ— è®ºåœ¨ä»€ä¹ˆå®¢æˆ·ç«¯ä½¿ç”¨ Next Chat æ—¶ï¼Œéƒ½å¯ä»¥åŒæ­¥é…ç½®æ•°æ®å’ŒèŠå¤©è®°å½•äº†ï¼

## å‚è€ƒæ–‡ç« 

åœ¨â€œWindows æŒ‚è½½ WebDAVâ€ç« èŠ‚é‡Œï¼Œä¸»è¦å‚è€ƒäº†[ã€ŠWindows æŒ‚è½½ WebDAVã€‹](https://www.expoli.tech/articles/2020/12/30/1609327097930#00ecc29c1a7b4cb783cfa61ba925073e)è¿™ç¯‡åšå®¢ï¼Œè§£å†³äº†æŒ‚è½½å¼‚å¸¸çš„é—®é¢˜ã€‚

åœ¨â€œå¤‡ä»½åº”ç”¨æ•°æ®åˆ° WebDAVâ€ç« èŠ‚é‡Œï¼Œä¸»è¦å‚è€ƒäº†[ã€Šç»ˆäºæ‹¿ä¸‹äº†NextChatçš„WebDAVäº‘åŒæ­¥ï¼Œæˆ‘æ„Ÿè§‰æˆ‘åˆè¡Œäº†ã€‹](https://linux.do/t/topic/373723)å’Œ[ã€Šã€æ‹‰è·¨ï¼Œä½†èƒ½ç”¨äº†ã€‘NextChat çš„ WebDAV äº‘åŒæ­¥ã€‚ã€‚ã€‹](https://linux.do/t/topic/328163)è¿™ä¸¤ç¯‡å¸–å­ã€‚
</content:original-text><content:updated-at>2025-04-05T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[æ‹¿åˆšä¹°çš„ Mac Mini åšæˆ‘çš„åº”ç”¨æœåŠ¡å™¨]]></title><description><![CDATA[å»å¹´ç¬”è€…æ‹¿ N100 å°å‹ä¸»æœºå®‰è£… OpenWRT ç³»ç»Ÿä½œä¸»è·¯ç”±æœåŠ¡å™¨ï¼Œåˆå¡è¿›å»ä¸€äº›ç¬”è€…è‡ªå·±éƒ¨ç½²çš„åº”ç”¨æœåŠ¡ã€‚åæ¥ Mac Mini 4 å‘å”®äº†ï¼Œè¯„æµ‹å¾—åˆ°çš„åŠŸè€—ä¸æ€§èƒ½ä»¤äººæƒŠå¹ï¼Œæœ€é‡è¦çš„æ˜¯å®šä»·å¾ˆä¸è‹¹æœï¼Œè®©æˆ‘è¿™ä¸ªè‹¹æœå°é»‘å­ä¹Ÿæƒ³è¦å…¥æ‰‹ä¸€å°ç©ç©ã€‚ å½“ç„¶ï¼Œç¬”è€…åœ¨é€› V2EX çš„æ—¶å€™ä¹Ÿçœ‹äº†å¤§é‡åŠé€€è´­å…¥ Mac Mini 4 çš„å¸–å­ï¼Œå°¤å…¶æ˜¯åƒç¬”è€…è¿™æ ·åªæ˜¯æ‹¿æ¥åšè½»é‡çº§åº”ç”¨æœåŠ¡å™¨çš„ç”¨é€” â€”â€” å¤§ç‚®æ‰“èšŠå­ã€‚ä½†æ˜¯ä½ çŸ¥é“çš„â€¦]]></description><link>https://blog.towind.fun/posts/mac-mini-server</link><guid isPermaLink="false">mac-mini-server</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Sun, 30 Mar 2025 00:00:00 GMT</pubDate><content:original-text>
å»å¹´ç¬”è€…æ‹¿ N100 å°å‹ä¸»æœºå®‰è£… OpenWRT ç³»ç»Ÿä½œä¸»è·¯ç”±æœåŠ¡å™¨ï¼Œåˆå¡è¿›å»ä¸€äº›ç¬”è€…è‡ªå·±éƒ¨ç½²çš„åº”ç”¨æœåŠ¡ã€‚åæ¥ Mac Mini 4 å‘å”®äº†ï¼Œè¯„æµ‹å¾—åˆ°çš„åŠŸè€—ä¸æ€§èƒ½ä»¤äººæƒŠå¹ï¼Œæœ€é‡è¦çš„æ˜¯å®šä»·å¾ˆä¸è‹¹æœï¼Œè®©æˆ‘è¿™ä¸ªè‹¹æœå°é»‘å­ä¹Ÿæƒ³è¦å…¥æ‰‹ä¸€å°ç©ç©ã€‚

å½“ç„¶ï¼Œç¬”è€…åœ¨é€› V2EX çš„æ—¶å€™ä¹Ÿçœ‹äº†å¤§é‡åŠé€€è´­å…¥ Mac Mini 4 çš„å¸–å­ï¼Œå°¤å…¶æ˜¯åƒç¬”è€…è¿™æ ·åªæ˜¯æ‹¿æ¥åšè½»é‡çº§åº”ç”¨æœåŠ¡å™¨çš„ç”¨é€” â€”â€” å¤§ç‚®æ‰“èšŠå­ã€‚ä½†æ˜¯ä½ çŸ¥é“çš„ï¼Œå³ä½¿å¹¶ä¸éœ€è¦ï¼Œä½†æ˜¯ç¬”è€…å¯ä»¥æ‹¿å®ƒä¸ºè‡ªå·±çš„çµé­‚åˆ¶é€ å…¨æ–°çš„åˆºæ¿€æ¥å……å®ç”Ÿæ´»ã€‚

æ—¶é—´æ¥åˆ° 2025 å¹´ 03 æœˆï¼ŒMac Mini 4 å·²ç»æœ‰å¤§é‡ç°è´§è€Œæ— éœ€è¹²ç‚¹æŠ¢è´­äº†ï¼Œå›½å®¶è¡¥è´´å åŠ å­¦ç”Ÿè¡¥è´´ï¼Œåœ¨äº¬ä¸œä¸ŠèŠ± 2999 å…ƒä¸‹å•å…¥æ‰‹äº†æœ€ä½é…ç½®ï¼ˆä½†æœ€é«˜æ€§ä»·æ¯”ï¼‰çš„ç‰ˆæœ¬ã€‚

è¿™ç¯‡åšå®¢å°†è®°å½•ç¬”è€…ä»é›¶å¼€å§‹æŠ˜è…¾ Mac Mini 4 åšè½»é‡çº§åº”ç”¨æœåŠ¡å™¨çš„å…¨è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ä»åŸæ¥çš„æœåŠ¡å™¨ä¸Šè¿ç§»å·²æœ‰ Docker å®¹å™¨å’Œåº”ç”¨æœåŠ¡çš„æ“ä½œæ­¥éª¤ã€‚

## é¦–æ¬¡å¯åŠ¨ Mac Mini

è¿™æ˜¯ç¬”è€…ç¬¬ä¸€æ¬¡è´­ä¹° Mac Miniï¼Œåœ¨é¦–æ¬¡å¯åŠ¨ä¸»æœºçš„æ—¶å€™ï¼Œä¼šéœ€è¦è¿æ¥é¼ æ ‡ä¸é”®ç›˜ã€‚ç”±äº Mac Mini 4 ä¸Šåªæœ‰ Type-C æ¥å£ï¼Œæ‰€ä»¥å¯ä»¥æå‰å‡†å¤‡æ‹“å±•åæˆ–è€… Type-C è¿æ¥çº¿ã€‚

å¦‚æœæœ‰è“ç‰™é¼ æ ‡å’Œè“ç‰™é”®ç›˜ï¼Œå°±ä¸éœ€è¦ç”¨åˆ°è¿™äº›ç¡¬ä»¶äº†ï¼šåªéœ€è¦æŠŠè“ç‰™é¼ æ ‡å’Œè“ç‰™é”®ç›˜ç½®äºé…å¯¹æ¨¡å¼ä¸‹ï¼ŒMac Mini å°±ä¼šè‡ªåŠ¨é…å¯¹å¹¶è¿æ¥ã€‚

## é¢å‘æœåŠ¡å™¨çš„ Mac Mini é…ç½®

å‚è€ƒç½‘ä¸Šå…¶å®ƒæ•™ç¨‹æŒ‡å‡ºçš„ç»†èŠ‚ï¼Œåœ¨â€œè®¾ç½®â€é‡Œå¯¹ Mac Mini è¿›è¡Œé…ç½®ï¼š

1. **ä¿æŒæœåŠ¡å™¨è¿è¡ŒçŠ¶æ€**ï¼šåœ¨â€œèƒ½æºâ€é‡Œè®¾ç½®â€œæ˜¾ç¤ºå™¨å…³é—­æ—¶ï¼Œé˜²æ­¢è‡ªåŠ¨è¿›å…¥ç¡çœ â€å’Œâ€œæ–­ç”µåè‡ªåŠ¨å¯åŠ¨â€ï¼›åœ¨â€œé”å®šå±å¹•â€é‡Œç¦ç”¨å±å¹•ä¿æŠ¤ç¨‹åºã€‚
2. **ä¿æŒç”¨æˆ·çš„ç™»å½•çŠ¶æ€**ï¼šåœ¨â€œç”¨æˆ·ä¸ç¾¤ç»„â€é‡Œè®¾ç½®â€œè‡ªåŠ¨ä»¥æ­¤èº«ä»½ç™»å½•â€ï¼Œä¿éšœå„ç§è½¯ä»¶åœ¨ä¸»æœºå¯åŠ¨åæ­£å¸¸è¿è¡Œã€‚
3. **é¿å…ç³»ç»Ÿæ›´æ–°è‡ªåŠ¨é‡å¯**ï¼šåœ¨â€œé€šç”¨ - è½¯ä»¶æ›´æ–°â€é‡Œå…³é—­è‡ªåŠ¨æ£€æŸ¥ã€ä¸‹è½½å’Œå®‰è£…æ›´æ–°çš„åŠŸèƒ½ã€‚

è¿™æ ·ï¼ŒMac Mini å°±æ»¡è¶³ä½œä¸ºå¸¸æ—¶è¿è½¬çš„æœåŠ¡å™¨çš„åŸºæœ¬é…ç½®éœ€è¦äº†ã€‚

## åŸºäº Rust Desk çš„è¿œç¨‹æ¡Œé¢è¿æ¥

ç¬”è€…ç›®å‰åªæœ‰å±€åŸŸç½‘è®¿é—®ä¸»æœºçš„éœ€æ±‚ï¼Œè€Œä¸”ä¸æƒ³ç”¨åŒ…å«ä¸­ç»§æœåŠ¡å™¨ç­‰å¢å€¼æœåŠ¡åœ¨å†…çš„å„ç±»è¿œç¨‹æ¡Œé¢è½¯ä»¶ï¼Œå› æ­¤é€‰ç”¨äº† Github ä¸Šæ˜Ÿæ ‡æœ€å¤šçš„å¼€æºè¿œç¨‹æ¡Œé¢å®¢æˆ·ç«¯ [Rust Desk](https://github.com/rustdesk/rustdesk)ã€‚

ä¸æƒ³ä»˜ä¸€åˆ†é’±å°±æƒ³ä½“éªŒå®Œæ•´çš„ Rust Desk èƒ½åŠ›çš„è¯ï¼Œå¯ä»¥é€‰æ‹©åœ¨æœ¬åœ°éƒ¨ç½² Rust Desk çš„ä¸­ç»§æœåŠ¡å™¨ã€‚

Docker æ˜¯ç®¡ç†æœ¬åœ°æœåŠ¡çš„æ— äºŒä¹‹é€‰ï¼Œé¦–å…ˆåœ¨ Mac Mini ä¸Šä¸‹è½½å¹¶å®‰è£… Docker Desktopã€‚è®¾ç½®å›½å†…é•œåƒä»“åº“ï¼Œåœ¨ â€œSettings - Docker Engineâ€ é‡Œæ·»åŠ ï¼š

```json
{
  &quot;registry-mirrors&quot;: [
    &quot;https://docker-0.unsee.tech&quot;,
    &quot;https://hub.fast360.xyz&quot;,
    &quot;https://dockerpull.cn&quot;
  ]
}
```

ä¸ä¿è¯ä¸Šè¿°é•œåƒä»“åº“å§‹ç»ˆå¯ç”¨ï¼Œå¦‚å¤±æ•ˆï¼Œå¯ä»¥åœ¨ç½‘ä¸Šæ‰¾åˆ°æœ€æ–°æœ‰æ•ˆçš„åœ°å€ã€‚

æ‹‰å– Rust Desk çš„æœåŠ¡ç«¯é•œåƒ `rustdesk/rustdesk-server`ï¼Œè¿è¡Œ hbbs å’Œ hbbr å®¹å™¨æœåŠ¡ï¼š

&gt; å®˜æ–¹æ–‡æ¡£ä½¿ç”¨â€œHostâ€ç½‘ç»œæ¨¡å¼æ¥å…é™¤ä¸€ä¸ªä¸€ä¸ªæ‰‹åŠ¨è®¾ç½®ç«¯å£å·çš„éº»çƒ¦ï¼Œä½†æ˜¯ MacOS ç³»ç»Ÿå¹¶ä¸æ”¯æŒè¿™ç§ç½‘ç»œæ¨¡å¼ã€‚

```bash
# RustDesk çš„ä¸­ä»‹æœåŠ¡å™¨ï¼Œç”¨äºç®¡ç†å’Œåè°ƒå®¢æˆ·ç«¯è¿æ¥
docker run --name hbbs -p 21115:21115 -p 21116:21116 -p 21116:21116/udp -p 21118:21118 -v path/to/rustdesk/data:/root -td rustdesk/rustdesk-server hbbs
# RustDesk çš„ä¸­ç»§æœåŠ¡å™¨ï¼Œç”¨äºåœ¨ä¸¤å°å®¢æˆ·ç«¯ä¹‹é—´è¿›è¡Œè¿æ¥ä¸­ç»§
docker run --name hbbr -p 21117:21117 -p 21119:21119 -v path/to/rustdesk/data:/root -td rustdesk/rustdesk-server hbbr
```

è·å– Rust Desk ä¸­ä»‹æœåŠ¡å™¨å…¬é’¥ï¼Œæ‰“å° `path/to/rustdesk/data` ç›®å½•ä¸‹è‡ªåŠ¨ç”Ÿæˆçš„ `id_ed25519.pub` æ–‡ä»¶å†…å®¹ï¼š

```bash
cat path/to/rustdesk/data/id_ed25519.pub
```

åˆ†åˆ«åœ¨ä¸»æ§ç«¯ï¼ˆç¬”è€…ä¸º Windowsï¼‰å’Œè¢«æ§ç«¯ï¼ˆå³ Mac Miniï¼‰ä¸Šå®‰è£… Rust Desk å®¢æˆ·ç«¯ï¼Œåœ¨å®¢æˆ·ç«¯çš„â€œè®¾ç½® - ç½‘ç»œ - ID/ä¸­ç»§æœåŠ¡å™¨â€å¤„é…ç½®ä¸­ç»§æœåŠ¡å™¨ç›¸å…³å†…å®¹ã€‚è¿™é‡Œå¡«å†™ä¸»è·¯ç”±è‡ªåŠ¨ä¸º Mac Mini çš„åˆ†é…çš„ IP åœ°å€ `192.168.100.239`ï¼Œå¦‚æœåœ¨å¯åŠ¨ä¸­ç»§æœåŠ¡å™¨å®¹å™¨æ—¶æ²¡æœ‰è‡ªè¡Œä¿®æ”¹æš´éœ²çš„ç«¯å£ï¼Œé‚£ä¹ˆ Rust Desk ä¼šè‡ªåŠ¨è®¿é—®åˆ°å¯¹åº”çš„ç«¯å£ï¼Œæ— éœ€å•ç‹¬æŒ‡å®šç«¯å£å·ï¼ŒåŒæ—¶å°†ä¸Šä¸€æ­¥å¾—åˆ°å…¬é’¥å¡«å†™åˆ° â€œKeyâ€ é‡Œï¼š

![é…ç½® Rust Desk å®¢æˆ·ç«¯çš„ä¸­ç»§æœåŠ¡å™¨](./mac-mini-server/rustdesk-public-key.png)

åœ¨ä¸»æ§ç«¯è¾“å…¥è¢«æ§ç«¯çš„ ID ä¸è¿æ¥å¯†ç ï¼Œå³å¯è¿æ¥åˆ°è¿œç¨‹æ¡Œé¢ï¼š

![è¿æ¥åˆ° Mac Mini è¿œç¨‹æ¡Œé¢](./mac-mini-server/connect-to-mac-mini.png)

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿œç¨‹æ¡Œé¢å°†ä½¿ç”¨ä¸å¯å˜æ›´çš„ 1920 \* 1080 åˆ†è¾¨ç‡ï¼Œå¯ä»¥ä½¿ç”¨ Better Dummy è½¯ä»¶ä¸º Mac Mini è™šæ‹Ÿä¸€ä¸ªæ˜¾ç¤ºå±ï¼Œå°±å¯ä»¥è‡ªå®šä¹‰åˆ†è¾¨ç‡ä¸å¯ç”¨ HiDPI åŠŸèƒ½äº†ã€‚

![ä½¿ç”¨ Better Dummy è™šæ‹Ÿæ˜¾ç¤ºå±](./mac-mini-server/with-better-dummy.png)

æœ€åï¼Œåœ¨ OpenWRT çš„æ§åˆ¶é¢æ¿é‡Œå°† `192.168.100.239` ç»‘å®šä¸ºåˆ†é…ç»™ Mac Mini çš„å›ºå®š IPv4 åœ°å€ï¼Œä»¥åå°±æ— éœ€åœ¨ä¸»æ§ç«¯é‡æ–°é…ç½®ä¸­ç»§æœåŠ¡å™¨çš„ç›¸å…³å†…å®¹å•¦ã€‚

![ä¸º Mac Mini ç»‘å®šé™æ€ IPv4 åœ°å€](./mac-mini-server/dhcp-static-ipv4.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç¬”è€…åŒæ—¶å°† Mac Mini æ— çº¿ç½‘å¡çš„ MAC åœ°å€å’Œä»¥å¤ªç½‘å¡çš„ MAC åœ°å€ç»‘å®šç»™ `192.168.100.239`ï¼Œä¸ºä¹‹åæ–­å¼€ WiFi ä½¿ç”¨ç½‘çº¿åšå¥½äº†é“ºå«ã€‚

## è¿ç§» Docker é‡Œçš„å®¹å™¨

### è¿ç§»æ•°æ®åº“

æ•°æ®åº“æ˜¯ç¬”è€…å…¶å®ƒåº”ç”¨æœåŠ¡çš„åŸºçŸ³ï¼Œé¦–å…ˆåº”å½“è¿ç§»è¿™äº›å®¹å™¨æœåŠ¡ã€‚

è¿™é‡Œä»¥ PostgreSQL æ•°æ®åº“ä¸ºä¾‹ï¼Œé¦–å…ˆåº”å½“è°ƒç”¨ PostgreSQL å®˜æ–¹æä¾›çš„å¤‡ä»½å·¥å…·ï¼Œå¤‡ä»½æ•°æ®åº“é‡Œçš„æ‰€æœ‰æ•°æ®è¡¨ï¼š

```bash
# è¿›å…¥åä¸º postgres çš„ PostgreSQL æ•°æ®åº“å®¹å™¨
docker exec -it postgres bash
# ä»¥ postgres çš„èº«ä»½å¤‡ä»½æ•°æ®åº“é‡Œçš„æ‰€æœ‰æ•°æ®è¡¨
pg_dumpall -U postgres &gt; /path/to/all_databases.sql
# é€€å‡ºå®¹å™¨
exit
```

æ¥ç€ï¼Œå°†æ•°æ®è¡¨å¤‡ä»½æ–‡ä»¶ `all_databases.sql` å¤åˆ¶åˆ°ä¸»æœºä¸Šï¼š

```bash
docker cp postgres:/path/to/all_databases.sql /local/path/to/all_databases.sql
```

ç„¶åï¼Œå°†ä¸»æœºä¸Šçš„æ•°æ®è¡¨å¤‡ä»½æ–‡ä»¶ä¼ è¾“åˆ° Mac Mini ä¸Šï¼š

```bash
scp /local/path/to/all_databases.sql username@192.168.100.239:/Users/username/PostgreSQL/all_databases.sql
```

åœ¨ Mac Mini ä¸Šæ‹‰å–æœ€æ–°ç‰ˆæœ¬çš„ `postgres` é•œåƒï¼Œå¯åŠ¨æ–°çš„ PostgreSQL å®¹å™¨ï¼š

```bash
docker run --name postgres --restart unless-stopped -e POSTGRES_PASSWORD=SECRET_PASSWORD -v /Users/username/PostgreSQL/data:/var/lib/postgresql/data -d -p 5432:5432 postgres:latest
```

å°†æ•°æ®è¡¨å¤‡ä»½æ–‡ä»¶å¤åˆ¶åˆ° PostgreSQL å®¹å™¨é‡Œï¼š

```bash
docker cp /Users/username/PostgreSQL/all_databases.sql postgres:/path/to/all_databases.sql
```

æœ€åï¼Œè¿›å…¥åˆ°æ–°çš„ PostgreSQL å®¹å™¨é‡Œï¼Œè¿˜åŸæ•°æ®è¡¨ï¼š

```bash
docker exec -it postgres bash
psql -U postgres -f /path/to/all_databases.sql
```

è¿™æ ·ï¼Œå¯¹ PostgreSQL æ•°æ®åº“å®¹å™¨çš„è¿ç§»å°±å®Œæˆäº†ï¼

ç¬”è€…åŸºäº frpc å®ç°å†…ç½‘ç©¿é€ï¼Œå› æ­¤è¿˜éœ€è¦åœ¨ OpenWRT æ§åˆ¶é¢æ¿é‡Œé…ç½® frpc å®¢æˆ·ç«¯ï¼Œä¿®æ”¹ PostgreSQL æ•°æ®åº“çš„å†…ç½‘åœ°å€ï¼Œä»åŸæ¥ä¸»è·¯ç”±æœåŠ¡å™¨æ‰€åœ¨çš„ `192.168.100.1`ï¼Œæ”¹åˆ° Mac Mini æ‰€åœ¨çš„ `192.168.100.239`ã€‚è¿™æ ·ï¼Œå¤–ç½‘ä¹Ÿèƒ½æ­£å¸¸è®¿é—®æ–°çš„ PostgreSQL æ•°æ®åº“äº†ã€‚

### è¿ç§» Minecraft æ¸¸æˆæœåŠ¡å™¨åˆ° Docker å®¹å™¨

å»å¹´ç¬”è€…åœ¨ä¸»è·¯ç”±ä¸Šéƒ¨ç½²äº† Minecraft æœåŠ¡å™¨ï¼Œè¿™æ¬¡å†³å®šä¸€å¹¶è¿ç§»åˆ° Mac Mini é‡Œæ¥ï¼Œä½œä¸º Docker å®¹å™¨ç»§ç»­å¯¹å¤–æä¾›æœåŠ¡ã€‚

æ‰“åŒ…ç°æœ‰çš„ Minecraft æ•°æ®æ–‡ä»¶ï¼ŒåŒ…æ‹¬æ¨¡ç»„ç”Ÿæˆçš„æ–‡ä»¶ç­‰ã€‚å¯¹äºç¬”è€…ï¼Œæ‰§è¡Œäº†å¦‚ä¸‹å‘½ä»¤ï¼š

```bash
tar -czf mc-server.tar.gz banned-ips.json banned-players.json config dynmap journeymap mods ops.json server-icon.png server.properties usercache.json whitelist.json world
```

å°†æ‰“åŒ…åçš„æ–‡ä»¶ä¼ è¾“åˆ° Mac Mini ä¸Šï¼š

```bash
scp mc-server.tar.gz username@192.168.100.239:/path/to/mc-server.tar.gz
```

è§£å‹åˆ°æ•°æ®æ–‡ä»¶å¤¹ä¸­ï¼š

```bash
tar -zxf /path/to/mc-server.tar.gz -C /path/to/mc-server-data
```

æ‹‰å–æœ€æ–°ç‰ˆæœ¬çš„ `itzg/minecraft-server` é•œåƒï¼ŒåŸºäºå®ƒè¿è¡Œ Minecraft å®¹å™¨ï¼š

```bash
docker run --name mc-server-fabric --restart unless-stopped -v /path/to/mc-server-data:/data -e TYPE=FABRIC -e VERSION=1.20.4 -e FABRIC_LOADER_VERSION=0.15.10 -e FABRIC_LAUNCHER_VERSION=1.0.1 -e EULA=TRUE -d -p 25565:25565 -p 8123:8123 itzg/minecraft-server:latest
```

ä¸Šé¢çš„ç¯å¢ƒå˜é‡è¡¨ç¤ºï¼Œå¯ç”¨ä¸€ä¸ª Fabric æ¨¡ç»„æœåŠ¡å™¨ï¼ŒMinecraft ç‰ˆæœ¬ä¸º 1.20.4ï¼ŒFabric loader ç‰ˆæœ¬ä¸º 0.15.10ï¼ŒFabric launcher ç‰ˆæœ¬ä¸º 1.0.1ã€‚ç¬”è€…çš„ Minecraft æœåŠ¡å™¨å¯¹å¤–æä¾›äº† Dynmap åœ¨çº¿åœ°å›¾æœåŠ¡ï¼Œå› æ­¤é™¤äº† Minecraft ä¸»æœåŠ¡ç«¯å£ 25565 å¤–ï¼Œè¿˜å¯¹å¤–æš´éœ²äº† 8123 åœ°å›¾æœåŠ¡ç«¯å£ã€‚

è¿™æ ·ï¼Œå®¹å™¨ä¼šåœ¨åˆå§‹åŒ–æ—¶è‡ªåŠ¨ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ Fabric åŠ è½½å™¨å³ `fabric-server-mc.1.20.4-loader.0.15.10-launcher.1.0.1.jar`ï¼Œæœ€ååƒåŸæ¥ä¸€æ ·è¿è¡Œèµ·æ¥ Minecraft æœåŠ¡å™¨ï¼Œå®Œæˆå¯¹ Minecraft æœåŠ¡å™¨çš„è¿ç§»ï¼

![åˆå§‹åŒ– Minecraft æœåŠ¡å™¨](./mac-mini-server/docker-minecraft-initialize.png)

ä»åˆ€è€•ç«ç§çš„ `screen` åå°åº”ç”¨ï¼Œåˆ°å¦‚ä»Šçš„ Docker å®¹å™¨æœåŠ¡ï¼Œä¹Ÿç®—æ˜¯ä¸€æ¬¡å°å‹çš„ Minecraft æœåŠ¡ç«¯æ¶æ„å‡çº§å§\~

## å¼€å§‹æ¼«é•¿çš„å·¥ä½œ

æœ€åˆå¯¹ Mac Mini çš„é…ç½®ä¸è°ƒæ•™ä¾èµ–äº WiFi å’Œæ˜¾ç¤ºå±ï¼Œåœ¨è¿œç¨‹æ¡Œé¢å°±ç»ªåï¼Œå°±å¯ä»¥å°†å®ƒç§»åŠ¨åˆ°æ— çº¿ AP æ—è¾¹ï¼Œä½œä¸ºä¸€å°æ²‰é»˜çš„æœåŠ¡å™¨å¼€å§‹æ¼«é•¿çš„å·¥ä½œå•¦ï¼

å…³é—­ Mac Mini çš„ WiFi åŠŸèƒ½ï¼Œå…³é—­ä¸»æœºï¼Œå°†ä¸»æœºç§»åŠ¨åˆ°æ— çº¿ AP æ—è¾¹ï¼Œä½¿ç”¨ç½‘çº¿å°†ä¸¤è€…è¿æ¥ã€‚

å¯åŠ¨ Mac Miniï¼Œä¸»è·¯ç”±æœåŠ¡å™¨çš„ DHCP æœåŠ¡å°†ä¼šè‡ªåŠ¨ä¸º Mac Mini åˆ†é…å‰é¢ç¬”è€…å›ºå®šå¥½çš„ IPv4 åœ°å€ã€‚

é€šè¿‡ä¸»æ§ç«¯ Rust Desk è®¿é—® Mac Miniï¼Œé¡ºåˆ©è¿æ¥åˆ°è¿œç¨‹æ¡Œé¢ï¼Œä¸€åˆ‡æå®šï¼

## å†™åœ¨æœ€å

å…œå…œè½¬è½¬æŠ˜æŠ˜è…¾è…¾ä¸¤å¤©æ—¶é—´ï¼Œç»ˆäºæŠŠæ‰€æœ‰åº”ç”¨æœåŠ¡ä»ä¸»è·¯ç”±æœåŠ¡å™¨ä¸Šè¿ç§»åˆ°äº† Mac Mini ä¸Šï¼Œå¯å–œå¯è´ºå¯å–œå¯è´ºï¼

![Docker å®¹å™¨æœåŠ¡åˆ—è¡¨](./mac-mini-server/docker-containers.png)

è¿‡ç¨‹æ€»ä½“æ¥è¯´æ˜¯ç›¸å½“é¡ºåˆ©çš„ï¼Œæ²¡æœ‰é‡åˆ°ä»€ä¹ˆç–‘éš¾æ‚ç—‡æˆ–ä¸å…¼å®¹çš„é—®é¢˜ï¼Œè¿ç§»åˆ° Docker é‡Œçš„åº”ç”¨æœåŠ¡ä¹Ÿéƒ½ä¸€æ¬¡æ­£å¸¸è·‘é€šï¼Œä¸ç”±è®©æˆ‘å¯¹ Docker ä¾èµ–æ„ˆé™·æ„ˆæ·±ã€‚

å…¶å®ç¬”è€…è´­ä¹° Mac Mini 4 çš„å¦ä¸€ä¸ªåˆè¡·æ˜¯æ‹¿å®ƒåšæ—è·¯ç”±ï¼Œæ›¿æ¢ç›®å‰çš„ OpenWRT ä¸»è·¯ç”±ï¼Œä½†æ˜¯åˆè§‰å¾—è¿‡äºç¹çï¼ˆæºäºè¿‡å»å¿ƒè¡€çš„ç§¯ç´¯ï¼‰ï¼Œæœ€ç»ˆææµ…äº†è¿™ä¸ªè®¡åˆ’ã€‚

ç°åœ¨åœ¨ç¬”è€…çš„å®¶é‡Œï¼Œå°±ç”± N100 ä¸»è·¯ç”±æœåŠ¡å™¨ä¸ Mac Mini 4 è½»é‡çº§åº”ç”¨æœåŠ¡å™¨ç›¸è¾…ç›¸æˆï¼Œå…±åŒæ‰¿è½½ç¬”è€…æ£è…¾çš„å¿ƒç†éœ€è¦ã€‚
</content:original-text><content:updated-at>2025-03-31T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[å¯¹æ²¹çŒ´è„šæœ¬ Pixiv Previewer è¿›è¡ŒäºŒæ¬¡å¼€å‘]]></title><description><![CDATA[ç¬”è€…çš„ä¸šä½™çˆ±å¥½ä¹‹ä¸€å°±æ˜¯é€› Pixivï¼Œæ”¶è—å¥½çœ‹çš„æ’ç”»ç­‰ä½œå“å¹¶ä¸‹è½½åˆ°æœ¬åœ°ã€‚æ²¹çŒ´è„šæœ¬ Pixiv Previewer åšäº†ä¸¤ä¸ªç¬”è€…å¾ˆå–œæ¬¢çš„ä¾¿åˆ©æ€§å·¥ä½œï¼š ä½œå“é¢„è§ˆï¼šé¼ æ ‡æ‚¬æµ®åœ¨ä½œå“ç¼©ç•¥å›¾ä¸Šæ—¶è‡ªåŠ¨åœ¨å½“å‰é¡µé¢æ˜¾ç¤ºå¤§å›¾ï¼Œå¿«é€Ÿå†³å®šè¦ä¸è¦ç‚¹è¿›ä½œå“é¡µã€‚ ä½œå“æ’åºï¼šä½œå“æœç´¢é¡µå¯ä»¥æŒ‰â€œæ’åºâ€æŒ‰é’®ï¼Œè‡ªåŠ¨è·å–è‹¥å¹²é¡µçš„ä½œå“å¹¶æŒ‰ç…§æ”¶è—æ•°æ’åºï¼Œå¿«é€Ÿç­›é€‰ä¼˜è´¨ä½œå“ã€‚

å‡ºäºçˆ±å¥½ï¼Œç¬”è€…å»è„šæœ¬ä»“åº“ç¿»é˜…äº†ä¸€ä¸‹æºç ï¼Œè§‰å¾—æœ‰ä¸€äº›å¯ä»¥æ”¹è¿›çš„åœ°æ–¹â€¦]]></description><link>https://blog.towind.fun/posts/pixiv-previewer</link><guid isPermaLink="false">pixiv-previewer</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Mon, 17 Mar 2025 00:00:00 GMT</pubDate><content:original-text>
ç¬”è€…çš„ä¸šä½™çˆ±å¥½ä¹‹ä¸€å°±æ˜¯é€› Pixivï¼Œæ”¶è—å¥½çœ‹çš„æ’ç”»ç­‰ä½œå“å¹¶ä¸‹è½½åˆ°æœ¬åœ°ã€‚æ²¹çŒ´è„šæœ¬ Pixiv Previewer åšäº†ä¸¤ä¸ªç¬”è€…å¾ˆå–œæ¬¢çš„ä¾¿åˆ©æ€§å·¥ä½œï¼š

1. **ä½œå“é¢„è§ˆ**ï¼šé¼ æ ‡æ‚¬æµ®åœ¨ä½œå“ç¼©ç•¥å›¾ä¸Šæ—¶è‡ªåŠ¨åœ¨å½“å‰é¡µé¢æ˜¾ç¤ºå¤§å›¾ï¼Œå¿«é€Ÿå†³å®šè¦ä¸è¦ç‚¹è¿›ä½œå“é¡µã€‚
2. **ä½œå“æ’åº**ï¼šä½œå“æœç´¢é¡µå¯ä»¥æŒ‰â€œæ’åºâ€æŒ‰é’®ï¼Œè‡ªåŠ¨è·å–è‹¥å¹²é¡µçš„ä½œå“å¹¶æŒ‰ç…§æ”¶è—æ•°æ’åºï¼Œå¿«é€Ÿç­›é€‰ä¼˜è´¨ä½œå“ã€‚

å‡ºäºçˆ±å¥½ï¼Œç¬”è€…å»[è„šæœ¬ä»“åº“](https://github.com/Ocrosoft/PixivPreviewer)ç¿»é˜…äº†ä¸€ä¸‹æºç ï¼Œè§‰å¾—æœ‰ä¸€äº›å¯ä»¥æ”¹è¿›çš„åœ°æ–¹ï¼Œé‚ Fork ä¹‹ï¼Œè¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚

## å·¥ç¨‹åŒ–æ”¹é€ 

é¦–å½“å…¶å†²çš„è‡ªç„¶æ˜¯å‰ç«¯é¡¹ç›®å·¥ç¨‹åŒ–æ”¹é€ ã€‚å¤§å¤šæ•°æ²¹çŒ´è„šæœ¬ä»“åº“éƒ½æ˜¯å­¤é›¶é›¶çš„ä¸€ä¸ª JavaScript æ–‡ä»¶ï¼ŒPixiv Previewer ä¹Ÿä¸ä¾‹å¤–ã€‚ç›´æ¥æ‰‹æ“ JavaScript è™½ç„¶å¾ˆä¾¿åˆ©ï¼Œä½†åœ¨é¡¹ç›®é•¿æœŸçš„ç»´æŠ¤å¼€å‘ä¸­å¤šåŠä¼šæ©åŸ‹æ‰è®¸å¤šæœªæ›¾ç•™æ„çš„ Bugï¼ŒåŒæ—¶ç”±äºç¼ºå°‘å…³è”æç¤ºï¼Œå¼€å‘æ•ˆç‡ä¹Ÿä¼šå¤§æ‰“æŠ˜æ‰£ã€‚ä½œä¸ºå‰ç«¯å·¥ç¨‹å¸ˆï¼Œè¿™æ ·å¯æ€•çš„äº‹æƒ…è‡ªç„¶æ˜¯ä¸èƒ½æ¥å—çš„ã€‚

### é€šè¿‡ tsup æ„å»ºé¡¹ç›®

åˆå§‹åŒ– `package.json` ç­‰è¿‡ç¨‹è·³è¿‡ä¸è¡¨ï¼Œæ·»åŠ  TypeScript æ”¯æŒè‡ªç„¶æ˜¯å¯¹é¡¹ç›®è¿›è¡ŒäºŒæ¬¡å¼€å‘çš„å‰ç½®æ­¥éª¤ã€‚ç”±äºæˆ‘ä»¬æœ€åæ„å»ºçš„äº§ç‰©å°†ä½œä¸ºæ²¹çŒ´è„šæœ¬è¿è¡Œï¼Œå³æ‰“åŒ…ä¸ºåº“ï¼Œå› æ­¤ç¬”è€…é€‰æ‹©äº†å¼€ç®±å³ç”¨çš„ [tsup](https://github.com/egoist/tsup)ï¼š

```bash
yarn add -D tsup
```

æ·»åŠ  tsup çš„é…ç½®æ–‡ä»¶ `tsup.config.ts`ï¼š

```ts
import svg from &quot;esbuild-plugin-svg&quot;;
import { defineConfig } from &quot;tsup&quot;;

import packageJson from &quot;./package.json&quot;;

export default defineConfig({
  entry: [&quot;src/index.ts&quot;],
  target: [&quot;chrome107&quot;],
  minify: false,
  splitting: false,
  clean: true,
  platform: &quot;browser&quot;,
  esbuildPlugins: [svg()], // ä¸ºäº†æ­£ç¡®å¤„ç†é¡¹ç›®ä¸­ç”¨åˆ°çš„ SVG æ–‡ä»¶ï¼Œæ·»åŠ äº†æ­¤æ’ä»¶
  env: {
    VERSION: packageJson.version,
  },
  banner: {
    js: `// ==UserScript==
// @name                Pixiv Previewer L
// @namespace           ${packageJson.homepage}
// @version             ${packageJson.version}-${new Date().toLocaleDateString()}
// @description         ${packageJson.description}
// @author              ${packageJson.author}
// @license             ${packageJson.license}
// @supportURL          ${packageJson.homepage}
// @match               *://www.pixiv.net/*
// @grant               GM_getValue
// @grant               GM_setValue
// @grant               GM_registerMenuCommand
// @grant               GM_unregisterMenuCommand
// @grant               GM.xmlHttpRequest
// @icon                https://t0.gstatic.com/faviconV2?client=SOCIAL&amp;type=FAVICON&amp;fallback_opts=TYPE,SIZE,URL&amp;size=32&amp;url=https://www.pixiv.net
// @icon64              https://t0.gstatic.com/faviconV2?client=SOCIAL&amp;type=FAVICON&amp;fallback_opts=TYPE,SIZE,URL&amp;size=64&amp;url=https://www.pixiv.net
// @require             https://update.greasyfork.org/scripts/515994/1478507/gh_2215_make_GM_xhr_more_parallel_again.js
// @require             http://code.jquery.com/jquery-3.7.1.min.js
// @run-at              document-end
// ==/UserScript==`,
  },
});
```

ä¸Šé¢çš„é…ç½®è¡¨ç¤ºï¼Œtsup å°†æ‰“åŒ…æ„å»ºæºæ–‡ä»¶ `src/index.ts` è‡³é»˜è®¤äº§ç‰©æ–‡ä»¶ `dist/index.js`ï¼Œä¿è¯å…¼å®¹ `Chrome &gt;= 107`ã€‚å…¶ä¸­ï¼Œç¬”è€…å¤ç”¨äº† `package.json` é‡Œå®šä¹‰çš„è‹¥å¹²å­—æ®µï¼Œç”¨äºæ·»åŠ é¡¹ç›®ç¯å¢ƒå˜é‡ï¼ˆè„šæœ¬é€šè¿‡ç‰ˆæœ¬å·åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºæ›´æ–°æ—¥å¿—æ¡†ï¼‰ï¼Œä»¥åŠç”Ÿæˆæ²¹çŒ´è„šæœ¬é¡¶éƒ¨çš„é…ç½®é¡¹ã€‚

è¿™æ ·ï¼Œå½“æ‰§è¡Œ `tsup` å‘½ä»¤æ—¶ï¼Œæ„å»ºçš„äº§ç‰©å½¢å¦‚ï¼š

```js
// ==UserScript==
// @name                Pixiv Previewer L
// @namespace           https://github.com/LolipopJ/PixivPreviewer
// @version             1.1.1-2025/4/25
// @description         Original project: https://github.com/Ocrosoft/PixivPreviewer.
// @author              Ocrosoft, LolipopJ
// @license             GPL-3.0
// @supportURL          https://github.com/LolipopJ/PixivPreviewer
// @match               *://www.pixiv.net/*
// @grant               GM_getValue
// @grant               GM_setValue
// @grant               GM_registerMenuCommand
// @grant               GM_unregisterMenuCommand
// @grant               GM.xmlHttpRequest
// @icon                https://t0.gstatic.com/faviconV2?client=SOCIAL&amp;type=FAVICON&amp;fallback_opts=TYPE,SIZE,URL&amp;size=32&amp;url=https://www.pixiv.net
// @icon64              https://t0.gstatic.com/faviconV2?client=SOCIAL&amp;type=FAVICON&amp;fallback_opts=TYPE,SIZE,URL&amp;size=64&amp;url=https://www.pixiv.net
// @require             https://update.greasyfork.org/scripts/515994/1478507/gh_2215_make_GM_xhr_more_parallel_again.js
// @require             http://code.jquery.com/jquery-3.7.1.min.js
// @run-at              document-end
// ==/UserScript==

// ... è„šæœ¬æ„å»ºåçš„ä»£ç 
```

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œtsup ä¼šä½¿ç”¨é¢„è®¾çš„ `tsconfig.json`ã€‚ä½†ç¬”è€…åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå‘ç° VSCode æœ‰æ—¶ä¼šé—æ¼æŸäº›ç±»å‹çš„å®šä¹‰ï¼Œäºæ˜¯æ‰‹åŠ¨æ·»åŠ äº† `tsconfig.json` åœ¨æ ¹ç›®å½•ï¼š

```json
{
  &quot;compilerOptions&quot;: {
    &quot;target&quot;: &quot;ES2022&quot;,
    &quot;module&quot;: &quot;esnext&quot;,
    &quot;esModuleInterop&quot;: true,
    &quot;moduleResolution&quot;: &quot;bundler&quot;,
    &quot;skipLibCheck&quot;: true,
    &quot;forceConsistentCasingInFileNames&quot;: true,
    &quot;lib&quot;: [&quot;esnext&quot;, &quot;dom&quot;]
  },
  &quot;include&quot;: [&quot;src/&quot;],
  &quot;exclude&quot;: [&quot;node_modules/&quot;, &quot;dist/&quot;]
}
```

### ä»£ç è´¨é‡æ£€æŸ¥ä¸æ ¼å¼åŒ–å·¥å…·

TypeScript è‡ªèº«å·²åŒ…å«ç±»å‹æ£€æŸ¥ç­‰èƒ½åŠ›ï¼Œä½†è¿˜å¯ä»¥å¼•å…¥æ›´å¤šè´¨é‡æ£€æŸ¥çš„é€šç”¨è§„èŒƒï¼Œæå‡é¡¹ç›®çš„å¥å£®æ€§ã€‚å¯¹äº TypeScript é¡¹ç›®ï¼Œç›®å‰æ¥çœ‹æœ€å¥½çš„é€‰æ‹©åº”å½“æ˜¯ [`typescript-eslint`](https://github.com/typescript-eslint/typescript-eslint)ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£æ·»åŠ ä¾èµ–å¹¶é…ç½® `eslint.config.mjs`ï¼š

```bash
yarn add --dev eslint @eslint/js typescript typescript-eslint
```

```js
// @ts-check

import eslint from &quot;@eslint/js&quot;;
import tseslint from &quot;typescript-eslint&quot;;

export default tseslint.config(
  eslint.configs.recommended,
  tseslint.configs.recommended,
);
```

ç°åœ¨æ‰§è¡Œ `eslint src --fix` å³å¯æŸ¥æ‰¾å¹¶å°è¯•ä¿®å¤ `src/` ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„è´¨é‡é—®é¢˜ã€‚

æ¥ç€ä¸ºé¡¹ç›®æ·»åŠ è‡ªåŠ¨æ ¼å¼åŒ–èƒ½åŠ›ï¼ŒPrettier æ˜¯ç¬”è€…æœ€æ¨èçš„é€‰é¡¹ã€‚æ­¤å¤–ï¼Œç¬”è€…å–œæ¬¢å°† Prettier ä¸ ESLint ç»“åˆèµ·æ¥ä¸€èµ·ä½¿ç”¨ï¼Œå³åœ¨æ‰§è¡Œ `eslint src --fix` ä¿®å¤è´¨é‡é—®é¢˜çš„åŒæ—¶ï¼Œè‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ã€‚ESLint çš„æ’ä»¶ [`eslint-plugin-prettier`](https://github.com/prettier/eslint-plugin-prettier) å¯ä»¥å®ç°å¦‚ä¸Šèƒ½åŠ›ï¼Œæ·»åŠ æ­¤æ’ä»¶ä½œä¸ºä¾èµ–å¹¶è¿›ä¸€æ­¥é…ç½® `eslint.config.mjs`ï¼š

```bash
yarn add -D prettier eslint-plugin-prettier eslint-config-prettier
```

```js
// @ts-check

import eslint from &quot;@eslint/js&quot;;
import tseslint from &quot;typescript-eslint&quot;;
import eslintPluginPrettierRecommended from &quot;eslint-plugin-prettier/recommended&quot;;

export default tseslint.config(
  eslint.configs.recommended,
  tseslint.configs.recommended,
  eslintPluginPrettierRecommended,
);
```

æ­¤å¤–ï¼ŒPixiv Previewer é¡¹ç›®ä¾èµ–äº JQuery æ¥æ‰§è¡ŒæŸ¥æ‰¾ä¸ä¿®æ”¹ DOM çš„æ“ä½œï¼Œç¬”è€…æ·»åŠ äº†ç›¸åº”çš„ç±»å‹æç¤ºï¼š

```bash
yarn add -D @types/jquery globals
```

```js
// @ts-check

import eslint from &quot;@eslint/js&quot;;
import tseslint from &quot;typescript-eslint&quot;;
import eslintPluginPrettierRecommended from &quot;eslint-plugin-prettier/recommended&quot;;
import globals from &quot;globals&quot;;

export default tseslint.config(
  eslint.configs.recommended,
  tseslint.configs.recommended,
  {
    languageOptions: {
      globals: {
        ...globals.browser,
        ...globals.jquery,
      },
    },
  },
  eslintPluginPrettierRecommended,
);
```

è‡³æ­¤ï¼ŒåŸºæœ¬çš„é¡¹ç›®å·¥ç¨‹åŒ–æ”¹é€ å‘Šä¸€æ®µè½ã€‚é¡¹ç›®å¯ä»¥åŸºäº TypeScript å¼€å‘ï¼Œå¹¶ä¸”æ‹¥æœ‰äº†è´¨é‡æ£€æŸ¥å’Œæ ¼å¼åŒ–èƒ½åŠ›ã€‚å°†åŸæ¥çš„ JavaScript ä»£ç æ”¾åˆ° `src/index.ts` æ–‡ä»¶é‡Œï¼Œå¼€å§‹æ­£å¼çš„äºŒæ¬¡å¼€å‘å§ï¼

## é¢„è§ˆåŠŸèƒ½ä¼˜åŒ–

ç¬”è€…åœ¨é˜…è¯» Pixiv Previewer æºç æ—¶å‘ç°ï¼ŒåŸä½œè€…æ ¹æ®å½“å‰é¡µé¢çš„ä¸åŒï¼Œå®ç°äº†ä¸åŒçš„é€šè¿‡ DOM èŠ‚ç‚¹å¯»æ‰¾å¯é¢„è§ˆä½œå“çš„ `&lt;img&gt;` æ ‡ç­¾çš„æ–¹æ³•ï¼Œå¹¶ä¸ºå®ƒæ·»åŠ ç›‘å¬äº‹ä»¶ï¼Œå½“é¼ æ ‡æ‚¬æµ®åœ¨ä¸Šé¢çš„æ—¶å€™æ˜¾ç¤ºé¢„è§ˆã€‚ä¸ºäº†åº”å¯¹ä½œå“åŠ¨æ€åŠ è½½çš„æƒ…å†µï¼Œè„šæœ¬è®¾ç½®äº†å¾ªç¯å®šæ—¶å™¨ï¼Œæ¯éš”ä¸€å°æ®µæ—¶é—´é‡æ–°æ‰§è¡Œä¸Šè¿°æ–¹æ³•ã€‚

è¿™ç§åŠ›å¤§ç –é£çš„å®ç°æ–¹æ¡ˆå­˜åœ¨ä¸€ä¸ªä¸å¯å¿½è§†çš„ç¼ºé™·ï¼šè¦è€ƒè™‘åˆ°æ¯ä¸ªé¡µé¢é‡Œä¸åŒçš„ä½œå“ `&lt;img&gt;` æ ‡ç­¾çš„æ’å¸ƒæƒ…å†µï¼Œä¸ºä¹‹å®ç°ç»‘å®šäº‹ä»¶çš„æ–¹æ³•ã€‚å¯¹äºæ²¡æœ‰è€ƒè™‘åˆ°çš„ä½œå“ `&lt;img&gt;` æ ‡ç­¾ï¼Œè‡ªç„¶æ— æ³•æ˜¾ç¤ºé¢„è§ˆã€‚ä¾‹å¦‚ï¼Œåœ¨å½“å‰çš„ `Pixiv Previewer@3.7.32` ç‰ˆæœ¬ï¼Œè‰ºæœ¯å®¶å¼¹çª—é‡Œæœ€è¿‘çš„ä½œå“å°±æ— æ³•æ˜¾ç¤ºé¢„è§ˆï¼š

![è‰ºæœ¯å®¶æœ€è¿‘ä½œå“æš‚æœªå®ç°é¢„è§ˆåŠŸèƒ½](./pixiv-previewer/unimplemented-preview.png)

å¦å¤–ï¼Œå¦‚æœ Pixiv å‰ç«¯é¡µé¢æŸä¸€å¤©è¿­ä»£æ›´æ–°ï¼Œå¯»æ‰¾ä½œå“ `&lt;img&gt;` æ ‡ç­¾çš„æ–¹æ³•ä¹Ÿå¯èƒ½éœ€è¦å¤§åˆ€é˜”æ–§åœ°ä¿®æ”¹ã€‚

&gt; å‘å¸ƒè¿™ç¯‡åšå®¢çš„ç¬¬äºŒå¤©ï¼Œ2025 å¹´ 03 æœˆ 18 æ—¥ï¼ŒPixiv å°±ä¸Šçº¿äº†æ–°çš„é¦–é¡µï¼Œâ€œæ¨èä½œå“â€æ¨¡å—çš„ä¸‹é¢å˜æˆäº†æ— é™æ»šåŠ¨çš„æ¨æ–‡æ¨¡å¼ã€‚ç”±äºæ¨æ–‡å­˜åœ¨é«˜åº¦ä¸Šé™ï¼Œå› æ­¤éƒ¨åˆ†å°ºå¯¸çš„å›¾ç‰‡è¿˜æ˜¯ä¼šå‡ºç°æ˜¾ç¤ºä¸å…¨çš„æƒ…å†µï¼Œå¯ä»¥æ·»åŠ é¢„è§ˆåŠŸèƒ½ã€‚

ç¬”è€…æƒ³åˆ°çš„æ”¹è¿›æ–¹æ¡ˆæ˜¯ï¼šæŠŠæ‰¾ä½œå“ `&lt;img&gt;` æ ‡ç­¾çš„å·¥ä½œï¼Œä»è„šæœ¬æ‰‹ä¸­ç§»äº¤åˆ°ç”¨æˆ·æ‰‹ä¸­ã€‚å³ç›‘å¬é¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼Œå½“æ‚¬æµ®åˆ°å¯é¢„è§ˆä½œå“ä¸Šæ—¶ï¼Œæ˜¾ç¤ºé¢„è§ˆã€‚

```ts
const onMouseMove = (mouseMoveEvent: JQuery.MouseMoveEvent) =&gt; {
  onMouseOverIllust(mouseMoveEvent.target);
};

$(document).on(&quot;mousemove&quot;, onMouseMove);
```

åœ¨ä¸Šé¢çš„ä»£ç é‡Œï¼Œç¬”è€…ä¸º Document å…¨å±€ç»‘å®šäº† `mousemove` ç›‘å¬äº‹ä»¶ï¼Œå½“é¼ æ ‡ç§»åŠ¨æ—¶ï¼Œè°ƒç”¨ `onMouseOverIllust(target)` æ–¹æ³•ï¼Œå…¶ä¸­ `target` æ˜¯å½“å‰é¼ æ ‡æ‰€æ‚¬æµ®çš„å…ƒç´ ã€‚å¦‚æœç›‘å¬çš„æ˜¯ `mouseover` äº‹ä»¶ï¼Œè„šæœ¬å¯ä»¥æœ‰æ›´å¥½çš„æ€§èƒ½è¡¨ç°ï¼Œä½†æ˜¯ç¬”è€…åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç° `mouseover` äº‹ä»¶å›è°ƒå¯¹è±¡é‡Œçš„ `ctrlKey` ç­‰å€¼æœ‰æ—¶ä¸èƒ½æ­£ç¡®åæ˜ å®é™…çŠ¶æ€ï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹©äº†ç›‘å¬ `mousemove` äº‹ä»¶ã€‚

æ¥ç€ï¼Œéœ€è¦åˆ¤æ–­é¼ æ ‡å½“å‰æ‚¬æµ®çš„å…ƒç´ æ˜¯å¦ä¸ºå¯é¢„è§ˆçš„ä½œå“ï¼Œå¦‚æœæ˜¯åˆ™æ˜¾ç¤ºé¢„è§ˆã€‚è§‚å¯Ÿ DOM èŠ‚ç‚¹ï¼š

![ä½œå“ DOM èŠ‚ç‚¹](./pixiv-previewer/hovered-illust.png)

å¦‚æœå½“å‰é¼ æ ‡æ‚¬æµ®åœ¨å¯é¢„è§ˆçš„ä½œå“ `&lt;img&gt;` å…ƒç´ ä¸Šï¼Œåˆ™æœ¬èº«åŒ…å«äº†è®¿é—®é“¾æ¥çš„ `src` å±æ€§ï¼Œé€šè¿‡ç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼å¤„ç†å³å¯è·å–ä½œå“çš„ Pixiv ID å’Œå¤§å›¾é“¾æ¥ã€‚åŒæ—¶ï¼Œå¤–å±‚è¿˜åŒ…è£¹ç€ä¸€å±‚ `&lt;a&gt;` å…ƒç´ ï¼ŒåŒ…å«è·³è½¬é“¾æ¥ã€‚

è€ƒè™‘åˆ°éƒ¨åˆ† `&lt;img&gt;` å…ƒç´ è™½ç„¶åŒ…å«ä½œå“ç¼©ç•¥å›¾çš„ `src` å±æ€§ï¼Œä½†è·³è½¬çš„é¡µé¢å¹¶ä¸ä¸€å®šæ˜¯ä½œå“é¡µæœ¬èº«ï¼ˆ`https://www.pixiv.net/artworks/artwork-id`ï¼‰ï¼Œå³å¯èƒ½åªæ˜¯ä½œä¸ºå°é¢æ‰“å¼€åˆ«çš„é¡µé¢ï¼Œé¼ æ ‡æ‚¬æµ®åœ¨è¿™äº› `&lt;img&gt;` å…ƒç´ ä¸Šæ—¶ä¸åº”å½“æ˜¾ç¤ºé¢„è§ˆã€‚å› æ­¤ç¬”è€…å®ç°çš„åˆ¤æ–­æ–¹æ³•æ˜¯ï¼šç»Ÿä¸€å–å½“å‰æ‚¬æµ®å…ƒç´ çš„ç¬¬ä¸€ä¸ªçˆ¶ `&lt;a&gt;` èŠ‚ç‚¹ï¼Œå½“å…¶ `href` å€¼æ»¡è¶³ `/\/artworks\/(\d+)/` æ—¶ï¼Œæ˜¾ç¤ºé¢„è§ˆï¼š

```ts
const getIllustMetadata = (target: JQuery&lt;HTMLElement&gt;) =&gt; {
  let imgLink = target;
  while (!imgLink.is(&quot;A&quot;)) {
    imgLink = imgLink.parent();

    if (!imgLink.length) {
      return null;
    }
  }

  const illustHref = imgLink.attr(&quot;href&quot;);
  const illustHrefMatch = illustHref?.match(/\/artworks\/(\d+)/);
  if (!illustHrefMatch) {
    return null;
  }
  const illustId = illustHrefMatch[1];

  const ugoiraSvg = imgLink.children(&quot;div:first&quot;).find(&quot;svg:first&quot;);
  const illustType =
    ugoiraSvg.length || imgLink.hasClass(&quot;ugoku-illust&quot;)
      ? IllustType.UGOIRA // åŠ¨å›¾ä½œå“
      : IllustType.ILLUST; // æ’ç”»æˆ–æ¼«ç”»ä½œå“

  return {
    /** ä½œå“ ID */
    illustId,
    /** ä½œå“ç±»å‹ */
    illustType,
  };
};

const onMouseOverIllust = (target: JQuery&lt;HTMLElement&gt;) =&gt; {
  const { illustId, illustType } = getIllustMetadata(target) || {};
  previewIllust({ target, illustId, illustType });
};
```

æ’ç”»æˆ–æ¼«ç”»ä½œå“å¯èƒ½å­˜åœ¨å¤šé¡µï¼Œå¤„ç†æ—¶å¯ä»¥å§‹ç»ˆè°ƒç”¨ Pixiv å®˜æ–¹çš„æ¥å£ `/ajax/illust/${artwork-id}/pages`ï¼Œè·å–æŒ‡å®šä½œå“åŒ…å«çš„æ‰€æœ‰é“¾æ¥ã€‚

å†ä¿®ä¿®è¡¥è¡¥ï¼Œä¸ºäº‹ä»¶åŠ ä¸ŠèŠ‚æµå‡½æ•°ï¼Œå“åº”é¼ æ ‡æ»šåŠ¨åˆ‡æ¢é¡µæ•°ç­‰ï¼Œå®ç°äº†å’ŒåŸç‰ˆå¹¶æ— äºŒå¼‚çš„é¢„è§ˆèƒ½åŠ›ï¼š

![Pixiv é¢„è§ˆ](./pixiv-previewer/previewer.png)

å¯å–œå¯è´ºï¼Œå¯å–œå¯è´ºï¼

## æ’åºåŠŸèƒ½é‡æ„ä¸ä¼˜åŒ–

åŸè„šæœ¬çš„é¢„è§ˆåŠŸèƒ½å·²ç»èƒ½å¤Ÿéå¸¸å¥½åœ°å®ç°ç¬”è€…éœ€è¦çš„èƒ½åŠ›äº†ï¼Œç¬”è€…æƒ³è¦åœ¨æ­¤åŸºç¡€ä¸ŠåŠ å…¥ä¸€äº›é¢å¤–çš„èƒ½åŠ›æˆ–åšä¸€äº›ä¼˜åŒ–ã€‚

å…¶å®æœ€å¼€å§‹çš„åŸåŠ¨åŠ›æ¥è‡ªäºåŸè„šæœ¬åœ¨æŸæ¬¡æ›´æ–°ä»¥åï¼Œæ’åºåŠŸèƒ½çªç„¶å˜å¾—å¾ˆæ…¢ï¼Œè¿‡å»ç¬”è€…ä¸€æ¬¡æ€§å–œæ¬¢æ’åº 20 é¡µä½œå“å†æŒ‘é€‰å–œæ¬¢çš„ï¼Œç°åœ¨å´è¦å…ˆç­‰ä¸ªäºŒååˆ†é’Ÿï¼Œè¿˜å¯èƒ½â€œä¸­é“å´©æ®‚â€ã€‚åé¢çœ‹å…¬å‘Šæ‰äº†è§£åˆ°ï¼ŒPixiv ä»æŸå¤©å¼€å§‹å¯¹æ¥è‡ªäºåŒ IP çš„è¯·æ±‚è¿›è¡Œäº†é™åˆ¶ï¼Œå¦‚æœçŸ­æ—¶é—´å†…è¶…è¿‡äº†è¯·æ±‚çš„ä¸Šé™ï¼Œåˆ™ä¼šæš‚æ—¶å±è”½è¯·æ±‚ã€‚è¿™ç‚¹å¯¹äº Pixiv æ¥è¯´æ— å¯åšéï¼Œèƒ½å¤§å¤§ç¼“è§£åƒç¬”è€…è¿™æ ·çš„æœåŠ¡å™¨è›€è™«çš„â€œæ”»å‡»â€ã€‚

äºæ˜¯ä¾¿å¼€å§‹äº†æœ¬ä»¥ä¸ºæ— é™æœŸçš„å’•å’•å’•ï¼Œä½†æœ€è¿‘ä»£ç å†™å¾—æ‰‹æ„Ÿç«çƒ­ï¼Œæƒ³åˆ°äº†è¿™ä¸ªå‘ï¼Œå°±èŠ±äº†å‡ å¤©å¡«ä¸€å¡«ã€‚åŒæ—¶ä¹Ÿå¤šæ¥è§¦æ¥è§¦åŸç”Ÿ DOM æ“ä½œç­‰å°çŸ¥è¯†ï¼Œç™¾åˆ©æ— ä¸€å®³ã€‚

### è¯·æ±‚ä½œå“åˆ†é¡µ

æ’åºåŠŸèƒ½çš„æœ¬è´¨å°±æ˜¯åŒæ—¶è¯·æ±‚å¤šä¸ªåˆ†é¡µï¼Œå†è·å–æ¯ä¸ªä½œå“çš„è¯¦ç»†ä¿¡æ¯ï¼Œæœ€ååœ¨å‰ç«¯æ˜¾ç¤ºå‡ºæ¥ã€‚ä¸‹é¢ä»¥æ ‡ç­¾æœç´¢ç»“æœçš„é¡µé¢ä¸ºä¾‹ï¼Œå®ç°æ’åºåŠŸèƒ½ã€‚

å¯¹äºä¸åŒçš„å¯æ’åºé¡µé¢ï¼Œéœ€è¦è·å–çš„è¦ç´ æœ‰ä¸‰ï¼š

- è¯·æ±‚åˆ†é¡µçš„æ¥å£ã€‚
- è¯·æ±‚åˆ†é¡µçš„å‚æ•°ã€‚
- ä½œå“çš„åˆ—è¡¨ DOM èŠ‚ç‚¹ã€‚

ä½¿ç”¨è§‚å¯Ÿæ³•ï¼Œåœ¨ç½‘ç»œè¯·æ±‚é‡Œæ‰¾åˆ°åˆ†é¡µçš„æ¥å£ä¸é»˜è®¤çš„æœç´¢å‚æ•°ï¼š

```ts
function getSortOptionsFromPathname(pathname: string) {
  let type: IllustSortType;
  let api: string;
  let defaultSearchParams: string;

  let match: RegExpMatchArray;
  if (
    (match = pathname.match(/\/tags\/(.+)\/(artworks|illustrations|manga)$/))
  ) {
    const tagName = match[1];
    const filterType = match[2];

    switch (filterType) {
      case &quot;artworks&quot;:
        type = IllustSortType.TAG_ARTWORK;
        api = `/ajax/search/artworks/${tagName}`;
        defaultSearchParams = `word=${tagName}&amp;order=date_d&amp;mode=all&amp;p=1&amp;csw=0&amp;s_mode=s_tag_full&amp;type=all&amp;lang=zh`;
        break;
      case &quot;illustrations&quot;:
        type = IllustSortType.TAG_ILLUST;
        api = `/ajax/search/illustrations/${tagName}`;
        defaultSearchParams = `word=${tagName}&amp;order=date_d&amp;mode=all&amp;p=1&amp;csw=0&amp;s_mode=s_tag_full&amp;type=illust_and_ugoira&amp;lang=zh`;
        break;
      case &quot;manga&quot;:
        type = IllustSortType.TAG_MANGA;
        api = `/ajax/search/manga/${tagName}`;
        defaultSearchParams = `word=${tagName}&amp;order=date_d&amp;mode=all&amp;p=1&amp;csw=0&amp;s_mode=s_tag_full&amp;type=manga&amp;lang=zh`;
        break;
    }
  }

  return {
    type,
    api,
    searchParams: new URLSearchParams(defaultSearchParams),
  };
}
```

å½“ç”¨æˆ·åœ¨å‰ç«¯è®¾ç½®æœç´¢æ¡ä»¶çš„æ—¶å€™ï¼Œæœç´¢æ¡ä»¶ä¼šè‡ªåŠ¨è¿½åŠ åˆ°å½“å‰çš„ Search Params ä¸Šã€‚è„šæœ¬åœ¨å¤„ç†çš„æ—¶å€™ï¼Œä¹Ÿåº”è¯¥è¯»å– Search Paramsï¼Œå†ä¸æ–¹æ³• `getSortOptionsFromPathname()` å¾—åˆ°çš„é»˜è®¤ `searchParams` è¿›è¡Œåˆå¹¶ï¼Œè®©æ¥å£è¯·æ±‚ç¬¦åˆç”¨æˆ·é¢„æœŸï¼š

```ts
const url = new URL(location.href);
const { pathname, searchParams } = url;

const {
  type,
  api,
  searchParams: defaultSearchParams,
} = getSortOptionsFromPathname(pathname);

const mergedSearchParams = new URLSearchParams(defaultSearchParams);
searchParams.forEach((value, key) =&gt; {
  // ç›¸åŒå‚æ•°è¦†ç›–ï¼Œä¸åŒå‚æ•°è¿½åŠ 
  mergedSearchParams.set(key, value);
});
```

æ¥ç€ï¼Œè·å–é™ˆåˆ—ä½œå“çš„åˆ—è¡¨ DOM èŠ‚ç‚¹ï¼š

```ts
function getIllustrationsListDom(type: IllustSortType) {
  let dom: JQuery&lt;HTMLUListElement&gt;;
  if (
    [
      IllustSortType.TAG_ARTWORK,
      IllustSortType.TAG_ILLUST,
      IllustSortType.TAG_MANGA,
    ].includes(type)
  ) {
    dom = $(&quot;ul.sc-ad8346e6-1.iwHaa-d&quot;);
  }

  if (dom) {
    return dom;
  } else {
    throw new Error(`Illustrations list DOM not found.`);
  }
}
```

Pixiv çš„å‰ç«¯ä½¿ç”¨äº† CSS Module æŠ€æœ¯æ¥ç”Ÿæˆæ ·å¼åï¼Œèƒ½å¤Ÿæœ‰æ•ˆé¿å…åŒåæ ·å¼å†²çªçš„é—®é¢˜ã€‚ä½†æ˜¯å¯¹äºè„šæœ¬å¼€å‘è€…æ¥è¯´ä¼šå¢åŠ ä¸€å®šçš„ç»´æŠ¤æˆæœ¬ â€”â€” æ¯æ¬¡ Pixiv çš„æ ·å¼æ”¹å˜è€Œé‡æ–°æ„å»ºæ ·å¼æ–‡ä»¶æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨æ›´æ–°è„šæœ¬é‡Œå¯¹åº”çš„æ ·å¼åï¼Œä»¥æ­£ç¡®æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚

å› æ­¤åœ¨å®ç°é‡Œï¼Œå½“è„šæœ¬å¯»æ‰¾èŠ‚ç‚¹å¤±è´¥æ—¶ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œé˜»æ­¢è„šæœ¬çš„ç»§ç»­è¿è¡Œã€‚ä½œä¸ºå¼€å‘è€…ï¼Œåœ¨ç¢°åˆ°è¿™æ ·çš„é—®é¢˜æ—¶ï¼Œå°±å¾—èµ¶ç´§æ›´æ–°è„šæœ¬ï¼Œæˆ–è€…æƒ³ä¸€æƒ³æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹å¼èƒ½å®šä½æ­¤èŠ‚ç‚¹ï¼ˆä¾‹å¦‚æœç´¢åŒ…å« 60 ä¸ªå­å…ƒç´ çš„ `ul` èŠ‚ç‚¹ ğŸ¤”ï¼‰ã€‚

### è·å–ä½œå“è¯¦ç»†ä¿¡æ¯

ä¸ºäº†è·å–ä½œå“çš„æ”¶è—æ•°æ®ä»¥æ’åºï¼Œéœ€è¦é€šè¿‡å¦å¤–çš„æ¥å£è·å–ä½œå“çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚æœè¯·æ±‚åˆ†é¡µçš„æ—¶å€™ï¼Œå“åº”å€¼å°±æŠŠä½œå“çš„æ”¶è—æ•°å¸¦ä¸Šå°±å¥½äº†â€¦â€¦ï¼‰ã€‚

è¿™é‡Œç›´æ¥æ²¿ç”¨äº†åŸä½œè€…ä½¿ç”¨çš„æ¥å£ `/touch/ajax/illust/details?illust_id=${id}`ï¼š

```ts
async function getIllustrationDetailsWithCache(id: string) {
  let illustDetails: IllustrationDetails =
    await getCachedIllustrationDetails(id);

  if (illustDetails) {
    iLog.d(`Use cached details for illustration ${id}`, illustDetails);
  } else {
    const requestUrl = `/touch/ajax/illust/details?illust_id=${id}`;
    const getIllustDetailsRes = await requestWithRetry({
      url: requestUrl,
      onRetry: (response, retryTimes) =&gt; {
        iLog.w(
          `Get illustration details through \`${requestUrl}\` failed:`,
          response,
          `${retryTimes} times retrying...`,
        );
      },
    });
    illustDetails = (
      getIllustDetailsRes.response as PixivStandardResponse&lt;{
        illust_details: IllustrationDetails;
      }&gt;
    ).body.illust_details;
  }

  cacheIllustrationDetails(illustDetails);

  return illustDetails;
}
```

åœ¨æ­¤åŸºç¡€ä¸Šåšäº†ä¸¤ä¸ªé¢å¤–çš„å·¥ä½œã€‚å…¶ä¸€æ˜¯ç¼“å­˜ä½œå“è¯¦ç»†ä¿¡æ¯ï¼šå¯¹äºå‘å¸ƒæ—¶é—´è¶…è¿‡ 6 å°æ—¶çš„ä½œå“ï¼Œæˆ‘ä»¬è®¤ä¸ºä½œå“çš„æ”¶è—æ•°å˜åŒ–ç‡ä¼šè¶‹äºå¹³ç¨³ï¼Œåˆ™å°†ä½œå“çš„è¯¦ç»†ä¿¡æ¯ç¼“å­˜ 12 å°æ—¶ã€‚12 å°æ—¶å†…å†è·å–æ­¤ä½œå“çš„è¯¦ç»†ä¿¡æ¯æ—¶ï¼Œç›´æ¥ä» Indexed DB é‡Œæ‹¿ã€‚çœç•¥ Indexed DB åˆå§‹åŒ–å’Œé”™è¯¯å¤„ç†ç­‰é€»è¾‘ï¼Œæ ¸å¿ƒå®ç°å¦‚ä¸‹ï¼š

```ts
/** ç¼“å­˜æ•°æ®è¡¨åç§° */
const ILLUSTRATION_DETAILS_CACHE_TABLE_KEY = &quot;illustrationDetailsCache&quot;;
/** ç¼“å­˜è¿‡æœŸæ—¶é—´ */
const ILLUSTRATION_DETAILS_CACHE_TIME = 1000 * 60 * 60 * 12; // 12 å°æ—¶
/** ä¸æ·»åŠ ç¼“å­˜çš„æ–°ä½œå“å‘å¸ƒæ—¶é—´ */
const NEW_ILLUSTRATION_NOT_CACHE_TIME = 1000 * 60 * 60 * 6; // 6 å°æ—¶

/** ç¼“å­˜ä½œå“è¯¦ç»†ä¿¡æ¯ */
const cacheIllustrationDetails = (
  illustration: IllustrationDetails,
  now: Date = new Date(),
) =&gt; {
  return new Promise&lt;void&gt;(() =&gt; {
    const cachedIllustrationDetailsObjectStore = db
      .transaction(ILLUSTRATION_DETAILS_CACHE_TABLE_KEY, &quot;readwrite&quot;)
      .objectStore(ILLUSTRATION_DETAILS_CACHE_TABLE_KEY);

    const createDate = new Date(illustration.createDate);

    if (
      now.getTime() - createDate.getTime() &gt;
      NEW_ILLUSTRATION_NOT_CACHE_TIME
    ) {
      // ä½œå“å‘å¸ƒè¶…è¿‡ä¸€å®šæ—¶é—´ï¼Œæ·»åŠ ç¼“å­˜
      const illustrationDetails: IllustrationDetailsCache = {
        ...illustration,
        cacheDate: now,
      };
      // è¿™é‡Œç®€å•å¤„ç†ï¼Œå¦‚æœæ•°æ®åº“é‡Œå·²ç»åŒ…å«ç¼“å­˜æ•°æ®ï¼Œåˆ™é‡æ–°è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º 12 å°æ—¶
      // å½“ç„¶ï¼Œæ›´åˆç†çš„æ–¹å¼æ˜¯å­˜åœ¨æ—¶è·³è¿‡ï¼Œä¸é‡æ–°è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´
      const addCachedIllustrationDetailsRequest =
        cachedIllustrationDetailsObjectStore.put(illustrationDetails);
    }
  });
};

/** è·å–ä½œå“è¯¦ç»†ä¿¡æ¯ç¼“å­˜ */
const getCachedIllustrationDetails = (id: string, now: Date = new Date()) =&gt; {
  return new Promise&lt;IllustrationDetailsCache | undefined&gt;((resolve) =&gt; {
    const cachedIllustrationDetailsObjectStore = db
      .transaction(ILLUSTRATION_DETAILS_CACHE_TABLE_KEY, &quot;readwrite&quot;)
      .objectStore(ILLUSTRATION_DETAILS_CACHE_TABLE_KEY);

    const getCachedIllustrationDetailsRequest =
      cachedIllustrationDetailsObjectStore.get(id);

    getCachedIllustrationDetailsRequest.onsuccess = (event) =&gt; {
      const illustrationDetails = (
        event.target as IDBRequest&lt;IllustrationDetailsCache | undefined&gt;
      ).result;
      if (illustrationDetails) {
        const { cacheDate } = illustrationDetails;
        if (
          now.getTime() - cacheDate.getTime() &lt;=
          ILLUSTRATION_DETAILS_CACHE_TIME
        ) {
          // ç¼“å­˜æœªè¿‡æœŸï¼Œè¿”å›ç¼“å­˜ç»“æœ
          resolve(illustrationDetails);
        }
      }
      resolve(undefined);
    };
  });
};
```

è®¾ç½®ç¼“å­˜çš„ä¸»è¦ç›®çš„æ˜¯å‡å°‘è¢« Pixiv é™åˆ¶è¯·æ±‚çš„å¯èƒ½æ€§ï¼Œä¹Ÿä¾¿äºå¼€å‘æµ‹è¯•ã€‚

ç¬¬äºŒä¸ªé¢å¤–çš„å·¥ä½œæ˜¯ï¼šä¸ºè·å–ä½œå“è¯¦ç»†ä¿¡æ¯çš„è¯·æ±‚æ·»åŠ é”™è¯¯é‡è¯•æœºåˆ¶ï¼Œé¿å…å›  Pixiv é™åˆ¶å¼•èµ·çš„æ’åºåŠŸèƒ½å¤±æ•ˆã€‚è¿™ä¸€ç‚¹é€šè¿‡å°è£…è¯·æ±‚æ–¹æ³•å®ç°ï¼š

```ts
const xmlHttpRequest = window.GM.xmlHttpRequest;

/** æ ‡å‡†çš„è¯·æ±‚æ–¹æ³• */
export const request = &lt;TContext = unknown&gt;(
  options: Tampermonkey.Request&lt;TContext&gt;,
) =&gt; {
  const { headers, ...restOptions } = options;
  return xmlHttpRequest&lt;TContext&gt;({
    responseType: &quot;json&quot;,
    ...restOptions,
    headers: {
      referer: &quot;https://www.pixiv.net/&quot;,
      ...headers,
    },
  });
};

/** å°è£…äº†é”™è¯¯é‡è¯•æœºåˆ¶çš„è¯·æ±‚æ–¹æ³• */
export const requestWithRetry = async &lt;TContext = unknown&gt;(
  options: Tampermonkey.Request&lt;TContext&gt; &amp; {
    /** é‡è¯•é—´éš”æ—¶é—´ï¼ˆmsï¼‰ */
    retryDelay?: number;
    /** æœ€å¤§é‡è¯•æ¬¡æ•° */
    maxRetryTimes?: number;
    /** é‡è¯•å›è°ƒ */
    onRetry?: (
      response: Tampermonkey.Response&lt;TContext&gt;,
      retryTimes: number,
    ) =&gt; void;
  },
) =&gt; {
  const {
    retryDelay = 10000,
    maxRetryTimes = Infinity,
    onRetry,
    ...restOptions
  } = options;

  let response: Tampermonkey.Response&lt;TContext&gt;;
  let retryTimes = 0;
  while (retryTimes &lt; maxRetryTimes) {
    response = await request&lt;TContext&gt;(restOptions);

    if (response.status === 200) {
      const responseData = response.response as PixivStandardResponse&lt;unknown&gt;;
      if (!responseData.error) {
        return response;
      }
    }

    retryTimes += 1;
    onRetry?.(response, retryTimes);
    await pause(retryDelay);
  }
  throw new Error(
    `Request for ${restOptions.url} failed: ${response.responseText}`,
  );
};
```

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœè¯·æ±‚å¤±è´¥ï¼Œé‚£ä¹ˆä¼šé—´éš” 10s é‡æ–°å‘èµ·ç›¸åŒè¯·æ±‚ï¼Œé‡è¯•çš„æ¬¡æ•°æ— ä¸Šé™ã€‚ç›´åˆ°è¯·æ±‚è·å¾—æˆåŠŸå“åº”å€¼æ—¶ï¼Œè¿”å›å“åº”çš„ç»“æœã€‚

æœ€åï¼Œå®ç°å¹¶å‘è¯·æ±‚çš„èƒ½åŠ›ï¼š

```ts
export const execLimitConcurrentPromises = async &lt;T&gt;(
  promises: (() =&gt; Promise&lt;T&gt;)[],
  limit = 48,
) =&gt; {
  const results: T[] = [];
  let index = 0;

  const executeNext = async () =&gt; {
    if (index &gt;= promises.length) return Promise.resolve();

    const currentIndex = index++;
    const result = await promises[currentIndex]();
    results[currentIndex] = result;
    return await executeNext();
  };

  const initialPromises = Array.from(
    { length: Math.min(limit, promises.length) },
    () =&gt; executeNext(),
  );

  await Promise.all(initialPromises);
  return results;
};

const getDetailedIllustrationPromises: (() =&gt; Promise&lt;IllustrationDetails&gt;)[] =
  [];
for (let i = 0; i &lt; illustrations.length; i += 1) {
  getDetailedIllustrationPromises.push(async () =&gt; {
    const illustration = illustrations[i];
    const illustrationId = illustration.id;
    const illustrationDetails =
      await getIllustrationDetailsWithCache(illustrationId);
    return {
      ...illustration,
      bookmark_user_total: illustrationDetails.bookmark_user_total,
    } as IllustrationDetails;
  });
}
const detailedIllustrations = await execLimitConcurrentPromises(
  getDetailedIllustrationPromises,
);
```

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè„šæœ¬ä¼šå‘èµ·è‡³å¤š 48 ä¸ªè·å–ä½œå“è¯¦ç»†ä¿¡æ¯çš„å¹¶å‘è¯·æ±‚ï¼Œæå‡æ’åºåŠŸèƒ½çš„å¤„ç†æ•ˆç‡ã€‚è€Œä¸”ç»æµ‹è¯•ï¼Œå¹¶å‘èƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šâ€œç»•è¿‡â€é£æ§æœºåˆ¶ï¼Œè‡³å°‘åœ¨é¦–æ¬¡å®Œæˆæ’åºæ—¶ï¼Œä¸ä¼šè¢«é™åˆ¶è¯·æ±‚ã€‚åªæ˜¯ç»“æŸåï¼ŒPixiv çš„æœåŠ¡å™¨â€œååº”è¿‡æ¥â€äº†ï¼Œå°±ä¼šè¢«å…³å‡ åˆ†é’Ÿå°é»‘å±‹äº† ğŸ˜¿ã€‚

å…³äºå¹¶å‘è¯·æ±‚åŠŸèƒ½ï¼Œå€¼å¾—è¡¥å……çš„ä¸€ç‚¹æ˜¯ï¼Œç”±äº [Chrome MV3 issue](https://github.com/w3c/webextensions/issues/694)ï¼Œç¬”è€…å‚è€ƒåŸä½œè€…çš„å¤„ç†ï¼Œå¼•å…¥äº†ä¿®å¤è„šæœ¬ `https://update.greasyfork.org/scripts/515994/1478507/gh_2215_make_GM_xhr_more_parallel_again.js` ä½¿å¾—å¹¶è¡Œè¯·æ±‚åŠŸèƒ½ç”Ÿæ•ˆã€‚

### å‰ç«¯å±•ç¤ºä½œå“

æ ¹æ®æ¡ä»¶è¿‡æ»¤ä½œå“å’Œæ’åºä½œå“çš„è¿‡ç¨‹è·³è¿‡ä¸è¡¨ï¼Œç›´æ¥æ¥åˆ°æœ€åå±•ç¤ºä½œå“çš„ç¯èŠ‚ï¼

```ts
class IllustrationsSorter {
  type: IllustSortType;
  illustrations: IllustrationDetails[];
  listElement: JQuery&lt;HTMLUListElement&gt;;

  constructor() {
    // ...
    this.showIllustrations();
  }

  showIllustrations() {
    const fragment = document.createDocumentFragment();
    for (const {
      aiType,
      alt,
      bookmarkData,
      bookmark_user_total,
      id,
      illustType,
      pageCount,
      profileImageUrl,
      tags,
      title,
      url,
      userId,
      userName,
    } of this.illustrations) {
      const isUgoira = illustType === IllustType.UGOIRA;

      const listItem = document.createElement(&quot;li&quot;);

      const container = document.createElement(&quot;div&quot;);
      container.style = &quot;width: 184px;&quot;;

      const illustrationAnchor = document.createElement(&quot;a&quot;);
      illustrationAnchor.setAttribute(&quot;data-gtm-value&quot;, id);
      illustrationAnchor.setAttribute(&quot;data-gtm-user-id&quot;, userId);
      illustrationAnchor.href = `/artworks/${id}`;
      illustrationAnchor.target = &quot;_blank&quot;;
      illustrationAnchor.rel = &quot;external&quot;;
      illustrationAnchor.style =
        &quot;display: block; position: relative; width: 184px;&quot;;

      const illustrationImageWrapper = document.createElement(&quot;div&quot;);
      illustrationImageWrapper.style =
        &quot;position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;&quot;;

      const illustrationImage = document.createElement(&quot;img&quot;);
      illustrationImage.src = url;
      illustrationImage.alt = alt;
      illustrationImage.style =
        &quot;object-fit: cover; object-position: center center; width: 100%; height: 100%; border-radius: 4px; background-color: rgb(31, 31, 31);&quot;;

      const ugoriaSvg = document.createElement(&quot;div&quot;);
      ugoriaSvg.style = &quot;position: absolute;&quot;;
      ugoriaSvg.innerHTML = playIcon;

      const illustrationMeta = document.createElement(&quot;div&quot;);
      illustrationMeta.style =
        &quot;position: absolute; top: 0px; left: 0px; right: 0px; display: flex; align-items: flex-start; padding: 4px 4px 0; pointer-events: none; font-size: 10px;&quot;;
      illustrationMeta.innerHTML = `
          ${
            pageCount &gt; 1
              ? `
                &lt;div style=&quot;margin-left: auto;&quot;&gt;
                  &lt;div style=&quot;display: flex; justify-content: center; align-items: center; height: 20px; min-width: 20px; color: rgb(245, 245, 245); font-weight: bold; padding: 0px 6px; background: rgba(0, 0, 0, 0.32); border-radius: 10px; line-height: 10px;&quot;&gt;
                    ${pageIcon}
                    &lt;span&gt;${pageCount}&lt;/span&gt;
                  &lt;/div&gt;
                &lt;/div&gt;`
              : &quot;&quot;
          }
        `;

      const illustrationToolbar = document.createElement(&quot;div&quot;);
      illustrationToolbar.style =
        &quot;position: absolute; top: 154px; left: 0px; right: 0px; display: flex; align-items: center; padding: 0 4px 4px; pointer-events: none; font-size: 12px;&quot;;
      // Mock: æš‚æœªå®ç°ç‚¹å‡»çˆ±å¿ƒæ”¶è— / å–æ¶ˆæ”¶è—çš„åŠŸèƒ½
      illustrationToolbar.innerHTML = `
          &lt;div style=&quot;padding: 0px 4px; border-radius: 4px; color: rgb(245, 245, 245); background: ${bookmark_user_total &gt; 50000 ? &quot;#9f1239&quot; : bookmark_user_total &gt; 10000 ? &quot;#dc2626&quot; : bookmark_user_total &gt; 5000 ? &quot;#1d4ed8&quot; : bookmark_user_total &gt; 1000 ? &quot;#15803d&quot; : &quot;#475569&quot;}; font-weight: bold; line-height: 16px; user-select: none;&quot;&gt;â¤ ${bookmark_user_total}&lt;/div&gt;
          &lt;div style=&quot;margin-left: auto;&quot;&gt;${bookmarkData ? heartFilledIcon : heartIcon}&lt;/div&gt;
        `;

      const illustrationTitle = document.createElement(&quot;div&quot;);
      illustrationTitle.innerHTML = title;
      illustrationTitle.style =
        &quot;margin-top: 4px; max-width: 100%; overflow: hidden; text-decoration: none; text-overflow: ellipsis; white-space: nowrap; line-height: 22px; font-size: 14px; font-weight: bold; color: rgb(245, 245, 245); transition: color 0.2s;&quot;;

      const illustrationAuthor = document.createElement(&quot;a&quot;);
      illustrationAuthor.setAttribute(&quot;data-gtm-value&quot;, userId);
      illustrationAuthor.href = `/users/${userId}`;
      illustrationAuthor.target = &quot;_blank&quot;;
      illustrationAuthor.rel = &quot;external&quot;;
      illustrationAuthor.style =
        &quot;display: flex; align-items: center; margin-top: 4px;&quot;;
      illustrationAuthor.innerHTML = `
          &lt;img src=&quot;${profileImageUrl}&quot; alt=&quot;${userName}&quot; style=&quot;object-fit: cover; object-position: center top; width: 24px; height: 24px; border-radius: 50%; margin-right: 4px;&quot;&gt;
          &lt;span style=&quot;min-width: 0px; line-height: 22px; font-size: 14px; color: rgb(214, 214, 214); text-decoration: none; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;&quot;&gt;${userName}&lt;/span&gt;
        `;

      illustrationImageWrapper.appendChild(illustrationImage);
      if (isUgoira) illustrationImageWrapper.appendChild(ugoriaSvg);
      illustrationAnchor.appendChild(illustrationImageWrapper);
      illustrationAnchor.appendChild(illustrationMeta);
      illustrationAnchor.appendChild(illustrationToolbar);
      illustrationAnchor.appendChild(illustrationTitle);
      container.appendChild(illustrationAnchor);
      container.appendChild(illustrationAuthor);
      listItem.appendChild(container);
      fragment.appendChild(listItem);
    }

    this.listElement.find(&quot;li&quot;).remove();
    this.listElement.append(fragment);
  }
}
```

åœ¨ä¸Šé¢çš„ä»£ç é‡Œï¼Œç¬”è€…å‚è€ƒ Pixiv ä½œå“èŠ‚ç‚¹çš„ DOMï¼Œæ‰‹åŠ¨æ„é€ äº†å¤§æŠµä¸€è‡´çš„ä½œå“èŠ‚ç‚¹ï¼Œå°½ç®¡éƒ¨åˆ†åŠŸèƒ½ç¼ºå¤±ï¼Œä½†èƒ½å¤Ÿæ»¡è¶³æ’åºä½œå“çš„éœ€è¦ã€‚ç¬”è€…ä¹Ÿè€ƒè™‘è¿‡å…‹éš†åŸç”ŸèŠ‚ç‚¹å†ä¿®æ”¹ DOM èŠ‚ç‚¹é‡Œçš„å±æ€§ä¼šå¦æ›´å¥½ï¼Œä½†æ˜¯å¿§å¿ƒå‰ç«¯ç‰ˆæœ¬æ›´æ–°å¯¼è‡´ DOM èŠ‚ç‚¹ç»“æ„æ›´æ–°ï¼Œä»¥åŠæ‹…å¿ƒä¸åŒé¡µé¢çš„ DOM èŠ‚ç‚¹ç»“æ„ä¸åŒï¼Œæ‰€ä»¥è¿˜æ˜¯äººå·¥æå‡ºæ¥äº†é€šç”¨èŠ‚ç‚¹ã€‚

æœ€åï¼Œåœ¨æƒ³è¦æ’åºçš„é¡µé¢ç‚¹å‡»æŒ‰é’®ï¼Œçœ‹çœ‹å¤§å®¶éƒ½çˆ±ä»€ä¹ˆä½œå“å§ï¼

![æ’åºåŒ…å«â€œå¤©ç«¥çˆ±ä¸½ä¸â€æ ‡ç­¾çš„ä½œå“](./pixiv-previewer/sorting-result.png)

## æœ€å

é™„ä¸Š [Github ä»“åº“åœ°å€](https://github.com/LolipopJ/PixivPreviewerL)ä¸ [Tampermonkey è„šæœ¬åœ°å€](https://greasyfork.org/zh-CN/scripts/533844)ï¼Œå¸Œæœ›å¯¹æœ‰ç±»ä¼¼éœ€æ±‚çš„äººå¸¦æ¥ä¸€äº›å¸®åŠ©ã€‚
</content:original-text><content:updated-at>2025-04-26T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[åŸºäº Gatsby æ‰“é€ æˆ‘çš„ä¸ªäººåšå®¢ç³»ç»Ÿ]]></title><description><![CDATA[ç¢ç¢å¿µ æ­å»ºä¸€ä¸ªè‡ªå·±çš„åšå®¢æ˜¯æ— æ•°è·»èº«äº IT è¡Œä¸šå¼€å‘è€…çš„å¿ƒä¸­æœ€è´¨æœ´çš„æ„¿æœ›ï¼

å›æƒ³ç¬”è€…çš„å†ç¨‹ï¼Œåˆšä¸Šå¤§å­¦çš„æ—¶å€™å°±æ‘©æ‹³æ“¦æŒæƒ³è¦å®ç°ä¸€ä¸ªåšå®¢ç³»ç»Ÿï¼Œä½†åœ¨ Github ä¸Šåˆ›å»ºäº†ä»“åº“ä»¥åå°±å¼€å§‹äº†æ— é™æœŸçš„æ‹–å»¶ï¼šè‡ªå·±æ²¡æœ‰ä»»ä½•çš„å¼€å‘ç»éªŒï¼Œä¸çŸ¥é“æ¡†æ¶ä¹Ÿä¸çŸ¥é“ UI ç»„ä»¶åº“ï¼ŒåªçŸ¥é“è¦å†™ HTML + CSS + JavaScript ä»£ç ï¼Œé¢å¯¹çœ¼å‰æƒ³è¦å®ç°çš„å®Œæ•´ç³»ç»Ÿä¸çŸ¥è¯¥å¦‚ä½•ä¸‹æ‰‹ã€‚

ä»é›¶å¼€å§‹å®ç°åšå®¢ç³»ç»Ÿçš„è®¡åˆ’è™½ç„¶ææµ…â€¦]]></description><link>https://blog.towind.fun/posts/build-my-gatsby-blog</link><guid isPermaLink="false">build-my-gatsby-blog</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Wed, 12 Mar 2025 00:00:00 GMT</pubDate><content:original-text>
## ç¢ç¢å¿µ

æ­å»ºä¸€ä¸ªè‡ªå·±çš„åšå®¢æ˜¯æ— æ•°è·»èº«äº IT è¡Œä¸šå¼€å‘è€…çš„å¿ƒä¸­æœ€è´¨æœ´çš„æ„¿æœ›ï¼

å›æƒ³ç¬”è€…çš„å†ç¨‹ï¼Œåˆšä¸Šå¤§å­¦çš„æ—¶å€™å°±æ‘©æ‹³æ“¦æŒæƒ³è¦å®ç°ä¸€ä¸ªåšå®¢ç³»ç»Ÿï¼Œä½†åœ¨ Github ä¸Šåˆ›å»ºäº†ä»“åº“ä»¥åå°±å¼€å§‹äº†æ— é™æœŸçš„æ‹–å»¶ï¼šè‡ªå·±æ²¡æœ‰ä»»ä½•çš„å¼€å‘ç»éªŒï¼Œä¸çŸ¥é“æ¡†æ¶ä¹Ÿä¸çŸ¥é“ UI ç»„ä»¶åº“ï¼ŒåªçŸ¥é“è¦å†™ HTML + CSS + JavaScript ä»£ç ï¼Œé¢å¯¹çœ¼å‰æƒ³è¦å®ç°çš„å®Œæ•´ç³»ç»Ÿä¸çŸ¥è¯¥å¦‚ä½•ä¸‹æ‰‹ã€‚

ä»é›¶å¼€å§‹å®ç°åšå®¢ç³»ç»Ÿçš„è®¡åˆ’è™½ç„¶ææµ…ï¼Œä½†æ˜¯æ‹¥æœ‰ä¸€ä¸ªè‡ªå·±çš„åšå®¢çš„æ„¿æœ›æ²¡æœ‰æ”¹å˜ã€‚å¦‚æœè‡ªå·±è¿˜æ²¡æœ‰èƒ½åŠ›å»å¼€å‘ï¼Œé‚£æœ«è‡³å°‘åŸºäºç°æœ‰çš„åšå®¢å¹³å°å»æ­å»ºä¸€ä¸ªåšå®¢å§ï¼Œæ¯•ç«Ÿå¯¹äºåšå®¢æ¥è¯´ï¼Œæœ€é‡è¦çš„è¿˜æ˜¯å†…å®¹æœ¬èº«ã€‚ç»ˆäºåœ¨å¤§äºŒä¸Šå­¦æœŸçš„æ—¶å€™æ”¶é›†èµ„æ–™ï¼Œæ¨ªå‘å¯¹æ¯”ï¼Œè€ƒé‡ä¸åŒåšå®¢å¹³å°çš„ä¼˜åŠ¿ä¸çŸ­æ¿ï¼Œæœ€ç»ˆé€‰æ‹©äº†åŸºäº Hexo æ­å»ºè‡ªå·±çš„é™æ€åšå®¢ç³»ç»Ÿï¼Œèƒ½å¤Ÿéƒ¨ç½²åœ¨ Github Pages ä¸Šè€Œä¸éœ€è¦è‡ªå·±å»ç»´æŠ¤æœåŠ¡å™¨ã€‚è¿˜æ ¹æ®è‡ªå·±æ­å»ºçš„ç»éªŒï¼Œæ¨¡ä»¿åˆ«äººå†™äº†ä¸€ç¯‡æ­å»º Hexo åšå®¢çš„&lt;Link to=&quot;/posts/hello-hexo-world&quot;&gt;ç®€æ˜“æ•™ç¨‹&lt;/Link&gt;ï¼Œè¿™ç¯‡æ•™ç¨‹ä¹Ÿé¡ºç†æˆç« æˆä¸ºäº†è‡ªå·±çš„ç¬¬ä¸€ç¯‡æŠ€æœ¯åšå®¢ã€‚

Hexo ç”±ç›®å½•ç»“æ„é©±åŠ¨ï¼Œç®€å•å¥½ç”¨ï¼Œä½œä¸ºåšä¸»å¯ä»¥å…¨èº«å¿ƒæŠ•å…¥åˆ°åšå®¢çš„æ’°å†™ä¸­å»ã€‚Hexo çš„ç”Ÿæ€é‡Œå·²ç»æœ‰ç€éå¸¸å¤šçš„æƒ¹çœ¼ä¸”å®ç”¨çš„åšå®¢ä¸»é¢˜ï¼Œä¸‹è½½åˆ°åˆ°å¯¹åº”ç›®å½•ä¸‹å†ä¿®æ”¹å…¨å±€é…ç½®é¡¹å³å¯ä¸€é”®å¯ç”¨ã€‚ç¬”è€…åœ¨å¤§å­¦ç”Ÿæ¶¯ç›¸å½“æ…¢çƒ­ï¼Œç›´åˆ°è®¤ä¸ºè‡ªå·±åº”è¯¥å¼€å§‹åšæŸä»¶äº‹æƒ…æ—¶ï¼Œæ‰ä¸ç•™ä½™åŠ›åœ°å» push è‡ªå·±ï¼Œå¯è°“æ˜¯å……åˆ†äº«å—äº†é’æ˜¥ã€‚å› æ­¤åœ¨æ‹¥æœ‰äº†åšå®¢ç³»ç»Ÿä¹‹åï¼Œåè€Œå¤±å»äº†å¾ˆå¤šåŸåˆçš„åŠ¨åŠ›ï¼Œåˆå› ä¸ºè‡ªå·±å¹¶æ²¡æœ‰æ²‰æµ¸äºå¯¹æŠ€æœ¯çš„å­¦ä¹ ä¸­å»ï¼Œä¹Ÿå°±æ²¡æœ‰ä»€ä¹ˆå¥½å†™ä¸‹æ¥è®°æˆåšå®¢çš„ã€‚

ç›´åˆ°å¤§ä¸‰ä¸‹å­¦æœŸï¼Œç¬”è€…é€‰å®šäº†æˆä¸ºå‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆçš„é“è·¯ï¼Œåœ¨ä¼—å¤šé¢ç»ä¸­çœ‹åˆ°äº†åšå®¢çš„é‡è¦æ€§ï¼Œäºæ˜¯å¼€å§‹æ…¢æ…¢å†™èµ·æ¥ã€‚å°†å®ä¹ é‡åˆ°çš„å›°éš¾ï¼Œç«èµ›é¡¹ç›®é‡Œçš„å¼€å‘ç»éªŒï¼Œä»¥åŠè‡ªå­¦è¿‡ç¨‹ä¸­çš„æ”¶è·æ•´ç†ä¸ºä¸€ç¯‡ç¯‡åšå®¢ï¼Œä¸Šä¼ åˆ°è‡ªå·±çš„ä»“åº“é‡Œã€‚æœ›ç€ç»ˆäºèƒ½ç¿»é¡µçš„ä¸ªäººåšå®¢ï¼Œä¸€ç§çº¯ç²¹çš„æ»¡è¶³æ„Ÿæ²¹ç„¶è€Œç”Ÿã€‚

åæ¥åˆè§‰å¾—è‡ªå·±çš„å¤§å­¦ç”Ÿæ¶¯æœ‰äº›å¤ªå¹³æ·¡äº†ï¼Œäºæ˜¯ä¾¿æŒ‘æˆ˜å‘ Github åˆ«äººçš„é¡¹ç›®æäº¤ PRï¼Œå…¶ä¸­æçš„æœ€å¤šçš„ PR æ˜¯ç»™è‡ªå·±åœ¨ç”¨çš„åšå®¢ä¸»é¢˜ â€”â€” [hexo-theme-archer](https://github.com/fi3ework/hexo-theme-archer) çš„ï¼Œå¦å¤–è¿˜æˆåŠŸç”³è¯·æˆä¸ºäº†å®ƒçš„ç»´æŠ¤è€…ï¼Œè‡ªå‘åœ°å¸®å¿™å»è§£å†³å †ç§¯çš„ Issuesã€‚ç°åœ¨æƒ³æ¥é‚£æ—¶å€™çš„è‡ªå·±è¿˜éå¸¸çš„ç¨šå«©ï¼ŒIssues é‡Œæä»€ä¹ˆå°±åšä»€ä¹ˆï¼Œæ²¡æœ‰è®¤çœŸåˆ†æè¿‡å®ƒæ˜¯å¦çœŸçš„æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚ä¾‹å¦‚æœ‰ä¸ª Issue æåˆ°å¸Œæœ›æä¾›å›¾ç‰‡å·¦å³æµ®åŠ¨çš„åŠŸèƒ½ï¼Œè‡ªå·±å°±å†™äº†ä¸¤ä¸ªæ ·å¼ç±»å¡åˆ°ä¸»é¢˜é‡Œå¹¶è´´ä¸Šå¦‚ä½•ä½¿ç”¨ï¼Œä½†å®é™…ä¸Šè¿™æ ·çš„åŠŸèƒ½åªéœ€è¦åšä¸»åœ¨æ’°å†™åšå®¢çš„æ—¶å€™ä½¿ç”¨ `&lt;img&gt;` æ ‡ç­¾çš„å½¢å¼å†æ·»åŠ è¡Œå†…æ ·å¼å°±å¯ä»¥äº†ã€‚ä¸è¿‡å½“ç„¶ä¹Ÿæœ‰è‡ªè®¤ä¸ºåšå¾—ä¸é”™çš„å·¥ä½œï¼Œä¾‹å¦‚çœ‹åˆ°æœ‰äººæäº†ä¸€ä¸ª PR ä¸ºä¸»é¢˜æ·»åŠ äº†æš—è‰²æ¨¡å¼æ”¯æŒï¼Œä¸€ä¸‹å­æ¿€å‘èµ·äº†æˆ‘çš„å…´è¶£ï¼Œäºæ˜¯åœ¨è¿™ä¸ª PR çš„åŸºç¡€ä¸ŠèŠ±äº†å‡ å¤©çš„åŠŸå¤«å®ç°äº†å®Œå…¨çš„æš—è‰²æ¨¡å¼é€‚é…ï¼Œæƒ³å¿…ä¸ºå¤§å®¶çš„çœ¼ç›èµ·åˆ°äº†ä¸€äº›ä¿æŠ¤çš„ä½œç”¨ã€‚

æ—¶é—´æµè½¬ï¼Œéšç€å‰ç«¯å¼€å‘æˆä¸ºäº†è‡ªå·±çš„å·¥ä½œï¼Œç«™ç‚¹å¼€å‘å·²ç„¶æˆä¸ºçƒ¹å°é²œèˆ¬çš„äº‹æƒ…ï¼Œä¸å†ç¥ç§˜ã€‚æŸå¤©ç¬”è€…å¶ç„¶çœ‹åˆ°äº† [Thesis Theme Vision](https://thesis.priority.vision/)ï¼Œå¾ˆæœ‰ç¬”è®°è½¯ä»¶çš„æ„Ÿè§‰ï¼Œååˆ†ç¬¦åˆè‡ªå·±å¯¹åšå®¢ç³»ç»Ÿçš„å®¡ç¾å–œå¥½ï¼Œç»ˆäºè€ä¸ä½æƒ³è¦å»å¤åˆ»å®ç°çš„æ„¿æœ›ï¼Œäºæ˜¯åˆåˆ›å»ºäº†ä¸€ä¸ª Github ä»“åº“ã€‚è¿™ä¸€æ¬¡ï¼Œç¡®å®ä»é›¶å¼€å§‹äº†è‡ªå·±çš„åšå®¢ç³»ç»Ÿæ­å»ºå·¥ç¨‹ã€‚

## æŠ€æœ¯é€‰å‹

ç¬”è€…æœ€åˆè€ƒè™‘çš„æ˜¯ä¸º Hexo å¼€å‘ä¸€ä¸ªä¸»é¢˜ï¼Œä½†æ˜¯æˆ‘å®åœ¨å¾ˆéš¾æŠ•å…¥åˆ°å­¦ä¹ å…¶æ”¯æŒçš„ EJS æˆ– Pug è¿™äº›æ¨¡æ¿è¯­è¨€ä¸­å»ï¼Œæ€æ¥æƒ³å»è¿˜æ˜¯ç»§ç»­æŠ•èµ„åˆ°æˆ‘æ“…é•¿çš„ä¸”æ›´æœ‰æœªæ¥çš„ React ä¸­å»å§ï¼Œé‚å†³å®šå¦èµ·ç‚‰ç¶ã€‚

æ¥ä¸‹æ¥æ— è®ºæ˜¯é€‰æ‹© Next.js æˆ– Umi ä½œä¸ºå¼€å‘æ¡†æ¶éƒ½æ²¡æœ‰é—®é¢˜ï¼Œç”šè‡³ç›´æ¥åŸºäº React æ‰‹æ“ä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œä½†ç¬”è€…è¿˜æ˜¯å¯¹ Gatsby å’Œ Docusaurus è¿™ç±»æ‰€è°“çš„â€œé™æ€ç«™ç‚¹ç”Ÿæˆå™¨â€éå¸¸æ„Ÿå…´è¶£ã€‚è€ƒè™‘åˆ°ç¬”è€…è‡ªèº«å¯¹åšå®¢ç³»ç»Ÿé«˜å¯è‡ªå®šä¹‰æ€§çš„éœ€è¦ï¼Œæœ€ç»ˆé€‰æ‹©äº† Gatsby ä½œä¸ºæ¡†æ¶ã€‚æ ¸å¿ƒä½¿ç”¨åˆ°çš„åº“ç‰ˆæœ¬å¦‚ä¸‹ï¼š

- `gatsby@^5.0.0`
- `react@^18.0.0`

## è§£æå¹¶æ¸²æŸ“åšå®¢

### è§£æ `.mdx` æ–‡ä»¶ä¸ºåšå®¢

ä¸åŒäº Hexo çš„å°†æ–‡ä»¶å¡åˆ° `source/_posts/` ç›®å½•ä¸‹å³è¯†åˆ«ä¸ºä¸€ç¯‡åšå®¢ï¼ŒGatsby è¦æ±‚å¼€å‘è€…å®ç°â€œè§£ææ•°æ®æºåˆ°æ•°æ®å±‚â€å’Œâ€œç»„ä»¶ä»æ•°æ®å±‚æŸ¥è¯¢â€ä¸¤ä¸ªé˜¶æ®µçš„å·¥ä½œã€‚æ´å¼•å®˜æ–¹æ–‡æ¡£çš„æ•°æ®å±‚ä»‹ç»å›¾ç‰‡å¦‚ä¸‹ï¼š

![data layer](./build-my-gatsby-blog/data-layer.png)

è§£ææ•°æ®æºåˆ°æ•°æ®å±‚å¯ä»¥é€šè¿‡**æºæ’ä»¶**å®ç°ï¼Œå®˜æ–¹çº¦å®šæºæ’ä»¶ä»¥ `gatsby-source-` å¼€å¤´ã€‚ç¬”è€…ç°åœ¨æƒ³è¦å°†æœ¬åœ°çš„ `.mdx` æ–‡ä»¶è§£æåˆ°æ•°æ®å±‚ï¼Œå¯ä»¥é€šè¿‡æ’ä»¶ [`gatsby-source-filesystem`](https://www.gatsbyjs.com/plugins/gatsby-source-filesystem/) å®ç°ã€‚ç¼–è¾‘ `gatsby-config.ts`ï¼Œæ·»åŠ æ­¤æ’ä»¶å¹¶é…ç½®æ¬²è§£æçš„æœ¬åœ°ç›®å½•ï¼š

```ts
import type { GatsbyConfig } from &quot;gatsby&quot;;

const config: GatsbyConfig = {
  plugins: [
    {
      resolve: &quot;gatsby-source-filesystem&quot;, // å°½ç®¡å®˜æ–¹æ–‡æ¡£åœ¨ä½¿ç”¨å­—ç¬¦ä¸²æ—¶éƒ½ä½¿ç”¨çš„æ˜¯åå¼•å· `ï¼Œä½†ç¬”è€…æ›´ä¹ æƒ¯ä½¿ç”¨å•åŒå¼•å·
      options: {
        name: &quot;posts&quot;,
        path: &quot;path/to/posts/&quot;,
      },
      __key: &quot;posts&quot;,
    },
  ],
};

export default config;
```

ä¸Šé¢çš„é…ç½®é¡¹è¡¨ç¤ºæ’ä»¶å°†è‡ªåŠ¨è¯»å– `path/to/posts/` ç›®å½•ä¸‹çš„æ–‡ä»¶ä¿¡æ¯ã€‚

ä½†è¿™è¿˜ä¸å¤Ÿï¼Œæºæ’ä»¶ `gatsby-source-filesystem` ä»…å…è®¸æŸ¥è¯¢ä¸æ–‡ä»¶ç›¸å…³çš„å…ƒæ•°æ®ï¼Œä½†æ˜¯å´æ— æ³•è¯»å–æ–‡ä»¶åŒ…å«çš„å…·ä½“å†…å®¹ã€‚ä¸ºäº†è¯»å–åˆ°æ–‡ä»¶å†…å®¹ï¼Œå°±è¦ç”¨åˆ°**è½¬æ¢å™¨æ’ä»¶**ã€‚å¯¹äº `.mdx` æ ¼å¼çš„ File èŠ‚ç‚¹ï¼Œå¯ä»¥é€šè¿‡æ’ä»¶ [`gatsby-plugin-mdx`](https://www.gatsbyjs.com/plugins/gatsby-plugin-mdx/) è½¬æ¢ä¸º MDX èŠ‚ç‚¹ã€‚å®˜æ–¹æ–‡æ¡£é‡Œçš„è¿™å¼ å›¾èƒ½ç›´è§‚æè¿°è¿™ä¸ªè¿‡ç¨‹ï¼š

![data layer with nodes](./build-my-gatsby-blog/data-layer-with-nodes.png)

ç»§ç»­é…ç½® `gatsby-config.ts` å¦‚ä¸‹ï¼š

```ts
import remarkGfm from &quot;remark-gfm&quot;;

const config: GatsbyConfig = {
  plugins: [
    {
      resolve: &quot;gatsby-source-filesystem&quot;,
      // ...
    },
    {
      resolve: &quot;gatsby-plugin-mdx&quot;,
      options: {
        gatsbyRemarkPlugins: [
          // æ·»åŠ ä»£ç å—é«˜äº®
          &quot;gatsby-remark-prismjs&quot;,
        ],
        mdxOptions: {
          remarkPlugins: [
            // æ·»åŠ å¯¹ GitHub flavored markdown (GFM) æ ¼å¼çš„æ”¯æŒ
            remarkGfm,
          ],
        },
      },
    },
  ],
};
```

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œç”±äº MDX çš„è¯­æ³•ä¸ Markdown ä¸åŒï¼Œå®ƒé»˜è®¤ä»…æ”¯æŒ CommonMark æ ¼å¼ï¼Œè€ŒæŸäº›éæ ‡å‡†çš„ Markdown åŠŸèƒ½å¦‚è¡¨æ ¼ï¼Œéœ€è¦å•ç‹¬é…ç½®æ’ä»¶å¯ç”¨ã€‚åœ¨ä¸Šé¢çš„é…ç½®é¡¹é‡Œï¼Œç¬”è€…å°±å¼•å…¥äº† `remark-gfm` æ’ä»¶ï¼Œå®ƒä½¿å¾— `gatsby-plugin-mdx` èƒ½å¤Ÿè§£æ GFM æ ¼å¼çš„è¯­æ³•ã€‚ä½†æ˜¯ç”±äº[å…¼å®¹æ€§é—®é¢˜](https://github.com/gatsbyjs/gatsby/discussions/36406)ï¼Œç»æµ‹è¯•ï¼Œç›®å‰çš„ `gatsby-plugin-mdx@5.14.0` åªèƒ½æ­é…æ—§ç‰ˆæœ¬çš„ `remark-gfm@^1.0.0` ä½¿ç”¨ï¼Œä¸è¿‡ä¹Ÿè¶³å¤Ÿäº†ã€‚

å®˜æ–¹æ•™ç¨‹åœ¨åšå®¢çš„ Frontmatter ä¸­æ·»åŠ äº† `slug` å±æ€§æ¥æ–¹ä¾¿åç»­ç”Ÿæˆè·¯ç”±ï¼Œä½†ç¬”è€…æ›´å–œå¥½ Hexo é‚£ç§æ–‡ä»¶è·¯å¾„é©±åŠ¨è·¯ç”±ç”Ÿæˆçš„æ¨¡å¼ã€‚ä¸ºæ­¤ï¼Œå¯ä»¥åœ¨ `gatsby-node.ts` ä¸­å¯¼å‡º `onCreateNode()` æ–¹æ³•ï¼Œå¯¹äºæ¯ä¸€ä¸ª MDX èŠ‚ç‚¹ï¼Œæ ¹æ®æ–‡ä»¶è·¯å¾„ç”Ÿæˆ `slug` å±æ€§ï¼š

```ts
import { type CreateNodeArgs } from &quot;gatsby&quot;;

export const onCreateNode = ({ node, actions }: CreateNodeArgs) =&gt; {
  const { createNodeField } = actions;
  if (node.internal.type === &quot;Mdx&quot;) {
    createNodeField({
      node,
      name: &quot;slug&quot;,
      value: parseFilePathToPostSlug(String(node.internal.contentFilePath)),
    });
  }
};
```

å‡è®¾æ’°å†™äº†å¦‚ä¸‹çš„åšå®¢æ–‡ç« ï¼š

```md
---
title: ä»åŒæ­¥ QQ ç©ºé—´è¯´è¯´åˆ°å‰ç«¯å‘ˆç°ï¼Œæˆ‘éƒ½åšäº†äº›å•¥
date: 2024-10-17
updated: 2024-10-17
timeliness: false
categories:
  - å…¨æ ˆå¼€å‘
tags:
  - React
  - TypeScript
  - Node
  - ffmpeg
---

æœ€è¿‘åœ¨æ£è…¾æˆ‘çš„ Timeline æ—¶é—´çº¿é¡¹ç›®ï¼Œå¸Œæœ›å°†æˆ‘åœ¨ä¸åŒå¹³å°ä¸Šçš„å‘è¨€å’Œæ´»è·ƒè®°å½•åŒæ­¥è¿‡æ¥ï¼Œåœ¨ç‹¬ç«‹çš„ç«™ç‚¹ä¸ŠæŒ‰ç…§åˆ›å»ºæ—¶é—´å€’åºå‘ˆç°ã€‚

...
```

è®¿é—®æœ¬åœ°çš„ GraphQL IDE ç•Œé¢ï¼ŒæŸ¥è¯¢åˆ°çš„ MDX èŠ‚ç‚¹ç»“æœå¦‚ä¸‹ï¼š

![query mdx nodes](./build-my-gatsby-blog/query-mdx-nodes.png)

æˆªæ­¢ç›®å‰ï¼Œç¬”è€…å®Œæˆäº†â€œè§£ææ•°æ®æºåˆ°æ•°æ®å±‚â€è¿™ä¸€é˜¶æ®µçš„å·¥ä½œï¼Œæ¥ä¸‹æ¥å°±éœ€è¦åœ¨ç»„ä»¶è¯»å–è¿™äº› MDX èŠ‚ç‚¹æ•°æ®å¹¶å±•ç¤ºäº†ã€‚

### æ¸²æŸ“åšå®¢

Gatsby çš„ GraphQL æ•°æ®å±‚æ˜¯å®ƒåŒºåˆ«äºå…¶å®ƒå‰ç«¯æ¡†æ¶çš„é‡è¦ç‰¹æ€§ï¼Œå°½ç®¡æœ€ç»ˆæ„å»ºçš„äº§ç‰©ä»æ˜¯é™æ€çš„å‰ç«¯é¡µé¢ï¼Œä½†åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­å¼•å…¥äº†è¿™æ ·çš„ç±»ä¼¼æ•°æ®åº“çš„æ¦‚å¿µï¼Œä½“éªŒä»¿ä¼¼è‡ªå·±ä¸è‡ªå·±æ¡æ‰‹ï¼Œè‡ªå·±åŒè‡ªå·±è¿›è¡Œæ•°æ®ä¼ é€’ã€‚

å¦‚æœæƒ³åœ¨ React ç»„ä»¶é‡Œæ¶ˆè´¹æ•°æ®å±‚é‡Œå‡†å¤‡å¥½çš„æ•°æ®ï¼Œå°±éœ€è¦ç¼–å†™å¯¹åº”çš„ GraphQL æŸ¥è¯¢ä»£ç ï¼š

```ts
// src/hooks/useAllMdx.ts
import { graphql, useStaticQuery } from &quot;gatsby&quot;;

interface MdxNode {
  excerpt: string;
  fields: {
    slug: string;
  };
  frontmatter: {
    categories: string[];
    tags: string[];
    title: string;
    date: string;
    updated: string;
  };
}

export const useAllMdx = () =&gt; {
  const {
    allMdx: { nodes: posts },
  } = useStaticQuery&lt;{
    allMdx: { nodes: MdxNode[] };
  }&gt;(graphql`
    query {
      allMdx(sort: { frontmatter: { date: DESC } }) {
        nodes {
          excerpt
          fields {
            slug
          }
          frontmatter {
            categories
            tags
            title
            date
            updated
          }
        }
      }
    }
  `);

  return posts;
};

export default useAllMdx;
```

ä¸€ä¸ª React ç»„ä»¶é‡Œæœ€å¤šåªèƒ½æœ‰ `useStaticQuery()` æ–¹æ³•ï¼Œå¦‚æœæ‚¨æƒ³è¦æŸ¥è¯¢å¤šæ¡ä¸åŒæ•°æ®ï¼Œè¦ä¹ˆæŠŠæŸ¥è¯¢ä»£ç å†™åˆ°ä¸€èµ·ï¼Œè¦ä¹ˆå°±æ–°å»ºä¸€ä¸ªé’©å­æ–¹æ³•ï¼ˆæ¨èï¼‰ã€‚å¯¹äºå…¨å±€éƒ½ä¼šä½¿ç”¨åˆ°çš„æ•°æ®ï¼Œå¯ä»¥åˆ†é—¨åˆ«ç±»æ”¾åˆ°ä¸åŒçš„é’©å­æ–¹æ³•é‡Œï¼Œä¾‹å¦‚ç½‘ç«™çš„ Metadataï¼Œå°±å¯ä»¥æŠŠæŸ¥è¯¢ä»£ç æ”¾åœ¨ `src/hooks/useSiteMetadata.ts` é‡Œã€‚

ç°åœ¨ï¼Œç¬”è€…éœ€è¦æ ¹æ®åšå®¢çš„æ–‡ä»¶è·¯å¾„ï¼Œè‡ªåŠ¨ç”Ÿæˆè®¿é—®è·¯ç”±ï¼Œä¾‹å¦‚å¯¹äºåšå®¢æ–‡ä»¶ `path/to/this-is-a-blog.mdx`ï¼Œå¯ä»¥é€šè¿‡è·¯ç”± `/posts/this-is-a-blog` è®¿é—®åˆ°ï¼Œè¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿå®˜æ–¹æä¾›äº†å¤šç§æ–¹æ¡ˆï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©äº†æ›´ç¬¦åˆè‡ªå·±å–œå¥½çš„ï¼Œåœ¨ `gatsby-node.ts` æ–‡ä»¶é‡Œå¯¼å‡º `createPages()` æ–¹æ³•çš„æ–¹æ¡ˆï¼Œå®ƒèƒ½å¤Ÿä»¥ç¼–ç¨‹çš„æ–¹å¼è‡ªå®šä¹‰ç”Ÿæˆè·¯ç”±ï¼Œæ‹¥æœ‰ç›¸å½“å¤§çš„è‡ªç”±åº¦ï¼š

```ts
import { type CreatePagesArgs } from &quot;gatsby&quot;;
import path from &quot;path&quot;;

const postTemplate = path.resolve(&quot;./src/templates/post.tsx&quot;);

export const createPages = async function ({
  actions,
  graphql,
}: CreatePagesArgs) {
  const { data } = await graphql&lt;{
    allMdx: {
      nodes: MdxNode[];
    };
  }&gt;(`
    query {
      allMdx(
        sort: { frontmatter: { date: DESC } }
        filter: {
          internal: {
            contentFilePath: { regex: &quot;//blog/posts/|/blog/about-me.mdx/&quot; }
          }
        }
      ) {
        nodes {
          fields {
            slug
          }
          id
          internal {
            contentFilePath
          }
        }
      }
    }
  `);

  data?.allMdx.nodes.forEach((node) =&gt; {
    const slug = node.fields.slug;
    const path = slug === &quot;about-me&quot; ? &quot;/about-me&quot; : `/posts/${slug}`;

    actions.createPage({
      path,
      component: `${postTemplate}?__contentFilePath=${node.internal.contentFilePath}`,
      context: {
        id: node.id,
      },
    });
  });
};
```

ç¬”è€…å°±æ ¹æ®åšå®¢çš„è·¯å¾„ï¼Œå•ç‹¬é…ç½®äº†â€œå…³äºæˆ‘â€é¡µé¢çš„è·¯ç”±ã€‚æ­¤å¤–ï¼Œç¬”è€…è¯»å–äº† `src/templates/post.tsx` æ–‡ä»¶ä½œä¸ºç”Ÿæˆè·¯ç”±çš„é¡µé¢æ¨¡æ¿ï¼Œå¹¶æŒ‰ç…§ `gatsby-plugin-mdx` æ¨èçš„æ–¹å¼ï¼Œå°† MDX èŠ‚ç‚¹çš„æ–‡ä»¶è·¯å¾„ä½œä¸ºäº†æŸ¥è¯¢å‚æ•° `__contentFilePath` çš„å€¼ï¼Œè¿™æ ·æ¨¡æ¿æ–‡ä»¶çš„ `props.children` å°†è‡ªåŠ¨è¢«æ›¿æ¢ä¸º MDX èŠ‚ç‚¹åŒ…å«å†…å®¹çš„è§£æç»“æœã€‚å¦å¤–ï¼Œç¬”è€…å‘ç»„ä»¶ä¼ é€’äº† MDX èŠ‚ç‚¹ `id` ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œä¸ºæ¨¡æ¿æ–‡ä»¶æŸ¥è¯¢ MDX èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯æä¾›äº†å‚æ•°ã€‚

ä¸‹é¢ï¼Œç¼–å†™æ¨¡æ¿æ–‡ä»¶ `src/templates/post.tsx` å³å¯å®ç°åšå®¢é¡µé¢çš„å±•ç¤ºäº†ï¼š

```tsx
import { MDXProvider } from &quot;@mdx-js/react&quot;;
import { graphql, type PageProps } from &quot;gatsby&quot;;
import * as React from &quot;react&quot;;

type PostPageData = {
  mdx: Pick&lt;MdxNode, &quot;frontmatter&quot;&gt;;
};

type PostPageContext = Pick&lt;MdxNode, &quot;id&quot;&gt;;

const PostTemplate: React.FC&lt;PageProps&lt;PostPageData, PostPageContext&gt;&gt; = ({
  children,
  data,
}) =&gt; {
  const {
    mdx: {
      frontmatter: { title, date, updated, categories, tags },
    },
  } = data;

  return (
    &lt;div&gt;
      &lt;h1&gt;{title}&lt;/h1&gt;
      &lt;article&gt;
        &lt;MDXProvider&gt;{children}&lt;/MDXProvider&gt;
      &lt;/article&gt;
    &lt;/div&gt;
  );
};

export const query = graphql`
  query ($id: String!) {
    mdx(id: { eq: $id }) {
      frontmatter {
        categories
        tags
        title
        date
        updated
      }
    }
  }
`;

export default PostTemplate;
```

é€šè¿‡ä¸Šé¢å¯¼å‡ºçš„ `query` é™æ€æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ŒGatsby å°†æŸ¥è¯¢æ•°æ®å±‚é‡Œ `mdx.id === props.pageContext.id` çš„ MDX èŠ‚ç‚¹çš„æŒ‡å®šå±æ€§ï¼Œå¹¶æŠŠç»“æœä¼ é€’ç»™ React ç»„ä»¶çš„ `props.data`ã€‚

è¿™æ ·ï¼Œâ€œç»„ä»¶ä»æ•°æ®å±‚æŸ¥è¯¢â€è¿™ä¸€é˜¶æ®µçš„å·¥ä½œä¹Ÿå®Œæˆäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯æ…¢æ…¢ä¼˜åŒ–é¡µé¢é€»è¾‘å’Œå±•ç¤ºæ•ˆæœäº†ï¼

### æ·»åŠ è‡ªå®šä¹‰ç»„ä»¶

MDX æ ¼å¼çš„åšå®¢ç›¸æ¯” MD æ ¼å¼çš„æœ€å¤§ä¼˜åŠ¿åœ¨äºèƒ½å¤Ÿä½¿ç”¨è‡ªå®šä¹‰çš„ React ç»„ä»¶ï¼š

```tsx
import { type MDXProps } from &quot;mdx/types&quot;;

import Card from &quot;path/to/components/card&quot;;

const components: MDXProps[&quot;components&quot;] = {
  Card,
};

const PostTemplate = ({ children }) =&gt; {
  return (
    &lt;article&gt;
      &lt;MDXProvider components={components}&gt;{children}&lt;/MDXProvider&gt;
    &lt;/article&gt;
  );
};
```

ç°åœ¨ï¼Œåœ¨ç¼–å†™ MDX åšå®¢æ–‡ä»¶çš„æ—¶å€™ï¼Œå°±å¯ä»¥åƒä½¿ç”¨ JSX ä¸€æ ·ä½¿ç”¨ `&lt;Card&gt;` ç»„ä»¶äº†ï¼

![card](./build-my-gatsby-blog/card.png)

å¦å¤–ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰ç°æœ‰æ ‡ç­¾æ¸²æŸ“çš„ç»“æœã€‚ä¾‹å¦‚æƒ³è¦ä¸ºå›¾ç‰‡æ–‡ä»¶æ·»åŠ  FancyBox çš„æ”¯æŒï¼Œå¯ä»¥ç¼–å†™ä»£ç å¦‚ä¸‹ï¼š

```tsx
import { Fancybox } from &quot;@fancyapps/ui&quot;;

const FancyBoxImage = (props: { alt?: string; src?: string }) =&gt; {
  const {
    alt = &quot;The author is too lazy to give an alt&quot;,
    src,
    ...restProps
  } = props;
  return (
    &lt;a href={src} data-fancybox=&quot;gallery&quot; data-caption={alt}&gt;
      &lt;img src={src} alt={alt} {...restProps} /&gt;
    &lt;/a&gt;
  );
};

const components: MDXProps[&quot;components&quot;] = {
  img: FancyBoxImage,
};

const PostTemplate = ({ children }) =&gt; {
  const articleRef = React.useRef&lt;HTMLElement&gt;(null);

  React.useEffect(() =&gt; {
    Fancybox.bind(&quot;[data-fancybox]&quot;);
    return () =&gt; Fancybox.unbind(&quot;[data-fancybox]&quot;);
  }, []);

  return (
    &lt;article ref={articleRef}&gt;
      &lt;MDXProvider components={components}&gt;{children}&lt;/MDXProvider&gt;
    &lt;/article&gt;
  );
};
```

MDX æ¸²æŸ“å¾—åˆ°çš„ `&lt;img&gt;` ç»„ä»¶å°†è‡ªåŠ¨è¢«æ›¿æ¢ä¸º `&lt;FancyBoxImage&gt;` ç»„ä»¶ï¼Œéšåæ­£ç¡®åœ°è¢« FancyBox ç»‘å®šã€‚

### é™æ€èµ„æºçš„è®¿é—®ä¸ä¼˜åŒ–

æ’ä»¶ `gatsby-remark-images` å°†è‡ªåŠ¨å‹ç¼©åšå®¢ä¸­ä½¿ç”¨åˆ°çš„æœ¬åœ°å›¾ç‰‡çš„ä½“ç§¯ï¼Œå‡å°‘æµé‡å‹åŠ›ï¼›åŒæ—¶ç”Ÿæˆå ä½å›¾ç‰‡ï¼Œé¿å…åšå®¢é«˜åº¦çªç„¶å˜åŒ–ï¼Œæå‡é˜…è¯»ä½“éªŒã€‚åœ¨ Gatsby çš„æœ€ä½³å®è·µä¸­ï¼Œåº”å½“å§‹ç»ˆä½¿ç”¨ç±»ä¼¼ `gatsby-remark-images` è¿™æ ·çš„æ’ä»¶æ¥ä¼˜åŒ–å›¾ç‰‡ç±»å‹çš„é™æ€èµ„æºã€‚

ç»“åˆæ’ä»¶ `gatsby-plugin-mdx` ä½¿ç”¨ï¼Œå¯ä»¥é…ç½®å¦‚ä¸‹ï¼š

```ts
const config: GatsbyConfig = {
  plugins: [
    &quot;gatsby-plugin-sharp&quot;,
    {
      resolve: &quot;gatsby-plugin-mdx&quot;,
      options: {
        gatsbyRemarkPlugins: [
          {
            resolve: &quot;gatsby-remark-images&quot;,
            options: {
              maxWidth: 624,
            },
          },
          &quot;gatsby-remark-copy-linked-files&quot;,
        ],
      },
    },
  ],
};
```

å…¶ä¸­ï¼Œ`gatsby-plugin-sharp` æ˜¯æ’ä»¶ `gatsby-remark-images` çš„å¿…è¦ä¾èµ–ï¼Œéœ€è¦æ·»åŠ åˆ°æ’ä»¶åˆ—è¡¨ä¸­ã€‚

éœ€è¦ç•™æ„çš„æ˜¯ï¼Œæ’ä»¶ `gatsby-remark-images` ä»…æ”¯æŒå‹ç¼©ã€å¤„ç†éƒ¨åˆ†çš„å›¾ç‰‡æ ¼å¼å¦‚ `.jpeg`ã€‚å…¶å®ƒçš„æ ¼å¼å¦‚ `.gif` åˆ™éœ€è¦æ’ä»¶ `gatsby-remark-copy-linked-files` å¸®åŠ©ï¼ŒåŸå°ä¸åŠ¨åœ°ç§»åŠ¨åˆ°å¯¹åº”çš„ç›®å½•é‡Œã€‚ååŒä½¿ç”¨è¿™ä¸¤ä¸ªæ’ä»¶å³å¯è¾¾æˆæœ€å¥½çš„é™æ€èµ„æºè®¿é—®æ•ˆæœã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œç”±äº `gatsby-remark-images` ä¼šç›¸åº”åœ°å°è£… MDX æ¸²æŸ“ç»“æœé‡Œçš„ `&lt;img&gt;` æ ‡ç­¾ï¼Œä¸ºäº†å…¼å®¹ FancyBox èƒ½åŠ›ï¼Œå¯ä»¥æ›´æ–° `useEffect()` é’©å­æ–¹æ³•å¦‚ä¸‹ï¼š

```tsx
const PostTemplate = ({ children }) =&gt; {
  const articleRef = React.useRef&lt;HTMLElement&gt;(null);

  React.useEffect(() =&gt; {
    const optimizedImageLinks =
      articleRef.current?.querySelectorAll&lt;HTMLLinkElement&gt;(
        &quot;a.gatsby-resp-image-link&quot;,
      );
    optimizedImageLinks?.forEach((link) =&gt; {
      const image = link.children.item(1) as HTMLImageElement;
      link.setAttribute(&quot;data-fancybox&quot;, &quot;gallery&quot;);
      link.setAttribute(&quot;data-caption&quot;, image.alt);
    });

    Fancybox.bind(&quot;[data-fancybox]&quot;);
    return () =&gt; Fancybox.unbind(&quot;[data-fancybox]&quot;);
  }, []);

  return (
    &lt;article ref={articleRef}&gt;
      &lt;MDXProvider components={components}&gt;{children}&lt;/MDXProvider&gt;
    &lt;/article&gt;
  );
};
```

## åšå®¢æœç´¢

ç¬”è€…åŸºäº Algolia å®ç°åšå®¢æœç´¢çš„èƒ½åŠ›ï¼Œæ’ä»¶ [`gatsby-plugin-algolia`](https://www.gatsbyjs.com/plugins/gatsby-plugin-algolia/) èƒ½å¸®åŠ©é¡¹ç›®å¿«é€Ÿå®ç°ç´¢å¼•æ•°æ®å¹¶ä¸Šä¼ çš„åŠŸèƒ½ã€‚

åœ¨ Algolia æ§åˆ¶å°åˆ›å»ºç´¢å¼•å¹¶è·å–å¯†é’¥ç­‰çš„æ“ä½œä¸å†å†—è¿°ï¼Œå°†è¿™äº›å€¼å¡åˆ°ç¯å¢ƒå˜é‡é‡Œå³å¯è¢« Gatsby è®¿é—®ï¼š

```bash
# åŒ…å« GATSBY_ å‰ç¼€çš„ç¯å¢ƒå˜é‡å°†æš´éœ²åˆ°å®¢æˆ·ç«¯ç¯å¢ƒä¸­
# åç»­å°†ç”¨åˆ°ä¸‹é¢ä¸‰ä¸ªå˜é‡å®ç°å®¢æˆ·ç«¯æ£€ç´¢åŠŸèƒ½
GATSBY_ALGOLIA_APP_ID=YOUR_ALGOLIA_APP_ID
GATSBY_ALGOLIA_API_PUBLIC_KEY=YOUR_ALGOLIA_API_PUBLIC_KEY
GATSBY_ALGOLIA_INDEX_NAME=YOUR_ALGOLIA_INDEX_NAME
# ç”¨äºä¸Šä¼ æ•°æ®ç­‰çš„ Algolia ç®¡ç†ç§˜é’¥åˆ‡å‹¿æ·»åŠ  GATSBY_ å‰ç¼€
ALGOLIA_API_KEY=YOUR_ALGOLIA_API_PRIVATE_KEY
```

ä¸ºäº†ä¸Šä¼ ç”¨äºæ£€ç´¢çš„åšå®¢å…ƒæ•°æ®åˆ° Algoliaï¼Œå¯ä»¥åƒè¿™ä¹ˆé…ç½® `gatsby-config.ts`ï¼š

```ts
import dotenv from &quot;dotenv&quot;;

dotenv.config({
  path: [&quot;.env&quot;, `.env.${process.env.NODE_ENV}`],
});

const config: GatsbyConfig = {
  plugins: [
    {
      // ... å…¶å®ƒçš„æ’ä»¶
    },
    {
      // åº”å½“å°† gatsby-plugin-algolia æ’ä»¶æ”¾åˆ°åˆ—è¡¨çš„æœ€å
      // ç¡®ä¿ GraphQL æŸ¥è¯¢åˆ°çš„ç»“æœæ˜¯ç»è¿‡å…¶å®ƒæ’ä»¶å¤„ç†åçš„æœ€ç»ˆç»“æœ
      resolve: &quot;gatsby-plugin-algolia&quot;,
      options: {
        appId: process.env.GATSBY_ALGOLIA_APP_ID,
        apiKey: process.env.ALGOLIA_API_KEY,
        indexName: process.env.GATSBY_ALGOLIA_INDEX_NAME,
        queries: [
          {
            query: `
              query {
                allMdx(
                  filter: {
                    internal: {
                      contentFilePath: { regex: &quot;//blog/posts//&quot; }
                    }
                  }
                ) {
                  nodes {
                    excerpt(pruneLength: 200)
                    fields {
                      slug
                    }
                    frontmatter {
                      categories
                      tags
                      title
                      date
                      updated
                      timeliness
                    }
                    id
                    internal {
                      contentDigest
                    }
                  }
                }
              }`,
            transformer: ({
              data,
            }: {
              data: {
                allMdx: {
                  nodes: MdxNode[];
                };
              };
            }) =&gt; data.allMdx.nodes,
          },
        ],
      },
    },
  ],
};
```

æ’ä»¶ `gatsby-plugin-algolia` éœ€è¦ä¸€ä¸ªåŒ…å«åšå®¢å…ƒæ•°æ®çš„æ•°ç»„ä»¥æ‰§è¡Œä¸Šä¼ æ“ä½œï¼Œè€Œ GraphQL æŸ¥è¯¢çš„ç»“æœæ˜¯ä¸€ä¸ªå½¢å¦‚ `{ addMdx: { nodes: MdxNode[] }}` çš„å¯¹è±¡ï¼Œå› æ­¤è¦ä½¿ç”¨æ’ä»¶æä¾›çš„ `transformer()` æ–¹æ³•ï¼Œè¿”å›é‡Œé¢çš„ `nodes` æ•°ç»„ã€‚

ä¸ºäº†ç¡®ä¿åšå®¢åœ¨ç´¢å¼•é‡Œçš„å”¯ä¸€æ€§ï¼Œå¹¶ç¡®ä¿ç´¢å¼•é‡Œçš„æ•°æ®å§‹ç»ˆæœ€æ–°ï¼Œåœ¨ GraphQL æŸ¥è¯¢çš„æ—¶å€™å¿…é¡»æä¾› `id` å’Œ `internal.contentDigest`ã€‚

è¿™æ ·ï¼Œå½“æ‰§è¡Œæ„å»ºæ“ä½œæ—¶ï¼Œæ’ä»¶å°†è‡ªåŠ¨æŠŠæŸ¥è¯¢å¾—åˆ°çš„åšå®¢å…ƒæ•°æ®ä¸Šä¼ åˆ°æŒ‡å®šçš„ Algolia ç´¢å¼•ä¸­å»ã€‚ç™»å½• Algolia æ§åˆ¶å°ï¼Œå³å¯æŸ¥çœ‹ä¸Šä¼ çš„ç»“æœå•¦ï¼š

![algolia index item](./build-my-gatsby-blog/algolia-index-item.png)

å®¢æˆ·ç«¯æœç´¢åšå®¢çš„åŠŸèƒ½å¯ä»¥åŸºäº Algolia æä¾›çš„å‰ç«¯ç»„ä»¶å®ç°ï¼Œç¬”è€…å®ç°çš„ä¸€ä¸ªç®€å•çš„ä¾‹å­æ˜¯ï¼š

```tsx
import { liteClient as algoliasearch } from &quot;algoliasearch/lite&quot;;
import {
  Configure,
  Hits,
  InstantSearch,
  Pagination,
  SearchBox,
} from &quot;react-instantsearch&quot;;

import Post from &quot;path/to/post&quot;;

const searchClient = algoliasearch(
  String(process.env.GATSBY_ALGOLIA_APP_ID),
  String(process.env.GATSBY_ALGOLIA_API_PUBLIC_KEY),
);

const Hit = ({ hit }) =&gt; {
  return &lt;Post post={hit} /&gt;;
};

const AlgoliaSearch = () =&gt; {
  return (
    &lt;InstantSearch
      insights
      searchClient={searchClient}
      indexName={process.env.GATSBY_ALGOLIA_INDEX_NAME}
    &gt;
      &lt;Configure hitsPerPage={10} /&gt;
      &lt;SearchBox /&gt;
      &lt;Hits&lt;AlgoliaPostItem&gt; hitComponent={Hit} /&gt;
      &lt;Pagination /&gt;
    &lt;/InstantSearch&gt;
  );
};

export default AlgoliaSearch;
```

è¿™æ ·ï¼Œå®¢æˆ·ç«¯çš„åšå®¢æœç´¢èƒ½åŠ›å°±å®ç°äº†ï¼š

![algolia search item](./build-my-gatsby-blog/algolia-search-item.png)

æ›´å¤šçš„åŠŸèƒ½ä¾‹å¦‚è‡ªåŠ¨ç”Ÿæˆ RSS è®¢é˜…ä¹Ÿå¯ä»¥å‚è€ƒä¸Šé¢çš„å¤„ç†æ–¹æ¡ˆï¼Œæœç´¢åˆé€‚çš„æ’ä»¶é…ç½®å®ç°ã€‚

## è·¯ç”±åˆ‡æ¢ä½“éªŒä¼˜åŒ–

æœ‰çš„æ—¶å€™åˆ‡æ¢è·¯ç”±å¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ—¶é—´å¤„ç†ï¼Œç”¨æˆ·çœ‹ä¸åˆ°é¡µé¢åˆ‡æ¢çš„ç»“æœå¯èƒ½ä¼šéå¸¸ç„¦è™‘ã€‚ä¸ºäº†ç¼“è§£è¿™ç§ç„¦è™‘ï¼Œåœ¨åº“ `nprogress` çš„å¸®åŠ©ä¸‹ï¼Œç¬”è€…æ·»åŠ äº†å¯è§†åŒ–çš„è¿›åº¦æ¡ã€‚

è¿™ä¸€åˆ‡éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨ `gatsby-browser.ts` æ–‡ä»¶å¯¼å‡ºä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸé’©å­æ–¹æ³•å³å¯ï¼š

```ts
import nProgress from &quot;nprogress&quot;;

export const onRouteUpdateDelayed = () =&gt; {
  nProgress.start();
};

export const onRouteUpdate = () =&gt; {
  nProgress.done();
};
```

ä¸Šé¢çš„ä»£ç è¡¨ç¤ºï¼Œå½“è·¯ç”±åˆ‡æ¢è€—æ—¶å¤§äº 1 ç§’æ—¶ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡ã€‚å½“è·¯ç”±åˆ‡æ¢å®Œæˆæ—¶ï¼Œéšè—è¿›åº¦æ¡ã€‚

å½“ç„¶ï¼Œåˆ«å¿˜äº†å¼•å…¥ `nprogress` çš„æ ·å¼æ–‡ä»¶ï¼Œå¦‚æœå¸Œæœ›ï¼Œè¿˜å¯ä»¥ä¿®æ”¹ä¸€ä¸‹è¿›åº¦æ¡çš„é¢œè‰²ã€‚

## æŒç»­éƒ¨ç½²

ç¬”è€…åŸºäº Github Workflow å®ç°é¡¹ç›®çš„æŒç»­é›†æˆä¸æŒç»­éƒ¨ç½²ï¼Œå¯ä»¥ç¼–å†™å·¥ä½œæµæ–‡ä»¶ `.github/workflows/deployment.yml` å¦‚ä¸‹ï¼š

```yml
name: Blog System CI &amp; CD

on:
  push:
    branches:
      - main

jobs:
  pages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: &quot;yarn&quot;

      - name: Cache Yarn dependencies
        uses: actions/cache@v4
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles(&apos;**/yarn.lock&apos;) }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build Gatsby
        run: yarn build

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }} # ç¬”è€…å°†äº§ç‰©æ¨é€åˆ°äº†å¤–éƒ¨ä»“åº“ï¼Œå› æ­¤è¿™é‡Œä½¿ç”¨åˆ°äº† Github ç§äººå¯†é’¥
          publish_dir: ./public
          external_repository: LolipopJ/LolipopJ.github.io
          publish_branch: main
```
</content:original-text><content:updated-at>2025-03-17T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[ä»åŒæ­¥ QQ ç©ºé—´è¯´è¯´åˆ°å‰ç«¯å‘ˆç°ï¼Œæˆ‘éƒ½åšäº†äº›å•¥]]></title><description><![CDATA[æœ€è¿‘åœ¨æ£è…¾æˆ‘çš„ Timeline æ—¶é—´çº¿é¡¹ç›®ï¼Œå¸Œæœ›å°†æˆ‘åœ¨ä¸åŒå¹³å°ä¸Šçš„å‘è¨€å’Œæ´»è·ƒè®°å½•åŒæ­¥è¿‡æ¥ï¼Œåœ¨ç‹¬ç«‹çš„ç«™ç‚¹ä¸ŠæŒ‰ç…§åˆ›å»ºæ—¶é—´å€’åºå‘ˆç°ã€‚ è¿‡å»ï¼Œæˆ‘å°è¯•æŠŠè¿™ä¸ªæƒ³æ³•æ”¾åˆ° Telegram ä¸Šå®ç°ï¼ŒæŠŠå‘è¨€å’Œè®°å½•åŒæ­¥åˆ°æˆ‘çš„é¢‘é“ä¸Šã€‚ä½†æ˜¯æ ¼å¼è½¬æ¢çš„ç¹æ‚ä»¥åŠè‡ªç”±åº¦ä¸Šçš„é™åˆ¶è®©æˆ‘å¤§è´¹å‘¨ç« ï¼ŒåŠ ä¹‹å¢é‡å¼€è®¾çš„åŒæ­¥å†…å®¹ä¼šä»¥æ¶ˆæ¯çš„æ–¹å¼ä¸€æ¡ä¸€æ¡æ·»åŠ åˆ°æœ«å°¾ï¼Œæ— æ³•æŒ‰æ—¶é—´æ’åºï¼Œæœ€ç»ˆæˆ‘æ”¾å¼ƒäº†è¿™ä¸ªæ–¹æ¡ˆã€‚

è¨€å½’æ­£ä¼ ï¼Œåœ¨é¡¹ç›®å¼€å‘çš„è¿‡ç¨‹ä¸­â€¦]]></description><link>https://blog.towind.fun/posts/sync-qzone-talks</link><guid isPermaLink="false">sync-qzone-talks</guid><category><![CDATA[å…¨æ ˆå¼€å‘]]></category><pubDate>Thu, 17 Oct 2024 00:00:00 GMT</pubDate><content:original-text>
æœ€è¿‘åœ¨æ£è…¾æˆ‘çš„ Timeline æ—¶é—´çº¿é¡¹ç›®ï¼Œå¸Œæœ›å°†æˆ‘åœ¨ä¸åŒå¹³å°ä¸Šçš„å‘è¨€å’Œæ´»è·ƒè®°å½•åŒæ­¥è¿‡æ¥ï¼Œåœ¨ç‹¬ç«‹çš„ç«™ç‚¹ä¸ŠæŒ‰ç…§åˆ›å»ºæ—¶é—´å€’åºå‘ˆç°ã€‚

è¿‡å»ï¼Œæˆ‘å°è¯•æŠŠè¿™ä¸ªæƒ³æ³•æ”¾åˆ° Telegram ä¸Šå®ç°ï¼ŒæŠŠå‘è¨€å’Œè®°å½•åŒæ­¥åˆ°æˆ‘çš„é¢‘é“ä¸Šã€‚ä½†æ˜¯æ ¼å¼è½¬æ¢çš„ç¹æ‚ä»¥åŠè‡ªç”±åº¦ä¸Šçš„é™åˆ¶è®©æˆ‘å¤§è´¹å‘¨ç« ï¼ŒåŠ ä¹‹å¢é‡å¼€è®¾çš„åŒæ­¥å†…å®¹ä¼šä»¥æ¶ˆæ¯çš„æ–¹å¼ä¸€æ¡ä¸€æ¡æ·»åŠ åˆ°æœ«å°¾ï¼Œæ— æ³•æŒ‰æ—¶é—´æ’åºï¼Œæœ€ç»ˆæˆ‘æ”¾å¼ƒäº†è¿™ä¸ªæ–¹æ¡ˆã€‚

è¨€å½’æ­£ä¼ ï¼Œåœ¨é¡¹ç›®å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘é‡åˆ°çš„ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„åœºæ™¯å³ QQ ç©ºé—´è¯´è¯´çš„åŒæ­¥ã€‚æœ¬æ–‡äº‹æ— å·¨ç»†åœ°è®°å½•ä¸‹æˆ‘åœ¨å¤„ç† QQ ç©ºé—´è¯´è¯´åŒæ­¥çš„è¿‡ç¨‹ä¸­ï¼Œåšäº†å“ªäº›å·¥ä½œï¼Œå¸Œæœ›ä¸ºæœ‰ç›¸åº”éœ€æ±‚çš„åšç±³ä»¬å¸¦æ¥ä¸€äº›çµæ„Ÿã€‚

## åŒæ­¥ QQ ç©ºé—´è¯´è¯´

### åŒæ­¥æ–¹æ¡ˆçš„æ¢ç´¢ä¸ç¡®å®š

éå¸¸è‡ªç„¶è€Œç„¶çš„ï¼Œç¬”è€…è®¾æƒ³ä½¿ç”¨ Puppeteer æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œï¼Œæ‰“å¼€ QQ ç©ºé—´ç½‘é¡µç«¯ï¼Œè¾“å…¥è´¦å·å’Œå¯†ç ï¼Œè¿›å…¥åˆ°ä¸ªäººä¸»é¡µï¼Œæ ¹æ® DOM ç»“æ„çˆ¬å–å¾—åˆ°è¯´è¯´çš„ä¿¡æ¯ã€‚åŒæ ·éå¸¸è‡ªç„¶è€Œç„¶çš„ï¼Œåœ¨åˆ‡æ¢ç™»å½•æ¨¡å¼ï¼ˆä»äºŒç»´ç ç™»å½•åˆ°è´¦å·å¯†ç ç™»å½•ï¼‰æ­¥éª¤å°±å¡ç€äº†ï¼Œæ¨¡æ‹Ÿç‚¹å‡»åˆ‡æ¢ç™»å½•æ¨¡å¼æŒ‰é’®æ— æ•ˆã€‚ç¬”è€…å¹¶éçˆ¬è™«ä¸“å®¶ï¼Œæ²¡æœ‰æ­¤ç±»é—®é¢˜çš„å¯¹æŠ—ç»éªŒï¼Œåœ¨æœç´¢æ— æœåæ— å¥ˆæ”¾å¼ƒã€‚å†æƒ³åˆ°åç»­å¯èƒ½è¿˜è¦å¤„ç†ç™»å½•å®‰å…¨éªŒè¯ï¼Œæˆ–å¤„ç†åˆ«çš„é˜²çˆ¬æ‰‹æ®µï¼Œåˆ¤æ–­ Puppeteer çš„æ–¹æ¡ˆå…¶å®å¹¶ä¸åˆé€‚ QQ ç©ºé—´è¯´è¯´çš„åŒæ­¥ã€‚

äºæ˜¯æƒ³åˆ°æ¥å£çš„æ–¹æ¡ˆï¼Œæ¨¡æ‹Ÿç™»å½•è¯·æ±‚ï¼Œå¹¶æŠŠè¿”å›çš„ Cookies å¡ç»™è·å–è¯´è¯´ä¿¡æ¯çš„è¯·æ±‚ã€‚æŸ¥çœ‹ç½‘ç»œè¯·æ±‚å¯çŸ¥ï¼ŒH5 ç«¯çš„ QQ ç©ºé—´ä½¿ç”¨ `https://h5.qzone.qq.com/webapp/json/mqzone_feeds/getActiveFeeds` æ¥å£æ‹‰å–è¯´è¯´ä¿¡æ¯ï¼Œç„¶è€ŒåŒæ—¶ä¹Ÿå‘ç°è¯·æ±‚è·¯å¾„é‡ŒåŒ…å«äº†ä¸¤ä¸ªä¸å­˜åœ¨äº Cookies çš„å‚æ•°ï¼š`qzonetoken` å’Œ `g_tk`ï¼Œå®ƒæ˜¯é€šè¿‡æŸç§ç‰¹æ®Šç®—æ³•åœ¨å‰ç«¯ç”Ÿæˆçš„ï¼

æ—¢ç„¶æ˜¯å‰ç«¯ç”Ÿæˆçš„ï¼Œé‚£ä¹ˆç®—æ³•ä¸€å®šæœ‰è¿¹å¯å¾ªï¼Œæ±‚åŠ©äºæœç´¢å¼•æ“æœç„¶æ‰¾åˆ°äº† `g_tk` çš„ç”Ÿæˆç®—æ³•ã€‚

åœ¨æœç´¢çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜å‘ç°å¤§å®¶ä¸€èˆ¬é€šè¿‡ `https://user.qzone.qq.com/proxy/domain/taotao.qq.com/cgi-bin/emotion_cgi_msglist_v6` æ¥å£æ‹‰å–è¯´è¯´è¯´ä¿¡æ¯ï¼›å¦å¤–åœ¨ Github ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªé«˜æ˜Ÿæ ‡çš„ Python å®ç° [GetQzonehistory](https://github.com/LibraHp/GetQzonehistory)ï¼Œå¯ä»¥åŸºäºå®ƒæ”¹å·´æ”¹å·´å®ç° Node.js ç‰ˆæœ¬ã€‚

è‡³æ­¤ï¼ŒåŒæ­¥æ–¹æ¡ˆå¾—åˆ°äº†ç¡®å®šï¼ˆæ¯•ç«Ÿå®ç°å¥½çš„ GetQzonehistory ç ç‰åœ¨å‰ï¼‰ï¼Œæˆ‘ä»¬å°†é€šè¿‡æ¥å£çš„æ–¹å¼æ‹‰å–è¯´è¯´ä¿¡æ¯ã€‚

### ç™»å½•æ–¹æ¡ˆçš„ç¡®å®šä¸å®ç°

ç°åœ¨å¼€å§‹å®ç° QQ ç©ºé—´ç™»å½•çš„åŠŸèƒ½ï¼Œç¿»çœ‹ GetQzonehistory æºç ï¼Œå‘ç°å…¶é‡‡ç”¨äº†æ‰«ç ç™»å½•çš„å®ç°æ–¹å¼ï¼Œè¿™åº”å½“æ˜¯æœ‰æ‰€è€ƒé‡çš„ï¼Œå¯ä»¥ç»•è¿‡ç™»å½•å®‰å…¨éªŒè¯ç­‰æ£˜æ‰‹çš„é—®é¢˜ï¼Œå½“ç„¶ä¹Ÿå­˜åœ¨æ— æ³•è‡ªåŠ¨åŒ–åŒæ­¥ä»»åŠ¡çš„é—®é¢˜ã€‚

è€ƒè™‘åˆ°å‘ç©ºé—´è¯´è¯´å¹¶ä¸æ˜¯ä¸€ä¸ªé«˜é¢‘è¡Œä¸ºï¼Œåœ¨æƒ³è¦åŒæ­¥æ—¶æ‰‹åŠ¨æ‰«ç æ˜¯å¯æ¥å—çš„ï¼Œé‚æ²¿ç”¨äº†**æ‰«ç ç™»å½•**çš„å®ç°ã€‚æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·ç«¯ï¼šè®¿é—®è·å–ç™»å½•äºŒç»´ç é¡µé¢ã€‚
2. æœåŠ¡ç«¯ï¼šè¯·æ±‚ `https://ssl.ptlogin2.qq.com/ptqrshow` æ¥å£è·å–ç™»å½•äºŒç»´ç ï¼Œä»å“åº”çš„ Cookies é‡Œè·å– `qrsig`ã€‚å°†ç™»å½•äºŒç»´ç è¿”å›ç»™ç”¨æˆ·ã€‚
3. æœåŠ¡ç«¯ï¼šè½®è¯¢è¯·æ±‚ `https://ssl.ptlogin2.qq.com/ptqrlogin` å¾—åˆ°æ‰«ç ç»“æœï¼Œè¯·æ±‚çš„è·¯å¾„å‚æ•° `ptqrtoken` åŸºäºä¸Šä¸€æ­¥å¾—åˆ°çš„ `qrsig` ç”Ÿæˆï¼Œç”Ÿæˆç®—æ³•å¦‚ä¸‹ï¼š

   ```ts
   const getPtqrToken = (qrSig: string) =&gt; {
     let ptqrToken = 0;

     for (let i = 0; i &lt; qrSig.length; i += 1) {
       ptqrToken += (ptqrToken &lt;&lt; 5) + qrSig.charCodeAt(i);
     }

     return 2147483647 &amp; ptqrToken;
   };
   ```

4. ç”¨æˆ·ç«¯ï¼šä½¿ç”¨æ‰‹æœºæ‰«ç å¹¶ç¡®è®¤ç™»å½•ã€‚
5. æœåŠ¡ç«¯ï¼šè½®è¯¢å“åº”åŒ…å« `ç™»å½•æˆåŠŸ` å­—æ®µï¼Œè·å–å“åº”ä½“é‡Œ `ptsigx` å’Œå“åº” Cookies é‡Œé”® `uin` çš„å€¼ã€‚
6. æœåŠ¡ç«¯ï¼šå°†ä¸Šä¸€æ­¥å¾—åˆ°çš„ `ptsigx` å’Œ `uin` ä½œä¸ºè¯·æ±‚ `https://ptlogin2.qzone.qq.com/check_sig` çš„è·¯å¾„å‚æ•°ã€‚è¯·æ±‚æˆåŠŸï¼Œå“åº”ä¸º 302 çŠ¶æ€ç ï¼Œå°†å“åº”çš„ Cookies ä¿å­˜åˆ°æœ¬åœ°ï¼Œæ­¤å³ä¸ºæ‰€éœ€çš„ç”¨æˆ·ç™»å½•æ€ Cookiesã€‚

### åŒæ­¥æ–¹æ¡ˆçš„å®ç°

ç™»å½•æ€ Cookies å·²è§£å†³ï¼ŒåŒæ­¥çš„å…·ä½“å®ç°ä¹Ÿå°±è½»è€Œæ˜“ä¸¾äº†ã€‚æµç¨‹å¦‚ä¸‹ï¼š

1. è¯»å–ä¿å­˜åœ¨æœ¬åœ°çš„ç”¨æˆ·ç™»å½•æ€ Cookiesï¼Œè·å– `p_skey` é”®å¯¹åº”çš„å€¼ï¼ŒåŸºäºå®ƒç”Ÿæˆ `g_tk`ï¼Œç”Ÿæˆç®—æ³•å¦‚ä¸‹ï¼š

   ```ts
   const getGTk = (pSkey: string) =&gt; {
     let gTk = 5381;

     for (let i = 0; i &lt; pSkey.length; i += 1) {
       gTk += (gTk &lt;&lt; 5) + pSkey.charCodeAt(i);
     }

     return gTk &amp; 2147483647;
   };
   ```

2. è¯·æ±‚ `https://user.qzone.qq.com/proxy/domain/taotao.qq.com/cgi-bin/emotion_cgi_msglist_v6` æ¥å£ï¼Œå°† `g_tk` ä½œä¸ºè·¯å¾„å‚æ•°ã€‚æ­¤å¤–ç”± `pos` æŒ‡å®šæŸ¥è¯¢åç§»é‡ï¼Œ`num` æŒ‡å®šæŸ¥è¯¢æ¡æ•°ã€‚
3. ä»å“åº”é‡Œæå–è¯´è¯´çš„å…·ä½“ä¿¡æ¯ï¼Œé€šè¿‡ `JSON.parse()` æ–¹æ³•è½¬æ¢ä¸º JSON æ ¼å¼åšè¿›ä¸€æ­¥å¤„ç†ã€‚å…¶æ ¼å¼å®šä¹‰ç®€ç•¥è¡¨ç¤ºå¦‚ä¸‹ï¼š

   ```ts
   interface QZoneInfo {
     code: number;
     logininfo: {
       /** ç”¨æˆ·å */
       name: string;
       /** QQ å· */
       uin: number;
     };
     /** è¯´è¯´åˆ—è¡¨ */
     msglist: QZoneTalk[];
     /** è¯´è¯´æ€»æ•° */
     total: number;
   }

   interface QZoneTalk {
     /** è¯„è®ºåˆ—è¡¨ */
     commentlist?: QZoneTalkComment[];
     /** è¯´è¯´å†…å®¹ */
     content: string;
     /** åˆ›å»ºæ—¶é—´(s) */
     created_time: number;
     /** ä¸Šæ¬¡ä¿®æ”¹æ—¶é—´(s)ã€‚é»˜è®¤å€¼ä¸º 0 */
     lastmodify: number;
     /** å®šä½ä¿¡æ¯ */
     lbs: {
       name: string;
       pos_x: string;
       pos_y: string;
     };
     name: string;
     /** è¯´è¯´å›¾ç‰‡é™„ä»¶ï¼ˆä»…æœ‰å›¾ç‰‡æˆ–åŒæ—¶åŒ…å«å›¾ç‰‡å’Œè§†é¢‘æ—¶ï¼Œä½¿ç”¨è¯¥å­—æ®µï¼‰ */
     pic?: QZoneTalkPic[];
     /** æ˜¯å¦ç§å¯† */
     secret: 0 | 1;
     /** è¯´è¯´ ID */
     tid: string;
     uin: number;
     /** è¯´è¯´è§†é¢‘é™„ä»¶ï¼ˆä»…æœ‰è§†é¢‘æ—¶ï¼Œä½¿ç”¨è¯¥å­—æ®µï¼‰ */
     video?: QZoneTalkVideo[];
   }
   ```

4. æ ¹æ®è‡ªèº«éœ€è¦å¤„ç†å¾—åˆ°çš„è¯´è¯´ç»“æœï¼Œå®ŒæˆåŒæ­¥çš„éœ€æ±‚ã€‚

## è¯´è¯´è§†é¢‘æ’­æ”¾ä¼˜åŒ–

ç¬”è€…å¿ƒæ»¡æ„è¶³åœ°æµè§ˆç€å‘ˆç°åœ¨æ—¶é—´çº¿é¡¹ç›®é‡Œçš„ QQ ç©ºé—´è¯´è¯´ï¼Œå…´è¶£ç›ç„¶åœ°ç‚¹å‡»äº†ä¸€ä¸ªä»¥å‰ä¸Šä¼ çš„è§†é¢‘ï¼Œè§†é¢‘å´åœ¨ç¬”è€…ç„¦è™‘åœ°ç­‰å¾…åå¤šç§’åæ‰å¼€å§‹æ’­æ”¾ã€‚è¿™ä¸‹å­ç¬”è€…çŸ¥é“åˆæœ‰æ–°çš„é—®é¢˜è¦è§£å†³äº† â€”â€” æ€ä¹ˆå®ç°è§†é¢‘çš„è¾¹ä¸‹è½½è¾¹æ’­æ”¾ï¼Ÿ

æ±‚åŠ©äºæœç´¢å¼•æ“ï¼Œå¾—çŸ¥ `.mp4` æ ¼å¼çš„è§†é¢‘æ–‡ä»¶æœ¬æ¥æ˜¯å¯ä»¥è¾¹ä¸‹è½½è¾¹æ’­æ”¾çš„ã€‚å¦‚æœä¸èƒ½è¾¹ä¸‹è½½è¾¹æ’­æ”¾ï¼Œåˆ™è¯´æ˜æè¿°å®ƒçš„**è§†é¢‘æ ¼å¼ä¿¡æ¯å…ƒæ•°æ®**è¢«æ”¾ç½®åˆ°äº†è§†é¢‘æ–‡ä»¶çš„ä¸­é—´æˆ–æœ«å°¾ã€‚ä¸€ä¸ªç®€å•ä¸”å¸¸ç”¨çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä½¿ç”¨ [`qt-faststart`](https://github.com/danielgtaylor/qtfaststart) å·¥å…·ï¼Œå°†è¿™äº›å…ƒæ•°æ®ç§»åŠ¨åˆ°è§†é¢‘æ–‡ä»¶çš„å¤´éƒ¨ã€‚

ç¬”è€…åœ¨å¯¼å‡ºè¯´è¯´åï¼Œå‘ç°åŒæ—¶åŒ…å«æœ‰ `.mp4` å’Œ `.m3u8` ä¸¤ç§æ ¼å¼çš„æ–‡ä»¶ã€‚å…¶ä¸­ `.m3u8` æ˜¯æ’­æ”¾åˆ—è¡¨æ–‡ä»¶ï¼Œè¿˜éœ€è¦æŠŠé‡Œé¢åŒ…å«çš„è§†é¢‘ç‰‡æ®µæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°ï¼Œä¸ç„¶æ— æ³•æ­£å¸¸æ’­æ”¾ã€‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µä¾›å›å‚è€ƒï¼š

```ts
if (videoFilename.endsWith(&quot;.m3u8&quot;)) {
  const videoSliceFilenameMatches = String(responseData).matchAll(
    new RegExp(`^${videoFilename.split(&quot;.&quot;)[0]}.+$`, &quot;gm&quot;),
  );
  const videoBaseUrl = path.dirname(videoUrl);

  Array.from(videoSliceFilenameMatches).forEach((videoSliceFilenameMatch) =&gt; {
    const sliceFilename = videoSliceFilenameMatch[0];
    const sliceDownloadUrl = `${videoBaseUrl}/${sliceFilename}`;
    const sliceSavePath = path.resolve(
      videoSaveDir,
      sliceFilename.split(&quot;?&quot;)[0],
    );

    axios
      .get(sliceDownloadUrl, {
        responseType: &quot;arraybuffer&quot;,
        maxContentLength: Infinity, // é¿å…æ–‡ä»¶è¿‡å¤§å¼‚å¸¸è·³å‡ºï¼›åœ¨ä¸‹è½½åŸå§‹è§†é¢‘æ—¶ä¹Ÿåº”å½“é…ç½®æ­¤é¡¹
        maxBodyLength: Infinity, // åŒä¸Š
      })
      .then((getSliceResponse) =&gt; {
        fs.writeFileSync(sliceSavePath, getSliceResponse.data);
      });
  });
}
```

&gt; ä¸ä¼ ç»Ÿçš„è§†é¢‘æ ¼å¼ä¸åŒï¼ŒM3U8 è§†é¢‘æ ¼å¼å°†æ•´ä¸ªè§†é¢‘åˆ†æˆ**å¤šä¸ªå°ç‰‡æ®µ**è¿›è¡Œä¼ è¾“ï¼Œè¿™äº›å°ç‰‡æ®µå¯ä»¥æ ¹æ®ç½‘ç»œæƒ…å†µè‡ªåŠ¨è°ƒèŠ‚å…¶è´¨é‡å’Œå¤§å°ã€‚è¿™ç§æ–¹å¼ä½¿å¾— M3U8 è§†é¢‘æ ¼å¼éå¸¸é€‚åˆåœ¨ç½‘ç»œç¯å¢ƒä¸ç¨³å®šæˆ–å¸¦å®½ä¸è¶³çš„æƒ…å†µä¸‹æ’­æ”¾è§†é¢‘ã€‚

ç»è¿‡å¤æ‚ä¸”æŠ˜è…¾çš„æ€æƒ³æ–—äº‰åï¼Œç¬”è€…å†³å®šä½¿ç”¨ [`ffmpeg`](https://ffmpeg.org) å·¥å…·ï¼Œå°†æ‰€æœ‰ `.mp4` æ ¼å¼çš„è§†é¢‘æ–‡ä»¶è½¬æ¢ä¸º `.m3u8` æ ¼å¼ï¼Œå®Œæˆæ ¼å¼ä¸Šçš„ç»Ÿä¸€ä¸è¾¹ä¸‹è½½è¾¹æ’­æ”¾çš„éœ€æ±‚ã€‚

### æœåŠ¡ç«¯è½¬æ¢è§†é¢‘æ–‡ä»¶ä¸º `.m3u8` æ ¼å¼

æœåŠ¡ç«¯å®‰è£…ä½¿ç”¨ `ffmpeg` æ‰€éœ€çš„ä¾èµ–ï¼š

```bash
yarn add fluent-ffmpeg ffmpeg-static
```

å…¶ä¸­ `ffmpeg-static` åœ¨å®‰è£…æ—¶ä¼šè‡ªåŠ¨ä¸‹è½½ä¸€ä¸ªç¼–è¯‘å¥½çš„ `ffmpeg` äºŒè¿›åˆ¶æ–‡ä»¶åˆ°æœ¬åœ°ï¼Œä¾› `fluent-ffmpeg` ä½¿ç”¨ï¼š

```ts
import pathToFfmpeg from &quot;ffmpeg-static&quot;;
import Ffmpeg from &quot;fluent-ffmpeg&quot;;

Ffmpeg.setFfmpegPath(pathToFfmpeg);
```

å°† `.mp4` æ–‡ä»¶è½¬æ¢ä¸º `.m3u8` æ ¼å¼ï¼Œå¯ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š

```ts
const convertVideoToM3u8 = (videoFilePath: string, outputFilePath: string) =&gt; {
  Ffmpeg(videoFilePath)
    .outputFormat(&quot;hls&quot;)
    .outputOptions([&quot;-hls_list_size 0&quot;, &quot;-hls_allow_cache 1&quot;])
    .output(outputFilePath)
    .run();
};
```

å…¶ä¸­ `outputOptions()` çš„å®Œæ•´å‚æ•°åˆ—è¡¨å®šä¹‰å¯ä»¥[åœ¨è¿™é‡Œ](https://ffmpeg.org/ffmpeg-formats.html#hls-2)æ‰¾åˆ°ã€‚`-hls_list_size` é…ç½®ä¿ç•™çš„è§†é¢‘ç‰‡æ®µæ•°é‡ï¼Œæ­¤å¤„çš„è§†é¢‘æ ¼å¼è½¬æ¢å¹¶éç›´æ’­åœºæ™¯ï¼Œå› æ­¤éœ€è¦è®¾ä¸º `0`ï¼›`-hls_allow_cache` å³æ˜¯å¦å…è®¸å®¢æˆ·ç«¯ç¼“è§†é¢‘ç‰‡æ®µï¼Œè®¾ä¸ºå…è®¸ï¼›å¦å¤– `-hls_time` å¯ä»¥é…ç½®æ¯ä¸ªè§†é¢‘ç‰‡æ®µçš„é•¿åº¦ï¼Œé»˜è®¤å€¼ä¸º `2`ï¼ˆç§’ï¼‰ï¼Œæ­¤å¤„ä¿æŒé»˜è®¤ã€‚

è½¬æ¢åçš„ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![m3u8-results](./sync-qzone-talks/m3u8-results.png)

ç‰¹åˆ«çš„ï¼Œå¦‚æœæœºå™¨çš„è¿è¡Œå†…å­˜ä¸è¶³å¤Ÿæ‰¹é‡å¤„ç†å¤šä¸ªè§†é¢‘æ–‡ä»¶ï¼Œå»ºè®®å°è£…ä¸€ä¸ªä¸²è¡Œæ‰§è¡Œ Promise ä»»åŠ¡çš„æ–¹æ³•ï¼ˆæœ€è¿‘ä¸€æ¬¡é¢è¯•é‡åˆ°çš„é¢˜ç›®ï¼Œå±…ç„¶å³åˆ»åœ¨è‡ªå·±çš„é¡¹ç›®é‡Œç”¨ä¸ŠğŸ‘ğŸ¼ï¼‰ï¼Œä¾æ¬¡æ‰§è¡Œè½¬æ¢ä»»åŠ¡ï¼Œé¿å…å†…å­˜æº¢å‡ºå¯¼è‡´çš„ç¨‹åºå¼‚å¸¸è·³å‡ºã€‚å¯å‚è€ƒç¬”è€…çš„å®ç°ï¼š

```ts
const createPromiseQueue = () =&gt; {
  const queue: (() =&gt; Promise&lt;void&gt;)[] = [];
  let isProcessing = false;

  const processQueue = async () =&gt; {
    if (isProcessing) return;
    isProcessing = true;

    while (queue.length &gt; 0) {
      const task = queue.shift();
      try {
        await task?.(); // æ‰§è¡Œä»»åŠ¡
      } catch (error) {
        console.error(&quot;Queue task failed:&quot;, error);
      }
    }

    isProcessing = false; // å¤„ç†å®Œæˆ
  };

  return (promiseFunction: () =&gt; Promise&lt;void&gt;) =&gt; {
    queue.push(promiseFunction);
    processQueue();
  };
};

const addToConvertQueue = createPromiseQueue();

const convertVideoToM3u8 = (videoFilePath: string, outputFilePath: string) =&gt; {
  addToConvertQueue(
    () =&gt;
      new Promise((resolve, reject) =&gt; {
        Ffmpeg(videoFilePath)
          .outputFormat(&quot;hls&quot;)
          .outputOptions([&quot;-hls_list_size 0&quot;, &quot;-hls_allow_cache 1&quot;])
          .output(outputFilePath)
          .on(&quot;end&quot;, () =&gt; {
            resolve();
          })
          .on(&quot;error&quot;, (error) =&gt; {
            reject(error);
          })
          .run();
      }),
  );
};
```

### å®¢æˆ·ç«¯æ’­æ”¾ `.m3u8` æ ¼å¼è§†é¢‘æ”¯æŒ

æµè§ˆå™¨è‡ªå¸¦çš„ `&lt;video&gt;` æ ‡ç­¾å¹¶ä¸åŸç”Ÿæ”¯æŒæ’­æ”¾ `.m3u8` æ ¼å¼çš„è§†é¢‘ï¼Œè¿™é‡Œç¬”è€…å¼•å…¥äº† [`video.js`](https://videojs.com/) åº“å®ç°æ’­æ”¾åŠŸèƒ½ã€‚åŸºäºå®˜æ–¹æä¾›çš„[ç»„ä»¶å®ç°](https://videojs.com/guides/react/)ï¼Œæ”¹å·´æ”¹å·´å®ç°ä¸ºè‡ªå·±çš„ï¼š

```tsx
import { useEffect, useRef } from &quot;react&quot;;
import videojs from &quot;video.js&quot;;
import Player from &quot;video.js/dist/types/player&quot;;

export interface VideoPlayerProps {
  id: string;
  options: {
    sources: { src: string; type?: string }[];
    controls?: boolean;
    poster?: string;
    preload?: &quot;auto&quot; | &quot;metadata&quot; | &quot;none&quot;;
    [key: string]: unknown;
  };
  className?: string;
  onReady?: (player: Player) =&gt; void;
}

/** https://videojs.com/guides/react/ */
export const VideoPlayer = (props: VideoPlayerProps) =&gt; {
  const { id, options, className = &quot;&quot;, onReady } = props;

  const videoRef = useRef&lt;HTMLDivElement&gt;(null);
  const playerRef = useRef&lt;Player&gt;(null);

  useEffect(() =&gt; {
    if (!videoRef.current) return;

    if (!playerRef.current) {
      const videoElement = document.createElement(&quot;video-js&quot;);

      videoElement.classList.add(&quot;vjs-default-skin&quot;, &quot;vjs-big-play-centered&quot;);
      videoElement.dataset.setup = &apos;{&quot;fluid&quot;: true}&apos;;
      videoRef.current.appendChild(videoElement);

      // @ts-expect-error: playerRef is writable
      const player = (playerRef.current = videojs(videoElement, options, () =&gt; {
        videojs.log(`Video player for ${id} is ready.`);
        onReady?.(player);
      }));
    }
  }, [id, onReady, options, videoRef]);

  // Dispose the Video.js player when the functional component unmounts
  useEffect(() =&gt; {
    const player = playerRef.current;

    return () =&gt; {
      if (player &amp;&amp; !player.isDisposed()) {
        player.dispose();
        // @ts-expect-error: playerRef is writable
        playerRef.current = null;
        videojs.log(`Video player for ${id} is disposed.`);
      }
    };
  }, [id, playerRef]);

  // ç¦»å¼€è§†é‡åè‡ªåŠ¨æš‚åœæ’­æ”¾
  useEffect(() =&gt; {
    const video = videoRef.current;
    const player = playerRef.current;

    if (video &amp;&amp; player) {
      const pauseObserver = new IntersectionObserver(([entry]) =&gt; {
        if (!entry.isIntersecting) {
          player.pause();
        }
      });
      pauseObserver.observe(video);
      return () =&gt; {
        pauseObserver.unobserve(video);
      };
    }
  }, [videoRef, playerRef]);

  return &lt;div data-vjs-player ref={videoRef} className={className} /&gt;;
};

export default VideoPlayer;
```

ä¸€åˆ‡å°±ç»ªï¼Œå†æ¬¡ç‚¹å‡»è§†é¢‘ï¼Œç¼“å†²æ¡å¦‚é¢„æœŸèˆ¬ä¸€èŠ‚èŠ‚åŠ è½½ï¼Œå®ç°äº†è§†é¢‘çš„è¾¹ä¸‹è½½è¾¹æ’­æ”¾ï¼Œå¯å–œå¯è´ºå¯å–œå¯è´ºï¼

### å®¢æˆ·ç«¯æ„å»ºä½“ç§¯ï¼ˆé¦–å±é€Ÿåº¦ï¼‰ä¼˜åŒ–

å¦‚æœæ‚¨å·²ç»å…·å¤‡äº†ä¸€å®šçš„å‰ç«¯å¼€å‘ç»éªŒï¼Œå°±ä¼šå¯¹æ‰“åŒ…è¿›é¡¹ç›®çš„ä¸‰æ–¹åº“éå¸¸æ•æ„Ÿï¼šæ‰“åŒ…æœªç»ï¼ˆæˆ–æ— æ³•ï¼‰æŒ‰éœ€å¼•å…¥ä¼˜åŒ–çš„ä¸‰æ–¹åº“ï¼Œæ„å‘³ç€å°†ä¸‰æ–¹åº“çš„å…¨éƒ¨ä»£ç å¡åˆ°é¡¹ç›®ä¸­ï¼Œå°†å¯¼è‡´é¡¹ç›®çš„æ„å»ºåä½“ç§¯å¤§å¹…å¢é•¿ã€‚åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œç¬”è€…ä¸ºäº†å…¼å®¹ `.m3u8` æ ¼å¼è§†é¢‘çš„æ’­æ”¾ï¼Œå¼•å…¥äº†å¹¿æ³›ç”¨äºè§†é¢‘ç½‘ç«™çš„ `video.js` åº“ï¼Œæ„å»ºæ’­æ”¾è¯´è¯´è§†é¢‘çš„ç»„ä»¶ã€‚è€Œå®ƒå°±æ˜¯æ— æ³•æŒ‰éœ€å¼•å…¥çš„ä¸‰æ–¹åº“ï¼Œæ‰“åŒ…åçš„ä»£ç ä½“ç§¯å› è€Œå¤§å¹…å¢é•¿ï¼š

```plaintext
Route (app)                              Size     First Load JS
â”Œ â—‹ /                                    217 kB          338 kB
â”” â—‹ /_not-found                          873 B          88.1 kB
+ First Load JS shared by all            87.3 kB
  â”œ chunks/364-54e0b660da1a9f95.js       31.7 kB
  â”œ chunks/618f8807-5ab9f851e4f8eeba.js  53.6 kB
  â”” other shared chunks (total)          1.96 kB
```

å¹¶éæ¯ä¸€ä¸ªç«™é•¿éƒ½ä¼šé…ç½®åŒ…å«è§†é¢‘çš„æ—¶é—´çº¿æºï¼ˆä¾‹å¦‚æœ¬æ–‡çš„ QQ ç©ºé—´ï¼‰ï¼Œé¦–å±åŠ è½½çš„æ—¶é—´çº¿å†…å®¹ä¹Ÿå¹¶éä¸€å®šåŒ…å«è§†é¢‘å†…å®¹ï¼Œå¦‚æœä¸€è‚¡è„‘åœ°å°† `video.js` æ‰“åŒ…åœ¨é¦–å± JS ä»£ç å†…ï¼ŒåŠ¿å¿…æ— æ³•å¸¦æ¥æœ€å¥½çš„è®¿é—®ä½“éªŒã€‚

å¹¸è¿çš„æ˜¯ï¼Œ`next.js` å·²ç»å†…ç½®äº†åŠ¨æ€å¼•å…¥ç»„ä»¶çš„æ–¹æ³• `dynamic()`ï¼Œå¦‚æœè¦åŠ¨æ€å¼•å…¥ä½¿ç”¨åˆ° `video.js` åº“çš„ `&lt;VideoPlayer&gt;` ç»„ä»¶ï¼Œåªéœ€è¦ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š

```tsx
import dynamic from &quot;next/dynamic&quot;;
const VideoPlayer = dynamic(() =&gt; import(&quot;@/components/VideoPlayer&quot;));
```

å¦‚æ˜¯ä¼˜åŒ–åï¼Œé¦–å±åŠ è½½çš„ JS ä½“ç§¯è‡ª `338 kB` é™è‡³ `142 kB`ã€‚ç­‰åˆ°ç”¨æˆ·é‡åˆ°åŒ…å«è§†é¢‘çš„æ—¶é—´çº¿å†…å®¹æ—¶ï¼Œæ‰ä¼šåŠ è½½ä¸è§†é¢‘æ’­æ”¾ç›¸å…³çš„ JS èµ„æºï¼Œå®ç°äº†å¯¹è®¿é—®ä½“éªŒçš„ä¼˜åŒ–ã€‚

```plaintext
Route (app)                              Size     First Load JS
â”Œ â—‹ /                                    20.4 kB         142 kB
â”” â—‹ /_not-found                          873 B          88.2 kB
+ First Load JS shared by all            87.4 kB
  â”œ chunks/364-54e0b660da1a9f95.js       31.7 kB
  â”œ chunks/618f8807-5ab9f851e4f8eeba.js  53.6 kB
  â”” other shared chunks (total)          2.06 kB
```
</content:original-text><content:updated-at>2024-10-17T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[çº¯å‰ç«¯å¦‚ä½•å®ç°ä¸€ä¸ªè½¬ç›˜æŠ½å¥–ç»„ä»¶]]></title><description><![CDATA[ä¸ºä»€ä¹ˆ å‰é˜µå­é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°è¿™ä¸ªé—®é¢˜ï¼Œè§‰å¾—æŒºæœ‰æ„æ€ï¼Œäºæ˜¯å†³å®šäº²æ‰‹å®ç°ä¸€ä¸ªè½¬ç›˜æŠ½å¥–ç»„ä»¶è¯•è¯•ã€‚

ç¿»çœ‹åˆ«äººçš„å®ç°æ–¹æ¡ˆæ—¶ï¼Œå‘ç°å’Œè‡ªå·±é¢è¯•æ—¶ç­”å¾—ç›¸å·®å¾ˆå¤§ï¼Œæ‚² ğŸ˜¢ã€‚ä½†æ€»ä¹‹ï¼Œæ˜¯æ—¶å€™å¼€å§‹å¼¥è¡¥è‡ªå·±çš„ CSS å’ŒåŠ¨ç”»æŠ€èƒ½äº†ã€‚

æ˜¯ä»€ä¹ˆ

ä¸€ä¸ªè½¬ç›˜æŠ½å¥–ç»„ä»¶ä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œå†™æœ‰ä¸­å¥–ç»“æœçš„åœ†å½¢è½¬ç›˜ã€æŒ‡å‘ç»“æœçš„æŒ‡é’ˆå’Œå¼€å§‹è½¬åŠ¨çš„æŒ‰é’®ã€‚

å¦‚æœæ¯ä¸ªä¸­å¥–ç»“æœçš„æ¦‚ç‡ç›¸è¿‘ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§çœŸå®æ¦‚ç‡æ¥åˆ’åˆ†æ¯ä¸ªå¥–å“æ‰€å åœ†å½¢çš„æ‰‡å½¢æ¯”ä¾‹â€¦]]></description><link>https://blog.towind.fun/posts/lucky-draw</link><guid isPermaLink="false">lucky-draw</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Fri, 06 Sep 2024 00:00:00 GMT</pubDate><content:original-text>
## ä¸ºä»€ä¹ˆ

å‰é˜µå­é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°è¿™ä¸ªé—®é¢˜ï¼Œè§‰å¾—æŒºæœ‰æ„æ€ï¼Œäºæ˜¯å†³å®šäº²æ‰‹å®ç°ä¸€ä¸ªè½¬ç›˜æŠ½å¥–ç»„ä»¶è¯•è¯•ã€‚

ç¿»çœ‹åˆ«äººçš„å®ç°æ–¹æ¡ˆæ—¶ï¼Œå‘ç°å’Œè‡ªå·±é¢è¯•æ—¶ç­”å¾—ç›¸å·®å¾ˆå¤§ï¼Œæ‚² ğŸ˜¢ã€‚ä½†æ€»ä¹‹ï¼Œæ˜¯æ—¶å€™å¼€å§‹å¼¥è¡¥è‡ªå·±çš„ CSS å’ŒåŠ¨ç”»æŠ€èƒ½äº†ã€‚

## æ˜¯ä»€ä¹ˆ

ä¸€ä¸ªè½¬ç›˜æŠ½å¥–ç»„ä»¶ä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œå†™æœ‰ä¸­å¥–ç»“æœçš„åœ†å½¢è½¬ç›˜ã€æŒ‡å‘ç»“æœçš„æŒ‡é’ˆå’Œå¼€å§‹è½¬åŠ¨çš„æŒ‰é’®ã€‚

å¦‚æœæ¯ä¸ªä¸­å¥–ç»“æœçš„æ¦‚ç‡ç›¸è¿‘ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§çœŸå®æ¦‚ç‡æ¥åˆ’åˆ†æ¯ä¸ªå¥–å“æ‰€å åœ†å½¢çš„æ‰‡å½¢æ¯”ä¾‹ã€‚ä½†æ˜¯é€šå¸¸è½¬ç›˜ä¸­ä¼šè®¾ç½®æŠ½ä¸­æ¦‚ç‡æå°çš„å¤§å¥–ï¼ŒæŒ‰ç…§çœŸå®æ¯”ä¾‹çš„è¯å°†æ— æ³•å……åˆ†å±•ç¤ºå¥–å“å†…å®¹ï¼Œè€Œä¸”é™ä½ç”¨æˆ·å¯¹è½¬ç›˜æŠ½å¥–æœ¬èº«çš„å…´è¶£åº¦ã€‚æ‰€ä»¥æœ¬æ–‡å®ç°çš„è½¬ç›˜ç»„ä»¶é€‰æ‹© **å‡åˆ†çš„æ–¹å¼** æ¥åˆ’åˆ†æ¯ä¸ªå¥–å“æ‰€å çš„æ‰‡å½¢æ¯”ä¾‹ï¼Œç¬¦åˆé€šç”¨çš„åŸåˆ™ï¼Œä¹Ÿä»è§†è§‰ä¸Šè®©ç”¨æˆ·è§‰å¾—ä¸­å¥–æ¦‚ç‡ç›¸å½“ã€‚

è½¬ç›˜è½¬åŠ¨å¯ä»¥æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯æŒ‡é’ˆä¸åŠ¨è½¬ç›˜åŠ¨ï¼Œä¸€ç§æ˜¯è½¬ç›˜ä¸åŠ¨æŒ‡é’ˆåŠ¨ï¼Œéƒ½èƒ½å¾ˆå¥½åœ°è¡¨è¾¾è½¬ç›˜æŠ½å¥–çš„è¿‡ç¨‹ã€‚å¯¹æ¯”ä¸¤ç§æ–¹å¼ï¼Œå‰è€…çš„è§†è§‰ä½“éªŒä¼šæ›´ä½³ï¼Œä¸”æŒ‡é’ˆå¯ä»¥æ”¾ç½®åœ¨ä»»æ„ä½ç½®ï¼ˆåœ¨ä¸­é—´å¾€ä¸ŠæŒ‡æˆ–åœ¨å·¦ä¾§å¾€å³æŒ‡ç­‰ç­‰éƒ½å¯ä»¥ï¼‰ï¼›åè€…åˆ™ç›¸å¯¹å«è“„ä¸€äº›ï¼Œç”¨æˆ·çš„è§†è§‰è´Ÿæ‹…è¾ƒä½ï¼Œä½†æŒ‡é’ˆåªèƒ½æ”¾åœ¨ä¸­é—´æ—‹è½¬ï¼ˆæˆ‘è®¾æƒ³äº†ä¸€ä¸‹åœ¨è½¬ç›˜å¤–ä¾§åšåœ†å‘¨è¿åŠ¨ï¼Œæ„Ÿè§‰ä¹Ÿæœ‰ç‚¹æ„æ€ï¼‰ã€‚å› æ­¤ï¼Œæœ¬æ–‡çš„å®ç°é€‰æ‹© **æŒ‡é’ˆä¸åŠ¨è½¬ç›˜åŠ¨** çš„æ–¹å¼ï¼Œä»å‰ç«¯å¼€å‘çš„è§’åº¦æ¥è¯´ï¼Œå®ç°äº†ä¸€ç§æ–¹å¼ï¼Œå¦ä¸€ç§æ–¹å¼ä¹Ÿå¯ä»¥ç®€å•å®ç°äº†ã€‚

å½“æˆ‘ä»¬ç‚¹å‡»å¼€å§‹è½¬åŠ¨çš„æŒ‰é’®æ—¶ï¼Œè½¬ç›˜ä¾¿ä¼šå¼€å§‹è½¬åŠ¨ã€‚ç°å®ç”Ÿæ´»ä¸­çš„è½¬ç›˜é€šå¸¸ç”±äººæ‰‹åŠ›é©±åŠ¨ï¼Œè½¬ç›˜çš„ **è½¬é€Ÿä¼šä»é›¶è¿…é€ŸåŠ åˆ°æœ€å¤§ï¼Œç„¶åé€æ¸å˜å°ç›´è‡³ä¸ºé›¶**ã€‚æˆ‘ä»¬å®ç°çš„è½¬ç›˜ä¸å—è¿™äº›ç‰©ç†æ¡ä»¶çš„é™åˆ¶ï¼Œä½†å¯¹ç°å®çš„å……åˆ†æ¨¡æ‹Ÿå¯ä»¥æå‡è½¬ç›˜æŠ½å¥–çš„å¯ä¿¡åº¦ï¼Œæœ¬æ–‡ä¹Ÿå°†æœç€è¿™ä¸ªæ–¹å‘å®ç°ã€‚

å½“ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œå‰ç«¯å³å‘åç«¯è¯·æ±‚äº†æŠ½å¥–çš„ç»“æœï¼Œåç»­è½¬ç›˜çš„è½¬åŠ¨ä¹Ÿä¸è¿‡æ˜¯é¢„è®¾å¥½çš„åŠ¨ç”»ç½¢äº†ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°è®¡ç®—å¾—åˆ°è½¬ç›˜åº”å½“æ—‹è½¬çš„è§’åº¦ï¼Œè®©æŒ‡é’ˆæ°æ°å¥½åœç•™åœ¨å¥–å“æ‰€åœ¨çš„æ‰‡å½¢åŒºåŸŸã€‚è¿™ä¹Ÿæ„å‘³ç€ **è½¬ç›˜æ—‹è½¬çš„è§’åº¦å¯ä»¥æ˜¯ä¸€ä¸ªèŒƒå›´**ï¼ŒæŒ‡é’ˆå¹¶ä¸ä¸€å®šæŒ‡å‘æ‰‡å½¢åŒºåŸŸçš„æ­£ä¸­é—´ï¼Œè¿™ä¹Ÿæ˜¯å¯¹ç°å®å®é™…çš„ä¸€ä¸ªæ¨¡æ‹Ÿã€‚

## æ€ä¹ˆåš

åœ¨æ·±å…¥åŠ¨ç”»å®ç°ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆå®Œæˆ ~~ç®€å•çš„~~ å‰ç½®å·¥ä½œï¼ŒæŠŠè½¬ç›˜æŠ½å¥–ç»„ä»¶çš„ä¸‰ä¸ªå¿…è¦ç»„æˆéƒ¨åˆ†ç”»å‡ºæ¥ã€‚

é¦–å…ˆæ˜¯åœ†å½¢è½¬ç›˜ï¼š

```html
&lt;div class=&quot;container&quot;&gt;
  &lt;div id=&quot;turntable&quot; class=&quot;turntable&quot;&gt;&lt;/div&gt;
&lt;/div&gt;
```

```scss
.container {
  width: 500px;
  padding: 40px;
  background: #f8fafc;
  display: flex;
  justify-content: center;
}

.turntable {
  position: relative;
  width: 400px;
  height: 400px;
  border-radius: 50%;
}
```

```ts
interface Prize {
  label: string;
  probability: number;
  bgColor: string;
}

const prizes: Prize[] = [
  { label: &quot;è¶…çº§å¤§å¥–&quot;, probability: 0.001, bgColor: &quot;#b91c1c&quot; },
  { label: &quot;ç‰¹ç­‰å¥–&quot;, probability: 0.009, bgColor: &quot;#c2410c&quot; },
  { label: &quot;ä¸€ç­‰å¥–&quot;, probability: 0.01, bgColor: &quot;#7e22ce&quot; },
  { label: &quot;äºŒç­‰å¥–&quot;, probability: 0.03, bgColor: &quot;#2563eb&quot; },
  { label: &quot;ä¸‰ç­‰å¥–&quot;, probability: 0.15, bgColor: &quot;#15803d&quot; },
  { label: &quot;å®‰æ…°å¥–&quot;, probability: 0.3, bgColor: &quot;#1e293b&quot; },
  { label: &quot;è°¢è°¢å‚ä¸&quot;, probability: 0.5, bgColor: &quot;#3f3f46&quot; },
];

const turntableDom = document.getElementById(&quot;turntable&quot;);
const proportionPerPrize = Number((100 / prizes.length).toFixed(1));

// #region åˆ’åˆ†è½¬ç›˜æ‰‡å½¢åŒºåŸŸ
const turntableConicGradient = prizes.map((prize, index) =&gt; {
  const from = (proportionPerPrize * index).toFixed(1);
  const to =
    index === prizes.length - 1
      ? 100
      : (proportionPerPrize * (index + 1)).toFixed(1);
  return `${prize.bgColor} ${from}% ${to}%`;
});
turntableDom.style.background = `conic-gradient(${turntableConicGradient.join(
  &quot;,&quot;,
)})`;
// #endregion
```

åˆ©ç”¨ CSS å‡½æ•° `conic-gradient()` åˆ›å»ºé¢œè‰²æ¸å˜ï¼Œå·§å¦™åœ°å®ç°è½¬ç›˜æ‰‡å½¢åŒºåŸŸçš„å‡åˆ†ã€‚å¾—åˆ°çš„è½¬ç›˜å¦‚ä¸‹æ‰€ç¤ºï¼š

![turntable-base](./lucky-draw/turntable-base.png)

æ¥ç€ä¸ºæ¯ä¸ªæ‰‡å½¢åŒºåŸŸæ·»åŠ å…·ä½“çš„å¥–å“åç§°ï¼š

```scss
.prize-label {
  position: absolute;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: baseline;
  font-weight: bold;
  color: white;
  // #region è°ƒæ•´å¥–å“åçš„ä½ç½®
  line-height: 100px;
  // #endregion
}
```

```ts
const anglePerPrize = Number((360 / prizes.length).toFixed(1));

// #region æ·»åŠ å¥–å“åèŠ‚ç‚¹
const prizeLabels = document.createDocumentFragment();
prizes.map((prize, index) =&gt; {
  const prizeLabel = document.createElement(&quot;div&quot;);
  prizeLabel.classList.add(&quot;prize-label&quot;);
  prizeLabel.style.transform = `rotate(${
    -anglePerPrize / 2 + anglePerPrize * (index + 1)
  }deg)`;
  prizeLabel.innerText = prize.label;
  prizeLabels.appendChild(prizeLabel);
});
turntableDom.append(prizeLabels);
// #endregion

// #region è®¾ç½®è½¬ç›˜åˆå§‹è§’åº¦
const turntableBaseRotate = -anglePerPrize / 2;
turntableDom.style.transform = `rotate(${turntableBaseRotate}deg)`;
// #endregion
```

æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºäº†åŒ…å«å¥–å“åçš„æ ‡ç­¾èŠ‚ç‚¹ï¼Œé€šè¿‡ç®€å•çš„è®¡ç®—ï¼Œè®©å®ƒä»¬æ—‹è½¬åˆ°è‡ªå·±æ‰€å±çš„æ‰‡å½¢åŒºåŸŸä¸Šã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜ä¸ºè½¬ç›˜è®¾ç½®äº†ä¸€ä¸ªåˆå§‹è§’åº¦ï¼Œä½¿å¾—ç¬¬ä¸€ä¸ªå¥–å“å‘ˆç°åœ¨è½¬ç›˜çš„æ­£ä¸Šæ–¹ã€‚æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š

![turntable-with-prize-labels](./lucky-draw/turntable-with-prize-labels.png)

&gt; æ›´ç²¾è‡´ã€ç¾è§‚çš„è½¬ç›˜è®¾è®¡è¿˜æ˜¯å»ºè®®ç›´æ¥ä½¿ç”¨åšå¥½çš„è½¬ç›˜å›¾ç‰‡ï¼›çº¯å‰ç«¯å®ç°çš„è¯ä¸€æ–¹é¢è€—æ—¶è€—åŠ›ï¼Œå¦ä¸€æ–¹é¢å¦‚æœè¯·æ±‚è¿‡å¤šçš„è£…é¥°å›¾ç‰‡åè€Œä¼šé™ä½è®¿é—®æ€§èƒ½ã€‚
&gt;
&gt; ```html
&gt; &lt;img src=&quot;path/to/turntable.png&quot; alt=&quot;turntable&quot; id=&quot;turntable&quot; class=&quot;turntable&quot;&gt;&lt;/img&gt;
&gt; ```

æ¥ä¸‹æ¥æ·»åŠ æŒ‡é’ˆå’ŒæŠ½å¥–æŒ‰é’®ï¼š

```html
&lt;div class=&quot;container&quot;&gt;
  &lt;div id=&quot;turntable&quot; class=&quot;turntable&quot;&gt;&lt;/div&gt;
  &lt;div class=&quot;arrow&quot;&gt;&lt;/div&gt;
  &lt;div id=&quot;lottery-btn&quot; class=&quot;lottery-btn&quot;&gt;æŠ½å¥–&lt;/div&gt;
&lt;/div&gt;
```

```scss
.arrow {
  position: absolute;
  top: 140px;
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-bottom: 100px solid #f8fafc;
}

.lottery-btn {
  position: absolute;
  top: 200px;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: #f8fafc;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #333;
  font-weight: bold;
  cursor: pointer;
  user-select: none;

  &amp;--disabled {
    color: #999;
    pointer-events: none;
  }
}
```

ä½¿ç”¨ç»å¯¹å®šä½å°†æŒ‡é’ˆå’ŒæŒ‰é’®æ”¾åˆ°åˆé€‚çš„ä½ç½®ï¼Œè½¬ç›˜ç°åœ¨çœ‹ä¸Šå»æœ‰æ¨¡æœ‰æ ·äº†ï¼š

![turntable-with-all](./lucky-draw/turntable-with-all.png)

æœ€é‡è¦çš„ç¯èŠ‚åˆ°äº†ï¼Œå®ç°è½¬ç›˜æŠ½å¥–çš„æ ¸å¿ƒéœ€æ±‚ï¼šè½¬ï¼

é¦–å…ˆå®ç°ä¸€ä¸ªæ”¯æŒç”Ÿæˆå°æ•°ä½å `precision` ä½ç²¾åº¦çš„éšæœºæ•°çš„æ–¹æ³•ï¼Œå®ƒå°†è¢«ç”¨äºæ¨¡æ‹ŸæŠ½å¥–ç»“æœï¼ˆå½“ç„¶è¿™åº”å½“ç”±åç«¯å®Œæˆï¼‰ï¼Œä»¥åŠè®¡ç®—è½¬ç›˜åº”å½“æ—‹è½¬çš„è§’åº¦ï¼š

```ts
const getRandomNumber = (min: number, max: number, precision: number) =&gt; {
  const factor = Math.pow(10, precision);
  const random = Math.random() * (max - min) + min;
  return Math.round(random * factor) / factor;
};
```

åŸºäºåˆšåˆšå®ç°çš„ `getRandomNumber()` æ–¹æ³•ï¼Œå®Œæˆæˆ‘ä»¬çš„æŠ½å¥–äº‹ä»¶ï¼š

```ts
const animationDuration = 5000;
const rotateLapsBase = 10;
let rotateLaps = 0;

const lotteryBtnDom = document.getElementById(&quot;lottery-btn&quot;);
lotteryBtnDom.onclick = () =&gt; {
  lotteryBtnDom.classList.add(&quot;lottery-btn--disabled&quot;);

  // #region æ¨¡æ‹ŸæŠ½å¥–ç»“æœï¼Œç”±åç«¯å®Œæˆ
  let prizeIndex = 0;
  let resultNum = getRandomNumber(0, 1, 3); // æœ¬æ–‡é¢„è®¾å¥–å“çš„ä¸­å¥–æ¦‚ç‡ç²¾ç¡®åˆ°å°æ•°ç‚¹å 3 ä½ï¼Œå› æ­¤è¿™é‡Œçš„ `precision` è®¾ä¸º 3
  while (resultNum &gt; 0) {
    resultNum -= prizes[prizeIndex].probability;
    if (resultNum &gt; 0) {
      prizeIndex += 1;
    }
  }
  const prize = prizes[prizeIndex];
  // #endregion

  // #region è·å–è½¬ç›˜éœ€è¦æ—‹è½¬çš„è§’åº¦
  const turntableRotateDegFrom = Number(
    (anglePerPrize * prizeIndex).toFixed(1),
  );
  const turntableRotateDegTo =
    prizeIndex === prizes.length - 1
      ? 360
      : Number((anglePerPrize * (prizeIndex + 1)).toFixed(1));
  const turntableRotateDegEdgeThreshold = Number(
    (anglePerPrize / 4).toFixed(1),
  ); // è®¾å®šæ—‹è½¬åˆ°æŒ‡å®šæ‰‡å½¢åŒºåŸŸçš„è·è¾¹ç¼˜é˜ˆå€¼ï¼ˆ&lt;= anglePerPrize / 2ï¼‰ï¼Œé˜²æ­¢å‡ºç°æŒ‡é’ˆæŒ‡å‘å¤ªé è¿‘è¾¹ç¼˜çš„æƒ…å†µ
  const turntableRotateDegBase = getRandomNumber(
    turntableRotateDegFrom + turntableRotateDegEdgeThreshold,
    turntableRotateDegTo - turntableRotateDegEdgeThreshold,
    1,
  );
  rotateLaps += rotateLapsBase; // é€‚é…å¤šæ¬¡æ—‹è½¬çš„æƒ…å†µ
  const turntableRotateDeg = -(rotateLaps * 360 + turntableRotateDegBase);
  // #endregion

  // #region ä¸ºè½¬ç›˜è®¾ç½®æ—‹è½¬åŠ¨ç”»
  turntableDom.style.transform = `rotate(${turntableRotateDeg}deg)`;
  turntableDom.style.transition = `transform ${animationDuration}ms ease-out`;
  // #endregion

  setTimeout(() =&gt; {
    alert(`æ‚¨æŠ½ä¸­äº†ï¼š${prize.label}ï¼`);
    lotteryBtnDom.classList.remove(&quot;lottery-btn--disabled&quot;);
  }, animationDuration + 500);
};
```

è®¡ç®—å®é™…ä¸­å¥–ç»“æœæ‰€åœ¨çš„æ‰‡å½¢åŒºåŸŸè§’åº¦ `turntableRotateDegFrom` è‡³ `turntableRotateDegTo`ï¼Œåˆ†åˆ«åŠ ä¸Šå’Œå‡å»è·ç¦»è¾¹ç¼˜çš„é˜ˆå€¼ `turntableRotateDegEdgeThreshold`ï¼Œå°†å¾—åˆ°çš„èŒƒå›´å–éšæœºæ•°ï¼Œå³å¯å¾—åˆ°æˆ‘ä»¬æœ€åè½¬ç›˜åº”æ—‹è½¬çš„è§’åº¦ `turntableRotateDegBase`ã€‚å°†åº”æ—‹è½¬çš„è§’åº¦å†åŠ ä¸Šè®¾å®šå¥½çš„æ—‹è½¬åœˆæ•°æ‰€å¯¹åº”çš„è§’åº¦ï¼Œå–åå³å¯å¾—åˆ°åŠ¨ç”»æ•ˆæœä¸­å®é™…æ—‹è½¬çš„è§’åº¦ `turntableRotateDeg`ã€‚

ç‚¹å‡»æŠ½å¥–æŒ‰é’®ï¼Œçœ‹çœ‹ç°åœ¨çš„æ•ˆæœå§ï¼š

![lucky-draw-base-animation](./lucky-draw/lucky-draw-base-animation.gif)

Opsï¼Œç«Ÿç„¶æ˜¯è°¢è°¢å‚ä¸ï¼Œæˆ‘è§‰å¾—æœ‰é»‘å¹•ï¼ä½†æ˜¯å¯å–œå¯è´ºï¼Œæˆ‘ä»¬å·²ç»åŸºæœ¬å®ç°äº†è½¬ç›˜æŠ½å¥–ç»„ä»¶æ‰€éœ€çš„å…¨éƒ¨èƒ½åŠ›ã€‚

ä¸‹é¢ï¼Œä¸ºäº†ä½¿è½¬ç›˜æ—‹è½¬çš„æ•ˆæœæ›´è´´è¿‘ç”Ÿæ´»å®é™…ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ—‹è½¬åŠ¨ç”»è®¾ç½®æ›´ç¬¦åˆç‰©ç†ç›´è§‰çš„è¿‡æ¸¡æ•ˆæœã€‚

åˆšåˆšä¸º `transform` è®¾ç½®çš„åŠ¨ç”»è¿‡æ¸¡æ•ˆæœ `transition-timing-function: ease-out;` ç›¸å½“äº `transition-timing-function: cubic-bezier(0, 0, .58, 1);`ï¼Œè¡¨ç¤ºåŠ¨ç”»ä¸€å¼€å§‹è¾ƒå¿«ï¼Œéšç€åŠ¨ç”»çš„è¿›è¡Œé€æ¸å‡é€Ÿã€‚

ä½†æ˜¯è½¬ç›˜ä»è½¬åŠ¨å‡é€Ÿè‡³åœæ­¢çš„è¿‡æ¸¡æ—¶é—´å¤ªçŸ­ï¼Œä»è§†è§‰ä¸Šçœ‹å°¤ä¸ºçªå…€ï¼Œè¦æ˜¯ç¨é•¿ä¸€äº›å°±å¥½äº†ã€‚

é€šè¿‡ [cubic-bezier](https://cubic-bezier.com/)ï¼Œæˆ‘ä»¬ä»¥å¯è§†åŒ–çš„æ–¹å¼å®ç°ä¸€ä¸ªæ»¡è¶³éœ€è¦çš„ä¸‰æ¬¡è´å¡å°”æ›²çº¿ï¼Œä½œä¸ºåŠ¨ç”»çš„è¿‡æ¸¡æ•ˆæœã€‚å¦‚ï¼š`transition-timing-function: cubic-bezier(.3, .9, .38, 1);`ï¼Œå®ƒå‡é€Ÿè‡³åœæ­¢çš„ **è¿‡æ¸¡æ—¶é—´æ›´é•¿ä¸”æ›´æŸ”å’Œ**ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

![lucky-draw-better-animation](./lucky-draw/lucky-draw-better-animation.gif)

å®Œæ•´çš„ Demo å¥‰ä¸Šï¼š

&lt;iframe
  height=&quot;600&quot;
  scrolling=&quot;no&quot;
  title=&quot;lucky-draw-demo&quot;
  src=&quot;https://codepen.io/LolipopJ/embed/QWXzwWp?default-tab=html%2Cresult&quot;
  frameBorder=&quot;no&quot;
  loading=&quot;lazy&quot;
  allowtransparency=&quot;true&quot;
  allowFullScreen={true}
&gt;
  See the Pen{&quot; &quot;}
  &lt;a href=&quot;https://codepen.io/LolipopJ/pen/QWXzwWp&quot;&gt;lucky-draw-demo&lt;/a&gt; by
  JasonSung (&lt;a href=&quot;https://codepen.io/LolipopJ&quot;&gt;@LolipopJ&lt;/a&gt;) on{&quot; &quot;}
  &lt;a href=&quot;https://codepen.io&quot;&gt;CodePen&lt;/a&gt;.
&lt;/iframe&gt;
</content:original-text><content:updated-at>2024-09-07T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[Electron æ‰§è¡Œåå°ç¨‹åºå¹¶åœ¨æ¸²æŸ“å™¨å®æ—¶æ‰“å°è¿è¡Œæ—¥å¿—]]></title><description><![CDATA[å¼€å‘å›¾åƒæŸ¥é‡å·¥å…·æ—¶é‡åˆ°äº†è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šåœ¨æŸ¥é‡ä¹‹å‰ï¼Œç”¨æˆ·éœ€è¦å…ˆå¯¹å›¾åƒæ–‡ä»¶è¿›è¡Œç´¢å¼•æ“ä½œï¼Œåå°å°†è°ƒç”¨å¯æ‰§è¡Œæ–‡ä»¶å¹¶ä¸ºæ¯å¼ å›¾åƒç”Ÿæˆç‰¹å¾å€¼ã€‚ç´¢å¼•æ“ä½œæ‰€éœ€çš„æ—¶é—´ä¸å›¾åƒçš„æ•°é‡åŠå¤§å°å‘ˆæ­£ç›¸å…³ï¼Œç¬”è€…ä¸ºå¤§çº¦ 50000 å¼ å›¾ç‰‡ï¼ˆçº¦ 170GBï¼‰ç”Ÿæˆç‰¹å¾å€¼ï¼Œéœ€è¦èŠ±è´¹å°†è¿‘ 90 åˆ†é’Ÿçš„æ—¶é—´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ¸²æŸ“å™¨ä»€ä¹ˆä¹Ÿä¸å±•ç¤ºï¼Œå¡åœ¨é‚£é‡Œï¼Œç”¨æˆ·éš¾å…ä¼šéå¸¸ç„¦è™‘ â€”â€” åå°æ˜¯å¦è¿˜åœ¨è¿è¡Œï¼Œæˆ‘æ˜¯ä¸æ˜¯å¡æ­»äº†ï¼Ÿ é‚£ä¹ˆéœ€æ±‚ä¹Ÿå°±æ˜äº†äº†â€¦]]></description><link>https://blog.towind.fun/posts/electron-real-time-print-execution-log</link><guid isPermaLink="false">electron-real-time-print-execution-log</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Mon, 05 Aug 2024 00:00:00 GMT</pubDate><content:original-text>
å¼€å‘å›¾åƒæŸ¥é‡å·¥å…·æ—¶é‡åˆ°äº†è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šåœ¨æŸ¥é‡ä¹‹å‰ï¼Œç”¨æˆ·éœ€è¦å…ˆå¯¹å›¾åƒæ–‡ä»¶è¿›è¡Œç´¢å¼•æ“ä½œï¼Œåå°å°†è°ƒç”¨å¯æ‰§è¡Œæ–‡ä»¶å¹¶ä¸ºæ¯å¼ å›¾åƒç”Ÿæˆç‰¹å¾å€¼ã€‚ç´¢å¼•æ“ä½œæ‰€éœ€çš„æ—¶é—´ä¸å›¾åƒçš„æ•°é‡åŠå¤§å°å‘ˆæ­£ç›¸å…³ï¼Œç¬”è€…ä¸ºå¤§çº¦ 50000 å¼ å›¾ç‰‡ï¼ˆçº¦ 170GBï¼‰ç”Ÿæˆç‰¹å¾å€¼ï¼Œéœ€è¦èŠ±è´¹å°†è¿‘ 90 åˆ†é’Ÿçš„æ—¶é—´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ¸²æŸ“å™¨ä»€ä¹ˆä¹Ÿä¸å±•ç¤ºï¼Œå¡åœ¨é‚£é‡Œï¼Œç”¨æˆ·éš¾å…ä¼šéå¸¸ç„¦è™‘ â€”â€” åå°æ˜¯å¦è¿˜åœ¨è¿è¡Œï¼Œæˆ‘æ˜¯ä¸æ˜¯å¡æ­»äº†ï¼Ÿ

é‚£ä¹ˆéœ€æ±‚ä¹Ÿå°±æ˜äº†äº†ï¼Œæ­£å¦‚æœ¬æ–‡çš„æ ‡é¢˜æ‰€è¿°ï¼Œæˆ‘ä»¬éœ€è¦**å°†åå°è¿è¡Œçš„æ—¥å¿—å®æ—¶æ¨é€åˆ°æ¸²æŸ“å™¨**ï¼Œè¿™æ ·ç”¨æˆ·ä¾¿èƒ½çœ‹åˆ°ç´¢å¼•æ“ä½œçš„è¿›åº¦ï¼Œå®‰ä¸‹å¿ƒæ¥ã€‚

## æŠ€æœ¯èƒŒæ™¯

ä¼—æ‰€å‘¨çŸ¥ï¼Œä¸€ä¸ª Electron åº”ç”¨åˆ†ä¸ºäº† Renderer æ¸²æŸ“å™¨å’Œ Main ä¸»è¿›ç¨‹ä¸¤ç«¯ã€‚æ¸²æŸ“å™¨è´Ÿè´£å¯¹å®¢ä¾§çš„å±•ç¤ºï¼Œæ­£å¦‚æˆ‘ä»¬è®¿é—®çš„æ‰€æœ‰ç½‘é¡µä¸€æ ·ï¼Œæ˜¯ HTMLã€CSSã€JavaScript çš„é›†åˆï¼Œæ— æ³•è°ƒç”¨ Node æˆ–æ˜¯è®¿é—®å®¿ä¸»æœºæ–‡ä»¶ç­‰ã€‚è€Œä¸»è¿›ç¨‹åˆ™å…·å¤‡æœ‰æœåŠ¡ç«¯åº”ç”¨çš„æ€§è´¨ï¼Œèƒ½å¤Ÿè°ƒç”¨ Node æˆ–æ˜¯ä¸å®¿ä¸»æœºäº¤äº’ç­‰ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œä¸ºäº†å®ç°æˆ‘ä»¬çš„ç›®æ ‡ï¼Œåœ¨èƒŒåä¾æ¬¡è¦å®ç°è¿™äº›äº‹æƒ…ï¼š

1. æ¸²æŸ“å™¨æ¥æ”¶ç”¨æˆ·ç´¢å¼•æ“ä½œçš„è¯·æ±‚ï¼Œå°†è¯·æ±‚å‘é€è‡³ä¸»è¿›ç¨‹ã€‚
2. ä¸»è¿›ç¨‹æ¥æ”¶åˆ°è¯·æ±‚ï¼Œè°ƒç”¨å¯æ‰§è¡Œæ–‡ä»¶å¼€å§‹ç”Ÿæˆå›¾åƒç‰¹å¾å€¼ã€‚
3. ä¸»è¿›ç¨‹å°†äº§ç”Ÿçš„æ—¥å¿—ä¿¡æ¯å®æ—¶æ¨é€ç»™æ¸²æŸ“å™¨ã€‚
4. æ¸²æŸ“å™¨æ¥æ”¶åˆ°æ—¥å¿—ä¿¡æ¯ï¼Œå¹¶å‘ç”¨æˆ·å±•ç¤ºã€‚

## éœ€æ±‚å®ç°

æ ¹æ®åˆšæ‰çš„åˆ†æï¼Œå¯¹[è¿›ç¨‹é—´é€šä¿¡ï¼ˆInter-Process Communicationï¼ŒIPCï¼‰](https://www.electronjs.org/zh/docs/latest/tutorial/ipc)èƒ½åŠ›çš„ä½¿ç”¨å°†ä¼šæ˜¯å®ç°éœ€æ±‚çš„å…³é”®ã€‚

å®ç°çš„å…·ä½“æ–¹æ¡ˆéµå¾ª Electron æ¨èçš„å®‰å…¨è®¾ç½®å³ä¸Šä¸‹æ–‡éš”ç¦»ã€‚ä¸‹é¢çš„å†…å®¹å‡è®¾æ‚¨å¯¹[é¢„åŠ è½½å™¨](https://www.electronjs.org/zh/docs/latest/tutorial/process-model#preload-%E8%84%9A%E6%9C%AC)æœ‰ä¸€å®šçš„äº†è§£ã€‚

### æ¸²æŸ“å™¨å°†è¯·æ±‚å‘é€è‡³ä¸»è¿›ç¨‹

æ¸²æŸ“å™¨å‘é€è¯·æ±‚è‡³ä¸»è¿›ç¨‹æ˜¯**æ¸²æŸ“å™¨åˆ°ä¸»è¿›ç¨‹çš„å•å‘é€šä¿¡**ï¼Œå…·ä½“çš„å®ç°åˆ†æˆä¸‰ä¸ªæ­¥éª¤ï¼š

1. ä¸»è¿›ç¨‹é€šè¿‡ `ipcMain.on()` ç›‘å¬è¯·æ±‚ã€‚

   ```ts
   // main/background.ts
   import { ipcMain } from &quot;electron&quot;;

   export enum Events {
     UPDATE_INDEX = &quot;events:updateIndex&quot;,
   }

   ipcMain.on(Events.UPDATE_INDEX, (_, args) =&gt; {
     // todo: execute binary
   });
   ```

2. é¢„åŠ è½½å™¨å‘æ¸²æŸ“å™¨æš´éœ² `ipcRenderer.send()` æ–¹æ³•ã€‚

   ```ts
   // main/preload.ts
   import { ipcRenderer, contextBridge } from &quot;electron&quot;;

   const ipc = {
     send: (channel: string, ...args: unknown[]) =&gt; {
       ipcRenderer.send(channel, ...args);
     },
     // ç”±äº Electron çš„å®‰å…¨æœºåˆ¶ï¼Œæ‚¨ä¸èƒ½ç›´æ¥æš´éœ² `ipcRenderer` ä»¥åŠä¸Šé¢çš„æ–¹æ³•
     // é”™è¯¯çš„ä¾‹å­ï¼š
     // send: ipcRenderer.send,
   };

   contextBridge.exposeInMainWorld(&quot;ipc&quot;, ipc);

   export type IPC = typeof ipc;
   ```

   è®© TypeScript æ›´å¥½åœ°ä¸ºæ‚¨å·¥ä½œï¼Œåˆ«å¿˜äº†å°†ç±»å‹ `IPC` æš´éœ²ç»™ `Window` å¯¹è±¡ï¼š

   ```ts
   // renderer/preload.d.ts
   import type { IPC } from &quot;path/to/main/preload&quot;;

   declare global {
     interface Window {
       ipc: IPC;
     }
   }
   ```

3. æ¸²æŸ“å™¨å®ç°è°ƒç”¨é¢„åŠ è½½å™¨æš´éœ²çš„æ–¹æ³•ã€‚

   ```tsx
   // renderer/path/to/component-trigger.tsx
   import { Events } from &quot;path/to/main/background&quot;;

   export default () =&gt; {
     const onUpdateIndex = () =&gt; {
       window.ipc.send(Events.UPDATE_INDEX);
     };

     return &lt;&gt;{/* component details */}&lt;/&gt;;
   };
   ```

   å†åœ¨åˆé€‚çš„åœ°æ–¹ç¼–å†™è§¦å‘é€»è¾‘ï¼Œå³å¯å°†è¯·æ±‚å‘é€è‡³ä¸»è¿›ç¨‹ã€‚

### ä¸»è¿›ç¨‹è°ƒç”¨å¯æ‰§è¡Œæ–‡ä»¶

æ¥ç€ï¼Œè®©æˆ‘ä»¬æ¥å®Œå–„ä¸»è¿›ç¨‹çš„é€»è¾‘ï¼šåœ¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå»è°ƒç”¨æœ¬åœ°çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

åœ¨ Node ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾è€æœ‹å‹ `child_process` å¸®å¿™ã€‚`child_process.exec()` ä¼šç­‰å¾…æ‰§è¡Œç»“æŸåå°†ç»“æœä¸€å¹¶è¿”å›ï¼Œä¸æ»¡è¶³æˆ‘ä»¬çš„éœ€è¦ï¼›`child_process.spawn()` é‡‡ç”¨äº‹ä»¶ç›‘å¬æœºåˆ¶ï¼Œå¯ä»¥åº”å¯¹å®æ—¶è¾“å‡ºæ—¥å¿—çš„æƒ…æ™¯ï¼Œæ»¡è¶³æˆ‘ä»¬çš„éœ€è¦ã€‚

åŸºäº `child_process.spawn()` ç¼–å†™ä»£ç å¦‚ä¸‹ï¼š

```ts
// main/background.ts
import { spawn } from &quot;child_process&quot;;

const runSpawn = (cmd: string, args: string[]) =&gt; {
  const process = spawn(cmd, args);

  process.stdout.on(&quot;data&quot;, (data) =&gt; {
    // todo: on receive stdout data
  });

  process.stderr.on(&quot;data&quot;, (data) =&gt; {
    // todo: on receive stderr data
  });

  process.on(&quot;close&quot;, (code) =&gt; {
    // todo: on receive close signal
  });
};

ipcMain.on(Events.UPDATE_INDEX, (_, args) =&gt; {
  runSpawn(&quot;path/to/binary&quot;, [&quot;--update-index&quot;, &quot;--rest-args&quot;]);
});
```

### ä¸»è¿›ç¨‹å®æ—¶æ¨é€æ—¥å¿—ä¿¡æ¯ç»™æ¸²æŸ“å™¨

å½“äº‹ä»¶ç›‘å¬å™¨è§¦å‘æ—¶ï¼Œå‘æ¸²æŸ“å™¨å‘é€æ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ˜¯**ä¸»è¿›ç¨‹åˆ°æ¸²æŸ“å™¨çš„å•å‘é€šä¿¡**ï¼Œå…·ä½“çš„å®ç°åŒæ ·åˆ†æˆä¸‰ä¸ªæ­¥éª¤ï¼š

1. ä¸»è¿›ç¨‹é€šè¿‡ `browserWindow.webContents.send()` å‘é€ä¿¡æ¯ã€‚

   å®Œå–„å‰é¢çš„ `runSpawn()` æ–¹æ³•ï¼š

   ```ts
   // main/background.ts
   import iconv from &quot;iconv-lite&quot;;

   export enum SpawnEvents {
     SPAWN_STARTED = &quot;spawn:started&quot;,
     SPAWN_STDOUT = &quot;spawn:stdout&quot;,
     SPAWN_STDERR = &quot;spawn:stderr&quot;,
     SPAWN_FINISHED = &quot;spawn:finished&quot;,
   }

   // Compatible with default command line encoding `cp936` on Windows platform
   const iconvDecoding = process.platform === &quot;win32&quot; ? &quot;cp936&quot; : &quot;utf-8&quot;;

   const runSpawn = (cmd: string, args: string[]) =&gt; {
     const process = spawn(cmd, args);
     browserWindow.webContents.send(SpawnEvents.SPAWN_STARTED);

     process.stdout.on(&quot;data&quot;, (data) =&gt; {
       browserWindow.webContents.send(
         SpawnEvents.SPAWN_STDOUT,
         iconv.decode(Buffer.from(data, &quot;binary&quot;), iconvDecoding),
       );
     });

     process.stderr.on(&quot;data&quot;, (data) =&gt; {
       browserWindow.webContents.send(
         SpawnEvents.SPAWN_STDERR,
         iconv.decode(Buffer.from(data, &quot;binary&quot;), iconvDecoding),
       );
     });

     process.on(&quot;close&quot;, (code) =&gt; {
       browserWindow.webContents.send(SpawnEvents.SPAWN_FINISHED, code ?? 0);
     });
   };
   ```

   ç‰¹åˆ«çš„ï¼Œåœ¨ Windows ç«¯ï¼Œç”±äºå‘½ä»¤è¡Œå·¥å…·é»˜è®¤é‡‡ç”¨ `cp936` ç¼–ç ï¼Œåœ¨è¾“å‡ºä¸­æ–‡æ—¶ä¼šå‡ºç°ä¹±ç çš„ç°è±¡ã€‚å› æ­¤ï¼Œåœ¨ä¸Šé¢çš„å®ç°ä¸­ï¼Œç¬”è€…ä½¿ç”¨äº† `iconv-lite` å¯¹æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯è¿›è¡Œäº†é‡æ–°è§£ç ã€‚

2. é¢„åŠ è½½å™¨å‘æ¸²æŸ“å™¨æš´éœ² `ipcRenderer.on()` æ–¹æ³•ã€‚

   ```ts
   // main/preload.ts
   import { type IpcRendererEvent } from &quot;electron&quot;;

   const ipc = {
     on: (channel: string, func: (...args: unknown[]) =&gt; void) =&gt; {
       const subscription = (_event: IpcRendererEvent, ...args: unknown[]) =&gt;
         func(...args);
       ipcRenderer.on(channel, subscription);

       return () =&gt; {
         ipcRenderer.removeListener(channel, subscription);
       };
     },
   };
   ```

   å…¶è¿”å›å€¼æ˜¯æ¸…é™¤ç›‘å¬å™¨çš„æ–¹æ³•ï¼Œå¯ä»¥é…åˆ `React.useEffect()` ä½¿ç”¨ã€‚

3. æ¸²æŸ“å™¨å®ç°è°ƒç”¨é¢„åŠ è½½å™¨æš´éœ²çš„æ–¹æ³•ã€‚

   ```tsx
   // renderer/path/to/component-listener.tsx
   import { useEffect, useState } from &quot;react&quot;;
   import { SpawnEvents } from &quot;path/to/main/background&quot;;

   export default () =&gt; {
     const [loading, setLoading] = useState&lt;boolean&gt;(false);
     const [stdout, setStdout] = useState&lt;string&gt;(&quot;&quot;);
     const [stderr, setStderr] = useState&lt;string&gt;(&quot;&quot;);

     useEffect(() =&gt; {
       const cleanupSpawnStarted = window.ipc.on(
         SpawnEvents.SPAWN_STARTED,
         () =&gt; {
           setLoading(true);
         },
       );
       const cleanupSpawnStdout = window.ipc.on(
         SpawnEvents.SPAWN_STDOUT,
         (data: string) =&gt; {
           setStdout(data);
         },
       );
       const cleanupSpawnStderr = window.ipc.on(
         SpawnEvents.SPAWN_STDERR,
         (data: string) =&gt; {
           // setStderr(data);
           setStderr((prev) =&gt; {
             return (data + &quot;\n&quot; + prev).substring(0, 2000);
           });
         },
       );
       const cleanupSpawnFinished = window.ipc.on(
         SpawnEvents.SPAWN_FINISHED,
         (code: number) =&gt; {
           setLoading(false);
         },
       );

       return () =&gt; {
         cleanupSpawnStarted();
         cleanupSpawnStdout();
         cleanupSpawnStderr();
         cleanupSpawnFinished();
       };
     }, []);

     return &lt;&gt;{/* component details */}&lt;/&gt;;
   };
   ```

   ä¸€èˆ¬æ¥è¯´ï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä¼šå°†æ—¥å¿—ä¿¡æ¯é‡å®šå‘è‡³ `stderr` æ ‡å‡†é”™è¯¯ï¼Œè¿è¡Œçš„æœ€ç»ˆç»“æœé‡å®šå‘è‡³ `stdout` æ ‡å‡†è¾“å‡ºã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å±•ç¤ºçš„æ˜¯ `stderr` çš„å†…å®¹ã€‚

   å¦‚æœæ¸²æŸ“å™¨è¿˜éœ€è¦å¯¹ `stdout` çš„ç»“æœè¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ï¼ŒåŒæ ·å¯ä»¥åœ¨å¯¹åº”çš„ç»„ä»¶ä¸­æ·»åŠ ç›‘å¬å™¨ï¼š`window.ipc.on(SpawnEvents.SPAWN_STDOUT, (data: string) =&gt; {})`ã€‚

### æ¸²æŸ“å™¨å±•ç¤ºæ¥æ”¶åˆ°çš„æ—¥å¿—ä¿¡æ¯

ç°åœ¨ï¼Œæ‰€æœ‰çš„é“¾è·¯éƒ½å·²ç»æ‰“é€šï¼ŒæŸ¥æ”¶ç¼–å†™ä»£ç åŠªåŠ›çš„ç»“æ™¶å§ï¼

![å®æ—¶å±•ç¤ºæ—¥å¿—ä¿¡æ¯](./electron-real-time-print-execution-log/real-time-execution-log.gif)
</content:original-text><content:updated-at>2024-08-05T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[éƒ¨ç½²ä¸€ä¸ªç»™æœ‹å‹ä½¿ç”¨çš„ Minecraft æ¨¡ç»„æœåŠ¡å™¨]]></title><description><![CDATA[ç¬”è€…åœ¨ä»Šå¹´äº”æœˆä»½éƒ¨ç½²äº†ä¸€ä¸ªä¸æœ‹å‹åŒç©å…±ä¹çš„ Minecraft æœåŠ¡å™¨ï¼Œç¨³å®šè¿è¡Œè‡³ä»Šã€‚å¿½ç„¶æƒ³è®°å½•ä¸ºä¸€ç¯‡åšå®¢ï¼Œåˆ†äº«åˆ†äº«æŠ˜è…¾çš„ç»å†ã€‚ ç¬”è€…ç»“åˆä¸ªäººå–œå¥½ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼Œæ¨¡ç»„ä¼˜å…ˆï¼‰å’Œå¤§ä¼—æ¨èï¼ˆFabric æ›´é€‚åˆæ–°ç‰ˆæœ¬ Minecraftï¼‰ï¼Œå†³å®šåŸºäº Fabric æ­å»ºä¸€ä¸ªå¯ä»¥æ·»åŠ æ¨¡ç»„çš„ Minecraft æœåŠ¡å™¨ã€‚æ­¤ç±»æœåŠ¡å™¨ç®€ç§°ä¸ºæ¨¡ç»„æœåŠ¡å™¨ï¼Œè¿˜æœ‰åŸºäº Paper, Spigot ç­‰æ­å»ºçš„æ’ä»¶æœåŠ¡å™¨â€¦]]></description><link>https://blog.towind.fun/posts/run-mc-server</link><guid isPermaLink="false">run-mc-server</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Fri, 05 Jul 2024 00:00:00 GMT</pubDate><content:original-text>
ç¬”è€…åœ¨ä»Šå¹´äº”æœˆä»½éƒ¨ç½²äº†ä¸€ä¸ªä¸æœ‹å‹åŒç©å…±ä¹çš„ Minecraft æœåŠ¡å™¨ï¼Œç¨³å®šè¿è¡Œè‡³ä»Šã€‚å¿½ç„¶æƒ³è®°å½•ä¸ºä¸€ç¯‡åšå®¢ï¼Œåˆ†äº«åˆ†äº«æŠ˜è…¾çš„ç»å†ã€‚

ç¬”è€…ç»“åˆä¸ªäººå–œå¥½ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼Œæ¨¡ç»„ä¼˜å…ˆï¼‰å’Œå¤§ä¼—æ¨èï¼ˆFabric æ›´é€‚åˆæ–°ç‰ˆæœ¬ Minecraftï¼‰ï¼Œå†³å®šåŸºäº Fabric æ­å»ºä¸€ä¸ªå¯ä»¥æ·»åŠ æ¨¡ç»„çš„ Minecraft æœåŠ¡å™¨ã€‚æ­¤ç±»æœåŠ¡å™¨ç®€ç§°ä¸ºæ¨¡ç»„æœåŠ¡å™¨ï¼Œè¿˜æœ‰åŸºäº [Paper](https://github.com/PaperMC/Paper), [Spigot](https://www.spigotmc.org) ç­‰æ­å»ºçš„æ’ä»¶æœåŠ¡å™¨ï¼Œå¯ä»¥ç»¼åˆè‡ªèº«éœ€æ±‚ï¼Œé€‰æ‹©æœ€åˆé€‚çš„æ­å»ºæ–¹æ¡ˆã€‚

## éƒ¨ç½² Minecraft æœåŠ¡å™¨

### å®‰è£… Java ç¯å¢ƒ

Java ç‰ˆçš„ Minecraft æœåŠ¡å™¨ä¾èµ–äº Java å¯åŠ¨ï¼Œå› æ­¤åœ¨ä¸€åˆ‡çš„æœ€å¼€å§‹ï¼Œéœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå®‰è£… Java ç¯å¢ƒã€‚

Java ç‰ˆçš„ Minecraft è‡ª 1.18 ç‰ˆæœ¬å¼€å§‹éœ€è¦ Java &gt;= 17ã€‚å‚è€ƒç½‘ä¸Šä¿¯æ‹¾çš†æ˜¯çš„æ•™ç¨‹ï¼Œé€šè¿‡åŒ…ç®¡ç†å·¥å…·æˆ–å‰å¾€ [Oracle OpenJDK](https://jdk.java.net/) é¡µé¢ä¸‹è½½å¹¶å®‰è£…åˆé€‚ç‰ˆæœ¬çš„ Javaã€‚

è¾“å…¥ `java -version` å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸï¼Œåœ¨ç¬”è€…çš„æœåŠ¡å™¨ä¸Šæ‰“å°çš„ç»“æœå¦‚ä¸‹ï¼š

```bash
$ java -version
openjdk version &quot;21.0.2&quot; 2024-01-16
OpenJDK Runtime Environment (build 21.0.2+13-alpine-r0)
OpenJDK 64-Bit Server VM (build 21.0.2+13-alpine-r0, mixed mode, sharing)
```

### ä¸‹è½½ Minecraft æœåŠ¡å™¨å¯åŠ¨å™¨

å‰å¾€ Fabric æä¾›çš„[ä¸‹è½½ Minecraft æœåŠ¡å™¨å¯åŠ¨å™¨é¡µé¢](https://fabricmc.net/use/server)ï¼Œé€‰æ‹©æ¬²éƒ¨ç½²çš„ Minecraft æœåŠ¡å™¨ç‰ˆæœ¬ï¼ŒFabric åŠ è½½å™¨å’Œ Fabric æ¨¡ç»„ç‰ˆæœ¬ï¼š

![ä¸‹è½½ Minecraft æœåŠ¡å™¨å¯åŠ¨å™¨](./run-mc-server/download-fabric-mc-server-launcher.png)

åœ¨æœåŠ¡å™¨ä¸Šé€šè¿‡ `curl` å‘½ä»¤ä¸‹è½½ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼š

```bash
curl -OJ https://meta.fabricmc.net/v2/versions/loader/1.21/0.15.11/1.0.1/server/jar
```

å¾—åˆ° Java å¯æ‰§è¡Œçš„å½’æ¡£æ–‡ä»¶ `fabric-server-mc.1.21-loader.0.15.11-launcher.1.0.1.jar`ã€‚

### å¯åŠ¨æœåŠ¡å™¨

æ–°å»ºä¸€ä¸ªå­˜æ”¾ Minecraft æœåŠ¡å™¨æ–‡ä»¶çš„ç›®å½•ï¼Œç§»åŠ¨åˆ°æ­¤ç›®å½•ï¼Œé€šè¿‡ `java` å‘½ä»¤æ‰§è¡Œåˆšåˆšå¾—åˆ°çš„æ–‡ä»¶ï¼š

```bash
java -Xmx2G -jar fabric-server-mc.1.21-loader.0.15.11-launcher.1.0.1.jar nogui
```

å°†è‡ªåŠ¨åœ¨**å½“å‰æ‰€åœ¨çš„ç›®å½•**ç”Ÿæˆå¿…è¦çš„æ•°æ®æ–‡ä»¶ã€‚é¦–æ¬¡å¯åŠ¨å°†ä¼šä»¥å¤±è´¥å‘Šç»ˆï¼Œæ­¤æ—¶éœ€è¦æ‰‹åŠ¨ç¼–è¾‘ç›®å½•ä¸‹çš„ `eula.txt`ï¼ŒåŒæ„ Minecraft çš„æœ€ç»ˆç”¨æˆ·è®¸å¯åè®®ï¼š

```txt
eula=true
```

å†æ¬¡å¯åŠ¨å°±ä¸€åˆ‡ OK äº†ã€‚

&gt; Minecraft æœåŠ¡å™¨é»˜è®¤ç›‘å¬ 25565 ç«¯å£ï¼Œè¯·ç¡®ä¿é˜²ç«å¢™æ”¾è¡Œäº†è¯¥ç«¯å£çš„ TCP ç±»å‹è¯·æ±‚ã€‚

æµ‹è¯•ä¸€åˆ‡æ­£å¸¸è¿è¡Œï¼Œå¯ä»¥é€šè¿‡æœåŠ¡å™¨å…¬ç½‘ IP è¿æ¥åˆ°æœåŠ¡å™¨åï¼Œä½¿ç”¨ `screen` å‘½ä»¤ç®¡ç† Minecraft æœåŠ¡å™¨è¿›ç¨‹ï¼š

```bash
screen -dmS mc-server java -Xmx2G -jar fabric-server-mc.1.21-loader.0.15.11-launcher.1.0.1.jar nogui
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å»ºç«‹äº†ä¸€ä¸ªåä¸º `mc-server` çš„ Screen ç»ˆç«¯ï¼Œéœ€è¦æŸ¥çœ‹è¿è¡Œæ—¥å¿—æ—¶ä½¿ç”¨ `screen -r mc-server` è¿›å…¥ã€‚

![æŸ¥çœ‹ Minecraft æœåŠ¡ç«¯æ—¥å¿—](./run-mc-server/server-log.png)

æ˜¯çš„ï¼Œè¿™å°±æ˜¯å…¨éƒ¨ã€‚æ¥ä¸‹æ¥å°±æ˜¯å‘æŒ¥åˆ›é€ åŠ›çš„ç¯èŠ‚äº†ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨ Minecraft ä¸­ä¸€ç›´åšçš„é‚£æ ·ã€‚

## è®©æœ‹å‹ä»¬è¿æ¥åˆ° Minecraft æœåŠ¡å™¨

ç¬”è€…æ¨èä½¿ç”¨å¼€æºä½œè€…[é¾™è…¾çŒ«è·ƒ](https://github.com/LTCatt)å¼€å‘çš„ [Plain Craft Launcher](https://github.com/Hex-Dragon/PCL2)ï¼ˆ[çˆ±å‘ç”µ](https://afdian.net/p/0164034c016c11ebafcb52540025c377)ï¼‰æ¥ä¸‹è½½ä¸å¯åŠ¨ Minecraft å®¢æˆ·ç«¯ã€‚

ä¸‹è½½æ—¶éœ€é€‰æ‹©ä¸æœåŠ¡ç«¯ç›¸åŒçš„ Fabric Loader å’Œ Fabric API ç‰ˆæœ¬ï¼š

![é€šè¿‡ PCL ä¸‹è½½ Minecraft å®¢æˆ·ç«¯](./run-mc-server/download-mc-client.png)

ä½¿ç”¨æ­£ç‰ˆè´¦å·æˆ–ç¦»çº¿è´¦å·å¯åŠ¨å®¢æˆ·ç«¯ï¼š

![é€šè¿‡ PCL å¯åŠ¨ Minecraft å®¢æˆ·ç«¯](./run-mc-server/start-mc-client.png)

## æ·»åŠ ä¸ç®¡ç†æ¨¡ç»„

æˆ‘ä»¬å¯ä»¥å‘ Minecraft æœåŠ¡å™¨æ·»åŠ å„ç§å„æ ·çš„ Fabric æ¨¡ç»„ã€‚

æ¨¡ç»„å­˜æ”¾äºæœåŠ¡å™¨æ ¹ç›®å½•çš„ `mods/` ç›®å½•ä¸‹ï¼ŒæœåŠ¡å™¨åˆå§‹åŒ–åä¼šé»˜è®¤åŒ…å«ä¸€ä¸ª Fabric ä¾èµ–çš„å¿…è¦æ¨¡ç»„ `mods/fabric-api-1.0.1+1.21.jar`ã€‚æˆ‘ä»¬ä¹Ÿåªéœ€è¦åƒè¿™æ ·ï¼ŒæŠŠ `.jar` æ ¼å¼çš„æ¨¡ç»„æ–‡ä»¶æ”¾ç½®åˆ° `mods/` ç›®å½•ä¸‹ï¼Œå°±ç®—æˆåŠŸæ·»åŠ æ¨¡ç»„äº†ã€‚

æ‚¨å¯ä»¥åœ¨ [Modrinth](https://modrinth.com/mods) å’Œ [CurseForge](https://www.curseforge.com/minecraft/search?class=mc-mods) æ¢ç´¢å’Œä¸‹è½½æƒ³è¦ä½¿ç”¨çš„æ¨¡ç»„ã€‚

ä¸‹é¢ä¸¾å‡ ä¸ªç¬”è€…ä½¿ç”¨åˆ°çš„æ¨¡ç»„çš„ä¾‹å­ã€‚

### AutoModpack / è‡ªåŠ¨åˆ†å‘å®¢æˆ·ç«¯æ¨¡ç»„

æŒ‰æ¨¡ç»„çš„ä½¿ç”¨ç¯å¢ƒï¼Œå¯ä»¥åˆ’åˆ†ä¸ºä»¥ä¸‹å››ç±»ï¼š

- å®¢æˆ·ç«¯æ¨¡ç»„ï¼šå®‰è£…åœ¨å®¢æˆ·ç«¯ã€‚æœåŠ¡ç«¯å®‰è£…æ— æ•ˆã€‚
- æœåŠ¡ç«¯æ¨¡ç»„ï¼šå®‰è£…åœ¨æœåŠ¡ç«¯ã€‚å®¢æˆ·ç«¯å®‰è£…æ— æ•ˆã€‚
- å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯æ¨¡ç»„ï¼šé€šå¸¸å®‰è£…åœ¨æœåŠ¡ç«¯ï¼Œåœ¨å®¢æˆ·ç«¯åŒæ—¶å®‰è£…å¯ä»¥å¢å¼ºä½“éªŒã€‚
- å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ¨¡ç»„ï¼šåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åŒæ—¶å®‰è£…æ‰æœ‰æ•ˆã€‚

ä¸ºäº†è·Ÿæœ‹å‹ä»¬éƒ½æœ‰ç›¸ä¼¼çš„æ¸¸æˆä½“éªŒï¼ˆä¹Ÿé¡ºä¾¿ç…§é¡¾ä¸å¤§æ‡‚æ¨¡ç»„å®‰è£…çš„æœ‹å‹ï¼‰ï¼Œè€ƒè™‘å»å®ç°æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„æ¨¡ç»„åŒæ­¥èƒ½åŠ›ã€‚ç¬”è€…æ‰¾åˆ°äº†æ¨¡ç»„ [AutoModpack](https://modrinth.com/mod/automodpack) æ¥å®ç°æ­¤åŠŸèƒ½ã€‚

AutoModpack æ˜¯ä¸€ä¸ª**å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ¨¡ç»„**ï¼Œå®‰è£…äº†æ­¤æ¨¡ç»„çš„å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨åŒæ­¥æœåŠ¡ç«¯ä¸Šæ‰˜ç®¡çš„æ¨¡ç»„åˆ°æœ¬åœ°ï¼Œä¿è¯ä¸åŒå®¢æˆ·ç«¯ä½“éªŒçš„ä¸€è‡´æ€§ã€‚å› æ­¤å¯¹äºä¸€èµ·ç©çš„æœ‹å‹ï¼Œåªéœ€è¦è®©ä»–ä»¬åœ¨å®¢æˆ·ç«¯çš„ `mods/` ç›®å½•ä¸‹æ”¾å…¥æ­¤æ¨¡ç»„ï¼Œå¹¶åœ¨é¦–æ¬¡è¿›å…¥æœåŠ¡å™¨æ—¶ç¡®è®¤åŒæ­¥å®¢æˆ·ç«¯æ¨¡ç»„å°±å¯ä»¥äº†ã€‚

![åŒæ­¥å®¢æˆ·ç«¯æ¨¡ç»„](./run-mc-server/sync-client-mods.png)

å¯¹äºä¸åº”å½“è¢«åŒæ­¥åˆ°å®¢æˆ·ç«¯å»çš„æ¨¡ç»„ï¼ŒAutoModpack ä¹Ÿæä¾›äº†ç®€å•çš„é…ç½®æ–¹å¼ï¼šä»¥ `server-` å¼€å¤´é‡å‘½åæ–‡ä»¶ã€‚ä¾‹å¦‚å¯¹äºåªéœ€è¦å®‰è£…åœ¨æœåŠ¡ç«¯çš„æ¨¡ç»„ [Dynmap](https://modrinth.com/plugin/dynmap)ï¼Œå°†æ¨¡ç»„æ–‡ä»¶ `mods/Dynmap-3.7-beta-6-fabric-1.21.jar` é‡å‘½åä¸º `mods/server-Dynmap-3.7-beta-6-fabric-1.21.jar` å³å¯ã€‚

### Dynmap / æœåŠ¡å™¨åœ°å›¾

![æœåŠ¡å™¨åœ°å›¾ï¼Œæ‘„åˆ¶äº 2024.07.05 17:18](./run-mc-server/server-map-202407051718.png)

æƒ³è¦ç”¨æµè§ˆå™¨åœ¨çº¿æŸ¥çœ‹ Minecraft æœåŠ¡å™¨åœ°å›¾ï¼ŒæŸ¥çœ‹å½“å‰åœ¨çº¿ç©å®¶çš„æ¸¸ç©æƒ…å†µï¼Œç›´æ¥å‘åœ¨çº¿çš„ç©å®¶å‘é€æ¶ˆæ¯ï¼Ÿè¿™ä¸€åˆ‡ä»…éœ€è¦ä¸€ä¸ªæœåŠ¡ç«¯æ¨¡ç»„ [Dynmap](https://modrinth.com/plugin/dynmap) å°±å¯ä»¥å®ç°ï¼

æˆåŠŸå¯ç”¨ Dynmap åï¼ŒWeb æœåŠ¡å°†é»˜è®¤ç›‘å¬æœ¬æœºçš„ 8123 ç«¯å£ï¼Œè¯·ç¡®ä¿é˜²ç«å¢™æ”¾è¡Œäº†è¯¥ç«¯å£çš„ TCP ç±»å‹è¯·æ±‚ã€‚

èµ·å§‹æ—¶é€šè¿‡æµè§ˆå™¨æŸ¥çœ‹ä¼šæ˜¯ä¸€ç‰‡é»‘æš—ï¼Œä¼´éšç©å®¶åœ¨ä¸–ç•Œé‡Œçš„æ¢ç´¢ï¼ŒDynmap ä¼šé€æ¸ç»˜åˆ¶æˆå½¢å®Œæ•´çš„åœ°å›¾ã€‚

### Fabric Tailor / ç¦»çº¿æœåŠ¡å™¨è‡ªå®šä¹‰æ¢è‚¤

å¯¹äºç¦»çº¿æœåŠ¡å™¨ï¼Œå“ªæ€•ä»¥æ­£ç‰ˆç”¨æˆ·çš„èº«ä»½ç™»å½•ï¼Œä¹Ÿæ— æ³•è·å–åˆ°è‡ªå·±ä¸Šä¼ çš„çš®è‚¤ï¼›ç”±äºæŠ€æœ¯é—®é¢˜ï¼Œéƒ¨åˆ† Minecraft å¯åŠ¨å™¨ä¹Ÿæ— æ³•ä¿®æ”¹é«˜ç‰ˆæœ¬å®¢æˆ·ç«¯çš„ç©å®¶çš®è‚¤ã€‚å¤§å®¶ç™»å…¥æœåŠ¡å™¨å‘ç°å½¼æ­¤éƒ½æ˜¯ N-wordï¼Œå®åœ¨ä¸èƒ½å¸¦æ¥æ„‰å¿«çš„è§†è§‰ä½“éªŒã€‚

æœåŠ¡ç«¯æ¨¡ç»„ [Fabric Tailor](https://modrinth.com/mod/fabrictailor) å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒå‘æ¸¸æˆæ·»åŠ äº† `/skin` å‘½ä»¤ï¼Œç©å®¶å¯ä»¥è°ƒç”¨æ­¤å‘½ä»¤å®ç°è‡ªå®šä¹‰æ¢è‚¤ã€‚ä¾‹å¦‚ï¼š

```bash
# è®¾ç½®ä¸ºæŒ‡å®š URL é“¾æ¥å¯¹åº”çš„çš®è‚¤
/skin set URL classic https://s.namemc.com/i/b80558ff4b834410.png # ç»å…¸èº«æ
/skin set URL slim https://s.namemc.com/i/b80558ff4b834410.png # çº¤ç»†èº«æ

# è®¾ç½®ä¸ºæŒ‡å®šæ­£ç‰ˆç”¨æˆ·ä¸Šä¼ çš„çš®è‚¤
/skin set player Lolipop0703
```

## æœåŠ¡å™¨è¿ç»´

### é…ç½®æœåŠ¡å™¨

å‚è€ƒ[æ­¤æ–‡æ¡£](https://minecraft.fandom.com/wiki/Server.properties)æŒ‰éœ€ä¿®æ”¹æœåŠ¡å™¨æ ¹ç›®å½•ä¸‹çš„ `server.properties` é…ç½®æ–‡ä»¶ã€‚

å…¶ä¸­å€¼å¾—ä¸€æçš„æœ‰ï¼š

- `motd`ï¼šæœåŠ¡å™¨æè¿°ä¿¡æ¯ï¼Œåœ¨æœåŠ¡å™¨åˆ—è¡¨å±•ç¤ºã€‚å¯ä»¥é€šè¿‡è¿™ä¸ª[å°å·¥å…·](https://minecraft.tools/en/motd.php?motd)ç”Ÿæˆä¸é¢„è§ˆã€‚
- `online-mode`ï¼šå¦‚æœä½ æœ‰å¹¶æ²¡æœ‰è´­ä¹°æ­£ç‰ˆ Minecraft çš„æœ‹å‹ï¼Œå¯è®¾ç½®ä¸º `false` æ¥å…è®¸ä»–ä»¬è¿›å…¥æœåŠ¡å™¨ã€‚
- `spawn-protection`ï¼šå‡ºç”Ÿç‚¹æ–¹å—ä¿æŠ¤ï¼Œé»˜è®¤å€¼ä¸º `16`ï¼Œä¿æŠ¤ä»¥å‡ºç”Ÿç‚¹ä¸ºä¸­å¿ƒçš„ `2 * 16 + 1 = 33` å—æ–¹æ ¼ã€‚å¯ä»¥è®¾ç½®å°ä¸€ç‚¹ï¼Œé¿å…æœ‹å‹ä»¬å› ç ´åä¸äº†æ–¹å—å¯¼è‡´çš„å›°æƒ‘ã€‚å½“ç„¶ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ç®¡ç†å‘˜ï¼Œè¿™ä¸ªé€‰é¡¹ä¼šè‡ªåŠ¨è¢«ç¦ç”¨ã€‚

æ­¤å¤–ï¼Œå°†è‡ªå®šä¹‰çš„æœåŠ¡å™¨å›¾æ ‡ä¿å­˜åˆ°æœåŠ¡å™¨æ ¹ç›®å½•ï¼Œå‘½åä¸º `server-icon.png`ï¼Œå³å¯åœ¨æœåŠ¡å™¨åˆ—è¡¨å±•ç¤ºã€‚

### æœåŠ¡å™¨çŠ¶æ€å¡ç‰‡

&lt;img
  alt=&quot;Minecraft æœåŠ¡å™¨çŠ¶æ€&quot;
  src=&quot;https://mcapi.us/server/image?ip=mc.towind.fun&quot;
/&gt;

ä¸€äº›å¼€æ”¾æœåŠ¡å¯ä»¥ç”¨æ¥æŸ¥è¯¢ Minecraft æœåŠ¡å™¨çŠ¶æ€ï¼Œå¹¶ç”Ÿæˆç±»ä¼¼ä¸Šé¢è¿™æ ·çš„å¡ç‰‡ã€‚æƒ³è¦ç”ŸæˆåŒæ ·çš„å¡ç‰‡ï¼Ÿè®¿é—® [MCApi.us](https://mcapi.us) äº†è§£æ›´å¤šã€‚

### é€šè¿‡åŸŸåè¿æ¥åˆ°æœåŠ¡å™¨

å‡è®¾æ‚¨å·²æ‹¥æœ‰ä¸€ä¸ªåŸŸåå¹¶é€šè¿‡ DNS æœåŠ¡å•†è§£æåˆ°äº†æœåŠ¡å™¨ï¼Œé‚£ä¹ˆè¿æ¥æœåŠ¡å™¨æ—¶ä¸å†éœ€è¦å¡«å†™æœåŠ¡å™¨çš„å…¬ç½‘ IP åœ°å€ï¼Œä½¿ç”¨åŸŸåå°±è¡Œã€‚

ç¬”è€…çš„æœåŠ¡å™¨å°±å¯ä»¥é€šè¿‡åŸŸå `mc.towind.fun` è¿æ¥ï¼ŒMinecraft å®¢æˆ·ç«¯å°†æŸ¥è¯¢åˆ°åŸŸåèƒŒåçš„ IP åœ°å€ï¼Œè®¿é—®å…¶ 25565 ç«¯å£ã€‚

å‡è®¾æ‚¨è¿˜å®‰è£…å’Œé…ç½®å¥½äº† Nginx æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥å°†æœåŠ¡å™¨åœ°å›¾è¿›è¡Œè½¬å‘ã€‚ä¾‹å¦‚ï¼š

```conf
server {
  listen 443 ssl;
  ssl_certificate /path/to/fullchain.pem;
  ssl_certificate_key /path/to/privkey.pem;

  server_name mc.towind.fun;

  location /map/ {
    proxy_pass http://127.0.0.1:8123/;
  }
}
```

ç°åœ¨ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦æ”¾è¡Œ 8123 ç«¯å£ï¼ŒæœåŠ¡å™¨åœ°å›¾é€šè¿‡ Nginx ç›‘å¬çš„ 443 ç«¯å£è½¬å‘ï¼Œè®¿é—®é“¾æ¥ https://mc.towind.fun/map å³å¯ã€‚

### æœåŠ¡å™¨å¤‡ä»½

æ—¶å¸¸ Minecraft å¤‡ä»½æœåŠ¡å™¨æ•°æ®å¹¶ä¸Šä¼ åˆ°äº‘ç›˜æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ï¼Œç¬”è€…åœ¨&lt;Link to=&quot;/posts/backup-mc-server&quot;&gt;å¦ä¸€ç¯‡åšå®¢&lt;/Link&gt;é‡Œå®ç°äº†æ•°æ®çš„å®šæ—¶å¤‡ä»½ä¸ä¸Šä¼ ï¼Œä¾›å›å‚è€ƒã€‚
</content:original-text><content:updated-at>2024-07-13T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[åŸºäº SteamCMD éƒ¨ç½²ä¸€ä¸ªç»™æœ‹å‹ä½¿ç”¨çš„é¥¥è’è”æœºç‰ˆæœåŠ¡å™¨]]></title><description><![CDATA[æœ¬æ–‡é‡ç°äº†ç¬”è€…åœ¨è‡ªå·±çš„ CentOS 7 (64-bit) ç³»ç»Ÿä¸­éƒ¨ç½²é¥¥è’è”æœºç‰ˆæœåŠ¡å™¨çš„å…¨è¿‡ç¨‹ï¼Œä¾›å›å‚è€ƒã€‚ Steam ç‰ˆçš„é¥¥è’è”æœºç‰ˆä¸ Wegame ç‰ˆæ•°æ®ä¸äº’é€šï¼Œä¹Ÿæ— æ³•ç›¸äº’è”æœºã€‚

ç¬”è€…ä¸»è¦å‚è€ƒäº†å¦‚ä¸‹ä¸¤ä¸ªéƒ¨ç½²æ•™ç¨‹ï¼š

Guides/Donâ€™t Starve Together Dedicated Servers How to setup dedicated server with cave onâ€¦]]></description><link>https://blog.towind.fun/posts/run-dont-starve-server</link><guid isPermaLink="false">run-dont-starve-server</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Tue, 02 Jul 2024 00:00:00 GMT</pubDate><content:original-text>
æœ¬æ–‡é‡ç°äº†ç¬”è€…åœ¨è‡ªå·±çš„ CentOS 7 (64-bit) ç³»ç»Ÿä¸­éƒ¨ç½²é¥¥è’è”æœºç‰ˆæœåŠ¡å™¨çš„å…¨è¿‡ç¨‹ï¼Œä¾›å›å‚è€ƒã€‚

Steam ç‰ˆçš„é¥¥è’è”æœºç‰ˆä¸ Wegame ç‰ˆæ•°æ®ä¸äº’é€šï¼Œä¹Ÿæ— æ³•ç›¸äº’è”æœºã€‚

ç¬”è€…ä¸»è¦å‚è€ƒäº†å¦‚ä¸‹ä¸¤ä¸ªéƒ¨ç½²æ•™ç¨‹ï¼š

- [Guides/Donâ€™t Starve Together Dedicated Servers](https://dontstarve.fandom.com/wiki/Guides/Don%E2%80%99t_Starve_Together_Dedicated_Servers)
- [How to setup dedicated server with cave on Linux](https://steamcommunity.com/sharedfiles/filedetails/?id=590565473)

## å®‰è£… `steamcmd`

å®‰è£…çš„æ­¥éª¤å¯ä»¥ç›´æ¥å‚è€ƒ SteamCMD çš„[å®˜æ–¹æ–‡æ¡£](https://developer.valvesoftware.com/wiki/SteamCMD)ï¼ˆ[ä¸­æ–‡ç‰ˆ](https://developer.valvesoftware.com/w/index.php?title=SteamCMD:zh-cn&amp;uselang=zh)ï¼‰ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSteamCMD ä»…æä¾› 32 ä½äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å¦‚æœæ‚¨çš„ç³»ç»Ÿä»…èƒ½è¿è¡Œ 64 ä½è¿›ç¨‹ï¼ˆä¾‹å¦‚ OpenWRT ç³»ç»Ÿï¼‰ï¼Œå°†**ä¸èƒ½**æ­£å¸¸ä½¿ç”¨ã€‚

ä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œ`steamcmd` å®˜æ–¹å»ºè®®åˆ›å»ºæ–°çš„ç³»ç»Ÿç”¨æˆ·è¿è¡Œï¼Œè€Œä¸æ˜¯æ‹¥æœ‰æœ€é«˜å‘½ä»¤æƒé™çš„ `root` ç”¨æˆ·ã€‚å› æ­¤ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º `steam` çš„ç”¨æˆ·ï¼š

```bash
# åˆ›å»º steam ç”¨æˆ·
sudo useradd -m steam
# ä¿®æ”¹ steam ç”¨æˆ·ç™»å½•å¯†ç 
sudo passwd steam
```

å¯¹äº 64 ä½ç³»ç»Ÿï¼Œéœ€è¦å®‰è£…å¦‚ä¸‹çš„å¿…è¦ä¾èµ–ä»¥è¿è¡Œ `steamcmd`ï¼š

```bash
yum -y install glibc.i686 libstdc++.i686
```

åˆ‡æ¢è‡³ `steam` ç”¨æˆ·ï¼š

```bash
su - steam
```

å®‰è£… `steamcmd`ï¼š

```bash
cd ~
curl -sqL &quot;https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz&quot; | tar zxvf -
```

è¿è¡Œ `steamcmd`ï¼š

```bash
/home/steam/steamcmd.sh
```

è€å¿ƒç­‰å¾…æ›´æ–°æ–‡ä»¶ä¸‹è½½ã€å®‰è£…å®Œæ¯•â€¦â€¦

## å®‰è£…é¥¥è’è”æœºç‰ˆ

å®‰è£…é¥¥è’è”æœºç‰ˆè¿è¡Œçš„å¿…è¦ä¾èµ–ï¼š

```bash
yum -y install libcurl.i686
ln -s /usr/lib/libcurl.so.4 /usr/lib/libcurl-gnutls.so.4
```

è®¾ç½®é¥¥è’è”æœºç‰ˆå®‰è£…ç›®å½•ï¼š

```bash
Steam&gt; force_install_dir /home/steam/steamapps/DST
```

åŒ¿åç™»å½•åˆ° `steamcmd`ï¼š

```bash
Steam&gt; login anonymous
```

å®‰è£…é¥¥è’è”æœºç‰ˆï¼š

```bash
Steam&gt; app_update 343050 validate
```

æµ‹è¯•é¥¥è’è”æœºç‰ˆçš„è¿è¡Œã€‚ç‰¹åˆ«çš„ï¼Œç”±äºç›¸å¯¹è·¯å¾„çš„ç¼˜æ•…ï¼Œæ‰§è¡Œ `dontstarve_dedicated_server_nullrenderer` å‰ä¸€å®šè¦å…ˆç§»åŠ¨åˆ°å®ƒæ‰€åœ¨çš„ç›®å½•ï¼š

```bash
cd /home/steam/steamapps/DST/bin
./dontstarve_dedicated_server_nullrenderer
```

å¦‚æœæ²¡æœ‰å…¶å®ƒçš„æŠ¥é”™ï¼Œé‚£ä¹ˆæ‰“å°å†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š

```plaintext
$ ./dontstarve_dedicated_server_nullrenderer
./dontstarve_dedicated_server_nullrenderer: /lib/libcurl-gnutls.so.4: no version information available (required by ./dontstarve_dedicated_server_nullrenderer)
[00:00:00]: PersistRootStorage is now /home/steam/.klei//DoNotStarveTogether/Cluster_1/Master/
[00:00:00]: Starting Up
[00:00:00]: Version: 617969
[00:00:00]: Current time: Tue Jul  2 18:22:40 2024

[00:00:00]: System Name: Linux
[00:00:00]: Host Name: iZ2vc17uca9zl48iicx7ojZ
[00:00:00]: Release(Kernel) Version: 3.10.0-1160.108.1.el7.x86_64
[00:00:00]: Kernel Build Timestamp: #1 SMP Thu Jan 25 16:17:31 UTC 2024
[00:00:00]: Machine Arch: x86_64
[00:00:00]: Don&apos;t Starve Together: 617969 LINUX
[00:00:00]: Build Date: 9567
[00:00:00]: Mode: 32-bit
...
```

æ­¤æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºå­˜æ¡£ç›®å½• `/home/steam/.klei/DoNotStarveTogether/Cluster_1`ï¼Œå¦‚æœåç»­ä¸å†éœ€è¦å¯ç›´æ¥åˆ é™¤ã€‚

## æ·»åŠ é¥¥è’è”æœºç‰ˆæœåŠ¡å™¨ç®¡ç†è„šæœ¬

`screen` å‘½ä»¤å¯ä»¥ç”¨æ¥åˆ›å»ºç‹¬ç«‹çš„å‘½ä»¤è¡Œçª—å£æ‰§è¡Œè¿›ç¨‹ï¼Œæ–¹ä¾¿å¯¹è¿›ç¨‹çš„ç®¡ç†ï¼Œä¾‹å¦‚è¿½è¸ªè¿è¡Œçš„æ—¥å¿—ä¿¡æ¯ã€‚ç¬”è€…é€‰ç”¨å®ƒæ¥ç®¡ç†é¥¥è’è”æœºç‰ˆæœåŠ¡å™¨çš„è¿›ç¨‹ã€‚

```bash
yum install -y screen
```

é¦–å…ˆåˆ›å»ºå­˜æ”¾è„šæœ¬çš„æ–‡ä»¶å¤¹ï¼š

```bash
mkdir /home/steam/scripts
```

ä¸‹é¢å¼€å§‹ç¼–å†™ç®¡ç†æœåŠ¡å™¨è¿‡ç¨‹ä¸­æœ€å¸¸ç”¨çš„ä¸¤ä¸ªè„šæœ¬ã€‚

### è‡ªåŠ¨æ›´æ–°è„šæœ¬

åˆ›å»ºè‡ªåŠ¨æ›´æ–°é¥¥è’è”æœºç‰ˆçš„è„šæœ¬ `/home/steam/scripts/update_dst.sh`ï¼Œç¼–å†™å†…å®¹å¦‚ä¸‹ï¼š

```sh
#!/bin/sh

# æ›´æ–°é¥¥è’è”æœºç‰ˆ
cd /home/steam
./steamcmd.sh +@ShutdownOnFailedCommand 1 +@NoPromptForPassword 1 +force_install_dir /home/steam/steamapps/DST +login anonymous +app_update 343050 validate +quit

# æ›´æ–°å·²å®‰è£…çš„æ¨¡ç»„
cd /home/steam/steamapps/DST/bin
./dontstarve_dedicated_server_nullrenderer -cluster CustomSaveName -only_update_server_mods
```

å…¶ä¸­ `CustomSaveName` ä¸ºæ‚¨çš„å­˜æ¡£ç›®å½•åç§°ï¼Œå¯è‡ªå®šä¹‰ä¿®æ”¹ï¼Œå¦‚ä¸é…ç½®å°†é»˜è®¤ä½¿ç”¨ `Cluster_1`ã€‚

æ·»åŠ è„šæœ¬çš„æ‰§è¡Œæƒé™ï¼Œåç•¥ï¼š

```bash
chmod +x /home/steam/scripts/update_dst.sh
```

### å¯åŠ¨ï¼ˆé‡å¯ï¼‰æœåŠ¡å™¨è„šæœ¬

åˆ›å»ºå¯åŠ¨ï¼ˆé‡å¯ï¼‰é¥¥è’è”æœºç‰ˆæœåŠ¡å™¨çš„è„šæœ¬ `/home/steam/scripts/start_dst.sh`ï¼Œç¼–å†™å†…å®¹å¦‚ä¸‹ï¼š

```sh
#!/bin/sh

# ä¿å­˜æœåŠ¡å™¨æ•°æ®å¹¶é€€å‡º
screen -S dst_master -X stuff $&apos;c_shutdown()\n&apos;
screen -S dst_caves -X stuff $&apos;c_shutdown()\n&apos;

# æ›´æ–°é¥¥è’è”æœºç‰ˆ
/home/steam/scripts/update_dst.sh

cd /home/steam/steamapps/DST/bin
# å¯åŠ¨åœ°ä¸Šä¸–ç•ŒæœåŠ¡å™¨
screen -dmS dst_master ./dontstarve_dedicated_server_nullrenderer -cluster CustomSaveName -console -shard Master
# å¯åŠ¨æ´ç©´ä¸–ç•ŒæœåŠ¡å™¨
screen -dmS dst_caves ./dontstarve_dedicated_server_nullrenderer -cluster CustomSaveName -console -shard Caves
```

è„šæœ¬å°†è‡ªåŠ¨ä¿å­˜æœåŠ¡å™¨æ•°æ®ï¼ˆå¦‚æœä¸ä½¿ç”¨ `c_shutdown()` è€Œç›´æ¥å…³é—­ Screen çš„è¯ï¼Œå°†ä¸¢å¤±åº¦è¿‡é»‘å¤œå‰æœªä¿å­˜çš„æ‰€æœ‰æ•°æ®ï¼‰ï¼Œæ£€æŸ¥å¹¶å®‰è£…é¥¥è’è”æœºç‰ˆæ›´æ–°åŒ…ï¼Œæœ€åé‡æ–°å¯åŠ¨æœåŠ¡å™¨ã€‚

æœåŠ¡å™¨å¯åŠ¨åï¼Œæ‰§è¡Œå‘½ä»¤ `screen -r dst_master` æˆ– `screen -r dst_caves` æŸ¥çœ‹æ—¥å¿—ï¼Œæ‚¨ä¼šå‘ç°æ‰“å°æœ‰å¦‚ä¸‹å†…å®¹ï¼š

```plaintext
[00:00:05]: [200] Account Failed (6): &quot;E_INVALID_TOKEN&quot;
[00:00:05]: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[00:00:05]: !!!! Your Server Will Not Start !!!!
[00:00:05]: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
[00:00:05]: No auth token could be found.
[00:00:05]: Please visit https://accounts.klei.com/account/game/servers?game=DontStarveTogether
[00:00:05]: to generate server configuration files
```

è¿™æ„å‘³ç€æˆ‘ä»¬æœ€åè¿˜éœ€è¦é…ç½® Auth Token ç­‰ä¿¡æ¯ï¼Œä½¿å¾—æœåŠ¡å™¨èƒ½æ­£ç¡®åœ°æ³¨å†Œå¹¶è¢«è”æœºç”¨æˆ·å‘ç°ã€‚

## æ­£å¼å¯åŠ¨é¥¥è’è”æœºç‰ˆæœåŠ¡å™¨

è®¿é—® https://accounts.klei.com/account/game/servers?game=DontStarveTogetherï¼Œåˆ›å»ºä¸€ä¸ªé¥¥è’è”æœºç‰ˆæœåŠ¡å™¨å¹¶è·å– Auth Tokenï¼š

![åˆ›å»ºæœåŠ¡å™¨](./run-dont-starve-server/add-new-server.png)

å¡«å†™åŸºæœ¬çš„é…ç½®ä¿¡æ¯ï¼š

![é…ç½®æœåŠ¡å™¨](./run-dont-starve-server/configure-server.png)

ä¸‹è½½è®¾ç½®å¹¶ä¸Šä¼ åˆ°ä¸»æœºï¼Œå°†è§£å‹åçš„æ–‡ä»¶æ”¾ç½®åˆ°å­˜æ¡£ç›®å½•ï¼š

```bash
unzip DST_Lolipop.zip
mv MyDediServer /home/steam/.klei/DoNotStarveTogether/CustomSaveName

# å¦‚æœä½¿ç”¨äº† root ç”¨æˆ·è§£å‹ï¼Œåˆ«å¿˜äº†ä¿®æ”¹æ–‡ä»¶å¤¹æ‰€æœ‰æƒ
# chown -R steam /home/steam/.klei/DoNotStarveTogether/CustomSaveName
```

æœ€åçš„æœ€åï¼Œæ‰§è¡Œå‰é¢ç¼–å†™çš„å¯åŠ¨è„šæœ¬ï¼š

```bash
/home/steam/scripts/start_dst.sh
```

åœ¨æ¸¸æˆå¤§å…é‡Œæœç´¢æœåŠ¡å™¨ï¼Œå¼€å§‹æ„‰å¿«åœ°ç©è€å§ï¼

![æœç´¢æœåŠ¡å™¨](./run-dont-starve-server/search-server.png)

## é¥¥è’è”æœºç‰ˆæœåŠ¡å™¨è¿ç»´

### æ·»åŠ æ¨¡ç»„

åœ¨é¥¥è’è”æœºç‰ˆæœåŠ¡å™¨æ·»åŠ å¹¶å¯ç”¨æ¨¡ç»„ï¼Œéœ€é…ç½®ä¸¤éƒ¨åˆ†å†…å®¹ã€‚

#### ä¸‹è½½æ¨¡ç»„

ç¬¬ä¸€éƒ¨åˆ†æ˜¯å‘Šè¯‰æœåŠ¡å™¨è¦ä¸‹è½½å“ªäº›æ¨¡ç»„ã€‚ç¼–è¾‘ `/home/steam/steamapps/DST/mods/dedicated_server_mods_setup.lua`ï¼Œä½¿ç”¨æŒ‡ä»¤ `ServerModSetup()` æˆ– `ServerModCollectionSetup()` æ·»åŠ éœ€è¦ä¸‹è½½çš„æ¨¡ç»„ï¼Œä¾‹å¦‚ï¼š

```lua
-- /home/steam/steamapps/DST/mods/dedicated_server_mods_setup.lua
ServerModSetup(&quot;345692228&quot;)
ServerModCollectionSetup(&quot;3286974182&quot;)
```

é€šè¿‡ä¸Šé¢çš„é…ç½®ï¼ŒæœåŠ¡å™¨å°†è‡ªåŠ¨ä¸‹è½½ Steam åˆ›æ„å·¥åŠä¸Šçš„æ¨¡ç»„ [#345692228](https://steamcommunity.com/sharedfiles/filedetails/?id=345692228)ï¼Œä»¥åŠæ¨¡ç»„é›†åˆ [#3286974182](https://steamcommunity.com/sharedfiles/filedetails/?id=3286974182) ä¸­çš„æ‰€æœ‰æ¨¡ç»„ã€‚

ç”±äºæ¯æ¬¡æ‰§è¡Œ `steamcmd.sh` å‘½ä»¤æ£€æŸ¥æ¸¸æˆæ›´æ–°åä¼šé‡ç½® `dedicated_server_mods_setup.lua`ï¼Œå»ºè®®æ‰‹åŠ¨å¤‡ä»½è¯¥æ–‡ä»¶ï¼Œè¿™æ ·çš„è¯æœªæ¥å¢åˆ æ¨¡ç»„æ—¶å¯ä»¥ç›´æ¥å¤ç”¨ã€‚ä¾‹å¦‚ï¼š

```bash
cp dedicated_server_mods_setup.lua dedicated_server_mods_setup.temp.lua
```

ä¼˜åŒ–å‰é¢æˆ‘ä»¬ç¼–å†™çš„æ›´æ–°æœåŠ¡å™¨è„šæœ¬ `/home/steam/scripts/update_dst.sh`ï¼Œåœ¨æ£€æŸ¥æ¸¸æˆæ›´æ–°ä¹‹åè¿˜åŸå¤‡ä»½æ–‡ä»¶ï¼š

```bash
cd /home/steam
./steamcmd.sh +@ShutdownOnFailedCommand 1 +@NoPromptForPassword 1 +force_install_dir /home/steam/steamapps/DST +login anonymous +app_update 343050 validate +quit

# è¿˜åŸå¤‡ä»½æ–‡ä»¶
cd /home/steam/steamapps/DST/mods
cp dedicated_server_mods_setup.temp.lua dedicated_server_mods_setup.lua

cd /home/steam/steamapps/DST/bin
./dontstarve_dedicated_server_nullrenderer -cluster CustomSaveName -only_update_server_mods
```

#### å¯ç”¨æ¨¡ç»„

ç¬¬äºŒéƒ¨åˆ†æ˜¯å‘Šè¯‰æœåŠ¡å™¨è¦å¯ç”¨å“ªäº›æ¨¡ç»„ã€‚æœ‰ä¸¤ç§é…ç½®æ–¹å¼ï¼Œé€‰æ‹©å…¶ä¸€å³å¯ï¼š

1. `/home/steam/.klei/DoNotStarveTogether/CustomSaveName/Caves/modoverrides.lua` ç”¨äºç®¡ç†æ´ç©´ä¸–ç•Œæ¨¡ç»„çš„å¯ç”¨ä¸é…ç½®ï¼›`/home/steam/.klei/DoNotStarveTogether/CustomSaveName/Master/modoverrides.lua` ç”¨äºç®¡ç†åœ°ä¸Šä¸–ç•Œæ¨¡ç»„çš„å¯ç”¨ä¸é…ç½®ã€‚
2. `/home/steam/steamapps/DST/mods/modsettings.lua` ç”¨äºç®¡ç†æ¨¡ç»„çš„å¯ç”¨ã€‚éœ€ç•™æ„çš„æ˜¯ï¼š1ï¼‰æœ¬æ–¹å¼é€šå¸¸ç”¨äºæ¨¡ç»„çš„å¼€å‘è°ƒè¯•ï¼›2ï¼‰ä¸èƒ½å¯¹æ¨¡ç»„è¿›è¡Œè¯¦ç»†è®¾ç½®ï¼Œæ¨¡ç»„å°†å§‹ç»ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼›3ï¼‰ä½¿ç”¨éƒ¨åˆ†æ¨¡ç»„æ—¶å¯èƒ½ä¼šæŠ¥é”™ï¼Œæ­¤æ—¶è¯·åˆ‡æ¢ä¸ºç¬¬ä¸€ç§é…ç½®æ–¹æ³•ã€‚

ç¬”è€…é€‰ç”¨ç¬¬ä¸€ç§é…ç½®æ–¹æ³•ï¼Œæ–°å»ºæ–‡ä»¶ `modoverrides.lua`ï¼Œç¼–å†™å†…å®¹å¦‚ä¸‹ï¼š

```lua
-- modoverrides.lua
return {
    [&quot;workshop-345692228&quot;] = { enabled = true },
    [&quot;workshop-xxxxxxxxx&quot;] = { enabled = true }
}
```

éœ€æ³¨æ„çš„æ˜¯ï¼Œ`modoverrides.lua` ä¸æ”¯æŒä¸€é”®å¯ç”¨æŸä¸ªæ¨¡ç»„åˆé›†çš„æ‰€æœ‰æ¨¡ç»„ï¼Œè¿˜æ˜¯éœ€è¦è·å–è¿™äº›æ¨¡ç»„çš„ç¼–å·å¹¶ç¼–å†™é…ç½®ã€‚

æ·»åŠ å¯æ‰§è¡Œæƒé™å¹¶æ‹·è´åˆ°å¯¹åº”ç›®å½•ï¼š

```bash
chmod +x modoverrides.lua
cp modoverrides.lua /home/steam/.klei/DoNotStarveTogether/CustomSaveName/Caves/
cp modoverrides.lua /home/steam/.klei/DoNotStarveTogether/CustomSaveName/Master/
```

æ‰§è¡Œè„šæœ¬ `/home/steam/scripts/start_dst.sh` é‡å¯æœåŠ¡å™¨å³å¯ã€‚

![æœåŠ¡å™¨æ¨¡ç»„](./run-dont-starve-server/server-with-mods.png)

### è‡ªå®šä¹‰ä¸–ç•Œ

ç¬”è€…å»ºè®®åœ¨ç”µè„‘ä¸Šæ‰‹åŠ¨å¯åŠ¨ä¸€ä¸ªè‡ªå®šä¹‰å¥½çš„ä¸–ç•Œï¼Œå†å°†ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ `worldgenoverride.lua` å’Œ `leveldataoverride.lua` åˆ†åˆ«ç²˜è´´åˆ°æœåŠ¡å™¨çš„å¯¹åº”æ–‡ä»¶å¤¹é‡Œã€‚åœ°ä¸Šä¸–ç•Œå’Œæ´ç©´ä¸–ç•Œçš„é…ç½®æ–‡ä»¶æœ‰æ‰€åŒºåˆ«ï¼Œä¸è¦ææ··å–½ï¼š

- `/home/steam/.klei/DoNotStarveTogether/CustomSaveName/Caves/leveldataoverride.lua`
- `/home/steam/.klei/DoNotStarveTogether/CustomSaveName/Caves/worldgenoverride.lua`
- `/home/steam/.klei/DoNotStarveTogether/CustomSaveName/Master/leveldataoverride.lua`
- `/home/steam/.klei/DoNotStarveTogether/CustomSaveName/Master/worldgenoverride.lua`

å…¶ä¸­ï¼Œ`worldgenoverride.lua` æ˜¯ä¸–ç•Œç”Ÿæˆè§„åˆ™ï¼Œä¿®æ”¹åéœ€è¦é‡æ–°ç”Ÿæˆä¸–ç•Œæ‰èƒ½ç”Ÿæ•ˆã€‚

### è¿›ä¸€æ­¥é…ç½®æœåŠ¡å™¨

ä¹‹å‰æ­¥éª¤ä¸­ä¸‹è½½çš„åŸºæœ¬é…ç½®å·²è¶³å¤Ÿæ”¯æŒæ­£å¸¸æ¸¸ç©ã€‚å¦‚æœè¿˜æƒ³è¦æ›´æ·±åº¦çš„å®šåˆ¶ï¼Œå¯ä»¥å‚è€ƒ[æ­¤æ–‡æ¡£](https://steamcommunity.com/sharedfiles/filedetails/?id=1616647350)ï¼ŒæŒ‰éœ€ä¿®æ”¹ä»¥ä¸‹ä¸‰ä¸ªæ–‡ä»¶ï¼š

- `/home/steam/.klei/DoNotStarveTogether/CustomSaveName/cluster.ini`
- `/home/steam/.klei/DoNotStarveTogether/CustomSaveName/Caves/server.ini`
- `/home/steam/.klei/DoNotStarveTogether/CustomSaveName/Master/server.ini`

### å®šæ—¶é‡å¯å¹¶æ›´æ–°æœåŠ¡å™¨

å¯ä»¥ä½¿ç”¨ `crontab` å‘½ä»¤å®ç°ï¼Œä½†é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ–°å»ºçš„ `steam` ç”¨æˆ·æ˜¯æ²¡æœ‰ä½¿ç”¨è¯¥å‘½ä»¤çš„æƒé™çš„ï¼Œéœ€è¦é¦–å…ˆåˆ‡åˆ°ç®¡ç†å‘˜ç”¨æˆ·æ·»åŠ æƒé™ï¼š

```bash
echo steam &gt;&gt; /etc/cron.allow
```

åˆ‡å› `steam` ç”¨æˆ·ï¼Œç¼–è¾‘è®¡åˆ’ä»»åŠ¡ `crontab -e`ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```plaintext
0 6 * * * /home/steam/scripts/start_dst.sh
```

ä¸Šé¢çš„é…ç½®è¡¨ç¤ºï¼Œåœ¨ç³»ç»Ÿæ—¶é—´æ¯å¤©å‡Œæ™¨ 6 ç‚¹æ•´ï¼Œè‡ªåŠ¨é‡å¯å¹¶æ›´æ–°é¥¥è’è”æœºç‰ˆæœåŠ¡å™¨ã€‚
</content:original-text><content:updated-at>2024-07-18T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[ä½¿ç”¨ Nginx æ²»ç†æˆ‘çš„æœåŠ¡]]></title><description><![CDATA[è¿™äº›å¤©åœ¨é˜¿é‡Œäº‘çš„ ECS æœåŠ¡å™¨ä¸Šæ£é¼“è‡ªå·±çš„ä¸œè¥¿ï¼Œé€šè¿‡ Nginx è½¬å‘è¯·æ±‚ï¼Œå…è®¸ä»¥åŸŸåçš„æ–¹å¼è®¿é—®åˆ°ç¬”è€…å¼€è®¾çš„ä¸åŒç«™ç‚¹ã€æœåŠ¡ã€‚ ç¬”è€…æ’°å†™æœ¬ç¯‡æ–‡ç« ï¼Œæ™’æ™’åœ¨æœåŠ¡å™¨ä¸Šéƒ½åšäº†å“ªäº›å·¥ä½œï¼Œä¹Ÿå¸Œæœ›èƒ½ä¸ºæ‚¨æä¾›ä¸€äº›å¯å‘ã€‚

å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Nginx

ç¬”è€…ä½¿ç”¨çš„æœåŠ¡å™¨ä¸º CentOS 7 ç³»ç»Ÿï¼Œé»˜è®¤çš„ yum æºä¸­åŒ…å«çš„ Nginx ç‰ˆæœ¬ä¸º ï¼ˆ2021-05-21ï¼‰ã€‚

æ›´æ–° yum æºï¼Œæ·»åŠ  Nginx çš„å®˜æ–¹æºï¼šâ€¦]]></description><link>https://blog.towind.fun/posts/nginx-services</link><guid isPermaLink="false">nginx-services</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Mon, 13 May 2024 00:00:00 GMT</pubDate><content:original-text>
è¿™äº›å¤©åœ¨é˜¿é‡Œäº‘çš„ ECS æœåŠ¡å™¨ä¸Šæ£é¼“è‡ªå·±çš„ä¸œè¥¿ï¼Œé€šè¿‡ Nginx è½¬å‘è¯·æ±‚ï¼Œå…è®¸ä»¥åŸŸåçš„æ–¹å¼è®¿é—®åˆ°ç¬”è€…å¼€è®¾çš„ä¸åŒç«™ç‚¹ã€æœåŠ¡ã€‚

ç¬”è€…æ’°å†™æœ¬ç¯‡æ–‡ç« ï¼Œæ™’æ™’åœ¨æœåŠ¡å™¨ä¸Šéƒ½åšäº†å“ªäº›å·¥ä½œï¼Œä¹Ÿå¸Œæœ›èƒ½ä¸ºæ‚¨æä¾›ä¸€äº›å¯å‘ã€‚

## å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Nginx

ç¬”è€…ä½¿ç”¨çš„æœåŠ¡å™¨ä¸º CentOS 7 ç³»ç»Ÿï¼Œé»˜è®¤çš„ yum æºä¸­åŒ…å«çš„ Nginx ç‰ˆæœ¬ä¸º `1.20.1`ï¼ˆ2021-05-21ï¼‰ã€‚

æ›´æ–° yum æºï¼Œæ·»åŠ  Nginx çš„å®˜æ–¹æºï¼š

```bash
rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm
```

ç¡®è®¤ Nginx å®˜æ–¹æºæ‹‰å–æˆåŠŸï¼š

```bash
$ yum repolist
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * centos-sclo-rh: mirrors.ustc.edu.cn
 * centos-sclo-sclo: mirrors.ustc.edu.cn
nginx                                                                        | 2.9 kB  00:00:00
nginx/x86_64/primary_db                                                      |  91 kB  00:00:00
repo id                            repo name                                                  status
nginx/x86_64                       nginx repo                                                   338
```

é‡æ–°å®‰è£… Nginxï¼š

```bash
yum install nginx
```

æŸ¥çœ‹å½“å‰çš„ Nginx ç‰ˆæœ¬ï¼š

```bash
$ nginx -v
nginx version: nginx/1.26.0
```

## æä¾›é™æ€å†…å®¹æœåŠ¡

&gt; Web æœåŠ¡å™¨çš„ä¸€ä¸ªé‡è¦ä»»åŠ¡æ˜¯æä¾›æ–‡ä»¶ï¼ˆæ¯”å¦‚å›¾ç‰‡æˆ–è€…é™æ€ HTML é¡µé¢ï¼‰æœåŠ¡ã€‚

### é™æ€ç«™ç‚¹æœåŠ¡

#### éƒ¨ç½²é™æ€ç«™ç‚¹

è¦å¯¹å¤–æä¾›é™æ€ç«™ç‚¹éå¸¸ç®€å•ï¼Œåªéœ€è¦å°†ç«™ç‚¹çš„é™æ€èµ„æºæ”¾ç½®åœ¨æœåŠ¡å™¨ä¸Šï¼Œå†é€šè¿‡ Nginx æš´éœ²å‡ºå»ã€‚

ä¸€ä¸ªç®€å•çš„ä¾‹å­æ˜¯ï¼š

```conf
# /etc/nginx/nginx.conf
http {
  server {
    listen 443 ssl;
    http2 on;

    ssl_certificate /etc/letsencrypt/live/towind.fun/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/towind.fun/privkey.pem;

    server_name towind.fun www.towind.fun blog.towind.fun;
    root /var/www/towind.fun/blog;
  }
}
```

é€šè¿‡ä¸Šé¢çš„é…ç½®ï¼Œç¬”è€…åªéœ€è¦å°†è‡ªå·±åšå®¢çš„é™æ€èµ„æºæ”¾ç½®åœ¨ `/var/www/towind.fun/blog` ç›®å½•ï¼Œå°±å¯ä»¥é€šè¿‡ https://towind.fun ç­‰åŸŸåè®¿é—®åˆ°å•¦ã€‚

å½“ç„¶ï¼Œç¬”è€…ä¸å¸Œæœ›æœ‰è¿™ä¹ˆå¤šä¸ªåŸŸåæ˜¾ç¤ºå®Œå…¨ä¸€æ ·çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®åŸŸåè·³è½¬ï¼Œå°†è¯·æ±‚é‡å®šå‘åˆ°ä¸€ä¸ªåŸŸåä¸Šï¼š

```conf
# /etc/nginx/nginx.conf
http {
  server {
    # ...https configurations
    server_name towind.fun www.towind.fun;
    rewrite ^/(.*)$ https://blog.towind.fun/$1 permanent;
  }
}
```

ç°åœ¨ï¼Œè®¿é—® https://towind.fun å’Œ https://www.towind.fun æ—¶ï¼Œæµè§ˆå™¨å°†è‡ªåŠ¨ 301 é‡å®šå‘åˆ° https://blog.towind.funã€‚

æ­¤å¤–ï¼Œç¬”è€…ä¸ºäº†æ›´å¥½çš„ SEOï¼Œç¼©çŸ­äº†é“¾æ¥çš„çº§æ•°ï¼Œå³ä» `/YYYY/MM/DD/blog-title` -&gt; `/YYYYMMDD/blog-title`ã€‚é‚£ä¹ˆå°±éœ€è¦å°†è¿‡å»è¢«æœç´¢å¼•æ“æ”¶å½•çš„é“¾æ¥ï¼Œé‡å®šå‘åˆ°æ–°çš„é“¾æ¥ï¼Œé¿å…ç”¨æˆ·è®¿é—®åˆ° 404 é¡µé¢ã€‚å¯ä»¥ç¼–å†™é…ç½®å¦‚ä¸‹ï¼š

```conf
# /etc/nginx/nginx.conf
http {
  server {
    # ...https configurations
    server_name blog.towind.fun;
    rewrite &quot;^/(\d{4})/(\d{2})/(\d{2})/(.+)$&quot; /$1$2$3/$4 permanent;
  }
}
```

é€šè¿‡ç®€å•çš„æ­£åˆ™åŒ¹é…å³å¯å®ç°é“¾æ¥é‡å®šå‘ã€‚

#### æŠ½å–é€šç”¨é…ç½®

Nginx é…ç½®ä¸­å­˜åœ¨å¤§é‡é‡å¤çš„å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›å†…å®¹æå–å‡ºæ¥ï¼Œå•ç‹¬æ”¾ç½®åœ¨æŸä¸ªç›®å½•ä¸‹ï¼Œé€šè¿‡ `include` æŒ‡ä»¤å¼•å…¥ã€‚

ä¾‹å¦‚å¯¹äº HTTPS é…ç½®ï¼Œå¯ä»¥æå–ä¸ºï¼š

```conf
# /etc/nginx/conf.shared.d/https.conf
listen 443 ssl;
http2 on;

ssl_certificate /etc/letsencrypt/live/towind.fun/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/towind.fun/privkey.pem;
```

åœ¨éœ€è¦çš„ `server` å—ä¸­å¼•å…¥ï¼š

```conf
# /etc/nginx/nginx.conf
http {
  server {
    include /etc/nginx/conf.shared.d/https.conf;
    server_name blog.towind.fun;
  }
}
```

åˆå¦‚å¸Œæœ›ç”¨æˆ·åœ¨è®¿é—® `http://` æ—¶è‡ªåŠ¨è·³è½¬åˆ° `https://`ï¼Œå¯ä»¥æå–ä¸ºï¼š

```conf
# /etc/nginx/conf.shared.d/http.conf
listen 80;
return 301 https://$http_host$request_uri;
```

åƒè¿™æ ·æŠ½å–å‡ºä¸åŒæœåŠ¡é‡Œé‡å¤çš„é…ç½®ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°é™ä½åç»­çš„ç»´æŠ¤æˆæœ¬ã€‚

#### é™æ€ç«™ç‚¹æŒç»­éƒ¨ç½²

ç”±äºé™æ€ç«™ç‚¹çš„æºç å‡æ‰˜ç®¡åœ¨ Github ä¸Šï¼Œå½“æ–°çš„ä»£ç æäº¤åï¼Œå¸Œæœ›èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°æœåŠ¡å™¨ä¸Šçš„é™æ€èµ„æºå†…å®¹ã€‚ç¬”è€…é€šè¿‡ `crontab` é…ç½®å®šæ—¶ä»»åŠ¡æ¥å®ç°è¿™ä¸ªéœ€æ±‚ï¼š

```bash
0 0,12,18 * * * /path/to/update-blog.sh &gt;&gt; /path/to/update-blog.log 2&gt;&amp;1
```

ä¸Šé¢çš„é…ç½®è¡¨ç¤ºï¼šåœ¨æ¯å¤©çš„ 0, 12, 18 ç‚¹æ•´è‡ªåŠ¨æ‰§è¡Œæ›´æ–°åšå®¢çš„è„šæœ¬ `/path/to/update-blog.sh`ï¼Œæ‰§è¡Œçš„æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯è¾“å‡ºé‡å®šå‘åˆ°æŒ‡å®šæ—¥å¿—æ–‡ä»¶ `/path/to/update-blog.log`ã€‚

è‡³äºæ›´æ–°è„šæœ¬çš„å®ç°åˆ™é¢‡ä¸ºç®€å•ï¼Œå¦‚æœæ„å»ºåçš„é™æ€æ–‡ä»¶å·²ç»å­˜æ”¾åˆ°äº† Github ä»“åº“çš„æŸä¸ªåˆ†æ”¯ï¼Œé‚£ä¹ˆåªéœ€è¦åˆ°æœ¬åœ°çš„ç›®å½•æ‰§è¡Œ `git pull` å‘½ä»¤å³å¯ã€‚ä¾‹å¦‚ï¼š

```bash
# /path/to/update-blog.sh
cd /var/www/towind.fun/blog
git pull
```

å¦‚æœæ²¡æœ‰å­˜æ”¾æ„å»ºåçš„é™æ€æ–‡ä»¶ï¼Œæˆ–æ„å»ºåçš„é™æ€æ–‡ä»¶æ— æ³•ç›´æ¥ä½¿ç”¨ï¼ˆä¾‹å¦‚ `bashPath` ä¸åŒï¼‰ï¼Œé‚£ä¹ˆé¢å¤–æ‰§è¡Œä¸€æ¬¡æ„å»ºå‘½ä»¤å³å¯ã€‚ä¾‹å¦‚ï¼š

```bash
# /path/to/update-example.sh
cd /path/to/example
git pull
npm run build
```

è€ƒè™‘åˆ°æˆ‘ä»¬ä¸ä¼šåœ¨æœåŠ¡å™¨ä¸Šç¼–å†™ä»£ç å¹¶æ¨é€ï¼Œå¯ä»¥ä½¿ç”¨ HTTPS åè®®çš„è¿œç¨‹åœ°å€ï¼Œè€Œä¸ç”¨ç»è¿‡ SSH éªŒè¯ï¼š

```bash
cd /path/to/example
# Change from git@github.com:username/example.git
git remote set-url origin https://github.com/username/example.git
```

### é™æ€ç«™ç‚¹è®¿é—®æ€§èƒ½ä¼˜åŒ–

é’ˆå¯¹é™æ€ç«™ç‚¹çš„è®¿é—®æ€§èƒ½ä¼˜åŒ–ï¼Œç¬”è€…ä¸»è¦é…ç½®äº† Nginx ä¸­**å‹ç¼©**å’Œ**ç¼“å­˜**ä¸¤éƒ¨åˆ†å†…å®¹ï¼Œå¦å¤–å…³é—­äº†è´Ÿä¼˜åŒ–çš„ Cloudflare CDNã€‚

#### Gzip å‹ç¼©

é…ç½® Nginx å¯ç”¨ `gzip` å‹ç¼©ï¼Œèƒ½å¤Ÿ**æ˜¾è‘—å‡å°‘**å‘é€ç»™å®¢æˆ·ç«¯çš„é™æ€æ–‡ä»¶ä½“ç§¯ã€‚é…ç½®å†…å®¹å¦‚ä¸‹ï¼š

```conf
# /etc/nginx/nginx.conf
http {
  # å¯ç”¨ gzip å‹ç¼©åŠŸèƒ½
  gzip on;
  # å‹ç¼©æ–‡ä»¶çš„æœ€å°å¤§å°ä¸º 10KB
  gzip_min_length 10K;
  # å‹ç¼©ç­‰çº§ä¸º 6ã€‚ç­‰çº§è¶Šä½å‹ç¼©é€Ÿåº¦è¶Šå¿«ï¼Œæ–‡ä»¶å‹ç¼©æ¯”è¶Šå°ï¼›åä¹‹é€Ÿåº¦è¶Šæ…¢ï¼Œå‹ç¼©æ¯”è¶Šå¤§
  gzip_comp_level 6;
  # å‹ç¼©çš„ MIME ç±»å‹
  gzip_types text/plain text/css application/json text/javascript application/javascript application/x-javascript text/xml application/xml application/xml+rss;
}
```

å¯¹äºåŸæ¥ 1151KB çš„è„šæœ¬æ–‡ä»¶ï¼š

```bash
$ ll --block-size=k | grep main.js
-rw-r--r-- 1 root root 1151K main.js
```

å‹ç¼©åå‘é€ç»™å®¢æˆ·ç«¯åªæœ‰ 442KB å¤§å°ï¼Œå‡å°‘äº†å¤§çº¦ 62% çš„ä½“ç§¯ï¼š

![assets-gzip](./nginx-services/assets-gzip.png)

åœ¨å¯ç”¨ `gzip` å‹ç¼©ä¹‹å‰ï¼Œç¬”è€…ä»è®¿é—®è‡ªå·±çš„åšå®¢åˆ°æ–‡ç« å†…å®¹æ˜¾ç¤ºå‡ºæ¥ï¼Œè¦ç­‰å¾…å¤§çº¦ 5 ç§’é’Ÿçš„æ—¶é—´ã€‚è¯´å®è¯ï¼Œè‹¥ä¸æ˜¯è‡ªå·±å®¶çš„ç«™ç‚¹ï¼Œæ—©å·²ä¸è€çƒ¦åœ° `ctrl + w` å…³é—­äº†ã€‚å¦‚ä»Šåªéœ€å¤§çº¦ 2 ç§’é’Ÿçš„æ—¶é—´ï¼Œç»™è®¿é—®ä½“éªŒå¸¦æ¥äº†è´¨çš„æå‡ã€‚

å®é™…è§‚å¯Ÿ Github Pages çš„ç½‘ç»œå“åº”å°±ä¼šå‘ç°ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯çš„è„šæœ¬æˆ–æ ·å¼ç­‰æ–‡ä»¶ä¹Ÿéƒ½ç»è¿‡äº†å‹ç¼©ï¼ˆ`br` ç¼–ç ï¼‰ï¼Œå¯æƒœç¬”è€…åˆ°ç°åœ¨æ‰çŸ¥é“å»é…ç½®ï¼ŒçŸ¥è¯†ç§¯ç´¯çš„é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚

#### Cache-Control ç¼“å­˜

é…ç½® Nginx å¯ç”¨ `Cache-Control` ç¼“å­˜ï¼Œç”±å®¢æˆ·ç«¯æ§åˆ¶æ˜¯å¦ä½¿ç”¨æœ¬åœ°å·²ç¼“å­˜çš„æ–‡ä»¶ã€‚é…ç½®å†…å®¹å¦‚ä¸‹ï¼š

```conf
# /etc/nginx/conf.shared.d/cache.conf
# åå•†ç¼“å­˜éªŒè¯ .html æ–‡ä»¶
location ~* .(html)$ {
  add_header Cache-Control &quot;no-cache&quot;;
}
# ç¼“å­˜ .css, .js æ–‡ä»¶ï¼Œç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º 1 å¤©ï¼Œç¼“å­˜è¿‡æœŸæ—¶ç¡®ä¿è·å–åˆ°æœ€æ–°æ–‡ä»¶
location ~* .(css|js)$ {
  add_header Cache-Control &quot;public, must-revalidate, max-age=86400&quot;;
}
# ç¼“å­˜å›¾ç‰‡ã€è§†é¢‘ç­‰æ–‡ä»¶ï¼Œç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º 1 å¹´ï¼Œä¸å¾—å¯¹æ–‡ä»¶è¿›è¡Œè½¬æ¢
location ~* .(png|jpg|jpeg|gif|ico|svg|mp4|ogg|ogv|webm|htc|xml|woff|gz|zip|7z)$ {
  add_header Cache-Control &quot;public, no-transform, max-age=31536000&quot;;
}
```

#### CDN æœåŠ¡

ç¬”è€…ä½¿ç”¨ Cloudflare ä½œä¸º DNS è§£ææœåŠ¡å™¨ï¼Œä½†è€ƒè™‘åˆ°ç«™ç‚¹é¢å‘çš„ç”¨æˆ·ä¸»è¦æ¥è‡ªä¸­å›½ï¼Œä¸”è®¿é—®é‡ä¸ä¼šå¾ˆå¤§ï¼Œå› æ­¤å…³é—­äº† Cloudflare æä¾›çš„ DNS ä»£ç†æœåŠ¡ã€‚

![cloudflare-cdn-speed-down-for-me](https://i.imgur.com/9H8utju.png)

### é™æ€æ–‡ä»¶æœåŠ¡

ç¬”è€…ä¹Ÿå¯¹å¤–æä¾›çš„é™æ€æ–‡ä»¶ä¸‹è½½çš„æœåŠ¡ï¼Œé…ç½®å½¢å¦‚ï¼š

```conf
# /etc/nginx/conf.d/download.conf
server {
  include /etc/nginx/conf.shared.d/http.conf;
  server_name download.towind.fun;
}

server {
  include /etc/nginx/conf.shared.d/https.conf;
  server_name download.towind.fun;
  root /var/www/towind.fun/download;
  # å…è®¸æµè§ˆé™æ€æ–‡ä»¶ç›®å½•
  autoindex on;
  # æ˜¾ç¤ºé™æ€æ–‡ä»¶å¤§å°
  autoindex_exact_size on;
  # æ˜¾ç¤ºæ–‡ä»¶æ—¶é—´ä¸ºæœåŠ¡å™¨æ—¶é—´
  autoindex_localtime on;
  # è®¾ç½®å­—ç¬¦é›†ä¸º utf-8ï¼Œé¿å…ä¸­æ–‡ä¹±ç 
  charset utf-8;
}
```

ä¸Šé¢çš„é…ç½®è¡¨æ˜ï¼šç¬”è€…å°†å¯¹å¤–æä¾›ä¸‹è½½çš„é™æ€æ–‡ä»¶æ”¾ç½®åœ¨æœåŠ¡å™¨çš„ `/var/www/towind.fun/download` ç›®å½•ä¸‹ï¼›å½“è®¿é—® https://download.towind.fun æ—¶ï¼Œå°±å¯ä»¥çœ‹è§æ‰€æœ‰å¯ä¸‹è½½çš„é™æ€æ–‡ä»¶ã€‚

## æä¾›ä»£ç†æœåŠ¡å™¨

&gt; Nginx çš„ä¸€ä¸ªå¸¸è§ç”¨é€”æ˜¯ä½œä¸ºä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œä½œç”¨æ˜¯æ¥æ”¶è¯·æ±‚å¹¶è½¬å‘ç»™è¢«ä»£ç†çš„æœåŠ¡å™¨ï¼Œä»ä¸­å–å¾—å“åº”ï¼Œå¹¶å°†å…¶å‘é€å›å®¢æˆ·ç«¯ã€‚

### è®¿é—®å†…ç½‘æœåŠ¡

ç¬”è€…å°†ä¸€äº›æœåŠ¡éƒ¨ç½²åœ¨äº†æ²¡æœ‰å…¬ç½‘ IP åœ°å€çš„å†…ç½‘æœåŠ¡å™¨ä¸Šï¼Œä¸ºäº†èƒ½é€šè¿‡åŸŸåè®¿é—®åˆ°è¿™äº›æœåŠ¡ï¼Œé¦–å…ˆä½¿ç”¨äº† frp è¿›è¡Œå†…ç½‘ç©¿é€ï¼šå°†æ‹¥æœ‰å…¬ç½‘ IP åœ°å€çš„æœåŠ¡å™¨ï¼ˆå…¬ç½‘æœåŠ¡å™¨ï¼‰ä½œä¸º frp æœåŠ¡ç«¯ï¼Œå°†å†…ç½‘æœåŠ¡å™¨ä½œä¸º frp å®¢æˆ·ç«¯å³å¯ã€‚

é…ç½® Nginxï¼Œå°†ç‰¹å®šåŸŸåçš„è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„ frp æœåŠ¡ç«¯ç«¯å£ï¼š

```conf
# /etc/nginx/conf.d/xxx.conf
server {
  include /etc/nginx/conf.shared.d/https.conf;
  server_name xxx.towind.fun;
  location = / {
    proxy_pass http://127.0.0.1:15244;
  }
}
```

ä¸Šé¢çš„é…ç½®è¡¨ç¤ºï¼šå½“é€šè¿‡ `https://xxx.towind.fun` è®¿é—®å…¬ç½‘æœåŠ¡å™¨æ—¶ï¼Œè¯·æ±‚å°†è½¬å‘è‡³æœ¬åœ°çš„ 15244 ç«¯å£ï¼Œå†ç»ç”± frp è®¿é—®åˆ°å†…ç½‘æœåŠ¡å™¨ä¸Šå¯¹åº”çš„æœåŠ¡ã€‚

### å†…ç½‘æœåŠ¡è®¿é—®æ€§èƒ½ä¼˜åŒ–

Nginx æä¾›äº†æœåŠ¡ç«¯çš„ Proxy ç¼“å­˜åŠŸèƒ½ï¼Œå¦‚æœä»å†…ç½‘æœåŠ¡å™¨è¿”å›çš„å“åº”å¤´ä¸ŠåŒ…å«ç¼“å­˜æ§åˆ¶çš„ä¿¡æ¯ï¼ŒNginx å°†è‡ªåŠ¨ç¼“å­˜èµ„æºåˆ°å…¬ç½‘æœåŠ¡å™¨ï¼Œè€Œæ— éœ€æ¯æ¬¡éƒ½å»è¯·æ±‚å†…ç½‘æœåŠ¡å™¨ã€‚

æ ¸å¿ƒçš„é…ç½®å†…å®¹å¦‚ä¸‹ï¼š

```conf
# /etc/nginx/nginx.conf
http {
  proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=defaultcache:10m max_size=1g;

  server {
    proxy_cache defaultcache;
    # ï¼ˆéå¿…è¦ï¼‰å“åº”å¤´æ·»åŠ è‡ªå®šä¹‰çš„ Nginx-Proxy-Cache å­—æ®µï¼Œå¦‚æœå€¼ä¸º HIT åˆ™è¡¨ç¤ºå‘½ä¸­äº†å…¬ç½‘æœåŠ¡å™¨æœ¬åœ°çš„ç¼“å­˜
    add_header Nginx-Proxy-Cache $upstream_cache_status;
  }
}
```

ä¸Šé¢çš„é…ç½®è¡¨ç¤ºï¼š

- ç¼“å­˜æ–‡ä»¶ä¿å­˜åœ¨ `/var/cache/nginx` ç›®å½•ã€‚
- ç¼“å­˜æ–‡ä»¶ä½¿ç”¨ 2 çº§ç›®å½•å­˜å‚¨ï¼Œç¬¬ä¸€çº§ç›®å½•åŒ…å«æœ€å¤š 16^1 ä¸ªæ–‡ä»¶å¤¹ï¼Œç¬¬äºŒçº§ç›®å½•åŒ…å«æœ€å¤š 16^2 ä¸ªæ–‡ä»¶å¤¹ã€‚å³æ€»å…±æœ€å¤šåŒ…å« 16^1 \* 16^2 = 4096 ä¸ªæ–‡ä»¶å¤¹ã€‚
- åœ¨å…±äº«å†…å­˜ä¸­è®¾ç½®äº†ä¸€å—åˆ«åä¸º `defaultcache`ï¼Œå¤§å°ä¸º 10MB çš„å­˜å‚¨åŒºåŸŸï¼Œç”¨äºå­˜å‚¨ key å­—ç¬¦ä¸²ã€‚æœ‰åŠ©äº Nginx å¿«é€Ÿåˆ¤æ–­è¯·æ±‚æ˜¯å¦å‘½ä¸­æœ¬åœ°çš„ç¼“å­˜ã€‚
- ç¼“å­˜æ–‡ä»¶å ç”¨çš„æœ€å¤§ç©ºé—´ä¸º 1GBã€‚è¾¾åˆ°é…é¢æ—¶ï¼ŒNginx ä¼šè‡ªåŠ¨åˆ é™¤æ‰ä½¿ç”¨é¢‘ç‡æœ€ä½çš„ç¼“å­˜æ–‡ä»¶ã€‚

è¿™æ ·å¯ä»¥æœ‰æ•ˆé™ä½å†…ç½‘æœåŠ¡å™¨ï¼ˆæºæœåŠ¡å™¨ï¼‰çš„è´Ÿæ‹…ã€‚

ä¸€ä¸ªå‘½ä¸­ Proxy ç¼“å­˜çš„ä¾‹å­å¦‚ä¸‹ï¼š

![assets-gzip](./nginx-services/proxy-cache-hit.png)
</content:original-text><content:updated-at>2024-07-17T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[åŸºäºåŸç”Ÿ Node å¤‡ä»½è½¯è·¯ç”±ä¸Šçš„ Minecraft æœåŠ¡å™¨å­˜æ¡£ï¼Œå¹¶é€šè¿‡ Alist ä¸Šä¼ åˆ°äº‘ç«¯]]></title><description><![CDATA[ç¬”è€…æœ€è¿‘åœ¨ OpenWRT è½¯è·¯ç”±ä¸Šéƒ¨ç½²äº†ä¸€ä¸ª Minecraft æœåŠ¡å™¨ï¼Œå‡ºäºå¯¹æ•°æ®å®‰å…¨çš„ç„¦è™‘ï¼Œäºæ˜¯æŠ˜è…¾äº†ä¸€ä¸‹å­˜æ¡£å¤‡ä»½çš„ç›¸å…³äº‹å®œï¼Œè®°å½•ä¸ºæ­¤æ–‡ã€‚ åœ¨ CurseForge ç­‰æ¨¡ç»„ç«™ä¸Šå·²æœ‰æ–¹ä¾¿å¥½ç”¨çš„ Minecraft æœåŠ¡å™¨å­˜æ¡£å¤‡ä»½æ’ä»¶ï¼Œé™¤éæ‚¨å–œæ¬¢æŠ˜è…¾æˆ–é«˜è‡ªç”±åº¦çš„å®šåˆ¶ï¼Œä¸ç”¨åƒç¬”è€…è¿™æ ·ç¼–å†™ä¸€æ•´ä¸ªè„šæœ¬ã€‚

å®Œæ•´çš„è„šæœ¬å¯è§æ­¤ã€‚

ç¼–å†™å¤‡ä»½è„šæœ¬
å‰ç½®å‡†å¤‡

ä¸ºäº†è„šæœ¬ç¼–å†™æ–¹ä¾¿ï¼Œçº¦å®šåº”è¯¥åœ¨ Minecraftâ€¦]]></description><link>https://blog.towind.fun/posts/backup-mc-server</link><guid isPermaLink="false">backup-mc-server</guid><category><![CDATA[åç«¯å¼€å‘]]></category><pubDate>Sat, 11 May 2024 00:00:00 GMT</pubDate><content:original-text>
ç¬”è€…æœ€è¿‘åœ¨ OpenWRT è½¯è·¯ç”±ä¸Šéƒ¨ç½²äº†ä¸€ä¸ª Minecraft æœåŠ¡å™¨ï¼Œå‡ºäºå¯¹æ•°æ®å®‰å…¨çš„ç„¦è™‘ï¼Œäºæ˜¯æŠ˜è…¾äº†ä¸€ä¸‹å­˜æ¡£å¤‡ä»½çš„ç›¸å…³äº‹å®œï¼Œè®°å½•ä¸ºæ­¤æ–‡ã€‚

åœ¨ CurseForge ç­‰æ¨¡ç»„ç«™ä¸Šå·²æœ‰æ–¹ä¾¿å¥½ç”¨çš„ Minecraft æœåŠ¡å™¨å­˜æ¡£å¤‡ä»½æ’ä»¶ï¼Œé™¤éæ‚¨å–œæ¬¢æŠ˜è…¾æˆ–é«˜è‡ªç”±åº¦çš„å®šåˆ¶ï¼Œä¸ç”¨åƒç¬”è€…è¿™æ ·ç¼–å†™ä¸€æ•´ä¸ªè„šæœ¬ã€‚

å®Œæ•´çš„è„šæœ¬[å¯è§æ­¤](https://github.com/LolipopJ/LolipopJ.github.io/blob/cd9d45af2a97f596ec6b3ada4c069f88a9e9bbd7/source/static/scripts/backup-mc-server.js)ã€‚

## ç¼–å†™å¤‡ä»½è„šæœ¬

### å‰ç½®å‡†å¤‡

ä¸ºäº†è„šæœ¬ç¼–å†™æ–¹ä¾¿ï¼Œçº¦å®šåº”è¯¥åœ¨ Minecraft æœåŠ¡å™¨çš„æ ¹ç›®å½•æ‰§è¡Œè„šæœ¬ã€‚æ ¡éªŒå½“å‰è„šæœ¬çš„æ‰§è¡Œç›®å½•ï¼š

```js
const cwd = process.cwd();
if (!fs.existsSync(path.resolve(cwd, &quot;eula.txt&quot;))) {
  throw new Error(
    &quot;You should execute this script at root dir of MineCraft server where `eula.txt` exists.&quot;,
  );
}
```

æ”¯æŒæŒ‡å®šå¤‡ä»½æ–‡ä»¶å­˜å‚¨çš„ç›®å½• `BACKUP_DIR`ï¼ŒåŒæ—¶ `checkupDir()` ç¡®ä¿ç›®å½•å­˜åœ¨ï¼š

```js
const BACKUP_DIR = &quot;backups&quot;;

const checkupDir = (dir) =&gt; {
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
};

const backupDir = path.resolve(cwd, BACKUP_DIR);
checkupDir(backupDir);
```

### ç”Ÿæˆå¤‡ä»½æ–‡ä»¶

æ”¯æŒæŒ‡å®šå¤‡ä»½æ–‡ä»¶çš„åˆ—è¡¨ï¼Œé™¤äº†æœ€é‡è¦çš„ `world/` ä»¥å¤–ï¼Œè¿˜å¯ä»¥å¤‡ä»½ `server.properties`ã€`world_nether/` å’Œ `world_the_end/` ç­‰æ–‡ä»¶æˆ–ç›®å½•ã€‚

```js
const BACKUP_FILES = [
  &quot;banned-ips.json&quot;,
  &quot;banned-players.json&quot;,
  &quot;config&quot;,
  &quot;mods&quot;,
  &quot;ops.json&quot;,
  &quot;server.properties&quot;,
  &quot;whitelist.json&quot;,
  &quot;world&quot;,
  &quot;world_nether&quot;,
  &quot;world_the_end&quot;,
];

const resolvedBackupFiles = BACKUP_FILES.filter((file) =&gt; {
  if (fs.existsSync(path.resolve(cwd, file))) {
    return true;
  }
  return false;
});
```

åŸç”Ÿ Node å¹¶æ²¡æœ‰æä¾›æ‰“åŒ…å‹ç¼©çš„æ–¹æ³•ï¼Œä¸ºäº†é¿å…å¼•å…¥å…¶å®ƒçš„ä¾èµ–ï¼Œè€ƒè™‘ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ `tar` å‘½ä»¤å®ç°ã€‚ä¸ºæ­¤ï¼Œéœ€è¦ä½¿ç”¨åˆ° Node çš„ `child_process`ï¼š

```js
const child_process = require(&quot;child_process&quot;);
const util = require(&quot;util&quot;);
const exec = util.promisify(child_process.exec);
```

ç°åœ¨ï¼Œå¯ä»¥é€šè¿‡ `exec()` æ¥æ‰§è¡Œç³»ç»Ÿä¸Šçš„å‘½ä»¤äº†ã€‚å¯ç¼–å†™æ–‡ä»¶å¤‡ä»½æ–¹æ³•å¦‚ä¸‹ï¼š

```js
const backupFilename = genFilename(); // çœç•¥æ–‡ä»¶åç”Ÿæˆæ–¹æ³•...
await exec(`tar -czf ${backupFilename} ${resolvedBackupFiles.join(&quot; &quot;)}`);
```

éœ€æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œ `tar` å‘½ä»¤æ—¶ï¼Œå¸¸ä¼ å…¥ `-v` æ ‡è¯†ï¼Œåœ¨å±å¹•ä¸Šæ‰“å°å‹ç¼©æˆ–è§£å‹çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆå¾ˆé…·ï¼‰ã€‚ä½†æ˜¯ï¼Œåœ¨ä½¿ç”¨ `exec()` æ—¶ï¼Œå­è¿›ç¨‹ä¼šå°†å‘½ä»¤çš„æ ‡å‡†è¾“å‡ºæˆ–é”™è¯¯ä¸€å¹¶è¿”å›ï¼Œå¦‚æœæ–‡ä»¶æ•°é‡è¿‡å¤šï¼Œæ ‡å‡†è¾“å‡ºè¶…è¿‡é¢„è®¾å¤§å°ï¼Œä¼šå¯¼è‡´æŠ¥é”™ï¼š`RangeError [ERR_CHILD_PROCESS_STDIO_MAXBUFFER]: stdout maxBuffer length exceeded`ã€‚ç”¨ `child_process.spawn()` å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œä½†è€ƒè™‘åˆ°æˆ‘ä»¬å¹¶ä¸åœ¨ä¹å‹ç¼©å‘½ä»¤çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯å»æ‰ `-v` æ ‡è¯†ã€‚

åˆ°æ­¤ä¸ºæ­¢ï¼Œå·²ç»èƒ½å¤Ÿå°†æ‰€éœ€çš„ Minecraft æœåŠ¡å™¨å­˜æ¡£æ–‡ä»¶æ‰“åŒ…å‹ç¼©ï¼Œå¤‡ä»½åˆ°ç³»ç»Ÿæœ¬åœ°äº†ã€‚

### ç§»é™¤å†å²å¤‡ä»½æ–‡ä»¶

å³ä½¿æ¯å¤©æ‰§è¡Œä¸€æ¬¡å¤‡ä»½ä»»åŠ¡ï¼Œé•¿ä¹…ç´¯ç§¯ä¹Ÿå°†å ç”¨å¤§é‡çš„ç©ºé—´ï¼Œæ›´ä½•å†µä¸€ä¸ªå¤‡ä»½çš„å¤§å°å·²ç„¶å‡ ç™¾ MB èµ·æ­¥ã€‚å› æ­¤éœ€è€ƒè™‘æœ¬åœ°ä¿ç•™çš„å¤‡ä»½æ–‡ä»¶æ•°é‡ï¼ŒåŠæ—¶ç§»é™¤å†å²çš„å¤‡ä»½æ–‡ä»¶ã€‚

é¦–å…ˆéœ€è¦è·å–å¤‡ä»½ç›®å½•ä¸‹å·²æœ‰çš„å¤‡ä»½æ–‡ä»¶ä¿¡æ¯ï¼š

```js
const filenames = fs.readdirSync(backupDir);
const backupFileList = filenames.map((filename) =&gt;
  fs.statSync(path.resolve(backupDir, filename)),
);
```

æ”¯æŒæŒ‡å®šä¿å­˜çš„å¤‡ä»½æ–‡ä»¶æ•°é‡ï¼Œå¾—åˆ°éœ€è¦ç§»é™¤çš„æ–‡ä»¶åˆ—è¡¨ï¼š

```js
const BACKUP_MAX_NUM = 7; // ä¿ç•™æœ€æ–°çš„ N ä¸ªå¤‡ä»½æ–‡ä»¶ï¼Œæ­¤å¤„ä¸º 7 ä¸ª

const backupFiles = backupFileList
  .filter((file) =&gt; file.isFile())
  .sort((a, b) =&gt; {
    return b.mtimeMs - a.mtimeMs;
  });
const oldBackupFiles = backupFiles.slice(BACKUP_MAX_NUM);
```

ç§»é™¤è¿™äº›æ–‡ä»¶å³å¯ï¼š

```js
const oldBackupFilenames = oldBackupFiles.map((file) =&gt; file.name);
oldBackupFilenames.forEach((filename) =&gt; {
  fs.rmSync(path.resolve(backupDir, filename));
});
```

è¿™æ ·åœ¨æ¯æ¬¡æ‰§è¡Œè„šæœ¬æ—¶ï¼Œéƒ½ä¼šè‡ªåŠ¨æ¸…ç†æ‰æœ¬åœ°å¤šä½™çš„å¤‡ä»½æ–‡ä»¶ï¼Œä¿è¯æ–‡ä»¶ç³»ç»Ÿå®¹é‡å¥åº·ã€‚

## è®¾ç½®å®šæ—¶ä»»åŠ¡

åŸºäº `crontab` å®ç°å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼Œä½¿ç”¨ `crontab -e` å‘½ä»¤ç¼–å†™ä»»åŠ¡åˆ—è¡¨ï¼š

```bash
0 4 * * * cd /path/to/mc-server &amp;&amp; node /path/to/backup-mc-server.js
```

ç¬”è€…å‘ç°å®šæ—¶ä»»åŠ¡å®é™…æ‰§è¡Œæ—¶é—´æ˜¯æ­£åˆ 12 ç‚¹ï¼Œè€Œéé¢„æœŸçš„å‡Œæ™¨ 4 ç‚¹ï¼Œæ¨æµ‹ç³»æœåŠ¡å™¨ä½¿ç”¨çš„ UTC æ—¶åŒºå¯¼è‡´ã€‚

å°½ç®¡é…ç½®äº† OpenWRT çš„æ—¶åŒºä¸º `Asia/Shanghai`ï¼Œä½†ä»ç„¶ä¸ç”Ÿæ•ˆï¼š

```bash
$ date -R
Wed, 15 May 2024 07:00:00 +0000
```

ç¬”è€…é€šè¿‡å®‰è£… `zoneinfo-asia` è§£å†³äº†é—®é¢˜ï¼š

```bash
$ opkg update
$ opkg install zoneinfo-asia
Installing zoneinfo-asia (2023c-2) to root...
Downloading https://mirrors.vsean.net/openwrt/releases/23.05.2/packages/x86_64/packages/zoneinfo-asia_2023c-2_x86_64.ipk
Installing zoneinfo-core (2023c-2) to root...
Downloading https://mirrors.vsean.net/openwrt/releases/23.05.2/packages/x86_64/packages/zoneinfo-core_2023c-2_x86_64.ipk
Configuring zoneinfo-core.
Configuring zoneinfo-asia.
$ /etc/init.d/system restart
$ date -R
Wed, 15 May 2024 15:00:00 +0800
```

è¿™æ ·ï¼Œåœ¨åŒ—äº¬æ—¶é—´å‡Œæ™¨ 4 ç‚¹ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è°ƒç”¨å¤‡ä»½è„šæœ¬ã€‚å¦‚æœå½¼æ—¶ä»æœ‰ç”¨æˆ·åœ¨æ¸¸ç©ï¼Œè„šæœ¬å¯èƒ½ä¼šè¿è¡Œå¤±è´¥ï¼Œå¯ä»¥åœ¨æ‰§è¡Œè„šæœ¬ä¹‹å‰å…³é—­ Minecraft æœåŠ¡å™¨ï¼Œå®Œæˆåé‡æ–°å¯åŠ¨ã€‚

## ï¼ˆå¯é€‰ï¼‰é€šè¿‡ Alist ä¸Šä¼ åˆ°äº‘ç«¯

&gt; ä¸ºäº†è¿™ç›˜é†‹ï¼ŒåŒ…äº†è¿™é¡¿é¥ºå­ã€‚

ä¸‡ä¸€ç¡¬ç›˜æŒ‚äº†å‘¢ï¼Ÿç¬”è€…è®¤ä¸ºä¿å­˜åœ¨è½¯è·¯ç”±æœ¬åœ°ä¸æ¯«æ²¡æœ‰å®‰å…¨æ„Ÿï¼Œäºæ˜¯å†³å®šåœ¨å¤‡ä»½åå³æ—¶ä¸Šä¼ åˆ°äº‘ç«¯ã€‚

ç¬”è€…å·²ç»åœ¨è½¯è·¯ç”±ä¸Šå®‰è£…å¹¶é…ç½®å¥½äº† Alistï¼Œè¿æ¥åˆ°äº†è‡ªå·±çš„ OneDriveã€‚ä¸‹é¢å°†è¿›ä¸€æ­¥å®ç°ä¸Šä¼ å¤‡ä»½æ–‡ä»¶åˆ° OneDrive æˆ–ä»»ä½•å…¶ä»–çš„äº‘ç›˜ã€‚

### è·å– Alist token

è°ƒç”¨ Alist æ¥å£æ—¶éœ€è¦ä¼ å…¥ tokenï¼Œå› æ­¤é¦–å…ˆéœ€è¦è·å– tokenï¼š

```js
const ALIST_ADDRESS = &quot;YOUR_ALIST_ADDRESS&quot;;
const ALIST_USERNAME = &quot;YOUR_ALIST_USERNAME&quot;;
const ALIST_PASSWORD = &quot;YOUR_ALIST_PASSWORD&quot;;

const headers = new Headers();
headers.append(&quot;Content-Type&quot;, &quot;application/json&quot;);

const raw = JSON.stringify({
  username: ALIST_USERNAME,
  password: ALIST_PASSWORD,
});

const requestOptions = {
  method: &quot;POST&quot;,
  headers,
  body: raw,
  redirect: &quot;follow&quot;,
};

const res = await fetch(`${ALIST_ADDRESS}/api/auth/login`, requestOptions);
const resText = await res.text();
const resObj = JSON.parse(resText);

const alistToken = resObj.data.token;
```

### ä¸Šä¼ å¤‡ä»½æ–‡ä»¶åˆ°äº‘ç›˜

ç°åœ¨ï¼Œç¼–å†™ Alist ä¸Šä¼ æ–‡ä»¶çš„æ–¹æ³•ï¼š

```js
const ALIST_BACKUP_DIR = &quot;/path/to/mc-backups&quot;;

const backupFile = fs.statSync(backupFilename);
const backupFileBasename = path.basename(backupFilename);
const alistFilePath = path.resolve(ALIST_BACKUP_DIR, backupFileBasename);

const headers = new Headers();
headers.append(&quot;Authorization&quot;, alistToken);
headers.append(&quot;As-Task&quot;, &quot;true&quot;);
headers.append(&quot;Content-Length&quot;, `${backupFile.size}`);
headers.append(&quot;File-Path&quot;, encodeURIComponent(alistFilePath));

const fileStream = fs.createReadStream(backupFilename);
const requestOptions = {
  method: &quot;PUT&quot;,
  headers,
  body: fileStream,
  redirect: &quot;follow&quot;,
  duplex: &quot;half&quot;,
};

await fetch(`${ALIST_ADDRESS}/api/fs/put`, requestOptions);
```

é€šè¿‡ `headers.append(&quot;As-Task&quot;, &quot;true&quot;);` å°†æ–‡ä»¶ä¸Šä¼ è®¾ä¸ºä»»åŠ¡ï¼Œé¿å…é˜»å¡å…¶å®ƒå‘½ä»¤çš„æ‰§è¡Œã€‚åœ¨ Alist ç®¡ç†åå°å¯ä»¥çœ‹åˆ°ä¸Šä¼ çš„è¿›åº¦ï¼š

![upload-to-alist](./backup-mc-server/upload-to-alist.png)

åˆ°è¿™ä¸€æ­¥ï¼Œæ‰§è¡Œå¤‡ä»½è„šæœ¬æ—¶ï¼Œå°†è‡ªåŠ¨æŠŠæ–°ç”Ÿæˆçš„å¤‡ä»½æ–‡ä»¶ä¸Šä¼ åˆ°äº‘ç›˜ã€‚

### ç§»é™¤äº‘ç›˜å†å²å¤‡ä»½æ–‡ä»¶

åŒæ ·ï¼Œäº‘ç›˜çš„ç©ºé—´ä¹Ÿä¸æ˜¯æ— é™çš„ï¼Œæˆ‘ä»¬é‡‡å–ä¸ç§»é™¤æœ¬åœ°å†å²å¤‡ä»½æ–‡ä»¶ç›¸åŒçš„ç­–ç•¥ã€‚

é¦–å…ˆè·å–äº‘ç›˜ä¸Šå·²æœ‰çš„å¤‡ä»½æ–‡ä»¶åˆ—è¡¨ï¼š

```js
const headers = new Headers();
headers.append(&quot;Authorization&quot;, alistToken);
headers.append(&quot;Content-Type&quot;, &quot;application/json&quot;);

const raw = JSON.stringify({
  path: ALIST_BACKUP_DIR,
});

const requestOptions = {
  method: &quot;POST&quot;,
  headers: headers,
  body: raw,
  redirect: &quot;follow&quot;,
};

const res = await fetch(`${ALIST_ADDRESS}/api/fs/list`, requestOptions);
const resText = await res.text();
const resObj = JSON.parse(resText);

const backupDirFileList = resObj.data.content || [];
```

è·å–éœ€è¦ç§»é™¤çš„å¤‡ä»½æ–‡ä»¶åˆ—è¡¨ï¼š

```js
const backupFiles = backupDirFileList
  .filter((file) =&gt; !file.is_dir)
  .sort((a, b) =&gt; {
    if (a.modified &gt; b.modified) {
      return -1;
    } else if (a.modified &lt; b.modified) {
      return 1;
    } else {
      return 0;
    }
  });

// ç”±äºæ–°çš„å¤‡ä»½æ–‡ä»¶æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œå› æ­¤åº”å½“ä¿ç•™æœ€æ–°çš„ BACKUP_MAX_NUM - 1 ä¸ªå¤‡ä»½æ–‡ä»¶
const oldBackupFiles = backupFiles.slice(BACKUP_MAX_NUM - 1);
const oldBackupFilenames = oldBackupFiles.map((file) =&gt; file.name);
```

æœ€åï¼Œç§»é™¤è¿™äº›æ–‡ä»¶å³å¯ï¼š

```js
const headers = new Headers();
headers.append(&quot;Authorization&quot;, alistToken);
headers.append(&quot;Content-Type&quot;, &quot;application/json&quot;);

const raw = JSON.stringify({
  names: oldBackupFilenames,
  dir: ALIST_BACKUP_DIR,
});

const requestOptions = {
  method: &quot;POST&quot;,
  headers: headers,
  body: raw,
  redirect: &quot;follow&quot;,
};

await fetch(`${ALIST_ADDRESS}/api/fs/remove`, requestOptions);
```

è¿™æ ·åœ¨æ¯æ¬¡æ‰§è¡Œè„šæœ¬æ—¶ï¼Œäº‘ç›˜çš„ç³»ç»Ÿå®¹é‡å¥åº·ä¹Ÿå¾—åˆ°äº†ä¿éšœã€‚

## ç»“å°¾

ç¨å¾®æ¶¦è‰²ä¼˜åŒ–ä¸€ä¸‹å¤‡ä»½è„šæœ¬ï¼Œæ‰§è¡Œçš„è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```bash
$ node /path/to/backup-mc-server.js
Create dir `/path/to/mc-server/backups` successfully.
Creating backup file `/path/to/mc-server/backups/backup-mcserver-2024-05-11-11-10-51.tar.gz` ...
Create backup file `/path/to/mc-server/backups/backup-mcserver-2024-05-11-11-10-51.tar.gz` successfully.
Log in alist successfully.
Start upload task successfully: local file `/path/to/mc-server/backups/backup-mcserver-2024-05-11-11-10-51.tar.gz` ==&gt; alist `/path/to/alist/backups/backup-mcserver-2024-05-11-11-10-51.tar.gz`.

===========================
Backup file is generated: true
Old backup files are removed: true
Task that upload backup file to alist is started: true
Old backup files in alist are removed: true
===========================
```

å•Šï¼Œæ»¡æ»¡çš„å®‰å¿ƒæ„Ÿï¼æ”¶å·¥ã€‚
</content:original-text><content:updated-at>2024-05-23T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[é‡åˆ° AntD ç»„ä»¶ä¸­æ–‡ä¹±ç é—®é¢˜ï¼Œå¯ä»¥è¯•è¯•è¿™ä¹ˆè§£å†³]]></title><description><![CDATA[é¡¹ç›®ä¸­ä½¿ç”¨äº† AntD 4.x çš„  ç»„ä»¶ï¼Œå¼€å‘ç¯å¢ƒæ˜¾ç¤ºæ­£å¸¸ï¼Œç”Ÿäº§ç¯å¢ƒæ˜¾ç¤ºä¹±ç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š é—®é¢˜åŸå› 

 ç»„ä»¶åº•å±‚çš„å›½é™…åŒ–æ—¢ç”± AntD æä¾›çš„  æ§åˆ¶ï¼ˆå¦‚ä¸Šå›¾çš„â€œå¹´â€ï¼Œæ˜¾ç¤ºæ­£å¸¸ï¼‰ï¼Œåˆç”± Moment æ§åˆ¶ï¼ˆå¦‚ä¸Šå›¾çš„â€œæœˆâ€ï¼Œæ˜¾ç¤ºä¹±ç ï¼‰ã€‚

ç»æŸ¥è¯¢ï¼Œå½“æˆ‘ä»¬ä»¥ ISO8859-1 æ–¹å¼è¯»å– UTF-8 ç¼–ç çš„ä¸­æ–‡æ—¶ï¼Œä¼šå‡ºç°å¦‚â€œÃ§â€Â±Ã¦Å“Ë†Ã¨Â¦ï¿½Ã¥Â¥Â½Ã¥Â¥Â½Ã¥Â­Â¦Ã¤Â¹ Ã¥Â¤Â©Ã¥Â¤Â©Ã¥ï¿½â€˜Ã¤Â¸Å â€¦]]></description><link>https://blog.towind.fun/posts/antd-comp-garbled-characters</link><guid isPermaLink="false">antd-comp-garbled-characters</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Mon, 09 Oct 2023 00:00:00 GMT</pubDate><content:original-text>
é¡¹ç›®ä¸­ä½¿ç”¨äº† AntD 4.x çš„ `&lt;DatePicker /&gt;` ç»„ä»¶ï¼Œå¼€å‘ç¯å¢ƒæ˜¾ç¤ºæ­£å¸¸ï¼Œç”Ÿäº§ç¯å¢ƒæ˜¾ç¤ºä¹±ç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![error](./antd-comp-garbled-characters/error.png)

## é—®é¢˜åŸå› 

`&lt;DatePicker /&gt;` ç»„ä»¶åº•å±‚çš„å›½é™…åŒ–æ—¢ç”± AntD æä¾›çš„ `&lt;ConfigProvider /&gt;` æ§åˆ¶ï¼ˆå¦‚ä¸Šå›¾çš„â€œå¹´â€ï¼Œæ˜¾ç¤ºæ­£å¸¸ï¼‰ï¼Œåˆç”± Moment æ§åˆ¶ï¼ˆå¦‚ä¸Šå›¾çš„â€œæœˆâ€ï¼Œæ˜¾ç¤ºä¹±ç ï¼‰ã€‚

ç»æŸ¥è¯¢ï¼Œå½“æˆ‘ä»¬ä»¥ ISO8859-1 æ–¹å¼è¯»å– UTF-8 ç¼–ç çš„ä¸­æ–‡æ—¶ï¼Œä¼šå‡ºç°å¦‚â€œÃ§â€Â±Ã¦Å“Ë†Ã¨Â¦ï¿½Ã¥Â¥Â½Ã¥Â¥Â½Ã¥Â­Â¦Ã¤Â¹ Ã¥Â¤Â©Ã¥Â¤Â©Ã¥ï¿½â€˜Ã¤Â¸Å â€è¿™æ ·çš„ç¬¦å·å‹ä¹±ç ï¼Œæ­£å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚

å› æ­¤äº§ç”Ÿé—®é¢˜çš„å…³é”®åœ¨äºï¼Œ**ä¸ºä½•æµè§ˆå™¨æ²¡æœ‰æ­£ç¡®åœ°ä»¥ UTF-8 æ ¼å¼è¯»å– Moment æä¾›çš„ä¸­æ–‡è¯­è¨€åŒ…æ–‡æœ¬ã€‚**

ç»æ’æŸ¥ï¼Œå‘ç°åœ¨è®¿é—®ç”Ÿäº§ç¯å¢ƒæ—¶ï¼ŒæœåŠ¡ç«¯è¿”å›çš„ HTML æ–‡æ¡£è®¾ç½®äº†ç¼–ç ä¸º ISO8859-1ï¼š

![response-content-type](./antd-comp-garbled-characters/response-content-type.png)

ä¸€åˆ‡ä¾¿æ°´è½çŸ³å‡ºã€‚

## å¦‚ä½•è§£å†³

æœ€å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯è”ç³»æœåŠ¡ç«¯åŒå­¦ï¼Œä¿®æ”¹ `Content-Type=text/html;charset=UTF-8`ã€‚

åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œä½¿ç”¨äº† CDN çš„æ–¹å¼å¼•å…¥ Momentï¼Œå› æ­¤å¯ä»¥é‡‡ç”¨çš„ä¸€ä¸ªä¸´æ—¶è§£å†³æ–¹æ¡ˆä¸ºå¼ºåˆ¶æŒ‡å®šç¼–ç ï¼Œä¾‹å¦‚ï¼š

```html
&lt;script
  src=&quot;https://gw.alipayobjects.com/os/lib/??moment/2.29.1/moment.js,moment/2.29.1/locale/zh-cn.js&quot;
  charset=&quot;utf-8&quot;
&gt;&lt;/script&gt;
```
</content:original-text><content:updated-at>2023-10-09T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[ä¸ºä»€ä¹ˆæˆ‘ä½¿ç”¨ Umi çš„ model ç®€æ˜“æ•°æ®æµç®¡ç†æ’ä»¶]]></title><description><![CDATA[Umi æ˜¯ä¸€æ¬¾ä¼ä¸šçº§çš„ React å‰ç«¯åº”ç”¨æ¡†æ¶ï¼Œäº‘å·§äº§ä¸šæ•°å­—ç»„ä»¶ä¸­å¿ƒæ¨èä½¿ç”¨åŸºäº Umi çš„ Koi æ¡†æ¶ç»Ÿä¸€å‰ç«¯åº”ç”¨ç ”å‘æµç¨‹ï¼Œæ”¯æ’‘å‰ç«¯é¡¹ç›®ä»ç ”å‘ã€è”è°ƒåˆ°ä¸Šçº¿ã€å‘å¸ƒçš„å…¨æµç¨‹ã€‚ æœ¬æ–‡å‡è®¾æ‚¨æ­£åœ¨æˆ–è®¡åˆ’ä½¿ç”¨ Umi æˆ– Koi ä½œä¸ºåº•å±‚æ¡†æ¶æ”¯æ’‘å‰ç«¯åº”ç”¨çš„å¼€å‘ï¼Œå¹¶ä¸”å¯¹ Umi æœ‰ä¸€å®šçš„äº†è§£ã€‚

æ•°æ®æ²»ç†çš„åŸåˆ™

React çš„æ ¸å¿ƒç‰¹å¾æ˜¯â€œæ•°æ®é©±åŠ¨è§†å›¾â€ï¼Œç”¨å…¬å¼è¡¨è¾¾å³ ï¼Œé€šè¿‡æ•°æ®å˜åŒ–æ¥é©±åŠ¨è§†å›¾å˜åŒ–ã€‚Reactâ€¦]]></description><link>https://blog.towind.fun/posts/umi-plugin-usemodel</link><guid isPermaLink="false">umi-plugin-usemodel</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Sun, 23 Oct 2022 00:00:00 GMT</pubDate><content:original-text>
Umi æ˜¯ä¸€æ¬¾ä¼ä¸šçº§çš„ React å‰ç«¯åº”ç”¨æ¡†æ¶ï¼Œäº‘å·§äº§ä¸šæ•°å­—ç»„ä»¶ä¸­å¿ƒæ¨èä½¿ç”¨åŸºäº Umi çš„ Koi æ¡†æ¶ç»Ÿä¸€å‰ç«¯åº”ç”¨ç ”å‘æµç¨‹ï¼Œæ”¯æ’‘å‰ç«¯é¡¹ç›®ä»ç ”å‘ã€è”è°ƒåˆ°ä¸Šçº¿ã€å‘å¸ƒçš„å…¨æµç¨‹ã€‚

æœ¬æ–‡å‡è®¾æ‚¨æ­£åœ¨æˆ–è®¡åˆ’ä½¿ç”¨ Umi æˆ– Koi ä½œä¸ºåº•å±‚æ¡†æ¶æ”¯æ’‘å‰ç«¯åº”ç”¨çš„å¼€å‘ï¼Œå¹¶ä¸”å¯¹ Umi æœ‰ä¸€å®šçš„äº†è§£ã€‚

## æ•°æ®æ²»ç†çš„åŸåˆ™

React çš„æ ¸å¿ƒç‰¹å¾æ˜¯â€œæ•°æ®é©±åŠ¨è§†å›¾â€ï¼Œç”¨å…¬å¼è¡¨è¾¾å³ `UI = render(data)`ï¼Œé€šè¿‡æ•°æ®å˜åŒ–æ¥é©±åŠ¨è§†å›¾å˜åŒ–ã€‚React å°†ç»„ä»¶å†…éƒ¨è‡ªæœ‰çš„æ•°æ®ç§°ä½œ stateï¼ˆçŠ¶æ€ï¼‰ï¼Œé€šè¿‡ç®¡ç† state æ¥å®ç°å¯¹ç»„ä»¶çš„ç®¡ç†ã€‚

é€šè¿‡ Props ä¼ å‚ï¼Œå¯ä»¥åœ¨ React ä¸­å®ç°ç®€å•çš„çˆ¶å­ã€å­çˆ¶å’Œå…„å¼Ÿç»„ä»¶é—´æ•°æ®ä¼ é€’ã€‚å¯¹äºè·¨çº§ç»„ä»¶é—´çš„æ•°æ®ä¼ é€’ï¼ŒReact æä¾›äº†åŸºäºç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼çš„ Context API æ¥å®ç°å…¨å±€é€šä¿¡ã€‚

éšç€åº”ç”¨çš„è†¨èƒ€ï¼Œç»„ä»¶å†…éƒ¨çš„çŠ¶æ€å˜å¾—æ„ˆåŠ å¤æ‚ï¼Œæ•°æ®æµç®¡ç†çš„æˆæœ¬ä¹Ÿè¶Šæ¥è¶Šé«˜ã€‚å¦‚æœè¯´æ‰€æœ‰ä»£ç çš„æœ«è·¯éƒ½æ˜¯æˆä¸ºä¸€åº§éš¾ä»¥ç»´æŠ¤çš„å¤§å±±çš„è¯ï¼Œåœ¨é‚£ä¹‹å‰ï¼Œæˆ‘ä»¬åº”å½“å¥½å¥½æƒ³æƒ³å¦‚ä½•å°½å¯èƒ½å¤šåœ°å»¶é•¿ä»£ç çš„å¯¿å‘½ï¼Œå»é‡æ–°æ€è€ƒæˆ‘ä»¬çš„ React é¡¹ç›®çš„ä»£ç ç»„ç»‡é€»è¾‘ã€‚

Umi å»ºè®®å°†æ‰€æœ‰ç»„ä»¶é™çº§ä¸ºâ€œæ— çŠ¶æ€ç»„ä»¶â€ï¼Œä»…ä»…ä¾èµ– Props æˆ– Context è¿›è¡Œæ¸²æŸ“ã€‚è¿™æ ·ï¼Œåœ¨ UI å±‚é¢ä»…å…³å¿ƒç”¨æˆ·äº¤äº’å’Œæ¸²æŸ“çš„é€»è¾‘ï¼Œåœ¨å•ç‹¬çš„æ•°æ®å±‚å»å…³å¿ƒæ•°æ®å¤„ç†çš„é€»è¾‘ã€‚ä»¥ Umi é¡¹ç›®ä¸ºä¾‹ï¼Œå…·ä½“è€Œè¨€å°±æ˜¯ï¼š

- `src/models` ä¸­çš„æ–‡ä»¶ç®¡ç†æ•°æ®å±‚çš„é€»è¾‘ï¼ŒåŒ…å«ç½‘ç»œè¯·æ±‚ã€æ•°æ®å¤„ç†ç­‰ã€‚
- `src/pages` ä¸­çš„é¡µé¢ç»„ä»¶ä¸æ•°æ®å±‚è¿›è¡Œäº¤äº’ï¼Œå¹¶å°†å¾—åˆ°çš„æ•°æ®é€šè¿‡ Props æˆ– Context ä¼ é€’ç»™é€šç”¨ç»„ä»¶ï¼Œè¿›è¡Œé¡µé¢æ¸²æŸ“ã€‚
- `src/components` ä¸­çš„é€šç”¨ç»„ä»¶ä»…ä»…ä¾èµ–ä» Props æˆ– Context å¾—åˆ°çš„æ•°æ®è¿›è¡Œæ¸²æŸ“ï¼Œä¸ä¸æ•°æ®å±‚å‘ç”Ÿç›´æ¥äº¤äº’ã€‚

## ä»‹ç» model ç®€æ˜“æ•°æ®æµæ’ä»¶

Umi çš„ model ç®€æ˜“æ•°æ®æµæ’ä»¶å°±æ˜¯åŸºäº Context çš„å°è£…ï¼Œä½¿å¾—æ•°æ®èƒ½å¤Ÿåœ¨é¡¹ç›®å…¨å±€å…±äº«ä¸ä½¿ç”¨ã€‚ç›¸æ¯”åŸç”Ÿçš„ Context APIï¼Œmodel ç®€æ˜“æ•°æ®æµæ’ä»¶æ›´åŠ ä¾¿äºä½¿ç”¨ã€‚

ä½¿ç”¨ Context API æ—¶ï¼Œéœ€è¦åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¹¶åœ¨æ¸²æŸ“æ ‘é¡¶å±‚åŒ…è£…ä¸Šä¸‹æ–‡çš„ Providerï¼š

```tsx
// src/contexts/userContext.tsx
import React, { createContext, useState } from &quot;react&quot;;
export const UserContext = createContext();
export const UserContextProvider = (props) =&gt; {
  const [username, setUsername] = useState&lt;string&gt;(&quot;&quot;);
  return (
    &lt;UserContext.Provider value={{ username }}&gt;
      {props.children}
    &lt;/UserContext.Provider&gt;
  );
};

// src/layouts/index.tsx
import React from &quot;react&quot;;
import { Outlet } from &quot;umi&quot;;
import { UserContextProvider } from &quot;@/contexts/userContext&quot;;
export const Layout = () =&gt; {
  return (
    &lt;UserContextProvider&gt;
      &lt;Outlet /&gt;
    &lt;/UserContextProvider&gt;
  );
};
export default Layout;
```

ä½¿ç”¨ç®€æ˜“æ•°æ®æµæ’ä»¶å¯ä»¥ç•¥å»åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡å’ŒåŒ…è£… Provider çš„è¿‡ç¨‹ï¼Œä»…éœ€è¦æŒ‰çº¦å®šç›®å½•å¯¼å‡ºä¸€ä¸ªè‡ªå®šä¹‰çš„ `hook` å‡½æ•°å³å¯ï¼š

```ts
// src/models/userModel.ts
import { useState } from &quot;react&quot;;
export default function () {
  const [username, setUsername] = useState&lt;string&gt;(&quot;&quot;);
  return { username };
}
```

åœ¨ç»„ä»¶ä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­å­˜å‚¨çš„æ•°æ®æ—¶ï¼ŒContext API éœ€è¦ï¼š

```tsx
import React, { useContext } from &quot;react&quot;;
import { UserContext } from &quot;@/contexts/userContext&quot;;
export const pageElement = () =&gt; {
  const { username } = useContext(UserContext);
  return &lt;&gt;{username}&lt;/&gt;;
};
export default pageElement;
```

è€Œä½¿ç”¨ç®€æ˜“æ•°æ®æµæ’ä»¶å¯ä»¥ç•¥å»å¼•å…¥æŒ‡å®šä¸Šä¸‹æ–‡å¯¹è±¡çš„è¿‡ç¨‹ï¼ŒUmi å·²ç»è‡ªåŠ¨ä¸ºå®ƒåˆ›å»ºäº†ä¸€ä¸ªå‘½åç©ºé—´ï¼š

```tsx
import React from &quot;react&quot;;
import { useModel } from &quot;umi&quot;;
export const pageElement = () =&gt; {
  const { username } = useModel(&quot;userModel&quot;);
  return &lt;&gt;{username}&lt;/&gt;;
};
export default pageElement;
```

ç”±äºè°ƒç”¨äº† `useContext` çš„ç»„ä»¶æ€»ä¼šåœ¨ `context` å€¼å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ `useMemo` æˆ– `memo` æ¥ä¼˜åŒ–é‡æ¸²æŸ“å¼€é”€è¾ƒå¤§çš„ç»„ä»¶ï¼š

```tsx
import React, { useContext, useMemo } from &quot;react&quot;;
import { UserContext } from &quot;@/contexts/userContext&quot;;
export const pageElement = () =&gt; {
  const { username } = useContext(UserContext);
  return useMemo(() =&gt; {
    return &lt;ExpensiveTree username={username} /&gt;;
  }, [username]);
};
export default pageElement;
```

ä½¿ç”¨ç®€æ˜“æ•°æ®æµæ’ä»¶æ—¶åŒæ ·å¯ä»¥ä½¿ç”¨ `useMemo` æˆ– `memo` æ¥è¿›è¡Œä¼˜åŒ–ï¼Œä½†æ›´å¥½çš„é€‰æ‹©æ˜¯ç›´æ¥åˆ©ç”¨ `useModel()` æä¾›çš„è¿‡æ»¤æ–¹æ³•ï¼Œåªå…³å¿ƒéœ€è¦çš„æ•°æ®ï¼š

```tsx
import React from &quot;react&quot;;
import { useModel } from &quot;umi&quot;;
export const pageElement = () =&gt; {
  const { username } = useModel(&quot;userModel&quot;, (model) =&gt; ({
    username: model.username,
  }));
  return &lt;ExpensiveTree username={username} /&gt;;
};
export default pageElement;
```

ç»¼ä¸Šæ‰€è¿°ï¼ŒUmi çš„ model ç®€æ˜“æ•°æ®æµæ’ä»¶å®ç°äº†å¯¹ Context API çš„è¾ƒå¥½å°è£…ï¼Œèƒ½å¤Ÿé™æœ¬å¢æ•ˆï¼Œç®€åŒ–ä»£ç çš„ç¼–å†™ã€‚å¯¹äºéœ€è¦ä½¿ç”¨ Context ç®¡ç†æ•°æ®æµçš„æƒ…å†µï¼Œéƒ½å¯ä»¥ä½¿ç”¨ model ç®€æ˜“æ•°æ®æµæ’ä»¶æ›¿ä»£ã€‚

## ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ model ç®€æ˜“æ•°æ®æµæ’ä»¶

è¿‘å¹´æ¥ï¼Œå¾®å‰ç«¯æ¶æ„çš„å…´èµ·ä¸ºä¼ä¸šå‰ç«¯åº”ç”¨å¼€å‘æ³¨å…¥äº†æ–°çš„æ´»åŠ›ï¼Œéšç€å·¨å‹å‰ç«¯åº”ç”¨æ‹†è§£æˆä¸€ä¸ªä¸ªå°å¾®å‹å‰ç«¯åº”ç”¨ï¼Œé¡µé¢æ•°æ®çš„æ²»ç†éš¾åº¦ä¹Ÿå¤§å¤§é™ä½äº†ã€‚

å½“æ‚¨ä½¿ç”¨ Umi æˆ– Koi å¼€å‘**å°å¾®å‹å‰ç«¯åº”ç”¨**é‡åˆ°å…¨å±€çŠ¶æ€å…±äº«æˆ–æ•°æ®æµç®¡ç†éœ€æ±‚æ—¶ï¼Œmodel ç®€æ˜“æ•°æ®æµæ’ä»¶å…·æœ‰**ä¾¿åˆ©**ã€**ä½å¿ƒæ™ºè´Ÿæ‹…**çš„ä¼˜åŠ¿ï¼Œä¸å¦¨å¥½å¥½åˆ©ç”¨å®ƒæ¥ç®¡ç†é¡µé¢æ•°æ®ã€‚

é’ˆå¯¹æ›´å¤æ‚çš„æ•°æ®æµç®¡ç†éœ€æ±‚ï¼ˆä¾‹å¦‚æ•°æ®å¯é¢„çŸ¥ç”šè‡³å¯å›æº¯ç­‰ï¼‰ï¼Œmodel ç®€æ˜“æ•°æ®æµæ’ä»¶æ˜¾å¾—æœ‰äº›æ‰è¥Ÿè§è‚˜äº†ï¼šå®ƒåªè´Ÿè´£å°†æ•°æ®å…¨å±€åŒ–ã€‚åˆ«æ‹…å¿ƒï¼Œå¼€æºç¤¾åŒºæä¾›äº†å¤§é‡ä¸“æ³¨äºåšå¥½æ•°æ®æµç®¡ç†è¿™ä»¶äº‹çš„æ–¹æ¡ˆï¼Œä¾‹å¦‚ [Redux](https://github.com/reduxjs/redux) å’Œ [MobX](https://github.com/mobxjs/mobx) ç­‰ï¼›Umi å®˜æ–¹ç›®å‰ä¹Ÿæä¾›äº†å¯¹æ¥ [dva](https://github.com/dvajs/dva) å’Œ [Valtio](https://github.com/pmndrs/valtio) æ•°æ®æµç®¡ç†åº“çš„æ’ä»¶ï¼Œå¼€ç®±å³ç”¨ã€‚
</content:original-text><content:updated-at>2022-10-23T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[å®šæ—¶å™¨ SetTimeout åœ¨åå°å¤±æ•ˆï¼Ÿè¯•è¯• Web Worker å§]]></title><description><![CDATA[ä¸šåŠ¡ä¸Šæœ‰è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼šã€Œè‹¥ç”¨æˆ·ä¸æ´»è·ƒè¶…è¿‡ 12 ä¸ªå°æ—¶ï¼Œè‡ªåŠ¨é€€å‡ºå½“å‰é¡µé¢ï¼Œå¹¶åˆ‡æ¢è·¯ç”±åˆ°é¦–é¡µã€ã€‚ æƒ³éƒ½æ²¡æƒ³ï¼Œç›´æ¥åœ¨  é‡Œç”¨  å®šä¸ªæ—¶ï¼Œ12 ä¸ªå°æ—¶åè§¦å‘ç›¸åº”è·³è½¬äº‹ä»¶ï¼š

æ²¡æƒ³åˆ°ï¼Œä»Šå¤©ä¸Šç­æ¥ï¼Œåˆ‡æ¢åˆ°æ²¡æœ‰å…³é—­çš„æ ‡ç­¾é¡µï¼Œå‘ç°è¿˜åœ¨å½“å‰é¡µé¢ï¼ŒææŒ‡ä¸€ç®—æ€ä¹ˆä¹Ÿæœ‰ 12 ä¸ªå°æ—¶äº†ï¼Œè¿™æ˜¯æ€ä¹ˆä¸€å›äº‹å„¿â€¦â€¦ï¼Ÿ

æ˜¨å¤©æ™šä¸Šèµ°çš„æ—¶å€™è¿˜åœ¨å’Œå‰è¾ˆæ¢è®¨é¡µé¢å¸è½½ï¼ˆï¼‰äº‹ä»¶ä¸æµè§ˆå™¨åå°ä¼˜åŒ–çš„å‘ï¼Œäºæ˜¯é¦–å…ˆå°±æƒ³åˆ°äº†å¯èƒ½æ˜¯æµè§ˆå™¨ä¼˜åŒ–çš„ç¼˜æ•…â€¦]]></description><link>https://blog.towind.fun/posts/js-webworker-settimeout</link><guid isPermaLink="false">js-webworker-settimeout</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Thu, 22 Sep 2022 00:00:00 GMT</pubDate><content:original-text>
ä¸šåŠ¡ä¸Šæœ‰è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼šã€Œè‹¥ç”¨æˆ·ä¸æ´»è·ƒè¶…è¿‡ 12 ä¸ªå°æ—¶ï¼Œè‡ªåŠ¨é€€å‡ºå½“å‰é¡µé¢ï¼Œå¹¶åˆ‡æ¢è·¯ç”±åˆ°é¦–é¡µã€ã€‚

æƒ³éƒ½æ²¡æƒ³ï¼Œç›´æ¥åœ¨ `useEffect()` é‡Œç”¨ `setTimeout()` å®šä¸ªæ—¶ï¼Œ12 ä¸ªå°æ—¶åè§¦å‘ç›¸åº”è·³è½¬äº‹ä»¶ï¼š

```tsx
import React, { useEffect } from &quot;react&quot;;

const LEAVE_PAGE_COUNTDOWN = 12 * 60 * 60 * 1000; // 12h

/** ç¦»å¼€é¡µé¢çš„æ–¹æ³• */
const leavePage = () =&gt; {
  // ...ç¦»å¼€å½“å‰é¡µé¢çš„ä¸šåŠ¡ä»£ç 
};

export default () =&gt; {
  useEffect(() =&gt; {
    // åˆå§‹åŒ–æ—¶è®¾ç½®å®šæ—¶å™¨
    const timer = setTimeout(() =&gt; {
      leavePage();
    }, LEAVE_PAGE_COUNTDOWN);

    return () =&gt; {
      // é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
      if (timer) clearTimeout(timer);
    };
  }, []);
};
```

æ²¡æƒ³åˆ°ï¼Œä»Šå¤©ä¸Šç­æ¥ï¼Œåˆ‡æ¢åˆ°æ²¡æœ‰å…³é—­çš„æ ‡ç­¾é¡µï¼Œå‘ç°è¿˜åœ¨å½“å‰é¡µé¢ï¼ŒææŒ‡ä¸€ç®—æ€ä¹ˆä¹Ÿæœ‰ 12 ä¸ªå°æ—¶äº†ï¼Œè¿™æ˜¯æ€ä¹ˆä¸€å›äº‹å„¿â€¦â€¦ï¼Ÿ

æ˜¨å¤©æ™šä¸Šèµ°çš„æ—¶å€™è¿˜åœ¨å’Œå‰è¾ˆæ¢è®¨é¡µé¢å¸è½½ï¼ˆ`unload`ï¼‰äº‹ä»¶ä¸æµè§ˆå™¨åå°ä¼˜åŒ–çš„å‘ï¼Œäºæ˜¯é¦–å…ˆå°±æƒ³åˆ°äº†å¯èƒ½æ˜¯æµè§ˆå™¨ä¼˜åŒ–çš„ç¼˜æ•…ï¼Œå¯¼è‡´å®šæ—¶å™¨æ²¡æœ‰æ­£å¸¸æ‰§è¡Œã€‚ä»¥ã€ŒsetTimeoutã€å’Œã€Œåå°å¤±æ•ˆã€ä¸ºæœç´¢å…³é”®è¯ï¼Œå¾ˆå¿«æ‰¾åˆ°äº†åŸå› å’Œä¼˜åŒ–è§£å†³æ–¹æ¡ˆã€‚

## å¤±æ•ˆåŸå› 

ç³»ç°ä»£æµè§ˆå™¨ä¸ºäº†èŠ‚èƒ½ä¸æ€§èƒ½ä¼˜åŒ–åšçš„å¤„ç†ã€‚

è‹¥é¡µé¢å¤„äºéæ¿€æ´»çš„çŠ¶æ€ï¼Œé‚£ä¹ˆæ­¤é¡µé¢ä¸­é€šè¿‡ `setTimeout()` æˆ– `setInterval()` åˆ›å»ºçš„å®šæ—¶å™¨å¯èƒ½ä¼š**åœæ­¢å·¥ä½œ**æˆ–**ä»¥è¾ƒæ…¢çš„é€Ÿåº¦å·¥ä½œ**ã€‚é¡µé¢çš„éæ¿€æ´»çŠ¶æ€åŒ…æ‹¬ä¸é™äºï¼šåˆ‡æ¢åˆ°å…¶å®ƒæ ‡ç­¾é¡µã€æœ€å°åŒ–çª—å£å’Œæ¯å±ç­‰ã€‚åœ¨ç§»åŠ¨ç«¯ï¼Œè¿™æ ·çš„æ€§èƒ½ä¼˜åŒ–å°¤ä¸ºå¸¸è§ã€‚

å› æ­¤ä¼šå‘ç”Ÿå¦å¤–ä¸€ç§å¸¸è§çš„ç°è±¡ï¼šå¦‚æœæµè§ˆå™¨é¡µé¢é‡Œæœ‰ä¸€ä¸ªåŸºäº `setInterval()` å®ç°çš„è®¡æ—¶å™¨ï¼Œå½“ç”¨æˆ·åˆ‡æ¢é¡µé¢æˆ–å›åˆ°æ¡Œé¢åï¼Œè®¡æ—¶å™¨å°†åœæ­¢è®¡æ—¶æˆ–è®¡æ—¶é¢‘ç‡å‡æ…¢ï¼Œå¯¼è‡´è®¡æ—¶åŠŸèƒ½å¼‚å¸¸ã€‚

## åŸºäº SetTimeout / SetInterval çš„è§£å†³æ–¹æ¡ˆ

å®šæ—¶å™¨å¤±æ•ˆå¸¦æ¥çš„æœ€ç›´æ¥å½±å“æ˜¯ï¼šJavaScript ä»£ç ä¸å†èƒ½å¤Ÿæ­£ç¡®è·å–å®šæ—¶å™¨**è®¡åˆ’æ‰§è¡Œçš„æ—¶é—´**æˆ–**å·²ç»æ‰§è¡Œçš„æ¬¡æ•°**ã€‚

ä¸€ä¸ªå¾ˆå®¹æ˜“æƒ³åˆ°çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œå½“é¡µé¢åˆ‡å›å‰å°æ—¶ï¼Œé‡æ–°æ ¡å‡† SetTimeout å®šæ—¶å™¨æ—¶é—´ã€‚

### ä½¿ç”¨ SetTimeout + ç›‘å¬ visibilitychange äº‹ä»¶

é€šè¿‡ç›‘å¬çª—å£çš„ `visibilitychange` äº‹ä»¶ï¼ˆå…¼å®¹æ€§[è§äºæ­¤](https://developer.mozilla.org/zh-CN/docs/Web/API/Document/visibilitychange_event#browser_compatibility)ï¼‰ï¼Œå¯ä»¥åˆ¤æ–­é¡µé¢æ˜¯å¦åˆ‡æ¢åˆ°å‰å°ï¼š

```ts
window.addEventListener(&quot;visibilitychange&quot;, () =&gt; {
  switch (document.visibilityState) {
    case &quot;visible&quot;:
      // å½“å‰é¡µé¢è¢«åˆ‡æ¢åˆ°å‰å°ï¼ˆå¯è§æˆ–éƒ¨åˆ†å¯è§ï¼‰
      break;
    case &quot;hidden&quot;:
      // å½“å‰é¡µé¢è¢«åˆ‡æ¢åˆ°åå°ï¼ˆä¸å¯è§ï¼‰
      break;
    case &quot;prerender&quot;:
      // å½“å‰é¡µé¢è¢«é¢„æ¸²æŸ“ï¼Œä¸”ç”¨æˆ·ä¸å¯è§
      break;
    case &quot;unloaded&quot;:
      // å½“å‰é¡µé¢è¢«å¸è½½
      break;
  }
});
```

å¯¹äºè¿™æ¬¡ä¸šåŠ¡ä¸Šé‡åˆ°çš„ 12 å°æ—¶è‡ªåŠ¨åˆ‡æ¢è·¯ç”±è¿™ä¸€éœ€æ±‚ï¼Œå¯¹å³æ—¶æ€§å’Œå®šæ—¶å™¨çš„ç²¾åº¦è¦æ±‚å¹¶ä¸é«˜ï¼Œä¸”é‡æ–°æ ¡å‡†çš„é€»è¾‘å®¹æ˜“ç¼–å†™ï¼Œå¯ä»¥ç å‡º React ä»£ç å¦‚ä¸‹ï¼š

```tsx
import React, { useEffect } from &quot;react&quot;;

const LEAVE_PAGE_TIMESTAMP = &quot;__leave_page_timestamp&quot;;
const LEAVE_PAGE_COUNTDOWN = 12 * 60 * 60 * 1000;

/** ç¦»å¼€é¡µé¢çš„æ–¹æ³• */
const leavePage = () =&gt; {
  // ...ç¦»å¼€å½“å‰é¡µé¢çš„ä¸šåŠ¡ä»£ç 
};

/** è·å¾—å€’è®¡æ—¶æ—¶é—´ */
const getLeavePageCountdown = (): number =&gt; {
  const timestamp = sessionStorage.getItem(LEAVE_PAGE_TIMESTAMP);
  const countdown = timestamp
    ? Number(timestamp) - new Date().getTime()
    : LEAVE_PAGE_COUNTDOWN;
  return countdown &gt; 0 ? countdown : 0;
};

/** è·å¾—ç¦»å¼€é¡µé¢å®šæ—¶å™¨ */
const getLeavePageTimeout = (): NodeJS.Timeout =&gt; {
  return setTimeout(() =&gt; leavePage(), getLeavePageCountdown());
};

export default () =&gt; {
  useEffect(() =&gt; {
    // åˆå§‹åŒ–æ—¶è®¾ç½®ç¦»å¼€é¡µé¢çš„æ—¶é—´
    sessionStorage.setItem(
      LEAVE_PAGE_TIMESTAMP,
      String(new Date().getTime() + LEAVE_PAGE_COUNTDOWN),
    );

    return () =&gt; {
      // é¡µé¢å¸è½½æ—¶æ¸…é™¤ SessionStorage
      sessionStorage.removeItem(LEAVE_PAGE_TIMESTAMP);
    };
  }, []);

  useEffect(() =&gt; {
    // åˆå§‹åŒ–æ—¶è®¾ç½®å®šæ—¶å™¨
    let timer = getLeavePageTimeout();

    const onWindowVisibilityChange = () =&gt; {
      // é‡æ–°æ ¡å‡†å®šæ—¶å™¨
      if (document.visibilityState === &quot;visible&quot;) {
        // æ¸…é™¤å·²æœ‰å®šæ—¶å™¨
        if (timer) clearTimeout(timer);
        // è®¾ç½®æ–°çš„å®šæ—¶å™¨
        timer = getLeavePageTimeout();
      }
    };
    // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬å™¨
    window.addEventListener(&quot;visibilitychange&quot;, onWindowVisibilityChange);

    return () =&gt; {
      // é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨å’Œç›‘å¬å™¨
      if (timer) clearTimeout(timer);
      window.removeEventListener(&quot;visibilitychange&quot;, onWindowVisibilityChange);
    };
  }, []);
};
```

ä¸Šé¢çš„ä»£ç åšäº†è¿™äº›äº‹æƒ…ï¼š

1. å½“ç”¨æˆ·è¿›å…¥åˆ°é¡µé¢æ—¶ï¼Œåœ¨ SessionStorage å­˜å‚¨äº†åº”å½“æ‰§è¡Œä¸šåŠ¡éœ€æ±‚çš„æ—¶é—´æˆ³ã€‚
2. å¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨ï¼Œåœ¨æŒ‡å®šæ—¶é—´ä»¥åæ‰§è¡Œä¸šåŠ¡éœ€æ±‚ã€‚
3. å¯åŠ¨ä¸€ä¸ªç›‘å¬å™¨ï¼Œå½“é¡µé¢å¯è§æ€§å‘ç”Ÿæ”¹å˜ï¼Œå˜ä¸ºã€Œå¯è§ã€æ—¶ï¼Œæ ¡å‡†å®šæ—¶å™¨ï¼šæ¸…é™¤å·²æœ‰çš„å®šæ—¶å™¨ï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªæ–°çš„å®šæ—¶å™¨ï¼Œåœ¨æ–°çš„æŒ‡å®šæ—¶é—´ä»¥åæ‰§è¡Œä¸šåŠ¡éœ€æ±‚ã€‚å…¶ä¸­ï¼Œæ–°çš„æŒ‡å®šæ—¶é—´ç”±å­˜å‚¨çš„æ—¶é—´æˆ³å’Œå½“å‰çš„æ—¶é—´è®¡ç®—å¾—æ¥ã€‚

### ä½¿ç”¨ SetInterval è½®è®­

å“‡å™»ï¼Œæœ‰å¤Ÿéº»çƒ¦ã€‚æ¢ä¸€ç§æ€è·¯ï¼Œä½¿ç”¨è½®è®­çš„å®ç°æ–¹å¼ï¼ŒåŸºäº SetInterval ä¸æ–­æ¯”è¾ƒå½“å‰çš„æ—¶é—´æˆ³å’Œåº”å½“ç¦»å¼€é¡µé¢çš„æ—¶é—´æˆ³ï¼Œè‹¥å½“å‰çš„æ—¶é—´æˆ³å¤§äºåº”å½“ç¦»å¼€é¡µé¢çš„æ—¶é—´æˆ³ï¼Œæ‰§è¡Œç¦»å¼€é¡µé¢çš„ä¸šåŠ¡æ–¹æ³•å°±å¥½äº†ã€‚è¿™ç§å®ç°æ–¹å¼æ— éœ€è´¹åŠ›åœ°é‡æ–°æ ¡å‡†æ—¶é—´ï¼Œæ˜¯ä¸€ä¸ªè®¨å·§çš„é€‰æ‹©ï¼š

```tsx
import React, { useEffect } from &quot;react&quot;;

const LEAVE_PAGE_COUNTDOWN = 12 * 60 * 60 * 1000;

/** ç¦»å¼€é¡µé¢çš„æ–¹æ³• */
const leavePage = () =&gt; {
  // ...ç¦»å¼€å½“å‰é¡µé¢çš„ä¸šåŠ¡ä»£ç 
};

export default () =&gt; {
  useEffect(() =&gt; {
    // è·å–æ‰§è¡Œä¸šåŠ¡éœ€æ±‚çš„æ—¶é—´æˆ³
    const timestamp = new Date().getTime() + LEAVE_PAGE_COUNTDOWN;

    // åˆå§‹åŒ–æ—¶è®¾ç½®è½®è¯¢å™¨
    const timer = setInterval(() =&gt; {
      const now = new Date().getTime();
      if (now &gt;= timestamp) {
        leavePage();
      }
    }, 1000);

    return () =&gt; {
      // é¡µé¢å¸è½½æ—¶æ¸…é™¤è½®è¯¢å™¨
      if (timer) clearInterval(timer);
    };
  }, []);
};
```

### ä¼¼ä¹éƒ½ä¸å¤ªä¼˜é›…

ä½†æ˜¯ï¼Œä»¥ä¸Šçš„å®ç°éƒ½ä¼šå¯¼è‡´ä¸€äº›ä½“éªŒä¸Šçš„é—®é¢˜ï¼šç”¨æˆ·ä»åå°åˆ‡æ¢åˆ°è¯¥é¡µé¢æ—¶ï¼Œè‹¥è¶…è¿‡äº† 12 ä¸ªå°æ—¶ï¼Œå®šæ—¶å™¨æˆ–è½®è¯¢å™¨ä¸€è¿è¡Œï¼Œå”°çš„ä¸€ä¸‹å­è·¯ç”±å‘ç”Ÿæ”¹å˜ï¼Œç”¨æˆ·ä¼šæ„Ÿåˆ°éå¸¸å¥‡æ€ªã€‚

è™½ç„¶åŠ ä¸Šä¸€äº› Notification å‘ŠçŸ¥åˆšåˆšå‘ç”Ÿäº†å•¥ä¼šå‡å°‘ç”¨æˆ·çš„ä¸é€‚ï¼Œä½†ç»ˆç©¶æˆ‘ä»¬è¿˜æ˜¯ä¼šå¸Œæœ›æµè§ˆå™¨èƒ½**å®Œå…¨æ­£å¸¸**åœ°è¿è¡Œå®šæ—¶å™¨æ–¹æ³•ï¼ˆè¿™æ˜¯æˆ‘ä»¬ä¸æƒ³è¦è¢«åå°ä¼˜åŒ–çš„åŠŸèƒ½ï¼‰ï¼Œè€Œä¸éœ€è¦åšè¿™äº›å¸¦æ¥é¢å¤–å¼€é”€ä¸”**ä¸ç¬¦åˆç›´è§‰**çš„é€‚é…ï¼ˆä¸‹ä¸€ä»»ç¨‹åºå‘˜çœ‹åˆ°ä»£ç å°±å¤´ç–¼ï¼‰ã€‚

æ­¤å¤–ï¼Œè¿™æ ·çš„åšæ³•å¹¶ä¸èƒ½æ»¡è¶³å¯¹**å‡†ç¡®åº¦è¦æ±‚é«˜**çš„å®šæ—¶å™¨éœ€æ±‚ã€‚

åŸºäºä»¥ä¸Šéœ€æ±‚ï¼Œæœ¬æ–‡çš„ä¸»è§’ **Web Worker** ç»™å‡ºäº†ç°ä»£ã€æ™®é€‚çš„è§£å†³æ–¹æ¡ˆã€‚

## ç”Ÿäº§å®è·µçš„è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ Web Worker

&gt; Web Worker ä¸º Web å†…å®¹åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œè„šæœ¬æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹æ³•ã€‚çº¿ç¨‹å¯ä»¥æ‰§è¡Œä»»åŠ¡è€Œä¸å¹²æ‰°ç”¨æˆ·ç•Œé¢â€¦â€¦ä¸€ä¸ª worker æ˜¯ä½¿ç”¨ä¸€ä¸ªæ„é€ å‡½æ•°åˆ›å»ºçš„ä¸€ä¸ªå¯¹è±¡è¿è¡Œä¸€ä¸ªå‘½åçš„ JavaScript æ–‡ä»¶ï¼šè¿™ä¸ªæ–‡ä»¶åŒ…å«å°†åœ¨å·¥ä½œçº¿ç¨‹ä¸­è¿è¡Œçš„ä»£ç ï¼›workers è¿è¡Œåœ¨å¦ä¸€ä¸ªå…¨å±€ä¸Šä¸‹æ–‡ä¸­ï¼Œä¸åŒäºå½“å‰çš„ windowã€‚
&gt;
&gt; \-\- [MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers)

Web Worker èƒ½å¤Ÿä¸º JavaScript åˆ›å»ºå¤šçº¿ç¨‹ç¯å¢ƒï¼Œå…è®¸å°†ä¸»çº¿ç¨‹ä¸­çš„ä»»åŠ¡åˆ†é…ç»™ Worker çº¿ç¨‹å¤„ç†ï¼Œä¸»çº¿ç¨‹å’Œ Worker çº¿ç¨‹ä¹‹é—´å¯ä»¥è¿›è¡Œé€šä¿¡ã€‚å½“é‡åˆ°è®¡ç®—å¯†é›†å‹æˆ–é«˜å»¶è¿Ÿçš„ä»»åŠ¡æ—¶ï¼Œå¸¸ä½¿ç”¨ Web Worker è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼šåœ¨ Worker çº¿ç¨‹è¿›è¡Œå¤æ‚çš„è®¡ç®—æ“ä½œï¼Œè¿›è€Œé¿å…ä¸»çº¿ç¨‹é˜»å¡æˆ–å¡æ­»ã€‚

Worker çº¿ç¨‹ä¸€æ—¦åˆ›å»ºæˆåŠŸï¼Œå°†**å§‹ç»ˆè¿è¡Œ**ï¼Œä¸ä¼šè¢«ä¸»çº¿ç¨‹ä¸Šçš„æ´»åŠ¨ä¸­æ–­ã€‚ä½†æ˜¯ï¼Œè¿™ä¹Ÿæ„å‘³ç€ Worker ä½¿ç”¨å®Œæ¯•ååº”å½“ç«‹å³å…³é—­ï¼Œé¿å…é€ æˆé¢å¤–çš„ç³»ç»Ÿå¼€é”€ã€‚

åªéœ€è¦äº†è§£ Web Worker çš„åŸºæœ¬ç”¨æ³•ï¼Œå°±èƒ½å¾ˆå¥½åœ°å®ç°æœ¬æ¬¡ä¸šåŠ¡ä¸Šçš„éœ€æ±‚ã€‚å°† `setTimeout()` æ–¹æ³•ç§»åŠ¨åˆ° Worker ä¸­å»ï¼Œåªè¦æµè§ˆå™¨ä¸å…³é—­ï¼ŒWorker å°†ä¿æŒè¿è¡Œçš„çŠ¶æ€ï¼Œåœ¨æ­£ç¡®çš„æ—¶æœºå‘ä¸»çº¿ç¨‹è¿”å›ç¦»å¼€é¡µé¢çš„æ¶ˆæ¯ã€‚

### Webpack çš„æ–¹å¼

é¦–å…ˆç¼–å†™ä¸€ä¸ª Web Worker è„šæœ¬æ–‡ä»¶ `leavePage.worker.js`ï¼š

```js
let timer;

self.onmessage = (event) =&gt; {
  // console.log(&quot;Received message from main thread&quot;, event.data);

  if (timer) {
    clearTimeout(timer);
  }

  timer = setTimeout(() =&gt; {
    // å‘ä¸»çº¿ç¨‹å‘å‡ºæ¶ˆæ¯
    self.postMessage(`Time to leave page ${new Date()}`);
    // event.data å³ç¦»å¼€é¡µé¢çš„å€’è®¡æ—¶ï¼ˆmsï¼‰
  }, event.data);
};
```

å¦‚æœæ‚¨çš„é¡¹ç›®åŸºäº Webpack 4.xï¼Œé‚£ä¹ˆéœ€è¦é…ç½® [`worker-loader`](https://github.com/webpack-contrib/worker-loader) æˆ– [`worker-plugin`](https://github.com/GoogleChromeLabs/worker-plugin) ç­‰ loader æˆ–æ’ä»¶æ‰èƒ½é€šè¿‡ `new Worker(url)` çš„æ–¹å¼æ­£å¸¸å¼•å…¥ Web Workerã€‚

åœ¨ React ä»£ç é‡Œè¯»å–è„šæœ¬æ–‡ä»¶ï¼Œå³å¯åˆ›å»º Worker çº¿ç¨‹å¹¶ç›‘å¬å®ƒè¿”å›çš„æ¶ˆæ¯ï¼š

```tsx
import React, { useEffect } from &quot;react&quot;;

/** ç¦»å¼€é¡µé¢çš„æ–¹æ³• */
const leavePage = () =&gt; {
  // ...ç¦»å¼€å½“å‰é¡µé¢çš„ä¸šåŠ¡ä»£ç 
};

export default () =&gt; {
  useEffect(() =&gt; {
    // æ–°å»º Worker çº¿ç¨‹
    // const worker = new Worker(&quot;path/to/leavePage.worker.js&quot;);

    // å‘ Worker çº¿ç¨‹å‘å‡ºæ¶ˆæ¯ï¼Œè®¾å®š 12h åè¿”å›æ¶ˆæ¯
    worker.postMessage(12 * 60 * 60 * 1000);

    // ç›‘å¬ Worker è¿”å›çš„æ¶ˆæ¯
    worker.onmessage = (event) =&gt; {
      // ä¸€æ—¦æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰§è¡Œç¦»å¼€é¡µé¢çš„ä¸šåŠ¡ä»£ç 
      console.log(&quot;Received message from worker thread&quot;, event.data);
      leavePage();
      // ä¸€æ—¦å®Œæˆå“åº”ï¼Œå…³é—­ Worker çº¿ç¨‹
      worker.terminate();
    };

    return () =&gt; {
      // é¡µé¢å¸è½½æ—¶å…³é—­ Worker çº¿ç¨‹
      worker.terminate();
    };
  }, []);
};
```

å¯¹äº Webpack 5.x ä»¥ä¸Šçš„é¡¹ç›®ï¼ŒWebpack å·²å†…ç½®äº†å¯¹ Web Worker çš„æ”¯æŒï¼Œå¯[æŸ¥é˜…æ–‡æ¡£](https://webpack.js.org/guides/web-workers)ä½¿ç”¨ã€‚

### åŠ¨æ€åŠ è½½çš„æ–¹å¼

å¦‚æœä¸æƒ³åœ¨ Webpack ä¸ŠåŠ  loader æˆ–æ’ä»¶ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘ã€ŒåŠ¨æ€ã€åœ°åŠ è½½è„šæœ¬æ–‡ä»¶ï¼Œè¿™éœ€è¦ä¸€ç‚¹ç‚¹å°æŠ€å·§ã€‚é¦–å…ˆå°† Worker åŒ…å«çš„å…·ä½“å†…å®¹ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å¯¼å‡ºï¼š

```js
// leavePage.worker.js
const leavePageWorker = `
var timer;
self.onmessage = function (event) {
  // ...
};
`;

export default leavePageWorker;
```

åœ¨ä¸»çº¿ç¨‹çš„ä»£ç é‡Œå¯¼å…¥å­—ç¬¦ä¸²å¹¶åˆ›å»ºçœŸæ­£çš„ Worker çº¿ç¨‹ï¼š

```ts
import LeavePageWorker from &quot;path/to/leavePage.worker.js&quot;;

const loadWebWorker = (code: string): Worker =&gt; {
  const blob = new Blob([&quot;(&quot; + code + &quot;)()&quot;]);
  return new Worker(URL.createObjectURL(blob));
};

const leavePageWorker = loadWebWorker(LeavePageWorker);
```

éœ€æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨åŠ¨æ€åŠ è½½çš„æ–¹å¼æ„å‘³ç€ Worker çš„ä»£ç å°†ä¸ç» Webpack è€Œç›´æ¥è°ƒç”¨ï¼Œæ‰€ä»¥åº”å½“ä½¿ç”¨å…¼å®¹æ€§æ›´å¥½çš„ã€Œå¤æ—© JavaScript è¯­æ³•ã€ï¼Œä¾‹å¦‚ `var` `function(){}` ç­‰ã€‚

ç”±äºæµè§ˆå™¨çš„ Content Security Policy (CSP) ç­–ç•¥ï¼Œé€šè¿‡æ­¤æ–¹æ³•åˆ›å»º Worker å¯èƒ½ä¼šå¤±è´¥ï¼Œå¯ä»¥å‚è€ƒ[æ­¤ä»‹ç»](https://stackoverflow.com/questions/30280370/how-does-content-security-policy-csp-work)è¿›è¡Œè§£å†³ã€‚

### Umi é¡¹ç›®çš„æ–¹å¼

æ ¹æ® [Umi æ–‡æ¡£](https://v3.umijs.org/config#workerloader)ï¼Œå¯¹äº Umi 3.4.1+ çš„é¡¹ç›®ï¼Œå¯ä»¥è¿›è¡Œå¦‚ä¸‹é…ç½®å¯ç”¨å¯¹ Web Worker çš„æ”¯æŒï¼š

```ts
// config.ts
export default defineConfig({
  workerLoader: {},
});
```

ç„¶è€Œ Umi æ–‡æ¡£å¹¶æ²¡æœ‰æ Web Worker çš„å¼•å…¥æ–¹å¼ï¼Œä¸è¿‡æŸ¥é˜… [Umi æºç ](https://github.com/umijs/umi/blob/3.x/packages/bundler-webpack/src/getConfig/getConfig.ts#L364-L372)å‘ç°ï¼š

```ts
if (config.workerLoader) {
  webpackConfig.module
    .rule(&quot;worker&quot;)
    .test(/.*worker.(ts|js)/) // Web Worker æ–‡ä»¶å‘½åè§„åˆ™
    .use(&quot;worker-loader&quot;)
    .loader(require.resolve(&quot;@umijs/deps/compiled/worker-loader&quot;))
    .options(config.workerLoader);
}
```

å¯çŸ¥ Umi åŸºäº `worker-loader`ï¼Œå°† `worker.ts` æˆ– `worker.js` ç»“å°¾çš„æ–‡ä»¶å½“ä½œ Web Worker å¤„ç†ã€‚é‚£ä¹ˆå¯ä»¥è¿™æ ·ç¼–å†™ä¸»çº¿ç¨‹çš„ä»£ç ï¼š

```tsx
import React, { useEffect } from &quot;react&quot;;
import LeavePageWorker from &quot;path/to/leavePage.worker.js&quot;;

export default () =&gt; {
  useEffect(() =&gt; {
    // æ–°å»º Worker çº¿ç¨‹
    const worker: Worker = new LeavePageWorker();

    // åƒä¹‹å‰ä¸€æ ·ç›‘å¬ worker äº‹ä»¶å³å¯
    // ...

    return () =&gt; {
      // åˆ«å¿˜äº†ä½¿ç”¨å®Œåå…³é—­ Worker çº¿ç¨‹
      worker.terminate();
    };
  }, []);
};
```

Worker çš„ç¼–è¯‘å’Œè¿è¡Œå‡åœ¨åå°æ‰§è¡Œï¼Œè¿™æ„å‘³ç€å³ä½¿å‡ºç°æŠ¥é”™ä¹Ÿä¸ä¼šæ˜¾å¼æé†’æ‚¨ã€‚æ‚¨å¯ä»¥éšæ—¶åœ¨å¼€å‘è€…å·¥å…·é‡Œæ‰¾åˆ°ç¼–è¯‘å¾—åˆ°çš„ Worker çš„ä»£ç ï¼š

![åœ¨å¼€å‘è€…å·¥å…·ä¸­æŸ¥çœ‹ Worker æºç ](./js-webworker-settimeout/webworker-source.jpg)

å¯¹äº Umi 3.4.1 ä»¥å‰ç‰ˆæœ¬çš„é¡¹ç›®ï¼Œå¯ä»¥é€šè¿‡ [`chainWebpack`](https://v3.umijs.org/config#chainwebpack) æ·»åŠ  `worker-loader` æˆ– `worker-plugin` æ’ä»¶çš„æ”¯æŒã€‚

Umi 4.x å†…ç½® Webpack 5.x ä½œä¸ºé»˜è®¤ Bundlerï¼Œå› æ­¤[æŸ¥é˜…æ–‡æ¡£](https://webpack.js.org/guides/web-workers)ä½¿ç”¨å³å¯ã€‚

### ä¸‰æ–¹åº“çš„æ–¹å¼

å¦‚æœä¸ä»‹æ„ Web Worker ç¼–å†™æ˜¯å¦åŸç”Ÿï¼ˆç¬”è€…ä»ä¸ä»‹æ„ï¼ï¼‰ï¼Œæ›´æ¨èé€‰ç”¨å°è£…äº† Web Worker èƒ½åŠ›çš„ä¸‰æ–¹åº“ï¼Œä¾‹å¦‚ [`alewin/useWorker`](https://github.com/alewin/useWorker) å’Œ [`developit/greenlet`](https://github.com/developit/greenlet/) ç­‰ã€‚

å®ƒä»¬é™ä½äº†ä½¿ç”¨ Web Worker çš„å¿ƒæ™ºæˆæœ¬ï¼Œä½¿å¾—è°ƒç”¨ Web Worker å°±åƒç¼–å†™æ™®é€šçš„ `async` å¼‚æ­¥å‡½æ•°ä¸€æ ·ï¼›é‡è¦çš„æ˜¯ï¼Œä¸å¿…å†æ‹…å¿ƒå¼•å…¥ Web Worker æ—¶å¸¦æ¥çš„å„ç§å„æ ·çš„å¥‡æ€ªé—®é¢˜ï¼ˆCDN éƒ¨ç½²æ—¶ï¼Œå¯èƒ½å‘ç”ŸåŒæºé—®é¢˜ï¼‰ã€‚

ä»¥ `alewin/useWorker` ä¸ºä¾‹ï¼Œå¯ä»¥è¿™æ ·æ”¹è¿›å‰é¢çš„ä»£ç ï¼š

```tsx
import React, { useEffect } from &quot;react&quot;;
import { useWorker } from &quot;@koale/useworker&quot;;

/**
 * ä¼‘çœ  @timeout æ¯«ç§’
 */
const setTimeoutAsync = (timeout: number) =&gt; {
  return new Promise&lt;void&gt;((resolve) =&gt;
    setTimeout(() =&gt; {
      resolve();
    }, timeout),
  );
};

export default () =&gt; {
  const [setTimeoutWorker, { kill: killSetTimeoutWorker }] =
    useWorker(setTimeoutAsync);

  useEffect(() =&gt; {
    const runLeavePageWorker = async () =&gt; {
      await setTimeoutWorker(12 * 60 * 60 * 1000);
      // ... åœ¨æ­¤å¤„æ‰§è¡Œç¦»å¼€é¡µé¢çš„ä¸šåŠ¡ä»£ç 
    };

    runLeavePageWorker();

    return () =&gt; {
      killSetTimeoutWorker();
    };
  }, []);
};
```

## å‚è€ƒæ–‡ç« 

- [Web Worker ä½¿ç”¨æ•™ç¨‹ - é˜®ä¸€å³°](https://www.ruanyifeng.com/blog/2018/07/web-worker.html)
- [è®°ä¸€æ¬¡å®šæ—¶å™¨é—®é¢˜çš„ä¼˜é›…è§£å†³](https://juejin.cn/post/6855583384375132174)
- [web worker onmessage - Uncaught SyntaxError: Unexpected token \&lt;](https://stackoverflow.com/questions/49171791/web-worker-onmessage-uncaught-syntaxerror-unexpected-token)
- [Combination of async function + await + setTimeout](https://stackoverflow.com/questions/33289726/combination-of-async-function-await-settimeout)
</content:original-text><content:updated-at>2022-09-22T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[è¿æ¥åˆ° Windows ç«¯çš„ PostgreSQL æ•°æ®åº“]]></title><description><![CDATA[å‡è®¾ï¼Œæ‚¨èº«è¾¹æœ‰ä¸¤å°ç”µè„‘ï¼Œä¸€å°æ‰“ç®—ç”¨æ¥åš PostgreSQL æ•°æ®åº“æœåŠ¡å™¨ï¼Œä¸€å°ç”¨æ¥åšå®¢æˆ·ç«¯ã€‚æœåŠ¡å™¨ä¸Šçš„ PostgreSQL 14 å®‰è£…åœ¨  ç›®å½•ä¸‹ï¼Œæ•°æ®åº“æ–‡ä»¶ä¿å­˜åœ¨  ç›®å½•ï¼Œæ¬²è®¿é—®çš„æ•°æ®åº“åä¸º ï¼Œè®¿é—®æ•°æ®åº“çš„ç”¨æˆ·ä¸º ã€‚ é…ç½® 

ç¼–è¾‘æ•°æ®åº“é…ç½®æ–‡ä»¶ ï¼Œè®¾ç½®ç›‘å¬çš„è¿œç¨‹è¿æ¥åœ°å€ã€‚å°†  é¡¹çš„å€¼è®¾ç½®ä¸º ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

é…ç½® 

ç¼–è¾‘æ•°æ®åº“å®¢æˆ·ç«¯è®¤è¯é…ç½®æ–‡ä»¶ ï¼Œè®¾ç½®å…è®¸è¿æ¥åˆ°æ•°æ®åº“çš„å®¢æˆ·ç«¯ IP åœ°å€ã€‚

è¯¥â€¦]]></description><link>https://blog.towind.fun/posts/connect-with-pgsql</link><guid isPermaLink="false">connect-with-pgsql</guid><category><![CDATA[åç«¯å¼€å‘]]></category><pubDate>Sat, 12 Feb 2022 00:00:00 GMT</pubDate><content:original-text>
å‡è®¾ï¼Œæ‚¨èº«è¾¹æœ‰ä¸¤å°ç”µè„‘ï¼Œä¸€å°æ‰“ç®—ç”¨æ¥åš PostgreSQL æ•°æ®åº“æœåŠ¡å™¨ï¼Œä¸€å°ç”¨æ¥åšå®¢æˆ·ç«¯ã€‚æœåŠ¡å™¨ä¸Šçš„ PostgreSQL 14 å®‰è£…åœ¨ `C:\Program Files\PostgreSQL\14` ç›®å½•ä¸‹ï¼Œæ•°æ®åº“æ–‡ä»¶ä¿å­˜åœ¨ `C:\Program Files\PostgreSQL\14\data` ç›®å½•ï¼Œæ¬²è®¿é—®çš„æ•°æ®åº“åä¸º `db_name`ï¼Œè®¿é—®æ•°æ®åº“çš„ç”¨æˆ·ä¸º `db_user`ã€‚

## é…ç½® `postgresql.conf`

ç¼–è¾‘æ•°æ®åº“é…ç½®æ–‡ä»¶ `C:\Program Files\PostgreSQL\14\data\postgresql.conf`ï¼Œè®¾ç½®ç›‘å¬çš„è¿œç¨‹è¿æ¥åœ°å€ã€‚å°† `listen_addresses` é¡¹çš„å€¼è®¾ç½®ä¸º `*`ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```conf
# - Connection Settings -

listen_addresses = &apos;*&apos;  # what IP address(es) to listen on
```

## é…ç½® `pg_hba.conf`

ç¼–è¾‘æ•°æ®åº“å®¢æˆ·ç«¯è®¤è¯é…ç½®æ–‡ä»¶ `C:\Program Files\PostgreSQL\14\data\pg_hba.conf`ï¼Œè®¾ç½®å…è®¸è¿æ¥åˆ°æ•°æ®åº“çš„å®¢æˆ·ç«¯ IP åœ°å€ã€‚

è¯¥æ–‡ä»¶çš„æ³¨é‡Šå¤„å·²ç»ç»™å‡ºäº†å„ç§é…ç½®çš„è¯¦ç»†è¯´æ˜ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å°†é‡ç‚¹æ”¾åœ¨å¯¹å…è®¸çš„è¿œç¨‹è¿æ¥åœ°å€çš„é…ç½®ä¸Šã€‚

`pg_hba.conf` å¯¹ ADDRESS åœ°å€çš„è§£æåŸºäº [CIDR æ— ç±»åˆ«åŸŸé—´è·¯ç”±](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing)ã€‚

é‚£ä¹ˆï¼Œå¯¹äº IPv4 åœ°å€ï¼Œæœ‰å¦‚ä¸‹äº”ç§å…¸å‹æƒ…å†µï¼š

| ADDRESS           | è¯´æ˜                                           |
| ----------------- | ---------------------------------------------- |
| 210.41.111.111/32 | ä»…å…è®¸ IP åœ°å€ä¸º 210.41.111.111 çš„è¿œç¨‹è¿æ¥è¯·æ±‚ |
| 210.41.111.0/24   | å…è®¸ IP åœ°å€ä¸º 210.41.111.\* çš„è¿œç¨‹è¿æ¥è¯·æ±‚    |
| 210.41.0.0/16     | å…è®¸ IP åœ°å€ä¸º 210.41.\*.\* çš„è¿œç¨‹è¿æ¥è¯·æ±‚     |
| 210.0.0.0/8       | å…è®¸ IP åœ°å€ä¸º 210.\*.\*.\* çš„è¿œç¨‹è¿æ¥è¯·æ±‚     |
| 0.0.0.0/0         | å…è®¸æ‰€æœ‰ IP åœ°å€çš„è¿œç¨‹è¿æ¥è¯·æ±‚                 |

é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬çš„å®¢æˆ·ç«¯çš„ IP åœ°å€ä¸º `210.41.112.112`ï¼Œå¯ä»¥æ·»åŠ æ¡ç›®å¦‚ä¸‹ï¼š

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD
host    db_name         db_user         210.41.112.112/32       scram-sha-256
# host    db_name         db_user         210.41.112.0/24         scram-sha-256
# host    db_name         db_user         210.41.0.0/16           scram-sha-256
# host    db_name         db_user         210.0.0.0/8             scram-sha-256
# host    db_name         db_user         0.0.0.0/0               scram-sha-256
```

æ›´å°çš„èŒƒå›´ï¼Œæ„å‘³ç€æ›´é«˜çš„å®‰å…¨æ€§ã€‚

## é‡å¯æ•°æ®åº“æœåŠ¡

ä¸ºäº†è®©é…ç½®ç”Ÿæ•ˆï¼Œæˆ‘ä»¬éœ€è¦é‡å¯å¯åŠ¨ PostgreSQL æ•°æ®åº“ã€‚

åœ¨ Windows ç«¯ï¼ŒPostgreSQL ä½œä¸ºä¸€ä¸ªæœåŠ¡è¿è¡Œã€‚æŒ‰ Windows é”®ï¼Œæœç´¢ `service`ï¼Œè¿›å…¥æœåŠ¡åº”ç”¨ï¼Œæ‰¾åˆ° `postgresql-x64-*` æœåŠ¡ï¼Œå³é”®é‡æ–°å¯åŠ¨å³å¯ã€‚

![é‡å¯ PostgreSQL æ•°æ®åº“](./connect-with-pgsql/restart-pgsql.png)

## è¿æ¥åˆ°æ•°æ®åº“

### åŒä¸€è·¯ç”±å™¨ä¸‹

é…ç½® `pg_hba.conf`ï¼Œå…è®¸ç›¸åŒè·¯ç”±å™¨ä¸‹å…¶å®ƒä¸»æœºçš„è¿æ¥è¯·æ±‚ã€‚ä¾‹å¦‚ï¼Œå…è®¸ IP åœ°å€ä¸º `192.168.0.0` è‡³ `192.168.255.255` çš„è¿æ¥è¯·æ±‚ï¼š

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD
host    db_name         db_user         192.168.0.0/16          scram-sha-256
```

é‡æ–°å¯åŠ¨æ•°æ®åº“æœåŠ¡ã€‚

å‡è®¾æœåŠ¡å™¨çš„å†…ç½‘ IP åœ°å€ä¸º `192.168.1.104`ï¼Œæ•°æ®åº“ç›‘å¬ç«¯å£ä¸º `5432`ã€‚é‚£ä¹ˆï¼Œå½“æˆ‘ä»¬é€šè¿‡å®¢æˆ·ç«¯è¿æ¥è¿œç¨‹æ•°æ®åº“æ—¶ï¼Œä¸»æœºååº”å¡«å†™ `192.168.1.104`ï¼Œç«¯å£åº”å¡«å†™ `5432`ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½é¡ºåˆ©è®¿é—®åˆ°æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“äº†ã€‚

### è¿œç¨‹è¿æ¥

å‡å¦‚æ‚¨çš„ç”¨ä½œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„ç”µè„‘åˆ†éš”ä¸¤åœ°ï¼Œç°åœ¨æƒ³è¦è¿œç¨‹è¿æ¥æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿä¸‹é¢æ˜¯æˆ‘å¸¸ç”¨çš„åŠæ³•ã€‚

é¦–å…ˆï¼Œéœ€è¦è·å–æœåŠ¡å™¨çš„å…¬ç½‘ IP åœ°å€ï¼Œå¯ä»¥åœ¨[è¿™é‡Œ](https://www.ip138.com/)æŸ¥è¯¢ã€‚è¿™é‡Œå‡è®¾æœåŠ¡å™¨é€šè¿‡è·¯ç”±å™¨ä¸å…¬ç½‘è¿æ¥ã€‚

æ¥ç€ï¼Œé…ç½®è·¯ç”±å™¨çš„**è™šæ‹ŸæœåŠ¡å™¨**ã€‚å¯ä»¥é€šè¿‡å¦‚ä¸‹æ­¥éª¤å®ç°ï¼š

1. å°†æœåŠ¡å™¨çš„å†…ç½‘ IP åœ°å€ä¸å®ƒçš„ç¡¬ä»¶ MAC åœ°å€ç»‘å®šã€‚åˆ«å¿˜äº†åœ¨æœåŠ¡å™¨çš„ç½‘ç»œå±æ€§å¤„ï¼Œå…³é—­éšæœºç¡¬ä»¶åœ°å€åŠŸèƒ½ã€‚
2. é…ç½®è™šæ‹ŸæœåŠ¡å™¨ï¼Œæ˜ å°„è·¯ç”±å™¨çš„å¤–éƒ¨ç«¯å£ä¸ºæœåŠ¡å™¨çš„æ•°æ®åº“ç«¯å£ã€‚

æœ€åï¼Œä¿®æ”¹ `pg_hba.conf`ï¼Œæ ¹æ®å®¢æˆ·ç«¯çš„å…¬ç½‘ IP åœ°å€è¿›è¡Œé…ç½®ã€‚å¦‚æœå®¢æˆ·ç«¯çš„ç½‘ç»œç¯å¢ƒç»å¸¸å˜åŒ–ï¼Œå°½ç®¡ä¸å®‰å…¨ï¼Œä½†ä¹Ÿå¯ä»¥è€ƒè™‘è®¾ç½®å…è®¸æ‰€æœ‰ IP åœ°å€è¿›è¡Œè¿æ¥ã€‚

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD
host    db_name         db_user         0.0.0.0/0               scram-sha-256
host    db_name         db_user         ::/0                    scram-sha-256
```

é‡æ–°å¯åŠ¨æ•°æ®åº“æœåŠ¡ã€‚

ä¾‹å¦‚ï¼Œè·¯ç”±å™¨çš„å…¬ç½‘ IP åœ°å€ä¸º `210.41.111.111`ï¼ŒæœåŠ¡å™¨çš„å†…ç½‘ IP åœ°å€ä¸º `192.168.1.104`ï¼Œè™šæ‹ŸæœåŠ¡å™¨å¤–éƒ¨ç«¯å£ä¸º `22212`ï¼Œæ•°æ®åº“ç›‘å¬ç«¯å£ä¸º `5432`ã€‚é‚£ä¹ˆï¼Œå½“æˆ‘ä»¬é€šè¿‡å®¢æˆ·ç«¯è¿æ¥è¿œç¨‹æ•°æ®åº“æ—¶ï¼Œä¸»æœºååº”å¡«å†™ `210.41.111.111`ï¼Œç«¯å£åº”å¡«å†™ `22212`ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½é¡ºåˆ©è®¿é—®åˆ°æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“äº†ã€‚
</content:original-text><content:updated-at>2022-02-12T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[è¿™ä½å®¢å®˜ï¼Œè¦æ¥ä¸€å¼ æˆ‘çè—è®¸ä¹…çš„å›¾ç‰‡å—]]></title><description><![CDATA[ç¬”è€…è‡ªé«˜ä¸­åˆ°ç°åœ¨ï¼Œæ¸¸èµ°äº Pixiv è‹¥å¹²è½½ï¼Œä¸æ…æ”¶è—äº†è®¸å¤šåå®¶é›…ä½œã€‚ ç‹¬ä¹ä¹ä¸å¦‚ä¼—ä¹ä¹ï¼ç¬”è€…æƒ³åšä¸€ä¸ª web é¡µé¢æ¥éšæœºè®¿é—®æˆ‘çš„æ”¶è—ï¼Œä¸è¿‡åœ¨æ­¤ä¹‹å‰ï¼Œå¯ä»¥å…ˆå®ç°æœåŠ¡ç«¯ä¸Šçš„å†…å®¹ã€‚å†ä¹‹ååšç½‘é¡µæ—¶ï¼Œä¸è¿‡æ˜¯ç®€å•çš„è¯»å–æ•°æ®åº“ç½¢äº†ï¼

æœ€åˆï¼Œç¬”è€…ä»¥ä¸ºå¾—å°†æˆ‘çš„åº“å­˜å…¨éƒ¨æ”¾åˆ°æœåŠ¡å™¨ä¸Šé¡¹ç›®ä¸­å»ï¼Œç„¶åéšæœºè®¿é—®å…¶ä¸­çš„å›¾ç‰‡å®ç°åŠŸèƒ½ï¼Œä½†è¿™æ ·åšå¾ˆéš¾å¾—åŒæ­¥ï¼Œé‚æç½®ã€‚ä¸è¿‡ï¼Œç¬”è€…åœ¨æœ€è¿‘å‘ç°æœ‰ä¸€ä¸ª Pixiv å›¾ç‰‡ä»£ç†ç½‘ç«™ å¯ä»¥å¿«é€Ÿä¸‹è½½â€¦]]></description><link>https://blog.towind.fun/posts/random-get-me-a-picture</link><guid isPermaLink="false">random-get-me-a-picture</guid><category><![CDATA[åç«¯å¼€å‘]]></category><pubDate>Thu, 13 Jan 2022 00:00:00 GMT</pubDate><content:original-text>
ç¬”è€…è‡ªé«˜ä¸­åˆ°ç°åœ¨ï¼Œæ¸¸èµ°äº Pixiv è‹¥å¹²è½½ï¼Œä¸æ…æ”¶è—äº†è®¸å¤šåå®¶é›…ä½œã€‚

ç‹¬ä¹ä¹ä¸å¦‚ä¼—ä¹ä¹ï¼ç¬”è€…æƒ³åšä¸€ä¸ª web é¡µé¢æ¥éšæœºè®¿é—®æˆ‘çš„æ”¶è—ï¼Œä¸è¿‡åœ¨æ­¤ä¹‹å‰ï¼Œå¯ä»¥å…ˆå®ç°æœåŠ¡ç«¯ä¸Šçš„å†…å®¹ã€‚å†ä¹‹ååšç½‘é¡µæ—¶ï¼Œä¸è¿‡æ˜¯ç®€å•çš„è¯»å–æ•°æ®åº“ç½¢äº†ï¼

æœ€åˆï¼Œç¬”è€…ä»¥ä¸ºå¾—å°†æˆ‘çš„åº“å­˜å…¨éƒ¨æ”¾åˆ°æœåŠ¡å™¨ä¸Šé¡¹ç›®ä¸­å»ï¼Œç„¶åéšæœºè®¿é—®å…¶ä¸­çš„å›¾ç‰‡å®ç°åŠŸèƒ½ï¼Œä½†è¿™æ ·åšå¾ˆéš¾å¾—åŒæ­¥ï¼Œé‚æç½®ã€‚ä¸è¿‡ï¼Œç¬”è€…åœ¨æœ€è¿‘å‘ç°æœ‰ä¸€ä¸ª [Pixiv å›¾ç‰‡ä»£ç†ç½‘ç«™](https://pixiv.re/) å¯ä»¥å¿«é€Ÿä¸‹è½½åˆ°å›¾ç‰‡ï¼Œå¤§å–œï¼Œäºæ˜¯å¼€å§‹äº†è¿™ä¸ªå°å·¥ç¨‹ã€‚

![è¯·æ±‚éœ€åŒ…å« Referer](./random-get-me-a-picture/pixiv-cat.png)

å®ç°æ­¤åŠŸèƒ½åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šä¸€ï¼Œä¸ºæœ¬åœ°çš„å›¾ç‰‡ç”Ÿæˆæ•°æ®åº“ç´¢å¼•æ¡ç›®ã€‚äºŒï¼Œå¼€å‘ Telegram Bot æ¥å£ï¼Œéšæœºä»æ•°æ®åº“ç´¢å¼•ä¸­è·å–ä¸€å¼ å›¾ç‰‡è½¬å‘ç»™èŠå¤©ã€‚

## ä¸ºæœ¬åœ°çš„ Pixiv å›¾ç‰‡å»ºç«‹ç´¢å¼•

### åˆå§‹åŒ–æ•°æ®åº“ Pixiv å›¾ç‰‡ç´¢å¼•ä¿¡æ¯

å¦‚æœä½¿ç”¨ Pixiv å›¾ç‰‡ä»£ç†çš„æ–¹æ³•ï¼Œåªéœ€è¦å°† Artwork çš„åŸºæœ¬ä¿¡æ¯ä¸Šä¼ ç»™æˆ‘ä»¬çš„æ•°æ®åº“å³å¯ã€‚

æ ¹æ®[å®˜æ–¹æ–‡æ¡£](https://core.telegram.org/bots/api#sending-files)ï¼Œå½“å‘é€å›¾ç‰‡æ–‡ä»¶æ—¶ï¼ŒTelegram API å¯¹å›¾ç‰‡çš„å¤§å°æœ‰é™åˆ¶ï¼šç›´æ¥ä½¿ç”¨ HTTP URL çš„æ–¹å¼ä¸è¶…è¿‡ 5 MBï¼ŒæœåŠ¡å™¨ä¸Šä¼ å›¾ç‰‡çš„æ–¹å¼ä¸è¶…è¿‡ 10 MBï¼ˆä»¥[æ–‡ä»¶çš„æ ¼å¼](https://core.telegram.org/bots/api#senddocument)å‘é€æ—¶ï¼Œä¸è¶…è¿‡ 50 MBï¼Œæœ¬æ–‡ä¸é‡‡ç”¨æ–‡ä»¶çš„æ ¼å¼å‘é€ï¼‰ã€‚å› æ­¤ï¼Œåœ¨è®¾è®¡æ•°æ®åº“æ—¶ï¼Œè¿˜éœ€è¦è€ƒè™‘å›¾ç‰‡çš„å¤§å°ã€‚

è®¾è®¡ Sequenlize æ•°æ®åº“æ¨¡å‹ `ServicePixivCollection.js` å¦‚ä¸‹ï¼š

```js
const { DataTypes } = require(&quot;sequelize&quot;);

module.exports = {
  id: {
    type: DataTypes.INTEGER,
    autoIncrement: true,
    primaryKey: true,
  },
  // Pixiv artwork ID. Example: 95400283 for for 95400283_p${picIndex}.${picType}
  picId: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  // Artwork index. Example: 1 for ${pixivId}_p1.${picType}
  picIndex: {
    type: DataTypes.INTEGER,
    allowNull: false,
  },
  // Artwork suffix type. Example: jpg for ${pixivId}_p${picIndex}.jpg
  picType: {
    type: DataTypes.TEXT,
    allowNull: false,
  },
  // Artwork size, MB
  picSize: {
    type: DataTypes.FLOAT,
    allowNull: false,
  },
  // Artwork save date
  picCreatedAt: {
    type: DataTypes.DATE,
    allowNull: false,
  },
};
```

å¦‚é‡‡ç”¨æœ€å°å®ç°ï¼Œä¹Ÿå¯ä»¥å°†ä¸Šé¢çš„ `picId`, `picIndex` å’Œ `picType` åˆå¹¶ä¸ºä¸€ä¸ªæ•°æ®é¡¹ï¼Œä¾‹å¦‚ `picName`ï¼Œç›´æ¥ä¿å­˜å›¾ç‰‡çš„åå­—ã€‚ç¬”è€…è€ƒè™‘åˆ°åç»­å¯èƒ½ä¼šå¢æ·»æ–°çš„åŠŸèƒ½ï¼Œäºæ˜¯å°†å®ƒä»¬å•ç‹¬æ‹å‡ºæ¥å‚¨å­˜ã€‚

å¤„ç†ä¸åŒè·¯å¾„ä¸‹çš„å›¾ç‰‡æ—¶ï¼Œå¯èƒ½éœ€è¦ä¿å­˜æ‰§è¡Œçš„æƒ…å†µã€‚ä¾‹å¦‚ A ç›®å½•åœ¨å½“å‰æ—¶é—´ç‚¹è¿›è¡Œç»´æŠ¤ï¼Œè·å–äº†æ‰€æœ‰çš„å›¾ç‰‡ï¼Œä¸‹æ¬¡è¯»å– A ç›®å½•æ—¶ï¼Œåº”å½“ä»ä¸Šæ¬¡ç»´æŠ¤çš„æ—¶é—´å¼€å§‹è·å–æœ€æ–°çš„å›¾ç‰‡ã€‚ç°åœ¨æ–°åŠ äº† B ç›®å½•ï¼Œå¦‚æœä»ä¸Šæ¬¡ç»´æŠ¤ A çš„æ—¶é—´ç‚¹å¼€å§‹è¯»å–å›¾ç‰‡çš„è¯ï¼Œåœ¨æ—¶é—´ç‚¹ä¹‹å‰çš„å›¾ç‰‡å°†æ— æ³•ä¸Šä¼ ã€‚å› æ­¤ï¼Œé’ˆå¯¹ä¸åŒæ–‡ä»¶å¤¹çš„ç»´æŠ¤ï¼Œå¯ä»¥åˆ†åˆ«å»ºç«‹ä¸€ä¸ªå•ç‹¬çš„æ•°æ®é¡¹ã€‚

è®¾è®¡æ•°æ®åº“æ¨¡å‹ `ServiceProcess.js` å¦‚ä¸‹ï¼š

```js
const { DataTypes } = require(&quot;sequelize&quot;);

module.exports = {
  id: {
    type: DataTypes.INTEGER,
    autoIncrement: true,
    primaryKey: true,
  },
  serviceId: {
    type: DataTypes.UUID,
    defaultValue: DataTypes.UUIDV4,
    allowNull: false,
  },
  serviceName: {
    type: DataTypes.TEXT,
    allowNull: false,
  },
  serviceConfig: {
    type: DataTypes.TEXT,
  },
  serviceSharedData: {
    type: DataTypes.TEXT,
  },
  lastExecAt: {
    type: DataTypes.DATE,
  },
  haveExecTime: {
    type: DataTypes.INTEGER,
    allowNull: false,
    defaultValue: 0,
  },
};
```

ä¸º Sequelize æ·»åŠ è¯¥æ¨¡å‹ï¼Œå‘ `sequelize.js` æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

```js
const servicePixivCollectionModel = require(&quot;path/to/ServicePixivCollection&quot;);
const serviceProcessModel = require(&quot;path/to/ServiceProcess&quot;);

sequelize.define(&quot;ServicePixivCollection&quot;, servicePixivCollectionModel);
sequelize.define(&quot;ServiceProcess&quot;, serviceProcessModel);
```

é…ç½®æ‰«æå›¾ç‰‡çš„é—´éš”æ—¶é—´å’Œæœ¬åœ°å›¾ç‰‡è·¯å¾„ï¼Œç¼–å†™ `config.js` å¦‚ä¸‹:

```js
module.exports = {
  pixiv: {
    randomGetFromCollection: {
      duration: 3600,
      path: [&quot;C:\\path\\to\\collection&quot;],
    },
  },
};
```

æ‰«ææŒ‡å®šç›®å½•çš„å›¾ç‰‡æ–‡ä»¶ï¼Œå›¾ç‰‡æ–‡ä»¶åç§°åº”æ»¡è¶³ä» Pixiv ä¸‹è½½å›¾ç‰‡çš„åç§°æ ¼å¼ã€‚ä¾‹å¦‚ï¼š`95400283_p0.jpg`ï¼Œ`95400283` ä¸ºæ•°æ®åº“ä¸­çš„ `picId`ï¼Œ`_p0` çš„ `0` ä¸º `picIndex`ï¼Œ`.jpg` ä¸­çš„ `jpg` ä¸º `picType`ã€‚ç¼–å†™ç”Ÿæˆå›¾ç‰‡ç´¢å¼•çš„ä»£ç  `pixiv.js` å¦‚ä¸‹ï¼š

```js
const { readdir, stat } = require(&quot;fs/promises&quot;);
const path = require(&quot;path&quot;);

const config = require(&quot;path/to/config&quot;).pixiv;

const Sequelize = require(&quot;path/to/sequelize&quot;);

const generateCollectionIndex = async function () {
  const serviceName = &quot;Generate Collection Index&quot;;
  const bToMB = 1024 * 1024;

  // File size with decimal places
  const fileSizeReservedDecimalPlace = 3;
  const fileSizeReservedDecimalNum = 10 ** fileSizeReservedDecimalPlace;

  const sequelize = await Sequelize();
  const ServicePixivCollection = sequelize.models.ServicePixivCollection;
  const ServiceProcess = sequelize.models.ServiceProcess;

  let collectionPaths = config.generateCollectionIndex.path;
  if (!Array.isArray(collectionPaths)) {
    collectionPaths = [collectionPaths];
  }

  // Get filenames in collection paths
  let allFiles = [];
  for (const collectionPath of collectionPaths) {
    let files = [];
    files = files.concat(await readdir(collectionPath));

    // Only keep files with Pixiv naming style
    const reg = /^\d+_p\d+.(jpg|png|gif)$/;
    files = files.filter((filename) =&gt; {
      return reg.test(filename);
    });

    // Get file stat and resolve file info
    for (let i = 0; i &lt; files.length; i++) {
      const filename = files[i];
      const filePath = path.join(collectionPath, filename);

      const picIdSplitArr = filename.split(&quot;_p&quot;);
      const picId = Number(picIdSplitArr[0]);

      const picIndexSplitArr = picIdSplitArr[1].split(&quot;.&quot;);
      const picIndex = Number(picIndexSplitArr[0]);

      const picType = picIndexSplitArr[1];

      const picStat = await stat(filePath);
      const picSize =
        Math.floor((picStat.size / bToMB) * fileSizeReservedDecimalNum) /
        fileSizeReservedDecimalNum; // MB
      const picCreatedAt = picStat.mtimeMs; // ms

      files[i] = {
        picName: filename,
        picId,
        picIndex,
        picType,
        picSize,
        picCreatedAt,
      };
    }

    // Only keep files that recently saved
    const serviceProcess = await ServiceProcess.findOne({
      where: { serviceName, serviceConfig: collectionPath },
    });
    if (serviceProcess) {
      // Only update or create Pixiv artwork that saved after last time this service is done
      let lastUpdateIndexTime = serviceProcess.dataValues.lastExecAt;
      if (lastUpdateIndexTime) {
        lastUpdateIndexTime = new Date(lastUpdateIndexTime).getTime();
        files = files.filter((pic) =&gt; {
          return pic.picCreatedAt &gt; lastUpdateIndexTime;
        });
      }
    } else {
      await ServiceProcess.create({
        serviceName,
        serviceConfig: collectionPath,
      });
    }

    allFiles = allFiles.concat(files);
  }

  const updateIndexAt = new Date().toISOString();

  // Update or create pic index
  for (const picFile of allFiles) {
    // æ³¨æ„ï¼šæ­¤å¤„çš„ updateOrCreate() ä¸ºç¬”è€…è‡ªå®šä¹‰çš„æ–¹æ³•
    // å…¶ä½œç”¨ä¸ºï¼šå½“å­˜åœ¨ item æ—¶ï¼Œæ›´æ–° itemï¼›ä¸å­˜åœ¨æ—¶ï¼Œåˆ›å»º item
    await sequelize.updateOrCreate(
      ServicePixivCollection,
      {
        picId: picFile.picId,
        picIndex: picFile.picIndex,
      },
      picFile,
    );
  }

  // Update service process record
  ServiceProcess.update(
    {
      lastExecAt: updateIndexAt,
    },
    {
      where: { serviceName },
    },
  );
  ServiceProcess.increment(&quot;haveExecTime&quot;, { where: { serviceName } });
};

module.exports = {
  generateCollectionIndex,
};
```

è®¾ç½®å®šæ—¶æ‰«æå›¾ç‰‡ï¼ŒåŸºäº `toad-scheduler` åº“ç¼–å†™æœåŠ¡ä»£ç å¦‚ä¸‹ï¼š

```js
const {
  ToadScheduler,
  SimpleIntervalJob,
  AsyncTask,
} = require(&quot;toad-scheduler&quot;);

const pixivTask = require(&quot;path/to/pixiv&quot;);
const config = require(&quot;path/to/config&quot;).pixiv;

const initService = async function () {
  const taskGenerateCollectionIndex = new AsyncTask(
    &quot;Generate Pixiv Collection Index&quot;,
    async () =&gt; {
      await pixivTask.generateCollectionIndex();
    },
    (error) =&gt; {
      console.error(error);
    },
  );
  const jobGenerateCollectionIndex = new SimpleIntervalJob(
    {
      seconds: config.generateCollectionIndex.duration,
      runImmediately: true,
    },
    taskGenerateCollectionIndex,
  );

  const scheduler = new ToadScheduler();
  scheduler.addSimpleIntervalJob(jobGenerateCollectionIndex);
};

module.exports = initService;
```

ç¨‹åºå¯åŠ¨æ—¶ï¼Œè¿è¡Œ `initService()` å³å¯ã€‚æœåŠ¡å™¨å°†è‡ªåŠ¨è¯»å–æŒ‡å®šç›®å½•ä¸‹çš„ Pixiv å›¾ç‰‡æ–‡ä»¶ï¼Œå¹¶åœ¨æ•°æ®åº“ä¸­å»ºç«‹ç´¢å¼•ã€‚[ä¸‹ä¸€æ­¥](#éšæœºè·å–æ•°æ®åº“ä¸­çš„ä¸€ä¸ª-pixiv-å›¾ç‰‡è®¿é—®åœ°å€)ï¼Œæˆ‘ä»¬å°†éšæœºä»æ•°æ®åº“ä¸­è¯»å–ä¸€å¼ ä½œå“çš„ä¿¡æ¯ã€‚

### æ€è·¯ï¼šçˆ¬å– Pixiv å›¾ç‰‡çš„æºæ–‡ä»¶åœ°å€

å¦‚æœä½¿ç”¨äº²è‡ªè·å–å›¾ç‰‡å¹¶è½¬å‘çš„æ–¹æ³•ï¼Œé™¤äº†å‰é¢éœ€è¦åˆå§‹åŒ–æ•°æ®åº“çš„å›¾ç‰‡ç´¢å¼•ä¿¡æ¯å¤–ï¼Œè¿˜éœ€è¦æ„å»º Axios è¯·æ±‚ï¼Œçˆ¬å–ç½‘é¡µæºä»£ç ï¼Œä»ä¸­è¯»å– Artwork çš„ä¸‹è½½é“¾æ¥ç­‰ä¿¡æ¯ï¼Œå†ä¸Šä¼ åˆ°æ•°æ®åº“ã€‚

ä¾‹å¦‚ï¼Œå¯¹äºä¸‹è½½ [`95400283_p0.jpg`](https://www.pixiv.net/artworks/95400283)ï¼Œæœ€å°‘éœ€è¦è·å–å…¶æºæ–‡ä»¶é“¾æ¥ `https://i.pximg.net/img-original/img/2022/01/09/07/27/17/95400283_p0.jpg` ä¸­çš„ `/2022/01/09/07/27/17` éƒ¨åˆ†ï¼Œå¹¶ä¸Šä¼ åˆ°æ•°æ®åº“ä¸­ã€‚

æ›´å¤šçš„ï¼Œåœ¨çˆ¬å–æºä»£ç æ—¶ï¼Œå¯ä»¥è®°å½•ä¸‹å›¾ç‰‡çš„ä½œè€…ä¿¡æ¯ï¼Œå›¾ç‰‡æ˜¯å¦å¯ä»¥åœ¨å·¥ä½œæ—¶å®‰å…¨è§‚çœ‹ï¼ˆç™»å½•åæ‰èƒ½çˆ¬å–æ­¤ç±»å†…å®¹ï¼Œå¯èƒ½éœ€è¦åœ¨è¯·æ±‚æ—¶æ·»åŠ ä¸ªäººè´¦æˆ·ä¿¡æ¯ï¼‰ç­‰ï¼Œå¯¹æ—¥åå¤„ç†å±•ç¤ºå†…å®¹å¤§æœ‰è£¨ç›Šã€‚

å¤„ç†ç½‘é¡µæºä»£ç æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ [cheerio](https://github.com/cheeriojs/cheerio) åº“å¢åŠ æ•ˆç‡ã€‚

## ä¸º Telegram Bot æ·»åŠ éšæœºè·å– Pixiv å›¾ç‰‡çš„æ¥å£

### éšæœºè·å–æ•°æ®åº“ä¸­çš„ä¸€ä¸ª Pixiv å›¾ç‰‡è®¿é—®åœ°å€

ç¼–å†™ `randomGetPixivCollection.js` ä»£ç å¦‚ä¸‹ï¼š

```js
const Sequelize = require(&quot;path/to/sequelize&quot;);

const randomGetPixivCollection = async function () {
  try {
    const sequelize = await Sequelize();
    const ServicePixivCollection = sequelize.models.ServicePixivCollection;

    // Gain the total number of Pixiv artworks
    const artworksCount = await ServicePixivCollection.count();

    // Generate a random value
    const randomArtworkId = Math.floor(Math.random() * artworksCount) + 1;

    // Get random artwork
    const artwork = await ServicePixivCollection.findOne({
      where: { id: randomArtworkId },
    });

    // Resolve artwork object
    const data = artwork.dataValues;

    const picId = data.picId;
    const picIndex = data.picIndex;
    const picType = data.picType;

    data.picName = `${picId}_p${picIndex}.${picType}`;
    data.picNameMD = `${picId}\\_p${picIndex}\\.${picType}`;
    data.picUrl = `https://www.pixiv.net/artworks/${picId}`;

    let picProxyUrlParam;
    if (picIndex &gt; 0) {
      picProxyUrlParam = `${picId}-${picIndex + 1}.${picType}`;
    } else {
      picProxyUrlParam = `${picId}.${picType}`;
    }
    data.picProxyUrl = `https://pixiv.cat/${picProxyUrlParam}`;

    return {
      ok: true,
      data,
      error: undefined,
    };
  } catch (error) {
    return {
      ok: false,
      data: undefined,
      error,
    };
  }
};

module.exports = randomGetPixivCollection;
```

æ ¹æ® Pixiv.cat ç½‘ç«™çš„ä½¿ç”¨è¯´æ˜ï¼Œå¯¹å•å¼ å›¾ç‰‡çš„ Pixiv ä½œå“ï¼Œåº”è®¿é—® `https://pixiv.cat/${picId}.${picType}`ã€‚è€Œå¯¹äºå¤šå¼ å›¾ç‰‡çš„ Pixiv ä½œå“ï¼ˆæ¼«ç”»ï¼‰ï¼Œåº”è®¿é—® `https://pixiv.cat/${picId}-${picIndex + 1}.${picType}`ã€‚

å¯èƒ½ä¼šå½±å“ä½“éªŒï¼Œéœ€è¦æ”¹è¿›çš„åœ°æ–¹æ˜¯ï¼šå½“ä½œå“åä¸º `${picId}_p0.${picType}` æ—¶ï¼Œæˆ‘ä»¬ä¸çŸ¥é“è¯¥ä½œå“æ˜¯å¦ä¸ºå•å¼ å›¾ç‰‡ï¼Œè¿˜æ˜¯æ¼«ç”»ä½œå“ï¼Œæ— æ³•æ­£ç¡®åˆ¤æ–­åº”è¯¥è®¿é—®çš„ URL é“¾æ¥ã€‚[åœ¨åé¢](#ç›´æ¥ä½¿ç”¨-pixiv-å›¾ç‰‡ä»£ç†)ï¼Œæˆ‘ä»¬å°†é’ˆå¯¹æ­¤æƒ…å†µåšå¤„ç†ã€‚

### æ·»åŠ  Telegram Bot å‘½ä»¤

æ¥ä¸‹æ¥ä¸º Bot æ·»åŠ æŒ‡ä»¤ï¼Œä»¥è°ƒç”¨éšæœºè·å–å›¾ç‰‡çš„æ¥å£ã€‚åŒæ ·ï¼Œè¿™é‡Œç»™å‡ºä½¿ç”¨ Pixiv å›¾ç‰‡ä»£ç†çš„å…·ä½“å®ç°ï¼Œä»¥åŠäº²è‡ªè·å–å›¾ç‰‡å¹¶è½¬å‘çš„å¯èƒ½æ€è·¯ã€‚

#### ç›´æ¥ä½¿ç”¨ Pixiv å›¾ç‰‡ä»£ç†

æ³¨æ„ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼ä¸Šä¼ çš„å›¾ç‰‡**ä¸è¶…è¿‡ 5 MB**ã€‚

ç¼–å†™ Bot çš„é…ç½®å¦‚ä¸‹ï¼š

```js
bot.onText(/\/random_pixiv/, async (msg) =&gt; {
  const chatId = msg.chat.id;

  const res = await randomGetPixivCollection();
  if (res.ok === true) {
    // Send placeholder message
    const placeholderMessage = await bot.sendMessage(
      chatId,
      `Geeeeting a random Pixiv artwork ...`,
    );

    const data = res.data;
    const {
      id,
      picNameMD,
      picUrl,
      picSize,
      picProxyUrl,
      picId,
      picIndex,
      picType,
    } = data;

    const caption = `[source](${picUrl})`;

    let msgReplied = false;

    if (picSize &lt; 5) {
      // Artwork size is smaller than 5 MB, send photo message
      const sendPhotoOptions = {
        caption,
        parse_mode: &quot;MarkdownV2&quot;,
        disable_web_page_preview: true,
      };

      try {
        await bot.sendPhoto(chatId, picProxyUrl, sendPhotoOptions);

        msgReplied = true;
      } catch (err) {
        if (picIndex == 0) {
          try {
            // Comic mode artwork with index=0 may send failed
            // Use comic mode url instead
            const picProxyUrl = `https://pixiv.cat/${picId}-1.${picType}`;
            await bot.sendPhoto(chatId, picProxyUrl, sendPhotoOptions);

            msgReplied = true;
          } catch (err) {
            //
          }
        }
      }
    }

    // Artwork size is not smaller than 5 MB or send failed again,
    // send caption message
    if (!msgReplied) {
      await bot.sendMessage(chatId, caption, {
        parse_mode: &quot;MarkdownV2&quot;,
        disable_web_page_preview: false,
      });
    }

    // Remove placeholder message
    bot.deleteMessage(chatId, placeholderMessage.message_id);
  } else {
    bot.sendMessage(
      chatId,
      &quot;Get random pixiv artwork failed. You may try to call it again later!&quot;,
    );
  }
});
```

åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œå½“ä»¥ `bot.sendPhoto()` çš„æ–¹æ³•å°è¯•å‘é€ 5 MB ä»¥ä¸‹çš„å›¾ç‰‡å¤±è´¥æ—¶ï¼Œé¦–å…ˆé‡æ–°æ„å»ºè¯·æ±‚ URL ä¸º `https://pixiv.cat/${data.picId}-1.${data.picType}`ï¼Œå†æ¬¡è¿›è¡Œå‘é€ã€‚å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼ˆå¯èƒ½å›¾ç‰‡è¢«ä½œè€…åˆ é™¤ï¼‰ï¼Œåˆ™å‘é€ç®€å•çš„é“¾æ¥æ–‡æœ¬ã€‚ç”±æ­¤ï¼Œè§£å†³äº†å‰é¢æåˆ°çš„æ— æ³•åˆ¤æ–­ä½œå“æ˜¯å¦ä¸ºæ¼«ç”»ä½œå“çš„é—®é¢˜ã€‚

ä¸ Telegram ä¸Šçš„æœºå™¨äººå¯¹è¯ï¼Œå‘é€å‘½ä»¤ `\random_pixiv`ï¼Œç»“æœå¦‚ä¸‹ï¼š

![Bot service](./random-get-me-a-picture/bot-service.png)

#### æ€è·¯ï¼šè·å– Pixiv å›¾ç‰‡å¹¶è½¬å‘

æ³¨æ„ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼ä¸Šä¼ çš„å›¾ç‰‡**ä¸è¶…è¿‡ 10 MB**ã€‚

æˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨ `bot.sendPhoto()` æ–¹æ³•ä¸­ä½¿ç”¨ Pixiv æºç«™å›¾ç‰‡çš„è·å–é“¾æ¥ï¼Œè¿™æ˜¯å› ä¸º Pixiv è®¾ç½®äº†åçˆ¬è™«æœºåˆ¶ï¼Œåªæ¥æ”¶è¯·æ±‚å¤´çš„ Referer åŒ…å« `https://www.pixiv.net/` çš„è¯·æ±‚ã€‚

![è¯·æ±‚éœ€åŒ…å« Referer](./random-get-me-a-picture/pixiv-request-referer.png)

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šæ„é€  Axios è¯·æ±‚ï¼Œè®¾ç½® Referer è¯·æ±‚å¤´ï¼Œç„¶åå‘é€è¯·æ±‚å‘ Pixiv æœåŠ¡å™¨è·å–å›¾ç‰‡ï¼Œå†å°†å›¾ç‰‡è½¬ä¸º `multipart/form-data` æ ¼å¼å‘é€ç»™ Telegram ä¼šè¯ã€‚

## ä¸º Koa æ·»åŠ éšæœºè·å– Pixiv å›¾ç‰‡çš„æ¥å£

Koa åº”ç”¨ç¨‹åºæœ¬èº«ä¹Ÿæä¾›äº†è·¯ç”±åŠŸèƒ½ï¼Œåœ¨è¿™é‡Œå¯ä»¥å¾ˆè½»æ¾åœ°å°†è·å–éšæœº Pixiv å›¾ç‰‡çš„æœåŠ¡å¯¹æ¥åˆ° Koa ä¸Šå»ã€‚

ç¼–å†™è·¯ç”±æ–‡ä»¶å¦‚ä¸‹ï¼š

```js
const router = require(&quot;koa-router&quot;)();

const randomGetPixivCollection = require(&quot;path/to/randomGetPixivCollection&quot;);

router.get(&quot;/random&quot;, async function (ctx) {
  const res = await randomGetPixivCollection();
  if (res.ok === true) {
    ctx.redirect(res.data.picProxyUrl);
  } else {
    ctx.body = &quot;Get random Pixiv artwork failed.&quot;;
  }
});

module.exports = router;
```

ç„¶è€Œï¼Œè¿™é‡Œå¹¶æ²¡æœ‰è§£å†³å‰é¢æåˆ°çš„æ¼«ç”»ä½œå“é—®é¢˜ï¼Œç•™å¾…ç”¨æˆ·åœ¨è·³è½¬åè‡ªè¡Œæ“ä½œã€‚

## å‚è€ƒæ–‡ç« 

- [çˆ¬å– pixiv æ¯æ—¥æ¨è](https://blog.csdn.net/weixin_45826022/article/details/109406389)
</content:original-text><content:updated-at>2022-01-15T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[ä»é›¶å¼€å§‹ä½¿ç”¨ Telegram Bot]]></title><description><![CDATA[æœ¬æ–‡åŸºäº Koa ä»é›¶å¼€å§‹æ­å»ºä¸€ä¸ªç®€å•çš„ Telegram Bot åº”ç”¨æœåŠ¡ï¼Œæ”¯æŒè·å– Github Issues çš„è¯„è®ºå¹¶è½¬å‘åˆ° Telegram é¢‘é“ï¼Œå¸®åŠ©ç¬”è€…æ›´å¥½åœ°å°†æ£ç© Telegramï¼ æ—¶é—´æ¨ç§»è‡³ 2024 å¹´ï¼Œç¬”è€…ç°åœ¨æ›´å»ºè®®ä½¿ç”¨ Bun å¼€å‘åº”ç”¨æœåŠ¡ï¼Œå¼€ç®±å³ç”¨çš„é«˜æ€§èƒ½æœåŠ¡ä»¥åŠå®Œå¤‡çš„ TypeScript æ”¯æŒï¼Œèƒ½å¤§å¤§æå‡å¼€å‘ä½“éªŒã€‚ä¸‹é¢ä¸ºæ’°å†™äº 2022 å¹´åˆçš„åŸæ–‡ã€‚

æœ¬æ–‡å‡è®¾æ‚¨å·²â€¦]]></description><link>https://blog.towind.fun/posts/start-telegram-bot</link><guid isPermaLink="false">start-telegram-bot</guid><category><![CDATA[åç«¯å¼€å‘]]></category><pubDate>Sun, 09 Jan 2022 00:00:00 GMT</pubDate><content:original-text>
æœ¬æ–‡åŸºäº Koa ä»é›¶å¼€å§‹æ­å»ºä¸€ä¸ªç®€å•çš„ Telegram Bot åº”ç”¨æœåŠ¡ï¼Œæ”¯æŒè·å– Github Issues çš„è¯„è®ºå¹¶è½¬å‘åˆ° Telegram é¢‘é“ï¼Œå¸®åŠ©ç¬”è€…æ›´å¥½åœ°å°†æ£ç© Telegramï¼

&gt; æ—¶é—´æ¨ç§»è‡³ 2024 å¹´ï¼Œç¬”è€…ç°åœ¨æ›´å»ºè®®ä½¿ç”¨ [Bun](https://bun.sh) å¼€å‘åº”ç”¨æœåŠ¡ï¼Œå¼€ç®±å³ç”¨çš„é«˜æ€§èƒ½æœåŠ¡ä»¥åŠå®Œå¤‡çš„ TypeScript æ”¯æŒï¼Œèƒ½å¤§å¤§æå‡å¼€å‘ä½“éªŒã€‚ä¸‹é¢ä¸ºæ’°å†™äº 2022 å¹´åˆçš„åŸæ–‡ã€‚

æœ¬æ–‡å‡è®¾æ‚¨å·²å¯¹ Node.js å’Œ Koa æœ‰ä¸€å®šçš„äº†è§£ã€‚

## åˆå§‹åŒ– Koa é¡¹ç›®

[Koa](https://koajs.com/) æ˜¯ä¸º Node.js è®¾è®¡çš„ä¸‹ä¸€ä»£ Web æ¡†æ¶ï¼Œå…¶å¹•åå¼€å‘è€…ä¸»è¦æ¥è‡ªçŸ¥åçš„ Express å›¢é˜Ÿã€‚

å°½ç®¡ä½¿ç”¨ [koa-generator](https://github.com/i5ting/koa-generator) æ¥åˆå§‹åŒ– Koa é¡¹ç›®æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä½†ç¬”è€…è¿˜æ˜¯å–œæ¬¢ä»å¤´å¼€å§‹çš„æ„Ÿè§‰ã€‚

é‚£ä¹ˆé¦–å…ˆï¼Œæ–°å»ºæ–‡ä»¶å¤¹å¹¶è¿›å…¥ï¼Œä½¿ç”¨ `npm init` åˆå§‹åŒ– `package.json`ã€‚

å®‰è£…å¿…è¦çš„ä¾èµ–ï¼š

```bash
npm install koa koa-router koa-bodyparser dotenv
```

å®‰è£…å¼€å‘ä¾èµ–ï¼š

```bash
npm install -D nodemon
```

å®‰è£…æœåŠ¡å™¨éƒ¨ç½²æ—¶ä½¿ç”¨çš„ä¾èµ–ï¼š

```bash
npm install pm2
```

ä¸ºäº†ç®€ä¾¿ï¼Œè¿™é‡Œç¬”è€…ä½¿ç”¨äº†åˆ«äººè¿›è¡Œå°è£…åçš„ Telegram Bot API åº“ [node-telegram-bot-api](https://github.com/yagop/node-telegram-bot-api)ï¼š

```bash
npm install node-telegram-bot-api
```

è§„åˆ’é¡¹ç›®ç›®å½•ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š

```plaintext
.
â”œâ”€â”€ .env
â”œâ”€â”€ app.js
â”œâ”€â”€ package.json
â”œâ”€â”€ bin
â”‚   â””â”€â”€ www.js
â””â”€â”€ routes
â”‚   â””â”€â”€ index.js
â””â”€â”€ service
    â”œâ”€â”€ bot.js
    â””â”€â”€ index.js
```

å…¶ä¸­ï¼Œ`.env` ä¸ºç¯å¢ƒé…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬ Telegram Bot Token åœ¨å†…çš„ä¿¡æ¯åœ¨æ­¤å¤„é…ç½®ï¼›`bin/www.js` ä¸ºé¡¹ç›®å¯åŠ¨æ—¶æ‰§è¡Œçš„æ–‡ä»¶ï¼Œè¿™æ„å‘³ç€åœ¨é…ç½®è„šæœ¬å‘½ä»¤æ—¶ï¼Œåº”å½“ä½¿ç”¨ `nodemon bin/www` åŠ `pm2 start bin/www`ï¼›`routes` ç›®å½•ä¸ºè·¯ç”±ç›®å½•ï¼Œç”¨æ¥å­˜æ”¾å¯è°ƒç”¨çš„æ¥å£ï¼›æœ€åï¼Œ`service` ç›®å½•ä¸ºæœåŠ¡ç›®å½•ï¼Œåœ¨è¿™é‡Œè¿æ¥ Bot å’Œæ•°æ®åº“ï¼Œå¹¶æ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‚

## è¿æ¥åˆ° Telegram Bot

### åˆ›å»ºæ–°çš„ Bot

é¦–å…ˆï¼Œé€šè¿‡åœ¨ Telegram ä¸Šä¸ [BotFather](https://core.telegram.org/bots#6-botfather) äº¤äº’ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Telegram Botã€‚

![create a new bot](./start-telegram-bot/create-bot.png)

è®°å½•ä¸‹å½“ä¸­çš„ **HTTP API** çš„å€¼å³ Telegram Bot Tokenï¼Œä½œä¸ºé¡¹ç›®çš„ç¯å¢ƒå˜é‡ä¿å­˜ï¼Œåˆ‡å‹¿ä¸Šä¼ åˆ°è¿œç¨‹ä»£ç ä»“åº“ä¸­ã€‚

```js
const token = process.env.TELEGRAM_BOT_TOKEN;
```

### ä¸ Bot å»ºç«‹è¿æ¥

æˆ‘ä»¬çš„é¡¹ç›®å¯èƒ½æ— æ³•ç›´æ¥è®¿é—®åˆ° Telegram çš„æœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨ [**SOCKS5 ä»£ç†**](https://github.com/mattcg/socks5-https-client)è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```js
const TelegramBot = require(&quot;node-telegram-bot-api&quot;);
const proxySocks5Agent = require(&quot;socks5-https-client/lib/Agent&quot;);

requestOptions = {
  agentClass: proxySocks5Agent,
  agentOptions: {
    socksHost: process.env.PROXY_SOCKS5_HOST,
    socksPort: process.env.PROXY_SOCKS5_PORT,
    socksUsername: process.env.PROXY_SOCKS5_USERNAME,
    socksPassword: process.env.PROXY_SOCKS5_PASSWORD,
  },
};

const bot = new TelegramBot(token, {
  polling: true,
  request: requestOptions,
});
```

å¦‚ä½• SOCKS5 å·¥ä½œä¸æ­£å¸¸ï¼ˆ[è¿™æ˜¯](https://github.com/yagop/node-telegram-bot-api/issues/696#issuecomment-613023532)ä¸€ä¸ªå¯èƒ½çš„åŸå› ï¼‰ï¼Œä¹Ÿå¯ä»¥å°è¯•ä½¿ç”¨ **HTTP ä»£ç†**ï¼š

```js
const TelegramBot = require(&quot;node-telegram-bot-api&quot;);

requestOptions = {
  proxy: process.env.PROXY_HTTP,
};

const bot = new TelegramBot(token, {
  polling: true,
  request: requestOptions,
});
```

å¯¹ Bot è¿›è¡Œæµ‹è¯•ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

```js
bot.onText(/\/start/, (msg) =&gt; {
  // console.log(msg)
  bot.sendMessage(msg.chat.id, &quot;Hi, this is Telly Bot!&quot;);
});
```

æ‰“å¼€ Telegramï¼Œå¯¹ Bot å‘é€ `/start`ï¼Œçœ‹çœ‹æ˜¯å¦ä¼šå¾—åˆ° `Hi, this is Telly Bot!` çš„å›åº”ã€‚

### ä½¿ç”¨ç½‘ç»œé’©å­ä¸ Bot äº¤äº’

Telegram Bot å¯ä»¥é€šè¿‡è½®è¯¢ï¼ˆpollingï¼‰å’Œç½‘ç»œé’©å­ï¼ˆwebhookï¼‰ä¸¤ç§ä¸åŒçš„æ–¹å¼æ¥è·å–ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼Œåœ¨å‰é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯è½®è¯¢çš„æ–¹å¼ã€‚

è½®è¯¢çš„æ–¹å¼æ— éœ€é¢å¤–çš„é…ç½®ï¼Œæ›´é€‚åˆæœ¬åœ°å¿«é€Ÿè¿›è¡Œå¼€å‘æµ‹è¯•ï¼›è€Œç½‘ç»œé’©å­çš„æ–¹å¼æ›´é€‚åˆé¡¹ç›®éƒ¨ç½²ã€‚é‚£ä¹ˆï¼Œä¸€ä¸ªå¥å…¨çš„ Telegram Bot åº”å½“ä½¿ç”¨**ç½‘ç»œé’©å­**çš„æ–¹å¼æ¥å®ç°ã€‚

ä¸ºäº†æ¥æ”¶ç”¨æˆ·å¯¹ Telegram Bot å‘é€çš„æ¶ˆæ¯ï¼Œåœ¨ç½‘ç»œé’©å­çš„æ–¹å¼ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª **HTTPS åè®®çš„å…¬ç½‘åœ°å€**ï¼Œé™¤äº†ç›´æ¥ä½¿ç”¨è‡ªå·±çš„æœåŠ¡å™¨ï¼Œè¿˜å¯ä»¥æ€ä¹ˆåŠå‘¢ï¼Ÿåˆ«æ€¥ï¼Œæœ‰ [ngrok](https://ngrok.com/) ä¸ºæˆ‘ä»¬æ’å¿§è§£éš¾ï¼šå®ƒæ˜¯ä¸€æ¬¾åå‘ä»£ç†å·¥å…·ï¼Œå¯ä»¥å°†æœ¬åœ°çš„åœ°å€æ˜ å°„åˆ°å…¬ç½‘ä¸Šå»ã€‚

![ngrok](./start-telegram-bot/ngrok.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“ ngrok è¿è¡Œæ—¶ï¼ŒTelegram Bot å‘å‘ `https://a75b-182-141-75-13.ngrok.io` çš„è¯·æ±‚ï¼Œå°†è½¬å‘ç»™è¿è¡Œåœ¨æœ¬åœ° `http://localhost:4000` ä¸Šçš„ç¨‹åºã€‚

è¿™æ ·ï¼Œåªéœ€è¦åŒæ—¶è¿è¡Œæˆ‘ä»¬çš„é¡¹ç›®å’Œ ngrokï¼Œæˆ‘ä»¬å°±å¯ä»¥æ­£å¸¸åœ°æ¥æ”¶åˆ°ä¿¡æ¯å¹¶è¿›è¡Œå¤„ç†äº†ã€‚ä¿®æ”¹è¿æ¥ Bot çš„ä»£ç å¦‚ä¸‹ï¼š

```js
const bot = new TelegramBot(token, {
  request: requestOptions,
});

bot.setWebHook(`${process.env.WEBHOOK_HOST}/bot${token}`);

globalThis.bot = bot;
```

ç°åœ¨ï¼ŒTelegram ä¸Šæœºå™¨äººæ”¶åˆ°çš„æ¶ˆæ¯ä¼šç«‹å³å‘é€ç»™æˆ‘ä»¬çš„æœåŠ¡å™¨ã€‚æœ€åï¼Œåœ¨æœåŠ¡å™¨éœ€è¦å¤„ç†æ¥æ”¶åˆ°çš„ POST ç±»å‹è¯·æ±‚ `/bot${TELEGRAM_BOT_TOKEN}`ï¼Œå‘ŠçŸ¥ Telegram æˆ‘ä»¬å·²ç»æ”¶åˆ°æ–°çš„æ¶ˆæ¯äº†ã€‚å¯ä»¥åœ¨ `routes/index.js` ä¸­æ·»åŠ ä»£ç å¦‚ä¸‹ï¼š

```js
router.post(`bot${token}`, (ctx) =&gt; {
  globalThis.bot.processUpdate(ctx.request.body);
  ctx.status = 200;
});
```

éœ€è¦è¡¥å……çš„æ˜¯ï¼Œé€šè¿‡ä¸Šé¢ä»£ç ä¸­ Bot API åº“æä¾›çš„ [`processUpdate`](https://github.com/yagop/node-telegram-bot-api/blob/master/doc/api.md#telegrambotprocessupdateupdate) æ–¹æ³•ï¼Œå¯ä»¥å¯¹æ¥æ”¶åˆ°çš„æ¶ˆæ¯è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œè§¦å‘æ­£ç¡®çš„äº‹ä»¶å¹¶æ‰§è¡Œå›è°ƒæ–¹æ³•ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬çš„æœºå™¨äººå°†ä¸å†ç¬¨æ‹™åœ°è½®è¯¢ Telegram æœåŠ¡å™¨ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰æœªå¤„ç†çš„æ¶ˆæ¯ï¼Œè€Œæ˜¯é™é™ç­‰å¾… Telegram æœåŠ¡å™¨å‘é€è¿‡æ¥çš„è¯·æ±‚ã€‚

## è½¬å‘ Github Issues åˆ° Telegram é¢‘é“

[Chen å…ˆç”Ÿ](https://billc.io/)è‡ªå·±çš„ Telegram é¢‘é“ä¼šå®šæ—¶å‘é€ä»–æ›´æ–°çš„æ¨æ–‡ï¼Œç¬”è€…ä¹Ÿæƒ³æ•´ä¸€ä¸ªï¼Œæœ€ç®€å•çš„å®ç°æ–¹å¼æ˜¯ç”³è¯·ä¸€ä¸ª Twitter å¼€å‘è€…è´¦å·ï¼Œå®šæ—¶è°ƒç”¨ API è·å–æœ€æ–°æ¨æ–‡ä¿¡æ¯å³å¯ â€”â€” ä½†æ˜¯æ²¡èƒ½ç”³è¯·åˆ°ã€‚æš‚é€€ä¸€æ­¥ï¼Œå…ˆæŠŠç¬”è€…åœ¨ Github Issues ä¸Šçš„ç¢ç¢å¿µåŒæ­¥ç»™é¢‘é“å§ã€‚

æ¥ä¸‹æ¥çš„å†…å®¹å‡è®¾æ‚¨å·²å¯¹ PostgreSQL å’Œæ•°æ®åº“ ORM å·¥å…·æœ‰ä¸€å®šçš„äº†è§£ã€‚

### è¿æ¥åˆ°æ•°æ®åº“

åŒæ­¥åŠŸèƒ½éœ€è¦æ•°æ®åº“çš„æ”¯æŒï¼Œå½“ç„¶ä¹Ÿä¸ºäº†æœªæ¥æ›´å¤šåŠŸèƒ½çš„å®ç°ï¼Œåœ¨è¿™é‡Œï¼Œå…ˆä¸æœ¬æœºçš„æ•°æ®åº“å»ºç«‹è¿æ¥ã€‚ä»¥ [PostgreSQL](https://www.enterprisedb.com/downloads/postgres-postgresql-downloads) ä¸ºä¾‹ï¼Œé¦–å…ˆå®‰è£… [node-postgres](https://github.com/brianc/node-postgres) åº“ï¼š

```bash
npm install pg
```

æ–°å»ºæ–‡ä»¶ `config.js` æ¥å­˜å‚¨è¿æ¥åˆ°æ•°æ®åº“çš„é…ç½®ï¼š

```js
const config = {
  database: {
    postgresql: {
      host: &quot;localhost&quot;,
      port: 5432,
      database: &quot;telly_bot_db&quot;,
      user: &quot;telly_bot_db_user&quot;,
      password: &quot;telly_bot_db_pwd&quot;,
      timezone: &quot;+08:00&quot;,
    },
  },
};

module.exports = config;
```

### ä½¿ç”¨ ORM ç®¡ç†æ•°æ®åº“

é€šè¿‡ ORM å·¥å…·æ¥å¯¹æ•°æ®åº“è¿›è¡Œç®¡ç†ä¸æŸ¥è¯¢ï¼Œå¯ä»¥é¿å…æ‰‹åŠ¨è¿ç»´çš„çª˜å¢ƒã€‚è¿™é‡Œé€‰ç”¨ [Sequelize](https://github.com/sequelize/sequelize) åº“ï¼Œå®‰è£…å¿…è¦çš„ä¾èµ–ï¼š

```bash
npm install sequelize pg-hstore
```

ä¿®æ”¹ `db/index.js` ä»£ç å¦‚ä¸‹ï¼š

```js
const { Sequelize } = require(&quot;sequelize&quot;);
const pgsqlConfig = require(&quot;../config&quot;).database.postgresql;
const options = {
  timezone: pgsqlConfig.timezone || &quot;+08:00&quot;,
};
const sequelize = new Sequelize(
  `postgres://${pgsqlConfig.user}:${pgsqlConfig.password}@${pgsqlConfig.host}:${pgsqlConfig.port}/${pgsqlConfig.database}`,
  options,
);

(async () =&gt; {
  try {
    await sequelize.authenticate();
    console.log(
      `Connection with ${pgsqlConfig.database} has been established successfully.`,
    );
    await sequelize.sync({ alter: true });
    console.log(&quot;All models were synchronized successfully.&quot;);
  } catch (error) {
    console.error(
      `Unable to connect to the database ${pgsqlConfig.database}:`,
      error,
    );
  }
})();

module.exports = sequelize;
```

ä¸ºäº†å®ç°è‡ªåŠ¨è½¬å‘ Github Issues ä¸­çš„è¯„è®ºï¼Œæˆ‘ä»¬éœ€è¦ä¸€å¼ æ•°æ®è¡¨æ¥å­˜å‚¨ä¸Šä¸€æ¬¡è½¬å‘çš„è¯„è®ºï¼ˆæˆ–ç¼–è¾‘è®°å½•ï¼‰çš„**æœ€åæ›´æ–°æ—¥æœŸ**ï¼ˆ`lastUpdateCommentAt`)ã€‚è¿™æ ·ï¼Œä¸‹ä¸€æ¬¡æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œåªéœ€è¦æŸ¥çœ‹è¯¥æ—¥æœŸä¹‹åæ˜¯å¦æœ‰æ–°çš„è¯„è®ºï¼ˆæˆ–ç¼–è¾‘è®°å½•ï¼‰å°±å¯ä»¥äº†ã€‚å¯¹äºæ¯ä¸€ä¸ª Issueï¼Œéƒ½ä¼šåœ¨è¯¥è¡¨ä¸­åˆ›å»ºä¸€æ¡æ•°æ®ã€‚ä¸º Sequelize æ·»åŠ æ¨¡å‹ `db/model/ServiceGithubIssueComment.js` å¦‚ä¸‹ï¼š

```js
const { DataTypes } = require(&quot;sequelize&quot;);

module.exports = {
  // The ID of the forwarding Github Issue service
  id: {
    type: DataTypes.INTEGER,
    autoIncrement: true,
    primaryKey: true,
  },
  // Url of Github Issue. Example: ${USERNAME}/${REPOSITORY}/issues/${ISSUE_NUM}
  issueUrl: {
    type: DataTypes.TEXT,
    allowNull: false,
  },
  // Only forward the comments of these users, empty means forward all
  issueUserId: {
    type: DataTypes.ARRAY(DataTypes.TEXT),
  },
  // The ID of the channel to which the comment was forwarded
  forwardChannelId: {
    type: DataTypes.TEXT,
    allowNull: false,
  },
  // The last date the issue comments were updated
  lastUpdateCommentAt: {
    type: DataTypes.DATE,
  },
  // Date the service was last run
  lastExecServiceAt: {
    type: DataTypes.DATE,
  },
};
```

ä¸€ä¸ªæ¨¡å‹å°†æˆä¸ºæ•°æ®åº“ä¸­çš„ä¸€å¼ æ•°æ®è¡¨ã€‚å‘ `db/index.js` ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

```js
const serviceGithubIssueCommentModel = require(&quot;./model/ServiceGithubIssueComment&quot;);
sequelize.define(&quot;ServiceGithubIssueComment&quot;, serviceGithubIssueCommentModel);
// sequelize.sync({ alter: true })
```

æ³¨æ„ï¼Œå°†æ¨¡å‹ç»‘å®šç»™ sequelize å¯¹è±¡çš„æ“ä½œ `sequelize.define()` éœ€è¦æ”¾åœ¨ `sequelize.sync()` æ–¹æ³•ä¹‹å‰ã€‚

å½“ `sequelize.define()` æ‰§è¡Œå®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥éšæ—¶ä½¿ç”¨ `sequelize.models.ServiceGithubIssueComment` æ¥è·å–æ¨¡å‹å®ä¾‹ã€‚é€šè¿‡æ¨¡å‹å®ä¾‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å¯¹åº”çš„æ•°æ®è¡¨ä¸­æ‰§è¡Œå„ç§ SQL æŸ¥è¯¢è¯­å¥äº†ã€‚

### è·å–æŒ‡å®š Issue ä¸­çš„æœ€æ–°è¯„è®º

Github REST API æ–‡æ¡£æ¨èä½¿ç”¨ [@octokit/core](https://github.com/octokit/core.js) åº“æ¥æ‰§è¡Œè¯·æ±‚ï¼š

```bash
npm install @octokit/core
```

å‘ `config.js` ä¸­æ·»åŠ ç›¸åº”çš„é…ç½®ã€‚ä»¥è·å–ç¬”è€…çš„[ç¢ç¢å¿µ](https://github.com/LolipopJ/LolipopJ/issues/2)ä¸ºä¾‹ï¼š

```js
const config = {
  github: {
    forwardIssueComment: {
      duration: 3600,
      task: [
        {
          owner: &quot;LolipopJ&quot;,
          repo: &quot;LolipopJ&quot;,
          issueNumber: 2,
          issueUserId: [42314340],
          forwardChannelId: &quot;@lolipop_thoughts&quot;,
          since: &quot;2022-01-01T00:00:00.000Z&quot;,
        },
      ],
    },
  },
};
```

å…¶ä¸­ï¼Œ`duration` ä¸ºä¸¤æ¬¡æ‰§è¡ŒæœŸé—´é—´éš”çš„æ—¶é—´ï¼ˆç§’ï¼‰ã€‚æ­¤å¤–ï¼Œé…ç½®ä¸­å­˜åœ¨ `issueUserId` é¡¹ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬å¯èƒ½åªæƒ³è¦è½¬å‘è‡ªå·±å‘é€çš„è¯„è®ºï¼Œåœ¨åé¢åªéœ€è¦æ ¹æ®è¯¥é¡¹è¿‡æ»¤è¯¥ç”¨æˆ· ID çš„è¯„è®ºå³å¯ï¼ˆå¯ä»¥é€šè¿‡ `https://api.github.com/users/your_github_user_name` æŸ¥çœ‹æŒ‡å®š Github è´¦æˆ·çš„ IDï¼‰ã€‚

[è¿™é‡Œ](https://docs.github.com/en/rest/reference/issues#list-issue-comments)æ˜¯è·å–æŒ‡å®š Issues ä¸­çš„è¯„è®ºçš„æ–¹æ³•ã€‚ç¼–å†™ `service/github.js` ä»£ç å¦‚ä¸‹ï¼ˆ**ä»…åšå‚è€ƒ**ï¼šä»£ç æˆªå–å®ç°åŠŸèƒ½çš„éƒ¨åˆ†ï¼Œåˆ¨é™¤æé«˜é²æ£’æ€§çš„éƒ¨åˆ†ï¼Œä¹Ÿå»é™¤äº†ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„éƒ¨åˆ†ï¼‰ï¼š

```js
const { Octokit } = require(&quot;@octokit/core&quot;);
const config = require(&quot;../config&quot;).github;
const octokit = new Octokit(octokitOptions);

const bot = globalThis.bot;
const sequelize = globalThis.sequelize;

const forwardGithubIssueComment = async function () {
  const issues = config.forwardIssueComment.task;
  const ServiceGithubIssueComment = sequelize.models.ServiceGithubIssueComment;

  for (const issue of issues) {
    const owner = issue.owner;
    const repo = issue.repo;
    const issueNumber = issue.issueNumber;
    const forwardChannelId = issue.forwardChannelId;
    const issueUserId = issue.issueUserId;
    const issueUrl = `${owner}/${repo}/issues/${issueNumber}`;

    const queryConfig = {
      issueUrl,
      issueUserId,
      forwardChannelId,
    };
    const perPage = 100;
    let page = 0;

    // æŸ¥è¯¢ Github Issues çš„è¯„è®ºçš„æœ€åæ›´æ–°æ—¥æœŸ lastUpdateCommentAt
    const issueServiceInfo = await ServiceGithubIssueComment.findOne({
      where: queryConfig,
    });
    const lastUpdateCommentDate =
      issueServiceInfo.dataValues.lastUpdateCommentAt;

    // å°† lastUpdateCommentAt åŠ ä¸Š 1ms ä½œä¸ºä¸‹ä¸€æ¬¡æŸ¥è¯¢çš„èµ·å§‹æ—¥æœŸ
    const since = new Date(
      new Date(lastUpdateCommentDate).getTime() + 1,
    ).toISOString();

    // è°ƒç”¨ Github API è·å–æŒ‡å®š issue çš„è¯„è®ºä¿¡æ¯
    // æŸ¥è¯¢çš„è¯„è®ºæ›´æ–°æ—¥æœŸä» since å¼€å§‹
    let issueComments = [];
    while (issueComments.length === perPage * page) {
      ++page;
      const res = await octokit.request(
        &quot;GET /repos/{owner}/{repo}/issues/{issue_number}/comments&quot;,
        {
          owner,
          repo,
          issue_number: issueNumber,
          since,
          per_page: perPage,
          page,
        },
      );
      issueComments = issueComments.concat(res.data);
    }

    // å¦‚æœè®¾ç½®äº† issueUserId é¡¹ï¼Œåˆ™åªä¿ç•™æ•°ç»„ä¸­ç”¨æˆ· ID çš„è¯„è®º
    if (Array.isArray(issueUserId) &amp;&amp; issueUserId.length &gt; 0) {
      issueComments = issueComments.filter((comment) =&gt; {
        const commentUserId = comment.user.id;
        if (issueUserId.includes(commentUserId)) {
          return true;
        } else {
          return false;
        }
      });
    }
  }
};
```

å¦‚æœ Issue å­˜æ”¾åœ¨ç§äººä»“åº“ä¸­ï¼Œåˆ™éœ€è¦ç”¨åˆ° [Personal Access Token](https://github.com/settings/tokens/new?scopes=repo) è¿›è¡Œé‰´æƒã€‚åœ¨åˆ›å»º `octokit` å¯¹è±¡æ—¶ä¼ é€’ç›¸åº”å‚æ•°ï¼š

```js
const octokitOptions = {};
const authToken = process.env.GITHUB_PERSONAL_ACCESS_TOKEN;
if (authToken) {
  octokitOptions.auth = authToken;
}
const octokit = new Octokit(octokitOptions);
```

### å®šæ—¶è½¬å‘è¯„è®ºåˆ° Telegram é¢‘é“

ç”±äº Github Issues ä¸­çš„è¯„è®ºä¸º Markdown æ ¼å¼ï¼Œåœ¨è½¬å‘åˆ°é¢‘é“æ—¶ï¼Œå°±éœ€è¦å¯¹å†…å®¹è¿›è¡Œè§£æã€‚å¹¸è¿çš„æ˜¯ï¼ŒTelegram Bot çš„ [`sendMessage()`](https://core.telegram.org/bots/api#sendmessage) æ–¹æ³•å¯ä»¥è®¾ç½® `parse_mode` é€‰é¡¹ï¼Œå¯ä»¥å°†**å¤§éƒ¨åˆ†**çš„ Markdown å†…å®¹é¡ºåˆ©è§£æä¸ºæ­£ç¡®çš„æ¶ˆæ¯æ ·å¼ã€‚ä½†ä¸å¹¸çš„æ˜¯ï¼Œç”±äº Telegram æœ¬èº«çš„ä¸€äº›é™åˆ¶ï¼Œå¯¹äºä¸€äº›æ— æ³•è§£æçš„ç¬¦å·ä¼šæŠ¥é”™ï¼Œé’ˆå¯¹è¿™ä¸€éƒ¨åˆ†è¯„è®ºï¼Œç¬”è€…é€‰æ‹©ç›´æ¥å‘é€è¯„è®ºçš„ç½‘é¡µåœ°å€ä½œä¸ºæ›¿ä»£ã€‚

ç»§ç»­ç¼–å†™ `service/github.js` ä»£ç å¦‚ä¸‹ï¼ˆ**ä»…åšå‚è€ƒ**ï¼‰ï¼š

```js
if (issueComments.length &gt; 0) {
  let lastUpdateCommentAt = new Date(0).toISOString();

  // è½¬å‘è¯„è®ºåˆ° Telegram é¢‘é“
  for (const issueComment of issueComments) {
    try {
      await bot.sendMessage(forwardChannelId, issueComment.body, {
        parse_mode: &quot;MarkdownV2&quot;,
      });
    } catch (error) {
      await bot.sendMessage(forwardChannelId, issueComment.html_url);
    }

    const issueCommentUpdatedAt = issueComment.updated_at;
    if (issueCommentUpdatedAt &gt; lastUpdateCommentAt) {
      lastUpdateCommentAt = issueCommentUpdatedAt;
    }
  }

  // ç»´æŠ¤æ•°æ®åº“ï¼Œä¿å­˜ Github Issue è¯„è®ºçš„æœ€åæ›´æ–°æ—¥æœŸ
  await ServiceGithubIssueComment.update(
    {
      lastUpdateCommentAt,
      lastExecServiceAt: new Date().toISOString(),
    },
    {
      where: queryConfig,
    },
  );
}
```

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»åŸºæœ¬å®ç°äº†æ‰€éœ€è¦çš„å…¨éƒ¨åŠŸèƒ½ã€‚æœ€åéœ€è¦åšçš„äº‹æƒ…ï¼Œå°±æ˜¯è®¾ç½®æ¯éš”ä¸€å®šæ—¶é—´è‡ªåŠ¨è¿è¡Œæ­¤æœåŠ¡ï¼ŒæŒç»­è·å–æœ€æ–°çš„è¯„è®ºä¿¡æ¯ã€‚è¿™é‡Œç¬”è€…ç”¨åˆ°äº† `toad-scheduler` åº“ï¼š

```bash
npm install toad-scheduler
```

åœ¨ `service/index.js` ä¸­ç¼–å†™è®¡åˆ’ä»»åŠ¡ä»£ç å¦‚ä¸‹ï¼š

```js
const {
  ToadScheduler,
  SimpleIntervalJob,
  AsyncTask,
} = require(&quot;toad-scheduler&quot;);

const githubService = require(&quot;./github&quot;);

const config = require(&quot;../config&quot;);

const scheduler = new ToadScheduler();
const taskForwardGithubIssueComment = new AsyncTask(
  &quot;Forward Github Issue Comment&quot;,
  async () =&gt; {
    await githubService.forwardGithubIssueComment();
  },
  (error) =&gt; {
    console.error(error);
  },
);
const jobForwardGithubIssueComment = new SimpleIntervalJob(
  {
    seconds: config.github.forwardIssueComment.duration,
    runImmediately: true,
  },
  taskForwardGithubIssueComment,
);

scheduler.addSimpleIntervalJob(jobForwardGithubIssueComment);
```

ä¸€åˆ‡å°±ç»ªï¼Œè¿è¡Œæˆ‘ä»¬çš„ Bot ç¨‹åºï¼

```bash
npm run pm2
```

ç¬”è€…çš„é¢‘é“é¡ºåˆ©æ”¶åˆ°äº†æ¥è‡ª Github Issue ä¸­çš„è¯„è®ºä¿¡æ¯ï¼

![Forward Github Issue&apos;s comments to my channel](./start-telegram-bot/forward-to-my-channel.png)

å½“ç„¶ï¼Œè¯¥æœåŠ¡è¿˜æœ‰è®¸å¤šå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼Œä¾‹å¦‚ï¼šå½“è¯„è®ºå‘ç”Ÿæ›´æ–°æ—¶ï¼Œåº”ç¼–è¾‘å·²å‘é€çš„é¢‘é“æ¶ˆæ¯ä¸ºæœ€æ–°è¯„è®ºå†…å®¹ï¼Œè€Œä¸æ˜¯é‡æ–°å‘ä¸€æ¡æ–°çš„æ¶ˆæ¯ç­‰ã€‚ä¸å†åœ¨æ­¤æ–‡èµ˜è¿°ã€‚

## å‚è€ƒæ–‡ç« 

- [å¼€å‘ä¸€ä¸ª Telegram Bot](https://www.wandouip.com/t5i13823/)
- [node-telegram-bot-api usage](https://github.com/yagop/node-telegram-bot-api/blob/master/doc/usage.md)
- [How to set webhooks using express local server and NGROK](https://github.com/leobloise/node-telegram-bot-api-wb-tutorial)
</content:original-text><content:updated-at>2024-07-09T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[æŠŠè‡ªå·±çš„ç®€å†åšæˆ Web é¡µé¢]]></title><description><![CDATA[å»å¹´æŠ•ç®€å†çš„æ—¶å€™ï¼Œåœ¨ Github ä¸Šæ‰¾äº†ä¸ªå¼€æºçš„ï¼Œæ˜Ÿæ˜Ÿå¾ˆå¤šçš„ä»“åº“ best-resume-ever æ¥åˆ¶ä½œè‡ªå·±çš„ç®€å†ã€‚å…¶ä¸­çš„ Creative æ¨¡æ¿æˆ‘è§‰å¾—å¾ˆå–œæ¬¢ï¼Œå°±ç”¨å®ƒåˆ¶ä½œäº†æˆ‘äººç”Ÿä¸­çš„ç¬¬ä¸€ä»½æ‰¾å·¥ä½œç”¨çš„ç®€å†ï¼š ç„¶ååˆ°äº†ç°åœ¨ï¼Œåˆ°äº†ç§‹æ‹›çœŸæ­£æ‰¾å·¥ä½œèµ°å‘ç¤¾ä¼šçš„å­£èŠ‚äº†ï¼Œåˆè¯¥åˆ¶ä½œè‡ªå·±çš„ç®€å†äº†ã€‚ä¸€å¹´çš„æ—¶å…‰ç»™è‡ªå·±çš„äººç”Ÿåˆå¢æ·»äº†å‡ åˆ†è‰²å½©ï¼ŒåŸå…ˆç®€å†æ¨¡æ¿å·²ç„¶ä¸å¤Ÿç”¨äº†ã€‚æ­£å·§ï¼Œè¿™ä¸ªä»“åº“ç”± Vue ç¼–å†™â€¦]]></description><link>https://blog.towind.fun/posts/build-my-resume</link><guid isPermaLink="false">build-my-resume</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Thu, 19 Aug 2021 00:00:00 GMT</pubDate><content:original-text>
å»å¹´æŠ•ç®€å†çš„æ—¶å€™ï¼Œåœ¨ Github ä¸Šæ‰¾äº†ä¸ªå¼€æºçš„ï¼Œæ˜Ÿæ˜Ÿå¾ˆå¤šçš„ä»“åº“ [best-resume-ever](https://github.com/salomonelli/best-resume-ever) æ¥åˆ¶ä½œè‡ªå·±çš„ç®€å†ã€‚å…¶ä¸­çš„ Creative æ¨¡æ¿æˆ‘è§‰å¾—å¾ˆå–œæ¬¢ï¼Œå°±ç”¨å®ƒåˆ¶ä½œäº†æˆ‘äººç”Ÿä¸­çš„ç¬¬ä¸€ä»½æ‰¾å·¥ä½œç”¨çš„ç®€å†ï¼š

![my first resume](./build-my-resume/my-first-resume.jpg)

ç„¶ååˆ°äº†ç°åœ¨ï¼Œåˆ°äº†ç§‹æ‹›çœŸæ­£æ‰¾å·¥ä½œèµ°å‘ç¤¾ä¼šçš„å­£èŠ‚äº†ï¼Œåˆè¯¥åˆ¶ä½œè‡ªå·±çš„ç®€å†äº†ã€‚ä¸€å¹´çš„æ—¶å…‰ç»™è‡ªå·±çš„äººç”Ÿåˆå¢æ·»äº†å‡ åˆ†è‰²å½©ï¼ŒåŸå…ˆç®€å†æ¨¡æ¿å·²ç„¶ä¸å¤Ÿç”¨äº†ã€‚æ­£å·§ï¼Œè¿™ä¸ªä»“åº“ç”± Vue ç¼–å†™ï¼Œå¯ä»¥ç”¨è‡ªå·±å·²æœ‰çš„çŸ¥è¯†å¯¹ç®€å†åšä¸€äº›æ”¹é€ æ‰‹æœ¯ã€‚

## æ”¹é€ ç®€å†

ä¸¾å››ä¸ªæ”¹é€ çš„ä¾‹å­å¥½äº†ã€‚

### æ·»åŠ  Chip çº¸ç‰‡

åœ¨ Creative æ¨¡æ¿çš„æŠ€èƒ½ä¸“é•¿æ ç›®ä¸­ï¼Œä½¿ç”¨äº†çº¸ç‰‡çš„å½¢å¼å±•ç¤ºæ¯”è¾ƒæ“…é•¿çš„ç¼–ç¨‹è¯­è¨€ï¼Œå¾ˆå¥½çœ‹ï¼ä¸ºçº¯çº¯çš„æ–‡å­—å¤šå¢æ·»äº†äº›ä¸ä¸€æ ·çš„è‰²å½©ã€‚

è€Œåœ¨é¡¹ç›®ç»å†æ ç›®ä¸­ï¼Œä¸ºæ¯ä¸€ä¸ªé¡¹ç›®æä¾›äº† platform å±æ€§ï¼Œä¹Ÿå°±æ˜¯é¡¹ç›®åŸºäºçš„è¯­è¨€æˆ–å¹³å°ç­‰ã€‚ä½†æ˜¯è¿™ä¸€ä¸ªå±æ€§æ˜¯ä»¥æ–‡å­—çš„å½¢å¼å±•ç¤ºçš„ï¼Œæˆ‘è§‰å¾—å¹¶ä¸å¥½çœ‹ï¼Œåœ¨é¢œè‰²ä¸Šä¹Ÿæ²¡æœ‰çªå‡ºçš„ä½œç”¨ã€‚äºæ˜¯æˆ‘è®¡åˆ’ä½¿ç”¨çº¸ç‰‡çš„å½¢å¼åœ¨å±•ç¤º platform å±æ€§ã€‚

æ¨¡ä»¿æˆ‘ç»å¸¸ä½¿ç”¨çš„ Vue UI ç»„ä»¶åº“ Vuetify çš„ç¼–å†™ï¼Œæ·»åŠ æ ·å¼è¡¨ç±»å¦‚ä¸‹ï¼š

```less
.chip {
  display: inline-block;
  color: white;
  background-color: @accent-color;
  overflow: hidden;
  vertical-align: middle;
  padding: 5px;
  margin-left: 5px;
  border-radius: 4px;
  font-size: 0.8em;

  &amp;-secondary {
    color: rgba(0, 0, 0, 0.87);
    background-color: #e0e0e0;
  }
}
```

å…¶ä¸­ `.chip` ä¸ºé»˜è®¤çš„çº¸ç‰‡æ ·å¼è¡¨ï¼Œä½¿ç”¨ä¸»é¢˜è‰²ä½œä¸ºèƒŒæ™¯ï¼Œç™½è‰²ä½œä¸ºæ–‡æœ¬é¢œè‰²ï¼›è€Œ `.chip-secondary` å¯ä»¥è¦†ç›–åŸæœ‰çš„é…è‰²ï¼Œä½¿ç”¨ç°è‰²ä½œä¸ºèƒŒæ™¯ï¼Œé»‘è‰²ä½œä¸ºæ–‡æœ¬é¢œè‰²ã€‚

æ·»åŠ  Vue æ¨¡æ¿ä»£ç å¦‚ä¸‹ï¼Œå½“ platform å±æ€§ä¸ä¸ºç©ºæ—¶ï¼Œæ˜¾ç¤ºæ‹¥æœ‰ platform å†…å®¹çš„çº¸ç‰‡ï¼›å½“ dev å±æ€§ä¸ä¸ºç©ºæ—¶ï¼Œæ˜¾ç¤ºæœ‰â€œå¼€å‘ä¸­â€æ–‡æœ¬çš„æ¬¡è¦é…è‰²çš„çº¸ç‰‡ã€‚

```html
&lt;span v-if=&quot;project.platform&quot; class=&quot;chip&quot;&gt;{{ project.platform }}&lt;/span&gt;
&lt;span v-if=&quot;project.dev&quot; class=&quot;chip chip-secondary&quot;&gt;{{ lang.underDev }}&lt;/span&gt;
```

æ˜¾ç¤ºçš„ç»“æœå¦‚ä¸‹ï¼š

![resume chips](./build-my-resume/resume-chips.png)

### ä¿®æ”¹é¡µé¢å¸ƒå±€

è¿™ä¸ªé¡¹ç›®é‡Œçš„æ‰€æœ‰ä¸»é¢˜åŸºäº A4 çº¸å¼ ï¼ˆ21 \* 29.7cmï¼‰è®¾è®¡ï¼š

```css
/**
 * https://github.com/salomonelli/best-resume-ever/blob/master/src/pages/resume.vue
 */
.page {
  width: 21cm;
  height: 29.68cm;
}
```

ç°åœ¨äº’è”ç½‘ä¼ä¸šçš„ç®€å†å¤§å¤šä½¿ç”¨ä¸“é—¨çš„æ‹›è˜ç½‘ç«™ä¸Šä¼ æäº¤ï¼Œä¼¼ä¹ä¸å¿…æ‹˜æ³¥äº A4 çº¸çš„å¤§å°äº†ã€‚ç”µè„‘å±å¹•é‚£ä¹ˆå¤§ï¼Œä½•ä¸å°†æ•´ä¸ªç®€å†ç›´æ¥â€œè´´è„¸ä¸Šâ€å‘¢ï¼

é¦–å…ˆå°†é¡µé¢çš„å®½åº¦å’Œé«˜åº¦è®¾ç½®ä¸º 100%ï¼Œå³å®½åº¦è¦†ç›–æ•´ä¸ªæµè§ˆå™¨ï¼Œé«˜åº¦è¶³ä»¥å®¹çº³æ‰€æœ‰ç®€å†ä¸Šæ‰€æœ‰å†…å®¹ã€‚

ç„¶ååˆ©ç”¨çœå¿ƒçš„ Flex å¸ƒå±€ï¼Œå°†é¡µé¢å³è¾¹çš„æ­£æ–‡å†…å®¹åˆ†ä¸ºå·¦å³ä¸¤æ ã€‚

ç¼–å†™é¡µé¢çš„å¸ƒå±€å½¢å¦‚ï¼š

```html
&lt;div class=&quot;resume&quot;&gt;
  &lt;div class=&quot;left-column&quot;&gt;&lt;!-- å·¦æ  --&gt;&lt;/div&gt;
  &lt;div class=&quot;right-column&quot;&gt;
    &lt;div class=&quot;right-column-section&quot;&gt;&lt;!-- å³æ çš„å·¦ä¾§ --&gt;&lt;/div&gt;
    &lt;div class=&quot;right-column-section&quot;&gt;&lt;!-- å³æ çš„å³ä¾§ --&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
```

æ ·å¼è¡¨å†…å®¹å½¢å¦‚ï¼š

```less
.resume {
  display: flex;
}

.left-column {
  flex: 1;
}

.right-column {
  flex: 3;

  display: flex;
  justify-content: space-around;
}

.right-column-section {
  flex: 0 0 48%;
}
```

ç°åœ¨æˆ‘çš„ç®€å†çœ‹ä¸Šå»å°±æ˜¾å¾—å¾ˆå¤§æ°”äº†ï¼š

![resume preview](./build-my-resume/resume-preview.png)

ä½†æ˜¯ï¼Œä½¿ç”¨ Flex å¸ƒå±€æŠŠ `right-column` åˆ†æˆçš„ä¸¤æ ï¼Œå¦‚æœä¸¤è¾¹åˆšå¥½é«˜åº¦å·®ä¸å¤šï¼Œé‚£ä¾¿æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼›ä½†å¦‚æœæŸä¸€æ æ¯”å¦ä¸€æ é«˜å¾ˆå¤šï¼Œé¡µé¢å°±ä¼šæ˜¾å¾—å‚å·®ä¸é½ã€‚æ‰‹åŠ¨æŠŠä¸€äº›å…ƒç´ æŒªåˆ°å¦ä¸€æ ä¼¼ä¹èƒ½å¤Ÿè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†åœ¨å®ç°ä¸Šéå¸¸ä¸ä¼˜é›…ã€‚

å› æ­¤ï¼Œåæ¥æˆ‘é€‰ç”¨äº† Multiple-column å¸ƒå±€ä½œä¸º `right-column` çš„å¸ƒå±€ã€‚

ç¼–å†™é¡µé¢çš„å¸ƒå±€å½¢å¦‚ï¼š

```html
&lt;div class=&quot;resume&quot;&gt;
  &lt;div class=&quot;left-column&quot;&gt;&lt;!-- å·¦æ  --&gt;&lt;/div&gt;
  &lt;div class=&quot;right-column&quot;&gt;&lt;!-- å³æ  --&gt;&lt;/div&gt;
&lt;/div&gt;
```

æ ·å¼è¡¨å†…å®¹å½¢å¦‚ï¼š

```less
.resume {
  display: flex;
}

.left-column {
  flex: 1;
}

.right-column {
  flex: 3;

  display: block;
  column-count: 2;
  column-gap: 4%;
}
```

è¿˜æœ‰ä¸ªå°é—®é¢˜ï¼Œæˆ‘å¸Œæœ›æˆ‘çš„é¡¹ç›®ç»å†ä¸­çš„æ¯ä¸€æ®µç»å†éƒ½æ˜¯å®Œæ•´çš„ï¼Œå†…å®¹ä¸éšç€åˆ†æ åˆ†ç¦»ã€‚åªéœ€è¦ä¸ºå®ƒä»¬è®¾ç½® `break-inside: avoid;` å³å¯ï¼š

```less
.section-content__item {
  break-inside: avoid;
}
```

### é€‚é…ç§»åŠ¨ç«¯ç•Œé¢

æ—¢ç„¶è®¡åˆ’éƒ¨ç½²ä¸ºç½‘é¡µï¼Œé‚£ä¹ˆæ¨ªå‘ä¸‰æ çš„è®¾è®¡æ˜¾ç„¶å¯¹ç§»åŠ¨ç«¯è®¾å¤‡å¾ˆä¸å‹å¥½ã€‚

å¦‚æœç½‘é¡µå’Œå³æ å‡ä¸º Flex å¸ƒå±€ï¼Œå¯ä»¥ä½¿ç”¨ `flex-direction` æ¥å¿«é€Ÿè°ƒæ•´é¡µé¢å¸ƒå±€çš„æ–¹å‘ã€‚ç¼–å†™æ ·å¼è¡¨ä»£ç å¦‚ä¸‹ï¼š

```less
@media (max-width: 960px) {
  .resume {
    flex-direction: column;
  }

  .right-column {
    flex-direction: column;
  }
}
```

Easy as a cake. å½“é¡µé¢å®½åº¦å°äº 960px æ—¶ï¼Œå°†æŠŠåŸæœ‰çš„ä¸‰æ çºµå‘ä¾æ¬¡æ’åˆ—å‡ºæ¥ã€‚æ•ˆæœå¦‚ä¸‹ï¼š

![resume mobile preview](./build-my-resume/resume-mobile.png)

å¦‚æœç½‘é¡µä¸º Flex å¸ƒå±€ï¼Œå³æ ä¸º Multiple-column å¸ƒå±€ï¼Œä¿®æ”¹ç½‘é¡µçš„ `flex-direction` å’Œå³æ çš„ `column-count` å³å¯ï¼š

```less
@media (max-width: 960px) {
  .resume {
    flex-direction: column;
  }

  .right-column {
    column-count: 1;
  }
}
```

### æ·»åŠ å¤œé—´æ¨¡å¼

ä½¿ç”¨ CSS æä¾›çš„ [CSS Variables](https://developer.mozilla.org/en-US/docs/Web/CSS/--*) èƒ½åŠ›æ¥å®ç°é¡µé¢çš„ä¸»é¢˜åˆ‡æ¢ï¼Œå…¶æµè§ˆå™¨å…¼å®¹æ€§[è§äºæ­¤](https://caniuse.com/?search=CSS%20Variables)ã€‚

é¦–å…ˆåˆ›å»ºä¸€ä¸ªä¸»é¢˜é…ç½®æ–‡ä»¶ `src/assets/themes.json` æ¥å­˜å‚¨ä¸åŒä¸»é¢˜çš„é¢œè‰²ï¼Œä¾‹å¦‚ï¼š

```json
{
  &quot;light&quot;: {
    &quot;backgroundColor&quot;: &quot;#fafafa&quot;,
    &quot;textColor&quot;: &quot;rgba(0, 0, 0, 0.87)&quot;
  },
  &quot;dark&quot;: {
    &quot;backgroundColor&quot;: &quot;#121212&quot;,
    &quot;textColor&quot;: &quot;rgba(255, 255, 255, 0.87)&quot;
  }
}
```

ç¼–å†™ Vue è„šæœ¬å¦‚ä¸‹ï¼š

```js
&lt;script&gt;
const themes = require(&quot;@/assets/themes&quot;);

export default {
  data() {
    return {
      themeMode: &quot;light&quot;,
    };
  },
  methods: {
    setThemeMode(mode) {
      this.themeMode = mode;
      document.documentElement.style.setProperty(
        &quot;--theme-background-color&quot;,
        themes[mode].backgroundColor
      );
      document.documentElement.style.setProperty(
        &quot;--theme-text-color&quot;,
        themes[mode].textColor
      );
    },
  },
  created() {
    this.setThemeMode(&quot;light&quot;);
  },
}
&lt;/script&gt;
```

å½“æˆ‘ä»¬æ‰§è¡Œ `this.setThemeMode(&quot;light&quot;)` æ—¶ï¼Œç›¸å½“äºè¦†ç›–ï¼ˆæˆ–æ·»åŠ ï¼‰äº†å¦‚ä¸‹çš„ CSS æ ·å¼è¡¨ï¼š

```css
:root {
  --theme-background-color: #fafafa;
  --theme-text-color: rgba(0, 0, 0, 0.87);
}
```

åŒç†ï¼Œå½“æœªæ¥æ‰§è¡Œ `this.setThemeMode(&quot;dark&quot;)` æ—¶ï¼Œåˆ™ä¼šæŠŠä¹‹å‰åœ¨ `src/assets/themes.json` é…ç½®çš„é¢œè‰²è¦†ç›–åˆ°æ­¤å¤„ã€‚

æœ€åï¼Œåªéœ€è¦ç”¨ä¸Šæˆ‘ä»¬å®šä¹‰å¥½çš„è¿™äº› CSS å˜é‡å°±å¯ä»¥äº†ï¼Œä¾‹å¦‚ï¼š

```less
.resume {
  color: var(--theme-text-color);
}

.right-column {
  background-color: var(--theme-background-color);
}
```

## éƒ¨ç½²ä¸ºé™æ€ç½‘é¡µ

è¿™ä¸ªé¡¹ç›®ä» 2017 å¹´å¼€å§‹ï¼Œåˆ°ç°åœ¨å·®ä¸å¤š 4 å¹´çš„æ—¶é—´ã€‚ä»ç°åœ¨çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒä¾èµ–äº†è®¸å¤šä¸å¿…è¦ï¼Œæˆ–æ˜¯å·²åºŸå¼ƒçš„åŒ…ï¼Œè¿™æ˜¯è‡ªç„¶ã€‚

å› æ­¤ï¼Œæˆ‘æƒ³å°†ç®€å†é¡µé¢ä»è¿™ä¸ªé¡¹ç›®åˆ†ç¦»å‡ºæ¥ï¼Œç‹¬ç«‹ä¸ºä¸€ä¸ªç®€å•çš„ Vue é¡¹ç›®ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œè‡ªä»ç”¨ä¸Šäº† [npm-check-updates](https://www.npmjs.com/package/npm-check-updates) è¿™ä¸ªåº“ï¼Œæˆ‘çš„è¿½æ–°å¼ºè¿«ç—‡å°±è¶Šæ¥è¶Šçœ‹ä¸å¾—è¿™ä¹ˆå¤šå¯ä»¥å‡çº§çš„ä¾èµ–ã€‚

### ä½¿ç”¨ Vue CLI æ‰“åŒ… Vue é¡¹ç›®

[Vue CLI](https://cli.vuejs.org) æä¾›äº† Vue é¡¹ç›®ä»å¼€å‘åˆ°æ‰“åŒ…ä¸ºé™æ€æ–‡ä»¶å¹¶éƒ¨ç½²çš„å…¨å¥—è§£å†³æ–¹æ¡ˆã€‚

æ€»ä¹‹å…ˆå…¨å±€å®‰è£… Vue CLIï¼š

```bash
PS C:\Users\Lolipop\Github&gt; yarn global add @vue/cli
...
# ç”±äºå®‰è£…è¿‡å…¶å®ƒç‰ˆæœ¬çš„ Vue CLI
# å› æ­¤è¿™é‡Œä½¿ç”¨ç»å¯¹è·¯å¾„è®¿é—®æœ€æ–°ç‰ˆæœ¬çš„ Vue CLI
PS C:\Users\Lolipop\Github&gt; C:\Users\Lolipop\AppData\Local\Yarn\bin\vue.cmd --version
@vue/cli 4.5.13
```

åˆ›å»ºæ–°çš„ Vue é¡¹ç›®ï¼š

```bash
PS C:\Users\Lolipop\Github&gt; C:\Users\Lolipop\AppData\Local\Yarn\bin\vue.cmd create resume
```

ä¹ æƒ¯æ€§æ›´æ–°ä¾èµ–ä¸ºæœ€æ–°ç‰ˆæœ¬ï¼š

```bash
PS C:\Users\Lolipop\Github&gt; cd resume
PS C:\Users\Lolipop\Github\resume&gt; ncu -u -t minor
Using yarn
Upgrading C:\Users\Lolipop\Github\resume\package.json
[====================] 17/17 100%

 @vue/cli-plugin-babel    ~4.5.0  â†’  ~4.5.13
 @vue/cli-plugin-eslint   ~4.5.0  â†’  ~4.5.13
 @vue/cli-plugin-router   ~4.5.0  â†’  ~4.5.13
 @vue/cli-service         ~4.5.0  â†’  ~4.5.13
 eslint                   ^6.7.2  â†’   ^6.8.0
 eslint-plugin-prettier   ^3.3.1  â†’   ^3.4.0
 less                     ^3.0.4  â†’  ^3.13.1
 prettier                 ^2.2.1  â†’   ^2.3.2
 vue-template-compiler   ^2.6.11  â†’  ^2.6.14
 core-js                  ^3.6.5  â†’  ^3.16.2
 vue                     ^2.6.11  â†’  ^2.6.14
 vue-router               ^3.2.0  â†’   ^3.5.2

Run yarn install to install new versions.

PS C:\Users\Lolipop\Github\resume&gt; yarn install
```

å¯åŠ¨é¡¹ç›®æœåŠ¡ç«¯æ¸²æŸ“ï¼Œç¡®ä¿èƒ½æ­£å¸¸è¿è¡Œï¼š

```bash
PS C:\Users\Lolipop\Github\resume&gt; yarn serve
```

å°†åŸæœ‰çš„ Vue æ–‡ä»¶ç§»åŠ¨è¿‡æ¥ï¼Œå¤„ç†å‘ç”Ÿé”™è¯¯çš„ä¾èµ–å…³ç³»ï¼Œå†æ ¹æ®éœ€è¦å®‰è£…å¿…è¦çš„å…¶å®ƒä¾èµ–ã€‚

åˆ«å¿˜äº†é…ç½® `vue.config.js` ä¸­çš„ `publicPath` é¡¹ã€‚æˆ‘ä»¬çš„é¡¹ç›®å°†éƒ¨ç½²åœ¨åŸŸåçš„æ ¹è·¯å¾„ï¼Œä¾‹å¦‚ `https://lolipopj.github.io/resume`ï¼Œå› æ­¤éœ€è¦é…ç½®å¦‚ä¸‹ï¼š

```js
// vue.config.js
module.exports = {
  publicPath: process.env.NODE_ENV === &quot;production&quot; ? &quot;/resume/&quot; : &quot;/&quot;,
};
```

Okay... ä¸€åˆ‡å°±ç»ªï¼Œæœ€ååªéœ€è¦æ‰§è¡Œï¼š

```bash
PS C:\Users\Lolipop\Github\resume&gt; yarn build
...

 DONE  Build complete. The dist directory is ready to be deployed.
 INFO  Check out deployment instructions at https://cli.vuejs.org/guide/deployment.html

Done in 14.90s.
```

Beatiful. ç°åœ¨ï¼Œåªéœ€è¦å°† `dist/` ç›®å½•ä¸‹çš„é™æ€èµ„æºéƒ¨ç½²å³å¯ã€‚

### éƒ¨ç½² Github page

ä¸€å¦‚æ—¢å¾€ï¼Œä¸»åˆ†æ”¯çš„æäº¤è§¦å‘ Github Actionsï¼Œè‡ªåŠ¨æ‰§è¡Œæ‰“åŒ…æ„å»ºæ“ä½œï¼Œå¹¶å°†å®ƒä»¬ä¸Šä¼ åˆ° gh-pages åˆ†æ”¯ï¼Œéƒ¨ç½²ä¸º Github pageã€‚

é¦–å…ˆåˆ›å»ºä¸€ä¸ª [Personal access token](https://github.com/settings/tokens/new)ï¼Œèµ‹äºˆ repo çš„æ‰€æœ‰æƒé™ã€‚åœ¨ä»“åº“çš„ Secrets å¤„æ·»åŠ æ–°çš„ç§˜å¯†ï¼Œå‘½åä¸ºä¾‹å¦‚ `ACCESS_TOKEN`ã€‚å°†åˆšåˆšåˆ›å»ºçš„ token ä½œä¸ºæ­¤ç§˜å¯†çš„å€¼å³å¯ã€‚

åˆ›å»ºå¹¶ç¼–å†™ `.github/workflows/deploy.yml` å¦‚ä¸‹ï¼š

```yml
name: Resume Deployment

on:
  push:
    branches:
      - main

jobs:
  pages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js 14.x
        uses: actions/setup-node@v1
        with:
          node-version: &quot;14.x&quot;
      - name: Cache NPM dependencies
        uses: actions/cache@v2
        with:
          path: node_modules
          key: ${{ runner.OS }}-npm-cache
          restore-keys: |
            ${{ runner.OS }}-npm-cache
      - name: Install Dependencies
        run: |
          npm install
      - name: Build
        run: |
          npm run build
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          personal_token: ${{ secrets.ACCESS_TOKEN }}
          publish_dir: dist
          publish_branch: gh-pages
```

æäº¤ä»£ç ï¼ç°åœ¨ï¼Œæˆ‘çš„ç®€å†é¡ºåˆ©éƒ¨ç½²åˆ°äº† [Github page](https://lolipopj.github.io/resume/) ä¸Šã€‚

## å¯¼å‡ºç®€å† PDF æ–‡ä»¶

æˆ–è®¸ç›´æ¥å°†ç®€å†ç½‘ç«™åœ°å€å‘é€ç»™ HR å¾ˆé…·ï¼Œä½†æ˜¯æ‹›è˜ç³»ç»Ÿè¿˜æ˜¯éœ€è¦æˆ‘æäº¤ç®€å†çš„ PDF æ–‡æ¡£ã€‚

&gt; æ¥ä¸‹æ¥çš„å†…å®¹ä¸»è¦å‚è€ƒäº† best-resume-ever å·²æœ‰çš„[å®ç°](https://github.com/salomonelli/best-resume-ever/blob/master/scripts/export.js)ã€‚

çŸ¥åçš„ [puppeteer](https://www.npmjs.com/package/puppeteer) é¡¹ç›®å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆé¡µé¢çš„ PDF æ–‡æ¡£ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼š

```bash
PS C:\Users\Lolipop\Github\resume&gt; yarn add -D puppeteer@10.2.0
```

ç”±äºæˆ‘ä»¬éœ€è¦å…ˆå¯åŠ¨æœ¬åœ°æœåŠ¡ï¼Œæ‰èƒ½ç”¨ puppeteer è®¿é—®ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦å…ˆæ‰§è¡Œ `yarn serve` å‘½ä»¤ï¼Œå½“æœåŠ¡å¯åŠ¨æˆåŠŸåï¼Œå†æ‰§è¡Œåç»­çš„æ“ä½œã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ [concurrently](https://www.npmjs.com/package/concurrently) å’Œ [rxjs](https://www.npmjs.com/package/rxjs) å®ç°ï¼š

```bash
PS C:\Users\Lolipop\Github\resume&gt; yarn add -D concurrently@6.2.1 rxjs@7.3.0
```

concurrently å¯ä»¥åœ¨ä¸€ä¸ªç»ˆç«¯ä¸­åŒæ—¶è¿è¡Œå¤šä¸ªå‘½ä»¤ï¼Œä¸€æ—¦æŸä¸ªå‘½ä»¤è¿è¡Œå¤±è´¥ï¼Œä¾¿ä¸­æ­¢åˆšåˆšå½“å‰ç»ˆç«¯è¿è¡Œçš„æ‰€æœ‰å‘½ä»¤ã€‚

å‡è®¾æˆ‘ä»¬ç¼–å†™çš„è„šæœ¬æ–‡ä»¶ä¸º `scripts/export.js`ï¼Œé‚£ä¹ˆåœ¨ `package.json` ä¸­å¯ä»¥æ·»åŠ è¿™æ ·ä¸€æ¡å‘½ä»¤ï¼š

```json
{
  &quot;scripts&quot;: {
    &quot;export&quot;: &quot;concurrently \&quot;npm run serve\&quot; \&quot;node scripts/export.js\&quot; --success first --kill-others&quot;
  }
}
```

æˆ‘ä»¬å°†ä¾æ¬¡æ‰§è¡Œ `npm run serve` å’Œ `node scripts/export.js`ã€‚å½“ç¬¬ä¸€æ¡å‘½ä»¤æˆåŠŸæ—¶è¿”å› 0ï¼Œå¤±è´¥æ—¶è¿”å› 1ã€‚ä»»æ„ä¸€æ¡å‘½ä»¤ç»“æŸæˆ–å¤±è´¥æ—¶ä¸­æ­¢æ­¤è„šæœ¬ã€‚

rxjs æ˜¯ä¸€ä¸ªç”¨äºç¼–å†™å¼‚æ­¥ã€äº‹ä»¶é©±åŠ¨çš„ç¨‹åºçš„åº“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥ç›‘å¬é¡µé¢æ˜¯å¦å°±ç»ªï¼Œé¿å…åœ¨å°šæœªåŠ è½½å®Œæˆçš„æƒ…å†µä¸‹å°±æ‰“å°ç®€å† PDF æ–‡æ¡£ï¼š

```js
const http = require(&quot;http&quot;);
const { interval } = require(&quot;rxjs&quot;);
const { filter, first, mergeMap } = require(&quot;rxjs/operators&quot;);

const config = require(&quot;../config&quot;);
const port = config.DEV_PORT;

const fetchServeResponse = () =&gt; {
  return new Promise((res, rej) =&gt; {
    try {
      const req = http.request(`http://localhost:${port}/`, (response) =&gt;
        res(response.statusCode),
      );
      req.on(&quot;error&quot;, (err) =&gt; rej(err));
      req.end();
    } catch (err) {
      rej(err);
    }
  });
};

const waitForServerReady = () =&gt; {
  return interval(1000).pipe(
    mergeMap(async () =&gt; {
      try {
        const statusCode = await fetchServeResponse();
        if (statusCode === 200) {
          return true;
        }
        return false;
      } catch (err) {
        return false;
      }
    }),
    filter((ok) =&gt; !!ok),
  );
};
```

æ¥ä¸‹æ¥ï¼Œåˆ©ç”¨ puppeteer çš„å¼ºå¤§åŠŸèƒ½ï¼Œæ‰“å°å‡ºç®€å†çš„ PDF æ–‡æ¡£ï¼Œé¡ºä¾¿å†ç»™å±å¹•æˆªä¸ªå›¾å¥½äº†ï¼š

```js
const puppeteer = require(&quot;puppeteer&quot;);
const path = require(&quot;path&quot;);
const fs = require(&quot;fs&quot;);

const config = require(&quot;../config&quot;);
const port = config.DEV_PORT || 8088;
const defaultScreenshotWidth = config.EXPORT_SCREENSHOT_WIDTH || 1600;
const defaultScreenshotHeight = config.EXPORT_SCREENSHOT_HEIGHT || 1000;
const defaultPdfWidth = config.EXPORT_PDF_WIDTH || 1600;
const defaultPdfHeight = config.EXPORT_PDF_HEIGHT || 1000;

const { lastValueFrom } = require(&quot;rxjs&quot;);
const { first } = require(&quot;rxjs/operators&quot;);

const convert = async function () {
  await lastValueFrom(waitForServerReady().pipe(first()));

  console.log(&quot;Connected to server ...&quot;);
  console.log(&quot;Exporting ...&quot;);

  try {
    const savePath = path.join(__dirname, &quot;../export/&quot;);

    if (!fs.existsSync(savePath)) {
      fs.mkdirSync(savePath);
    }

    const exportResume = async function ({
      code = &quot;cn&quot;,
      screenshotFullPage = true,
      screenshotQuality = 100,
    }) {
      const url = `http://localhost:${port}/#/${code}?exportMode=true`;
      const filename = `resume-${code}`;

      const codeUpperCase = code.toUpperCase();
      const screenshotWidth =
        config[`EXPORT_SCREENSHOT_WIDTH_${codeUpperCase}`] ||
        defaultScreenshotWidth;
      const screenshotHeight =
        config[`EXPORT_SCREENSHOT_HEIGHT_${codeUpperCase}`] ||
        defaultScreenshotHeight;
      const pdfWidth =
        config[`EXPORT_PDF_WIDTH_${codeUpperCase}`] || defaultPdfWidth;
      const pdfHeight =
        config[`EXPORT_PDF_HEIGHT_${codeUpperCase}`] || defaultPdfHeight;

      const browser = await puppeteer.launch({
        args: [&quot;--no-sandbox&quot;],
        defaultViewport: {
          width: screenshotWidth,
          height: screenshotHeight,
        },
      });

      const page = await browser.newPage();

      await page.goto(url, {
        waitUntil: &quot;networkidle0&quot;,
      });

      await page.screenshot({
        path: `${savePath}${filename}.jpeg`,
        fullPage: screenshotFullPage,
        quality: screenshotQuality,
      });

      await page.pdf({
        path: `${savePath}${filename}.pdf`,
        width: pdfWidth,
        height: pdfHeight,
      });

      await browser.close();
    };

    await exportResume({
      code: &quot;cn&quot;,
    });

    await exportResume({
      code: &quot;en&quot;,
    });
  } catch (err) {
    console.log(&quot;Export failed.&quot;);
    throw new Error(err);
  }

  console.log(&quot;Finished exports.&quot;);
};
```

åœ¨ URL çš„ç»“å°¾æˆ‘è®¾ç½®äº† `?exportMode=true`ï¼Œä¾› Vue Router æŸ¥è¯¢ä½¿ç”¨ã€‚æ­£å¸¸è®¿é—®ç½‘é¡µæ—¶ï¼Œé»˜è®¤ä¸ºã€Œéå¯¼å‡ºæ¨¡å¼ã€ï¼Œç½‘é¡µä¸Šä¼šæ˜¾ç¤ºåˆ‡æ¢è¯­è¨€å’Œåˆ‡æ¢å¤œé—´æ¨¡å¼æŒ‰é’®ç­‰ï¼›ä½¿ç”¨æ­¤è„šæœ¬æ—¶ï¼Œè®¿é—®çš„ç½‘é¡µä¸ºã€Œå¯¼å‡ºæ¨¡å¼ã€ï¼Œéšè—æ‰ä¸å¿…è¦çš„å†…å®¹ã€‚

ç„¶ååˆåˆ°äº†çˆ·æœ€å–œæ¬¢çš„**çº¦å®šå¤§äºé…ç½®**ç¯èŠ‚ï¼Œåœ¨ä¸Šé¢çš„ä»£ç é‡Œï¼Œå‡è®¾æ¯ä¸ªç¿»è¯‘ç‰ˆæœ¬çš„ç®€å†æœ‰ä¸åŒçš„ URL å€¼ï¼Œå¯¹åº”ä¸åŒçš„ `code`ã€‚ä¾‹å¦‚ `http://localhost:8088/#/cn` ä¸ºç®€å†çš„ä¸­æ–‡ç‰ˆæœ¬ï¼Œå¯¹åº”çš„ `code` å€¼ä¸º `cn`ã€‚è¿™æ ·ï¼Œæœ€ç»ˆå¯¼å‡ºæ–‡ä»¶ä¸º `export/resume-cn.jpeg` å’Œ `export/resume-cn.pdf`ã€‚

å¦‚æœéœ€è¦é…ç½®ä¸åŒç¿»è¯‘ç‰ˆæœ¬çš„ç®€å†çš„ PDF æ–‡æ¡£ï¼ˆæˆ–æˆªå›¾ï¼‰çš„å¤§å°ï¼Œå¯ä»¥åœ¨ `config.json` ä¸­é…ç½®ã€‚ä¾‹å¦‚éœ€è¦é…ç½®ä¸­æ–‡ç‰ˆæœ¬ç®€å† PDF æ–‡æ¡£çš„é«˜åº¦ï¼Œè®¾ç½® `&quot;EXPORT_PDF_HEIGHT_CN&quot;: 850` å³å¯ï¼Œå…¶ä¸­ `_CN` ä¸º `code` çš„å¤§å†™å€¼å‰é¢åŠ ä¸ŠçŸ­æ¨ªçº¿ã€‚

ä¸è¿‡ï¼Œæ‰‹åŠ¨é…ç½®æ‰“å° PDF é«˜åº¦åœ¨å®ç°ä¸Šå¹¶ä¸ä¼˜é›…ï¼Œä»”ç»†æƒ³æƒ³ï¼Œæ—¢ç„¶ puppeteer èƒ½å¤Ÿæ¨¡ä»¿æµè§ˆå™¨ä¸­çš„æ‰€æœ‰è¡Œä¸ºï¼Œé‚£ä¹ˆï¼šåœ¨å›ºå®šé¡µé¢å®½åº¦çš„æƒ…å†µä¸‹ï¼Œè·å–å½“å‰é¡µé¢çš„é«˜åº¦ä¹Ÿæ˜¯ç†æ‰€åº”å½“èƒ½å¤Ÿåšåˆ°çš„å§ã€‚[`page.evaluate()`](https://pptr.dev/#?product=Puppeteer&amp;version=v10.2.0&amp;show=api-pageevaluatepagefunction-args) æ–¹æ³•å¯ä»¥å®ç°è¿™ä¸ªéœ€æ±‚ï¼š

```js
const exportResume = async function ({ autoFitPdf = true }) {
  // ...
  const pdfHeight = autoFitPdf
    ? await page.evaluate(() =&gt; {
        const body = document.body,
          html = document.documentElement;

        const pageHeight = Math.max(
          body.scrollHeight,
          body.offsetHeight,
          html.clientHeight,
          html.scrollHeight,
          html.offsetHeight,
        );

        // ç¡®ä¿å®¹çº³ä¸‹æ‰€æœ‰çš„å†…å®¹ï¼Œ
        // è€Œä¸ä¼šå› å°æ•°ç‚¹åçš„å·®å€¼åˆ†é¡µ
        return pageHeight + 10;
      })
    : config[`EXPORT_PDF_HEIGHT_${codeUpperCase}`] || defaultPdfHeight;
  // ...
};
```

å®Œæ•´çš„è„šæœ¬æ–‡ä»¶[è§äºæ­¤](https://github.com/LolipopJ/resume/blob/8ae81dcffe2b84c71d3ce4c8f3adb705b4f98b91/scripts/export.js)ã€‚

æœ€åï¼Œè§è¯åŠ³åŠ¨çš„æˆæœå§ã€‚æ‰§è¡Œåˆšåˆšæˆ‘ä»¬ç¼–å†™çš„è„šæœ¬ï¼š

```bash
PS C:\Users\Lolipop\Github\resume&gt; yarn export
...
[0] &lt;s&gt; [webpack.Progress] 100%
[0]
[0]
[0]
[0]   App running at:
[0]   - Local:   http://localhost:8088/
[0]   - Network: http://192.168.237.206:8088/
[0]
[0]   Note that the development build is not optimized.
[0]   To create a production build, run yarn build.
[0]
[1] Connected to server ...
[1] Exporting ...
[1] Finished exports.
[1] node scripts/export.js exited with code 0
--&gt; Sending SIGTERM to other processes..
[0] npm run serve exited with code 1
Done in 42.14s.
```

ä¸ºäº†é¿å…å¯¼å‡ºå¤±è´¥æˆ–å¼‚å¸¸ï¼Œåœ¨æ­¤æœŸé—´åº”é¿å…ä¿®æ”¹é¡µé¢æºæ–‡ä»¶ã€‚

é¡ºåˆ©åœ°å¯¼å‡ºäº†æˆ‘çš„ç®€å†ï¼Œæ­¤å¤–è¿˜æœ‰æˆªå›¾å’Œè‹±æ–‡ç‰ˆæœ¬ï¼š

![resume export](./build-my-resume/resume-export.png)
</content:original-text><content:updated-at>2021-08-20T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[ä½¿ç”¨ jsDelivr åŠ é€Ÿ Github ä»“åº“æ­å»ºè‡ªå·±çš„å›¾åºŠæœåŠ¡]]></title><description><![CDATA[ä½¿ç”¨æ­¤ç±»å…¬ç›ŠæœåŠ¡æ—¶åº”ä¿ç•™æ•¬ç•ä¹‹å¿ƒï¼Œä¸è¦æ»¥ç”¨æœåŠ¡ï¼Œæ¶ˆè€—ä»–äººçš„å–„æ„ã€‚ ä»Šå¤©çªç„¶æƒ³å»æä¸ªå›¾åºŠï¼Œä½¿ç”¨ CDN åŠ é€Ÿå›¾ç‰‡èµ„æºã€‚å› ä¸ºåšå®¢æ”¾åœ¨å°æ°´ç®¡æœåŠ¡å™¨ä¸Šï¼Œç›´æ¥ç”¨è¿™ä¸ªæœåŠ¡å™¨å‘ç”¨æˆ·ä¼ è¾“å›¾ç‰‡èµ„æºå¯¹å¸¦å®½æœ‰å¾ˆå¤§å½±å“ã€‚

é‚ä¸Šç½‘æœç´¢æœ‰æ— å…è´¹å›¾åºŠçš„æœåŠ¡ï¼Œçœ‹åˆ°ä¸å°‘å°† jsDelivr ç”¨ä½œå›¾åºŠä½¿ç”¨çš„æ•™ç¨‹ï¼Œä¾¿è‡ªå·±å®è·µä¸€ç•ªã€‚

åœ¨å›½å†…ï¼Œç›´æ¥ä½¿ç”¨ Github é“¾æ¥æ¥åŠ è½½å›¾ç‰‡æ˜¯å¾ˆæ…¢çš„ï¼Œç”šè‡³äºåŠ è½½ä¸å‡ºæ¥ï¼›ä½†è®¿é—® jsDelivrâ€¦]]></description><link>https://blog.towind.fun/posts/github-jsdelivr-hold-image</link><guid isPermaLink="false">github-jsdelivr-hold-image</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Fri, 13 Aug 2021 00:00:00 GMT</pubDate><content:original-text>
&gt; ä½¿ç”¨æ­¤ç±»å…¬ç›ŠæœåŠ¡æ—¶åº”ä¿ç•™æ•¬ç•ä¹‹å¿ƒï¼Œä¸è¦æ»¥ç”¨æœåŠ¡ï¼Œæ¶ˆè€—ä»–äººçš„å–„æ„ã€‚

ä»Šå¤©çªç„¶æƒ³å»æä¸ªå›¾åºŠï¼Œä½¿ç”¨ CDN åŠ é€Ÿå›¾ç‰‡èµ„æºã€‚å› ä¸ºåšå®¢æ”¾åœ¨å°æ°´ç®¡æœåŠ¡å™¨ä¸Šï¼Œç›´æ¥ç”¨è¿™ä¸ªæœåŠ¡å™¨å‘ç”¨æˆ·ä¼ è¾“å›¾ç‰‡èµ„æºå¯¹å¸¦å®½æœ‰å¾ˆå¤§å½±å“ã€‚

é‚ä¸Šç½‘æœç´¢æœ‰æ— å…è´¹å›¾åºŠçš„æœåŠ¡ï¼Œçœ‹åˆ°ä¸å°‘å°† jsDelivr ç”¨ä½œå›¾åºŠä½¿ç”¨çš„æ•™ç¨‹ï¼Œä¾¿è‡ªå·±å®è·µä¸€ç•ªã€‚

åœ¨å›½å†…ï¼Œç›´æ¥ä½¿ç”¨ Github é“¾æ¥æ¥åŠ è½½å›¾ç‰‡æ˜¯å¾ˆæ…¢çš„ï¼Œç”šè‡³äºåŠ è½½ä¸å‡ºæ¥ï¼›ä½†è®¿é—® jsDelivr é€Ÿåº¦è¾ƒå¿«ã€‚é€šè¿‡ jsDelivr æ¥åŠ é€Ÿ Github ä¸Šçš„å›¾ç‰‡èµ„æºï¼Œå³å¯ä»¥å®ç°æˆ‘ä»¬æƒ³è¦çš„å›¾åºŠæœåŠ¡ã€‚

ä½¿ç”¨å…¶å®ƒçš„å¯ä»¥åŠ é€Ÿ Github èµ„æºçš„ CDN æœåŠ¡æ¥æ›¿æ¢ jsDelivr ä¹Ÿå¯ä»¥ï¼›è¿™åº”è¯¥ç®—æ˜¯ç›®å‰å¯¹äºä¸ªäººå¼€å‘è€…æ¥è¯´ï¼Œæœ€ç®€å•ä¸”æœ€ç»æµçš„æ–¹å¼äº†ã€‚

## åˆ›å»ºå›¾åºŠä»“åº“

åœ¨ Github ä¸Šè‡ªå»ºä¸€ä¸ª**å…¬å¼€**çš„ä»“åº“å³å¯ï¼Œä¸å…¶å®ƒä»“åº“åŒºåˆ†å¼€ï¼Œæ‚¨å¯ä»¥å‘½åä¸º `img-holder`ã€‚

ä¸ºä»€ä¹ˆè¦æ˜¯å…¬å¼€çš„ä»“åº“ï¼Ÿå› ä¸º jsDelivr æ˜¯ A free CDN for Open Sourceã€‚å’³å’³ï¼Œå› ä¸ºéå…¬å¼€çš„ä»“åº“åˆ«äººä¹Ÿè®¿é—®ä¸åˆ°å•¦ã€‚

æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥å¾€è¿™ä¸ªä»“åº“é‡Œæ‰”å›¾ç‰‡æ–‡ä»¶äº†ã€‚

## ä½¿ç”¨ jsDelivr åŠ é€Ÿ

ä½¿ç”¨ä¹Ÿéå¸¸ç®€å•ï¼ŒjsDiliver æä¾›äº†è¿™ä¸ªä¾‹å­ï¼š

```plaintext
// load any GitHub release, commit, or branch
https://cdn.jsdelivr.net/gh/user/repo@version/file
```

æŒ‰ç…§è¿™ä¸ªæ ¼å¼ä¾è‘«èŠ¦ç”»ç“¢ï¼Œä¾‹å¦‚åœ¨ç¼–å†™ Markdown æ—¶ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š

```md
![CDN host image](https://cdn.jsdelivr.net/gh/user/repo/file)
```

å…¶ä¸­ `user` ä¸º Github è´¦æˆ·åï¼Œ`repo` ä¸ºä»“åº“åï¼Œ`file` ä¸ºæ–‡ä»¶è·¯å¾„ã€‚

## å®é™…ä½¿ç”¨ç¤ºä¾‹

åœ¨æˆ‘çš„ `img-folder` ä»“åº“ä¸­å­˜æ”¾äº†ä¸€ä¸ª [`pic/less-spend.gif`](https://github.com/LolipopJ/img-folder/blob/master/pic/less-spend.gif) æ–‡ä»¶ã€‚

ç¼–å†™ Markdown å†…å®¹å¦‚ä¸‹ï¼š

```md
![Spend my money less](https://cdn.jsdelivr.net/gh/lolipopj/img-folder/pic/less-spend.gif)
```

æ¸²æŸ“ä¸º HTML æ–‡ä»¶ï¼Œæ˜¾ç¤ºå†…å®¹å¦‚ä¸‹ï¼š

![Spend my money less](https://cdn.jsdelivr.net/gh/lolipopj/img-folder/pic/less-spend.gif)

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”±äº jsDelivr æœ¬èº«çš„ç¼“å­˜æœºåˆ¶ï¼Œåˆšåˆšä¸Šä¼ åˆ° Github ä»“åº“ä¸Šçš„å›¾ç‰‡èµ„æºå¯èƒ½æ— æ³•æˆåŠŸè·å–ã€‚ç³»æ­£å¸¸ç°è±¡ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ä¾¿å¯ã€‚

çœ‹åˆ°ä¸€äº›åšå®¢æåˆ°å¯ä»¥ä½¿ç”¨ [PicGo](https://github.com/Molunerfinn/PicGo) æ¥ç®¡ç†è‡ªå·±çš„å›¾åºŠèµ„æºï¼Œç”µè„‘å’Œæ‰‹æœºç«¯éƒ½å¯ä»¥ä½¿ç”¨ï¼Œç”šè‡³è¿˜æä¾›äº† VSCode æ’ä»¶ã€‚Coolï¼Œå¯¹äºä½¿ç”¨å›¾ç‰‡è¾ƒå¤šçš„ç”¨æˆ·å¯èƒ½éå¸¸æœ‰å¸®åŠ©ã€‚
</content:original-text><content:updated-at>2024-07-25T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[ä½¿ç”¨ EditorConfig å’Œ Prettier ä¼˜é›…åœ°é…ç½® VSCode ä»£ç æ ¼å¼åŒ–]]></title><description><![CDATA[ç¼–å†™ä»£ç æ—¶ä½¿ç”¨ EditorConfig EditorConfig èƒ½å¤Ÿå¸®åŠ©è·¨å„ç§ IDE å¼€å‘åŒä¸€é¡¹ç›®çš„ä¸åŒå¼€å‘äººå‘˜ä¿æŒä¸€è‡´çš„ç¼–ç é£æ ¼ã€‚

VSCode æ²¡æœ‰å†…ç½®å¯¹ EditorConfig çš„æ”¯æŒï¼Œéœ€è¦åœ¨æ’ä»¶å¸‚åœºä¸­æ‰‹åŠ¨æœç´¢å¹¶å®‰è£…æ’ä»¶ã€‚

EditorConfig ä¼šè‡ªåŠ¨è¯»å–å·¥ä½œåŒºä¸­çš„  æ–‡ä»¶ï¼Œæ›´è¯¦ç»†çš„é…ç½®è¯´æ˜å¯ä»¥å‚è€ƒå®˜æ–¹ä»‹ç»ã€‚ä¸‹é¢æ˜¯ç¬”è€…å¸¸ç”¨çš„é…ç½®ï¼š

æ¨é€ä»“åº“å‰ä½¿ç”¨ Prettier

ä¸ºäº†è¿›ä¸€æ­¥ç¡®â€¦]]></description><link>https://blog.towind.fun/posts/editorconfig-prettier</link><guid isPermaLink="false">editorconfig-prettier</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Sat, 07 Aug 2021 00:00:00 GMT</pubDate><content:original-text>
## ç¼–å†™ä»£ç æ—¶ä½¿ç”¨ EditorConfig

EditorConfig èƒ½å¤Ÿå¸®åŠ©è·¨å„ç§ IDE å¼€å‘åŒä¸€é¡¹ç›®çš„ä¸åŒå¼€å‘äººå‘˜ä¿æŒä¸€è‡´çš„ç¼–ç é£æ ¼ã€‚

VSCode æ²¡æœ‰å†…ç½®å¯¹ EditorConfig çš„æ”¯æŒï¼Œéœ€è¦åœ¨æ’ä»¶å¸‚åœºä¸­æ‰‹åŠ¨æœç´¢å¹¶å®‰è£…[æ’ä»¶](https://marketplace.visualstudio.com/items?itemName=EditorConfig.EditorConfig)ã€‚

EditorConfig ä¼šè‡ªåŠ¨è¯»å–å·¥ä½œåŒºä¸­çš„ `.editorconfig` æ–‡ä»¶ï¼Œæ›´è¯¦ç»†çš„é…ç½®è¯´æ˜å¯ä»¥å‚è€ƒ[å®˜æ–¹ä»‹ç»](https://editorconfig-specification.readthedocs.io/)ã€‚ä¸‹é¢æ˜¯ç¬”è€…å¸¸ç”¨çš„é…ç½®ï¼š

```editorconfig
root = true

[*]
indent_style = space
indent_size = 4
end_of_line = lf
charset = utf-8
insert_final_newline = true
trim_trailing_whitespace = true
```

## æ¨é€ä»“åº“å‰ä½¿ç”¨ Prettier

ä¸ºäº†è¿›ä¸€æ­¥ç¡®ä¿ä»£ç é£æ ¼ç¬¦åˆç¼–ç è§„èŒƒï¼Œå¯ä»¥åœ¨ä¸Šåº“å‰ä½¿ç”¨ Prettier ä¿®å¤ä»£ç æ ¼å¼ã€‚

å°† Prettier å®‰è£…ä¸ºé¡¹ç›®å¼€å‘ä¾èµ–ï¼š

```bash
yarn add -D prettier
```

åœ¨ `package.json` ä¸­æ·»åŠ  Prettier è¿è¡Œè„šæœ¬ï¼š

```json
{
  &quot;scripts&quot;: {
    &quot;prettier&quot;: &quot;prettier --write **/* --ignore-unknown&quot;
  }
}
```

ç°åœ¨ï¼Œæ‰§è¡Œ `yarn prettier` å‘½ä»¤ï¼Œå·¥å…·å°†æŒ‰ç…§ Prettier é¢„ç½®çš„è§„åˆ™è‡ªåŠ¨æ ¼å¼åŒ–æ‰€æœ‰æ”¯æŒçš„åç¼€æ ¼å¼çš„æ–‡ä»¶äº†ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.prettierrc.json` æ–‡ä»¶ï¼Œå¯ä»¥è¿›ä¸€æ­¥é…ç½® Prettier æ ¼å¼åŒ–è§„åˆ™ï¼Œå¯å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://prettier.io/docs/en/options.html)ã€‚ä¾‹å¦‚ï¼š

```json
{
  // JSON æ–‡ä»¶ä¸­ä¸åº”æ·»åŠ æ³¨é‡Šï¼Œéœ€å»é™¤
  &quot;semi&quot;: true, // å¥æœ«æ˜¯å¦æ·»åŠ åˆ†å·
  &quot;singleQuote&quot;: true // æ˜¯å¦ä½¿ç”¨å•å¼•å·
}
```

å‡å¦‚æˆ‘ä»¬çš„é¡¹ç›®ä¸­ä¼šåŒ…å« PHP ä»¥åŠ Java ç­‰è¯­è¨€çš„ä»£ç ï¼Œè¦è®© Prettier å¤„ç†å®ƒä»¬çš„æ ¼å¼ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒPrettier å¹¶ä¸æ”¯æŒ PHP æˆ– Java ä»£ç çš„æ ¼å¼åŒ–ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬å•ç‹¬æ·»åŠ æ”¯æŒå…¶å®ƒç¼–ç¨‹è¯­è¨€çš„ [Prettier æ’ä»¶](https://prettier.io/docs/en/plugins.html)ä½œä¸ºé¡¹ç›®çš„ä¾èµ–ã€‚å…¶ä¸­ï¼Œä»¥ `@prettier` å¼€å¤´çš„æ’ä»¶ä¸ºå®˜æ–¹ç»´æŠ¤æ’ä»¶ï¼Œä¾‹å¦‚ [`@prettier/plugin-php`](https://github.com/prettier/plugin-php)ï¼›å…¶å®ƒå‘½åæ’ä»¶ä¸ºç¤¾åŒºå¼€å‘æ’ä»¶ï¼Œä¾‹å¦‚ [`prettier-plugin-java`](https://github.com/jhipster/prettier-java)ã€‚

```bash
yarn add --dev @prettier/plugin-php prettier-plugin-java
```

Prettier å°†è‡ªåŠ¨åŠ è½½ä¸å®ƒåœ¨åŒä¸€ `node_modules` æ–‡ä»¶å¤¹ä¸­çš„ Prettier æ’ä»¶ï¼Œå¹¶è‡ªåŠ¨è¯†åˆ«æ–°å¢çš„ä»£ç åç¼€ï¼ˆå¦‚ `.php` å’Œ `.java`ï¼‰ã€‚å› æ­¤åœ¨æœ€åï¼Œåªéœ€è¦å†æ‰§è¡Œä¸€é `yarn prettier`ï¼Œå°±å¯ä»¥å®ç°æ ¼å¼åŒ–é¡¹ç›®ä¸­çš„ PHP åŠ Java ä»£ç äº†ã€‚
</content:original-text><content:updated-at>2023-12-14T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[æ›´æ¢æŒç»­é›†æˆå·¥å…·ï¼Œä» Travis åˆ° Github Actions]]></title><description><![CDATA[æˆ‘çœŸå‚»ï¼ŒçœŸçš„ï¼Œå•å•å—æ–‡æ¡£çš„æ¨èå°±é€‰æ‹©äº† Travis ä½œä¸ºéƒ¨åˆ†é¡¹ç›®çš„æŒç»­é›†æˆå·¥å…·ï¼Œæ²¡æœ‰æ–™åˆ°å®ƒæ—©å·²äº 2020 å¹´ 12 æœˆæ›´æ¢äº†å…è´¹æ”¿ç­–ï¼Œä¸å†ä¸ºå¼€æºé¡¹ç›®æä¾›å…è´¹çš„ç”¨äºæŒç»­é›†æˆä½¿ç”¨çš„ Credits äº†ã€‚å½“èµ é€çš„ 10000 ä¸ªç‚¹æ•°ç”¨å®Œï¼Œå°±éœ€è¦ä»˜è´¹æ‰èƒ½è¿›è¡Œæ„å»ºäº†ã€‚ å½“ç„¶ï¼Œä½œä¸ºç»æµé©±åŠ¨çš„å…¬å¸ï¼Œè¿‘äº›å¤©æ¥åˆå— Github Actions ç­‰å…¶å®ƒæŒç»­é›†æˆå·¥å…·æ‰“å‹äº†ç›ˆåˆ©ç©ºé—´â€¦]]></description><link>https://blog.towind.fun/posts/switch-travis-to-github-workflow</link><guid isPermaLink="false">switch-travis-to-github-workflow</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Sat, 10 Jul 2021 00:00:00 GMT</pubDate><content:original-text>
æˆ‘çœŸå‚»ï¼ŒçœŸçš„ï¼Œå•å•å—æ–‡æ¡£çš„æ¨èå°±é€‰æ‹©äº† Travis ä½œä¸ºéƒ¨åˆ†é¡¹ç›®çš„æŒç»­é›†æˆå·¥å…·ï¼Œæ²¡æœ‰æ–™åˆ°å®ƒæ—©å·²äº 2020 å¹´ 12 æœˆæ›´æ¢äº†å…è´¹æ”¿ç­–ï¼Œä¸å†ä¸ºå¼€æºé¡¹ç›®æä¾›å…è´¹çš„ç”¨äºæŒç»­é›†æˆä½¿ç”¨çš„ Credits äº†ã€‚å½“èµ é€çš„ 10000 ä¸ªç‚¹æ•°ç”¨å®Œï¼Œå°±éœ€è¦ä»˜è´¹æ‰èƒ½è¿›è¡Œæ„å»ºäº†ã€‚

å½“ç„¶ï¼Œä½œä¸ºç»æµé©±åŠ¨çš„å…¬å¸ï¼Œè¿‘äº›å¤©æ¥åˆå— Github Actions ç­‰å…¶å®ƒæŒç»­é›†æˆå·¥å…·æ‰“å‹äº†ç›ˆåˆ©ç©ºé—´ï¼ŒæŠ›å¼ƒå¼€æºç”¨æˆ·é€‰æ‹©è½¬å‹åšèµ·äº†å•†äººäº‹ä¸šä¹Ÿå¹¶éä¸å¯ç†è§£ã€‚æ„Ÿè°¢å®ƒæ›¾ä¸ºå¼€å‘è€…æä¾›çš„ä¾¿åˆ©ï¼Œä¸è¿‡ä½œä¸ºä¸€ä¸ªä½›ç³»å¼€å‘è€…ï¼Œç»ˆäºè¿˜æ˜¯éœ€è¦è½¬æŠ•åˆ°åˆ«çš„å…è´¹å·¥å…·ä¸Šå»äº†â€”â€”Gihub Actionsã€‚

## ç¼–å†™æ–°çš„ workflow.yml

é‚£ä¹ˆé¦–å…ˆï¼Œæˆ‘ä»¬å°±éœ€è¦å°†ä¸º Travis ç¼–å†™çš„å‘½åä¸º `.travis.yml` çš„é…ç½®æ–‡ä»¶ï¼Œç¿»è¯‘æˆ Github Actions èƒ½è¯†åˆ«çš„ workflow.yml é…ç½®æ–‡ä»¶ã€‚

ä»¥[çŒ®ç»™ä¸­æ–‡è¯»è€…çš„è®¾è®¡æ¨¡å¼æ•™ç¨‹](https://github.com/LolipopJ/design-patterns-for-humans-zh)è¿™ä¸ªé¡¹ç›®ä¸ºä¾‹ï¼ŒåŸæœ‰çš„ `.travis.yml` å†…å®¹å¦‚ä¸‹ï¼š

```yml
language: node_js
node_js:
  - lts/*
branches:
  only:
    - main
install:
  - cd vuepress
  - yarn install
script:
  - yarn build
deploy:
  provider: pages
  skip_cleanup: true
  local_dir: vuepress/docs/.vuepress/dist
  github_token: $CI_DEPLOY_TOKEN
  keep_history: true
  on:
    branch: main
```

å½“æ£€æµ‹åˆ° main åˆ†æ”¯ä»£ç æ›´æ–°åï¼Œå¯åŠ¨æŒç»­é›†æˆå·¥å…·ã€‚å…‹éš†é¡¹ç›®ï¼Œè¿›å…¥åˆ°é¡¹ç›®çš„ `vuepress` ç›®å½•ä¸‹æ‰§è¡Œå®‰è£…ä¾èµ–å’Œç”Ÿæˆé™æ€æ–‡ä»¶æ“ä½œï¼Œæœ€åå°† `/vuepress/docs/.vuepress/dist` ç›®å½•ä¸‹çš„é™æ€æ–‡ä»¶ï¼Œä¸Šä¼ åˆ° `gh-pages` åˆ†æ”¯ï¼Œäº¤ç»™ Github éƒ¨ç½²ã€‚

ä½¿ç”¨ Github Actions å®ç°ä¸Šé¢çš„è¿‡ç¨‹ï¼Œé¦–å…ˆåœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.github/workflows` æ–‡ä»¶å¤¹ï¼Œåœ¨æ–‡ä»¶å¤¹å†…åˆ›å»º workflow é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ `deploy.yml`ï¼Œç¼–å†™å†…å®¹å¦‚ä¸‹ï¼š

```yml
name: Vuepress Deployment

on:
  push:
    branches:
      - main

jobs:
  pages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js 14.x
        uses: actions/setup-node@v1
        with:
          node-version: &quot;14.x&quot;
      - name: Cache NPM dependencies
        uses: actions/cache@v2
        with:
          path: node_modules
          key: ${{ runner.OS }}-npm-cache
          restore-keys: |
            ${{ runner.OS }}-npm-cache
      - name: Install Dependencies
        run: |
          cd vuepress
          npm install
      - name: Build
        run: |
          cd vuepress
          npm run build
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          deploy_key: ${{ secrets.ACCESS_TOKEN }}
          publish_dir: vuepress/docs/.vuepress/dist
          publish_branch: gh-pages
```

## åˆ›å»º SSH Deploy Key

è¿™ä¸€æ­¥æ˜¯ä¸ºäº†ç»™ Github Actions è¿œç¨‹æœåŠ¡å™¨è®¿é—®æˆ‘çš„ Github è´¦å·æä¾›å‡­è¯ã€‚å¦‚æœæ²¡æœ‰è®¾ç½® Github è´¦æˆ·åŒé‡éªŒè¯æˆ–å…¶å®ƒå®‰å…¨éªŒè¯ï¼Œå¯ä»¥ç§»é™¤ä¸Šé¢è„šæœ¬ä¸­çš„ `deploy_key` å±æ€§ç„¶åè·³è¿‡è¿™ä¸€æ­¥ã€‚ä½†æ˜¯å‡å¦‚ä»¥åè®¾ç½®äº†å®‰å…¨éªŒè¯ï¼Œå›æ¥æ”¹åˆä¼šå¾ˆéº»çƒ¦ï¼Œä¸å¦‚ä¸€æ­¥åˆ°ä½äº†å§ ğŸ¤—ã€‚

æ‚¨ä¹Ÿå¯ä»¥ç”Ÿæˆ Personal access token ä½œä¸ºæ›¿ä»£ï¼Œä¸è¿‡å‰é¢çš„è„šæœ¬ä¸­çš„ `deploy_key` åº”è¯¥ä¿®æ”¹ä¸º `personal_token`ã€‚

å¯åŠ¨å‘½ä»¤è¡Œå·¥å…·ï¼Œåˆ›å»º SSH éƒ¨ç½²å¯†é’¥ï¼š

```bash
# è¿›å…¥åˆ°å½“å‰ç”¨æˆ·çš„ .ssh ç›®å½•ä¸‹
cd ~/.ssh
# åˆ›å»º SSH å¯†é’¥
ssh-keygen -t rsa -b 4096 -C &quot;$(git config user.email)&quot; -f design-patterns-for-humans-zh-gh-pages
```

å…¶ä¸­ï¼Œ`design-patterns-for-humans-zh-gh-pages.pub` ä¸ºå…¬é’¥ï¼Œåº”ä¸Šä¼ åˆ° [Github è´¦æˆ· SSH keys è®¾ç½®](https://github.com/settings/keys)ä¸­ï¼›ä¸å¸¦åç¼€çš„ä¸ºç§é’¥ï¼Œåº”ä½œä¸º [Github é¡¹ç›®ä»“åº“çš„ Secret](https://github.com/LolipopJ/design-patterns-for-humans-zh/settings/secrets/actions)ï¼Œæ ¹æ®å‰é¢çš„é…ç½®ï¼Œè¿™é‡Œå‘½åä¸º `ACCESS_TOKEN`ã€‚

## æœ€åä¸€æ­¥

æœ€åï¼Œç§»é™¤ Github ä»“åº“ä¸­ç”¨äº Travis çš„åˆ é™¤åŸæœ‰éƒ¨ç½²å¯†é’¥ï¼Œä¾‹å¦‚ `CI_DEPLOY_TOKEN`ï¼Œåˆ é™¤é¡¹ç›®ä¸­çš„ `.travis.yml` æ–‡ä»¶ï¼Œæäº¤ä»£ç åˆ° Github å³å¯ã€‚

![CI éƒ¨ç½²æˆåŠŸ](./switch-travis-to-github-workflow/deploy-finished.png)
</content:original-text><content:updated-at>2021-07-14T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ URL åˆ°æ˜¾ç¤ºç½‘é¡µï¼ŒèƒŒåå‘ç”Ÿäº†ä»€ä¹ˆ]]></title><description><![CDATA[æœ€è¿‘å­¦ä¹ å‰ç«¯åŸºç¡€çŸ¥è¯†çš„æ—¶å€™ï¼Œçœ‹åˆ°äº†è¿™ä¸ªé—®é¢˜å’Œä¸€ä¸ªå›ç­”ï¼Œéå¸¸ç”ŸåŠ¨æœ‰è¶£ã€‚é‚æŠ±ç€æ¢³ç†çš„æƒ³æ³•ï¼Œå°†æ•´ä¸ªè¿‡ç¨‹æè¿°å‡ºæ¥ã€‚ ç°åœ¨ï¼Œå‡è®¾æ‚¨æ‰“å¼€äº†æµè§ˆå™¨ï¼Œæƒ³è¦è®¿é—®æˆ‘çš„ä¸ªäººåšå®¢ï¼Œæ‚¨ä¼šåœ¨åœ°å€æ è¾“å…¥  è¿™ä¸ª URL ç„¶åæ•²ä¸‹å›è½¦é”®ã€‚

ä»æ•²ä¸‹å›è½¦é”®åˆ°æœ€ç»ˆé¡ºåˆ©åœ¨æµè§ˆå™¨æ˜¾ç¤ºæˆ‘åšå®¢çš„ä¸»é¡µï¼Œè¿™ä¸ªè¿‡ç¨‹çš„èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ

æ£€æŸ¥ URL æ ¼å¼

åˆ«æ€¥ï¼Œåœ¨æ­£å¼é©¶å…¥äº’è”ç½‘çš„å¿«è½¦é“ä¹‹å‰ï¼Œæµè§ˆå™¨ä¼šé¦–å…ˆæ£€æŸ¥è¾“å…¥çš„ URL çš„æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚

ä¾‹å¦‚â€¦]]></description><link>https://blog.towind.fun/posts/browser-behind-visit-url</link><guid isPermaLink="false">browser-behind-visit-url</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Thu, 08 Jul 2021 00:00:00 GMT</pubDate><content:original-text>
æœ€è¿‘å­¦ä¹ å‰ç«¯åŸºç¡€çŸ¥è¯†çš„æ—¶å€™ï¼Œçœ‹åˆ°äº†è¿™ä¸ªé—®é¢˜å’Œ[ä¸€ä¸ªå›ç­”](https://www.zhihu.com/question/34873227/answer/518086565)ï¼Œéå¸¸ç”ŸåŠ¨æœ‰è¶£ã€‚é‚æŠ±ç€æ¢³ç†çš„æƒ³æ³•ï¼Œå°†æ•´ä¸ªè¿‡ç¨‹æè¿°å‡ºæ¥ã€‚

ç°åœ¨ï¼Œå‡è®¾æ‚¨æ‰“å¼€äº†æµè§ˆå™¨ï¼Œæƒ³è¦è®¿é—®æˆ‘çš„ä¸ªäººåšå®¢ï¼Œæ‚¨ä¼šåœ¨åœ°å€æ è¾“å…¥ `lolipopj.github.io` è¿™ä¸ª URL ç„¶åæ•²ä¸‹å›è½¦é”®ã€‚

ä»æ•²ä¸‹å›è½¦é”®åˆ°æœ€ç»ˆé¡ºåˆ©åœ¨æµè§ˆå™¨æ˜¾ç¤ºæˆ‘åšå®¢çš„ä¸»é¡µï¼Œè¿™ä¸ªè¿‡ç¨‹çš„èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ

## æ£€æŸ¥ URL æ ¼å¼

åˆ«æ€¥ï¼Œåœ¨æ­£å¼é©¶å…¥äº’è”ç½‘çš„å¿«è½¦é“ä¹‹å‰ï¼Œæµè§ˆå™¨ä¼šé¦–å…ˆæ£€æŸ¥è¾“å…¥çš„ URL çš„æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚

ä¾‹å¦‚ï¼Œå‡å¦‚æ‚¨è¾“å…¥çš„æ˜¯ `lolipop j.github.io`ï¼Œæˆ–æ˜¯ `lolipopj.gith$ub.io`ï¼Œæµè§ˆå™¨å°†ä¼šåˆ¤æ–­å®ƒä»¬ä¸ºé URLã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨é€šå¸¸ä¼šå°†æˆ‘ä»¬é”™è¯¯è¾“å…¥çš„ URL ä½œä¸ºæœç´¢å¼•æ“çš„è¾“å…¥å…³é”®å­—ï¼Œæœ€ç»ˆè·³è½¬åˆ°æœç´¢ç»“æœç•Œé¢ã€‚

### ä»€ä¹ˆæ˜¯ URL

- [ã€Œæ ‡è¯†äº’è”ç½‘ä¸Šçš„å†…å®¹ã€](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/Identifying_resources_on_the_Web)ï¼ŒMDN

HTTP è¯·æ±‚çš„å†…å®¹éå¸¸å®½æ³›ï¼Œç»Ÿç§°ä¸ºâ€œèµ„æºâ€ã€‚â€œèµ„æºâ€å¯ä»¥æ˜¯ä¸€ä»½æ–‡æ¡£ï¼Œä¸€å¼ å›¾ç‰‡ï¼Œæˆ–æ‰€æœ‰æ‚¨å¯ä»¥æƒ³è±¡åˆ°çš„æ ¼å¼ã€‚è€Œè¿™æ ·çš„æ¯ä¸ªâ€œèµ„æºâ€ï¼Œéƒ½ç”±ä¸€ä¸ª**ç»Ÿä¸€èµ„æºå®šä½ç¬¦ URL** æ ‡è¯†ã€‚

é€šä¿—åœ°è®²ï¼ŒURL å¯ä»¥å«ä½œâ€œç½‘ç»œåœ°å€â€æˆ–â€œé“¾æ¥â€ï¼Œå®ƒæ˜¯å¯¹æŒ‡å®šè®¡ç®—æœºç½‘ç»œä¸ŠæŸä½ç½®çš„**ç½‘ç»œèµ„æº**çš„å¼•ç”¨ï¼Œä»¥åŠæ£€ç´¢å®ƒçš„æœºåˆ¶ã€‚ä¸€ä¸ªå…¸å‹çš„ URL å¯ä»¥é‡‡ç”¨ `http://www.example.com/index.html` å½¢å¼è¡¨ç¤ºï¼Œå®ƒè¡¨æ˜äº†ä½¿ç”¨çš„åè®®ï¼ˆhttpï¼‰ï¼Œè®¿é—®çš„ä¸»æœºåï¼ˆwww.example.comï¼‰ä»¥åŠæ–‡ä»¶åï¼ˆindex.htmlï¼‰ã€‚

æ­¤å¤–ï¼ŒURL ä¹Ÿå¯ä»¥ç”¨äºæ–‡ä»¶ä¼ è¾“ï¼ˆFTPï¼‰ï¼Œå‘é€é‚®ä»¶ï¼ˆSMTPï¼‰å’Œæ•°æ®åº“è®¿é—®ï¼ˆJDBCï¼‰ç­‰ã€‚

URL æ˜¯**ç»Ÿä¸€èµ„æºæ ‡å¿—ç¬¦ URI** çš„å­é›†ï¼Œç”±äºæ—©æœŸ RFC æ–‡æ¡£æ’°å†™çš„[ä¸€äº›æ··ä¹±](https://danielmiessler.com/study/difference-between-uri-url/)ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­å¯èƒ½ä¼šå‘ç”Ÿæ··ç”¨çš„æƒ…å†µã€‚åœ¨ä»¥ HTTP ä¸ºä¸Šä¸‹æ–‡çš„è¯­å¢ƒä¸­ï¼Œå¤§å¤šæ•°æƒ…å†µä½¿ç”¨ URL å³å¯ã€‚

### URL æ ¼å¼

- [ã€ŒURLã€](https://en.wikipedia.org/wiki/URL)ï¼ŒWikipedia

URL ç¬¦åˆé€šç”¨ URI è¯­æ³•ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```plaintext
URI = scheme:[//authority]path[?query][#fragment]
```

å…¶ä¸­ï¼Œ`authority` éƒ¨åˆ†å¯ä»¥åˆ’åˆ†ä¸ºä¸‰ä¸ªå­æ¨¡å—ï¼š

```plaintext
authority = [userinfo@]host[:port]
```

URI å…·ä½“åŒ…æ‹¬å¦‚ä¸‹éƒ¨åˆ†ï¼š

- **éç©ºçš„** `scheme` æ ‡è¯†ï¼Œåé¢è·Ÿç€ä¸€ä¸ª `:`ã€‚ç”±å­—æ¯å¼€å¤´ï¼Œåè·Ÿå­—æ¯ã€æ•°å­—ã€`+`ã€`.` æˆ–è¿å­—ç¬¦ `-` çš„ä»»æ„ç»„åˆï¼Œè§„èŒƒå»ºè®®ä½¿ç”¨å°å†™æ ¼å¼ã€‚å¸¸è§çš„ä¾‹å­æœ‰ `http:`ï¼Œ`https:` å’Œ `ftp:` ç­‰ã€‚
- å¯é€‰çš„ä»¥ `//` å¼€å¤´çš„ `authority` æƒé™ç»„ä»¶ï¼ŒåŒ…æ‹¬ï¼š
  - å¯é€‰çš„ `userinfo` ç”¨æˆ·ä¿¡æ¯ï¼Œå¯èƒ½åŒ…æ‹¬ç”¨æˆ·åå’Œç”¨æˆ·å¯†ç ï¼Œä¸¤è€…ä½¿ç”¨ `:` åˆ†å¼€ã€‚åœ¨åé¢è·Ÿç€ `@`ã€‚å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œåº”ç”¨ç¨‹åºä¸åº”å½“å°†ç”¨æˆ·å¯†ç éƒ¨åˆ†ç”¨æ˜æ–‡è¡¨ç¤ºã€‚
  - **éç©ºçš„** `host` ä¸»æœºï¼Œç”±æ³¨å†Œåç§°ï¼ˆä¾‹å¦‚ä¸»æœºåï¼‰æˆ– IP åœ°å€ç»„æˆã€‚å¯¹äºåè€…ï¼Œå¦‚æœæ˜¯ IPv4 åœ°å€ï¼Œéœ€è¦ä½¿ç”¨åè¿›åˆ¶è¡¨ç¤ºæ³•ï¼›å¦‚æœæ˜¯ IPv6 åœ°å€ï¼Œéœ€è¦åŒ…æ‹¬åœ¨æ–¹æ‹¬å· `[]` ä¸­ã€‚
  - å¯é€‰çš„ä»¥ `:` å¼€å¤´çš„ `port` ç«¯å£å·ã€‚
- **éç©ºçš„** `path` è·¯å¾„ï¼Œç”±ä¸€ç³»åˆ— `/` åˆ†éš”çš„è·¯å¾„æ®µç»„æˆã€‚è·¯å¾„å°†ç±»ä¼¼æˆ–å®Œå…¨æ˜ å°„åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚æ­¤å¤–ï¼Œå¦‚æœå­˜åœ¨ `authority` æƒé™ç»„ä»¶ï¼Œåˆ™å¿…é¡»ä¸ºç©ºæˆ–ä»¥ `/` å¼€å¤´ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä¸èƒ½ä»¥ç©ºè·¯å¾„æ®µå¼€å¤´ï¼Œå› ä¸ºè¿™æ ·å®é™…ä¸Šå°±æ˜¯ä»¥ `//` å¼€å¤´ï¼Œå°†è¢«è§£é‡Šä¸º `authority` æƒé™ç»„ä»¶ã€‚
- å¯é€‰çš„ä»¥ `?` å¼€å¤´çš„ `query` æŸ¥è¯¢ã€‚è¯­æ³•æ²¡æœ‰æ˜ç¡®è¦æ±‚ï¼Œé€šå¸¸é‡‡ç”¨é”®å€¼å¯¹çš„å½¢å¼ã€‚
- å¯é€‰çš„ä»¥ `#` å¼€å¤´çš„ `fragment` ç‰‡æ®µã€‚ç”¨äºæä¾›å¯¹æ¬¡è¦èµ„æºçš„æŒ‡å‘ï¼Œä¾‹å¦‚åœ¨ HTML æ–‡æ¡£ä¸­ï¼Œå°†æŒ‡å‘åŒ…å«å¯¹åº” `id` å±æ€§çš„å…ƒç´ ã€‚

## è¡¥é½ URL

å‰é¢æˆ‘ä»¬åœ¨ä½¿ç”¨ URL æ—¶ï¼Œå¹¶æ²¡æœ‰æ·»åŠ å®ƒçš„å‰ç¼€ä¾‹å¦‚ `https://`ã€‚é‚£ä¹ˆæˆ‘ä»¬å…·ä½“ä½¿ç”¨çš„æ˜¯ HTTP åè®®è¿˜æ˜¯ HTTPS åè®®å‘¢ï¼Ÿ

é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæµè§ˆå™¨æœ‰è‡ªå·±çš„é¢„æ¡ˆï¼Œå³é»˜è®¤ä½¿ç”¨ HTTP åè®®ã€‚å‡å¦‚æ‚¨æ˜¯**ç¬¬ä¸€æ¬¡**è®¿é—®æˆ‘çš„åšå®¢ï¼ˆæ›´ä¸¥è°¨åœ°è¯´æ˜¯ç¬¬ä¸€æ¬¡è®¿é—® `github.io` åŸŸåä¸‹çš„ç½‘ç«™ï¼‰ï¼Œé™¤éåœ¨è¾“å…¥çš„æœ€å¼€å§‹å°±ä½¿ç”¨äº† `https://lolipopj.github.io` è¿™ä¸ª URLï¼Œå¦åˆ™å‡ä¼šè¢«é»˜è®¤è¡¥é½ä¸º `http://lolipopj.github.io`ã€‚å¯¹äºå¯ç”¨äº† [HSTS ä¿æŠ¤](#ä»€ä¹ˆæ˜¯-hstsä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å®ƒ)çš„ç½‘ç«™ï¼Œä»ç¬¬äºŒæ¬¡çš„è®¿é—®å¼€å§‹ï¼Œæµè§ˆå™¨å°†æ ¹æ®ç¬¬ä¸€æ¬¡è®¿é—®æ—¶å¾—åˆ°çš„å“åº”ç»“æœï¼Œè‡ªåŠ¨è¡¥é½åè®®ã€‚

éšç€ HSTS çš„æ¨å¹¿ä½¿ç”¨ï¼Œç°ä»£æµè§ˆå™¨ä¸­è¿˜å†…ç½®äº†ä¸€ä¸ªåˆ—è¡¨ [Preload List](#hsts-çš„-preload-list-æœºåˆ¶)ï¼Œè®°å½•å¸¸ç”¨ç½‘ç«™æ‰€ä½¿ç”¨çš„åè®®ã€‚å¯¹äºè¿™äº›ç½‘ç«™ï¼Œè¾“å…¥çš„ URL å°†è‡ªåŠ¨åœ¨å‰é¢è¡¥ä¸Šè®°å½•çš„åè®®ï¼Œå†ç”±æµè§ˆå™¨å‘é€è¯·æ±‚ã€‚å› æ­¤åœ¨å®é™…æƒ…å†µä¸­ï¼Œç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼Œæˆ‘ä»¬è¾“å…¥çš„ URL å°±ä¼šè¢«è¡¥é½ä¸º `https://lolipopj.github.io`ã€‚

### HTTP ä¸¥æ ¼ä¼ è¾“å®‰å…¨ HSTS

ä»¥ä¸‹å†…å®¹ä¸»è¦å‚è€ƒæ­¤æ–‡ç« ï¼š

- [ã€ŒHSTS è¯¦è§£ã€](https://zhuanlan.zhihu.com/p/25537440)ï¼Œ2017-03-03

### ä»€ä¹ˆæ˜¯ HSTSï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å®ƒ

åœ¨è¿‡å»ï¼Œå‡å¦‚æœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯ HTTPS åè®®ï¼Œå½“æˆ‘ä»¬é»˜è®¤ä½¿ç”¨ `http://lolipopj.github.io` å‘èµ·è¯·æ±‚æ—¶ï¼Œä¹Ÿä¼šåœ¨æœåŠ¡å™¨ç«¯é€šè¿‡ 301 é‡å®šå‘åˆ° `https://lolipopj.github.io`ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæµè§ˆå™¨é¦–å…ˆä½¿ç”¨äº† HTTP åè®®å‘èµ·è¯·æ±‚ï¼Œå¾—åˆ°é‡å®šå‘çš„å“åº”åï¼Œæµè§ˆå™¨ä¼šé‡æ–°å‘èµ·åŸºäº HTTPS åè®®çš„è¯·æ±‚å¹¶æœ€ç»ˆä¸æœåŠ¡å™¨å»ºç«‹é€šä¿¡ã€‚

è¿™æ˜¯ä¸€ä¸ªå­˜åœ¨é£é™©çš„æ“ä½œï¼Œå› ä¸ºåœ¨å»ºç«‹ HTTPS é€šä¿¡ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰ä¸€æ¬¡æ˜æ–‡çš„ HTTP è¯·æ±‚ä»¥åŠé‡å®šå‘æ“ä½œã€‚HTTP ä¸»è¦æœ‰å¦‚ä¸‹ä¸è¶³ï¼š

- é€šä¿¡ä½¿ç”¨æ˜æ–‡ï¼ˆä¸åŠ å¯†ï¼‰ï¼Œå†…å®¹å¯èƒ½ä¼šè¢«çªƒå¬ï¼›
- ä¸éªŒè¯é€šä¿¡æ–¹çš„èº«ä»½ï¼Œå› æ­¤æœ‰å¯èƒ½é­é‡ä¼ªè£…ï¼›
- æ— æ³•è¯æ˜æŠ¥æ–‡çš„å®Œæ•´æ€§ï¼Œæ‰€ä»¥æœ‰å¯èƒ½å·²é­ç¯¡æ”¹ç­‰ã€‚

ä¸­é—´äººå¯ä»¥åŠ«æŒ HTTP è¯·æ±‚å¹¶ç¯¡æ”¹å“åº”ï¼Œé˜»æ­¢å»ºç«‹ HTTPS è¿æ¥ï¼Œè·³è½¬åˆ°é’“é±¼ç½‘ç«™ç­‰ã€‚

å¯ä»¥æƒ³è§ï¼Œå¯¹äºä½¿ç”¨ HTTPS åè®®çš„æœåŠ¡å™¨ï¼Œå¦‚æœèƒ½ä»ç¬¬ä¸€æ¬¡å¼€å§‹å°±ç›´æ¥ä»¥ HTTPS åè®®å»ºç«‹è¿æ¥ï¼Œè·³è¿‡ HTTP + 301 é‡å®šå‘çš„æ­¥éª¤ï¼Œä¾¿å¯ä»¥é¿å…è¿™ä¸ªæ½œåœ¨é£é™©äº†ã€‚é‚£ä¹ˆï¼Œæµè§ˆå™¨è¯¥å¦‚ä½•çŸ¥é“å¯¹äºå“ªäº›ç½‘ç«™åº”è¯¥ä½¿ç”¨ HTTP åè®®ï¼Œå“ªäº›ç½‘ç«™åº”è¯¥å»ºç«‹ HTTPS è¯·æ±‚å‘¢ï¼Ÿ

è¿™å°±ä¸å¾—ä¸æåˆ° **HSTS**ï¼ˆHTTP Strict-Transport-Securityï¼Œå³ HTTP ä¸¥æ ¼ä¼ è¾“å®‰å…¨ï¼‰äº†ï¼Œå®ƒæ˜¯ä¸€ä¸ª Web å®‰å…¨ç­–ç•¥æœºåˆ¶ã€‚å…¶æœ€æ ¸å¿ƒçš„å®ç°ï¼Œæ˜¯ä¸€ä¸ª HTTP å“åº”å¤´ï¼Œæ­£æ˜¯å®ƒè®©æµè§ˆå™¨å¾—çŸ¥ï¼Œæ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´ï¼ˆé€šå¸¸è®¾ç½®ä¸º 1 å¹´ï¼‰ï¼Œå¯¹è¿™ä¸ªåŸŸåçš„è®¿é—®éƒ½åº”åŸºäº HTTPS åè®®ã€‚

ä¾‹å¦‚ï¼Œå½“æµè§ˆå™¨é€šè¿‡ HTTP/HTTPS åè®®è®¿é—®æŸç½‘ç«™ï¼Œè¿”å›çš„å“åº”å¤´å¯èƒ½åŒ…æ‹¬ä¸€é¡¹ï¼š

```plaintext
Strict-Transport-Security: max-age=31536000; includeSubDomains
```

æµè§ˆå™¨å°±çŸ¥é“ï¼Œåœ¨æ¥ä¸‹æ¥çš„ 31536000 ç§’ï¼ˆå³ 1 å¹´ï¼‰å†…ï¼Œå¯¹è¯¥åŸŸåï¼Œä»¥åŠå­åŸŸåï¼ˆincludeSubDomainsï¼‰çš„åç»­é€šä¿¡åº”è¯¥å¼ºåˆ¶ä½¿ç”¨ HTTPS è¿›è¡Œï¼Œç›´åˆ°è¿‡äº†æœ‰æ•ˆæœŸï¼ˆmax-ageï¼‰ä¸ºæ­¢ã€‚æ¯æ¬¡ç›¸åº”éƒ½å°†åˆ·æ–° HSTS æœ‰æ•ˆæœŸï¼›å¦‚æœè¿‡äº†æœ‰æ•ˆæœŸï¼Œåªè¦è¿›è¡Œä¸€æ¬¡æ–°çš„é€šä¿¡ï¼Œåˆä¼šå¼€å¯ä¸€å¹´çš„ HSTS æœ‰æ•ˆæœŸã€‚

### HSTS åŠ å¼ºæµè§ˆå™¨è¿æ¥ä¿æŠ¤

åœ¨ HSTS å‡ºç°ä»¥å‰ï¼Œå½“æµè§ˆå™¨å‘ç°å½“å‰ç½‘ç«™çš„è¯ä¹¦å‡ºç°é”™è¯¯ï¼Œæˆ–æµè§ˆå™¨ä¸æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ä¸å®‰å…¨ï¼Œæˆ–æ— æ³•å»ºç«‹ HTTPS è¿æ¥æ—¶ï¼Œæµè§ˆå™¨ä¼šå‘Šè­¦ç”¨æˆ·ï¼Œä½†åˆå…è®¸ç”¨æˆ·ç»§ç»­ä¸å®‰å…¨çš„è®¿é—®ã€‚

ä»ç†è®ºä¸Šæ¥è¯´ï¼Œå½“å‡ºç°æ­¤ç±»å‘Šè­¦æ—¶ï¼Œç”¨æˆ·åº”è¯¥æé«˜è­¦æƒ•ï¼Œç»ˆæ­¢åç»­çš„æ“ä½œã€‚ç„¶åç°å®æ˜¯ï¼Œç»å¤§å¤šæ•°ç”¨æˆ·å³ä½¿é‡åˆ°è¿™æ ·çš„å‘Šè­¦ï¼Œä¹Ÿä»ä¼šç»§ç»­è®¿é—®ã€‚

HSTS çš„å‡ºç°ä½¿å¾—äº‹æƒ…å‡ºç°äº†è½¬æœºã€‚å¯¹äºå¯ç”¨äº† HSTS ä¿æŠ¤çš„ç½‘ç«™ï¼Œå¦‚æœæµè§ˆå™¨å‘ç°è¿æ¥ä¸å®‰å…¨ï¼Œå®ƒå°†ä»…ä»…å‘Šè­¦ç”¨æˆ·ï¼Œ**ä¸å†**æä¾›ç»§ç»­è®¿é—®çš„é€‰æ‹©ï¼Œè¿›è€Œé¿å…åç»­çš„å®‰å…¨é—®é¢˜ã€‚

### HSTS çš„ Preload List æœºåˆ¶

å¾ˆå®¹æ˜“å‘ç°ï¼Œåœ¨ç¬¬ä¸€æ¬¡é€šè¿‡ URL è®¿é—®ç½‘ç«™æ—¶ï¼ˆæˆ–æµè§ˆå™¨æ²¡æœ‰å½“å‰ç½‘ç«™çš„ HSTS ä¿¡æ¯æ—¶ï¼‰ï¼Œä»ä¼šé»˜è®¤ä½¿ç”¨æ˜æ–‡çš„ HTTP åè®®è¿›è¡Œè¯·æ±‚ï¼Œç„¶åé‡å®šå‘åˆ‡æ¢åˆ° HTTPSï¼Œå¹¶åˆ·æ–°æµè§ˆå™¨ä¸­çš„ HSTS ä¿¡æ¯ã€‚è¿™æ ·ï¼Œç”¨æˆ·è¿˜æ˜¯æœ‰å—åˆ°ä¸­é—´äººæ”»å‡»çš„é£é™©ã€‚

é’ˆå¯¹è¿™ç§æƒ…å†µï¼ŒHSTS çš„åº”å¯¹æ–¹æ³•æ˜¯ï¼šåœ¨æµè§ˆå™¨ä¸­å†…ç½®ä¸€ä¸ªåˆ—è¡¨ï¼Œå³ Preload Listï¼Œåœ¨è¿™ä¸ªåˆ—è¡¨ä¸­çš„åŸŸåï¼Œæ— è®ºä½•ç§æƒ…å†µï¼Œæµè§ˆå™¨å°†**åªä½¿ç”¨** HTTPS å‘èµ·è¿æ¥ã€‚

è¿™ä¸ªåˆ—è¡¨ç”± Google Chromium ç»´æŠ¤ã€‚

### åŠ å…¥åˆ° HSTS Preload List

ä¸ºäº†åŠ å…¥åˆ°æ­¤åˆ—è¡¨ï¼Œæ‚¨çš„ç«™ç‚¹å¿…é¡»æ»¡è¶³ä»¥ä¸‹éœ€æ±‚ï¼š

1. æä¾›æœ‰æ•ˆçš„è¯ä¹¦ã€‚
2. å¦‚æœç›‘å¬äº† 80 ç«¯å£ï¼Œåˆ™éœ€è¦åœ¨åŒä¸€ä¸»æœºä¸Šä» HTTP é‡å®šå‘åˆ° HTTPSã€‚
3. ä¸ºæ‰€æœ‰å­åŸŸåæä¾› HTTPS æœåŠ¡ã€‚
4. åœ¨æ ¹åŸŸåçš„ HTTP å“åº”å¤´ä¸­æ·»åŠ  HSTS headerã€‚

æ‚¨å¯ä»¥åœ¨ [HSTS Preload List å®˜ç½‘](https://hstspreload.org/)æäº¤ç”³è¯·ï¼Œæˆ–æ˜¯äº†è§£æ›´å¤šç›¸å…³å†…å®¹ã€‚

## é€šè¿‡ DNS è·å– IP åœ°å€

TCP/IP æ˜¯èƒ½å¤Ÿåœ¨å¤šä¸ªä¸åŒç½‘ç»œé—´å®ç°ä¿¡æ¯ä¼ è¾“çš„**åè®®ç°‡**ï¼Œå®ƒä¸ä»…ä»…æŒ‡çš„æ˜¯ TCP å’Œ IP ä¸¤ä¸ªåè®®ï¼Œè€Œæ˜¯æŒ‡ä¸€ä¸ªç”± HTTPã€HTTPSã€FTPã€SMTPã€TCPã€UDP å’Œ IP ç­‰åè®®æ„æˆçš„åè®®ç°‡ã€‚TCP/IP å®šä¹‰äº†ç”µå­è®¾å¤‡å¦‚ä½•è¿å…¥å› ç‰¹ç½‘ï¼Œä»¥åŠæ•°æ®å¦‚ä½•åœ¨å®ƒä»¬ä¹‹é—´ä¼ è¾“çš„æ ‡å‡†ã€‚

åœ¨ TCP/IP æ¦‚å¿µå±‚æ¨¡å‹ä¸­ï¼Œè®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„è‡ªä¸Šè€Œä¸‹åˆ†æˆäº†åº”ç”¨å±‚ã€ä¼ è¾“å±‚ã€ç½‘ç»œå±‚å’Œé“¾è·¯å±‚ã€‚å…¶ä¸­ï¼ŒHTTP åè®®å±äºåº”ç”¨å±‚ã€‚å½“å®¢æˆ·ç«¯å‘å‡º HTTP è¯·æ±‚åï¼ŒæŠ¥æ–‡æ¥ä¸‹æ¥å°†æ¥åˆ°ä¼ è¾“å±‚å’Œç½‘ç»œå±‚è¿›è¡Œå¤„ç†ã€‚

æµè§ˆå™¨ä¼šéšæœºé€‰ç”¨ä¸€ä¸ªå¤§äº 1023ï¼ˆä¸” {&quot;&lt;&quot;}= 65535ï¼‰çš„ç«¯å£å·ï¼Œä½œä¸ºå½“å‰é¡µé¢é€šè®¯ä½¿ç”¨çš„ç«¯å£ï¼Œä»¥åŠä¼ è¾“å±‚çš„ TCP åè®®å¤´çš„ Source Port éƒ¨åˆ†ï¼Œè¿™å¾ˆå®¹æ˜“å®ç°ã€‚

ä½†é—®é¢˜æ˜¯ï¼Œè¿è¾“å±‚çš„ IP åè®®éœ€è¦**ç›®æ ‡ç½‘ç«™çš„ IP åœ°å€**æ‰èƒ½å·¥ä½œï¼Œè€Œç°åœ¨æµè§ˆå™¨åªæœ‰ `https://lolipopj.github.io` è¿™ä¸ª URL é“¾æ¥ï¼Œå®ƒå®Œå…¨æ— æ³•ç†è§£ã€‚

å› æ­¤ï¼Œæµè§ˆå™¨å°†é¦–å…ˆè”ç³»**åŸŸåç³»ç»Ÿ DNS**ï¼ˆDomain Name Systemï¼‰ï¼Œä¸€ä¸ªå°†åŸŸåå’Œ IP åœ°å€ç›¸äº’æ˜ å°„çš„åˆ†å¸ƒå¼æ•°æ®åº“ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ DNS æ¥æŸ¥è¯¢ä¸€ä¸² URL é“¾æ¥æ‰€å¯¹åº”çš„ IP åœ°å€ã€‚

DNS ç”±å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸¤éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­ï¼Œå®¢æˆ·ç«¯å‘èµ·æŸ¥è¯¢è¯·æ±‚ï¼Œä¾‹å¦‚æŸ¥è¯¢åŸŸåçš„ IP åœ°å€ï¼ŒæœåŠ¡ç«¯åˆ™è´Ÿè´£å›ç­”åŸŸåçš„çœŸæ­£ IP åœ°å€ã€‚é‚£ä¹ˆç°åœ¨ï¼ŒDNS å®¢æˆ·ç«¯å‘èµ·æŸ¥è¯¢ `github.io` åŸŸå IP åœ°å€çš„è¯·æ±‚ï¼Œå¯èƒ½ç»è¿‡å¦‚ä¸‹æ­¥éª¤ï¼š

1. é¦–å…ˆæ£€æŸ¥æœ¬æœºçš„ DNS ç¼“å­˜ï¼Œæ²¡æœ‰è¯¥åŸŸåçš„ IP åœ°å€ä¿¡æ¯ï¼
2. å†æŸ¥çœ‹æœ¬åœ°ç¡¬ç›˜ä¸­çš„ Host æ–‡ä»¶ï¼Œä¹Ÿæ²¡æœ‰ï¼
3. è¯·æ±‚æœ¬åœ°åŸŸåæœåŠ¡å™¨æˆ–å…¬å…±åŸŸåæœåŠ¡å™¨è®°å½•çš„ä¿¡æ¯ã€‚è¿™é‡Œä¹Ÿæ²¡æœ‰ï¼
4. æ­¤æ—¶ï¼Œæœ¬åœ°åŸŸåæœåŠ¡å™¨æˆ–å…¬å…±åŸŸåæœåŠ¡å™¨ä¼šå°†æŸ¥è¯¢è¯·æ±‚å‘é€ç»™**æ ¹åŸŸåæœåŠ¡å™¨**ï¼ˆRoot name serverï¼‰ã€‚æ ¹åŸŸåæœåŠ¡å™¨ä¼šæ ¹æ®è¯·æ±‚çš„ URLï¼Œå°†å…¶å¯¹åº”çš„**é¡¶çº§åŸŸåæœåŠ¡å™¨**ï¼ˆTop-level domain serverï¼‰çš„åœ°å€è¿”å›ç»™æœ¬åœ°åŸŸåæœåŠ¡å™¨æˆ–å…¬å…±åŸŸåæœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼Œè¿™é‡Œæˆ‘ä»¬æŸ¥è¯¢ç½‘å€çš„é¡¶çº§åŸŸåæ˜¯ `.io`ï¼Œåˆ™å°†æ­¤åŸŸåå¯¹åº”çš„é¡¶çº§åŸŸåæœåŠ¡å™¨çš„ IP åœ°å€è¿”å›å›æ¥ã€‚
5. æ¥ç€ï¼Œæœ¬åœ°åŸŸåæœåŠ¡å™¨æˆ–å…¬å…±åŸŸåæœåŠ¡å™¨ä¼šå°†æŸ¥è¯¢è¯·æ±‚å‘é€ç»™åˆšåˆšå¾—åˆ°çš„é¡¶çº§åŸŸåæœåŠ¡å™¨ã€‚é¡¶çº§åŸŸåæœåŠ¡å™¨å°†è¿”å›ç®¡ç† `github.io` çš„**æƒå¨åŸŸåæœåŠ¡å™¨**çš„ IP åœ°å€ï¼Œä¾‹å¦‚ `185.199.110.153`ã€‚ç»§ç»­è¯·æ±‚æ­¤æƒå¨åŸŸåæœåŠ¡å™¨ï¼Œå¦‚æœå¾—çŸ¥ `lolipopj.github.io` ä¸ºæ­¤åŸŸåä¸‹çš„ A è®°å½•ï¼Œé‚£ä¹ˆæ­¤ IP åœ°å€å³ä¸ºæ‰€æ±‚ã€‚
6. æŸ¥è¯¢çš„ IP åœ°å€ç»“æœå°†ç¼“å­˜åˆ°æœ¬æœºä»¥åŠæœ¬åœ°åŸŸåæœåŠ¡å™¨æˆ–å…¬å…±åŸŸåæœåŠ¡å™¨ï¼Œç”¨æˆ·ä¸‹æ¬¡æŸ¥è¯¢æ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œå¤§å‹ç½‘ç«™éƒ½ä¼šè¿”å› CNAME è®°å½•ï¼Œä¼ é€’ç»™[å…¨å±€æµé‡ç®¡ç† GTM æœåŠ¡](#å…¨å±€æµé‡ç®¡ç†-gtm)ï¼Œé€’å½’è§£æå™¨å°†æ‰§è¡Œå…¨æ–°çš„ DNS æŸ¥æ‰¾ã€‚é€šè¿‡ GTM æœåŠ¡çš„è´Ÿè½½å‡è¡¡æœºåˆ¶ç­‰ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·æ‰¾åˆ°æœ€é€‚åˆè‡ªå·±çš„è®¿é—®çš„æœåŠ¡å™¨ IP åœ°å€ï¼›æ­¤å¤–ï¼Œå¤§å¤šæ•°ç½‘ç«™ä¼šåš CDN ç¼“å­˜ï¼ŒGTM æœåŠ¡ä¹Ÿå¯ä»¥å¸®åŠ©ç”¨æˆ·æ‰¾åˆ°æœ€é€‚åˆè‡ªå·±çš„ CDN ç¼“å­˜æœåŠ¡å™¨ã€‚

ä½†æ— è®ºå¦‚ä½•ï¼Œè€å¤©çˆ·ï¼Œæµè§ˆå™¨å¯ç®—æ˜¯çŸ¥é“æˆ‘åšå®¢çš„ IP åœ°å€äº†ã€‚

### é€’å½’è§£æå™¨

ä¹Ÿç§°ä¸º â€œDNS è§£æå™¨â€ã€‚

é€’å½’è§£æå™¨æ˜¯ DNS æŸ¥è¯¢ä¸­çš„ç¬¬ä¸€ç«™ã€‚é€’å½’è§£æå™¨ä½œä¸ºå®¢æˆ·ç«¯ä¸ DNS åŸŸåæœåŠ¡å™¨çš„ä¸­é—´äººã€‚ä» Web å®¢æˆ·ç«¯æ”¶åˆ° DNS æŸ¥è¯¢åï¼Œé€’å½’è§£æå™¨å°†ä½¿ç”¨ç¼“å­˜çš„æ•°æ®è¿›è¡Œå“åº”ï¼Œæˆ–è€…å°†å‘æ ¹åŸŸåæœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œæ¥ç€å‘é¡¶çº§åŸŸåæœåŠ¡å™¨å‘é€å¦ä¸€ä¸ªè¯·æ±‚ï¼Œç„¶åå‘æƒå¨åŸŸåæœåŠ¡å™¨å‘é€æœ€åä¸€ä¸ªè¯·æ±‚ã€‚æ”¶åˆ°æ¥è‡ªåŒ…å«å·²è¯·æ±‚ IP åœ°å€çš„æƒå¨åŸŸåæœåŠ¡å™¨çš„å“åº”åï¼Œé€’å½’è§£æå™¨å°†å‘å®¢æˆ·ç«¯å‘é€å“åº”ã€‚

å¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨ä»–ä»¬çš„ ISP æä¾›çš„é€’å½’è§£æå™¨ï¼Œå³æœ¬åœ°åŸŸåæœåŠ¡å™¨ã€‚ä½†ä¹Ÿå¯ä»¥æŒ‡å®šå…¬å…±åŸŸåæœåŠ¡å™¨ä½œä¸ºé€’å½’è§£æå™¨ï¼Œå¦‚ Google çš„ `8.8.8.8` æˆ– Cloudflare çš„ `1.1.1.1` ç­‰ã€‚

### æ ¹åŸŸåæœåŠ¡å™¨

- [ã€Œæ ¹åŸŸåçš„çŸ¥è¯†ã€](https://www.ruanyifeng.com/blog/2018/05/root-domain.html)ï¼Œ2018-05-09

æ ¹åŸŸåæœåŠ¡å™¨ä¸­è®°å½•äº†å„ä¸ªé¡¶çº§åŸŸåæœåŠ¡å™¨çš„ IP åœ°å€ä¿¡æ¯ã€‚

ç”±äºæ—©æœŸçš„ DNS æŸ¥è¯¢ç»“æœæ˜¯ä¸€ä¸ª 512 å­—èŠ‚çš„ UDP æ•°æ®åŒ…ï¼Œè¿™ä¸ªåŒ…æœ€å¤šå®¹çº³ 13 ä¸ªæœåŠ¡å™¨çš„åœ°å€ï¼Œå› æ­¤è§„å®šå…¨ä¸–ç•Œæœ‰ 13 å°æ ¹åŸŸåæœåŠ¡å™¨ï¼Œç¼–å·ä» `a.root-servers.net` åˆ° `m.root-servers.net`ã€‚

ä¸ºäº†ä¿è¯æ ¹åŸŸåæœåŠ¡å™¨çš„å¯ç”¨æ€§ï¼Œæ¯å°æœåŠ¡å™¨åˆæœ‰å¤šä¸ªèŠ‚ç‚¹ã€‚æ ¹æ®[æ­¤ç½‘ç«™](https://root-servers.org/)çš„ç»Ÿè®¡ï¼Œæˆªæ­¢ 2021 å¹´ 07 æœˆ 12 æ—¥ï¼Œå…¨çƒä¸€å…±æœ‰ 1403 å°æ ¹åŸŸåæœåŠ¡å™¨å®ä¾‹ã€‚

å½“éœ€è¦é€šè¿‡æ ¹åŸŸåæœåŠ¡å™¨æŸ¥è¯¢é¡¶çº§åŸŸåæœåŠ¡å™¨æ—¶ï¼Œè¿›è¡Œè¯·æ±‚çš„ DNS æœåŠ¡å™¨ä¼šå‘è¿™ 13 å°æœåŠ¡å™¨**åŒæ—¶**å‘å‡ºè¯·æ±‚ï¼Œå“ªä¸€ä¸ªè¿”å›çš„ä¿¡æ¯å…ˆåˆ°è¾¾ï¼Œåˆ™ä½¿ç”¨å“ªä¸€ä¸ªæŸ¥è¯¢å¾—åˆ°çš„ç»“æœã€‚

### é¡¶çº§åŸŸåæœåŠ¡å™¨

ä¹Ÿç§°ä¸º â€œTLD åŸŸåæœåŠ¡å™¨â€ã€‚

é¡¶çº§åŸŸåæœåŠ¡å™¨è´Ÿè´£ç®¡ç†åœ¨è¯¥é¡¶çº§åŸŸåä¸‹æ³¨å†Œçš„æ‰€æœ‰äºŒçº§åŸŸåã€‚æˆ–è€…è¯´ï¼Œé¡¶çº§åŸŸåæœåŠ¡å™¨ä¸­è®°å½•äº†å±äºå®ƒçš„å„ä¸ªæƒå¨åŸŸåæœåŠ¡å™¨çš„ IP åœ°å€ã€‚

### æƒå¨åŸŸåæœåŠ¡å™¨

æƒå¨åŸŸåæœåŠ¡å™¨æ˜¯ä¿å­˜ DNS åç§°è®°å½•ï¼ˆåŒ…æ‹¬ Aã€AAAA å’Œ CNAMEï¼‰çš„æœåŠ¡å™¨ã€‚

æƒå¨åŸŸåæœåŠ¡å™¨åŒ…å«ç‰¹å®šäºå…¶æœåŠ¡åŸŸåçš„ä¿¡æ¯ã€‚å®ƒå¯ä¸ºé€’å½’è§£æå™¨æä¾›åœ¨ DNS A è®°å½•ä¸­æ‰¾åˆ°çš„æœåŠ¡å™¨çš„ IP åœ°å€ï¼›æˆ–è€…å¦‚æœè¯¥åŸŸå…·æœ‰ CNAME è®°å½•ï¼Œå®ƒå°†ä¸ºé€’å½’è§£æå™¨æä¾›ä¸€ä¸ªåˆ«ååŸŸï¼Œè¿™æ—¶é€’å½’è§£æå™¨å°†å¿…é¡»æ‰§è¡Œå…¨æ–° DNS æŸ¥æ‰¾ï¼Œä»¥ä¾¿ä»æƒå¨åŸŸåæœåŠ¡å™¨è·å–è®°å½•ï¼ˆé€šå¸¸ä¸ºåŒ…å« IP åœ°å€çš„ A è®°å½•ï¼‰ã€‚

### DNS æ”¯æŒ TCP å’Œ UDP åè®®

- [ã€Œä¸ºä»€ä¹ˆ DNS ä½¿ç”¨ UDP åè®®ã€](https://draveness.me/whys-the-design-dns-udp-tcp/)

&gt; å®é™…ä¸Šï¼ŒDNS ä¸ä»…ä½¿ç”¨äº† UDP åè®®ï¼Œä¹Ÿä½¿ç”¨äº† TCP åè®®ï¼Œä¸è¿‡åœ¨å…·ä½“ä»‹ç»ä»Šå¤©çš„é—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦å¯¹ DNS åè®®è¿›è¡Œç®€å•çš„ä»‹ç»ï¼šDNS æŸ¥è¯¢çš„ç±»å‹ä¸æ­¢åŒ…å« A è®°å½•ã€CNAME è®°å½•ç­‰å¸¸è§æŸ¥è¯¢ï¼Œè¿˜åŒ…å« AXFR ç±»å‹çš„ç‰¹æ®ŠæŸ¥è¯¢ï¼Œè¿™ç§ç‰¹æ®ŠæŸ¥è¯¢ä¸»è¦ç”¨äº **DNS åŒºåŸŸä¼ è¾“**ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯åœ¨å¤šä¸ªå‘½åæœåŠ¡å™¨ä¹‹é—´å¿«é€Ÿè¿ç§»è®°å½•ï¼Œç”±äºæŸ¥è¯¢è¿”å›çš„å“åº”æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ä¼šä½¿ç”¨ TCP åè®®æ¥ä¼ è¾“æ•°æ®åŒ…ã€‚
&gt; â€¦â€¦
&gt; æˆ‘ä»¬å¯ä»¥ç®€å•æ€»ç»“ä¸€ä¸‹ DNS çš„å‘å±•å²ï¼Œ1987 å¹´çš„ RFC1034 å’Œ RFC1035 å®šä¹‰äº†æœ€åˆç‰ˆæœ¬çš„ DNS åè®®ï¼Œåˆšè¢«è®¾è®¡å‡ºæ¥çš„ DNS å°±ä¼šåŒæ—¶ä½¿ç”¨ UDP å’Œ TCP åè®®ï¼Œå¯¹äºç»å¤§å¤šæ•°çš„ DNS æŸ¥è¯¢æ¥è¯´éƒ½ä¼šä½¿ç”¨ UDP æ•°æ®æŠ¥è¿›è¡Œä¼ è¾“ï¼ŒTCP åè®®åªä¼šåœ¨åŒºåŸŸä¼ è¾“çš„åœºæ™¯ä¸­ä½¿ç”¨ï¼Œå…¶ä¸­ UDP æ•°æ®åŒ…åªä¼šä¼ è¾“æœ€å¤§ 512 å­—èŠ‚çš„æ•°æ®ï¼Œå¤šä½™çš„ä¼šè¢«æˆªæ–­ï¼›ä¸¤å¹´åå‘å¸ƒçš„ RFC1123 é¢„æµ‹äº† DNS è®°å½•ä¸­å­˜å‚¨çš„æ•°æ®ä¼šè¶Šæ¥è¶Šå¤šï¼ŒåŒæ—¶ä¹Ÿç¬¬ä¸€æ¬¡æ˜¾å¼çš„æŒ‡å‡ºäº†**å‘ç° UDP åŒ…è¢«æˆªæ–­æ—¶åº”è¯¥é€šè¿‡ TCP åè®®é‡è¯•**ã€‚
&gt; è¿‡äº†å°†è¿‘ 20 å¹´çš„æ—¶é—´ï¼Œç”±äºäº’è”ç½‘çš„å‘å±•ï¼Œäººä»¬å‘ç° IPv4 å·²ç»ä¸å¤Ÿåˆ†é…äº†ï¼Œæ‰€ä»¥**å¼•å…¥äº†æ›´é•¿çš„ IPv6**ï¼ŒDNS ä¹Ÿåœ¨ 2003 å¹´å‘å¸ƒçš„ RFC3596 ä¸­è¿›è¡Œäº†åè®®ä¸Šçš„æ”¯æŒï¼›éšåå‘å¸ƒçš„ RFC5011 å’Œ RFC6376 å¢åŠ äº†åœ¨é‰´æƒå’Œå®‰å…¨æ–¹é¢çš„æ”¯æŒï¼Œä½†æ˜¯ä¹Ÿå¸¦æ¥äº†å·¨å¤§çš„ DNS è®°å½•ï¼ŒUDP æ•°æ®åŒ…è¢«æˆªæ–­å˜å¾—éå¸¸å¸¸è§ã€‚
&gt; RFC6891 æä¾›çš„ DNS æ‰©å±•æœºåˆ¶èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³å¤§æ•°æ®åŒ…è¢«æˆªæ–­çš„é—®é¢˜ï¼Œå‡å°‘äº†ä½¿ç”¨ TCP åè®®è¿›è¡Œé‡è¯•çš„éœ€è¦ï¼Œä½†æ˜¯ç”±äº**æœ€å¤§ä¼ è¾“å•å…ƒçš„é™åˆ¶**ï¼Œè¿™å¹¶ä¸èƒ½è§£å†³æ‰€æœ‰é—®é¢˜ã€‚
&gt; DNS å‡ºç°ä¹‹åçš„ 30 å¤šå¹´ï¼ŒRFC7766 æ‰ç»ˆäºæå‡ºäº†ä½¿ç”¨ TCP åè®®ä½œä¸ºä¸»è¦åè®®æ¥è§£å†³ UDP æ— æ³•è§£å†³çš„é—®é¢˜ï¼ŒTCP åè®®ä¹Ÿä¸å†åªæ˜¯ä¸€ç§é‡è¯•æ—¶ä½¿ç”¨çš„æœºåˆ¶ï¼Œéšåå‡ºç°çš„ DNS over TLS å’Œ DNS over HTTP ä¹Ÿéƒ½æ˜¯å¯¹ DNS åè®®çš„ä¸€ç§è¡¥å……ã€‚

### å…¨å±€æµé‡ç®¡ç† GTM

- [ã€Œå…¨å±€æµé‡ç®¡ç†äº§å“åŸç†ã€](https://help.aliyun.com/document_detail/189591.html?spm=a2c4g.11186623.6.640.3198229dgDSHXU)ï¼Œ2020-12-11ï¼Œé˜¿é‡Œäº‘

&gt; å…¨å±€æµé‡ç®¡ç†ï¼ˆGTMï¼‰æ”¯æŒç”¨æˆ·å°±è¿‘æ¥å…¥ã€é«˜å¹¶å‘è´Ÿè½½å‡è¡¡ã€å¥åº·æ£€æŸ¥ä¸æ•…éšœåˆ‡æ¢ï¼Œå¯ä»¥å¸®åŠ©ä¼ä¸šåœ¨çŸ­æ—¶é—´å†…æ„å»ºåŒåŸå¤šæ´»ä¸å¼‚åœ°ç¾å¤‡çš„å®¹ç¾æ¶æ„ã€‚
&gt; GTM å±äº DNS çº§åˆ«çš„æœåŠ¡ï¼Œä½¿ç”¨ DNS å‘å‘ç”¨æˆ·è¿”å›ç‰¹å®šçš„æœåŠ¡åœ°å€ï¼Œç„¶åå®¢æˆ·ç«¯ç”¨æˆ·ç›´æ¥è¿æ¥åˆ°æœåŠ¡åœ°å€ã€‚

å½“é€’å½’è§£æå™¨æ¥æ”¶åˆ°å“åº”çš„ CNAME ç»“æœåï¼Œä¼šå†æ‰§è¡Œä¸€é DNS æŸ¥æ‰¾è¿‡ç¨‹ï¼Œå¾—åˆ° GTM æœåŠ¡å™¨çš„ IP åœ°å€ã€‚é€’å½’è§£æå™¨å‘ GTM æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼ŒGTM æ”¶åˆ°è¯·æ±‚åï¼Œä¼šæ ¹æ®è¿è¡Œæœºåˆ¶å’Œé¢„é…ç½®ç­–ç•¥å‘é€’å½’è§£æå™¨å“åº”æœ€ç»ˆåº”ç”¨æœåŠ¡çš„ IP åœ°å€ã€‚

é€’å½’è§£æå™¨å°†æœ€åä¸€æ¬¡æŸ¥è¯¢å¾—åˆ°çš„ IP åœ°å€ä½œä¸ºè®¿é—® URL çš„æœ€ç»ˆåœ°å€ï¼Œè¿”å›ç»™æµè§ˆå™¨ï¼ŒåŒæ—¶ç¼“å­˜åˆ°æœ¬åœ°ã€‚æµè§ˆå™¨ä½¿ç”¨æ­¤ IP åœ°å€ç›´æ¥å‘åº”ç”¨æœåŠ¡å™¨å‘èµ·ç½‘ç»œè¿æ¥ï¼Œå¼€å§‹è¿›è¡Œä¸šåŠ¡é€šä¿¡ã€‚

## é€šè¿‡ ARP è·å– MAC åœ°å€

- [ã€Œåœ°å€è§£æåè®®ã€](https://zh.wikipedia.org/wiki/%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE)ï¼ŒWikipedia
- [ã€Œå›¾è§£ ARP åè®®ï¼ˆå››ï¼‰ä»£ç† ARPï¼šå–„æ„çš„æ¬ºéª—ã€](https://blog.51cto.com/chenxinjie/1961255)ï¼Œ2017-09-01

ç»è¿‡ä¼ è¾“å±‚å’Œç½‘ç»œå±‚å°è£…åçš„åŒ…å«æœ‰ HTTP æŠ¥æ–‡çš„æ•°æ®åŒ…ï¼Œç°åœ¨æ¥åˆ°äº†é“¾è·¯å±‚ã€‚åœ¨è¿™é‡Œï¼Œè¿˜å°†ä¸ºå®ƒåŠ ä¸Š MAC å¤´éƒ¨ã€‚

&gt; åœ¨**ä»¥å¤ªç½‘åè®®**ï¼ˆåœ¨ç‚¹å¯¹ç‚¹åè®® PPP ä¸­ï¼ŒçŸ¥é“ IP åœ°å€å°±å¯ä»¥è¿›è¡Œé€šä¿¡ï¼›æœ¬æ–‡çš„è®¨è®ºåŸºäºä»¥å¤ªç½‘åè®®ï¼‰ä¸­è§„å®šï¼ŒåŒä¸€å±€åŸŸç½‘ä¸­çš„ä¸€å°ä¸»æœºè¦å’Œå¦ä¸€å°ä¸»æœºè¿›è¡Œç›´æ¥é€šä¿¡ï¼Œå¿…é¡»è¦çŸ¥é“ç›®æ ‡ä¸»æœºçš„ MAC åœ°å€â€¦â€¦å¦å¤–ï¼Œå½“å‘é€ä¸»æœºå’Œç›®çš„ä¸»æœºä¸åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ä¸­æ—¶ï¼Œå³ä¾¿çŸ¥é“å¯¹æ–¹çš„ MAC åœ°å€ï¼Œä¸¤è€…ä¹Ÿä¸èƒ½ç›´æ¥é€šä¿¡ï¼Œå¿…é¡»ç»è¿‡**è·¯ç”±è½¬å‘**æ‰å¯ä»¥ã€‚

å¦‚ä½•å°†å·²çŸ¥çš„ç›®æ ‡ä¸»æœºçš„ IP åœ°å€ï¼Œè½¬æ¢ä¸ºæ•°æ®é“¾è·¯ä¼ è¾“éœ€è¦çš„ MAC åœ°å€ï¼Ÿåœ¨ IPv4 ä¸­ï¼Œè¿™é€šè¿‡åœ°å€è§£æåè®® ARPï¼ˆAddress Resolution Protocolï¼‰å®ç°ï¼›åœ¨ IPv6 ä¸­ï¼Œä½¿ç”¨é‚»å±…å‘ç°åè®® NDPï¼ˆNeighbor Discovery Protocolï¼‰ä»£æ›¿ ARPã€‚

ä»¥ ARP åè®®ä¸ºä¾‹ï¼Œå®ƒé€šè¿‡ ARP è¯·æ±‚å’Œ ARP å“åº”æŠ¥æ–‡ç¡®å®š MAC åœ°å€ã€‚ARP è¯·æ±‚æŠ¥æ–‡æ˜¯ä¸€ç§å¹¿æ’­æŠ¥æ–‡ï¼Œ**å±€åŸŸç½‘å†…**çš„æ‰€æœ‰ä¸»æœºéƒ½å¯ä»¥æ”¶åˆ°ã€‚å½“æŸä¸€ä¸ªä¸»æœºå‘ç°è¯·æ±‚æŠ¥æ–‡ä¸­çš„ IP åœ°å€ä¸ºè‡ªå·±çš„ IP åœ°å€ï¼Œå°±ä¼šå‘é€ ARP å“åº”æŠ¥æ–‡ç»™å‘å‡ºè¯·æ±‚æŠ¥æ–‡çš„ä¸»æœºã€‚

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸ä¸åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘çš„ä¸»æœºé€šä¿¡ï¼Œä½†ç”±äºæ¯ä¸ªç½‘æ®µéƒ½æ˜¯ç‹¬ç«‹çš„å¹¿æ’­åŸŸï¼Œæ²¡æ³•ç›´æ¥å‘äº’è”ç½‘ä¸Šçš„å…¶å®ƒä¸»æœºå‘é€å¹¿æ’­æŠ¥æ–‡ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿç½‘å…³è®¾å¤‡å°±åœ¨è¿™é‡Œå¤§æ˜¾èº«æ‰‹äº†ã€‚

å½“ä¸»æœº**å·²è®¾ç½®ç½‘å…³**æ—¶ï¼Œä¸»æœºè®¾ç½®çš„ç½‘å…³è®¾å¤‡å°†æ¥æ”¶åˆ° ARP è¯·æ±‚æŠ¥æ–‡ï¼Œä»¥è·¯ç”±å™¨ä¸ºä¾‹ï¼šè·¯ç”±å™¨å‘ç° ARP è¯·æ±‚æŠ¥æ–‡ä¸­çš„ IP åœ°å€ä¸å±äºå½“å‰å±€åŸŸç½‘ï¼Œå°±æŠŠè‡ªå·±çš„ MAC åœ°å€å“åº”ç»™è¯·æ±‚ä¸»æœºã€‚åç»­è¯·æ±‚ä¸»æœºç›´æ¥ä½¿ç”¨è¿™ä¸ª MAC åœ°å€ï¼Œå°†æ•°æ®åŒ…ä¼ è¾“ç»™è·¯ç”±å™¨ã€‚è€Œæ•°æ®åŒ…é€šè¿‡è·¯ç”±å™¨çš„**è·¯ç”±è½¬å‘**åŠŸèƒ½ï¼Œæœ€ç»ˆé¡ºåˆ©æŠµè¾¾äº’è”ç½‘ä¸Šå¯¹åº” IP åœ°å€çš„ä¸»æœºã€‚

å½“ä¸»æœº**æœªè®¾ç½®ç½‘å…³**æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ **ä»£ç† ARP**ï¼ˆARP Proxyï¼‰æœºåˆ¶ã€‚å±€åŸŸç½‘å†…çš„æ‰€æœ‰ç½‘å…³è®¾å¤‡å°†æ¥æ”¶åˆ° ARP è¯·æ±‚æŠ¥æ–‡ï¼Œè¿˜æ˜¯ä»¥è·¯ç”±å™¨ä¸ºä¾‹ï¼šè·¯ç”±å™¨å‘ç° ARP è¯·æ±‚æŠ¥æ–‡ä¸­çš„ IP åœ°å€ä¸å±äºå½“å‰å±€åŸŸç½‘ï¼Œè€Œæ˜¯å±äºè‡ªå·±**å·²çŸ¥çš„**å¦ä¸€ä¸ªç½‘æ®µä¸Šçš„æŸå°ä¸»æœºï¼Œå°±å°†è‡ªå·±ä½œä¸ºä»£ç†ï¼ŒæŠŠè‡ªå·±çš„ MAC åœ°å€å“åº”ç»™è¯·æ±‚ä¸»æœºã€‚åç»­è¯·æ±‚ä¸»æœºç›´æ¥ä½¿ç”¨è¿™ä¸ª MAC åœ°å€ï¼Œé€šè¿‡è·¯ç”±å™¨ä»£ç†ï¼Œå°±å¯ä»¥è®¿é—®åˆ°å±€åŸŸç½‘å¤–çš„ç›®æ ‡ä¸»æœºäº†ã€‚ä¸ ARP ç›¸æ¯”ï¼Œä»£ç† ARP æœ‰å¦‚ä¸‹å±€é™ï¼š

- ä»£ç† ARP éœ€è¦æœ‰ç›®æ ‡ç½‘å…³çš„ä¿¡æ¯ï¼›
- ä»£ç† ARP æ¯æ¬¡è®¿é—®æ–°çš„å¤–ç½‘åœ°å€æ—¶ï¼Œéƒ½éœ€è¦å‘é€ä¸€æ¬¡ ARP è¯·æ±‚ï¼›
- ä»£ç† ARP å—é™äºæ²¿é€”ç½‘ç»œè®¾å¤‡ã€‚ä¾‹å¦‚éƒ¨åˆ†è·¯ç”±å™¨å¯èƒ½ä¸æ”¯æŒæ­¤åŠŸèƒ½ï¼Œè€Œæ”¯æŒæ­¤åŠŸèƒ½çš„è·¯ç”±å™¨åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸€èˆ¬æ²¡æœ‰å¯ç”¨ä»£ç† ARPã€‚

åœ¨è·¨ç½‘æ®µé€šä¿¡ä¸­ï¼Œæ— è®ºä½¿ç”¨ ARP è¿˜æ˜¯ä»£ç† ARPï¼Œå‘å‡º ARP è¯·æ±‚çš„ä¸»æœºæ€»ä¼šæ”¶åˆ°ç½‘å…³çš„ MAC åœ°å€ä½œä¸ºå“åº”ã€‚

å› æ­¤ï¼Œåœ¨å®é™…ç½‘ç»œä¸­ï¼Œæ— è®ºæ˜¯å±€åŸŸç½‘å†…é€šä¿¡ï¼Œè¿˜æ˜¯è·¨ç½‘æ®µé€šä¿¡ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹è¿˜æ˜¯ä½¿ç”¨çš„æ˜¯ ARPï¼Œè€Œéä»£ç† ARPã€‚ä»£ç† ARP æ˜¯å¯¹ ARP çš„è¡¥å……ï¼Œæ˜¯ ARP çš„æ‹“å±•ä½¿ç”¨ã€‚

è¨€å½’æ­£ä¼ ï¼Œå‡å¦‚æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ IPv4 ç½‘ç»œï¼Œé€šè¿‡ ARP åè®®ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°ä¸»æœºè®¾ç½®çš„ç½‘å…³è®¾å¤‡çš„ MAC åœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬å°±é¡ºåˆ©åœ°ä¸ºæ•°æ®åŒ…æ·»åŠ äº† MAC å¤´éƒ¨ã€‚ç°åœ¨ï¼Œå®Œæ•´çš„æ•°æ®åŒ…å°±å¯ä»¥ä»ä¸»æœºä¼ è¾“åˆ°ç½‘å…³è®¾å¤‡ä¸Šï¼Œå†é©¶å…¥äº’è”ç½‘çš„å¿«è½¦é“ï¼Œæœ€ç»ˆæŠµè¾¾æœåŠ¡å™¨äº†ã€‚

### RARP å’Œ IARP

- [ã€Œå›¾è§£ ARP åè®®ï¼ˆå…­ï¼‰RARP ä¸ IARPï¼šè¢«é—å¿˜çš„å…„å¼Ÿåè®®ã€](https://zhuanlan.zhihu.com/p/29081692)ï¼Œ2017-09-05

RARP å³åå‘ ARPï¼ˆReverse ARPï¼‰ï¼ŒåŠŸèƒ½ä¸ ARP æ°å·§ç›¸åï¼Œç”¨æ¥å®ç° MAC åœ°å€åˆ° IP åœ°å€çš„æ˜ å°„ã€‚

ä¸€ä¸ªç®€å•çš„ä¾‹å­æ˜¯ï¼Œå½“ä¸€å°ä¸»æœºåˆšåˆšæ¥å…¥ç½‘ç»œï¼Œè¿™æ—¶å®ƒè¿˜æ²¡æœ‰å±€åŸŸç½‘åˆ†é…çš„å†…ç½‘ IP åœ°å€ã€‚é€šè¿‡ RARPï¼Œå®ƒå¯ä»¥å‘å±€åŸŸç½‘å‘é€å¹¿æ’­ï¼Œå¹¿æ’­åŒ…å«è‡ªå·±çš„ MAC åœ°å€ï¼Œå¦‚æœå±€åŸŸç½‘å†…æœ‰ RARP æœåŠ¡å™¨ä¸”**è®°å½•æœ‰æ­¤ MAC åœ°å€çš„æ˜ å°„ IP åœ°å€**ï¼Œé‚£ä¹ˆå®ƒå°†æ¥æ”¶åˆ° RARP å“åº”ï¼Œäºæ˜¯ä¸»æœºå°±æ‹¥æœ‰äº†è‡ªå·±çš„ IP åœ°å€ã€‚

RARP æœ‰è¿™äº›ç‰¹æ€§ï¼š

- RARP æœåŠ¡å™¨å¿…é¡»æå‰ç»‘å®š MAC åœ°å€å’Œ IP åœ°å€ã€‚å¦‚æœæ²¡æœ‰æå‰ç»‘å®šï¼Œåˆ™æœåŠ¡å™¨ä¸ä¼šå‘å›å“åº”ï¼›
- RARP æœåŠ¡å™¨åªèƒ½ç»™è¯·æ±‚çš„ä¸»æœºåˆ†é… IP åœ°å€ï¼Œä¸åŒ…æ‹¬ç½‘å…³ã€DNS ç­‰å…¶å®ƒä¿¡æ¯ã€‚

åœ¨åæ¥ï¼Œæœ‰äº†å¯åŠ¨åè®® BOOTPï¼Œåˆæœ‰äº†ç°åœ¨æœ€å¸¸ç”¨çš„[åŠ¨æ€ä¸»æœºè®¾ç½®åè®® DHCP](https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol)ã€‚

&gt; RARP æ˜¯ä¸€ç§é€å»çš„åœ°å€åˆ†é…æŠ€æœ¯ï¼Œæ˜¯ BOOTP å’Œ DHCP çš„é¼»ç¥–ï¼Œç›®å‰æˆ‘ä»¬çš„ç”µè„‘åŸºæœ¬ä¸ä¼šç”¨åˆ°è¿™ä¸ªåè®®ï¼Œåªæœ‰éƒ¨åˆ†æ— ç›˜å·¥ä½œç«™ç­‰æƒ…å†µéœ€è¦ç”¨åˆ°ã€‚

IARP å³é€†å‘ ARPï¼ˆInverse ARPï¼‰ï¼Œåœ¨å¸§ä¸­ç»§ç½‘ç»œï¼ˆå¹¿åŸŸç½‘ï¼‰ä¸­å®ç° DLCI åˆ° IP åœ°å€çš„æ˜ å°„ã€‚åœ¨å¸§ä¸­ç»§ç½‘ç»œä¸­ï¼Œå®ƒçš„åŠŸèƒ½**ç±»ä¼¼äº**ä»¥å¤ªç½‘ä¸­ MAC åœ°å€åˆ° IP åœ°å€çš„æ˜ å°„ã€‚

éšç€å¹¿åŸŸç½‘æŠ€æœ¯çš„æ›´è¿­ï¼Œå¸§ä¸­ç»§æŠ€æœ¯æ­£æ…¢æ…¢è¢«è¢«å…¶å®ƒæŠ€æœ¯æ‰€æ›¿ä»£ã€‚å› æ­¤ IARP ä½œä¸ºå¸§ä¸­ç»§æŠ€æœ¯ä¸­çš„ä¸€ç¯ï¼Œåœ¨ç°å®ä¸­çš„ä½¿ç”¨ä¹Ÿæ„ˆæ¥æ„ˆå°‘ã€‚

## ä½¿ç”¨ TLS ä¸æœåŠ¡å™¨å»ºç«‹å®‰å…¨çš„ TCP è¿æ¥

åœ¨å‘é€åŒ…å« HTTP æŠ¥æ–‡çš„æ•°æ®åŒ…ä¹‹å‰ï¼Œå®¢æˆ·ç«¯è¿˜è¦å…ˆé€šè¿‡ä¸‰æ¬¡æ¡æ‰‹ä¸æœåŠ¡å™¨å»ºç«‹ TCP è¿æ¥ï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯æ•°æ®ä¼ è¾“çš„**å¯é æ€§**ã€‚åœ¨å‰é¢ï¼Œæˆ‘ä»¬å·²ç»å¾—åˆ°äº†æœåŠ¡å™¨çš„ MAC åœ°å€ï¼Œå› æ­¤åŒ…å«å»ºç«‹ TCP è¿æ¥è¯·æ±‚æŠ¥æ–‡çš„æ•°æ®åŒ…å¯ä»¥é¡ºåˆ©å‘é€åˆ°æœåŠ¡å™¨ã€‚

1. TCP ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼Œå®¢æˆ·ç«¯ä¸»åŠ¨å‘æœåŠ¡å™¨å‘é€ TCP è¯·æ±‚æŠ¥æ–‡ã€‚è®¾ç½®å…¶é¦–éƒ¨ï¼š`SYN = 1, seq = x`ã€‚å…¶ä¸­ï¼Œx å’Œä¸‹é¢æ­¥éª¤ä¸­çš„ y ä¸ºéšæœºå€¼ã€‚
2. TCP ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼ŒæœåŠ¡å™¨ç›‘å¬è¯·æ±‚ï¼Œå½“æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚æŠ¥æ–‡æ—¶ï¼Œè‹¥åŒæ„è¿æ¥è¯·æ±‚ï¼Œåˆ™å‘å›ç¡®è®¤æŠ¥æ–‡ã€‚è®¾ç½®å…¶é¦–éƒ¨ï¼š`SYN = 1, ACK = 1, ack = x + 1, seq = y`ã€‚
3. TCP ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°ç¡®è®¤æŠ¥æ–‡ï¼Œé€šçŸ¥ä¸Šå±‚åº”ç”¨ï¼ˆå³æˆ‘ä»¬çš„æµè§ˆå™¨ï¼‰è¿æ¥å·²å»ºç«‹ï¼Œå¹¶å‘æœåŠ¡å™¨å‘é€ç¡®è®¤æŠ¥æ–‡ã€‚è®¾ç½®å…¶é¦–éƒ¨ï¼š`ACK = 1, ack = y + 1`ã€‚æœåŠ¡å™¨æ¥æ”¶åˆ°ç¡®è®¤æŠ¥æ–‡åï¼Œä¹Ÿé€šçŸ¥å…¶ä¸Šå±‚åº”ç”¨è¿æ¥å·²å»ºç«‹ã€‚

ç”±äºå‰é¢æˆ‘ä»¬æåˆ°çš„ HSTS æœºåˆ¶ï¼Œæˆ‘ä»¬çš„ HTTP è¯·æ±‚å°†åŸºäº HTTPS åè®®ã€‚ä¸¥æ ¼æ¥è¯´ï¼ŒHTTPS å¹¶éåº”ç”¨å±‚çš„ä¸€ç§æ–°åè®®ï¼Œå®ƒåªæ˜¯å°† HTTP åè®®çš„**é€šä¿¡æ¥å£**éƒ¨åˆ†ä½¿ç”¨**ä¼ è¾“å±‚å®‰å…¨æ€§åè®® TLS**ï¼ˆTransport Layer Securityï¼‰ä»£æ›¿ç½¢äº†ã€‚é€šå¸¸ï¼ŒHTTP ç›´æ¥ä¸ TCP é€šä¿¡ã€‚å½“ä½¿ç”¨ TLS æ—¶ï¼ŒHTTP å…ˆä¸ TLS é€šä¿¡ï¼Œå†ç”± TLS ä¸ TCP é€šä¿¡ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ºäº†ä¿è¯æ•°æ®ä¼ è¾“çš„**å®‰å…¨æ€§**ï¼Œå®¢æˆ·ç«¯è¿˜è¦ä¸æœåŠ¡å™¨åå•† TLS åè®®å‚æ•°ï¼Œè¿™ä¸ªè¿‡ç¨‹é€šå¸¸ç§°ä¸º TLS æ¡æ‰‹ã€‚åœ¨ TLS 1.0, 1.1 åŠ 1.2 ç‰ˆæœ¬ä¸­ï¼Œæ¡æ‰‹æœ‰å››æ¬¡ï¼›è€Œåœ¨ TLS 1.3 ç‰ˆæœ¬ä¸­ï¼Œæ¡æ‰‹åªéœ€è¦ä¸‰æ¬¡ã€‚TLS æ¡æ‰‹æ˜¯åœ¨ TCP è¿æ¥å»ºç«‹ä¹‹åè¿›è¡Œçš„ã€‚

ä»¥ [TLS 1.3 åè®®](https://datatracker.ietf.org/doc/html/rfc8446)ä¸ºä¾‹ï¼Œæ¡æ‰‹è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š

```plaintext
       Client                                           Server

Key  ^ ClientHello
Exch | + key_share*
     | + signature_algorithms*
     | + psk_key_exchange_modes*
     v + pre_shared_key*       --------&gt;
                                                  ServerHello  ^ Key
                                                 + key_share*  | Exch
                                            + pre_shared_key*  v
                                        {EncryptedExtensions}  ^  Server
                                        {CertificateRequest*}  v  Params
                                               {Certificate*}  ^
                                         {CertificateVerify*}  | Auth
                                                   {Finished}  v
                               &lt;--------  [Application Data*]
     ^ {Certificate*}
Auth | {CertificateVerify*}
     v {Finished}              --------&gt;
       [Application Data]      &lt;-------&gt;  [Application Data]

              +  Indicates noteworthy extensions sent in the
                 previously noted message.

              *  Indicates optional or situation-dependent
                 messages/extensions that are not always sent.

              {} Indicates messages protected using keys
                 derived from a [sender]_handshake_traffic_secret.

              [] Indicates messages protected using keys
                 derived from [sender]_application_traffic_secret_N.
```

è¿™æ ·ï¼Œæˆ‘ä»¬çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å»ºç«‹äº†åŸºäº TLS 1.3 çš„å®‰å…¨ TCP è¿æ¥ï¼Œæ˜¯æ—¶å€™ä¼ è¾“æ•°æ®äº†ï¼

### TLS ä¸ SSL

- [ã€Œä¼ è¾“å±‚å®‰å…¨æ€§åè®®ã€](https://zh.wikipedia.org/wiki/%E5%82%B3%E8%BC%B8%E5%B1%A4%E5%AE%89%E5%85%A8%E6%80%A7%E5%8D%94%E5%AE%9A)ï¼ŒWikipedia

åœ¨æ—¥å¸¸ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šè¯´ SSL æˆ– TLS/SSLï¼Œé‚£ä¹ˆ TLS å’Œ SSL ä¹‹é—´æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ

åŸæ¥ï¼Œ**å®‰å…¨å¥—æ¥å±‚ SSL**ï¼ˆSecure Sockets Layerï¼‰ æ˜¯ TLS çš„å‰èº«ã€‚TLS åŸºäº SSL 3.0 åè®®ï¼Œæ˜¯ SSL åè®®æ ‡å‡†åŒ–åçš„åè®®åã€‚ç”±äº SSL 3.0 è®¾è®¡ä¸­çš„ç¼ºé™·ï¼Œåœ¨ 2015 å¹´ 6 æœˆï¼Œ[RFC 7568](https://datatracker.ietf.org/doc/html/rfc7568) å®£å¸ƒå¼ƒç”¨ SSL 3.0ã€‚

ç›®å‰æœ€æ–°çš„ TLS 1.3 åè®®åœ¨ 2018 å¹´ 8 æœˆå‘è¡¨çš„ [RFC 8446](https://datatracker.ietf.org/doc/html/rfc8446) ä¸­å®šä¹‰ã€‚è€Œè¾ƒè€çš„ TLS 1.0 å’Œ TLS 1.1 ä¹Ÿå·²äº 2021 å¹´ 3 æœˆï¼Œåœ¨ [RFC 8996](https://datatracker.ietf.org/doc/html/rfc8996) ä¸­å®£å‘Šè¢«å¼ƒç”¨ã€‚

ç»“è®ºæ˜¯ï¼Œç†è®ºä¸Šæˆ‘ä»¬ç°åœ¨ç”¨çš„åŠ å¯†åè®®å¤§æŠµéƒ½æ˜¯ TLSï¼Œåœ¨è®¨è®ºä¸­ç›´æ¥ä½¿ç”¨ TLS å³å¯ã€‚

### TLS 1.3 çš„è¿›æ­¥

- [ã€ŒA Detailed Look at RFC 8446 (a.k.a. TLS 1.3)ã€](https://blog.cloudflare.com/rfc-8446-aka-tls-1-3/)ï¼Œ2018-08-11

TLS å·²ç»å­˜åœ¨ç›¸å½“å¤šçš„é—®é¢˜ï¼šä¾‹å¦‚ä»£ç ç¼ºä¹æµ‹è¯•ï¼Œç¨³å¥æ€§è¾ƒä½ï¼›å­˜åœ¨è®¸å¤šè®¾è®¡ç¼ºé™·ï¼Œå‡ºç°å¾ˆå¤šæ¼æ´ç­‰ã€‚

åœ¨è¿‘äº›å¹´æ¥ï¼Œäº’è”ç½‘ä¸Šä¸€ç›´å­˜åœ¨ä¸€ä¸ªä¸»è¦è¶‹åŠ¿ï¼Œå³å…¨é¢å¯ç”¨ HTTPSã€‚è¿™å¯ä»¥ä¿æŠ¤ç”¨æˆ·çš„å®‰å…¨ï¼Œä½†ä¼šå¯¼è‡´è¿æ¥é€Ÿåº¦å˜æ…¢ã€‚è‡ª TLS æ ‡å‡†åŒ–ä»¥æ¥ï¼Œåœ¨å‘é€åŠ å¯†æ•°æ®ä¹‹å‰ï¼Œå®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„æ¡æ‰‹è¯·æ±‚ä¼šè¿›è¡Œä¸¤æ¬¡å¾€è¿”ï¼ˆæˆ–è€…ä¼šè¯æ¢å¤è¿æ¥æ—¶è¿›è¡Œä¸€æ¬¡å¾€è¿”ï¼‰ã€‚ä¸å•ç‹¬çš„ HTTP ç›¸æ¯”ï¼ŒHTTPS ä¸­ TLS æ¡æ‰‹çš„é¢å¤–æˆæœ¬å¯èƒ½å¸¦æ¥æ½œåœ¨çš„é—®é¢˜ï¼Œå¹¶å¯¹ä»¥æ€§èƒ½ä¸ºä¸­å¿ƒçš„åº”ç”¨äº§ç”Ÿè´Ÿé¢å½±å“ã€‚åœ¨ [TLS 1.2 åè®®](https://datatracker.ietf.org/doc/html/rfc5246)ä¸­ï¼Œæ¡æ‰‹è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š

```plaintext
Client                                                Server

ClientHello                   --------&gt;
                                                 ServerHello
                                                Certificate*
                                          ServerKeyExchange*
                                         CertificateRequest*
                              &lt;--------      ServerHelloDone
Certificate*
ClientKeyExchange
CertificateVerify*
[ChangeCipherSpec]
Finished                      --------&gt;
                                          [ChangeCipherSpec]
                              &lt;--------             Finished
Application Data              &lt;-------&gt;     Application Data

* Indicates optional or situation-dependent messages that are not
always sent.
```

IETF å¯¹ TLS 1.2 çš„è¿‡æ—¶è®¾è®¡å’Œä¸¤æ¬¡å¾€è¿”å¼€é”€ä¸æ»¡æ„ï¼Œç€æ‰‹å®šä¹‰æ–°ç‰ˆæœ¬çš„ TLSï¼Œå³ TLS 1.3ï¼Œæ—¨åœ¨è§£å†³å¦‚ä¸‹çš„ä¸»è¦é—®é¢˜ï¼š

- å‡å°‘æ¡æ‰‹å»¶è¿Ÿï¼›
- åŠ å¯†æ›´å¤šçš„æ¡æ‰‹ä¿¡æ¯ï¼›
- æé«˜å¯¹è·¨åè®®æ”»å‡»çš„æ¢å¤èƒ½åŠ›ï¼›
- åˆ é™¤é—ç•™çš„åŠŸèƒ½ã€‚

åœ¨è¿‡å»çš„äºŒåå¹´é‡Œï¼Œå¯¹å¯†ç å­¦çš„ç ”ç©¶å¸®åŠ©äººä»¬å­¦åˆ°æ›´å¤šå…³äºå¦‚ä½•ç¼–å†™**æ›´å®‰å…¨çš„åŠ å¯†åè®®**çš„çŸ¥è¯†ã€‚TLS 1.3 çš„è®¾è®¡ç›®æ ‡ä¹‹ä¸€å°±æ˜¯åˆ é™¤æ½œåœ¨çš„å±é™©å…ƒç´ ï¼Œçº æ­£è¿‡å»çš„é”™è¯¯è®¾è®¡ã€‚ä¾‹å¦‚ï¼š

- **ç§»é™¤ RSA å¯†é’¥äº¤æ¢æ¨¡å¼**ï¼Œä»…ä¿ç•™ Diffie-Hellmanï¼ˆä¸‹ç®€ç§° DHï¼‰å¯†é’¥åè®®ã€‚RSA æ¨¡å¼å­˜åœ¨ä¸¤ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œä¸€æ˜¯å®ƒä¸æ˜¯å‰å‘åŠ å¯†ï¼ˆforward secretï¼‰ï¼Œæ„å‘³ç€å¦‚æœæœ‰äººè®°å½•ä¸‹åŠ å¯†çš„ä¼šè¯ï¼Œå¦‚æœåœ¨æŸå¤©è·å–åˆ°æœåŠ¡å™¨çš„ç§é’¥ï¼Œå°±å¯ä»¥å¯¹ä¼šè¯è¿›è¡Œç ´è§£ã€‚äºŒæ˜¯å­˜åœ¨éš¾ä»¥ä¿®å¤çš„æ¼æ´ï¼Œå¯ä»¥å‚è§ [ROBOT æ”»å‡»](https://robotattack.org/)ã€‚åˆ é™¤ RSA æ¨¡å¼ï¼Œåªä¿ç•™ DH å¯†é’¥åè®®ï¼Œå¸¦æ¥äº†ä¸€äº›æ€§èƒ½ä¼˜åŠ¿ï¼Œæˆ‘ä»¬åœ¨åé¢è¿›è¡Œè®¨è®ºã€‚
- **æä¾›æ›´å°‘çš„å¯é€‰é¡¹**ã€‚åœ¨å¯†ç å­¦ä¸­ï¼Œæä¾›å¤ªå¤šçš„é€‰é¡¹å¯èƒ½å¯¼è‡´æ›´å¤šçš„é”™è¯¯ã€‚è¿™ä¸ªåŸåˆ™åœ¨é€‰æ‹© DH å¯†é’¥åè®®çš„å‚æ•°æ—¶å°¤ä¸ºæ˜æ˜¾ã€‚è¯¥åè®®çš„å®‰å…¨æ€§å–å†³äºé€‰æ‹©çš„ DH å‚æ•°å€¼ï¼Œå®ƒä¸€æ–¹é¢è¦ä¸ºè¾ƒå¤§çš„å€¼ï¼Œå¦ä¸€æ–¹é¢éœ€è¦å…·æœ‰æŸäº›[æ­£ç¡®çš„æ•°å­¦å±æ€§](https://arstechnica.com/information-technology/2016/01/high-severity-bug-in-openssl-allows-attackers-to-decrypt-https-traffic/)ã€‚åœ¨ä»¥å‰ç‰ˆæœ¬çš„ TLS ä¸­ï¼ŒDH å‚æ•°ç”±å‚ä¸è€…å†³å®šï¼›è€Œåœ¨ TLS 1.3 ç‰ˆæœ¬ä¸­ï¼Œåˆ™å°†å‚æ•°é™åˆ¶ä¸ºå·²çŸ¥å®‰å…¨çš„å€¼ï¼Œå‡å°‘ç”¨æˆ·çš„å¯é€‰é¡¹ã€‚

æ›´å¤šå…³äºå®‰å…¨æ€§çš„æ”¹è¿›å¯ä»¥è®¿é—®è¯¥å°èŠ‚å¼€å¤´çš„[å‚è€ƒåšå®¢](https://blog.cloudflare.com/rfc-8446-aka-tls-1-3/)ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ TLS 1.3 åœ¨**æ€§èƒ½è¡¨ç°ä¸Šçš„ä¼˜åŠ¿**ã€‚

åœ¨ DH å¯†é’¥åè®®ä¸­ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½ä»åˆ›å»ºå…¬é’¥-ç§é’¥å¯¹å¼€å§‹ï¼Œç„¶åäº¤æ¢å„è‡ªçš„å…¬é’¥ï¼Œå¹¶æ ¹æ®è‡ªå·±çš„ç§é’¥å’Œå¯¹æ–¹çš„å…¬é’¥ç”Ÿæˆæœ€ç»ˆçš„å¯†é’¥ã€‚æœ€ç»ˆçš„å¯†é’¥è‡ªå§‹è‡³ç»ˆéƒ½ä¸ä¼šé€šè¿‡ç½‘ç»œä¼ è¾“ï¼ŒDH ç®—æ³•é€šè¿‡æ•°å­¦å®šå¾‹ä¿è¯åŒæ–¹ç®—å‡ºçš„ç»“æœä¸€è‡´ã€‚æ¥ä¸‹æ¥ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªå¯†é’¥å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†å’Œè§£å¯†ã€‚

TLS 1.3 ä½¿ç”¨è¿™æ ·ä¸€ä¸ªæ›´ç®€å•çš„å¯†é’¥åå•†æ¨¡å¼å’Œä¸€ç»„æ›´å°‘çš„å¯†é’¥åå•†é€‰é¡¹ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªè¿æ¥éƒ½å°†ä½¿ç”¨åŸºäº DH çš„å¯†é’¥åè®®ï¼ŒæœåŠ¡å™¨æ”¯æŒçš„ DH å‚æ•°æ›´å®¹æ˜“è¢«çŒœåˆ°ã€‚æœ‰é™çš„é€‰æ‹©ä½¿å¾—å®¢æˆ·ç«¯å¯ä»¥åœ¨ç¬¬ä¸€æ¡æ¶ˆæ¯ä¸­å°±å‘é€è‡ªå·±çš„å…¬é’¥ï¼Œè€Œæ— éœ€ç­‰å¾…æœåŠ¡å™¨ç¡®è®¤æ”¯æŒçš„ç±»å‹ã€‚

åœ¨æœåŠ¡å™¨ä¸æ”¯æŒå®¢æˆ·ç«¯ä½¿ç”¨åå•†é€‰é¡¹çš„ç½•è§æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨å¯ä»¥å‘é€ `HelloRetryRequest` çš„æ¶ˆæ¯ï¼Œè®©å®¢æˆ·ç«¯çŸ¥é“è‡ªå·±æ”¯æŒå“ªäº›åå•†é€‰é¡¹ç»„ã€‚

ä½œä¸ºå°ç»“ï¼š

&gt; TLS 1.3 is a modern security protocol built with modern tools like formal analysis that retains its backwards compatibility. It has been tested widely and iterated upon using real world deployment data. It&apos;s a cleaner, faster, and more secure protocol ready to become the de facto two-party encryption protocol online.
&gt; It is one the best recent examples of how it is possible to take 20 years of deployed legacy code and change it on the fly, resulting in a better internet for everyone. TLS 1.3 has been debated and analyzed for the last three years (2015 - 2018) and it&apos;s now ready for prime time.

### å¯¹ç§°å¯†é’¥åŠ å¯†ï¼Œéå¯¹ç§°å¯†é’¥åŠ å¯†ä¸æ··åˆåŠ å¯†

ç®€å•æ¥è¯´ï¼Œåœ¨**å¯¹ç§°å¯†é’¥åŠ å¯†**ä¸­ï¼Œå¯¹æ•°æ®çš„åŠ å¯†å’Œè§£å¯†éƒ½ä½¿ç”¨åŒä¸€ä¸ªå¯†é’¥ã€‚ç›¸è¾ƒäºéå¯¹ç§°å¯†é’¥åŠ å¯†ï¼Œå®ƒçš„é€Ÿåº¦æ›´å¿«ï¼›ä½†æ˜¯ç”±äºå¯†é’¥åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­å®¹æ˜“è¢«è·å–ï¼Œå› æ­¤å…¶å®‰å…¨æ€§è¾ƒä½ã€‚

åœ¨**éå¯¹ç§°å¯†é’¥åŠ å¯†**ï¼ˆæˆ–å…¬å¼€å¯†é’¥åŠ å¯†ï¼‰ä¸­ï¼Œä½¿ç”¨ä¸€å¯¹å¯†é’¥è¿›è¡ŒåŠ å¯†å’Œè§£å¯†ï¼Œåˆ†åˆ«ä¸ºå…¬å¼€å¯†é’¥å’Œç§æœ‰å¯†é’¥ã€‚å…¬å¼€å¯†é’¥æ‰€æœ‰äººéƒ½å¯ä»¥è·å¾—ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨å…¬å¼€å¯†é’¥å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼ŒæœåŠ¡å™¨ä½¿ç”¨ç§æœ‰å¯†é’¥å¯¹æ•°æ®è¿›è¡Œè§£å¯†ã€‚åŒæ ·ï¼ŒæœåŠ¡å™¨å¯¹å“åº”çš„æ•°æ®ä½¿ç”¨ç§æœ‰å¯†é’¥åŠ å¯†ï¼Œå®¢æˆ·ç«¯åˆ™å¯ä»¥é€šè¿‡å…¬å¼€å¯†é’¥è¿›è¡Œè§£å¯†ã€‚ç›¸è¾ƒäºå¯¹ç§°å¯†é’¥åŠ å¯†ï¼Œåªè¦ä¿ç®¡å¥½ç§æœ‰å¯†é’¥ï¼Œå°±èƒ½ä¿è¯å®¢æˆ·ç«¯ä¼ è¾“çš„æ¶ˆæ¯ä¸è¢«ç ´è§£ï¼Œå› æ­¤å®ƒçš„å®‰å…¨æ€§æ›´é«˜ï¼›ç”±äºç®—æ³•å’Œè¿‡ç¨‹æ›´ä¸ºç¹çï¼Œå› æ­¤å…¶é€Ÿåº¦è¾ƒæ…¢ã€‚

HTTPS é‡‡ç”¨çš„æ˜¯**æ··åˆåŠ å¯†**æœºåˆ¶â€”â€”åœ¨ TLS 1.3 ä»¥å‰ï¼Œå®¢æˆ·ç«¯é¦–å…ˆä½¿ç”¨æœåŠ¡å™¨æä¾›çš„å…¬é’¥ï¼ŒåŠ å¯†ä¸€ä¸ªéšæœºå€¼ï¼Œç„¶åå°†å®ƒä¼ è¾“ç»™æœåŠ¡å™¨ã€‚æœåŠ¡å™¨ä½¿ç”¨ç§é’¥è§£å¯†ï¼Œè·å¾—éšæœºå€¼ï¼Œç„¶åä½¿ç”¨ä¸å®¢æˆ·ç«¯ç›¸åŒçš„å¯†é’¥ç”Ÿæˆç®—æ³•ï¼ŒåŸºäºè¿™ä¸ªéšæœºå€¼å’Œä¹‹å‰æ¡æ‰‹ä¸­åˆ›å»ºçš„å¦å¤–ä¸¤ä¸ªéšæœºå€¼ï¼Œç”Ÿæˆä¸å®¢æˆ·ç«¯ç›¸åŒçš„å¯†é’¥ï¼Œä¹‹åå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å°±å¯ä»¥ä½¿ç”¨è¿™æŠŠå¯¹ç§°å¯†é’¥è¿›è¡Œé€šä¿¡äº†ã€‚åœ¨ TLS 1.3 ä¸­ï¼ŒåŸºäº DH å¯†é’¥åè®®ï¼Œä¸å†èµ˜è¿°ã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡å°±å…¼é¡¾äº†å¯¹ç§°å¯†é’¥åŠ å¯†çš„é«˜æ•ˆæ€§å’Œéå¯¹ç§°å¯†é’¥åŠ å¯†çš„å®‰å…¨æ€§ã€‚

## æ¬¢è¿è®¿é—®æˆ‘çš„åšå®¢

ç°åœ¨ï¼Œæµè§ˆå™¨çŸ¥é“äº†å·²ç»ä¸è¿œæ–¹çš„æœåŠ¡å™¨å»ºç«‹å¥½äº†å®‰å…¨å¯é çš„ä¼ è¾“é€šé“ï¼Œäºæ˜¯å°† HTTP è¯·æ±‚ä¿¡æ¯æ‰“åŒ…å¥½ï¼Œä¼ è¾“åˆ°æœåŠ¡å™¨ä¸Šçš„ 443 ç«¯å£ã€‚æœåŠ¡å™¨ä½¿ç”¨å¯†é’¥è§£å¯†è·å¾—å…¶ä¸­çš„ä¿¡æ¯ï¼Œå‘ç°æ˜¯è¯·æ±‚æˆ‘åšå®¢çš„ HTTP æŠ¥æ–‡ï¼Œé‚è½¬å‘ç»™ç›¸åº”çš„ HTTP æœåŠ¡ã€‚æœ€ç»ˆå°†æˆ‘ä»¬æ‰€éœ€çš„ HTML, CSS, JS ä»¥åŠç›¸å…³çš„é™æ€æ–‡ä»¶å‘é€ç»™æµè§ˆå™¨ï¼Œæµè§ˆå™¨å†æŠŠå®ƒä»¬æ¸²æŸ“å‡ºæ¥ã€‚

Oh, Welcome to visit my blogï¼

## å‚è€ƒæ–‡ç« 

é™¤äº†æ­£æ–‡ä¸­ç‰¹åˆ«ç½—åˆ—å‡ºæ¥çš„ç½‘ç«™æ–‡ç« ï¼Œè¿˜åŒ…æ‹¬ï¼š

- [ã€Œåœ¨æµè§ˆå™¨åœ°å€æ è¾“å…¥ä¸€ä¸ª URL åå›è½¦ï¼ŒèƒŒåä¼šè¿›è¡Œå“ªäº›æŠ€æœ¯æ­¥éª¤ï¼Ÿã€](https://www.zhihu.com/question/34873227/answer/518086565)ï¼Œ2020-03-28
- [ã€Œä¸Šå¤é¢è¯•é¢˜â€”â€”æµè§ˆå™¨åœ°å€æ è¾“å…¥åå›è½¦ä¼šå‘ç”Ÿä»€ä¹ˆã€](https://segmentfault.com/a/1190000021000934)ï¼Œ2019-11-14
- [ã€Œææ‡‚è¿™ 9 æ­¥ï¼ŒDNS è®¿é—®åŸç†å°±æ˜æ˜ç™½ç™½äº†ã€](https://segmentfault.com/a/1190000039650564)ï¼Œ2021-03-17
- [ã€ŒDNS æŸ¥è¯¢æœºåˆ¶ã€](https://segmentfault.com/a/1190000039406281)ï¼Œ2021-03-13
- [ã€ŒDNS æœåŠ¡å™¨æœ‰å“ªäº›ä¸åŒç±»å‹ï¼Ÿã€](https://www.cloudflare.com/zh-cn/learning/dns/dns-server-types/)ï¼ŒCloudflare
- [ã€Œ36 å¼ å›¾è¯¦è§£ ARP ï¼šç½‘ç»œä¸–ç•Œæ²¡æœ‰æˆ‘ï¼Œä½ å“ªä¹Ÿåˆ«æƒ³å»ã€](https://zhuanlan.zhihu.com/p/379015679)ï¼Œ2021-06-08
- [ã€Œå›¾è§£ HTTPã€](https://www.ituring.com.cn/book/1229)ï¼Œ\[æ—¥\]ä¸Šé‡å®£ è‘—ï¼Œäºå‡è‰¯ è¯‘
- [ã€Œè¯¦è§£ TCP ä¸‰æ¬¡æ¡æ‰‹ä»¥åŠ TLS/SSL æ¡æ‰‹ã€](https://ocdman.github.io/2018/11/02/%E8%AF%A6%E8%A7%A3TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E4%BB%A5%E5%8F%8ATLS-SSL%E6%8F%A1%E6%89%8B/)ï¼Œ2018-11-02
- [ã€ŒHTTPS è¯¦è§£äºŒï¼šSSL / TLS å·¥ä½œåŸç†å’Œè¯¦ç»†æ¡æ‰‹è¿‡ç¨‹ã€](https://segmentfault.com/a/1190000021559557)ï¼Œ2020-01-19
</content:original-text><content:updated-at>2021-07-23T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[ä¸º Archer ä¸»é¢˜æ›´æ¢å­—ä½“]]></title><description><![CDATA[çœ‹è…»äº†åŸå…ˆçš„å­—ä½“ï¼Œäº¦æˆ–æ˜¯æƒ³æ»¡è¶³ç‹¬æ ‘ä¸€å¸œçš„è®¾è®¡æ¬²æœ›ï¼Ÿä¸å¦¨æ›´æ¢ä¸€ä¸‹åšå®¢çš„å­—ä½“å§ï¼æœ¬æ–‡å°†åŸºäº Hexo å’Œä¸»é¢˜ Hexo-Theme-Archer å±•ç¤ºå¦‚ä½•æ›´æ¢åšå®¢çš„ä¸­æ–‡å­—ä½“ã€‚ å¼•å…¥å­—ä½“æ–‡ä»¶

è¿™é‡Œæä¾›ä¸¤ç§å¼•å…¥çš„æ€è·¯ï¼Œä¸€ç§æ˜¯ CDN å¼•å…¥ï¼Œä¸€ç§æ˜¯æœ¬åœ°å¼•å…¥ã€‚å»ºè®®é€šè¿‡ CDN çš„æ–¹å¼å¼•å…¥ï¼Œå¯ä»¥å¤§å¤§æé«˜åŠ è½½æ•ˆç‡ã€‚

å¼•å…¥ CDN å­—ä½“æ–‡ä»¶

ä»¥æ›´æ¢å­—ä½“ä¸ºæ€æºé»‘ä½“ï¼ˆGoogle å­—ä½“ä¸Šå« ï¼ŒAdobe ç‰ˆæœ¬å« ï¼‰ä¸ºä¾‹â€¦]]></description><link>https://blog.towind.fun/posts/web-font-for-hexo-theme-archer</link><guid isPermaLink="false">web-font-for-hexo-theme-archer</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Sat, 26 Jun 2021 00:00:00 GMT</pubDate><content:original-text>
çœ‹è…»äº†åŸå…ˆçš„å­—ä½“ï¼Œäº¦æˆ–æ˜¯æƒ³æ»¡è¶³ç‹¬æ ‘ä¸€å¸œçš„è®¾è®¡æ¬²æœ›ï¼Ÿä¸å¦¨æ›´æ¢ä¸€ä¸‹åšå®¢çš„å­—ä½“å§ï¼æœ¬æ–‡å°†åŸºäº Hexo å’Œä¸»é¢˜ [Hexo-Theme-Archer](https://github.com/fi3ework/hexo-theme-archer) å±•ç¤ºå¦‚ä½•æ›´æ¢åšå®¢çš„ä¸­æ–‡å­—ä½“ã€‚

## å¼•å…¥å­—ä½“æ–‡ä»¶

è¿™é‡Œæä¾›ä¸¤ç§å¼•å…¥çš„æ€è·¯ï¼Œä¸€ç§æ˜¯ CDN å¼•å…¥ï¼Œä¸€ç§æ˜¯æœ¬åœ°å¼•å…¥ã€‚å»ºè®®é€šè¿‡ CDN çš„æ–¹å¼å¼•å…¥ï¼Œå¯ä»¥å¤§å¤§æé«˜åŠ è½½æ•ˆç‡ã€‚

### å¼•å…¥ CDN å­—ä½“æ–‡ä»¶

ä»¥æ›´æ¢å­—ä½“ä¸ºæ€æºé»‘ä½“ï¼ˆGoogle å­—ä½“ä¸Šå« `Noto Sans`ï¼ŒAdobe ç‰ˆæœ¬å« `Source Han Sans`ï¼‰ä¸ºä¾‹ï¼Œè€ƒè™‘åˆ°ä¸­æ–‡ç«™ç‚¹é¢å‘çš„è¯»è€…åœ¨å›½å†…ï¼Œæ— æ³•ç›´æ¥ä¸‹è½½æ€æºé»‘ä½“è¿™æ¬¾ Google å­—ä½“ï¼Œå› æ­¤è€ƒè™‘é€šè¿‡ CDN çš„æ–¹å¼å¼•å…¥å®ƒã€‚æ®ç¬”è€…æµ‹è¯•ï¼Œç›®å‰æœ‰è¿™å››ä¸ª CDN ç«™ç‚¹å¯ä»¥æä¾›ç¨³å®šçš„æœåŠ¡ï¼š

- `https://fonts.googleapis.cnpmjs.org`
- `https://fonts.font.im`ï¼Œå¯å‚è€ƒï¼šhttp://www.googlefonts.cn/old
- `https://fonts.proxy.ustclug.org`
- `https://fonts.loli.net`ï¼Œå¯å‚è€ƒï¼šhttps://sb.sb/blog/css-cdn

ä½¿ç”¨æ–¹æ³•éå¸¸ç®€å•ï¼Œåœ¨ Google å­—ä½“ä¸Šé€‰æ‹©[æ€æºé»‘ä½“ç®€ä½“ä¸­æ–‡ç‰ˆæœ¬](https://fonts.google.com/specimen/Noto+Sans+SC?subset=chinese-simplified#standard-styles)ï¼Œå†é€‰æ‹©éœ€è¦çš„å­—é‡å¦‚ `Regular 400`ï¼Œå¦‚æœä½¿ç”¨ `&lt;link&gt;` çš„æ–¹å¼å¼•å…¥ï¼Œåˆ™ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```html
&lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.googleapis.com&quot; /&gt;
&lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.gstatic.com&quot; crossorigin /&gt;
&lt;link
  href=&quot;https://fonts.googleapis.com/css2?family=Noto+Sans+SC&amp;display=swap&quot;
  rel=&quot;stylesheet&quot;
/&gt;
```

ä½¿ç”¨ CDN åŠ é€Ÿçš„æ–¹å¼ï¼Œåªéœ€è¦å°†ä¸Šé¢ä»£ç ä¸­çš„ `https://fonts.googleapis.com` éƒ¨åˆ†æ›´æ¢ä¸ºå‰è¾¹å¯¹åº” CDN é“¾æ¥å³å¯ã€‚ä¾‹å¦‚ä½¿ç”¨ä¸­å›½ç§‘å­¦æŠ€æœ¯å¤§å­¦çš„é•œåƒç«™åŠ é€Ÿï¼Œåº”ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š

```html
&lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.proxy.ustclug.org&quot; /&gt;
&lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.gstatic.com&quot; crossorigin /&gt;
&lt;link
  href=&quot;https://fonts.proxy.ustclug.org/css2?family=Noto+Sans+SC&amp;display=swap&quot;
  rel=&quot;stylesheet&quot;
/&gt;
```

ç„¶åå°†ä¸Šé¢è¿™æ®µä»£ç æ”¾åˆ° Archer ä¸»é¢˜ç›®å½•ä¸‹çš„ `layout/_partial/base-head.ejs` ä»£ç ç‰‡æ®µä¸­å³å¯ã€‚

è¿™æ®µä»£ç åŒæ—¶å®šä¹‰äº†ä¸€ä¸ªåä¸º `Noto Sans SC` çš„å­—ä½“æ—ï¼Œåœ¨åé¢å°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªå€¼å¼•å…¥å­—ä½“äº†ã€‚

### ç›´æ¥å¼•å…¥æœ¬åœ°å­—ä½“æ–‡ä»¶

ä»¥æ›´æ¢å­—ä½“ä¸ºæœªæ¥è§é»‘ä¸ºä¾‹ï¼Œé¦–å…ˆï¼Œå»[å¼€æºçš„ Realease é¡µ](https://github.com/welai/glow-sans/releases)ä¸‹è½½å­—ä½“æ–‡ä»¶ã€‚å…¶ä¸­ï¼Œä»¥ `GlowSansSC` å¼€å¤´çš„å­—ä½“ä¸ºæœªæ¥è§é»‘çš„ç®€ä½“ä¸­æ–‡å­—ä½“ã€‚è¿™é‡Œæˆ‘é€‰æ‹©ä¸‹è½½äº† `GlowSansSC-Normal-v0.92.zip`ã€‚

è§£å‹ä¹‹ï¼Œå¯ä»¥å¾ˆå¤šä¸åŒ**å­—é‡**çš„ `.otf` å­—ä½“æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©äº† `GlowSansSC-Normal-Book.otf`ã€‚å°†å­—ä½“æ–‡ä»¶å¤åˆ¶åˆ° Archer ä¸»é¢˜çš„ `source/font` ç›®å½•ä¸‹ã€‚

ç¼–è¾‘ Archer ä¸»é¢˜ç›®å½•ä¸‹çš„ `src/scss/_variables.scss` æ–‡ä»¶ï¼Œæ·»åŠ æ–°çš„ `@font-face` å¦‚ä¸‹ï¼š

```scss
@font-face {
  font-family: &quot;Glow Sans SC&quot;;
  src: url(&quot;../font/GlowSansSC-Normal-Book.otf&quot;);
}
```

æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º `Glow Sans SC` çš„å­—ä½“æ—ï¼Œåœ¨åé¢å°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªå€¼å¼•å…¥å­—ä½“äº†ã€‚

å…¶ä¸­ï¼Œurl è·¯å¾„ `../font/GlowSansSC-Normal-Book.otf` æ˜¯å¦‚ä½•å¾—æ¥çš„å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨æ‰§è¡Œ `hexo g` æ—¶ï¼Œä¼šå°†ä¸»é¢˜ç›®å½•ä¸‹çš„ `source` ä¸­çš„æ–‡ä»¶æ‹·è´åˆ°åšå®¢æ ¹ç›®å½•ä¸‹çš„ `public` ç›®å½•ä¸­ã€‚è€Œæ ¹æ® Archer ä¸»é¢˜çš„ gulp ç”Ÿæˆè§„åˆ™ï¼Œç¼–è¯‘å¥½çš„ `.css` æ–‡ä»¶å­˜æ”¾åœ¨ä¸»é¢˜ç›®å½•ä¸‹çš„ `source/css` ä¸­ã€‚å› æ­¤ï¼Œä¸ºäº†æœ€ç»ˆæ­£ç¡®æŒ‡å‘åšå®¢æ ¹ç›®å½•ä¸‹ `public/font/GlowSansSC-Normal-Book.otf` æ–‡ä»¶ï¼Œåº”è¯¥è®¾ç½® url ä¸ºä¸Šä¸€çº§ç›®å½•ä¸‹çš„ `font` ç›®å½•ã€‚

è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯ï¼šé…ç½®æ–¹ä¾¿ã€‚

ä½†ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼šæ…¢ï¼å°¤å…¶å¯¹äºå¤§å¤šæ•°äººå»ºç«‹ä¸ªäººåšå®¢æ—¶ï¼Œä¼šä½¿ç”¨è‡ªå·±çš„â€œå°æ°´ç®¡â€æœåŠ¡å™¨ï¼Œå­—ä½“æ–‡ä»¶è¦åŠ è½½è€åŠå¤©æ‰èƒ½æ­£å¸¸æ˜¾ç¤ºå‡ºæ¥ï¼ˆåŒ…æ‹¬ä¸­æ–‡çš„å­—ä½“æ–‡ä»¶å¤§çº¦ 9 MB å·¦å³ï¼Œè€Œä¸‹è½½é€Ÿåº¦å¤§çº¦ä¸º 200 KB/sï¼‰ã€‚æ­¤å¤–ï¼Œç”±äº Archer ä¸»é¢˜åœ¨å¼€å¤´å¤„å°±ä¼šå¼•å…¥åŒ…å«å­—ä½“é…ç½®çš„ CSS æ–‡ä»¶ï¼Œè¦ç•™å¾…å­—ä½“åŠ è½½å®Œæˆåæ‰æ¸²æŸ“åç»­å†…å®¹ï¼Œæå¤§å½±å“é¦–æ¬¡æµè§ˆä½“éªŒã€‚

## æ›´æ¢åšå®¢å­—ä½“

æ¥ä¸‹æ¥ï¼Œä¿®æ”¹ Archer ä¸»é¢˜ `src/scss/_variables.scss` æ–‡ä»¶ä¸­çš„ `$base-font-family` å˜é‡ï¼š

```scss
$base-font-family:
  &quot;Noto Sans SC&quot;,
  -apple-system,
  BlinkMacSystemFont,
  &quot;Helvetica Neue&quot;,
  Arial,
  &quot;PingFang SC&quot;,
  &quot;Hiragino Sans GB&quot;,
  STHeiti,
  &quot;Microsoft YaHei&quot;,
  &quot;Microsoft JhengHei&quot;,
  &quot;Source Han Sans SC&quot;,
  &quot;Noto Sans CJK SC&quot;,
  &quot;Source Han Sans CN&quot;,
  &quot;Noto Sans SC&quot;,
  &quot;Source Han Sans TC&quot;,
  &quot;Noto Sans CJK TC&quot;,
  &quot;WenQuanYi Micro Hei&quot;,
  SimSun,
  sans-serif;
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œåœ¨ `$base-font-family` æœ€å‰é¢åŠ ä¸Š `Noto Sans SC`ï¼ˆæˆ– `Glow Sans SC`ï¼‰å°±å¯ä»¥æ›´æ¢å­—ä½“ä¸ºæ€æºé»‘ä½“ï¼ˆæˆ–æœªæ¥é»‘ä½“ï¼‰äº†ã€‚æµè§ˆå™¨æŒ‰é¡ºåºè¯»å–å¹¶ä½¿ç”¨å­—ä½“ï¼Œå¦‚æœå‰é¢çš„å­—ä½“æ²¡æœ‰ï¼Œåˆ™ä¾æ¬¡ä½¿ç”¨åé¢çš„å­—ä½“ã€‚

ç‰¹åˆ«çš„ï¼ŒArcher ä¸»é¢˜æä¾›äº†å¦ä¸€ä¸ªå˜é‡ `$feature-font-family`ï¼Œæ¸²æŸ“ä¸ºä¸»é¢˜ä¸­ Profileï¼ŒIntroï¼ŒFooter ç­‰åœ°æ–¹çš„å­—ä½“ï¼Œå¦‚æœå¸Œæœ›ï¼Œä¹Ÿå¯ä»¥æ›´æ¢ã€‚

åœ¨ä¸Šä¼ åˆ° Github ä¹‹å‰ï¼Œåˆ«å¿˜äº†åœ¨ä¸»é¢˜æ ¹ç›®å½•æ‰§è¡Œ `npm run build`ã€‚

## å‹ç¼©ä¸­æ–‡å­—ä½“

**ç¬”è€…å¹¶æœªæˆåŠŸåœ¨ Archer ä¸»é¢˜ä¸­å®ç°**ï¼Œè¿™é‡Œåªæ˜¯ç»™å‡ºå®ç°æ€è·¯å’Œæ–¹æ³•ã€‚

é€‚ç”¨äºåœ¨[**æœ¬åœ°å¼•å…¥å­—ä½“**](#ç›´æ¥å¼•å…¥æœ¬åœ°å­—ä½“æ–‡ä»¶)çš„æ–¹å¼ã€‚

å› ä¸ºä¸­æ–‡å­—ä½“çš„ç¼–ç ç›¸æ¯”è‹±æ–‡å­—ä½“å¤šå¾ˆå¤šï¼Œå¯¼è‡´ä¸­æ–‡å­—ä½“æ–‡ä»¶é€šå¸¸ç‰¹åˆ«å¤§ï¼Œååˆ†è€—è´¹ç½‘ç»œèµ„æºï¼Œè¿˜ä¼šé™ä½ç”¨æˆ·ä½“éªŒã€‚ä»¥ Archer ä¸»é¢˜è‡ªå¸¦çš„å­—ä½“ä¸ºä¾‹ï¼Œè‹±æ–‡å­—ä½“ `Oswald-Regular.ttf` åªæœ‰ 89 KB å¤§å°ï¼Œè€Œåˆšåˆšæœ¬åœ°å¼•å…¥ç¤ºä¾‹ä¸­çš„ä¸­æ–‡å­—ä½“ `GlowSansSC-Normal-Book.otf` æœ‰ 8971 KB ä¹‹å¤§ã€‚å¦‚æœèƒ½å¯¹ä¸­æ–‡å­—ä½“è¿›è¡Œå‹ç¼©ï¼Œå°†èƒ½å¤§å¤§æé«˜ç”¨æˆ·ä½“éªŒã€‚

ä¸€æ¬¾å›½äººå¼€æºçš„æ™ºèƒ½ WebFont å‹ç¼©å·¥å…· [font-spider](https://github.com/aui/font-spider) èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚

è¿™æ¬¾å·¥å…·èƒ½å¤Ÿè·å–ç½‘é¡µä¸­ä½¿ç”¨åˆ°çš„ä¸­æ–‡æ–‡å­—ï¼Œç„¶åä»æºå­—ä½“æ–‡ä»¶ä¸­æå–å‡ºæ¥è¿™äº›æ–‡å­—ï¼Œç”Ÿæˆä¸€ä¸ªåªåŒ…å«è¿™äº›æ–‡å­—çš„å­—ä½“æ–‡ä»¶ã€‚è€Œæˆ‘ä»¬åªéœ€è¦å¼•å…¥è¿™ä¸ªç”Ÿæˆçš„å­—ä½“æ–‡ä»¶ï¼Œå°±å¯ä»¥å®ç°å‹ç¼©ä¸­æ–‡å­—ä½“äº†ï¼

ä¸ºäº†èƒ½ä½¿ç”¨ Github Actions è‡ªåŠ¨é›†æˆéƒ¨ç½²åšå®¢ï¼Œè¿™é‡Œæˆ‘åœ¨åšå®¢æ ¹ç›®å½•å¼•å…¥äº† font-spider ä½œä¸ºé¡¹ç›®çš„å¼€å‘ä¾èµ–ã€‚

```bash
yarn add -D font-spider
```

ç”±äº font-spider éœ€è¦ä½¿ç”¨ `.ttf` æ ¼å¼çš„å­—ä½“è¿›è¡Œè½¬æ¢ï¼Œå› æ­¤é¦–å…ˆéœ€è¦æŠŠä¹‹å‰ä¸‹è½½çš„ `.otf` æ ¼å¼è½¬æ¢ä¸º `.ttf` æ ¼å¼ï¼Œè¿™å¯ä»¥å€ŸåŠ©äºè¿™ä¸ª[æ ¼å¼è½¬æ¢ç½‘ç«™](https://convertio.co/zh/otf-ttf/)ã€‚å°†è½¬æ¢å®Œæˆåçš„ `GlowSansSC-Normal-Book.ttf` å­—ä½“æ–‡ä»¶æ”¾åœ¨ä¸»é¢˜ç›®å½•ä¸‹çš„ `source/font` ä¸­ã€‚

ç¼–è¾‘ä¸»é¢˜ç›®å½•ä¸‹çš„ `src/scss/_variables.scss` æ–‡ä»¶ï¼Œä¿®æ”¹åˆšåˆšçš„æ ·å¼è¡¨å±æ€§ï¼š

```scss
@font-face {
  font-family: &quot;Glow Sans SC&quot;;
  src: url(&quot;../font/GlowSansSC-Normal-Book.eot&quot;);
  src:
    url(&quot;../font/GlowSansSC-Normal-Book.eot?#font-spider&quot;)
      format(&quot;embedded-opentype&quot;),
    url(&quot;../font/GlowSansSC-Normal-Book.woff2&quot;) format(&quot;woff2&quot;),
    url(&quot;../font/GlowSansSC-Normal-Book.woff&quot;) format(&quot;woff&quot;),
    url(&quot;../font/GlowSansSC-Normal-Book.ttf&quot;) format(&quot;truetype&quot;),
    url(&quot;../font/GlowSansSC-Normal-Book.svg&quot;) format(&quot;svg&quot;);
}
```

åœ¨ä¸»é¢˜æ ¹ç›®å½•æ‰§è¡Œ `yarn build` ç”Ÿæˆæ‰“åŒ…å¥½çš„æ ·å¼è¡¨æ–‡ä»¶ã€‚

å›åˆ°åšå®¢æ ¹ç›®å½•ï¼Œç¼–è¾‘ `package.json`ï¼Œæ·»åŠ è„šæœ¬ï¼š

```json
&quot;scripts&quot;: {
  &quot;font-spider&quot;: &quot;font-spider public/*.html&quot;
}
```

å…¶ä¸­ï¼Œ`public` æ˜¯ Hexo ç”Ÿæˆé™æ€åšå®¢æ–‡ä»¶çš„é»˜è®¤ç›®å½•ã€‚

åœ¨åšå®¢æ ¹ç›®å½•åˆ†åˆ«æ‰§è¡Œï¼š

```bash
# ç”Ÿæˆé™æ€åšå®¢æ–‡ä»¶
hexo g
# å‹ç¼©ä¸­æ–‡å­—ä½“æ–‡ä»¶
yarn font-spider
```

ç‰¹åˆ«çš„ï¼Œå‡å¦‚ä½¿ç”¨ Github Actions ä¸€ç±»çš„ CI ç³»ç»Ÿï¼Œåˆ«å¿˜äº†å°†å‹ç¼©ä¸­æ–‡å­—ä½“æ–‡ä»¶çš„æ­¥éª¤åŠ å…¥åˆ° CI é…ç½®ä¸­ã€‚

## æ–‡æœ«ç¢ç¢å¿µ

ç¬”è€…æœ€å¼€å§‹ä½¿ç”¨çš„æ˜¯ Github ä¸Š[å¼€æºçš„æ€æºé»‘ä½“](https://github.com/adobe-fonts/source-han-sans)ï¼Œé€šè¿‡æœ¬åœ°å¼•å…¥çš„æ–¹å¼åŠ è½½å­—ä½“ã€‚è€Œåé€‰æ‹©ä½¿ç”¨äº† CDN å¼•å…¥ Google å­—ä½“ä¸­çš„æ€æºé»‘ä½“ã€‚å‘ç°ä¸¤è€…ç«Ÿç„¶æœ‰ä¸å°çš„åŒºåˆ«ï¼Œæ€»çš„æ¥è¯´å‰è€…æ›´å¥½çœ‹ä¸€äº›â€¦â€¦å‡ä½¿ç”¨ `Regular` å­—é‡ï¼Œé¡µé¢æ•ˆæœå¦‚ä¸‹ï¼š

Github å¼€æºç‰ˆæœ¬ï¼š

![Github å¼€æºç‰ˆæœ¬æ€æºé»‘ä½“](./web-font-for-hexo-theme-archer/Github-Open-Source-Version.png)

Google å­—ä½“ç‰ˆæœ¬ï¼š

![Google å­—ä½“ç‰ˆæœ¬æ€æºé»‘ä½“](./web-font-for-hexo-theme-archer/Google-Fonts-Version.png)

å‰è€…å­—å½¢æ›´é«˜ï¼Œé¢œè‰²æ›´æ·¡é›…ä¸€äº›ã€‚å¯èƒ½éœ€è¦é¢å¤–çš„é…ç½®ï¼Ÿè€ƒè™‘åˆ°é¡µé¢åŠ è½½é€Ÿåº¦ï¼Œæš‚ä¸”é€‰ç”¨ CDN åŠ é€Ÿç‰ˆæœ¬ã€‚

## å‚è€ƒæ–‡ç« 

- [ç¶²é æ˜¯å¦å®‰è£æ€æºé»‘é«”ã€ä¸­æ–‡å­—å‹çš„è€ƒé‡ï¹å½±éŸ¿è¼‰å…¥é€Ÿåº¦çš„å› ç´ åŠä½œæ³•åˆ†æ](https://www.wfublog.com/2019/01/noto-sans-serif-traditional-chinese-web-font_11.html)
</content:original-text><content:updated-at>2021-08-10T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[ä½¿ç”¨åŸºäº Docker çš„ Nginx éƒ¨ç½²é™æ€ç½‘é¡µé¡¹ç›®]]></title><description><![CDATA[ç°åœ¨ï¼Œæˆ‘å·²ç»å®‰è£…äº† Dockerï¼Œå¹¶æ‹‰å–äº† Nginx çš„é•œåƒã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä¹Ÿè´­ä¹°äº†åŸŸåï¼Œå®Œæˆäº†å¤‡æ¡ˆï¼Œå¹¶ä¸”ä¸ºåŸŸåé…ç½®äº† SSLã€‚ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œé‚£ä¹ˆæˆ‘è¯¥æ€ä¹ˆå°†æˆ‘çš„é™æ€ç½‘é¡µé¡¹ç›®åœ¨ Linux ä¸»æœºä¸Šé€šè¿‡ Nginx éƒ¨ç½²ï¼Œæœ€ç»ˆå®ç°åŸŸåè®¿é—®å‘¢ï¼Ÿ æœ¬æ–‡ä»¥éƒ¨ç½²æˆ‘çš„ä¸ªäººåšå®¢é¡µé¢ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨åŸºäº Docker çš„ Nginx éƒ¨ç½²é™æ€ç½‘é¡µé¡¹ç›®ã€‚

å‡†å¤‡é™æ€ç½‘é¡µé¡¹ç›®

ä¸ºäº†æ›´æ–¹ä¾¿ç®¡ç†ç½‘é¡µé¡¹ç›®â€¦]]></description><link>https://blog.towind.fun/posts/website-deployment-docker-nginx</link><guid isPermaLink="false">website-deployment-docker-nginx</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Fri, 25 Jun 2021 00:00:00 GMT</pubDate><content:original-text>
ç°åœ¨ï¼Œæˆ‘å·²ç»å®‰è£…äº† Dockerï¼Œå¹¶æ‹‰å–äº† Nginx çš„é•œåƒã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä¹Ÿè´­ä¹°äº†åŸŸåï¼Œå®Œæˆäº†å¤‡æ¡ˆï¼Œå¹¶ä¸”ä¸ºåŸŸåé…ç½®äº† SSLã€‚ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œé‚£ä¹ˆæˆ‘è¯¥æ€ä¹ˆå°†æˆ‘çš„é™æ€ç½‘é¡µé¡¹ç›®åœ¨ Linux ä¸»æœºä¸Šé€šè¿‡ Nginx éƒ¨ç½²ï¼Œæœ€ç»ˆå®ç°åŸŸåè®¿é—®å‘¢ï¼Ÿ

æœ¬æ–‡ä»¥éƒ¨ç½²æˆ‘çš„ä¸ªäººåšå®¢é¡µé¢ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨åŸºäº Docker çš„ Nginx éƒ¨ç½²é™æ€ç½‘é¡µé¡¹ç›®ã€‚

## å‡†å¤‡é™æ€ç½‘é¡µé¡¹ç›®

ä¸ºäº†æ›´æ–¹ä¾¿ç®¡ç†ç½‘é¡µé¡¹ç›®ï¼Œå¯ä»¥åœ¨ä¸»æœºæ ¹ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªç›®å½•ï¼Œä¾‹å¦‚ `www`ï¼š

```bash
sudo -i # åˆ‡æ¢ä¸ºç®¡ç†å‘˜ç”¨æˆ·
cd /
mkdir www
```

ç°åœ¨ï¼Œæˆ‘å·²ç»æœ‰äº†ä¸€ä¸ªå®Œæ•´çš„é™æ€ç½‘é¡µé¡¹ç›®â€”â€”æˆ‘çš„[ä¸ªäººåšå®¢](https://github.com/LolipopJ/LolipopJ.github.io)ã€‚æˆ‘çš„ä¸ªäººåšå®¢åŸºäº Hexoï¼Œå…¶ä¸­ä»£ç æ”¾åœ¨ `source` åˆ†æ”¯ï¼Œç”Ÿæˆçš„é™æ€ç½‘é¡µæ–‡ä»¶æ”¾åœ¨ `master` åˆ†æ”¯ã€‚é¦–å…ˆé€šè¿‡ `git` å‘½ä»¤å°†é™æ€ç½‘é¡µæ–‡ä»¶å…‹éš†ä¸‹æ¥ï¼š

```bash
cd /www
git clone https://github.com/LolipopJ/LolipopJ.github.io.git -b master
```

## å‡†å¤‡ SSL è¯ä¹¦

æˆ‘ä½¿ç”¨äº†è…¾è®¯äº‘æ‰§è¡Œäº†å¤‡æ¡ˆæ“ä½œï¼Œå¹¶ç”³è¯·äº†å…è´¹çš„ SSL è¯ä¹¦ã€‚å‚è€ƒ[è…¾è®¯äº‘å®˜æ–¹æ–‡æ¡£](https://cloud.tencent.com/document/product/400/35244)ï¼Œä¸‹é¢æ‰§è¡Œå®‰è£… SSL è¯ä¹¦æ“ä½œã€‚

å°†ä¸‹è½½çš„è¯ä¹¦æ–‡ä»¶ä¼ å…¥ Linux ä¸»æœºä¸­å¹¶è§£å‹ã€‚ä»¥ SSL è¯ä¹¦æ–‡ä»¶å‹ç¼©åŒ… `blog.towind.fun.zip` ä¸ºä¾‹ï¼š

```bash
# å°†æ–‡ä»¶è§£å‹åˆ°å½“å‰ç›®å½•ä¸‹çš„ blog.towind.fun ç›®å½•ä¸­
unzip blog.towind.fun.zip -d blog.towind.fun
```

å¯ä»¥å°† `blog.towind.fun/Nginx` ç›®å½•ä¸‹çš„æ–‡ä»¶æ”¾ç½®åˆ° `/www/cert` ç›®å½•ä¸‹ï¼š

```bash
mkdir /www/cert
cp blog.towind.fun/Nginx/* /www/cert
```

ä¹‹åï¼Œåªéœ€è¦å°† `/www/cert` ç›®å½•æŒ‚è½½åˆ° Nginx çš„å®¹å™¨ä¸­ï¼Œå†é€šè¿‡ Nginx é…ç½®è®¿é—®å³å¯ã€‚

## åˆ›å»º Nginx å®¹å™¨

ä» Nginx 1.19 ç‰ˆæœ¬å¼€å§‹ï¼Œå…è®¸åœ¨é…ç½®ä¸­è‡ªå®šä¹‰ç¯å¢ƒå˜é‡ï¼Œåªéœ€è¦ç¼–å†™ä¸€ä¸ª `docker-compose.yml` æ–‡ä»¶ã€‚`docker-compose` æ˜¯ç”¨æ¥å°† Docker è‡ªåŠ¨åŒ–çš„å‘½ä»¤ï¼Œå¦‚æœè¿˜æ²¡æœ‰ï¼Œéœ€è¦å…ˆå®‰è£…å®ƒï¼š

```bash
sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
```

å¯ä»¥ç”¨ `docker-compose --version` å‘½ä»¤æµ‹è¯•å®‰è£…çš„ç»“æœã€‚

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒNginx ä¼šå¯»æ‰¾å®¹å™¨çš„ `/usr/share/nginx/html` ç›®å½•ä¸‹çš„ç½‘é¡µæ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠç½‘é¡µæ–‡ä»¶æ”¾åˆ°è¿™ä¸ªç›®å½•ä¸‹å»ã€‚æœ€ç®€å•çš„æ–¹å¼æ˜¯é€šè¿‡æŒ‚è½½ volume ä½¿å¾—å®¹å™¨å¯ä»¥è®¿é—®åˆ°æˆ‘ä»¬çš„ `/www/LolipopJ.github.io` ç›®å½•ã€‚

åœ¨ `/www/LolipopJ.github.io` ç›®å½•ä¸‹åˆ›å»º `docker-compose.yml`ï¼Œç¼–è¾‘å¦‚ä¸‹ï¼š

```yml
version: &quot;1.0&quot;
services:
  blog:
    image: nginx:1.21.0
    container_name: blog-nginx
    restart: always
    volumes:
      - ./:/usr/share/nginx/html # æŒ‚è½½å½“å‰é™æ€ç½‘é¡µæ–‡ä»¶ç›®å½•
      - ./templates:/etc/nginx/templates # æŒ‚è½½ Nginx é…ç½®æ¨¡æ¿ç›®å½•
      - /www/cert:/etc/nginx/cert # æŒ‚è½½ SSL è¯ä¹¦ç›®å½•
    ports:
      - 80:80
      - 443:443
    environment:
      - NGINX_HOST=blog.towind.fun
      - NGINX_HOST_SSL_CRT=cert/1_blog.towind.fun_bundle.crt
      - NGINX_HOST_SSL_KEY=cert/2_blog.towind.fun.key
```

ç”±äº `nginx.conf` è¯»å–æ–‡ä»¶æ—¶ï¼Œé»˜è®¤ä»¥ `/etc/nginx` ä¸ºèµ·å§‹ç›®å½•ï¼Œå› æ­¤å½“æŠŠ `/www/cert` ç›®å½•æŒ‚è½½åˆ° `/etc/nginx/cert` ç›®å½•æ—¶ï¼Œåº”å½“è®¾ç½®ç¯å¢ƒå˜é‡ `NGINX_HOST_SSL_CRT` ä¸º `cert/1_www.example.com_bundle.crt`ã€‚

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰§è¡Œæ­¤æ–‡ä»¶åï¼Œå°†ä¼šè¯»å– `templates`ï¼ˆå¯¹åº”å®¹å™¨ä¸­çš„ `/etc/nginx/templates`ï¼‰ç›®å½•ä¸‹çš„æ¨¡æ¿æ–‡ä»¶ï¼Œå¹¶å°†ç»“æœè¾“å‡ºåˆ°å®¹å™¨ä¸­ `/etc/nginx/conf.d` ç›®å½•ä¸‹ã€‚å› æ­¤ï¼Œå¯ä»¥åœ¨ `/www/LolipopJ.github.io` ç›®å½•ä¸‹åˆ›å»º `templates` ç›®å½•ï¼Œå¹¶ç¼–å†™ `templates/default.conf.template` æ–‡ä»¶å¦‚ä¸‹ï¼š

```conf
server {
  listen 443 ssl;
  listen [::]:443 ssl;
  server_name ${NGINX_HOST};
  ssl_certificate ${NGINX_HOST_SSL_CRT};
  ssl_certificate_key ${NGINX_HOST_SSL_KEY};

  location / {
    root /usr/share/nginx/html;
    index index.html index.htm;
  }

  error_page 404 /404.html;

  error_page 500 502 503 504 /50x.html;
  location = /50x.html {
    root /usr/share/nginx/html;
  }
}

# å°† http è¯·æ±‚è½¬ä¸º https è¯·æ±‚
server {
  listen 80;
  listen [::]:80;
  server_name ${NGINX_HOST};
  return 301 https://$host$request_uri;
}
```

ç°åœ¨ï¼Œåœ¨ `/www/LolipopJ.github.io` ç›®å½•ä¸‹æœ‰æˆ‘ä»¬ç¼–å†™å¥½çš„ `docker-compose.yml` å’Œ `templates/default.conf.template` æ–‡ä»¶ï¼›å¦å¤–ï¼Œä¸ºéƒ¨ç½² https æœåŠ¡æ‰€éœ€çš„ ssl è¯ä¹¦æ–‡ä»¶åœ¨ `/www/cert` ç›®å½•ä¸‹ã€‚é‚£ä¹ˆæœ€ååªéœ€è¦åœ¨ `/www/LolipopJ.github.io` ç›®å½•æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯ï¼š

```bash
docker-compose up -d
```

å…¶ä¸­ï¼Œ`-d` è¡¨ç¤ºåœ¨åå°è¿è¡Œå®¹å™¨ã€‚æ‰§è¡Œåï¼Œå°†æ‹‰èµ· Nginx å®¹å™¨ï¼Œå¹¶åœ¨å®¹å™¨ä¸­ç”Ÿæˆå¯¹åº”çš„ `/etc/nginx/conf.d/default.conf` æ–‡ä»¶ï¼Œä¾› `/etc/nginx/nginx.conf` è¯»å–ã€‚

## ä»æµè§ˆå™¨è®¿é—®

å˜¿ï¼ä¸€åˆ‡å°±ç»ªï¼Œä»æµè§ˆå™¨è®¿é—®æˆ‘çš„åšå®¢å§ï¼ç½‘å€æ˜¯ï¼š[https://blog.towind.fun](https://blog.towind.fun/)

å½“æˆ‘çš„ä¸ªäººåšå®¢æœ‰æ›´æ–°æ—¶ï¼Œå¯ä»¥é€šè¿‡ `git` å‘½ä»¤æ¥æ‹‰å–ï¼Œç„¶åé‡æ–°æ‰§è¡Œ `docker-compose up -d` å³å¯ï¼š

```bash
cd /www/LolipopJ.github.io
git pull
docker-compose up -d
```

## å‚è€ƒæ–‡æ¡£

- [How To Use the Official NGINX Docker Image](https://www.docker.com/blog/how-to-use-the-official-nginx-docker-image/)
</content:original-text><content:updated-at>2021-06-25T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[åœ¨ Linux ç³»ç»Ÿä¸‹å¯ç”¨ Project-V]]></title><description><![CDATA[ä¸‹è½½ Release åœ¨ Project-V çš„ Github Releases é¡µé¢ä¸‹è½½æœ€æ–°çš„äºŒè¿›åˆ¶åŒ…ã€‚

æœ¬æ–‡ä»¥é€šç”¨äº x86_64 æœºå™¨çš„  ä¸ºä¾‹ã€‚ä¸‹è½½å®Œæˆåä¼ å…¥ Linux ä¸»æœºå³å¯ã€‚

å®‰è£… Project-V

æ‰§è¡Œ  å‘½ä»¤ï¼š

æ–‡ä»¶å°†å…¨éƒ¨è§£å‹åˆ°å½“å‰ç›®å½•ã€‚

åˆ›å»ºè½¯é“¾æ¥

æ‰§è¡Œ  å‘½ä»¤ï¼š

è¿™é‡Œçš„  æ˜¯å‹ç¼©åŒ…é‡Œå·²ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€‚

é…ç½® Project-V

ç¼–è¾‘ä¸  ç›¸åŒç›®å½•ä¸‹çš„  æ–‡ä»¶â€¦]]></description><link>https://blog.towind.fun/posts/linux-project-v</link><guid isPermaLink="false">linux-project-v</guid><category><![CDATA[åç«¯å¼€å‘]]></category><pubDate>Wed, 09 Jun 2021 00:00:00 GMT</pubDate><content:original-text>
## ä¸‹è½½ Release

åœ¨ Project-V çš„ [Github Releases](https://github.com/v2fly/v2ray-core/releases) é¡µé¢ä¸‹è½½æœ€æ–°çš„äºŒè¿›åˆ¶åŒ…ã€‚

æœ¬æ–‡ä»¥é€šç”¨äº x86_64 æœºå™¨çš„ `v2ray-linux-64.zip` ä¸ºä¾‹ã€‚ä¸‹è½½å®Œæˆåä¼ å…¥ Linux ä¸»æœºå³å¯ã€‚

## å®‰è£… Project-V

æ‰§è¡Œ `unzip` å‘½ä»¤ï¼š

```bash
unzip v2ray-linux-64.zip
```

æ–‡ä»¶å°†å…¨éƒ¨è§£å‹åˆ°å½“å‰ç›®å½•ã€‚

## åˆ›å»ºè½¯é“¾æ¥

æ‰§è¡Œ `ln` å‘½ä»¤ï¼š

```bash
ln -s /path/to/v2ray /usr/local/bin
```

è¿™é‡Œçš„ `v2ray` æ˜¯å‹ç¼©åŒ…é‡Œå·²ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€‚

## é…ç½® Project-V

ç¼–è¾‘ä¸ `v2ray` ç›¸åŒç›®å½•ä¸‹çš„ `config.json` æ–‡ä»¶ï¼Œé…ç½®å¦‚ä¸‹ï¼š

```json
{
  // å‰ç•¥
  // List of inbound proxy configurations.
  &quot;inbounds&quot;: [
    {
      // Port to listen on. You may need root access if the value is less than 1024.
      &quot;port&quot;: 1080, // æœ¬æœºç›‘å¬çš„ç«¯å£ï¼Œåº”ä¸ºä¸åŠ åŒå¼•å·çš„æ•°å­—

      // IP address to listen on. Change to &quot;0.0.0.0&quot; to listen on all network interfaces.
      &quot;listen&quot;: &quot;127.0.0.1&quot;,

      // Tag of the inbound proxy. May be used for routing.
      &quot;tag&quot;: &quot;socks-inbound&quot;,

      // Protocol name of inbound proxy.
      &quot;protocol&quot;: &quot;socks&quot;,

      // Settings of the protocol. Varies based on protocol.
      &quot;settings&quot;: {
        &quot;auth&quot;: &quot;noauth&quot;,
        &quot;udp&quot;: false,
        &quot;ip&quot;: &quot;127.0.0.1&quot;
      },

      // Enable sniffing on TCP connection.
      &quot;sniffing&quot;: {
        &quot;enabled&quot;: true,
        // Target domain will be overriden to the one carried by the connection, if the connection is HTTP or HTTPS.
        &quot;destOverride&quot;: [&quot;http&quot;, &quot;tls&quot;]
      }
    }
  ],
  // List of outbound proxy configurations.
  &quot;outbounds&quot;: [
    {
      // Protocol name of the outbound proxy.
      &quot;protocol&quot;: &quot;vmess&quot;, // ä½¿ç”¨çš„ä»£ç†åè®®

      // Settings of the protocol. Varies based on protocol.
      &quot;settings&quot;: {
        &quot;vnext&quot;: [
          {
            &quot;address&quot;: &quot;V2RAY_SERVER_ADDRESS&quot;, // ä»£ç†çš„æœåŠ¡å™¨åœ°å€
            &quot;port&quot;: 16823, // ä»£ç†æœåŠ¡å™¨çš„ç«¯å£ï¼Œåº”ä¸ºä¸åŠ åŒå¼•å·çš„æ•°å­—
            &quot;users&quot;: [
              {
                &quot;id&quot;: &quot;V2RAY_UUID&quot;, // ä»£ç†æœåŠ¡å™¨çš„ UUID
                &quot;alterId&quot;: 64 // ä»£ç†æœåŠ¡å™¨çš„ Alter Idï¼Œåº”ä¸ºä¸åŠ åŒå¼•å·çš„æ•°å­—
              }
            ]
          },
          {
            // æ·»åŠ æ›´å¤šçš„ VMESS åè®®ä»£ç†æœåŠ¡å™¨
          }
        ]
      },

      // Tag of the outbound. May be used for routing.
      &quot;tag&quot;: &quot;vmess_serve&quot;
    }
  ]
  // åç•¥
}
```

å¯¹äºæ–°æ‰‹ï¼Œåªéœ€è¦æŒæ¡ `inbounds` å’Œ `outbounds` çš„é…ç½®æ–¹å¼å³å¯ã€‚

å¯¹äºè¿›é˜¶ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://www.v2fly.org/)ï¼Œæˆ–è€…æ›´é€‚åˆæ–°æ‰‹çš„[â€œç™½è¯æ–‡â€æ–‡æ¡£](https://guide.v2fly.org/)ã€‚

## å¯ç”¨ Project-V

ä¿å­˜ä¿®æ”¹åï¼Œåœ¨åå°è¿è¡Œ `v2ray`ï¼š

```bash
v2ray &amp;
```

å¦‚æœå‚è€ƒå‰é¢çš„é»˜è®¤é…ç½®ï¼Œåˆ™å®ƒå°†ç›‘å¬åœ¨ `127.0.0.1:1080` ç«¯å£ã€‚

å‡å¦‚æ‚¨æƒ³åŠ é€Ÿ `git` å…‹éš†é€Ÿåº¦ï¼Œåˆ™å¯ä»¥é…ç½®å®ƒçš„ `http(s).proxy`ï¼š

```bash
git config --global http.proxy socks5://127.0.0.1:1080
git config --global https.proxy socks5://127.0.0.1:1080
```

ç°åœ¨ï¼Œä½¿ç”¨ `git clone` å‘½ä»¤äº«å—é£ä¸€èˆ¬çš„é€Ÿåº¦å§ã€‚
</content:original-text><content:updated-at>2021-06-09T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[åœ¨ Euler ç³»ç»Ÿä¸Šç¦»çº¿å®‰è£… MySQL 5.7]]></title><description><![CDATA[æŸ¥çœ‹ç³»ç»Ÿ OS åŠæ¶æ„ ä»¥ Euler ç³»ç»Ÿä¸ºä¾‹ï¼Œåœ¨ç»ˆç«¯ä¸Šè¾“å…¥å‘½ä»¤æŸ¥çœ‹ï¼Œå¯ä»¥é€šè¿‡  å‘½ä»¤æ‰¾åˆ° rpm åŒ…ï¼Œå†é€šè¿‡  æŸ¥çœ‹ç³»ç»Ÿ OS åŠæ¶æ„ä¿¡æ¯ï¼š

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€šç”¨çš„  å‘½ä»¤ã€‚

å½“å‰ç³»ç»Ÿä¸º Euler 2.0 (SP5)ï¼Œå¤„ç†å™¨æ¶æ„ä¸º x86_64ã€‚

ä¸‹è½½ MySQL

Euler 2.0 ç³»ç»ŸåŸºäº CentOS 7 å¼€å‘ï¼Œè€Œ CentOS 7 ç”± Red Hat Enterpriseâ€¦]]></description><link>https://blog.towind.fun/posts/euler-install-mysql</link><guid isPermaLink="false">euler-install-mysql</guid><category><![CDATA[åç«¯å¼€å‘]]></category><pubDate>Fri, 04 Jun 2021 00:00:00 GMT</pubDate><content:original-text>
## æŸ¥çœ‹ç³»ç»Ÿ OS åŠæ¶æ„

ä»¥ Euler ç³»ç»Ÿä¸ºä¾‹ï¼Œåœ¨ç»ˆç«¯ä¸Šè¾“å…¥å‘½ä»¤æŸ¥çœ‹ï¼Œå¯ä»¥é€šè¿‡ `rpm -qa | grep euleros-release` å‘½ä»¤æ‰¾åˆ° rpm åŒ…ï¼Œå†é€šè¿‡ `rpm -qi ${åŒ…å}` æŸ¥çœ‹ç³»ç»Ÿ OS åŠæ¶æ„ä¿¡æ¯ï¼š

```bash
[root@lolipop ~]# rpm -qa | grep euleros-release
euleros-release-2.0SP5-13.eulerosv2r7.x86_64
[root@lolipop ~]# rpm -qi euleros-release-2.0SP5-13.eulerosv2r7.x86_64
Name        : euleros-release
Version     : 2.0SP5
Release     : 13.eulerosv2r7
Architecture: x86_64
......
```

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€šç”¨çš„ `uname -a` å‘½ä»¤ã€‚

å½“å‰ç³»ç»Ÿä¸º Euler 2.0 \(SP5\)ï¼Œå¤„ç†å™¨æ¶æ„ä¸º x86_64ã€‚

## ä¸‹è½½ MySQL

Euler 2.0 ç³»ç»ŸåŸºäº CentOS 7 å¼€å‘ï¼Œè€Œ CentOS 7 ç”± Red Hat Enterprise Linux ä¾ç…§å¼€æ”¾æºä»£ç è§„å®šå‘å¸ƒçš„æºä»£ç æ‰€ç¼–è¯‘è€Œæˆã€‚å› æ­¤åœ¨[æ­¤é¡µé¢](https://downloads.mysql.com/archives/community/)ä¸‹è½½ MySQL çš„æ—¶å€™ï¼Œå…¶ä¸­çš„ Operating System é¡¹åº”é€‰æ‹© `Red Hat Enterprise Linux / Oracle Linux`ï¼ŒOS Version åº”é€‰æ‹© `Red Hat Enterprise Linux 7 / Oracle Linux 7 (x86, 64-bit)`ã€‚æ¥ä¸‹æ¥ï¼Œé€‰æ‹©ä¸‹è½½ `RPM Bundle` å³å¯ã€‚

ä¾‹å¦‚ï¼Œåœ¨æµè§ˆå™¨è®¿é—® `https://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.33-1.el7.x86_64.rpm-bundle.tar`ï¼Œå°†è‡ªåŠ¨å¼€å§‹ä¸‹è½½ MySQL 5.7.33 é€‚ç”¨äº Oracle Linux 7 çš„ x86_64 ç‰ˆæœ¬ã€‚

## å®‰è£… MySQL

å°†ä¸‹è½½å¥½çš„æ¡£æ¡ˆåŒ…ä¼ è¾“åˆ° Linux ä¸»æœºä¸Šæˆ– Docker å®¹å™¨é‡Œï¼Œè§£å‹ä¹‹ï¼š

```bash
tar -xvf mysql-5.7.33-1.el7.x86_64.rpm-bundle.tar
```

æŒ‰é¡ºåºå®‰è£…è¿™äº› rpm åŒ…ï¼š

```bash
rpm -ivh mysql-community-common-5.7.33-1.el7.x86_64.rpm
rpm -ivh mysql-community-libs-5.7.33-1.el7.x86_64.rpm
rpm -ivh mysql-community-client-5.7.33-1.el7.x86_64.rpm
rpm -ivh mysql-community-server-5.7.33-1.el7.x86_64.rpm
```

å…¶å®ƒçš„åŒ…å¹¶éå¿…é¡»ï¼Œè€Œæ˜¯å¼€å‘æ—¶å¯èƒ½ä¼šç”¨åˆ°çš„ï¼Œæš‚æ—¶å¿½ç•¥å³å¯ã€‚

## åˆå§‹åŒ– MySQL

åˆå§‹åŒ– MySQL æ•°æ®åº“ï¼š

```bash
mysqld -I
```

è¯¥å‘½ä»¤ä¼šåˆå§‹åŒ–é»˜è®¤æ•°æ®åº“å¹¶åˆ›å»ºä¸€ä¸ªæœ‰éšæœºå¯†ç çš„è¶…çº§ç”¨æˆ·ï¼Œå¯†ç ä¼šæ‰“å°åˆ° MySQL çš„æ—¥å¿—ä¸­ã€‚

å¦‚æœåˆå§‹åŒ–æ—¶å‡ºç° `Fatal error: Please read &quot;Security&quot; section of the manual to find out how to run mysqld as root!` æŠ¥é”™ï¼Œå¯ä»¥å¼ºåˆ¶ä½¿ç”¨ root æƒé™æ‰§è¡Œï¼š

```bash
mysqld -I --user=root
```

æ¥ä¸‹æ¥ï¼Œä¸ºç›®å½•ç§»é™¤å¯è¯»æƒé™ï¼Œè¿™æ˜¯å› ä¸º MySQL ä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œä¼šå¿½ç•¥åˆ°æƒé™è¿‡é«˜çš„æ–‡ä»¶ï¼š

```bash
chown -R mysql:mysql /var/lib/mysql
```

## å¯åŠ¨ MySQL æœåŠ¡

é…ç½®å®Œæˆåï¼Œå°±å¯ä»¥å¯åŠ¨ MySQL æœåŠ¡äº†ï¼š

```bash
service mysqld start
```

ç¡®ä¿å¯åŠ¨æˆåŠŸï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤æŸ¥çœ‹ MySQL æœåŠ¡çš„çŠ¶æ€ï¼š

```bash
service mysqld status
```

## ç™»å½• MySQL

åœ¨ä¹‹å‰çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªè¶…çº§ç”¨æˆ·å’Œå®ƒçš„éšæœºç™»å½•å¯†ç ã€‚å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹è¿™ä¸ªéšæœºå¯†ç ï¼š

```bash
grep -n &apos;password&apos; /var/log/mysqld.log
```

ä¾‹å¦‚ï¼Œæ‰“å°ç»“æœå¦‚ä¸‹ï¼š

```bash
Storage:~ # grep -n &apos;password&apos; /var/log/mysqld.log
7:2021-06-02T07:50:39.284449Z 1 [Note] A temporary password is generated for root@localhost: IN2Scm=ERki9
```

åˆ™é»˜è®¤çš„éšæœºå¯†ç ä¸ºï¼š`IN2Scm=ERki9`ï¼Œæ‚¨åº”å½“ä¿ç®¡å¥½æ­¤å¯†ç ä¸è¦æ³„éœ²ï¼Œæˆ–æ˜¯ä¿®æ”¹ä¸ºæ–°çš„å¯†ç ã€‚

ä½¿ç”¨è¿™ä¸ªå¯†ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç™»å½•åˆ° MySQL ä¸­å»äº†ï¼š

```bash
Storage:~ # mysql -uroot -pIN2Scm=ERki9
mysql: [Warning] Using a password on the command line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.33 MySQL Community Server (GPL)

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.

mysql&gt;
```

æ­¤æ—¶å·²ç»å¯ä»¥æ­£å¸¸æ‰§è¡Œ MySQL æ•°æ®åº“æ“ä½œäº†ã€‚

å‡å¦‚éœ€è¦ä¿®æ”¹å¯†ç ï¼Œå¯ä»¥æ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼š

```sql
mysql&gt; ALTER USER &apos;root&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;${æ–°çš„å¯†ç }&apos;;
```

&gt; æ³¨æ„ï¼Œæ–°çš„å¯†ç é»˜è®¤æƒ…å†µä¸‹éœ€è¦ç¬¦åˆé•¿åº¦ï¼Œä¸”å¿…é¡»åŒ…æ‹¬æ•°å­—ï¼Œå°å†™æˆ–å¤§å†™å­—æ¯ï¼Œä»¥åŠç‰¹æ®Šå­—ç¬¦ã€‚
&gt; å°½ç®¡ä¸æ¨èï¼Œæ‚¨ä¹Ÿå¯ä»¥è®¾ç½®å¯†ç å¤æ‚åº¦å±æ€§ï¼Œè¿™æ ·å¯†ç åªéœ€è¦æ»¡è¶³é•¿åº¦è¦æ±‚å³å¯ä½¿ç”¨ï¼š`SET GLOBAL validate_password_policy=0;`

## æˆæƒ MySQL è¿œç¨‹è¿æ¥

ç™»å½•åˆ° MySQL ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```sql
mysql&gt; GRANT all privileges ON *.* TO &apos;root&apos;@&apos;%&apos; IDENTIFIED BY &apos;${æ‚¨çš„å¯†ç }&apos;;
```

ç°åœ¨ä¾¿å¯ä»¥ä½¿ç”¨å…¶å®ƒè®¾å¤‡è¿œç¨‹è¿æ¥ MySQL æ•°æ®åº“äº†ã€‚
</content:original-text><content:updated-at>2021-07-29T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[æ¼«è°ˆ JavaScript ç±»ï¼ˆClassï¼‰çš„ä½¿ç”¨]]></title><description><![CDATA[ç±»ï¼ˆClassï¼‰æ˜¯ç”¨äºåˆ›å»ºå¯¹è±¡çš„æ¨¡æ¿ï¼Œä»–ä»¬ç”¨ä»£ç å°è£…æ•°æ®ä»¥å¤„ç†è¯¥æ•°æ®ï¼Œæ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹æ–¹æ³•çš„é‡è¦ç‰¹æ€§ä¹‹ä¸€ã€‚JavaScript ä¸­çš„  è¯­æ³•åœ¨ ES6 ä¸­å¼•å…¥ï¼Œå…¶åº•å±‚å®ç°åŸºäºåŸå‹ï¼ˆPrototypeï¼‰ï¼Œç³»åŸå‹ç»§æ‰¿çš„è¯­æ³•ç³–ï¼ˆSyntactic Sugarï¼‰ã€‚ æœ¬åšæ–‡å°†æ¢è®¨ JavaScript ä¸­å¦‚ä½•ä½¿ç”¨ç±»çš„ç›¸å…³çŸ¥è¯†ï¼Œæ–‡ç« ç»„ç»‡æ¶æ„å’Œå†…å®¹åŸºäº MDN ä¸Šå…³äºç±»çš„ç« èŠ‚ã€‚

å®šä¹‰ç±»

ç±»å¯ä»¥è¢«çœ‹ä½œä¸€ç§â€¦]]></description><link>https://blog.towind.fun/posts/js-use-class</link><guid isPermaLink="false">js-use-class</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Thu, 20 May 2021 00:00:00 GMT</pubDate><content:original-text>
ç±»ï¼ˆClassï¼‰æ˜¯ç”¨äºåˆ›å»ºå¯¹è±¡çš„æ¨¡æ¿ï¼Œä»–ä»¬ç”¨ä»£ç å°è£…æ•°æ®ä»¥å¤„ç†è¯¥æ•°æ®ï¼Œæ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹æ–¹æ³•çš„é‡è¦ç‰¹æ€§ä¹‹ä¸€ã€‚JavaScript ä¸­çš„ `class` è¯­æ³•åœ¨ ES6 ä¸­å¼•å…¥ï¼Œå…¶åº•å±‚å®ç°åŸºäºåŸå‹ï¼ˆPrototypeï¼‰ï¼Œç³»åŸå‹ç»§æ‰¿çš„è¯­æ³•ç³–ï¼ˆSyntactic Sugarï¼‰ã€‚

æœ¬åšæ–‡å°†æ¢è®¨ JavaScript ä¸­**å¦‚ä½•ä½¿ç”¨ç±»**çš„ç›¸å…³çŸ¥è¯†ï¼Œæ–‡ç« ç»„ç»‡æ¶æ„å’Œå†…å®¹åŸºäº MDN ä¸Šå…³äºç±»çš„[ç« èŠ‚](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes)ã€‚

## å®šä¹‰ç±»

ç±»å¯ä»¥è¢«çœ‹ä½œä¸€ç§â€œç‰¹æ®Šçš„å‡½æ•°â€ï¼Œå’Œå‡½æ•°çš„å®šä¹‰æ–¹æ³•ä¸€æ ·ï¼Œç±»çš„å®šä¹‰æ–¹æ³•æœ‰ä¸¤ç§ï¼š**ç±»å£°æ˜**å’Œ**ç±»è¡¨è¾¾å¼**ã€‚

ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ï¼Œç›´æ¥ä½¿ç”¨ `class` å…³é”®å­—å£°æ˜ç±»ï¼Œå³**ç±»å£°æ˜**çš„æ–¹æ³•ã€‚

```js
class User {
  //
}
```

ä½†æ˜¯ï¼Œä¸å‡½æ•°å£°æ˜ä¸åŒçš„æ˜¯ï¼Œä½¿ç”¨ç±»å£°æ˜çš„æ–¹å¼**ä¸ä¼šæå‡**ã€‚è¿™æ„å‘³ç€å¿…é¡»å…ˆå£°æ˜ç±»ï¼Œå†ä½¿ç”¨å®ƒã€‚

```js
const u = new User(); // Uncaught ReferenceError: User is not defined

class User {
  //
}
```

å¦ä¸€ç§æ–¹æ³•æ˜¯ï¼Œå°† `class` å£°æ˜çš„ç±»èµ‹å€¼ç»™å˜é‡ï¼Œå³**ç±»è¡¨è¾¾å¼**çš„æ–¹æ³•ã€‚ç±»è¡¨è¾¾å¼å¯ä»¥å‘½åæˆ–åŒ¿åï¼Œå…¶ä¸­ï¼Œå‘½åç±»è¡¨è¾¾å¼çš„åç§°ï¼ˆç±»çš„ `name` å±æ€§ï¼‰æ˜¯è¯¥ç±»ä½“çš„å±€éƒ¨åç§°ã€‚

```js
// åŒ¿åç±»
let User = class {
  //
};
console.log(User.name); // User

// å‘½åç±»
let User = class Admin {
  //
};
console.log(User.name); // Admin
```

åŒæ ·ï¼Œä½¿ç”¨ç±»è¡¨è¾¾å¼çš„æ–¹å¼ä¹Ÿ**ä¸ä¼šæå‡**ã€‚

å®šä¹‰ç±»ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ `new` å…³é”®å­—å®ä¾‹åŒ–ç±»äº†ã€‚

```js
const u = new User();
```

## æ„é€ å‡½æ•°

`constructor()` æ–¹æ³•æˆ–**æ„é€ å‡½æ•°**ï¼Œæ˜¯ç”¨äºåˆ›å»ºå’Œåˆå§‹åŒ–ä¸€ä¸ªç”± `class` åˆ›å»ºçš„å¯¹è±¡çš„ç‰¹æ®Šæ–¹æ³•ï¼Œä¸€ä¸ªç±»åªèƒ½æ‹¥æœ‰ä¸€ä¸ª `constructor()` æ–¹æ³•ã€‚

å¦‚æœä¸€ä¸ªç±»ä¸­æœ‰æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆæ‰§è¡Œ `new` åˆ›å»ºå®ä¾‹æ—¶ï¼Œå°†è°ƒç”¨è¿™ä¸ªæ„é€ å‡½æ•°ã€‚

```js
class User {
  // æ„é€ å‡½æ•°
  constructor(name, gender) {
    this.name = name;
    this.gender = gender;
  }
}

const u = new User(&quot;Ming&quot;, &quot;Male&quot;); // åˆå§‹åŒ–å¯¹è±¡
console.log(u.name, u.gender); // Ming Male

const u2 = new User(&quot;Xiao&quot;); // åˆå§‹åŒ–èµ‹å€¼å‚æ•°å°‘äºæ„é€ å‡½æ•°å‚æ•°æ—¶
console.log(u2.name, u2.gender); // Xiao undefined
```

å¯¹äº `new` åˆ›å»ºå®ä¾‹æ—¶çš„æ¯ä¸ªå‚æ•°ï¼Œå°†ä¾æ¬¡èµ‹å€¼ç»™æ„é€ å‡½æ•°ã€‚å¤šä½™çš„å‚æ•°å°†è¢«å¿½ç•¥ã€‚

ç‰¹åˆ«çš„ï¼ŒES6 è§„å®šï¼Œå­ç±»çš„ `constructor()` ä¸­å¿…é¡»ä½¿ç”¨ `super()` è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚ä¸€ä¸ªåˆæ³•çš„ä¾‹å­ï¼š

```js
class User {
  constructor(name, gender) {
    this.name = name;
    this.gender = gender;
  }
}

// ä½¿ç”¨ extends åˆ›å»º User çš„å­ç±» Admin
class Admin extends User {
  constructor(name, gender, openId) {
    super(name, gender); // è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°
    this.openId = openId;
  }
}

const a = new Admin(&quot;Ming&quot;, &quot;Male&quot;, &quot;xxx489&quot;);
console.log(a.name, a.gender, a.openId); // Ming Male xxx489
```

## åŸå‹æ–¹æ³•

åœ¨ç±»ä½“ä¸­å¯ä»¥å£°æ˜å‡½æ•°æ–¹æ³•ã€‚ä»åº•å±‚å®ç°æ¥çœ‹ï¼Œè¿™äº›æ–¹æ³•å°†ä¼šåœ¨å¯¹è±¡çš„åŸå‹é“¾ä¸Šå®šä¹‰å‡ºæ¥ï¼Œæ•…ç§°ä½œ**åŸå‹æ–¹æ³•**ã€‚

```js
class Rectangle {
  // Field declarations
  log = []; // æ—¥å¿—å±æ€§
  // Constructor
  constructor(height, width) {
    this.height = height;
    this.width = width;
  }
  // Getter è·å–å½“å‰çš„é¢ç§¯
  get area() {
    return this.calcArea();
  }
  // Setter ä¿®æ”¹ height å±æ€§æ—¶æ·»åŠ æ—¥å¿—
  set height(h) {
    this._height = h; // å¦‚æœä¸º this.height = h ä¼šå¾ªç¯è°ƒç”¨è¿™ä¸ª Setterï¼Œå‘ç”Ÿå †æ ˆæº¢å‡º
    this.log.push(`set height: ${h}`);
  }
  // Setter ä¿®æ”¹ width å±æ€§æ—¶æ·»åŠ æ—¥å¿—
  set width(w) {
    this._width = w;
    this.log.push(`set width: ${w}`);
  }
  // Method è®¡ç®—å½“å‰çš„é¢ç§¯
  calcArea() {
    return this._height * this._width;
  }
}

const rec = new Rectangle(5, 10);
console.log(rec.log); // [&quot;set height: 5&quot;, &quot;set width: 10&quot;]
console.log(rec.area); // 50

rec.height = 10;
rec.width = 20;
console.log(rec.log); // [&quot;set height: 5&quot;, &quot;set width: 10&quot;, &quot;set height: 10&quot;, &quot;set width: 20&quot;]
console.log(rec.area); // 200
```

ä¸Šé¢çš„ç±»ä¸­å®šä¹‰è®¡ç®—å½“å‰é¢ç§¯çš„æ–¹æ³• `calcArea()` æ—¶ï¼Œä½¿ç”¨äº† ES6 å¼•å…¥çš„[æ›´ç®€çŸ­çš„å®šä¹‰è¯­æ³•](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Method_definitions)ï¼Œè¿™ç§è¯­æ³•ä¸ Setter å’Œ Getter çš„è¯­æ³•ç›¸ä¼¼ï¼Œå®ƒç›´æ¥å°†æ–¹æ³•åèµ‹å€¼ç»™äº†å‡½æ•°ã€‚

æ­¤å¤–ï¼Œç”±äº Setter çš„ç‰¹æ€§ï¼Œå½“æˆ‘ä»¬åœ¨æ„é€ å‡½æ•°æ‰§è¡Œèµ‹å€¼æ“ä½œï¼Œä»¥åŠä¹‹åä¿®æ”¹å®ä¾‹çš„å±æ€§æ—¶ï¼Œå°†è°ƒç”¨ Setter çš„æ–¹æ³•ï¼ˆå³ Hook å‡½æ•°ï¼‰ã€‚å› æ­¤åœ¨ä¸Šé¢ä»£ç ä¸­çš„ `rec` å®ä¾‹ä¸­ï¼Œå¹¶ä¸å­˜åœ¨ `height` å’Œ `width` å±æ€§ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ `_height` å’Œ `_width` å±æ€§ã€‚

## é™æ€æ–¹æ³•å’Œå±æ€§

åœ¨ç±»çš„æ–¹æ³•å‰é¢æ·»åŠ å…³é”®å­— `static` å¯ä»¥å®šä¹‰**é™æ€æ–¹æ³•**æˆ–**é™æ€å±æ€§**ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡ç±»ç›´æ¥è°ƒç”¨ï¼Œä½†ä¸èƒ½é€šè¿‡ç±»çš„å®ä¾‹è°ƒç”¨ã€‚é™æ€æ–¹æ³•å’Œé™æ€å±æ€§å¸¸ç”¨äºä¸ºä¸€ä¸ªä½¿ç”¨ç±»çš„åº”ç”¨ç¨‹åºåˆ›å»ºå·¥å…·å‡½æ•°ã€‚

```js
class Point {
  constructor(x, y) {
    this.x = x;
    this.y = y;
  }

  // å®šä¹‰ Point ç±»çš„é™æ€å±æ€§
  static className = &quot;Point&quot;;

  // å®šä¹‰ Point ç±»çš„é™æ€æ–¹æ³•
  static distance(a, b) {
    const dx = a.x - b.x;
    const dy = a.y - b.y;
    return Math.hypot(dx, dy); // Math.hypot() è¿”å›æ‰€æœ‰å‚æ•°çš„å¹³æ–¹å’Œçš„å¹³æ–¹æ ¹ï¼Œåœ¨æ­¤å¤„ç”¨äºæ±‚ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»
  }
}

const p1 = new Point(5, 5);
const p2 = new Point(10, 10);

console.log(p1.className); // undefined
console.log(p1.distance); // undefined

console.log(Point.className); // Point
console.log(Point.distance(p1, p2)); // 7.0710678118654755
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨å®ä¾‹è®¿é—®é™æ€æ–¹æ³•å’Œå±æ€§æ—¶ï¼Œä¼šæ˜¾ç¤º `undefined`ã€‚è€Œå½“æˆ‘ä»¬ä½¿ç”¨ç±»æ¥è®¿é—®æ—¶ï¼Œåˆ™èƒ½æ­£å¸¸è°ƒç”¨äº†ã€‚

## åŸå‹æ–¹æ³•å’Œé™æ€æ–¹æ³•ä¸­çš„ `this`

å½“è°ƒç”¨é™æ€æˆ–åŸå‹æ–¹æ³•æ—¶æ²¡æœ‰æŒ‡å®š `this` æ‰€å±çš„ä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆå°†è¿”å› `undefined`ã€‚è¿™æ˜¯å› ä¸º `class` å†…éƒ¨çš„ä»£ç **æ€»æ˜¯åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹æ‰§è¡Œ**ã€‚

```js
class MyClass {
  getThis() {
    return this;
  }
  static getStaticThis() {
    return this;
  }
}

const getClassStaticThis = MyClass.getStaticThis;
console.log(MyClass.getStaticThis()); // MyClass ç±»
console.log(getClassStaticThis()); // undefined

const obj = new MyClass();
const getObjThis = obj.getThis;
console.log(obj.getThis()); // obj å®ä¾‹å¯¹è±¡
console.log(getObjThis()); // undefined
```

ä½œä¸ºå¯¹æ¯”ï¼Œå°†ä¸Šé¢çš„ä»£ç ä½¿ç”¨ä¼ ç»Ÿçš„åŸºäºå‡½æ•°çš„è¯­æ³•å®ç°ã€‚åœ¨**éä¸¥æ ¼æ¨¡å¼**ä¸‹ï¼Œè‹¥æ²¡æœ‰æŒ‡å®š `this` æ‰€å±çš„ä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆå°†æŒ‡å‘å…¨å±€å¯¹è±¡ã€‚

```js
function MyClass() {}
MyClass.prototype.getThis = function () {
  return this;
};
// æ¨¡æ‹Ÿ Class çš„ static æ–¹æ³•
MyClass.getStaticThis = function () {
  return this;
};

const getClassStaticThis = MyClass.getStaticThis;
console.log(MyClass.getStaticThis()); // MyClass å‡½æ•°
console.log(getClassStaticThis()); // global object

const obj = new MyClass();
const getObjThis = obj.getThis;
console.log(obj.getThis()); // obj å®ä¾‹å¯¹è±¡
console.log(getObjThis()); // global object
```

`this` ä¸€ç›´æ˜¯ JavaScript è¯­è¨€æœ€ä»¤äººå›°æƒ‘çš„ç‰¹æ€§ä¹‹ä¸€ï¼Œæ‚¨å¯ä»¥é˜…è¯»ä¸ä¹‹ç›¸å…³çš„æ–‡ç« è¿›ä¸€æ­¥ç†è§£ã€‚

## ç”Ÿæˆå™¨æ–¹æ³•

ç”Ÿæˆå™¨æ˜¯ ES6 æ–°å¢çš„é«˜çº§ç‰¹æ€§ï¼Œå…è®¸å®šä¹‰ä¸€ä¸ªéè¿ç»­æ‰§è¡Œçš„å‡½æ•°ä½œä¸ºè¿­ä»£ç®—æ³•ï¼Œæ˜¯æ›¿ä»£è¿­ä»£å™¨ï¼ˆIteratorï¼‰çš„é€‰æ‹©ã€‚

ç”Ÿæˆå™¨å‡½æ•°ä½¿ç”¨ `function*` è¯­æ³•å®šä¹‰ï¼Œä¾‹å¦‚ `function* anyGenerator() {}`ã€‚åœ¨ç±»ä¸­å¯¹åº”æ›´ç®€çŸ­çš„è¯­æ³•ï¼Œå°†ç¬¦å· `*` æ”¾åœ¨æ–¹æ³•åå‰é¢å³å¯ï¼Œä¾‹å¦‚ `*anyGenerator() {}`ã€‚

```js
class Polygon {
  constructor(...sides) {
    this.sides = sides;
  }

  // å®šä¹‰ç”Ÿæˆå™¨æ–¹æ³•
  *getSides() {
    for (const side of this.sides) {
      yield side;
    }
  }
}

const pentagon = new Polygon(1, 2, 3, 4, 5);
console.log([...pentagon.getSides()]); // [1,2,3,4,5]
```

å…³äºç”Ÿæˆå™¨çš„æ›´å¤šä»‹ç»å¯å‚è€ƒ[æ­¤é¡µé¢](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators)ã€‚

## ç®­å¤´å‡½æ•°å®šä¹‰æ–¹æ³•

ç±»ä¸­è¿˜æœ‰ä¸€ç§å¸¸è§çš„å®šä¹‰æ–¹æ³•çš„æ–¹å¼ï¼šä½¿ç”¨**ç®­å¤´å‡½æ•°**ã€‚

```js
class Rectangle {
  // ä½¿ç”¨ç®­å¤´å‡½æ•°å®šä¹‰åŸå‹æ–¹æ³•
  calcArea = () =&gt; {
    return this.height * this.width;
  };
}
```

å­ç±»ç»§æ‰¿çˆ¶ç±»çš„ç®­å¤´å‡½æ•°å®šä¹‰çš„æ–¹æ³•æ—¶ï¼Œä¼šå‡ºç°**å±æ€§é®è”½ï¼ˆProperty Shadowingï¼‰**çš„ç°è±¡ã€‚ç¼–å†™ä»£ç å¦‚ä¸‹ï¼š

```js
class Father {
  sayHello = () =&gt; {
    console.log(&quot;I am your father.&quot;);
  };
}

class Child extends Father {
  sayHello() {
    console.log(&quot;I am a child.&quot;);
    super.sayHello();
  }
}

const child = new Child();
child.sayHello(); // I am your father.
```

ä¸Šé¢çš„ä»£ç å¹¶æ²¡æœ‰åƒæˆ‘ä»¬é¢„æƒ³çš„é‚£æ ·ï¼Œä¾æ¬¡æ‰“å°å‡º `I am a child.` å’Œ `I am your father.`ï¼Œè€Œæ˜¯åªæ‰“å°å‡ºäº† `I am your father.`ã€‚

ç®€å•è§£é‡ŠåŸå› çš„è¯å°±æ˜¯ï¼Œç®­å¤´å‡½æ•°å®šä¹‰çš„æ–¹æ³•å°†æŒ‚è½½åˆ°**å®ä¾‹çš„å±æ€§**ä¸Šï¼Œè€Œæ™®é€šå‡½æ•°å®šä¹‰çš„æ–¹æ³•æŒ‚è½½åˆ°**åŸå‹é“¾**ä¸Šã€‚è¿™æ ·ï¼Œå½“æˆ‘ä»¬å®ä¾‹åŒ– `child` å¯¹è±¡æ—¶ï¼Œä¼šå°†åŸå‹ `Child` ä»è‡ªå·±çš„çˆ¶ç±» `Father` ç»§æ‰¿çš„ `sayHello()` æ–¹æ³•åˆ™æŒ‚è½½åˆ°è‡ªèº«çš„å±æ€§ä¸Šã€‚

å›å¿†ä¸€ä¸‹è¿‡å»å­¦è¿‡çš„çŸ¥è¯†ï¼Œå½“æˆ‘ä»¬å°è¯•è°ƒç”¨å®ä¾‹çš„æ–¹æ³•æ—¶ï¼ŒJavaScript ä¼šé¦–å…ˆåœ¨å®ä¾‹çš„å±æ€§ä¸ŠæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨æ­¤æ–¹æ³•ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è°ƒç”¨ï¼Œå¦‚æœä¸å­˜åœ¨å†åœ¨åŸå‹é“¾ä¸ŠæŸ¥æ‰¾ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬è°ƒç”¨å®ä¾‹ `child` çš„ `sayHello()` æ–¹æ³•æ—¶ï¼ŒJavaScript æ‰¾åˆ°äº†å±æ€§ä¸Šçš„ `sayHello()` æ–¹æ³•ï¼Œé‚ç»“æŸäº†æŸ¥æ‰¾å¹¶è°ƒç”¨ã€‚

è¯¦ç»†å†…å®¹å¯ä»¥å‚è€ƒ[è¿™ç¯‡åšå®¢](https://github.com/dwqs/blog/issues/67#issue-327371697)ã€‚

åœ¨ç±»ä¸­ï¼Œç›´æ¥ä½¿ç”¨ `=` çš„å£°æ˜ä»æœ¬è´¨ä¸Šè€Œè¨€å°±æ˜¯ [Field Declarations](https://github.com/tc39/proposal-class-fields#field-declarations) çš„è¯­æ³•ï¼Œç›¸å½“äº**ç›´æ¥å£°æ˜äº†ä¸€ä¸ªå®ä¾‹çš„å±æ€§**ã€‚åœ¨æ¥ä¸‹æ¥çš„[å­—æ®µå£°æ˜](#å­—æ®µå£°æ˜)å°èŠ‚ä¸­ï¼Œä¹Ÿä½¿ç”¨åˆ°äº†è¿™ä¸ªè¯­æ³•ã€‚

## å­—æ®µå£°æ˜

### å…¬æœ‰å­—æ®µå£°æ˜

åœ¨ç±»ä¸­å¯ä»¥å£°æ˜å…¬æœ‰å­—æ®µï¼Œä½¿å¾—ç±»å®šä¹‰å…·æœ‰è‡ªæˆ‘è®°å½•æ€§ï¼Œä¸”è¿™äº›å­—æ®µå°†å§‹ç»ˆå­˜åœ¨ã€‚å­—æ®µçš„å£°æ˜å¯ä»¥è®¾ç½®åˆå§‹å€¼ã€‚

```js
class Point {
  x; // å…¬æœ‰å­—æ®µ x
  y = 0; // å…¬æœ‰å­—æ®µ yï¼Œåˆå§‹å€¼ä¸º 0
  constructor(x, y) {
    this.x = x;
    this.y = y;
  }
  get position() {
    return [this.x, this.y];
  }
}

console.log(new Point(5, 10).position); // [5, 10]
```

### ç§æœ‰å­—æ®µå£°æ˜

åœ¨å£°æ˜çš„å­—æ®µå‰é¢åŠ ä¸Š `#` è¡¨æ˜ä¸ºç§æœ‰å­—æ®µã€‚ç§æœ‰å­—æ®µåŒæ ·å¯ä»¥è®¾ç½®åˆå§‹å€¼ã€‚

```js
class Point {
  #x; // ç§æœ‰å­—æ®µ x
  #y = 0; // ç§æœ‰å­—æ®µ yï¼Œåˆå§‹å€¼ä¸º 0
  constructor(x, y) {
    this.#x = x;
    this.#y = y;
  }
  get position() {
    return [this.#x, this.#y];
  }
}

console.log(new Point(10, 5).position); // [10, 5]
```

ä¸å…¬æœ‰å­—æ®µä¸åŒçš„æ˜¯ï¼š

- ä¸èƒ½ä»ç±»å¤–éƒ¨å¼•ç”¨ç§æœ‰å­—æ®µã€‚æˆ–ç§æœ‰å­—æ®µåœ¨ç±»å¤–éƒ¨ä¸å¯è§ã€‚
- ç§æœ‰å­—æ®µä»…èƒ½åœ¨å­—æ®µå£°æ˜ä¸­é¢„å…ˆå®šä¹‰ã€‚
- åœ¨å®ä¾‹åˆ›å»ºä¹‹åï¼Œä¸èƒ½å†é€šè¿‡èµ‹å€¼æ¥åˆ›å»ºç§æœ‰å­—æ®µã€‚

```js
class Point {
  name = &quot;point&quot;;
  #x;
  #y = 0;
  // #z // å‡å¦‚ä¸åœ¨è¿™é‡Œæ˜¾å¼å£°æ˜ #z
  constructor(x, y, z) {
    this.#x = x;
    this.#y = y;
    // this.#z = z // Uncaught SyntaxError: Private field &apos;#z&apos; must be declared in an enclosing class
  }
  get position() {
    return [this.#x, this.#y];
  }
  get position3D() {
    // return [this.#x, this.#y, this.#z] // Uncaught SyntaxError: Private field &apos;#z&apos; must be declared in an enclosing class
  }
}

const p = new Point(10, 5, 15);
p.name = &quot;point3D&quot;; // å®ä¾‹å¯ä»¥é€šè¿‡èµ‹å€¼ä¿®æ”¹å…¬æœ‰å­—æ®µ
console.log(p.name); // point3D
p.#x = 20; // å®ä¾‹ä¸å¯é€šè¿‡èµ‹å€¼ä¿®æ”¹ç§æœ‰å­—æ®µï¼ŒUncaught SyntaxError: Private field &apos;#x&apos; must be declared in an enclosing class
console.log(p.#x); // å®ä¾‹ä¸å¯åœ¨å¤–éƒ¨è®¿é—®ç§æœ‰å­—æ®µï¼ŒUncaught SyntaxError: Private field &apos;#x&apos; must be declared in an enclosing class
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°è¯•åœ¨ç±»ä¸­ä¸æ˜¾å¼å£°æ˜ç§æœ‰å­—æ®µ `#z` çš„æƒ…å†µä¸‹ï¼Œè®¿é—® `#z`ï¼Œç»“æœä¼šæŠ›å‡º `SyntaxError`ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å°è¯•åœ¨å®ä¾‹ä¸­ç›´æ¥å¯¹ç§æœ‰å­—æ®µ `#x` è¿›è¡Œèµ‹å€¼å’Œè·å–æ“ä½œï¼Œä¹Ÿä¼šæŠ›å‡º `SyntaxError`ã€‚

## ä½¿ç”¨ `extends` æ‹“å±•å­ç±»

`extends` å¯ä»¥ç”¨æ¥åˆ›å»ºå­ç±»ï¼Œçˆ¶ç±»å¯ä»¥æ˜¯è‡ªå·±å®šä¹‰çš„æ™®é€šç±»ï¼Œä¹Ÿå¯ä»¥æ˜¯å†…å»ºå¯¹è±¡ã€‚å¯¹äºåè€…ï¼Œä»¥ç»§æ‰¿å†…å»ºçš„ `Date` å¯¹è±¡ä¸ºä¾‹ï¼š

```js
class MyDate extends Date {
  constructor() {
    // å¿…é¡»è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œå¦åˆ™ä¼šæŠ¥é”™
    super();
  }

  // å®šä¹‰å­ç±»çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥è·å–æ ¼å¼åŒ–åçš„æ—¥æœŸ
  getFormattedDate() {
    const months = [
      &quot;Jan&quot;,
      &quot;Feb&quot;,
      &quot;Mar&quot;,
      &quot;Apr&quot;,
      &quot;May&quot;,
      &quot;Jun&quot;,
      &quot;Jul&quot;,
      &quot;Aug&quot;,
      &quot;Sep&quot;,
      &quot;Oct&quot;,
      &quot;Nov&quot;,
      &quot;Dec&quot;,
    ];
    return (
      this.getDate() +
      &quot; - &quot; +
      months[this.getMonth()] +
      &quot; - &quot; +
      this.getFullYear()
    );
  }
}

console.log(new MyDate().getFormattedDate()); // 20 - May - 2021
```

ç±»ä¸è¿‡æ˜¯ä¸€ç§è¯­æ³•ç³–ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ `extends` æ¥ç»§æ‰¿ä¼ ç»Ÿçš„åŸºäºå‡½æ•°çš„â€œç±»â€ï¼š

```js
// å®šä¹‰ Animal â€œç±»â€
function Animal(name) {
  this.name = name;
}
Animal.prototype.speak = function () {
  console.log(this.name + &quot; makes a noise.&quot;);
};

// ä½¿ç”¨ extends æ‹“å±• Animal â€œç±»â€
class Dog extends Animal {
  speak() {
    super.speak();
    console.log(this.name + &quot; barks.&quot;);
  }
}

const d = new Dog(&quot;Mitzie&quot;);
d.speak();
// Mitzie makes a noise.
// Mitzie barks.
```

å¯¹äº**ä¸å¯æ„é€ **çš„å¸¸è§„å¯¹è±¡ï¼Œè¦å®ç°ç»§æ‰¿çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ `Object.setPrototypeOf()` æ–¹æ³•ï¼Œå®ƒå¯ä»¥è®¾ç½®ä¸€ä¸ªæŒ‡å®šå¯¹è±¡çš„åŸå‹åˆ°å¦ä¸€ä¸ªå¯¹è±¡ï¼š

```js
// å®šä¹‰ Animal å¯¹è±¡
const Animal = {
  speak() {
    console.log(this.name + &quot; makes a noise.&quot;);
  },
};

class Dog {
  constructor(name) {
    this.name = name;
  }
  speak() {
    super.speak();
    console.log(this.name + &quot; barks.&quot;);
  }
}

Object.setPrototypeOf(Dog.prototype, Animal); // å¦‚æœä¸è¿™æ ·åšï¼Œåœ¨è°ƒç”¨ speak æ—¶ä¼šè¿”å› TypeError

const d = new Dog(&quot;Mitzie&quot;);
d.speak();
// Mitzie makes a noise.
// Mitzie barks.
```

å‡ºäºæ€§èƒ½è€ƒé‡ï¼Œåº”é¿å…ä½¿ç”¨ `Object.setPrototypeOf()` æ–¹æ³•æ¥å®ç°ç»§æ‰¿ï¼Œåœ¨[è¿™é‡Œ](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/setPrototypeOf)äº†è§£å®ƒçš„æ›´å¤šã€‚

## ä½¿ç”¨ `super` è°ƒç”¨è¶…ç±»

ä½¿ç”¨ `super` å…³é”®å­—å¯ä»¥è°ƒç”¨å¯¹è±¡çš„çˆ¶å¯¹è±¡ä¸Šçš„å‡½æ•°ã€‚

```js
class Cat {
  constructor(name) {
    this.name = name;
  }
  speak() {
    console.log(`${this.name}: meo~~!`);
  }
}

class Lion extends Cat {
  speak() {
    super.speak(); // è°ƒç”¨ Cat å¯¹è±¡çš„ speak æ–¹æ³•
    console.log(`${this.name}: roars!!!`);
  }
}

const l = new Lion(&quot;Li&quot;);
l.speak();
// Li: meo~~!
// Li: roars!!!
```

å‡å¦‚æˆ‘ä»¬å°†ä¸Šé¢ä»£ç ä¸­ `Lion` ç±»é‡Œçš„ `speak()` æ–¹æ³•åˆ å»ï¼Œé‚£ä¹ˆæ‰“å°çš„ç»“æœæ˜¯ `Li: meo~~!`ã€‚å¦‚æœè®¤çœŸçœ‹åˆ°è¿™é‡Œçš„è¯ï¼ŒåŸå› æƒ³å¿…ä¹Ÿå·²ç»äº†ç„¶äºèƒ¸ï¼šå­ç±»ç»§æ‰¿äº†çˆ¶ç±»çš„å±æ€§å’Œæ–¹æ³•ã€‚é‚£ä¹ˆå½“å­ç±»å®šä¹‰äº†ä¸çˆ¶ç±»ç›¸åŒåå­—çš„æ–¹æ³•æ—¶ï¼Œæ ¹æ®åŸå‹é“¾ä¸Šçš„è°ƒç”¨è§„åˆ™ï¼Œä¼šè°ƒç”¨å­ç±»å®šä¹‰çš„æ–¹æ³•ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ `super` å…³é”®å­—çš„åŸå› ä¹‹ä¸€ï¼Œæ–¹æ³•åç›¸åŒçš„æƒ…å†µä¸‹ï¼Œåœ¨å­ç±»æ–¹æ³•ä¸­æˆ‘ä»¬ä»å¯ä»¥è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ã€‚

åœ¨**æ„é€ å‡½æ•°**ä¸­ï¼Œ`super()` éœ€è¦åœ¨ä½¿ç”¨ `this` å‰è°ƒç”¨ï¼š

```js
class Rectangle {
  constructor(height, width) {
    this._name = &quot;Rectangle&quot;;
    this._height = height;
    this._width = width;
  }
  get name() {
    return `Hi, I am a ${this._name}.`;
  }
  get area() {
    return this._height * this._width;
  }
}

class Square extends Rectangle {
  constructor(length) {
    // this._height = length // Must call super constructor in derived class before accessing &apos;this&apos; or returning from derived constructor
    super(length, length); // è°ƒç”¨ Rectangle çš„æ„é€ å‡½æ•°ï¼Œlength åˆ†åˆ«ä½œ height å’Œ width
    this._name = &quot;Square&quot;; // ä¿®æ”¹ name å±æ€§ä¸º Square
  }
}

const s = new Square(15);
console.log(s.name); // Hi, I am a Square.
console.log(s.area); // 225
```

`super` ä¹Ÿå¯ä»¥ç”¨æ¥è°ƒç”¨çˆ¶ç±»çš„é™æ€æ–¹æ³•ï¼š

```js
class Rectangle {
  constructor(height, width) {
    this._height = height;
    this._width = width;
  }
  static help() {
    // çˆ¶ç±»çš„é™æ€æ–¹æ³•
    return &quot;I have 4 sides.&quot;;
  }
}

class Square extends Rectangle {
  constructor(length) {
    super(length, length);
  }
  static help() {
    // å­ç±»çš„é™æ€æ–¹æ³•ï¼Œä½¿ç”¨ super è°ƒç”¨çˆ¶ç±»çš„ help æ–¹æ³•
    return super.help() + &quot; They are all equal.&quot;;
  }
}

console.log(Square.help()); // I have 4 sides. They are all equal.

// å‡å¦‚åªå»é™¤å­ç±» help æ–¹æ³•å‰é¢çš„ static å…³é”®å­—
// console.log(new Square(10).help()) // Uncaught TypeError: (intermediate value).help is not a function

// å‡å¦‚åªå»é™¤çˆ¶ç±» help æ–¹æ³•å‰é¢çš„ static å…³é”®å­—
// console.log(Square.help()) // Uncaught TypeError: (intermediate value).help is not a function
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ`Square` ä¸­çš„é™æ€æ–¹æ³• `help()` è°ƒç”¨äº†çˆ¶ç±»çš„é™æ€æ–¹æ³•ã€‚é™æ€æ–¹æ³•ä¸­çš„ `super` åªèƒ½è°ƒç”¨çˆ¶ç±»çš„é™æ€æ–¹æ³•ï¼Œå‡å¦‚æˆ‘ä»¬å»é™¤å­ç±»æˆ–çˆ¶ç±»æ–¹æ³•å‰é¢çš„ `static` å…³é”®å­—ï¼Œä¼šå‘ç”ŸæŠ¥é”™ã€‚

åœ¨æœ¬ç« èŠ‚çš„ä¾‹å­ä¸­ï¼Œä¼¼ä¹å­ç±»æ–¹æ³•ä¸­çš„ `super` éƒ½è°ƒç”¨äº†çˆ¶ç±»ä¸­ä¸ä¹‹åŒåçš„æ–¹æ³•ï¼Œä½†å®é™…ä¸Šå¹¶æ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼Œåœ¨ç¼–å†™çš„æ—¶å€™å¯ä»¥æ ¹æ®å®é™…çš„éœ€æ±‚è‡ªè¡Œè°ƒæ•´å‘½åæˆ–è°ƒç”¨å…¶å®ƒçˆ¶ç±»æ–¹æ³•ã€‚

åœ¨[ç®­å¤´å‡½æ•°çš„ä½¿ç”¨](#ç®­å¤´å‡½æ•°å®šä¹‰æ–¹æ³•)ç« èŠ‚çš„ä¾‹å­ä¸­ï¼Œæ—¢ç„¶ç®­å¤´å‡½æ•°å®šä¹‰çš„æ–¹æ³•æŒ‚è½½åˆ°äº†å®ä¾‹çš„å±æ€§ä¸Šï¼Œé‚£ä¹ˆè¿˜èƒ½ç”¨ `super` æ¥è°ƒç”¨å—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚JavaScript æ²¡èƒ½åœ¨çˆ¶å¯¹è±¡çš„åŸå‹é“¾ä¸Šæ‰¾åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œäºæ˜¯ä»€ä¹ˆä¹Ÿæ²¡æœ‰å‘ç”Ÿã€‚

æ›´å¤šè¡¥å……å¯ä»¥æŸ¥é˜… MDN ä¸Š[å…³äº `super` çš„ä»‹ç»](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/super)ã€‚

## ä½¿ç”¨ `Symbol.species` è¦†ç›–æ„é€ å‡½æ•°

`Symbol.species` è®¿é—®å™¨å±æ€§å…è®¸å­ç±»è¦†ç›–å¯¹è±¡çš„é»˜è®¤æ„é€ å‡½æ•°ã€‚

è¯»ç€å¾ˆæ‹—å£ï¼Œé‚£å°±çœ‹ä¸¤ä¸ªå®é™…çš„ä¾‹å­ã€‚å½“ä½¿ç”¨ `map()` è¿™æ ·çš„æ–¹æ³•ä¼šè¿”å›é»˜è®¤çš„æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬å¯èƒ½æƒ³åœ¨å¯¹æ‹“å±•çš„æ•°ç»„ç±» `MyArray` æ‰§è¡Œæ“ä½œæ—¶è¿”å› `Array` å¯¹è±¡ï¼Œé‚£ä¹ˆå¯ä»¥è¿™æ ·ç¼–å†™ä»£ç ï¼š

```js
class MyArray extends Array {
  // è®¾ç½® getterï¼Œå½“è·å– MyArray ç±»çš„æ„é€ å‡½æ•°æ—¶ï¼Œè¿”å› Array ç±»çš„æ„é€ å‡½æ•°
  static get [Symbol.species]() {
    return Array;
  }
}

const a = new MyArray(1, 2, 3);
const mapped = a.map((x) =&gt; x * x);
console.log(mapped instanceof MyArray); // false
console.log(mapped instanceof Array); // true
```

åˆä¾‹å¦‚ï¼Œæˆ‘ä»¬æ‹“å±• `Promise` ç±»ä¸º `TimeoutPromise` ç±»ï¼Œä½†æˆ‘ä»¬ä¸å¸Œæœ›æŸä¸€ä¸ªè¶…æ—¶çš„ Promise è¯·æ±‚å½±å“æ•´ä¸ª Promise é“¾ï¼Œå°±å¯ä»¥ä½¿ç”¨ `Symbol.species` æ¥å‘Šè¯‰ `TimeoutPromise` ç±»è¿”å›ä¸€ä¸ª `Promise` å¯¹è±¡ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ‰§è¡Œå¼‚å¸¸å¤„ç†æ“ä½œï¼š

```js
class TimeoutPromise extends Promise {
  static get [Symbol.species]() {
    return Promise;
  }
}
```

`Symbol.species` å…è®¸è‡ªå®šä¹‰è¿”å›çš„ç±»ï¼Œä¸ä¸€å®šæ˜¯å­ç±»ç»§æ‰¿å®ç°çš„ç±»ã€‚

`Symbol.species` å¸®åŠ©æˆ‘ä»¬åœ¨å¤„ç†å­ç±»å®ä¾‹æ—¶ï¼Œèƒ½å¤Ÿæœ‰ä¸€å¥—æ ‡å‡†çš„æ“ä½œæµç¨‹ï¼Œæ–¹ä¾¿äº†å¼€å‘ï¼Œåœ¨æŸäº›åœºæ™¯ååˆ†å®ç”¨ã€‚

## ä½¿ç”¨ Mix-ins å®ç°å¤šé‡ç»§æ‰¿

åœ¨ ECMAScript ä¸­ï¼Œä¸€ä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªå•è¶…ç±»ï¼Œå› æ­¤æƒ³é€šè¿‡å·¥å…·ç±»çš„æ–¹æ³•å®ç°å¤šé‡ç»§æ‰¿è¡Œä¸ºæ˜¯ä¸å¯èƒ½çš„ã€‚ä¸ºäº†å®ç°å¤šé‡ç»§æ‰¿ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Mixin çš„æ–¹æ³•ã€‚

ä»€ä¹ˆæ˜¯ Mixinï¼Ÿç®€å•æ¥è¯´ï¼ŒMixin ä¹Ÿæ˜¯ä¸€ä¸ªç±»ï¼ŒåŒ…æ‹¬äº†ä¸€äº›æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯ä»¥è¢«å…¶å®ƒç±»ä½¿ç”¨ã€‚ä½†åœ¨å…¶å®ƒç±»ä¸­ä½¿ç”¨è¿™äº›æ–¹æ³•**ä¸éœ€è¦ç»§æ‰¿** Mixinã€‚ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š

```js
let sayHiMixin = {
  // Mixin
  // Methods that useful
  sayHi() {
    alert(`Hello, ${this.name}`);
  },
  sayBye() {
    alert(`Bye, ${this.name}`);
  },
};

class User {
  constructor(name) {
    this.name = name;
  }
}

Object.assign(User.prototype, sayHiMixin); // å°† Mixin ä¸­çš„æ–¹æ³•å¤åˆ¶åˆ° Class ç±»ä¸­

new User(&quot;Dude&quot;).sayHi(); // Hello, Dude!
```

æˆ‘ä»¬åˆçŸ¥é“ï¼Œåˆ›å»ºç±»çš„[ä¸¤ç§å£°æ˜æ–¹å¼](#å®šä¹‰ç±»)æ˜¯ç­‰ä»·çš„ï¼š

```js
class Mixin1 {
  //
}

// ç­‰ä»·äº
const Mixin2 = class {
  //
};
```

å…¶ä¸­ï¼Œç¬¬äºŒç§æ–¹å¼ï¼Œæˆ–è€…è¯´ä½¿ç”¨ç±»è¡¨è¾¾å¼å£°æ˜ç±»çš„æ–¹å¼ï¼Œå…è®¸æˆ‘ä»¬**åŠ¨æ€ç”Ÿæˆè‡ªå®šä¹‰çš„ç±»**ã€‚æ ¹æ®è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¼–å†™ Mixin ä»£ç æ¥å®ç°å¤šé‡ç»§æ‰¿äº†ï¼š

```js
class Animal { // å…±åŒå·¥å…·ç±»
    //
}
class CatMixin = (superClass) =&gt; class extends superClass { // çŒ«çŒ«å·¥å…·ç±»
    //
}
class DogMixin = (superClass) =&gt; class extends superClass { // ç‹—ç‹—å·¥å…·ç±»
    //
}

class MyMixin extends CatMixin(DogMixin(Animal)) { // å®ç°å¤šé‡ç»§æ‰¿
    //
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªé€šç”¨çš„å·¥å…·ç±» `Animal`ï¼Œå…¶å®ƒ Mixin ç±»å¯èƒ½ä¼šç”¨åˆ°è¿™ä¸ªå·¥å…·ç±»ã€‚æ¥ç€æˆ‘ä»¬å®šä¹‰äº†çŒ«çŒ«å’Œç‹—ç‹—ä½¿ç”¨çš„å·¥å…·ç±» `CatMixin` ä¸ `DogMixin` çš„åˆ›å»ºè§„åˆ™ï¼Œå®ƒä»¬å°†ä¼ å…¥çš„å‚æ•°ä½œä¸ºè‡ªå·±çš„çˆ¶ç±»ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»ã€‚æœ€åï¼Œæˆ‘ä»¬å®šä¹‰äº†æƒ³è¦çš„ `MyMixin` ç±»ï¼Œå®ƒç»§æ‰¿äº† `CatMixin(DogMixin(Animal))` ç±»ã€‚ä»å®ç°çš„è§’åº¦æ¥çœ‹ï¼Œ**ç›¸å½“äº**æ‰§è¡Œäº†ä¸‹é¢çš„æ“ä½œï¼š

```js
class DogMixin extends Animal {
  //
}
class CatMixin extends DogMixin {
  // è¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ï¼ŒçŒ«çŒ«å·¥å…·ç±»æ€ä¹ˆèƒ½ç»§æ‰¿ç‹—ç‹—å·¥å…·ç±»
  //
}

class MyMixin extends CatMixin {
  //
}
```

å®é™…ä¸Šï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰è®© `CatMixin` ç±»å»ç»§æ‰¿ `DogMixin` ç±»ï¼Œè€Œæ˜¯ä½¿ç”¨äº† Mixin çš„æ€æƒ³ï¼Œè®© `MyMixin` ç»§æ‰¿äº†æˆ‘ä»¬åŸºäºç±»è¡¨è¾¾å¼åˆ›å»ºçš„ä¸€ä¸ªæ–°çš„ç±»ï¼Œå®ç°äº†å¤šé‡ç»§æ‰¿ã€‚

## å‚è€ƒèµ„æ–™

æœ¬åšæ–‡ä»…ä¸”è®°å½•äº† JavaScript ä¸­ç±»åœ¨è¯­æ³•ä¸Šçš„çŸ¥è¯†å’Œè¿ç”¨ï¼Œè¾…ä»¥å°‘é‡çš„å®ç°åŸç†ã€‚å…³äºåº•å±‚çš„å…·ä½“å®ç°ï¼Œå°±æ”¾åˆ°ä»¥åå†æ·±å…¥æ¢è®¨å­¦ä¹ å§ã€‚

### æŠ€æœ¯åšæ–‡

- [JavaScript æˆ– ES6 å¦‚ä½•å®ç°å¤šç»§æ‰¿æ€»ç»“ã€Mixin æ··åˆç»§æ‰¿æ¨¡å¼ã€‘](https://cloud.tencent.com/developer/article/1700017), 2020-09-18
- [ES6 Class Methods å®šä¹‰æ–¹å¼çš„å·®å¼‚](https://github.com/dwqs/blog/issues/67), 2018-06-25
- [[å­¦ä¹  es6]setter/getter æ¢ç©¶](https://segmentfault.com/a/1190000007356931), 2016-11-02
- [Metaprogramming in ES6: Symbols and why they&apos;re awesome](https://www.keithcirkel.co.uk/metaprogramming-in-es6-symbols/#symbolspecies), 2015-06-18

### å…¶å®ƒèµ„æ–™

ä¸»è¦å‚è€ƒäº† MDN ä¸Šå…³äºç±»å’Œç›¸å…³å†…å®¹çš„[æè¿°](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes)ã€‚

- [Mixins - JAVASCRIPT.INFO](https://javascript.info/mixins)
</content:original-text><content:updated-at>2024-08-14T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[æ¼«è°ˆ JavaScript é—­åŒ…]]></title><description><![CDATA[JavaScript ä¸­æœ‰ä¸€ä¸ªå«ä½œé—­åŒ…ï¼ˆClosureï¼‰çš„æ¦‚å¿µï¼Œéå¸¸æœ‰è¶£ä¸”é€‚ç”¨ï¼Œå€¼å¾—å­¦ä¹ å¹¶æ•´ç†ä¸ºä¸€ç¯‡åšå®¢ã€‚ ä¸ºäº†æ›´å¥½ç†è§£é—­åŒ…çš„ä½œç”¨ï¼Œä¸å¦¨çœ‹çœ‹æˆ‘çš„å…³äº JS å˜é‡æå‡ï¼ˆHoistingï¼‰å’Œå‡½æ•°æå‡ç°è±¡çš„é˜è¿°ã€‚

ä½œç”¨åŸŸ

åœ¨ JavaScript ä¸­ï¼Œä½œç”¨åŸŸï¼ˆScopeï¼‰æ˜¯å½“å‰ä»£ç æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ï¼Œä¹Ÿå³æ˜¯å€¼å’Œè¡¨è¾¾å¼åœ¨å…¶ä¸­å¯è®¿é—®åˆ°çš„ä¸Šä¸‹æ–‡ã€‚

å¦‚æœä¸€ä¸ªå˜é‡æˆ–å…¶å®ƒè¡¨è¾¾å¼ä¸åœ¨å½“å‰ä½œç”¨åŸŸä¸­ï¼Œå°±ä¼šæ²¿ä½œç”¨åŸŸé“¾â€¦]]></description><link>https://blog.towind.fun/posts/js-closure</link><guid isPermaLink="false">js-closure</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Tue, 18 May 2021 00:00:00 GMT</pubDate><content:original-text>
JavaScript ä¸­æœ‰ä¸€ä¸ªå«ä½œé—­åŒ…ï¼ˆClosureï¼‰çš„æ¦‚å¿µï¼Œéå¸¸æœ‰è¶£ä¸”é€‚ç”¨ï¼Œå€¼å¾—å­¦ä¹ å¹¶æ•´ç†ä¸ºä¸€ç¯‡åšå®¢ã€‚

ä¸ºäº†æ›´å¥½ç†è§£é—­åŒ…çš„ä½œç”¨ï¼Œä¸å¦¨çœ‹çœ‹æˆ‘çš„&lt;Link to=&quot;/posts/js-hoisting&quot;&gt;è¿™ä¸€ç¯‡åšå®¢&lt;/Link&gt;å…³äº JS å˜é‡æå‡ï¼ˆHoistingï¼‰å’Œå‡½æ•°æå‡ç°è±¡çš„é˜è¿°ã€‚

## ä½œç”¨åŸŸ

åœ¨ JavaScript ä¸­ï¼Œ**ä½œç”¨åŸŸ**ï¼ˆScopeï¼‰æ˜¯å½“å‰ä»£ç æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ï¼Œä¹Ÿå³æ˜¯å€¼å’Œè¡¨è¾¾å¼åœ¨å…¶ä¸­å¯è®¿é—®åˆ°çš„ä¸Šä¸‹æ–‡ã€‚

- å¦‚æœä¸€ä¸ªå˜é‡æˆ–å…¶å®ƒè¡¨è¾¾å¼ä¸åœ¨å½“å‰ä½œç”¨åŸŸä¸­ï¼Œå°±ä¼šæ²¿**ä½œç”¨åŸŸé“¾**ï¼ˆScope Chainï¼‰å¾€çˆ¶ä½œç”¨åŸŸæœç´¢ã€‚å¦‚æœä¹Ÿä»æœªæ‰¾åˆ°å®ƒçš„è¯ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸å¯ç”¨çš„ã€‚
- æœ€é¡¶çº§çš„çˆ¶ä½œç”¨åŸŸæ˜¯å…¨å±€å¯¹è±¡ã€‚
- çˆ¶ä½œç”¨åŸŸä¸èƒ½å¼•ç”¨å­ä½œç”¨åŸŸä¸­çš„å˜é‡å’Œå®šä¹‰ã€‚

ç›®å‰ï¼Œä½œç”¨åŸŸæœ‰ä¸‰ç§ï¼š**å…¨å±€ä½œç”¨åŸŸ**å’Œ**å‡½æ•°ä½œç”¨åŸŸ**ï¼Œä»¥åŠ ES6 æ–°å¢çš„**å—çº§ä½œç”¨åŸŸ**ã€‚

### ä½œç”¨åŸŸä¸æ‰§è¡Œä¸Šä¸‹æ–‡

ä½œç”¨åŸŸä¸**æ‰§è¡Œä¸Šä¸‹æ–‡**ï¼ˆContextï¼‰æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µã€‚JavaScript ç³»è§£é‡Šå‹è¯­è¨€ï¼Œæ‰§è¡Œåˆ†ä¸ºè§£é‡Šé˜¶æ®µå’Œæ‰§è¡Œé˜¶æ®µä¸¤ä¸ªé˜¶æ®µï¼Œä¸¤ä¸ªé˜¶æ®µæ‰€å®Œæˆçš„è¡Œä¸ºå¤§æŠµå¦‚ä¸‹ï¼š

- è§£é‡Šé˜¶æ®µï¼š
  1. è¯æ³•åˆ†æï¼›
  2. è¯­æ³•åˆ†æï¼›
  3. **ç¡®å®šä½œç”¨åŸŸè§„åˆ™**ã€‚
- æ‰§è¡Œé˜¶æ®µï¼š
  1. **åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡**ï¼›
  2. æ‰§è¡Œå‡½æ•°ä»£ç ï¼›
  3. åƒåœ¾å›æ”¶ã€‚

å¯ä»¥çœ‹è§ï¼Œåœ¨è§£é‡Šé˜¶æ®µå°±å·²ç»ç¡®å®šäº†ä½œç”¨åŸŸè§„åˆ™ï¼Œè€Œåœ¨æ‰§è¡Œé˜¶æ®µæ‰åˆ›å»ºäº†æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚å› è€Œä½œç”¨åŸŸåœ¨å®šä¹‰æ—¶å°±ç¡®å®šï¼Œä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼›æ‰§è¡Œä¸Šä¸‹æ–‡åœ¨è¿è¡Œæ—¶ç¡®å®šï¼Œå¯ä»¥å‘ç”Ÿæ”¹å˜ã€‚

### å…¨å±€ä½œç”¨åŸŸå’Œå‡½æ•°ä½œç”¨åŸŸ

æœ€å¤–å±‚å‡½æ•°å’Œåœ¨æœ€å¤–å±‚å‡½æ•°å¤–è¾¹å®šä¹‰çš„å˜é‡æ‹¥æœ‰å…¨å±€ä½œç”¨åŸŸï¼Œè€Œå‡½æ•°å†…éƒ¨å®šä¹‰çš„å…¶ä»–å‡½æ•°å’Œå˜é‡æ‹¥æœ‰å‡½æ•°ä½œç”¨åŸŸã€‚å¦‚ï¼š

```js
var outVar = &quot;outVar&quot;;
function outFunc() {
  var inVar = &quot;inVar&quot;;
  function inFunc() {
    console.log(outVar, inVar);
  }
  inFunc();
}
console.log(outVar); // outVar
console.log(inVar); // Uncaught ReferenceError: inVar is not defined
outFunc(); // outVar inVar
inFunc(); // Uncaught ReferenceError: inFunc is not defined
```

åœ¨æœ€å¤–å±‚ï¼Œæˆ‘ä»¬å¯ä»¥æ­£å¸¸æ‰“å° `outVar` å’Œè°ƒç”¨ `outFunc()` æ–¹æ³•ï¼Œä½†æ˜¯åœ¨å°è¯•ç›´æ¥è°ƒç”¨ `outFunc()` æ–¹æ³•ä¸­æ‰€å®šä¹‰çš„ `inVar` å’Œ `inFunc()` æ–¹æ³•æ—¶ï¼Œå‘ç”ŸæŠ¥é”™ã€‚æ­¤å¤–ï¼Œåœ¨ `inFunc()` æ–¹æ³•ä¸­ï¼ŒæˆåŠŸåœ¨çˆ¶ä½œç”¨åŸŸæ‰¾åˆ°å¹¶æ‰“å°å‡ºäº† `outVar` çš„å€¼ã€‚

æ‰€æœ‰æœªå®šä¹‰è€Œç›´æ¥èµ‹å€¼çš„å˜é‡ä¼šè‡ªåŠ¨å£°æ˜ä¸ºå…¨å±€å˜é‡ï¼Œæ‹¥æœ‰å…¨å±€ä½œç”¨åŸŸã€‚å¦‚ï¼š

```js
function outFunc() {
  globalInVar = &quot;globalInVar&quot;;
  var invar = &quot;inVar&quot;;
}
// æ‰§è¡Œè¿™ä¸ªå‡½æ•°ä»¥èµ‹å€¼
outFunc();
console.log(globalInVar); // globalInVar
console.log(invar); // Uncaught ReferenceError: invar is not defined
```

æˆ‘ä»¬åœ¨ `outFunc()` æ–¹æ³•ä¸­æœªä½¿ç”¨ `var` å£°æ˜è€Œç›´æ¥ç»™ `globalInVar` å˜é‡è¿›è¡Œèµ‹å€¼ï¼Œå®ƒå°†å£°æ˜ä¸ºå…¨å±€å˜é‡ï¼Œå¹¶èƒ½åœ¨æœ€å¤–å±‚ç›´æ¥æ‰“å°å‡ºæ¥ã€‚åº”å½“é¿å…æ­¤ç±»å£°æ˜çš„å­˜åœ¨ï¼Œåœ¨ `ESLint` ç­‰ä»£ç è´¨é‡æ£€æŸ¥å·¥å…·ä¸­ï¼Œä¼šæ ‡æ³¨æ­¤ç±»é”™è¯¯ã€‚

æ¥ä¸‹æ¥çœ‹ä¸€æ®µéå¸¸ç»å…¸çš„ä»£ç æ¡ˆä¾‹ï¼š

```js
function getArr() {
  var arr = [];
  for (var i = 0; i &lt; 5; i++) {
    arr.push(function () {
      return i;
    });
  }
  return arr;
}
var testArr = getArr();
console.log(testArr[2]()); // 5
```

æˆ‘ä»¬å°†æ–¹æ³•ä¼ å…¥åˆ°æ•°ç»„ä¸­ï¼ŒæœŸæœ›è°ƒç”¨æ–¹æ³•è¿”å›çš„å€¼ä¸ºå½“å‰æ•°ç»„çš„ç´¢å¼•å€¼ã€‚åœ¨è°ƒç”¨ `testArr[2]()` æ—¶ï¼ŒæœŸæœ›å¾—åˆ°çš„è¿”å›å€¼ä¸º `2`ï¼Œä½†å®é™…è¿”å›çš„å€¼æ˜¯ `5`ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

è¿™æ˜¯ç”±äºåœ¨ `for` å¾ªç¯ä¸­æˆ‘ä»¬ä½¿ç”¨ `var` å£°æ˜çš„å˜é‡ `i` ä¼šå‘ç”Ÿå˜é‡æå‡ï¼Œå…¶ä½œç”¨åŸŸä¸º `getArr()` è¿™ä¸ªå‡½æ•°ä½œç”¨åŸŸã€‚åœ¨è°ƒç”¨æ•°ç»„ä¸­å­˜å‚¨çš„å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†å¾ªç¯ï¼Œæ­¤æ—¶ `i` çš„å€¼å˜æˆäº† `5`ï¼Œåˆ™æ— è®ºè°ƒç”¨æ•°ç»„çš„å“ªä¸ªå‡½æ•°éƒ½ä¼šæ‰“å°å‡ºç°åœ¨çš„å€¼ `5`ã€‚ä¸Šé¢çš„ä»£ç ä½¿ç”¨ç®€åŒ–çš„æ–¹å¼ç¼–å†™ï¼Œç›¸å½“äºï¼š

```js
var arr = [];
var i; // å˜é‡æå‡ï¼Œæˆ‘ä»¬åœ¨ for å¾ªç¯ä¸­å£°æ˜çš„å˜é‡åœ¨å…¨å±€å¯è®¿é—®
for (i = 0; i &lt; 5; i++) {
  arr.push(function () {
    return i;
  });
}
console.log(arr[2]()); // 5
// console.log(i) // 5
```

é‚£ä¹ˆï¼Œç°åœ¨çš„é—®é¢˜æ˜¯ï¼Œè¦å¦‚ä½•åœ¨å‡½æ•°å†…éƒ¨ä¿å­˜ï¼ˆæˆ–è®°ä½ï¼‰ä¸€ä¸ªä»å¤–éƒ¨ä¼ å…¥çš„å€¼ï¼Œåœ¨è°ƒç”¨çš„æ—¶å€™èƒ½æ­£ç¡®æ‰“å°å‡ºæˆ‘ä»¬æƒ³è¦çš„ç»“æœå‘¢ï¼Ÿ

ES6 ä¸­æå‡ºäº†å—çº§ä½œç”¨åŸŸï¼Œå¯ä»¥é¡ºåˆ©è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

### å—çº§ä½œç”¨åŸŸ

ä¸å£°æ˜çš„å˜é‡åªèƒ½æ˜¯å…¨å±€æˆ–æ•´ä¸ªå‡½æ•°å—çš„ `var` å‘½ä»¤ä¸åŒï¼Œ`let` å’Œ `const` å‘½ä»¤å£°æ˜çš„å˜é‡ã€è¯­å¥å’Œè¡¨è¾¾å¼ä½œç”¨åŸŸå¯ä»¥é™åˆ¶åœ¨å—çº§ä»¥å†…ã€‚ä¾‹å¦‚ï¼š

```js
{
  var varVar = &quot;varVar&quot;;
  let letVar = &quot;letVar&quot;;
}
console.log(varVar); // varVar
console.log(letVar); // Uncaught ReferenceError: letVar is not defined
```

åœ¨ ES6 ä»¥å‰ï¼Œä¸å­˜åœ¨å—çº§ä½œç”¨åŸŸï¼Œä½¿ç”¨ `var` å‘½ä»¤å£°æ˜çš„åœ¨ `for`, `while` ç­‰å†…éƒ¨çš„å˜é‡éƒ½ä¼šæå‡ä¸ºå¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å—çº§ä½œç”¨åŸŸæ›¿æ¢åˆšåˆšçš„å‡½æ•°ä½œç”¨åŸŸäº†ï¼š

```js
function getArr() {
  const arr = [];
  for (let i = 0; i &lt; 5; i++) {
    // ä½¿ç”¨ let æ›¿æ¢ var
    arr.push(function () {
      return i;
    });
  }
  return arr;
}
const testArr = getArr();
console.log(testArr[2]()); // 2
```

ä½¿ç”¨ `let` å‘½ä»¤å£°æ˜çš„å˜é‡ `i` åœ¨å¾ªç¯ä¸­æ‹¥æœ‰å—çº§ä½œç”¨åŸŸï¼Œæ¯æ¬¡å¾ªç¯æ—¶æ¯ä¸ªè¿”å›çš„å‡½æ•°ä¸­å¼•ç”¨çš„éƒ½æ˜¯å…¶å¯¹åº”å—çº§ä½œç”¨åŸŸçš„å˜é‡ã€‚ä¸Šé¢çš„ä»£ç ä½¿ç”¨ç®€åŒ–çš„æ–¹å¼ç¼–å†™ï¼Œç›¸å½“äºï¼š

```js
const arr = [];
for (let i = 0; i &lt; 5; i++) {
  const n = i; // å£°æ˜çš„å˜é‡ä»…åœ¨ for å¾ªç¯çš„å—ä½œç”¨åŸŸå¯è®¿é—®
  arr.push(function () {
    return n;
  });
}
console.log(arr[2]()); // 2
// console.log(i) // Uncaught ReferenceError: i is not defined
```

è€Œåœ¨ ES6 ä¹‹å‰ï¼Œå°±éœ€è¦ç”¨åˆ°äº†è¿™ç¯‡åšæ–‡çœŸæ­£çš„ä¸»è§’â€”â€”é—­åŒ…ã€‚

## ä»€ä¹ˆæ˜¯é—­åŒ…

ç”±äº JavaScript çš„é“¾å¼ä½œç”¨åŸŸï¼ˆChain Scopeï¼‰ç»“æ„ï¼Œçˆ¶å¯¹è±¡çš„æ‰€æœ‰å˜é‡éƒ½å¯¹å­å˜é‡å¯è§ï¼Œåä¹‹åˆ™ä¸æˆç«‹ã€‚å‡ºäºæŸç§åŸå› ï¼Œæˆ‘ä»¬æœ‰æ—¶å€™éœ€è¦å¾—åˆ°å‡½æ•°å†…çš„å±€éƒ¨å˜é‡ï¼Œå°±éœ€è¦ä½¿ç”¨å˜é€šçš„æ–¹æ³•å®ç°ï¼š

```js
// å­å¯¹è±¡çš„å˜é‡å¯¹çˆ¶å¯¹è±¡ä¸å¯è§
function outerFunc() {
  var value = 100;
  function innerFunc() {
    console.log(value);
  }
}
innerFunc(); // Uncaught ReferenceError: innerFunc is not defined

// å˜é€šçš„æ–¹æ³•
function outerFunc() {
  var value = 100;
  function innerFunc() {
    console.log(value);
  }
  return innerFunc; // å°†å†…éƒ¨å®šä¹‰çš„æ–¹æ³•è¿”å›
}
var visitValue = outerFunc();
visitValue(); // 100
```

åœ¨ä¸€äº›ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œä¸€ä¸ªå‡½æ•°çš„å±€éƒ¨å˜é‡ä»…å­˜åœ¨äºæ­¤å‡½æ•°çš„æ‰§è¡ŒæœŸé—´ã€‚é‚£ä¹ˆä¸€æ—¦ `outerFunc()` æ‰§è¡Œå®Œæ¯•ï¼Œæ‚¨å¯èƒ½ä¼šè®¤ä¸ºå‡½æ•°å†…éƒ¨å®šä¹‰çš„å˜é‡ `value` å°†ä¸èƒ½å¤Ÿå†è®¿é—®ã€‚ç„¶è€Œï¼Œåœ¨ JavaScript ä¸­è¿™æ®µä»£ç èƒ½å¤Ÿé¡ºåˆ©æ‰§è¡Œå¹¶æ‰“å°å‡ºç»“æœã€‚

è¿™æ˜¯ç”±äº JavaScript ä¸­çš„å‡½æ•°ä¼šå½¢æˆ**é—­åŒ…**ã€‚

&gt; ä¸€ä¸ªå‡½æ•°å’Œå¯¹å…¶å‘¨å›´çŠ¶æ€ï¼ˆlexical environmentï¼Œè¯æ³•ç¯å¢ƒï¼‰çš„å¼•ç”¨æ†ç»‘åœ¨ä¸€èµ·ï¼ˆæˆ–è€…è¯´å‡½æ•°è¢«å¼•ç”¨åŒ…å›´ï¼‰ï¼Œè¿™æ ·çš„ç»„åˆå°±æ˜¯é—­åŒ…ï¼ˆclosureï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé—­åŒ…è®©ä½ å¯ä»¥åœ¨ä¸€ä¸ªå†…å±‚å‡½æ•°ä¸­è®¿é—®åˆ°å…¶å¤–å±‚å‡½æ•°çš„ä½œç”¨åŸŸã€‚åœ¨ JavaScript ä¸­ï¼Œæ¯å½“åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œé—­åŒ…å°±ä¼šåœ¨å‡½æ•°åˆ›å»ºçš„åŒæ—¶è¢«åˆ›å»ºå‡ºæ¥ã€‚
&gt; A closure is the combination of a function bundled together (enclosed) with references to its surrounding state (the lexical environment). In other words, a closure gives you access to an outer functionâ€™s scope from an inner function. In JavaScript, closures are created every time a function is created, at function creation time.

é—­åŒ…æ˜¯ç”±å‡½æ•°ä»¥åŠå£°æ˜è¯¥å‡½æ•°çš„è¯æ³•ç¯å¢ƒç»„åˆè€Œæˆçš„ã€‚è¯¥ç¯å¢ƒåŒ…å«äº†è¿™ä¸ªé—­åŒ…åˆ›å»ºæ—¶ä½œç”¨åŸŸå†…çš„æ‰€æœ‰å±€éƒ¨å˜é‡ã€‚ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œé—­åŒ…å¯ä»¥çœ‹ä½œå°†ä¸€ä¸ªå‡½æ•°çš„å†…éƒ¨å’Œå¤–éƒ¨è¿æ¥èµ·æ¥çš„æ¡¥æ¢ã€‚

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå˜é‡ `visitValue` æ˜¯æ‰§è¡Œ `outerFunc()` æ—¶åˆ›å»ºçš„å¯¹ `innerFunc` å‡½æ•°å®ä¾‹çš„å¼•ç”¨ï¼Œè€Œ `innerFunc` å®ä¾‹ç»´æŒäº†ä¸€ä¸ªå¯¹å®ƒçš„è¯æ³•ç¯å¢ƒçš„å¼•ç”¨ï¼Œåœ¨è¿™ä¸ªè¯æ³•ç¯å¢ƒä¸­å­˜åœ¨ç€å˜é‡ `value`ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ `visitValue()` æ—¶ï¼Œå˜é‡ `value` æ˜¯å¯ç”¨çš„ï¼Œæœ€åæˆ‘ä»¬æˆåŠŸåœ¨æ§åˆ¶å°æ‰“å°å‡ºäº†å®ƒçš„å€¼ã€‚

é‚£ä¹ˆï¼Œä¸ºäº†è§£å†³åœ¨å‰æ–‡æå‡ºçš„ä¸å­˜åœ¨å—çº§ä½œç”¨åŸŸçš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åƒè¿™æ ·ç¼–å†™ä»£ç ï¼š

```js
function getArr() {
  var arr = [];
  for (var i = 0; i &lt; 5; i++) {
    arr.push(
      (function (n) {
        // n çš„ä½œç”¨åŸŸä¸ºå‡½æ•°ä½œç”¨åŸŸ
        return function () {
          // è¿”å›ä¸€ä¸ªå‡½æ•°
          return n; // è°ƒç”¨å‡½æ•°è¿”å›çš„å€¼ä¸ºä¼ å…¥çš„ n çš„å€¼
        };
      })(i),
    ); // ä¼ å…¥å½“å‰çš„ i å€¼
  }
  return arr;
}
var testArr = getArr();
console.log(testArr[2]()); // 2
```

å¯¹äºä¸Šé¢çš„ `for` å¾ªç¯ï¼Œç›¸å½“äºæ‰§è¡Œäº†ä¸‹è¿°ä»£ç ï¼š

```js
arr[0] = (function (n) {
  return function () {
    return n;
  };
})(0);
arr[1] = (function (n) {
  return function () {
    return n;
  };
})(1);
arr[2] = (function (n) {
  return function () {
    return n;
  };
})(2);
// ä¸‹ç•¥

console.log(arr[2]()); // 2
```

è¿™æ ·ä¸€æ¥ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå‡½æ•°åˆ†åˆ«å¤„äºä¸€ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°çš„**å‡½æ•°ä½œç”¨åŸŸ**ä¸­ï¼Œè¿™ä¸ªç«‹å³æ‰§è¡Œçš„å‡½æ•°ä¼ å…¥äº†æ¯æ¬¡å¾ªç¯æ—¶å˜é‡ `i` çš„å€¼ã€‚äºæ˜¯ï¼Œå½“æˆ‘ä»¬è°ƒç”¨æ•°ç»„ä¸­çš„å‡½æ•°æ—¶ï¼Œå°†è¿”å›**ä¼ å…¥æ—¶**çš„ `i` å€¼ï¼Œè€Œä¸æ˜¯å¾ªç¯ç»“æŸåçš„ `i` å€¼ã€‚

&gt; &quot;JavaScript ä¸­é—­åŒ…æ— å¤„ä¸åœ¨ï¼Œä½ åªéœ€è¦èƒ½å¤Ÿè¯†åˆ«å¹¶æ‹¥æŠ±å®ƒã€‚&quot;
&gt; &quot;æœ€åä½ æç„¶å¤§æ‚Ÿï¼šåŸæ¥åœ¨æˆ‘çš„ä»£ç ä¸­å·²ç»åˆ°å¤„éƒ½æ˜¯é—­åŒ…äº†ï¼Œç°åœ¨æˆ‘ç»ˆäºèƒ½ç†è§£ä»–ä»¬äº†ã€‚
&gt; &quot;ç†è§£é—­åŒ…å°±å¥½åƒ Neo ç¬¬ä¸€æ¬¡è§åˆ°çŸ©é˜µä¸€æ ·ã€‚&quot;

_You Don&apos;t Know Javascript_ ä¸­å¦‚æ˜¯å†™é“ã€‚

## å¦‚ä½•ä½¿ç”¨é—­åŒ…

å¦‚æœä¸æ˜¯æŸäº›ç‰¹å®šä»»åŠ¡éœ€è¦ä½¿ç”¨åˆ°é—­åŒ…ï¼Œé‚£ä¹ˆåœ¨å‡½æ•°ä¸­åˆ›å»ºå¦ä¸€ä¸ªå‡½æ•°æ˜¯ä¸æ˜æ™ºçš„ã€‚é—­åŒ…ä¼šä½¿å¾—å‡½æ•°ä¸­çš„å˜é‡ä¿å­˜åœ¨**å†…å­˜**ä¸­ï¼Œå¯èƒ½é€ æˆæ€§èƒ½é—®é¢˜ã€‚

### å‡½æ•°é˜²æŠ–å’ŒèŠ‚æµ

å‡½æ•°é˜²æŠ–å’Œå‡½æ•°èŠ‚æµå°±æ˜¯å…¸å‹çš„é—­åŒ…ç”¨ä¾‹ï¼Œæˆ‘åœ¨&lt;Link to=&quot;/posts/js-debounce-throttle&quot;&gt;è¿™ä¸€ç¯‡åšå®¢&lt;/Link&gt;é‡Œå¯¹å®ƒä»¬è¿›è¡Œäº†ç¼–å†™ã€‚

### å‡½æ•°å·¥å‚

è¿™æ˜¯ä¸€ä¸ªå‡½æ•°å·¥å‚çš„ç¤ºä¾‹ï¼š

```js
function makeAdder(x) {
  return function (y) {
    return x + y;
  };
}

var add5 = makeAdder(5);
var add10 = makeAdder(10);

console.log(add5(2)); // 7
console.log(add10(2)); // 12
```

æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå‡½æ•° `makeAdder(x)`ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‚æ•° `x`ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ã€‚è¿”å›çš„è¿™ä¸ªå‡½æ•°æ¥å—å‚æ•° `y`ï¼Œå¹¶è¿”å› `x + y` çš„å€¼ã€‚æ¥ç€ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªæ–°å‡½æ•° `add5` å’Œ `add10`ï¼Œä¸€ä¸ªå°†å®ƒçš„å‚æ•°ä¸ `5` æ±‚å’Œï¼Œå¦ä¸€ä¸ªä¸ `10` æ±‚å’Œã€‚

`add5` å’Œ `add10` éƒ½æ˜¯é—­åŒ…ï¼Œå®ƒä»¬å…±äº«ç›¸åŒçš„å‡½æ•°å®šä¹‰ï¼Œä½†æ˜¯ä¿å­˜äº†ä¸åŒçš„è¯æ³•ç¯å¢ƒã€‚åœ¨ `add5` çš„è¯æ³•ç¯å¢ƒä¸­ï¼Œ`x` çš„å€¼ä¸º `5`ï¼›è€Œåœ¨ `add10` ä¸­ï¼Œ`x` ä¸º `10`ã€‚

### é¢å‘å¯¹è±¡ç¼–ç¨‹

æˆ‘ä»¬å¯ä»¥ç”¨é—­åŒ…æ¥æ¨¡æ‹Ÿ**ç§æœ‰**å±æ€§å’Œæ–¹æ³•ï¼Œå°±åƒé¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ä¸­ç±»çš„ç§æœ‰å±æ€§å’Œæ–¹æ³•çš„ç¼–å†™ä¸€æ ·ã€‚ä»¥æ„å»º `Rectangle` çŸ©å½¢ç±»ä¸ºä¾‹ï¼š

```js
var Rectangle = function (height, width) {
  var height = height; // ç§æœ‰çš„é«˜å±æ€§
  var width = width; // ç§æœ‰çš„å®½å±æ€§
  function calcArea() {
    // ç§æœ‰çš„è®¡ç®—é¢ç§¯æ–¹æ³•
    return height * width;
  }
  function setHeight(h) {
    // ç§æœ‰çš„è®¾ç½®é«˜æ–¹æ³•
    height = h;
  }
  function setWidth(w) {
    // ç§æœ‰çš„è®¾ç½®å®½æ–¹æ³•
    width = w;
  }
  return {
    // è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡å¯ä»¥è®¿é—®åˆ°é—­åŒ…çš„ä½œç”¨åŸŸ
    get area() {
      return calcArea();
    },
    setHeight: function (h) {
      setHeight(h);
    },
    setWidth: function (w) {
      setWidth(w);
    },
  };
};

var square = Rectangle(5, 5);
console.log(square.area); // 25

square.setHeight(10);
square.setWidth(10);
console.log(square.area); // 100

console.log(square.height); // undefined
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†é—­åŒ…æ¥å®šä¹‰å…¬å…±å‡½æ•°ï¼Œå¹¶ä»¤è¿™äº›å…¬å…±å‡½æ•°è®¿é—®åˆ°ç§æœ‰å‡½æ•°å’Œå˜é‡ã€‚è¿™ä¸ªæ–¹å¼åˆç§°æ¨¡å—æ¨¡å¼ï¼ˆModule Patternï¼‰ã€‚

åœ¨ ES6 ä¸­ï¼Œå¯ä»¥ç”¨ `class` è¯­æ³•ç³–æ¥å£°æ˜ç±»ã€‚ä¸Šé¢çš„ä»£ç ç›¸å½“äºï¼š

```js
class Rectangle {
  #height;
  #width;
  // Constructor
  constructor(height, width) {
    this.#height = height;
    this.#width = width;
  }
  // Getter
  get area() {
    return this.calcArea();
  }
  // Method
  calcArea() {
    return this.#height * this.#width;
  }
  setHeight(h) {
    this.#height = h;
  }
  setWidth(w) {
    this.#width = w;
  }
}

const square = new Rectangle(5, 5); // ä½¿ç”¨ new å…³é”®å­—æ¥åˆ›å»ºå¯¹è±¡
console.log(square.area); // 25

square.setHeight(10);
square.setWidth(10);
console.log(square.area); // 100

console.log(square.height); // undefined
```

åœ¨ `class` å†…ï¼Œç§æœ‰å±æ€§ `height` å’Œ `width` éœ€è¦åœ¨å‰é¢åŠ ä¸Š `#` å¹¶åœ¨å¼€å¤´æ˜¾ç¤ºå£°æ˜å‡ºæ¥ã€‚

å½“ç„¶ï¼Œç›¸æ¯”é—­åŒ…çš„æ–¹å¼ï¼Œä½¿ç”¨ `class` çš„å£°æ˜æ›´åŠ ç›´è§‚ï¼Œå€¼å¾—æ¨å¹¿ä½¿ç”¨ã€‚

å€¼å¾—è¡¥å……çš„æ˜¯ï¼Œå‡å¦‚ä¸éœ€è¦åœ¨å¯¹è±¡ä¸­ä½¿ç”¨ç§æœ‰å£°æ˜ï¼Œè€Œæ˜¯ä½¿ç”¨å…¬ç”¨å£°æ˜ï¼Œåº”å½“é¿å…ä½¿ç”¨é—­åŒ…ã€‚åŒæ ·ä»¥æ„å»º `PublicRectangle` çŸ©å½¢ç±»ä¸ºä¾‹ï¼š

```js
var PublicRectangle = function (height, width) {
  return {
    // å°†çŸ©å½¢çš„é«˜å’Œå®½ä½œä¸ºè¿”å›å¯¹è±¡çš„å¯è®¿é—®å±æ€§
    height: height,
    width: width,
    get area() {
      return this.height * this.width;
    },
    setHeight: function (h) {
      this.height = h;
    },
    setWidth: function (w) {
      this.width = w;
    },
  };
};

var square = PublicRectangle(5, 5);
console.log(square.area); // 25

square.setHeight(10);
square.setWidth(10);
console.log(square.area); // 100

console.log(square.height); // 10
```

ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¹¶æ²¡æœ‰åˆ©ç”¨åˆ°é—­åŒ…çš„å¥½å¤„ï¼Œåè€Œåœ¨æ¯æ¬¡è°ƒç”¨æ„é€ å™¨æ—¶éƒ½é‡æ–°èµ‹å€¼ä¸€éæ–¹æ³•ã€‚å› æ­¤åœ¨è¿™é‡Œä¸å¦¨å˜ä¸ºæ·»åŠ **åŸå‹æ–¹æ³•**çš„æ–¹å¼ï¼š

```js
var PublicRectangle = function (height, width) {
  this.height = height;
  this.width = width;
};
Object.defineProperty(PublicRectangle.prototype, &quot;area&quot;, {
  // ä¸º PublicRectangle åŸå‹æ·»åŠ  area çš„ getter
  get() {
    return this.height * this.width;
  },
});
PublicRectangle.prototype.setHeight = function (h) {
  this.height = h;
};
PublicRectangle.prototype.setWidth = function (w) {
  this.width = w;
};

var square = new PublicRectangle(5, 5); // åº”ä½¿ç”¨ new å…³é”®å­—
console.log(square.area); // 25

square.setHeight(10);
square.setWidth(10);
console.log(square.area); // 100

console.log(square.height); // 10
```

## å‚è€ƒèµ„æ–™

### æŠ€æœ¯åšå®¢ï¼ˆæˆ–é—®ç­”ï¼‰

- [é—­åŒ…ä»¥åŠå…¶ ES6 ä¸‹çš„ä½¿ç”¨](https://www.jianshu.com/p/ebb4eccb6625), 2020-01-13
- [æ·±å…¥ç†è§£ JavaScript ä½œç”¨åŸŸå’Œä½œç”¨åŸŸé“¾](https://blog.fundebug.com/2019/03/15/understand-javascript-scope/), 2019-03-15
- [æ·±å…¥è§£æ ES6 ä¸­ let å’Œé—­åŒ…](https://juejin.cn/post/6844903747106111501), 2018-12-25
- [å¦‚ä½•ç»™ js å†…å»ºå¯¹è±¡æ„é€ å™¨æ·»åŠ  getter å’Œ setter](https://segmentfault.com/q/1010000016598692), 2018-10-06
- [å­¦ä¹  Javascript é—­åŒ…ï¼ˆClosureï¼‰](http://www.ruanyifeng.com/blog/2009/08/learning_javascript_closures.html), 2009-08-30

### å…¶å®ƒèµ„æ–™

- [é—­åŒ… - MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Closures)
- [ç±» - MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes)
- [You Don&apos;t Know Javascript](https://github.com/getify/You-Dont-Know-JS)
</content:original-text><content:updated-at>2021-05-18T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[æ¼«è°ˆ JavaScript å˜é‡æå‡å’Œå‡½æ•°æå‡]]></title><description><![CDATA[åœ¨ ES6 è§„èŒƒå‡ºç°ä¹‹å‰ï¼Œä½¿ç”¨ JavaScript å£°æ˜å˜é‡åªæœ‰ ,  ä»¥åŠéšå¼å£°æ˜ä¸‰ç§æ–¹å¼ã€‚ æŒ‰ç…§ä¸€èˆ¬ç¼–ç¨‹çš„æ€ç»´ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡â€œå…ˆå£°æ˜ï¼Œåè°ƒç”¨â€çš„æ–¹å¼å»ä½¿ç”¨å˜é‡ï¼Œä¾‹å¦‚ï¼š

ä½†å‡å¦‚åè¿‡æ¥ï¼Œæˆ‘ä»¬â€œå…ˆè°ƒç”¨ï¼Œåå£°æ˜â€ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ

å¦‚ä¸Šæ‰€ç¤ºï¼Œåœ¨å£°æ˜å˜é‡  ä¹‹å‰å°è¯•å°†å®ƒçš„å€¼æ‰“å°å‡ºæ¥ï¼Œæ§åˆ¶å°è¾“å‡ºçš„ç»“æœæ˜¯ ï¼Œè€Œä¸æ˜¯é¢„æœŸä¸­çš„æŠ¥é”™ ã€‚è¿™å°±æ˜¯å˜é‡æå‡ã€‚

è€Œå¯¹äºå‡½æ•°çš„å£°æ˜ä¸ä½¿ç”¨ï¼Œä¹Ÿå‡ºç°äº†ç›¸ä¼¼çš„æƒ…å†µï¼š

åœ¨å£°æ˜å‡½æ•°â€¦]]></description><link>https://blog.towind.fun/posts/js-hoisting</link><guid isPermaLink="false">js-hoisting</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Tue, 11 May 2021 00:00:00 GMT</pubDate><content:original-text>
åœ¨ ES6 è§„èŒƒå‡ºç°ä¹‹å‰ï¼Œä½¿ç”¨ JavaScript å£°æ˜å˜é‡åªæœ‰ `var`, `function` ä»¥åŠéšå¼å£°æ˜ä¸‰ç§æ–¹å¼ã€‚

æŒ‰ç…§ä¸€èˆ¬ç¼–ç¨‹çš„æ€ç»´ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡â€œå…ˆå£°æ˜ï¼Œåè°ƒç”¨â€çš„æ–¹å¼å»ä½¿ç”¨å˜é‡ï¼Œä¾‹å¦‚ï¼š

```js
var a = 3;
console.log(a); // 3
```

ä½†å‡å¦‚åè¿‡æ¥ï¼Œæˆ‘ä»¬â€œå…ˆè°ƒç”¨ï¼Œåå£°æ˜â€ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ

```js
console.log(a); // undefined
var a = 3;
console.log(a); // 3

console.log(b); // Uncaught ReferenceError: b is not defined
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œåœ¨å£°æ˜å˜é‡ `a` ä¹‹å‰å°è¯•å°†å®ƒçš„å€¼æ‰“å°å‡ºæ¥ï¼Œæ§åˆ¶å°è¾“å‡ºçš„ç»“æœæ˜¯ `undefined`ï¼Œè€Œä¸æ˜¯é¢„æœŸä¸­çš„æŠ¥é”™ `Uncaught ReferenceError: a is not defined`ã€‚è¿™å°±æ˜¯**å˜é‡æå‡**ã€‚

è€Œå¯¹äºå‡½æ•°çš„å£°æ˜ä¸ä½¿ç”¨ï¼Œä¹Ÿå‡ºç°äº†ç›¸ä¼¼çš„æƒ…å†µï¼š

```js
sayHello(); // Hello there!

function sayHello() {
  console.log(&quot;Hello there!&quot;);
}
```

åœ¨å£°æ˜å‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥è°ƒç”¨å‡½æ•°æ–¹æ³•å¹¶æ­£ç¡®è¾“å‡ºã€‚è¿™ä¾¿æ˜¯**å‡½æ•°æå‡**ã€‚

åœ¨ JavaScript ä¸­å¥‡æ€ªçš„ä¸€ç‚¹æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å£°æ˜å˜é‡ï¼ˆä½¿ç”¨ `var`ï¼‰å’Œå£°æ˜å‡½æ•°ä¹‹å‰ä½¿ç”¨å®ƒä»¬ï¼Œå°±å¥½åƒå˜é‡å’Œå‡½æ•°çš„å£°æ˜è¢«æå‡åˆ°äº†ä»£ç çš„é¡¶éƒ¨ä¸€æ ·ï¼š

```js
console.log(a); // undefined
var a = 3;
console.log(a); // 3

// å¥½åƒç­‰äºä¸‹é¢çš„ä»£ç 
var a;
console.log(a); // undefined
a = 3;
console.log(a); // 3
```

å®é™…ä¸Šï¼ŒJavaScript å¹¶ä¸ä¼šç§»åŠ¨ä»£ç ï¼Œå˜é‡æå‡å’Œå‡½æ•°æå‡å¹¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„â€œæå‡â€ï¼Œè€Œæ˜¯è§£é‡Šæ‰§è¡Œ JavaScript ä»£ç è¿‡ç¨‹æ‰€å¸¦æ¥çš„â€œç‰¹æ€§â€ã€‚

## å‘ç”Ÿäº†ä»€ä¹ˆ

ä»¥ç°åœ¨æœ€ä¸»æµçš„ `V8` å¼•æ“ä¸ºä¾‹ï¼Œå…¶è§£é‡Šæ‰§è¡Œ JavaScript ä»£ç çš„è¿‡ç¨‹å¤§è‡´åˆ†ä¸ºç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼Œç”Ÿæˆå­—èŠ‚ç å’Œç”Ÿæˆæœºå™¨ç ä¸‰ä¸ªé˜¶æ®µã€‚

åœ¨ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘é˜¶æ®µï¼Œåˆåˆ†ä¸ºäº†è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æä¸¤ä¸ªé˜¶æ®µã€‚å…¶ä¸­ï¼Œåœ¨è¯æ³•åˆ†æé˜¶æ®µï¼ŒJavaScript ä¼šæ£€æµ‹åˆ°å½“å‰**ä½œç”¨åŸŸ**ä½¿ç”¨åˆ°çš„æ‰€æœ‰å˜é‡å’Œå‡½æ•°å£°æ˜ï¼Œå¹¶å°†è¿™äº›å˜é‡å’Œå‡½æ•°å£°æ˜æ·»åŠ åˆ°ä¸€ä¸ªåä¸º**è¯æ³•ç¯å¢ƒ**ï¼ˆLexical Environmentï¼‰çš„å†…å­˜ç©ºé—´å½“ä¸­ã€‚

åœ¨è¯æ³•åˆ†æé˜¶æ®µï¼Œå¯¹äºå˜é‡å£°æ˜å’Œå‡½æ•°å£°æ˜ï¼Œè¯æ³•ç¯å¢ƒçš„å¤„ç†æ˜¯ä¸ä¸€æ ·çš„ï¼š

- å¯¹äºå˜é‡å£°æ˜å¦‚ `var a = 3`ï¼Œä¼šä¸ºå˜é‡åˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–ä¸º `undefined`ï¼Œèµ‹å€¼è¯­å¥åœ¨ç”Ÿæˆæœºå™¨ç é˜¶æ®µçœŸæ­£æ‰§è¡Œä»£ç çš„æ—¶å€™æ‰è¿›è¡Œã€‚
- å¯¹äºå‡½æ•°å£°æ˜å¦‚ `function sayHello() { console.log(&apos;Hello there!&apos;) }`ï¼Œä¼šåœ¨å†…å­˜é‡Œåˆ›å»ºå‡½æ•°å¯¹è±¡ï¼Œå¹¶ä¸”ç›´æ¥åˆå§‹åŒ–ä¸ºè¯¥å‡½æ•°å¯¹è±¡ã€‚

å› æ­¤ï¼Œå¯¹äºå˜é‡å£°æ˜ï¼Œåœ¨çœŸæ­£æ‰§è¡Œåˆ°èµ‹å€¼è¯­å¥ä¹‹å‰ï¼Œæˆ‘ä»¬å°±å·²ç»å¯ä»¥ä½¿ç”¨æ­¤å˜é‡ï¼Œä½†æ˜¯åˆå€¼ä¸º `undefined`ï¼›è€Œå¯¹äºå‡½æ•°å£°æ˜ï¼Œåœ¨æ‰§è¡Œåˆ°å‡½æ•°å£°æ˜ä¹‹å‰ï¼Œå‡½æ•°å¯¹è±¡å°±å·²ç»å­˜åœ¨åœ¨å†…å­˜å½“ä¸­ï¼Œå¹¶å¯ä»¥ç›´æ¥è°ƒç”¨äº†ã€‚

åº”å½“æ³¨æ„çš„æ˜¯ï¼Œå‡½æ•°å£°æ˜çš„å¤„ç†ä¼˜å…ˆçº§è¦é«˜äºå˜é‡å£°æ˜ï¼ˆæ„å‘³ç€å‡½æ•°ä¼šâ€œæå‡â€åˆ°æ›´é å‰çš„ä½ç½®ï¼‰ï¼š

```js
console.log(foo);
foo = 3;
console.log(foo);
function foo() {}

// ç›¸å½“äºä¸‹é¢çš„ä»£ç 
var foo;
foo = function () {};
console.log(foo);
foo = 3;
console.log(foo);

// ä¾æ¬¡æ‰“å°å‡ºï¼š
// function foo() {}
// 3
```

å¦å¤–ï¼Œå˜é‡æå‡å’Œå‡½æ•°æå‡éƒ½æ˜¯å°†å£°æ˜â€œæå‡â€åˆ°å½“å‰**ä½œç”¨åŸŸ**çš„é¡¶ç«¯ï¼š

```js
var foo = 5;

function hoist() {
  console.log(foo);
  foo = 3;
  console.log(foo);
  function foo() {}
}

hoist();
console.log(foo);

// ç›¸å½“äºä¸‹é¢çš„ä»£ç 
var hoist;
var foo;

hoist = function () {
  var foo;
  foo = function () {};
  console.log(foo);
  foo = 3;
  console.log(foo);
};
foo = 5;

hoist();
console.log(foo);

// ä¾æ¬¡æ‰“å°å‡ºï¼š
// function foo() {}
// 3
// 5
```

`hoist()` æ–¹æ³•ä¸­æ‰§è¡Œçš„ `console.log(foo)` ä¼˜å…ˆä»å½“å‰ä½œç”¨åŸŸä¸­å¯»æ‰¾å˜é‡ `foo`ï¼Œå¦‚æœæ‰¾ä¸åˆ°æ‰åœ¨çˆ¶çº§ä½œç”¨åŸŸå¯»æ‰¾ã€‚

## åŒ¿åå‡½æ•°å£°æ˜

å¦‚æœå°†å‡½æ•°èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ä¼šæ€æ ·ï¼š

```js
sayHi(); // Uncaught TypeError: sayHi is not a function
console.log(sayHi); // undefined
var sayHi = function () {
  console.log(&quot;Hi there!&quot;);
};
sayHi(); // Hi there!
```

ä½¿ç”¨åŒ¿åå‡½æ•°å£°æ˜æ—¶ï¼Œ`sayHi` å‘ç”Ÿå˜é‡æå‡ï¼Œä½†èµ‹å€¼ä¸º `undefined`ï¼Œå› æ­¤æ‰§è¡Œ `sayHi()` æ—¶ä¼šæŠ¥é”™ `Uncaught TypeError: sayHi is not a function`ã€‚éšåæ‰§è¡Œå®Œèµ‹å€¼è¯­å¥åï¼Œæ‰æˆä¸ºä¸€ä¸ªå¯ä»¥æ‰§è¡Œçš„å‡½æ•°å˜é‡ã€‚

## é˜²æ­¢å˜é‡æå‡

åœ¨ ES6 ä¸­ï¼Œæä¾›äº†ä¸¤ä¸ªå£°æ˜å˜é‡çš„æ–°çš„å‘½ä»¤ï¼Œå³ç°åœ¨æˆ‘ä»¬æœ€å¸¸ç”¨çš„ `let` å’Œ `const`ã€‚ä½¿ç”¨ `let` å£°æ˜çš„å˜é‡å¯ä»¥ä¿®æ”¹ï¼Œè€Œä½¿ç”¨ `const` å£°æ˜çš„å˜é‡ä¸å¯æ›´æ”¹ã€‚ä½¿ç”¨ `const` å£°æ˜å¿…é¡»æŒ‡å®šåˆå§‹å€¼ã€‚

ä½¿ç”¨ `var`, `let` å’Œ `const` å£°æ˜çš„å˜é‡éƒ½ä¼šè¢«â€œæå‡â€ï¼Œä¸åŒçš„æ˜¯ï¼š

- `var` å‘½ä»¤åœ¨å˜é‡çš„å®šä¹‰è¢«æ‰§è¡Œä¹‹å‰å°±åˆå§‹åŒ–å˜é‡ï¼Œå¹¶æ‹¥æœ‰ä¸€ä¸ªé»˜è®¤çš„ `undefined` å€¼ã€‚
- `let` ä¸ `const` å‘½ä»¤ä¼šå½¢æˆ**æš‚æ—¶æ€§æ­»åŒº**ï¼Œåœ¨å˜é‡çš„å®šä¹‰è¢«æ‰§è¡Œä¹‹å‰éƒ½**ä¸ä¼šåˆå§‹åŒ–å˜é‡**ï¼Œé¿å…åœ¨å£°æ˜è¯­å¥ä¹‹å‰çš„ä¸æ­£ç¡®è°ƒç”¨ã€‚å¦‚æœå®šä¹‰æ—¶æ²¡æœ‰ç»™å®šå€¼çš„è¯ï¼Œ`let` å£°æ˜çš„å˜é‡ä¼šèµ‹å€¼ä¸º `undefined`ï¼Œè€Œ `const` å£°æ˜çš„å˜é‡ä¼šæŠ¥é”™ã€‚

å…³äºæš‚æ—¶æ€§æ­»åŒºçš„æ¦‚å¿µï¼Œæ´å¼•é˜®ä¸€å³°è€å¸ˆåœ¨ [ES6 å…¥é—¨ä¹¦](https://es6.ruanyifeng.com/#docs/let)ä¸­çš„è¯ï¼š

&gt; ES6 æ˜ç¡®è§„å®šï¼Œå¦‚æœåŒºå—ä¸­å­˜åœ¨ `let` å’Œ `const` å‘½ä»¤ï¼Œè¿™ä¸ªåŒºå—å¯¹è¿™äº›å‘½ä»¤å£°æ˜çš„å˜é‡ï¼Œä»ä¸€å¼€å§‹å°±å½¢æˆäº†å°é—­ä½œç”¨åŸŸã€‚å‡¡æ˜¯åœ¨å£°æ˜ä¹‹å‰å°±ä½¿ç”¨è¿™äº›å˜é‡ï¼Œå°±ä¼šæŠ¥é”™ã€‚
&gt; æ€»ä¹‹ï¼Œåœ¨ä»£ç å—å†…ï¼Œä½¿ç”¨ `let` å‘½ä»¤å£°æ˜å˜é‡ä¹‹å‰ï¼Œè¯¥å˜é‡éƒ½æ˜¯ä¸å¯ç”¨çš„ã€‚è¿™åœ¨è¯­æ³•ä¸Šï¼Œç§°ä¸ºâ€œæš‚æ—¶æ€§æ­»åŒºâ€ï¼ˆtemporal dead zoneï¼‰ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ `const` å£°æ˜å‡½æ•°çš„ä¾‹å­ï¼š

```js
test(); // Uncaught ReferenceError: Cannot access &apos;test&apos; before initialization
console.log(test); // Uncaught ReferenceError: Cannot access &apos;test&apos; before initialization
const test = function () {
  console.log(&quot;test&quot;);
};
test(); // test
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `const` å‘½ä»¤å£°æ˜å‡½æ•°ï¼Œåªè¦ä¸€è¿›å…¥å½“å‰ä½œç”¨åŸŸï¼Œæ‰€è¦ä½¿ç”¨çš„ `test` å˜é‡å°±å·²ç»å­˜åœ¨äº†ï¼Œä½†æ˜¯ä¸å¯è·å–ï¼Œå¦‚æœè·å–åˆ™ä¼šæŠ›å‡ºç‰¹åˆ«çš„é”™è¯¯ `Uncaught ReferenceError: Cannot access &apos;test&apos; before initialization`ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè·å–æœªå£°æ˜çš„å˜é‡æŠ›å‡ºçš„é”™è¯¯ä¸º `Uncaught ReferenceError: test is not defined`ï¼‰ã€‚åªæœ‰ç­‰åˆ°å£°æ˜å˜é‡çš„é‚£ä¸€è¡Œä»£ç å‡ºç°ï¼Œæ‰å¯ä»¥è·å–å’Œä½¿ç”¨è¯¥å˜é‡ã€‚ä½¿ç”¨ `let` å‘½ä»¤ä¹Ÿæœ‰åŒæ ·çš„æ•ˆæœã€‚

_[Google JavaScript Style Guide](https://google.github.io/styleguide/jsguide.html#features-use-const-and-let)_ å»ºè®®ä½¿ç”¨ ES6 è§„èŒƒçš„ `const` å’Œ `let` å‘½ä»¤å£°æ˜å˜é‡ï¼Œèˆå¼ƒå®¹æ˜“é€ æˆé”™è¯¯çš„ `var` å‘½ä»¤ã€‚

## ä¸ºä»€ä¹ˆæœ‰å˜é‡æå‡å’Œå‡½æ•°æå‡

å¸ƒå…°ç™»Â·è‰¾å…‹ï¼ˆBrendan Eichï¼‰æ˜¯ JavaScript çš„ä¸»è¦åˆ›é€ è€…ä¸æ¶æ„å¸ˆï¼Œå…³äºâ€œä¸ºä»€ä¹ˆè¦å˜é‡æå‡â€è¿™ä¸ªé—®é¢˜ï¼Œä»–ç»™å‡ºäº†è¿™æ ·çš„å›ç­”ï¼š

&gt; Q: So what is one of the main (if not the main) reasons of variables &quot;hoisting&quot;? / é‚£ä¹ˆï¼Œå˜é‡â€œæå‡â€çš„ä¸»è¦ï¼ˆæˆ–è€…å¹¶éä¸»è¦ï¼‰çš„åŸå› ä¹‹ä¸€æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ
&gt; Brendan Eich: An &quot;abstraction leak&quot; from the first JavaScript VM. Compiler indexes vars to stack slots, binds names to slots on entry. / è¿™æºäºç¬¬ä¸€æ‰¹ JavaScript è™šæ‹Ÿæœºçš„â€œæŠ½è±¡æ³„æ¼â€é—®é¢˜ã€‚ç¼–è¯‘å™¨åœ¨å…¥å£å¤„å°†å˜é‡ç´¢å¼•åˆ°äº†å †æ ˆæ’æ§½ï¼Œå¹¶æŠŠå˜é‡åç»‘å®šç»™äº†æ’æ§½ã€‚

**æŠ½è±¡æ³„æ¼**æ˜¯ä¸€ä¸ªè®¡ç®—æœºæœ¯è¯­ï¼ŒæŒ‡â€œæœ¬åº”éšè—å®ç°ç»†èŠ‚çš„æŠ½è±¡åŒ–ä¸å¯é¿å…åœ°æš´éœ²å‡ºåº•å±‚ç»†èŠ‚ä¸å±€é™æ€§â€ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„æ¦‚å¿µï¼Œä»¥ TCP åè®®ä¸¾ä¾‹ï¼š

&gt; å½“æˆ‘è¯´ TCP åè®®å¯ä»¥ä¿è¯æ¶ˆæ¯ä¸€å®šèƒ½å¤Ÿåˆ°è¾¾ï¼Œäº‹å®ä¸Šå¹¶éå¦‚æ­¤ã€‚å¦‚æœä½ çš„å® ç‰©è›‡æŠŠç½‘çº¿ç»™å’¬åäº†ï¼Œé‚£å³ä¾¿æ˜¯ TCP åè®®ä¹Ÿæ— æ³•ä¼ è¾“æ•°æ®ï¼›å¦‚æœä½ å’Œç½‘ç»œç®¡ç†å‘˜é—¹äº†çŸ›ç›¾ï¼Œä»–å°†ä½ çš„ç½‘å£æ¥åˆ°äº†ä¸€å°è´Ÿè½½å¾ˆé«˜çš„äº¤æ¢æœºä¸Šï¼Œé‚£å³ä¾¿ä½ çš„æ•°æ®åŒ…å¯ä»¥ä¼ è¾“ï¼Œé€Ÿåº¦ä¹Ÿä¼šå¥‡æ…¢æ— æ¯”ã€‚
&gt; è¿™å°±æ˜¯æˆ‘æ‰€è¯´çš„â€œæŠ½è±¡æ³„æ¼â€ã€‚TCP åè®®è¯•å›¾æä¾›ä¸€ä¸ªå®Œæ•´çš„æŠ½è±¡ï¼Œå°†åº•å±‚ä¸å¯é çš„æ•°æ®ä¼ è¾“åŒ…è£…èµ·æ¥ï¼Œä½†æ˜¯ï¼Œåº•å±‚çš„ä¼ è¾“æœ‰æ—¶ä¹Ÿä¼šå‘ç”Ÿé—®é¢˜ï¼Œå³ä¾¿æ˜¯ TCP åè®®ä¹Ÿæ— æ³•è§£å†³ï¼Œè¿™æ—¶ä½ ä¼šå‘ç°ï¼Œå®ƒä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ã€‚TCP åè®®å°±æ˜¯â€œæŠ½è±¡æ³„æ¼å®šå¾‹â€çš„ç¤ºä¾‹ä¹‹ä¸€ï¼Œå…¶å®ï¼Œå‡ ä¹æ‰€æœ‰çš„æŠ½è±¡éƒ½æ˜¯æ³„æ¼çš„ã€‚

è¨€å½’æ­£ä¼ ï¼Œæ­£æ˜¯ç”±äºç¬¬ä¸€æ‰¹ JavaScript è™šæ‹Ÿæœºç¼–è¯‘å™¨ä¸Šä»£ç çš„è®¾è®¡å¤±è¯¯ï¼Œå¯¼è‡´å˜é‡åœ¨å£°æ˜ä¹‹å‰å°±è¢«èµ‹äºˆäº† `undefined` çš„åˆå§‹å€¼ï¼Œè€Œåˆç”±äºè¿™ä¸ªå¤±è¯¯äº§ç”Ÿçš„å½±å“ï¼ˆæ— è®ºå¥½åï¼‰è¿‡äºå¹¿æ³›ï¼Œå› æ­¤åœ¨ç°åœ¨çš„ JavaScript ç¼–è¯‘å™¨ä¸­ä»ä¿ç•™äº†å˜é‡æå‡çš„â€œç‰¹æ€§â€ã€‚

è‡³äºâ€œä¸ºä»€ä¹ˆè¦å‡½æ•°æå‡â€ï¼Œæœ‰äººæå‡ºå¯èƒ½æ˜¯ä¸ºäº†è§£å†³å‡½æ•°ç›¸äº’é€’å½’è°ƒç”¨çš„é—®é¢˜ï¼Œå¸ƒå…°ç™»Â·è‰¾å…‹ç»™äºˆäº†è‚¯å®šå¹¶è¡¥å……é“ï¼š

&gt; Brendan Eich: Yes, function declaration hoisting is for mutual recursion &amp; generally to avoid painful bottom-up ML-like order. / æ˜¯çš„ï¼Œå‡½æ•°æå‡æ˜¯ä¸ºäº†è§£å†³å‡½æ•°ç›¸äº’é€’å½’è°ƒç”¨çš„é—®é¢˜ï¼Œå¹¶åœ¨æ€»ä½“ä¸Šé¿å…äº†åƒ ML è¯­è¨€é‚£æ ·ç—›è‹¦åœ°è‡ªä¸‹è€Œä¸Šè°ƒç”¨çš„é—®é¢˜ã€‚

**å‡½æ•°ç›¸äº’é€’å½’è°ƒç”¨**ï¼Œå¯ä»¥ç†è§£ä¸º A å‡½æ•°å†…ä¼šè°ƒç”¨åˆ° B å‡½æ•°ï¼Œè€Œ B å‡½æ•°ä¹Ÿä¼šè°ƒç”¨åˆ° A å‡½æ•°ã€‚ML è¯­è¨€æ˜¯ 20 ä¸–çºª 70 å¹´ä»£æ—©æœŸå¼€å‘å‡ºæ¥çš„é€šç”¨çš„å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ã€‚

ä¸¾ä¸€ä¸ªç»å…¸çš„ä¾‹å­ï¼š

```js
function isEven(n) {
  if (n === 0) {
    return true;
  }
  return isOdd(n - 1);
}

console.log(isEven(4)); // true

function isOdd(n) {
  if (n === 0) {
    return false;
  }
  return isEven(n - 1);
}
```

å¦‚æœæ²¡æœ‰å‡½æ•°æå‡ï¼Œåœ¨è°ƒç”¨ `isEven` æ–¹æ³•æ—¶ï¼Œç”±äº `isOdd` æ–¹æ³•è¿˜æœªå£°æ˜ï¼Œé‚£ä¹ˆç†è®ºä¸Šæ‰§è¡Œå°±ä¼šå‡ºç°é”™è¯¯ï¼Œåä¹‹äº¦ç„¶ã€‚é€šè¿‡å‡½æ•°æå‡ï¼Œ`isEven` å’Œ `isOdd` æ–¹æ³•ä¹‹é—´çš„ç›¸äº’é€’å½’è°ƒç”¨ä¹Ÿå°±å¯ä»¥å®ç°äº†ã€‚

## å‚è€ƒèµ„æ–™

å¯¹å˜é‡æå‡å’Œå‡½æ•°æå‡çš„è¿›ä¸€æ­¥å­¦ä¹ æ¢è®¨å¯ä»¥å‚è€ƒè¿™ç¯‡åšæ–‡[ã€Šæˆ‘çŸ¥é“ä½ æ‡‚ hoistingï¼Œå¯æ˜¯ä½ äº†è§£åˆ°å¤šæ·±ï¼Ÿã€‹](https://blog.techbridge.cc/2018/11/10/javascript-hoisting/)ï¼Œéå¸¸ä¹‹æ£’ï¼

### æŠ€æœ¯åšå®¢

- [JavaScript ä¸­çš„ Varï¼ŒLet å’Œ Const æœ‰ä»€ä¹ˆåŒºåˆ«](https://chinese.freecodecamp.org/news/javascript-var-let-and-const), 2020-12-08
- [ä»æœ¬è´¨ä¸Šç†è§£ JavaScript ä¸­çš„å˜é‡æå‡](https://juejin.cn/post/6844903895341219854), 2019-07-23
- [JavaScriptï¼šæ·±å…¥ç†è§£ JavaScript-è¯æ³•ç¯å¢ƒ](https://limeii.github.io/2019/05/js-lexical-environment/), 2019-05-06
- [å˜é‡å£°æ˜ç³»åˆ—ä¹‹ ES5(å˜é‡æå‡)](https://blog.csdn.net/weixin_38080573/article/details/79372448), 2018-02-25
- [JavaScript: å˜é‡æå‡å’Œå‡½æ•°æå‡](https://www.cnblogs.com/liuhe688/p/5891273.html), 2016-10-18
- [æŠ½è±¡æ³„æ¼å®šå¾‹](http://shzhangji.com/cnblogs/2013/12/17/the-law-of-leaky-abstractions/), 2013-12-17, è‹±æ–‡[åŸæ–‡é“¾æ¥](https://www.joelonsoftware.com/2002/11/11/the-law-of-leaky-abstractions/)

### å…¶å®ƒèµ„æ–™

- [Hoistingï¼ˆå˜é‡æå‡ï¼‰- MDN](https://developer.mozilla.org/zh-CN/docs/Glossary/Hoisting)
- [Google JavaScript Style Guide](https://google.github.io/styleguide/jsguide.html)
- [let å’Œ const å‘½ä»¤ - ã€ŠECMAScript 6 å…¥é—¨ã€‹](https://es6.ruanyifeng.com)
- [Leaky abstraction - Wikipedia](https://en.wikipedia.org/wiki/Leaky_abstraction)

## å…³äºæŠ½è±¡æ³„æ¼çš„è¡¥å……

è‰¾æ—Â·çº¦è€³Â·æ–¯æ³¢å°”æ–¯åŸºï¼ˆAvram Joel Spolskyï¼‰æ˜¯ç¨‹åºå‘˜å¿…å¤‡çš„é—®ç­”ç½‘ç«™ Stack Overflow çš„åˆ›å§‹äººä¹‹ä¸€ï¼Œäº 2002 å¹´ 11 æœˆ 11 æ—¥åœ¨åšæ–‡ [_The Law of Leaky Abstractions_](https://www.joelonsoftware.com/2002/11/11/the-law-of-leaky-abstractions/) ä¸­å¯¹æŠ½è±¡æ³„æ¼å®šå¾‹åšäº†éå¸¸è¯¦å°½çš„æè¿°ï¼Œå…¶ä¸­ä¸€äº›çœ‹æ³•è®©æˆ‘å†èµåŒä¸è¿‡äº†ï¼Œé‚è®°å½•åœ¨è¿™é‡Œï¼ˆä¸­æ–‡ç¿»è¯‘æ¥è‡ª[æ­¤åšå®¢](http://shzhangji.com/cnblogs/2013/12/17/the-law-of-leaky-abstractions/)ï¼‰ï¼š

&gt; ......
&gt; One reason the law of leaky abstractions is problematic is that it means that abstractions do not really simplify our lives as much as they were meant to. When Iâ€™m training someone to be a C++ programmer, it would be nice if I never had to teach them about char*â€™s and pointer arithmetic. It would be nice if I could go straight to STL strings. But one day theyâ€™ll write the code â€œfooâ€ + â€œbarâ€, and truly bizarre things will happen, and then Iâ€™ll have to stop and teach them all about char*â€™s anyway. Or one day theyâ€™ll be trying to call a Windows API function that is documented as having an OUT LPTSTR argument and they wonâ€™t be able to understand how to call it until they learn about char\*â€™s, and pointers, and Unicode, and wchar_tâ€™s, and the TCHAR header files, and all that stuff that leaks up.
&gt; æŠ½è±¡æ³„æ¼å¼•å‘çš„éº»çƒ¦ä¹‹ä¸€æ˜¯ï¼Œå®ƒå¹¶æ²¡æœ‰å®Œå…¨ç®€åŒ–æˆ‘ä»¬çš„å·¥ä½œã€‚å½“æˆ‘æŒ‡å¯¼åˆ«äººå­¦ä¹  C++ æ—¶ï¼Œæˆ‘å½“ç„¶å¸Œæœ›å¯ä»¥è·³è¿‡ char \* å’ŒæŒ‡é’ˆè¿ç®—ï¼Œç›´æ¥è®²è§£ STL å­—ç¬¦ä¸²ç±»åº“çš„ä½¿ç”¨ã€‚ä½†æ˜¯ï¼Œå½“æŸä¸€å¤©ä»–å†™å‡ºäº† â€œfooâ€ + â€œbarâ€ è¿™æ ·çš„ä»£ç ï¼Œå¹¶è¯¢é—®æˆ‘ä¸ºä»€ä¹ˆç¼–è¯‘é”™è¯¯æ—¶ï¼Œæˆ‘è¿˜æ˜¯éœ€è¦å‘Šè¯‰ä»– char \* çš„å­˜åœ¨ã€‚æˆ–è€…è¯´ï¼Œå½“ä»–éœ€è¦è°ƒç”¨ä¸€ä¸ª Windows APIï¼Œéœ€è¦æŒ‡å®š OUT LPTSTR å‚æ•°ï¼Œè¿™æ—¶ä»–å°±å¿…é¡»å­¦ä¹  char \*ã€æŒ‡é’ˆã€Unicodeã€wchar_tã€TCHAR å¤´æ–‡ä»¶ç­‰ä¸€ç³»åˆ—çŸ¥è¯†ï¼Œè¿™äº›éƒ½æ˜¯æŠ½è±¡æ³„æ¼ã€‚
&gt; ......
&gt; In teaching someone about ASP.NET programming, it would be nice if I could just teach them that they can double-click on things and then write code that runs on the server when the user clicks on those things. Indeed ASP.NET abstracts away the difference between writing the HTML code to handle clicking on a hyperlink (\&lt;a&gt;) and the code to handle clicking on a button. Problem: the ASP.NET designers needed to hide the fact that in HTML, thereâ€™s no way to submit a form from a hyperlink. They do this by generating a few lines of JavaScript and attaching an onclick handler to the hyperlink. The abstraction leaks, though. If the end-user has JavaScript disabled, the ASP.NET application doesnâ€™t work correctly, and if the programmer doesnâ€™t understand what ASP.NET was abstracting away, they simply wonâ€™t have any clue what is wrong.
&gt; åœ¨æŒ‡å¯¼ ASP.NET ç¼–ç¨‹æ—¶ï¼Œæˆ‘å¸Œæœ›å¯ä»¥ç›´æ¥å‘Šè¯‰å¤§å®¶åŒå‡»é¡µé¢ä¸Šçš„æ§ä»¶ï¼Œåœ¨å¼¹å‡ºçš„ä»£ç æ¡†ä¸­è¾“å…¥ç‚¹å‡»å“åº”äº‹ä»¶ã€‚çš„ç¡®ï¼ŒASP.NET å°†å¤„ç†ç‚¹å‡»çš„ HTML ä»£ç æŠ½è±¡æ‰äº†ï¼Œä½†é—®é¢˜åœ¨äºï¼ŒASP.NET çš„è®¾è®¡è€…éœ€è¦åŠ¨ç”¨ JavaScript æ¥æ¨¡æ‹Ÿè¡¨å•çš„æäº¤ï¼Œå› ä¸º HTML ä¸­çš„ \&lt;a&gt; æ ‡ç­¾æ˜¯æ²¡æœ‰è¿™ä¸€åŠŸèƒ½çš„ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¦‚æœç»ˆç«¯ç”¨æˆ·å°† JavaScript ç¦æ­¢äº†ï¼Œè¿™ä¸ªç¨‹åºå°†æ— æ³•è¿è¡Œã€‚åˆå­¦è€…ä¼šä¸çŸ¥æ‰€æªï¼Œç›´è‡³ä»–äº†è§£ ASP.NET çš„è¿ä½œæ–¹å¼ï¼Œäº†è§£å®ƒç©¶ç«Ÿå°†ä»€ä¹ˆæ ·çš„å·¥ä½œå°è£…èµ·æ¥äº†ï¼Œæ‰èƒ½è¿›ä¸€æ­¥æ’æŸ¥ã€‚
&gt; The law of leaky abstractions means that whenever somebody comes up with a wizzy new code-generation tool that is supposed to make us all ever-so-efficient, you hear a lot of people saying â€œlearn how to do it manually first, then use the wizzy tool to save time.â€ Code generation tools which pretend to abstract out something, like all abstractions, leak, and the only way to deal with the leaks competently is to learn about how the abstractions work and what they are abstracting. So the abstractions save us time working, but they donâ€™t save us time learning.
&gt; ç”±äºæŠ½è±¡å®šå¾‹çš„å­˜åœ¨ï¼Œæ¯å½“æœ‰äººè¯´è‡ªå·±å‘ç°äº†ä¸€æ¬¾æ–°çš„ä»£ç ç”Ÿæˆå·¥å…·ï¼Œèƒ½å¤Ÿå¤§å¤§æé«˜æˆ‘ä»¬çš„ç¼–ç¨‹æ•ˆç‡æ—¶ï¼Œä½ ä¼šå¬å¾ˆå¤šäººè¯´â€œå…ˆå­¦ä¹ æ‰‹å·¥ç¼–å†™ï¼Œå†å»ç”¨å·¥å…·ç”Ÿæˆâ€ã€‚ä»£ç ç”Ÿæˆå·¥å…·æ˜¯ä¸€ç§æŠ½è±¡ï¼ŒåŒæ ·ä¹Ÿä¼šæ³„æ¼ï¼Œå”¯ä¸€çš„è§£å†³æ–¹æ³•æ˜¯å­¦ä¹ å®ƒçš„å®ç°åŸç†ï¼Œå³å®ƒæŠ½è±¡äº†ä»€ä¹ˆã€‚æ‰€ä»¥è¯´æŠ½è±¡åªæ˜¯ç”¨äºæé«˜æˆ‘ä»¬çš„å·¥ä½œæ•ˆç‡çš„ï¼Œè€Œä¸ä¼šèŠ‚çœæˆ‘ä»¬çš„å­¦ä¹ æ—¶é—´ã€‚
&gt; And all this means that paradoxically, even as we have higher and higher level programming tools with better and better abstractions, becoming a proficient programmer is getting harder and harder.
&gt; è¿™å°±å½¢æˆäº†ä¸€ä¸ªæ‚–è®ºï¼šå½“æˆ‘ä»¬æ‹¥æœ‰è¶Šæ¥è¶Šé«˜çº§çš„å¼€å‘å·¥å…·ï¼Œè¶Šæ¥è¶Šå¥½çš„â€œæŠ½è±¡â€ï¼Œè¦æˆä¸ºä¸€ä¸ªé«˜æ°´å¹³çš„ç¨‹åºå‘˜åè€Œè¶Šæ¥è¶Šå›°éš¾äº†ã€‚
&gt; ......
&gt; Ten years ago, we might have imagined that new programming paradigms would have made programming easier by now. Indeed, the abstractions weâ€™ve created over the years do allow us to deal with new orders of complexity in software development that we didnâ€™t have to deal with ten or fifteen years ago, like GUI programming and network programming. And while these great tools, like modern OO forms-based languages, let us get a lot of work done incredibly quickly, suddenly one day we need to figure out a problem where the abstraction leaked, and it takes 2 weeks. And when you need to hire a programmer to do mostly VB programming, itâ€™s not good enough to hire a VB programmer, because they will get completely stuck in tar every time the VB abstraction leaks.
&gt; åå¹´å‰ï¼Œæˆ‘ä»¬ä¼šæƒ³è±¡æœªæ¥èƒ½å¤Ÿå‡ºç°å„ç§æ–°å¼çš„ç¼–ç¨‹èŒƒå‹ï¼Œç®€åŒ–æˆ‘ä»¬çš„å·¥ä½œã€‚çš„ç¡®ï¼Œè¿™äº›å¹´æˆ‘ä»¬åˆ›é€ çš„å„ç±»æŠ½è±¡ä½¿å¾—å¼€å‘å¤æ‚çš„å¤§å‹è½¯ä»¶å˜å¾—æ¯”åäº”å¹´å‰è¦ç®€å•å¾—å¤šï¼Œå°±åƒ GUI å’Œç½‘ç»œç¼–ç¨‹ã€‚ç°ä»£çš„é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€è®©æˆ‘ä»¬çš„å·¥ä½œå˜å¾—é«˜æ•ˆå¿«é€Ÿã€‚ä½†çªç„¶æœ‰ä¸€å¤©ï¼Œè¿™ç§æŠ½è±¡æ³„æ¼å‡ºä¸€ä¸ªé—®é¢˜ï¼Œè§£å†³å®ƒéœ€è¦è€—è´¹ä¸¤æ˜ŸæœŸã€‚å¦‚æœä½ éœ€è¦æ‹›å½•ä¸€ä¸ª VB ç¨‹åºå‘˜ï¼Œé‚£ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œå› ä¸ºå½“ä»–ç¢°åˆ° VB è¯­è¨€æ³„æ¼çš„é—®é¢˜æ—¶ï¼Œä»–ä¼šå˜å¾—å¯¸æ­¥éš¾è¡Œã€‚
&gt; The Law of Leaky Abstractions is dragging us down.
&gt; æŠ½è±¡æ³„æ¼å®šå¾‹æ­£åœ¨é˜»ç¢æˆ‘ä»¬å‰è¿›ã€‚
</content:original-text><content:updated-at>2022-10-21T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[å‡½æ•°é˜²æŠ–å’ŒèŠ‚æµï¼Œä»¥åŠåœ¨ Vue ä¸­çš„è¿ç”¨]]></title><description><![CDATA[åœ¨å‰ç«¯æ€§èƒ½ä¼˜åŒ–ä¸­å­˜åœ¨ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ï¼šå¦‚ä½•ä¼˜åŒ–é«˜é¢‘ç‡æ‰§è¡Œçš„ JS ä»£ç ï¼Ÿä¾‹å¦‚ï¼š æˆ‘ä»¬ä¸ºæµè§ˆå™¨æ»šåŠ¨ scroll ç»‘å®šäº†ç›‘å¬äº‹ä»¶ï¼Œå½“æ»šåŠ¨åˆ°æŸä½ç½®ä¹‹ä¸‹åï¼Œä¼šåœ¨æµè§ˆå™¨å³ä¸‹æ–¹æ˜¾ç¤ºä¸€ä¸ªç‚¹å‡»åèƒ½å¿«é€Ÿå›åˆ°é¡µé¢é¡¶éƒ¨çš„æµ®åŠ¨æŒ‰é’®ï¼›è€Œæ»šåŠ¨å›è¯¥ä½ç½®ä¹‹ä¸Šæ—¶ï¼Œæµ®åŠ¨æŒ‰é’®æ¶ˆå¤±ã€‚ç°åœ¨æˆ‘ä»¬å‘ç°ï¼Œç”¨æˆ·æ¯æ¬¡ä½¿ç”¨æ»šè½®æ»‘åŠ¨é¡µé¢ï¼Œéƒ½ä¼šè§¦å‘å¾ˆå¤šæ¬¡è¯¥äº‹ä»¶ï¼Œåˆ¤æ–­å½“å‰åœ¨è¯¥ä½ç½®ä¹‹ä¸Šè¿˜æ˜¯ä¹‹ä¸‹ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†å‰ç«¯çš„æ€§èƒ½ã€‚ æˆ‘ä»¬ä¸ºç½‘é¡µæ·»åŠ äº†æœç´¢åŠŸèƒ½â€¦]]></description><link>https://blog.towind.fun/posts/js-debounce-throttle</link><guid isPermaLink="false">js-debounce-throttle</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Sat, 08 May 2021 00:00:00 GMT</pubDate><content:original-text>
åœ¨å‰ç«¯æ€§èƒ½ä¼˜åŒ–ä¸­å­˜åœ¨ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ï¼šå¦‚ä½•ä¼˜åŒ–**é«˜é¢‘ç‡æ‰§è¡Œ**çš„ JS ä»£ç ï¼Ÿä¾‹å¦‚ï¼š

1. æˆ‘ä»¬ä¸ºæµè§ˆå™¨æ»šåŠ¨ scroll ç»‘å®šäº†ç›‘å¬äº‹ä»¶ï¼Œå½“æ»šåŠ¨åˆ°æŸä½ç½®ä¹‹ä¸‹åï¼Œä¼šåœ¨æµè§ˆå™¨å³ä¸‹æ–¹æ˜¾ç¤ºä¸€ä¸ªç‚¹å‡»åèƒ½å¿«é€Ÿå›åˆ°é¡µé¢é¡¶éƒ¨çš„æµ®åŠ¨æŒ‰é’®ï¼›è€Œæ»šåŠ¨å›è¯¥ä½ç½®ä¹‹ä¸Šæ—¶ï¼Œæµ®åŠ¨æŒ‰é’®æ¶ˆå¤±ã€‚ç°åœ¨æˆ‘ä»¬å‘ç°ï¼Œç”¨æˆ·æ¯æ¬¡ä½¿ç”¨æ»šè½®æ»‘åŠ¨é¡µé¢ï¼Œéƒ½ä¼šè§¦å‘å¾ˆå¤šæ¬¡è¯¥äº‹ä»¶ï¼Œåˆ¤æ–­å½“å‰åœ¨è¯¥ä½ç½®ä¹‹ä¸Šè¿˜æ˜¯ä¹‹ä¸‹ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†å‰ç«¯çš„æ€§èƒ½ã€‚
2. æˆ‘ä»¬ä¸ºç½‘é¡µæ·»åŠ äº†æœç´¢åŠŸèƒ½ï¼Œå½“ç”¨æˆ·è¾“å…¥æœç´¢å…³é”®å­—åï¼Œä¼šè‡ªåŠ¨æ˜¾ç¤ºå‡ºæœç´¢çš„ç»“æœã€‚ä½†æ˜¯ï¼Œç”¨æˆ·æ¯æ¬¡æ›´æ”¹è¾“å…¥éƒ½ç«‹å³è°ƒç”¨åç«¯è¿›è¡Œäº†æœç´¢ï¼Œå½¼æ—¶ç”¨æˆ·å¯èƒ½å°šæœªè¾“å…¥å®Œå…³é”®å­—ï¼Œäº¦æˆ–æ˜¯å…³é”®å­—è¾“å…¥é”™è¯¯éœ€è¦ä¿®æ”¹ã€‚è¿™æ ·æœç´¢å‡ºæ¥çš„ç»“æœå¹¶éç”¨æˆ·å¸Œæœ›çœ‹åˆ°çš„ï¼ŒåŒæ—¶è¿˜é™ä½äº†å‰ç«¯æ€§èƒ½ï¼Œæµªè´¹äº†å¤§é‡çš„æœåŠ¡å™¨èµ„æºã€‚

é’ˆå¯¹ä¸Šè¿°åˆ—ä¸¾çš„é—®é¢˜ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšï¼Œæ‰èƒ½åœ¨ä¼˜åŒ–å‰ç«¯æ€§èƒ½çš„åŒæ—¶ä¸è‡³äºå½±å“åˆ°ç”¨æˆ·çš„ä½“éªŒï¼Œä¾¿æ˜¯æœ¬æ–‡æ¢è®¨çš„å†…å®¹ã€‚

## å‡½æ•°èŠ‚æµ

å‡½æ•°èŠ‚æµï¼ˆThrottleï¼‰ï¼ŒæŒ‡åœ¨è§¦å‘äº‹ä»¶åçš„ä¸€å®šæ—¶é—´å†…ç»‘å®šçš„å‡½æ•°åªèƒ½æ‰§è¡Œä¸€æ¬¡ã€‚

å‡½æ•°èŠ‚æµçš„å®ç°æ€è·¯æ¯”è¾ƒç®€å•ï¼Œä¾‹å¦‚ä½¿ç”¨ `setTimeout` æ–¹æ³•å®ç°ï¼šç”±äº `setTimeout` æ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ï¼Œè¡¨ç¤ºå®šæ—¶å™¨çš„ç¼–å·ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨é—­åŒ…çš„æ–¹æ³•ç»´æŠ¤ä¸€ä¸ªå®šæ—¶å™¨ç¼–å·ã€‚æ¯æ¬¡è§¦å‘äº‹ä»¶æ—¶éƒ½é€šè¿‡å®šæ—¶å™¨ç¼–å·åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰å°šæœªåˆ°æœŸçš„å®šæ—¶å™¨ï¼Œå¦‚æœæœ‰åˆ™ç»“æŸï¼Œå¦‚æœæ²¡æœ‰åˆ™å¯ç”¨ä¸€ä¸ªå®šæ—¶å™¨ã€‚å®šæ—¶å™¨åˆ°æœŸåè°ƒç”¨ç»‘å®šçš„éœ€è¦èŠ‚æµçš„å‡½æ•°ï¼Œå¹¶è®¾ç½®å®šæ—¶å™¨ç¼–å·ä¸ºç©ºï¼Œè¡¨ç¤ºå¯ä»¥å¯ç”¨ä¸€ä¸ªæ–°çš„å®šæ—¶å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```js
/**
 * å‡½æ•°èŠ‚æµ
 * è¿ç»­è§¦å‘äº‹ä»¶ä½†æ˜¯åœ¨ wait æ¯«ç§’ä¸­åªæ‰§è¡Œä¸€æ¬¡å‡½æ•°
 * @param {Function} func æ‰§è¡Œçš„å‡½æ•°
 * @param {Number} wait å‡½æ•°èŠ‚æµç­‰å¾…çš„æ—¶é—´ï¼Œå•ä½ä¸º ms
 * @returns èŠ‚æµæ‰§è¡Œçš„å‡½æ•°
 */
function throttle1(func, wait) {
  let timer; // ç»´æŠ¤çš„å®šæ—¶å™¨ç¼–å·
  return function () {
    // è¿”å›èŠ‚æµæ‰§è¡Œçš„å‡½æ•°ï¼Œå¯ä»¥ç»‘å®šç»™äº‹ä»¶
    const args = arguments; // æ‰§è¡Œå‡½æ•°çš„å‚æ•°
    if (!timer) {
      // å½“å®šæ—¶å™¨ä¸å­˜åœ¨æˆ–å·²åˆ°æœŸæ—¶
      timer = setTimeout(() =&gt; {
        // å¯ç”¨ä¸€ä¸ªæ–°çš„å®šæ—¶å™¨
        timer = undefined; // åˆ°æœŸåè®¾ç½®å®šæ—¶å™¨ç¼–å·ä¸ºç©º
        func.apply(this, args); // åˆ°æœŸåæ‰§è¡Œå‡½æ•°
      }, wait); // å®šæ—¶å™¨ç­‰å¾… wait æ¯«ç§’åæ‰§è¡Œ
    }
  };
}
```

`setTimeout` çš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨è§¦å‘äº‹ä»¶åçš„ wait æ¯«ç§’è‡ªåŠ¨åæ‰§è¡Œéœ€è¦èŠ‚æµçš„å‡½æ•°ã€‚

éœ€è¦ç‰¹åˆ«ç•™æ„çš„æ˜¯ä¸Šè¿°ä»£ç æœ‰è¿™æ ·ä¸€ä¸ªç»†èŠ‚ï¼š`setTimeout(() =&gt; { func.apply(this, args) }, wait)`ã€‚

æˆ‘ä»¬ä½¿ç”¨äº†ç®­å¤´å‡½æ•°ï¼Œä½¿å¾— `setTimeout` ä¸­æ–¹æ³•å†… `this` çš„ä½œç”¨äºæŒ‡å‘ç»‘å®šæ­¤èŠ‚æµå‡½æ•°çš„å¯¹è±¡ï¼Œè€Œéå…¨å±€ `window` å¯¹è±¡ã€‚

æ­¤å¤–ï¼Œå¦‚æœä¸ä½¿ç”¨ `apply()` æ–¹æ³•è€Œæ˜¯ç›´æ¥è°ƒç”¨å‡½æ•°çš„è¯ï¼ŒèŠ‚æµæ‰§è¡Œå‡½æ•°å†…çš„ `this` å¯¹è±¡ä»æŒ‡å‘çš„æ˜¯å…¨å±€çš„ `window` å¯¹è±¡ï¼Œè€Œéæˆ‘ä»¬æœŸæœ›çš„ç»‘å®šæ­¤èŠ‚æµå‡½æ•°çš„å¯¹è±¡ï¼Œå› æ­¤åº”ä½¿ç”¨ `apply()` ä¼ å…¥ `this` ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚

å¯¹äºå®ç°ä¼ å…¥ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œ`call()` æ–¹æ³•çš„ä½œç”¨å’Œ `apply()` ç›¸åŒï¼Œåªæ˜¯å‰è€…éœ€è¦å°†ä¼ å…¥çš„å‚æ•°åˆ—ä¸¾å‡ºæ¥ï¼Œè€Œåè€…éœ€è¦å°†ä¼ å…¥çš„å‚æ•°æ”¾åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨ `const args = arguments` è·å–äº†å‡½æ•°ä¼ å…¥çš„å‚æ•°ï¼Œè€Œ `args` ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå› æ­¤é€‰æ‹©ä½¿ç”¨ `apply()` çš„æ–¹æ³•ã€‚

å‡å¦‚ä¸ä½¿ç”¨ç®­å¤´å‡½æ•°ï¼Œåº”è¯¥åœ¨ `setTimeout` æ–¹æ³•å‰è·å– `this` ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå†è°ƒç”¨ `apply()` æ–¹æ³•ï¼Œå¦‚ï¼š

```js
/**
 * å‡½æ•°èŠ‚æµéç®­å¤´å‡½æ•°ç‰ˆæœ¬
 * è¿ç»­è§¦å‘äº‹ä»¶ä½†æ˜¯åœ¨ wait æ¯«ç§’ä¸­åªæ‰§è¡Œä¸€æ¬¡å‡½æ•°
 * @param {Function} func æ‰§è¡Œçš„å‡½æ•°
 * @param {Number} wait å‡½æ•°èŠ‚æµç­‰å¾…çš„æ—¶é—´ï¼Œå•ä½ä¸º ms
 * @returns èŠ‚æµæ‰§è¡Œçš„å‡½æ•°
 */
function throttle2(func, wait) {
  let timer;
  return function () {
    const args = arguments;
    const that = this; // è·å–ä½œç”¨åŸŸä¸Šä¸‹æ–‡
    if (!timer) {
      timer = setTimeout(function () {
        // ä½¿ç”¨ function () {} çš„æ–¹å¼
        timer = undefined;
        func.apply(that, args); // ä½¿ç”¨ç»‘å®šçš„ä¸Šä¸‹æ–‡å¯¹è±¡
      }, wait);
    }
  };
}
```

å¦‚æœä¸å–œæ¬¢ `setTimeout` æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ—¶é—´æˆ³çš„æ–¹æ³•å®ç°å‡½æ•°èŠ‚æµï¼šåˆ©ç”¨é—­åŒ…çš„æ–¹æ³•ç»´æŠ¤ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œæ¯æ¬¡è§¦å‘äº‹ä»¶æ—¶é€šè¿‡å½“å‰çš„æ—¶é—´æˆ³å’Œç»´æŠ¤çš„æ—¶é—´æˆ³ä¹‹é—´çš„å·®å€¼è·å–é—´éš”çš„æ—¶é—´ã€‚è‹¥é—´éš”æ—¶é—´å¤§äºé¢„è®¾çš„ç­‰å¾…æ—¶é—´ï¼Œåˆ™æ‰§è¡Œå‡½æ•°ï¼Œå¹¶è®¾ç½®ç»´æŠ¤çš„æ—¶é—´æˆ³ä¸ºå½“å‰çš„æ—¶é—´æˆ³ã€‚

```js
/**
 * å‡½æ•°èŠ‚æµæ—¶é—´æˆ³ç‰ˆæœ¬
 * è¿ç»­è§¦å‘äº‹ä»¶ä½†æ˜¯åœ¨ wait æ¯«ç§’ä¸­åªæ‰§è¡Œä¸€æ¬¡å‡½æ•°
 * @param {Function} func æ‰§è¡Œçš„å‡½æ•°
 * @param {Number} wait å‡½æ•°èŠ‚æµç­‰å¾…çš„æ—¶é—´ï¼Œå•ä½ä¸º ms
 * @returns èŠ‚æµæ‰§è¡Œçš„å‡½æ•°
 */
function throttle3(func, wait) {
  let previous = new Date();
  return function () {
    const args = arguments;
    const now = new Date(); // è·å–å½“å‰çš„æ—¶é—´
    if (now - previous &gt; wait) {
      // Date å¯¹è±¡åœ¨è®¡ç®—æ—¶ä¼šéšå¼è½¬æ¢ä¸ºæ—¶é—´æˆ³ï¼Œå½“é—´éš”æ—¶é—´å¤§äºç­‰å¾…æ—¶é—´æ—¶
      previous = now; // è®¾ç½®ç»´æŠ¤çš„æ—¶é—´ä¸ºå½“å‰çš„æ—¶é—´
      func.apply(this, args); // æ‰§è¡Œå‡½æ•°
    }
  };
}
```

æ—¶é—´æˆ³çš„æ–¹æ³•ä¸ä¼šåœ¨ç­‰å¾…æ—¶é—´åè‡ªåŠ¨æ‰§è¡Œéœ€è¦èŠ‚æµçš„å‡½æ•°ï¼Œè€Œæ˜¯åœ¨ä¸‹ä¸€æ¬¡è§¦å‘äº‹ä»¶åæ‰æ‰§è¡Œã€‚åº”æ ¹æ®å…·ä½“éœ€æ±‚åœ¨ `setTimeout` å’Œæ—¶é—´æˆ³çš„æ–¹æ³•ä¹‹é—´è¿›è¡Œé€‰æ‹©ã€‚

ç‰¹åˆ«çš„ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®å½“è§¦å‘äº‹ä»¶åç«‹å³æ‰§è¡Œéœ€è¦èŠ‚æµçš„å‡½æ•°ï¼Œå†ç­‰å¾…ä¸€å®šæ—¶é—´åæ‰èƒ½å†æ¬¡æ‰§è¡Œæ­¤å‡½æ•°ã€‚åŸºäº `setTimeout` çš„æ–¹æ³•ï¼Œæ”¹è‰¯ä»£ç å¦‚ä¸‹ï¼š

```js
/**
 * å‡½æ•°èŠ‚æµ setTimeout æ”¹è‰¯ç‰ˆæœ¬
 * è¿ç»­è§¦å‘äº‹ä»¶ä½†æ˜¯åœ¨ wait æ¯«ç§’ä¸­åªæ‰§è¡Œä¸€æ¬¡å‡½æ•°
 * @param {Function} func æ‰§è¡Œçš„å‡½æ•°
 * @param {Number} wait å‡½æ•°èŠ‚æµç­‰å¾…çš„æ—¶é—´ï¼Œå•ä½ä¸º ms
 * @param {Boolean} immediate è§¦å‘åç«‹å³æ‰§è¡Œå‡½æ•°
 * @returns èŠ‚æµæ‰§è¡Œçš„å‡½æ•°
 */
function throttle4(func, wait, immediate = false) {
  let timer;
  return function () {
    const args = arguments;
    if (!timer) {
      if (immediate) {
        // è®¾ç½®ç«‹å³æ‰§è¡Œå‡½æ•°
        timer = setTimeout(() =&gt; {
          // å¯ç”¨ä¸€ä¸ªæ–°çš„å®šæ—¶å™¨
          timer = undefined; // åˆ°æœŸåè®¾ç½®å®šæ—¶å™¨ç¼–å·ä¸ºç©º
        }, wait); // å®šæ—¶å™¨ç­‰å¾… wait æ¯«ç§’åæ‰§è¡Œ
        func.apply(this, args); // ç«‹å³æ‰§è¡Œå‡½æ•°
      } else {
        timer = setTimeout(() =&gt; {
          timer = undefined;
          func.apply(this, args);
        }, wait);
      }
    }
  };
}
```

## å‡½æ•°é˜²æŠ–

å‡½æ•°é˜²æŠ–ï¼ˆDebounceï¼‰ï¼ŒæŒ‡åœ¨è§¦å‘äº‹ä»¶åçš„ä¸€å®šæ—¶é—´å†…ç»‘å®šçš„å‡½æ•°åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚æœåœ¨è¿™æ®µæ—¶é—´å†…åˆè§¦å‘äº†äº‹ä»¶ï¼Œåˆ™ä¼šé‡æ–°è®¡ç®—æ—¶é—´ã€‚

ä»å®šä¹‰ä¸Šæ¥çœ‹ï¼Œå‡½æ•°é˜²æŠ–åƒæ˜¯å‡½æ•°èŠ‚æµçš„â€œå¼ºåŒ–ç‰ˆâ€ï¼šå‡½æ•°èŠ‚æµä¿è¯åœ¨ä¸€å®šæ—¶é—´å†…åªæ‰§è¡Œä¸€æ¬¡äº‹ä»¶ç»‘å®šçš„å‡½æ•°ï¼Œè€Œå‡½æ•°é˜²æŠ–ç¡®ä¿äº†äº‹ä»¶åœ¨**ä¸€å®šæ—¶é—´å†…ç¨³å®šä¸å˜**åæ‰æ‰§è¡Œç»‘å®šçš„å‡½æ•°ã€‚

å‡½æ•°é˜²æŠ–çš„å®ç°æ€è·¯æ›´åŠ ç®€å•ï¼šåŒæ ·é€‚ç”¨é—­åŒ…çš„æ–¹æ³•ç»´æŠ¤ä¸€ä¸ªå®šæ—¶å™¨ç¼–å·ï¼Œæ¯æ¬¡è§¦å‘äº‹ä»¶æ—¶éƒ½é€šè¿‡æ­¤ç¼–å·å–æ¶ˆä¹‹å‰çš„å®šæ—¶å™¨ï¼Œå¹¶å¯ç”¨ä¸€ä¸ªæ–°çš„å®šæ—¶å™¨ã€‚å®šæ—¶å™¨åˆ°æœŸåæ‰§è¡Œéœ€è¦é˜²æŠ–çš„å‡½æ•°ï¼Œå¹¶è®¾ç½®å®šæ—¶å™¨ç¼–å·ä¸ºç©ºã€‚

ç‰¹åˆ«çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®¾ç½®å½“è§¦å‘äº‹ä»¶åç«‹å³æ‰§è¡Œéœ€è¦é˜²æŠ–çš„å‡½æ•°ã€‚è§¦å‘äº‹ä»¶æ—¶ï¼Œè‹¥ç»´æŠ¤çš„å®šæ—¶å™¨ç¼–å·ä¸ºç©ºï¼Œè¡¨ç¤ºå¯ä»¥ç«‹å³æ‰§è¡Œå‡½æ•°ã€‚æ­¤æ—¶å¯ç”¨ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå®šæ—¶å™¨åˆ°æœŸåè®¾ç½®ç¼–å·ä¸ºç©ºã€‚å½“å­˜åœ¨å®šæ—¶å™¨ç¼–å·æ—¶ï¼Œè¡¨ç¤ºä»åœ¨ç­‰å¾…æ—¶é—´å†…ï¼Œä¸ä¼šæ‰§è¡Œéœ€è¦é˜²æŠ–çš„å‡½æ•°ï¼Œæ­¤æ—¶æˆ‘ä»¬æ¸…é™¤å‰ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¹¶å¯ç”¨ä¸€ä¸ªæ–°çš„å®šæ—¶å™¨ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```js
/**
 * å‡½æ•°é˜²æŠ–
 * è§¦å‘äº‹ä»¶ååœ¨ wait æ¯«ç§’å†…å‡½æ•°åªæ‰§è¡Œä¸€æ¬¡ï¼›å¦‚æœåœ¨ wait æ¯«ç§’å†…åˆè§¦å‘äº†äº‹ä»¶ï¼Œåˆ™ä¼šé‡æ–°è®¡ç®—å‡½æ•°æ‰§è¡Œæ—¶é—´
 * @param {Function} func éœ€è¦é˜²æŠ–çš„å‡½æ•°
 * @param {Number} wait é˜²æŠ–çš„ç­‰å¾…æ—¶é—´ï¼Œå•ä½ä¸º ms
 * @param {Boolean} immediate è§¦å‘äº‹ä»¶åç«‹å³æ‰§è¡Œå‡½æ•°
 * @returns é˜²æŠ–æ‰§è¡Œçš„å‡½æ•°
 */
function debounce(func, wait, immediate = false) {
  let timer;
  return function () {
    const args = arguments;

    timer &amp;&amp; clearTimeout(timer); // å¦‚æœå®šæ—¶å™¨ç¼–å·ä¸ä¸ºç©ºï¼Œåˆ™æ¸…é™¤å®šæ—¶å™¨ã€‚æ­¤å¤„åªæ˜¯æ¸…é™¤å®šæ—¶å™¨ï¼Œå¹¶æœªæ¸…é™¤å®šæ—¶å™¨ç¼–å·

    if (immediate) {
      // è®¾ç½®ç«‹å³æ‰§è¡Œå‡½æ•°
      !timer &amp;&amp; func.apply(this, args); // å¦‚æœå®šæ—¶å™¨ç¼–å·ä¸ä¸ºç©ºï¼Œå³åœ¨ç­‰å¾…æ—¶é—´å†…ï¼Œä¸æ‰§è¡Œå‡½æ•°ï¼›è‹¥ä¸ºç©ºï¼Œåˆ™æ‰§è¡Œå‡½æ•°
      timer = setTimeout(() =&gt; {
        // å¯ç”¨æ–°çš„å®šæ—¶å™¨
        timer = undefined; // å®šæ—¶å™¨åˆ°æœŸåæ¸…ç©ºå®šæ—¶å™¨ç¼–å·
      }, wait); // å®šæ—¶å™¨ç­‰å¾… wait æ¯«ç§’åæ‰§è¡Œ
    } else {
      // ä¸ç«‹å³æ‰§è¡Œå‡½æ•°
      timer = setTimeout(() =&gt; {
        // å¯ç”¨æ–°çš„å®šæ—¶å™¨
        func.apply(this, args); // å®šæ—¶å™¨åˆ°æœŸåæ‰§è¡Œå‡½æ•°
      }, wait); // å®šæ—¶å™¨ç­‰å¾… wait æ¯«ç§’åæ‰§è¡Œ
    }
  };
}
```

## åœ¨ Nuxt.js ä¸­å¼•å…¥å‡½æ•°èŠ‚æµå’Œé˜²æŠ–

åœ¨é¡¹ç›®çš„ `plugins` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ `main.js`ã€‚å°†å‡½æ•°èŠ‚æµå’Œé˜²æŠ–æ·»åŠ ä¸º Vue çš„å®ä¾‹æ–¹æ³•ã€‚å¦‚ï¼š

```js
// plugins/main.js
import Vue from &quot;vue&quot;;

function throttle() {
  //
}

function debounce() {
  //
}

const main = {
  install(Vue) {
    // æ³¨å†Œåˆ° Vue.prototype.$Main ä¸­
    Vue.prototype.$Main = {
      throttle,
      debounce,
    };
  },
};

Vue.use(main);
```

æ¥ä¸‹æ¥åœ¨ `nuxt.config.js` ä¸­å¼•å…¥ï¼š

```js
export default {
  plugins: [&quot;~/plugins/main.js&quot;],
};
```

å°±å¯ä»¥åœ¨ç»„ä»¶ä¸­é€šè¿‡ `this.$Main.throttle()` è°ƒç”¨å‡½æ•°äº†ã€‚å…¶ä¸­ `this` æŒ‡å‘äº†å…¨å±€çš„ Vue å¯¹è±¡ã€‚

## ç®€å•çš„ä½¿ç”¨ç¤ºä¾‹

### æµè§ˆå™¨æ»šåŠ¨äº‹ä»¶

å¯¹äºæœ¬åšå®¢å¼€å¤´æå‡ºçš„ç¬¬ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‡½æ•°èŠ‚æµçš„æ–¹æ¡ˆä¼˜åŒ–å‰ç«¯æ€§èƒ½ã€‚

ä¸ºä»€ä¹ˆä¸ç”¨å‡½æ•°é˜²æŠ–ï¼Ÿå‡å¦‚ç”¨æˆ·ä¸€ç›´åœ¨æ»šåŠ¨æµè§ˆå™¨ï¼Œé‚£ä¹ˆç›´åˆ°ç”¨æˆ·åœæ­¢æ»šåŠ¨å‰ï¼Œéƒ½ä¸ä¼šæ‰§è¡Œå‡½æ•°åˆ¤æ–­å½“å‰æ»šåŠ¨ä½ç½®ã€‚è€Œä½¿ç”¨å‡½æ•°èŠ‚æµï¼Œæ— è®ºç”¨æˆ·æ˜¯å¦ä¸€ç›´åœ¨æ»šåŠ¨æµè§ˆå™¨ï¼Œéƒ½ä¼šåœ¨ä¸€å®šæ—¶é—´åå†æ¬¡æ‰§è¡Œå‡½æ•°åˆ¤æ–­å½“å‰æ»šåŠ¨ä½ç½®ã€‚

åŸºäº Vuetify UI ç»„ä»¶åº“ç¼–å†™ Vue ä»£ç å¦‚ä¸‹ï¼š

```vue
&lt;template&gt;
  &lt;v-fab-transition&gt;
    &lt;!-- å½“çª—å£æ»šåŠ¨å€¼å¤§äº 300 æ—¶æ˜¾ç¤ºæŒ‰é’® --&gt;
    &lt;v-btn
      v-show=&quot;scrollVal &gt; 300&quot;
      fixed
      fab
      dark
      bottom
      right
      color=&quot;white&quot;
      elevation=&quot;2&quot;
      class=&quot;mb-12&quot;
      @click=&quot;backToTop&quot;
    &gt;
      &lt;v-icon color=&quot;primary&quot;&gt;mdi-arrow-up&lt;/v-icon&gt;
    &lt;/v-btn&gt;
  &lt;/v-fab-transition&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  data: () =&gt; ({
    // å½“å‰çš„çª—å£æ»šåŠ¨å€¼
    scrollVal: 0,
  }),
  mounted() {
    // æ¯ 500 æ¯«ç§’è·å–å½“å‰çš„ scrollVal å€¼
    const throttleOnScroll = this.$Main.throttle(this.onScroll, 500);
    // ä¸º window æ·»åŠ æ»šåŠ¨äº‹ä»¶
    window.addEventListener(&quot;scroll&quot;, throttleOnScroll);
  },
  methods: {
    // è·å– window.pageYOffset å€¼å¹¶èµ‹å€¼ç»™ scrollVal
    onScroll() {
      this.scrollVal = window.pageYOffset;
    },
    // å›åˆ°é¡¶ç«¯
    backToTop() {
      window.scroll({
        top: 0,
        left: 0,
        behavior: &quot;smooth&quot;,
      });
    },
  },
};
&lt;/script&gt;
```

`window.pageYOffset` æ˜¯ `window.scrollY` çš„åˆ«åï¼Œå‰è€…çš„æµè§ˆå™¨å…¼å®¹æ€§è¾ƒå¥½ï¼Œè°ƒç”¨æ—¶å°†è¿”å›æ–‡æ¡£åœ¨å‚ç›´æ–¹å‘å·²æ»šåŠ¨çš„åƒç´ å€¼ã€‚

`onScroll()` æ–¹æ³•å¯ä»¥è·å–å½“å‰æ–‡æ¡£åœ¨å‚ç›´æ–¹å‘å·²æ»šåŠ¨çš„åƒç´ å€¼å¹¶èµ‹å€¼ç»™ `scrollVal`ï¼Œè€Œæµ®åŠ¨æŒ‰é’®æ ¹æ®æ­¤å€¼åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºã€‚ä¸Šè¿°ä»£ç è®¾å®šå½“è¯¥å€¼å¤§äº 300 æ—¶æ˜¾ç¤ºæµ®åŠ¨æŒ‰é’®ã€‚

ä¸Šè¿°ä»£ç å°† `onScroll()` æ–¹æ³•å°è£…æˆäº†ä¸€ä¸ªç­‰å¾…æ—¶é—´ä¸º 500 æ¯«ç§’çš„èŠ‚æµå‡½æ•° `throttleOnScroll()`ï¼Œå¹¶å°†è¯¥èŠ‚æµå‡½æ•°ç»‘å®šç»™æµè§ˆå™¨æ»šåŠ¨äº‹ä»¶ã€‚

å½“ç”¨æˆ·æ»šåŠ¨æµè§ˆå™¨æ—¶ï¼Œæ¯éš” 500 æ¯«ç§’ä¼šè·å–å½“å‰å·²æ»šåŠ¨çš„åƒç´ å€¼ï¼Œæµ®åŠ¨æŒ‰é’®å†æ ¹æ®æ­¤å€¼åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºï¼Œæ€§èƒ½ä¼˜åŒ–å®Œæˆï¼

## Easy ride

ä¸æƒ³è‡ªå·±æ‰‹æ’¸å‡½æ•°èŠ‚æµå’Œé˜²æŠ–ï¼Ÿ

é‚£å°±ç”¨å°è£…å¥½çš„å§ï¼š[Lodash](https://lodash.com/)ï¼Œä½ å€¼å¾—æ‹¥æœ‰ã€‚

## å‚è€ƒèµ„æ–™

- [ç»ˆäºææ‡‚ï¼šé˜²æŠ–å’ŒèŠ‚æµ](https://juejin.cn/post/6914591853882900488), 2021-01-06
- [å½»åº•å¼„æ‡‚å‡½æ•°é˜²æŠ–å’Œå‡½æ•°èŠ‚æµ](https://segmentfault.com/a/1190000018445196), 2019-03-09
- [ä»€ä¹ˆæ˜¯é˜²æŠ–å’ŒèŠ‚æµï¼Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå¦‚ä½•å®ç°](https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/5), 2019-01-23
- [æµ…æå‡½æ•°é˜²æŠ–ä¸å‡½æ•°èŠ‚æµ](https://www.jianshu.com/p/f9f6b637fd6c), 2018-08-12
</content:original-text><content:updated-at>2021-05-08T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[Windows ç³»ç»Ÿç¼–è¯‘å®‰è£…åŸºäº C++ çš„ gRPC]]></title><description><![CDATA[æœ¬åšå®¢åŸºäº CMake å®ç°ç¼–è¯‘  ç‰ˆæœ¬ã€‚ æœ¬åšå®¢çš„ Windows ç«¯ä½¿ç”¨çš„å‘½ä»¤æç¤ºç¬¦ç•Œé¢ä¸º Powershellã€‚

å®‰è£…ç¼–è¯‘ä¾èµ–è½¯ä»¶

åœ¨ Windows ç³»ç»Ÿä¸Šç¼–è¯‘ gRPC éœ€è¦é¦–å…ˆå‡†å¤‡ä¸‹è¿°è½¯ä»¶ï¼š

Visual Studio 2015ï¼ˆæˆ– 2017ï¼‰ï¼Œå°†ä½¿ç”¨åˆ° Visual C++ compiler Git CMake nasm ninjaï¼ˆå¯é€‰ï¼‰
Visual Studio 2015â€¦]]></description><link>https://blog.towind.fun/posts/windows-install-grpc</link><guid isPermaLink="false">windows-install-grpc</guid><category><![CDATA[åç«¯å¼€å‘]]></category><pubDate>Mon, 26 Apr 2021 00:00:00 GMT</pubDate><content:original-text>
æœ¬åšå®¢åŸºäº CMake å®ç°ç¼–è¯‘ `gRPC 1.28.1` ç‰ˆæœ¬ã€‚

æœ¬åšå®¢çš„ Windows ç«¯ä½¿ç”¨çš„å‘½ä»¤æç¤ºç¬¦ç•Œé¢ä¸º Powershellã€‚

## å®‰è£…ç¼–è¯‘ä¾èµ–è½¯ä»¶

åœ¨ Windows ç³»ç»Ÿä¸Šç¼–è¯‘ gRPC éœ€è¦é¦–å…ˆå‡†å¤‡ä¸‹è¿°è½¯ä»¶ï¼š

- Visual Studio 2015ï¼ˆæˆ– 2017ï¼‰ï¼Œå°†ä½¿ç”¨åˆ° Visual C++ compiler
- Git
- CMake
- nasm
- ninjaï¼ˆå¯é€‰ï¼‰

### Visual Studio 2015 (æˆ– 2017)

ç”¨äºç¼–è¯‘ gRPCã€‚ä¸‹ç®€ç§° VSã€‚

åœ¨å¾®è½¯çš„ [VS å®˜ç½‘](https://visualstudio.microsoft.com/zh-hans/)ä¸‹è½½å®‰è£…å³å¯ã€‚

### Git

ç”¨äºæ‹‰å– gRPC åº“å¹¶ä¸‹è½½æ‰€éœ€çš„ç¬¬ä¸‰æ–¹ä¾èµ–ã€‚

åœ¨ [Git å®˜ç½‘](https://git-scm.com/)ä¸‹è½½å¹¶å®‰è£…å³å¯ã€‚

```powershell
PS C:\Users\lolipop&gt; git --version
git version 2.21.0.windows.1
```

### CMake

ç”¨äºç”Ÿæˆç¼–è¯‘ gRPC çš„ Makefile æ–‡ä»¶ã€‚

åœ¨ [CMake å®˜ç½‘](https://cmake.org/download/)ä¸‹è½½ï¼Œå¯ä»¥é€‰æ‹©ä¸‹è½½ `.msi` æ–‡ä»¶ç›´æ¥å®‰è£…ã€‚

ä¾‹å¦‚å¯¹äº 64 ä½çš„ Windows ç”µè„‘å®‰è£… `CMake 3.20.1`ï¼Œæ‰¾åˆ°ï¼š

| Platform                                                                               | Files                           |
| -------------------------------------------------------------------------------------- | ------------------------------- |
| Windows x64 Installer: Installer tool has changed. Uninstall CMake 3.4 or lower first! | cmake-3.20.1-windows-x86_64.msi |

ä¸‹è½½å¹¶è¿è¡Œ `.msi` æ–‡ä»¶å®‰è£…å³å¯ã€‚

```powershell
PS C:\Users\lolipop&gt; cmake --version
cmake version 3.20.1
```

### nasm

gRPC çš„ç¬¬ä¸‰æ–¹ä¾èµ– `boringssl` éœ€è¦æ­¤è½¯ä»¶ã€‚

åœ¨ [nasm å®˜ç½‘](https://www.nasm.us/)ä¸‹è½½ï¼Œå¯ä»¥é€‰æ‹©ä¸‹è½½ `.exe` æ–‡ä»¶ç›´æ¥å®‰è£…ã€‚

ä¾‹å¦‚å¯¹äº 64 ä½çš„ Windows ç”µè„‘å®‰è£… `nasm 2.15.05`ï¼Œå¯ä»¥è¿›å…¥ `/pub/nasm/releasebuilds/2.15.05/win64` ç›®å½•ä¸‹è½½ `nasm-2.15.05-installer-x64.exe` æ–‡ä»¶å¹¶æ‰§è¡Œå®‰è£…æ“ä½œã€‚

nasm é»˜è®¤å®‰è£…ç›®å½•ä¸º `C:\Users\${æ‚¨çš„å·¥å·}\AppData\Local\bin\NASM`ï¼ˆè‹¥éæ­¤ç›®å½•ï¼Œè¯·åœ¨å®‰è£…ç•Œé¢ç¡®è®¤å®‰è£…çš„è·¯å¾„ï¼‰ï¼Œå°†è¯¥ç›®å½•æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­å³å¯ã€‚

```powershell
PS C:\Users\lolipop&gt; nasm --version
NASM version 2.15.05 compiled on Aug 28 2020
```

### ninjaï¼ˆå¯é€‰ï¼‰

æ‚¨å¯ä»¥ä½¿ç”¨ Ninja æ¥åŠ é€Ÿç¼–è¯‘ã€‚

å‡å¦‚æ‚¨å¸Œæœ›ä½¿ç”¨å®ƒï¼Œåç»­çš„ç¼–è¯‘æ“ä½œå¯å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://github.com/grpc/grpc/blob/master/BUILDING.md#windows-using-ninja-faster-build)ï¼Œæœ¬åšå®¢**ä¸ä½¿ç”¨** Ninja åŠ é€Ÿç¼–è¯‘ã€‚

## æ‹‰å– gRPC åº“

å»ºè®®åœ¨èƒ½å¤Ÿè¿æ¥ Github çš„æœºå™¨ç¯å¢ƒåˆ©ç”¨ Git å…‹éš† gRPC åº“å¹¶è·å–ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå†æ‰“åŒ…å‡ºæ¥ç»™ windows ç³»ç»Ÿç¼–è¯‘ä½¿ç”¨ã€‚

```bash
# å…‹éš† gRPC ä»“åº“
# å¯¹äºç‰¹å®šçš„åˆ†æ”¯ï¼Œä¾‹å¦‚ gRPC 1.28.1 ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨æ­¤å‘½ä»¤ï¼š
# git clone https://github.com/grpc/grpc.git -b v1.28.1
git clone https://github.com/grpc/grpc.git
# è·å– gRPC ç¬¬ä¸‰æ–¹ä¾èµ–
cd grpc
git submodule update --init
```

## ç¼–è¯‘å®‰è£… gRPC

ç‰¹åˆ«çš„ï¼Œå¦‚æœæ‚¨ä½¿ç”¨çš„ CMake ç‰ˆæœ¬ä½äº 3.13ï¼Œæˆ–ç¼–è¯‘çš„ gRPC ç‰ˆæœ¬ä½äº 1.27ï¼Œåœ¨æ‰§è¡Œ `cmake` å‘½ä»¤ä¹‹å‰ï¼Œéœ€è¦è‡ªè¡Œæ‰‹åŠ¨ç¼–è¯‘å®‰è£… gRPC çš„ä¾èµ–åº“ï¼Œä¸”åœ¨æ‰§è¡Œ `cmake` å‘½ä»¤æ—¶æŒ‡å®šè¿™äº›åº“çš„è·¯å¾„ï¼Œè¿™é‡Œæ˜¯[å®˜æ–¹çš„è¯´æ˜](https://github.com/grpc/grpc/blob/master/BUILDING.md#install-after-build)ã€‚

ä¸‹é¢çš„å†…å®¹åŸºäºçš„ CMake ç‰ˆæœ¬ä¸ä½äº 3.13ï¼Œä¸”ç¼–è¯‘çš„ gRPC ç‰ˆæœ¬ä¸ä½äº 1.27ã€‚

é¦–å…ˆåˆ›å»ºæ–‡ä»¶å¤¹å­˜å‚¨ç¼–è¯‘ç»“æœï¼Œå¹¶æ‰§è¡Œ `cmake` å‘½ä»¤ç”Ÿæˆ Makefile æ–‡ä»¶ã€‚ä½¿ç”¨**ç®¡ç†å‘˜æƒé™**æ‰“å¼€å‘½ä»¤è¡Œç•Œé¢ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```powershell
# åœ¨ grpc ç›®å½•ä¸‹åˆ›å»º .build ç›®å½•å¹¶è¿›å…¥
md .build
cd .build
# ç”Ÿæˆ Makefile æ–‡ä»¶
# å…¶ä¸­ Visual Studio 15 2017 ä¸ºå½“å‰çš„ VS ç‰ˆæœ¬
cmake .. -DgRPC_INSTALL=ON -G &quot;Visual Studio 15 2017&quot;
```

&gt; å°½ç®¡[ä¸æ¨è](https://github.com/grpc/grpc/blob/master/BUILDING.md#windows-a-note-on-building-shared-libs-dlls)ï¼Œåœ¨ä¸Šé¢æ‰§è¡Œ `cmake` å‘½ä»¤æ—¶ï¼Œæ‚¨å¯ä»¥æŒ‡å®š `-DBUILD_SHARED_LIBS=ON` ä»¥ç¼–è¯‘ç”Ÿæˆ gRPC C++ çš„ DLL æ–‡ä»¶ã€‚

æ¥ä¸‹æ¥å¯¹ gRPC è¿›è¡Œç¼–è¯‘å®‰è£…æ“ä½œï¼ŒåŒ…æ‹¬ä¸¤ç§æ–¹å¼ï¼Œè¿™é‡Œæ›´å»ºè®®ä½¿ç”¨ VSã€‚

### ä½¿ç”¨ VS ç¼–è¯‘å¹¶å®‰è£… gRPC

é¦–å…ˆï¼Œä½¿ç”¨**ç®¡ç†å‘˜æƒé™**æ‰“å¼€ VSï¼Œå¦åˆ™åœ¨å®‰è£… gRPC æ—¶ä¼šæŠ¥é”™ã€‚

æ¥ç€ä½¿ç”¨ VS æ‰“å¼€æ­¤ç›®å½•ä¸‹çš„ `grpc.sln` è§£å†³æ–¹æ¡ˆï¼Œæ‰¾åˆ°**è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨**ï¼ˆé»˜è®¤æƒ…å†µä¸‹åœ¨ VS çš„å³ä¾§ï¼‰ä¸­çš„ `ALL_BUILD` é¡¹ï¼Œå³é”®å¹¶é€‰æ‹©**ç”Ÿæˆ**æŒ‰é’®ï¼Œå¼€å§‹æ‰§è¡Œç¼–è¯‘æ“ä½œã€‚

ç¼–è¯‘ç»“æŸåï¼Œåœ¨**è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨**ä¸­æ‰¾åˆ° `INSTALL` é¡¹ï¼Œå³é”®å¹¶é€‰æ‹©**ç”Ÿæˆ**æŒ‰é’®ï¼Œå¼€å§‹æ‰§è¡Œå®‰è£…æ“ä½œã€‚

gRPC é»˜è®¤å®‰è£…åœ¨ `C:\Program Files (x86)\grpc` ç›®å½•ã€‚

å¦‚æœæŠ¥é”™ï¼Œè¯·ç¡®ä¿æ‚¨å·²ä½¿ç”¨ç®¡ç†å‘˜æƒé™æ‰“å¼€ VSã€‚ä½¿ç”¨ç®¡ç†å‘˜æƒé™é‡æ–°æ‰“å¼€ VS åï¼Œå³é”®ç‚¹å‡» `ALL_BUILD` å¹¶é€‰æ‹©**é‡æ–°ç”Ÿæˆ**æŒ‰é’®å³å¯ã€‚

### ä½¿ç”¨å‘½ä»¤è¡Œç¼–è¯‘å¹¶å®‰è£… gRPC

æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œç•Œé¢ï¼Œæ‰§è¡Œ `cmake` å‘½ä»¤æ¥ç¼–è¯‘å®‰è£… gRPCã€‚

```powershell
# ç¼–è¯‘å¹¶å®‰è£… gRPC
cmake --build . --target install --config Release
```

ç¼–è¯‘ç»“æŸåï¼Œä¼šè‡ªåŠ¨è¿›è¡Œå®‰è£…æ“ä½œã€‚

gRPC é»˜è®¤å®‰è£…åœ¨ `C:\Program Files (x86)\grpc` ç›®å½•ã€‚

å¦‚æœæ²¡æœ‰ä½¿ç”¨ç®¡ç†å‘˜æƒé™æ‰“å¼€å‘½ä»¤è¡Œç•Œé¢ï¼Œå®‰è£…æ—¶ä¼šå‘ç”ŸæŠ¥é”™ã€‚è¯·é‡æ–°ä½¿ç”¨ç®¡ç†å‘˜æƒé™æ‰“å¼€å‘½ä»¤è¡Œç•Œé¢ï¼Œå¹¶æ‰§è¡Œä¸Šé¢çš„å‘½ä»¤ã€‚

## æµ‹è¯• gRPC ç¼–è¯‘å®‰è£…ç»“æœ

æ¥ä¸‹æ¥çš„æ­¥éª¤åŸºäº VS ç¼–è¯‘å®‰è£… `gRPC 1.28.1` çš„ç»“æœï¼Œæµ‹è¯• Windows ç³»ç»Ÿä¸‹çš„ gRPC ç¯å¢ƒæ˜¯å¦å®‰è£…æˆåŠŸã€‚

ç§»åŠ¨åˆ° git å…‹éš†çš„ gRPC æºç ç›®å½•ä¸‹çš„ `grpc\examples\cpp\helloworld` ç›®å½•ï¼Œåˆ›å»ºå­˜æ”¾ç¼–è¯‘ç»“æœçš„æ–‡ä»¶å¤¹ `cmake\build`ï¼Œè¿›å…¥åˆ°è¯¥ç›®å½•ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š

```powershell
# ç”Ÿæˆ Makefile æ–‡ä»¶
# å…¶ä¸­ C:\Program Files (x86)\grpc æ˜¯ gRPC é»˜è®¤çš„å®‰è£…ç›®å½•
cmake -DCMAKE_PREFIX_PATH=&apos;C:\Program Files (x86)\grpc&apos; ../..
```

ä½¿ç”¨ç®¡ç†å‘˜æƒé™æ‰“å¼€ VSï¼Œå¹¶æ‰“å¼€å½“å‰ç›®å½•ä¸‹çš„ `HelloWorld.sln` è§£å†³æ–¹æ¡ˆï¼Œå³é”®åˆ†åˆ«é€‰æ‹©è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨ä¸­çš„ `greeter_client.cc` å’Œ `greeter_server.cc` å¹¶ç‚¹å‡»ç”ŸæˆæŒ‰é’®ã€‚

ç¼–è¯‘å®Œæˆåï¼Œä¼šåœ¨ `cmake\build\Debug` ç›®å½•ä¸‹ç”Ÿæˆæˆ‘ä»¬éœ€è¦çš„å¯æ‰§è¡Œæ–‡ä»¶ `greeter_server.exe` å’Œ `greeter_client.exe`ã€‚

ä½¿ç”¨ Powershell ç§»åŠ¨åˆ°è¯¥ç›®å½•ï¼Œå¯åŠ¨æœåŠ¡ç«¯ `./greeter_server.exe`ï¼š

```powershell
PS grpc\examples\cpp\helloworld\cmake\build\Debug&gt; ./greeter_server.exe
Server listening on 0.0.0.0:50051
```

æœåŠ¡ç«¯é»˜è®¤ç›‘å¬ 50051 ç«¯å£ã€‚

å†å¯åŠ¨ä¸€ä¸ª Powershell ç§»åŠ¨åˆ°è¯¥ç›®å½•ï¼Œå¯åŠ¨å®¢æˆ·ç«¯ `./greeter_client.exe`ï¼š

```powershell
PS grpc\examples\cpp\helloworld\cmake\build\Debug&gt; ./greeter_client.exe
Greeter received: Hello world
```

æˆåŠŸæ‰“å°å‡º `Greeter received: Hello world` å­—æ®µï¼Œæµ‹è¯•æˆåŠŸï¼

ä½œä¸ºå¯¹ç…§ç»„ï¼Œæ‚¨å¯ä»¥å…³é—­æ‰æœåŠ¡ç«¯ï¼Œå†æ‰§è¡Œå®¢æˆ·ç«¯ï¼Œè§‚å¯Ÿæ‰“å°çš„ç»“æœã€‚

Hello, gRPC world!

## å‚è€ƒèµ„æ–™

- [ç¼–è¯‘ gRPC(windows)å’Œæµ‹è¯• demo](https://blog.csdn.net/xiaoyafang123/article/details/76529917) - 2017.08.01 - æ³¨ï¼šåšä¸»å¡«çš„è½¬è½½ï¼Œæš‚æœªæ‰¾åˆ°åŸæ–‡é“¾æ¥
</content:original-text><content:updated-at>2021-04-26T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[Linux ç³»ç»Ÿç¼–è¯‘å®‰è£…åŸºäº C++ çš„ gRPC]]></title><description><![CDATA[æœ¬æ–‡é€‚ç”¨äº C++ ç‰ˆæœ¬ gRPC çš„ç¦»çº¿ç¼–è¯‘å®‰è£…ï¼Œä½†å¯¹äºä¸‹è½½ gRPC æ­¥éª¤å¼ºçƒˆå»ºè®®ä½¿ç”¨ git è¿›è¡Œã€‚ å¦‚æœåœ¨èƒ½ç›´æ¥è¿æ¥å¤–ç½‘çš„æœºå™¨ä¸Šç¼–è¯‘ï¼Œå¯ç›´æ¥æŒ‰ç…§ gRPC å®˜ç½‘æ–‡æ¡£çš„æŒ‡å¼•å¿«é€Ÿæ‰§è¡Œç¼–è¯‘æ“ä½œã€‚

å®‰è£…åŸºæœ¬ä¾èµ–

ç¡®ä¿æœºå™¨ä¸ŠåŒ…æ‹¬è¿™äº›åŸºæœ¬ä¾èµ–ï¼š, ,  ä¸ C++ ç¼–è¯‘ç¯å¢ƒã€‚

gRPC çš„ç¼–è¯‘éœ€è¦  ç‰ˆæœ¬åœ¨  åŠä»¥ä¸Šã€‚å‡å¦‚ç‰ˆæœ¬ä½äºæ­¤ï¼Œåº”å½“åœ¨ Docker å®¹å™¨ä¸­å®‰è£…è¾ƒæ–°ç‰ˆæœ¬çš„ GCC å†æ‰§è¡Œç¼–è¯‘æ“ä½œâ€¦]]></description><link>https://blog.towind.fun/posts/linux-docker-install-grpc</link><guid isPermaLink="false">linux-docker-install-grpc</guid><category><![CDATA[åç«¯å¼€å‘]]></category><pubDate>Thu, 22 Apr 2021 00:00:00 GMT</pubDate><content:original-text>
æœ¬æ–‡é€‚ç”¨äº C++ ç‰ˆæœ¬ gRPC çš„ç¦»çº¿ç¼–è¯‘å®‰è£…ï¼Œä½†å¯¹äº[ä¸‹è½½ gRPC](#ä¸‹è½½-gRPC) æ­¥éª¤å¼ºçƒˆå»ºè®®ä½¿ç”¨ git è¿›è¡Œã€‚

å¦‚æœåœ¨èƒ½ç›´æ¥è¿æ¥å¤–ç½‘çš„æœºå™¨ä¸Šç¼–è¯‘ï¼Œå¯ç›´æ¥æŒ‰ç…§ [gRPC å®˜ç½‘æ–‡æ¡£](https://github.com/grpc/grpc)çš„æŒ‡å¼•å¿«é€Ÿæ‰§è¡Œç¼–è¯‘æ“ä½œã€‚

## å®‰è£…åŸºæœ¬ä¾èµ–

ç¡®ä¿æœºå™¨ä¸ŠåŒ…æ‹¬è¿™äº›åŸºæœ¬ä¾èµ–ï¼š`autoconf`, `libtool`, `pkg-config` ä¸ C++ ç¼–è¯‘ç¯å¢ƒã€‚

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰ autoconf
which autoconf

# å¦‚æœæ²¡æœ‰ï¼Œåˆ™å®‰è£…
# CentOS
yum install autoconf
# Ubuntu
apt-get install autoconf
```

gRPC çš„ç¼–è¯‘éœ€è¦ `gcc` ç‰ˆæœ¬åœ¨ `4.9` åŠä»¥ä¸Šã€‚å‡å¦‚ç‰ˆæœ¬ä½äºæ­¤ï¼Œåº”å½“åœ¨ Docker å®¹å™¨ä¸­å®‰è£…è¾ƒæ–°ç‰ˆæœ¬çš„ GCC å†æ‰§è¡Œç¼–è¯‘æ“ä½œã€‚

æˆ‘ä½¿ç”¨ `gcc 4.9.4` æˆåŠŸç¼–è¯‘ `gRPC 1.28.x`ï¼Œå¦å¤–[æœ‰äººæµ‹è¯•](https://github.com/grpc/grpc/issues/24932#issuecomment-754344093)åœ¨ `4.9.2`, `5.3.1` ä»¥åŠ `7.3.1` ç‰ˆæœ¬ç¼–è¯‘æˆåŠŸï¼›è€Œæˆ‘ä½¿ç”¨æ’°å†™æ­¤æ–‡æ—¶ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ `10.3.0` ç¼–è¯‘æŠ¥é”™ï¼Œè¯·è¯»è€…åŠ ä»¥é€‰æ‹©ã€‚

æ›´æ–° GCC çš„æ–¹æ³•å¯ä»¥å‚è€ƒæˆ‘çš„&lt;Link to=&quot;/posts/linux-docker-gcc-update&quot;&gt;è¿™ä¸€ç¯‡åšå®¢&lt;/Link&gt;ã€‚

```bash
# æŸ¥çœ‹ gcc ç‰ˆæœ¬
gcc -v
```

å¦‚æœæœºå™¨ä¸Šæ²¡æœ‰ `gcc` æˆ– `g++` ç­‰ï¼Œå¯ä»¥å®‰è£… `Development Tools` æˆ– `build-essential` è½¯ä»¶åŒ…ã€‚

```bash
# CentOS
yum groupinstall &quot;Development Tools&quot;
# Ubuntu
apt-get install -y build-essential
```

## å®‰è£… CMake

&gt; `make` æ˜¯ gRPC ä»¥å‰ä½¿ç”¨çš„æ„å»ºå‘½ä»¤ï¼Œä½†æ˜¯å®˜æ–¹æ–‡æ¡£ä¸å†å»ºè®®ä½¿ç”¨å®ƒã€‚åº”ä½¿ç”¨ `bazel` æˆ– `cmake` ä»£æ›¿ã€‚æ­¤å¤„æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ `cmake` æ‰§è¡Œç¼–è¯‘ã€‚

æ‰§è¡Œä¸‹è¿°å‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å‘½ä»¤åˆ™éœ€è¦å®‰è£… CMakeã€‚ç›®å‰ç¼–è¯‘ gRPC éœ€è¦çš„ CMake æœ€ä½ç‰ˆæœ¬ä¸º `3.5.1`ï¼Œå»ºè®®ä½¿ç”¨çš„ CMake ç‰ˆæœ¬ä¸º `3.13` åŠä»¥ä¸Šã€‚

```bash
# æŸ¥çœ‹å½“å‰ CMake ç‰ˆæœ¬
cmake --version
```

åœ¨ [CMake å®˜ç½‘](https://cmake.org/download/)ä¸‹è½½éœ€è¦ç‰ˆæœ¬çš„ CMake æºç æˆ–äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

ä¾‹å¦‚ä¸‹è½½é€‚ç”¨äº x86_64 çš„ Linux ç³»ç»Ÿçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥é€‰æ‹©ä¸‹è½½ `cmake-3.20.1-linux-x86_64.tar.gz`ï¼Œå…¶ä¸­ `3.20.1` ä¸ºç‰ˆæœ¬å·ã€‚

è§£å‹ï¼Œå¯ä»¥å°† `/path/to/cmake-3.20.1-linux-x86_64/bin/` ç›®å½•ä¸‹çš„äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ç²˜è´´åˆ° `/usr/bin/` ç›®å½•ä¸‹ï¼›æˆ–æ˜¯ä¸ºå®ƒä»¬åˆ›å»ºè½¯é“¾æ¥ï¼Œåˆ›å»ºè½¯é“¾æ¥åº”ä½¿ç”¨ç»å¯¹è·¯å¾„ã€‚

```bash
# è§£å‹
tar -zxvf cmake-3.20.1-linux-x86_64.tar.gz
# ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶åˆ›å»ºè½¯é“¾æ¥
sudo ln -sf /path/to/cmake-3.20.1-linux-x86_64/bin/* /usr/bin/
# å†æ¬¡æ‰§è¡Œï¼Œç¡®ä¿å®‰è£…æˆåŠŸ
cmake --version
```

æŸ¥çœ‹ç‰ˆæœ¬å·æ—¶å¦‚æœæç¤º `CMake Error: Could not find CMAKE_ROOT !!!`ï¼Œå¯èƒ½æ˜¯åŸæœ¬è°ƒç”¨çš„ CMake äºŒè¿›åˆ¶æ–‡ä»¶å­˜æ”¾åœ¨å…¶å®ƒç›®å½•ä¸‹ã€‚ä¾‹å¦‚ï¼ŒåŸæ¥çš„ CMake äºŒè¿›åˆ¶æ–‡ä»¶å­˜æ”¾åœ¨ `/usr/local/bin/` ç›®å½•ä¸‹ï¼Œè€Œè°ƒç”¨å‘½ä»¤æ—¶ç³»ç»Ÿåˆä¼˜å…ˆä»è¯¥ç›®å½•æœç´¢å‘½ä»¤ã€‚å› æ­¤åº”åœ¨åˆ›å»ºè½¯é“¾æ¥æ—¶åº”æ‰§è¡Œï¼š

```bash
# åˆ›å»º cmake äºŒè¿›åˆ¶æ–‡ä»¶è½¯é“¾æ¥
sudo ln -sf /path/to/cmake-3.20.1-linux-x86_64/bin/* /usr/local/bin/
```

å¯¹äºå…¶å®ƒè·¯å¾„ï¼Œå¯ä»¥é€šè¿‡ `find / -name &quot;cmake&quot;` æ¥å¯»æ‰¾ã€‚

## ä¸‹è½½ gRPC

å»ºè®®åœ¨èƒ½å¤Ÿç›´æ¥è®¿é—®å¤–ç½‘çš„ç¯å¢ƒåˆ©ç”¨ git å…‹éš† gRPC åº“å¹¶è·å–ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå†æ‰“åŒ…å‡ºæ¥ç»™å…¶å®ƒç¯å¢ƒç¼–è¯‘ä½¿ç”¨ã€‚

æ‰‹åŠ¨ä¸‹è½½ gRPC åŠç¬¬ä¸‰æ–¹ä¾èµ–è€—æ—¶è€—åŠ›ï¼Œè¿˜æœ‰å¯èƒ½åƒæˆ‘ä¸€æ ·â€œèµ”äº†å¤«äººåˆæŠ˜å…µâ€ä¾ç„¶ç¼–è¯‘ä¸äº†ã€‚

```bash
# å…‹éš† gRPC ä»“åº“
git clone https://github.com/grpc/grpc.git
cd grpc
# è·å– gRPC ç¬¬ä¸‰æ–¹ä¾èµ–
git submodule update --init
```

## ç¼–è¯‘å®‰è£… gRPC

å®˜æ–¹æ–‡æ¡£[å»ºè®®](https://grpc.io/docs/languages/cpp/quickstart/#build-and-install-grpc-protocol-buffers-and-abseil)ç”¨æˆ·é€‰æ‹©æœ¬åœ°è·¯å¾„å®‰è£… gRPCï¼Œå› ä¸ºå…¨å±€å®‰è£…åæƒ³è¦å¸è½½ gRPC ä¼šååˆ†å¤æ‚ã€‚å› æ­¤ï¼Œåœ¨ç¼–è¯‘å®‰è£…ä¹‹å‰ï¼Œå¯ä»¥é¦–å…ˆé€‰æ‹©ä¸€ä¸ªç”¨æˆ·æœ¬åœ°çš„è·¯å¾„ã€‚

```bash
# å®‰è£…åˆ° $HOME/.local ä¸­
export MY_INSTALL_DIR=$HOME/.local
# ç¡®ä¿ç›®å½•å­˜åœ¨
mkdir -p $MY_INSTALL_DIR
# æ·»åŠ è¯¥è·¯å¾„ä¸‹çš„ bin ç›®å½•åˆ°ç¯å¢ƒå˜é‡
export PATH=&quot;$PATH:$MY_INSTALL_DIR/bin&quot;
```

åœ¨ gRPC æ ¹ç›®å½•ä¸‹æ‰§è¡Œ[ä¸‹è¿°æ“ä½œ](https://github.com/grpc/grpc/blob/master/BUILDING.md#building-with-cmake)ï¼š

```bash
# åˆ›å»ºå­˜æ”¾ç¼–è¯‘ gRPC ç»“æœçš„ç›®å½•
mkdir -p cmake/build
# è¿›å…¥åˆ°è¯¥ç›®å½•
pushd cmake/build
# ç”Ÿæˆç¼–è¯‘ gRPC çš„ Makefile æ–‡ä»¶
# å…¶ä¸­ DCMAKE_INSTALL_PREFIX æŒ‡å®šäº† gRPC çš„å®‰è£…è·¯å¾„
cmake -DgRPC_INSTALL=ON \
    -DgRPC_BUILD_TESTS=OFF \
    -DCMAKE_INSTALL_PREFIX=$MY_INSTALL_DIR \
    ../..
# æ‰§è¡Œç¼–è¯‘
# ${JOBS_NUM} ä¸ºåŒæ—¶æ‰§è¡Œçš„çº¿ç¨‹æ•°ï¼Œåº”æ›¿æ¢ä¸ºæ•°å­—ï¼Œä¸‹åŒ
make -j ${JOBS_NUM}
# å®‰è£… gRPC
make install
```

å¦‚æœæƒ³è¦ç¼–è¯‘åŠ¨æ€åº“ `.so` æ–‡ä»¶ï¼Œå¯ä»¥åœ¨ä¸Šä¸€æ­¥æ‰§è¡Œ `cmake` å‘½ä»¤æ—¶è®¾ç½® `-DBUILD_SHARED_LIBS=ON`ï¼Œå¦‚ï¼š

```bash
# ç”Ÿæˆç¼–è¯‘ gRPC çš„ Makefile æ–‡ä»¶
cmake -DBUILD_SHARED_LIBS=ON ../..
```

å‡å¦‚ç¼–è¯‘å¤±è´¥ï¼Œå¯ä»¥å‚è€ƒç¬”è€…é‡åˆ°çš„[é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ](#å¯èƒ½é‡è§çš„é”™è¯¯)ã€‚

C++ ç‰ˆæœ¬çš„ gRPC è¿˜ä¾èµ–äº Abseil C++ åº“ï¼Œå› æ­¤éœ€è¦å•ç‹¬ç¼–è¯‘å®‰è£…å®ƒï¼š

```bash
# å›åˆ° gRPC æ ¹ç›®å½•
popd
# åˆ›å»ºå­˜æ”¾ Abseil C++ ç¼–è¯‘ç»“æœçš„ç›®å½•
mkdir -p third_party/abseil-cpp/cmake/build
# è¿›å…¥åˆ°ç¼–è¯‘ç›®å½•
pushd third_party/abseil-cpp/cmake/build
# ç”Ÿæˆç¼–è¯‘ abseil-cpp çš„ Makefile æ–‡ä»¶
cmake -DCMAKE_INSTALL_PREFIX=$MY_INSTALL_DIR \
    -DCMAKE_POSITION_INDEPENDENT_CODE=TRUE \
    ../..
# æ‰§è¡Œç¼–è¯‘
make -j ${JOBS_NUM}
# å®‰è£… Abseil C++
make install
```

å“ˆï¼å¤§åŠŸå‘Šæˆã€‚æœ€åæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ gRPC æ˜¯å¦å®‰è£…æˆåŠŸã€‚

## æµ‹è¯•ç¼–è¯‘å®‰è£… gRPC æˆåŠŸ

é¦–å…ˆç¼–è¯‘ gRPC æä¾›çš„ç¤ºä¾‹ï¼š

```bash
# å›åˆ° gRPC æ ¹ç›®å½•
popd
# è¿›å…¥ example ç›®å½•
cd examples/cpp/helloworld
# åˆ›å»ºå­˜æ”¾ example ç¼–è¯‘ç»“æœçš„ç›®å½•
mkdir -p cmake/build
# è¿›å…¥åˆ°ç¼–è¯‘ç›®å½•
pushd cmake/build
# ç”Ÿæˆç¼–è¯‘ example çš„ Makefile æ–‡ä»¶
# å…¶ä¸­ DCMAKE_PREFIX_PATH æŒ‡å®šæˆ‘ä»¬ä½¿ç”¨çš„ gRPC è·¯å¾„ï¼Œå³ gRPC çš„å®‰è£…è·¯å¾„
cmake -DCMAKE_PREFIX_PATH=$MY_INSTALL_DIR ../..
# æ‰§è¡Œç¼–è¯‘
make -j ${JOBS_NUM}
```

è¿™æ ·ï¼Œåœ¨å½“å‰ç›®å½•å°±ä¼šç”Ÿæˆç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¯•è¯•çœ‹å§ï¼

åœ¨å½“å‰ç»ˆç«¯å¯ç”¨ gRPC ç¤ºä¾‹çš„æœåŠ¡ç«¯ï¼Œå®ƒä¼šé»˜è®¤ç›‘å¬å½“å‰ä¸»æœºçš„ `50051` ç«¯å£ï¼š

```bash
./greeter_server

# æ˜¾ç¤ºå†…å®¹å¦‚ä¸‹
Server listening on 0.0.0.0:50051
```

æ‰“å¼€ä¸€ä¸ªæ–°ç»ˆç«¯ï¼Œè¿›å…¥åˆ°æ­¤ç›®å½•ï¼Œè¿è¡Œå®¢æˆ·ç«¯ï¼Œå°±å¯ä»¥çœ‹åˆ°è®¿é—®çš„ç»“æœå•¦ï¼š

```bash
./greeter_client

# æ˜¾ç¤ºå†…å®¹å¦‚ä¸‹
Greeter received: Hello world
```

å‡å¦‚é€€å‡ºäº†æœåŠ¡ç«¯ï¼Œå†è¿è¡Œå®¢æˆ·ç«¯ï¼Œåˆ™ä¼šæ‰“å°ï¼š

```bash
# å…³é—­æœåŠ¡ç«¯ï¼Œç„¶åæ‰§è¡Œ
./greeter_client

# æ˜¾ç¤ºå†…å®¹å¦‚ä¸‹
14: failed to connect to all addresses
Greeter received: RPC failed
```

å¼€å§‹æ„‰å¿«åœ°ç¼–å†™ gRPC ç¨‹åºå§ï¼

## å¯èƒ½é‡è§çš„é”™è¯¯

### ç¼–è¯‘ gRPC æ‰§è¡Œ make åæç¤º error

```bash
error: no matching function for call to â€˜StrFormat(const char [22], const char*, char [64], int32_t&amp;, long int&amp;, const char*&amp;, int&amp;)â€™
```

æç¤ºæŠ¥é”™æ²¡æœ‰æ‰¾åˆ° `StrFormat` å‡½æ•°ï¼Œè¯·ç¡®ä¿ `gcc` ç‰ˆæœ¬åœ¨ `4.9` åŠä»¥ä¸Šï¼Œå¯ä»¥æ‰§è¡Œ `gcc -v` å‘½ä»¤æŸ¥çœ‹å½“å‰ç‰ˆæœ¬ã€‚

å»ºè®®[æ›´æ–°](http://3ms.huawei.com/km/blogs/details/10193429)åˆ° `gcc 4.9.4` ç‰ˆæœ¬ï¼Œç¬”è€…åœ¨è¯¥ç‰ˆæœ¬ä¸‹é¡ºåˆ©ç¼–è¯‘ gRPCã€‚
</content:original-text><content:updated-at>2021-05-11T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[Linux å®¹å™¨æ›´æ–°æˆ–é™çº§ GCC ç‰ˆæœ¬]]></title><description><![CDATA[å¦‚æœè½¯ä»¶æºå¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ CentOS çš„ yum åŒ…ç®¡ç†å™¨æˆ– Ubuntu çš„ apt åŒ…ç®¡ç†å™¨ç­‰ä¸€é”®å®‰è£… GCCï¼Œä¾‹å¦‚ï¼š æœ¬æ–‡é€‚ç”¨äºç³»ç»Ÿä¸­åŒ…å«æœ‰å…¶å®ƒç‰ˆæœ¬çš„ GCC ç¼–è¯‘å™¨æƒ…å†µä¸‹ï¼Œæ‰‹åŠ¨æ›´æ–°æˆ–é™çº§ GCC ç¼–è¯‘å™¨ã€‚ç¼–è¯‘ GCC çš„è¿‡ç¨‹ååˆ†è€—æ—¶ï¼Œå¦‚æœèƒ½ä½¿ç”¨åŒ…ç®¡ç†å™¨å°½é‡è¿˜æ˜¯ä½¿ç”¨åŒ…ç®¡ç†å™¨å§ã€‚

NOTE: å¦‚æœä»…ä½¿ç”¨ GCC è¿›è¡Œç¼–è¯‘æ“ä½œæˆ–ä¸ç¡®å®šå½“å‰ç³»ç»Ÿèƒ½å¦å…¼å®¹æ–°ç‰ˆæœ¬çš„ GCCï¼Œå»ºè®®åœ¨ Dockerâ€¦]]></description><link>https://blog.towind.fun/posts/linux-docker-gcc-update</link><guid isPermaLink="false">linux-docker-gcc-update</guid><category><![CDATA[åç«¯å¼€å‘]]></category><pubDate>Tue, 20 Apr 2021 00:00:00 GMT</pubDate><content:original-text>
å¦‚æœè½¯ä»¶æºå¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ CentOS çš„ yum åŒ…ç®¡ç†å™¨æˆ– Ubuntu çš„ apt åŒ…ç®¡ç†å™¨ç­‰ä¸€é”®å®‰è£… GCCï¼Œä¾‹å¦‚ï¼š

```bash
yum -y install gcc
yum -y install gcc-c++

# æˆ–æ˜¯ä¸€é”®å®‰è£…å¼€å‘å·¥å…·è½¯ä»¶åŒ…ï¼ŒåŒ…æ‹¬ gcc, g++ ç­‰
yum groupinstall &quot;Development Tools&quot;
```

æœ¬æ–‡é€‚ç”¨äºç³»ç»Ÿä¸­**åŒ…å«æœ‰**å…¶å®ƒç‰ˆæœ¬çš„ GCC ç¼–è¯‘å™¨æƒ…å†µä¸‹ï¼Œæ‰‹åŠ¨æ›´æ–°æˆ–é™çº§ GCC ç¼–è¯‘å™¨ã€‚ç¼–è¯‘ GCC çš„è¿‡ç¨‹ååˆ†è€—æ—¶ï¼Œå¦‚æœèƒ½ä½¿ç”¨åŒ…ç®¡ç†å™¨å°½é‡è¿˜æ˜¯ä½¿ç”¨åŒ…ç®¡ç†å™¨å§ã€‚

NOTE: å¦‚æœä»…ä½¿ç”¨ GCC è¿›è¡Œç¼–è¯‘æ“ä½œæˆ–ä¸ç¡®å®šå½“å‰ç³»ç»Ÿèƒ½å¦å…¼å®¹æ–°ç‰ˆæœ¬çš„ GCCï¼Œå»ºè®®åœ¨ **Docker å®¹å™¨ç¯å¢ƒ**ä¸­æ‰§è¡Œç¼–è¯‘å’Œå®‰è£…æ“ä½œï¼Œå¹¶åœ¨å®¹å™¨ä¸­ä½¿ç”¨ GCC ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘æºç ã€‚

```bash
# æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­ GCC çš„ç‰ˆæœ¬
gcc -v
```

## ä¸‹è½½ GCC å¹¶è§£å‹

åœ¨ [GCC å®˜ç½‘](https://gcc.gnu.org/mirrors.html)é€‰æ‹©ä¸‹è½½ GCC çš„é•œåƒç«™ç‚¹ï¼Œé€‰æ‹©è¿›å…¥ `release/` ç›®å½•ï¼Œé€‰æ‹©éœ€è¦çš„ GCC ç‰ˆæœ¬ä¸‹è½½å³å¯ã€‚

æœ¬æ–‡ä»¥å®‰è£… `GCC 10.3.0` ä¸ºä¾‹ï¼Œè¿›å…¥ `release/gcc-10.3.0/` ç›®å½•ï¼Œé€‰æ‹© `gcc-10.3.0.tar.gz` è¿›è¡Œä¸‹è½½ã€‚

å°†å‹ç¼©åŒ…ä¼ å…¥ Docker å®¹å™¨ç¯å¢ƒï¼Œå¹¶è§£å‹åˆ°å®¹å™¨çš„ `/usr/local/` ç›®å½•ä¸‹ã€‚

```bash
tar -xf gcc-10.3.0.tar.gz -C /usr/local/
```

## ä¸‹è½½ GCC ä¾èµ–åŒ…

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä¸‹è½½ GCC ç¼–è¯‘æ‰€éœ€çš„ä¾èµ–åŒ…ï¼š

```bash
cd /usr/local/gcc-10.3.0
# æ‰§è¡Œè„šæœ¬ä¸‹è½½ä¾èµ–åŒ…
./contrib/download_prerequisites
```

å¯¹äºè¾ƒè€ç‰ˆæœ¬çš„ GCCï¼ˆä¾‹å¦‚ `4.9.4` ç‰ˆæœ¬ï¼‰ï¼Œæ‰§è¡Œè„šæœ¬æ—¶å¯èƒ½ä¼šæ— æ³•è¿æ¥æœåŠ¡å™¨ï¼Œå¯ä»¥æ›´æ¢ä»£ç†è¿›è¡Œä¸‹è½½ï¼š

```bash
# ç¼–è¾‘ contrib/download_prerequisites æ–‡ä»¶
vim ./contrib/download_prerequisites
```

å°†æ–‡ä»¶ä¸­ `ftp://gcc.gnu.org/pub/gcc/infrastructure` å­—æ®µæ›´æ¢ä¸º `http://www.mirrorservice.org/sites/sourceware.org/pub/gcc/infrastructure`ï¼Œç„¶åå†åœ¨æ ¹ç›®å½•æ‰§è¡Œ `./contrib/download_prerequisites` å‘½ä»¤ä¸‹è½½ä¾èµ–åŒ…å³å¯ã€‚

å¯¹äºè¾ƒæ–°ç‰ˆæœ¬çš„ GCCï¼ˆä¾‹å¦‚ `10.3.0` ç‰ˆæœ¬ï¼‰ï¼Œä¾èµ–åŒ…åŒ…æ‹¬ `gmp`, `mpfr`, `mpc` ä»¥åŠ `isl`ã€‚æç¤ºå¦‚ä¸‹ï¼Œè¡¨ç¤ºä¾èµ–ä¸‹è½½æˆåŠŸï¼š

```bash
2021-04-19 15:32:27 URL:http://gcc.gnu.org/pub/gcc/infrastructure/gmp-6.1.0.tar.bz2 [2383840/2383840] -&gt; &quot;./gmp-6.1.0.tar.bz2&quot; [1]
2021-04-19 15:32:30 URL:http://gcc.gnu.org/pub/gcc/infrastructure/mpfr-3.1.4.tar.bz2 [1279284/1279284] -&gt; &quot;./mpfr-3.1.4.tar.bz2&quot; [1]
2021-04-19 15:32:34 URL:http://gcc.gnu.org/pub/gcc/infrastructure/mpc-1.0.3.tar.gz [669925/669925] -&gt; &quot;./mpc-1.0.3.tar.gz&quot; [1]
2021-04-19 15:32:38 URL:http://gcc.gnu.org/pub/gcc/infrastructure/isl-0.18.tar.bz2 [1658291/1658291] -&gt; &quot;./isl-0.18.tar.bz2&quot; [1]
gmp-6.1.0.tar.bz2: OK
mpfr-3.1.4.tar.bz2: OK
mpc-1.0.3.tar.gz: OK
isl-0.18.tar.bz2: OK
All prerequisites downloaded successfully.
```

## ç¼–è¯‘ GCC

å›åˆ°ä¸Šä¸€çº§ç›®å½•å³ `/usr/local`ï¼Œæ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œå­˜æ”¾ç¼–è¯‘ GCC æºç ç”Ÿæˆçš„æ–‡ä»¶ï¼š

```bash
cd /usr/local
mkdir gcc-build-10.3.0
cd gcc-build-10.3.0
```

ç°åœ¨æˆ‘ä»¬åœ¨ `/usr/local/` è·¯å¾„ä¸‹åˆ›å»ºäº†ä¸€ä¸ªåä¸º `gcc-build-10.3.0` çš„ç›®å½•ï¼Œå¹¶è¿›å…¥åˆ°æ­¤ç›®å½•ä¸­ã€‚

GCC ç¼–è¯‘å™¨æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘ï¼Œä½†æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨å®ƒæ¥ç¼–è¯‘ C å’Œ C++ è¯­è¨€ç¨‹åºçš„æºç ã€‚å› æ­¤åœ¨ç¼–è¯‘ GCC ä¹‹å‰å¯ä»¥é…ç½®åªå¯ç”¨ C å’Œ C++ è¯­è¨€æ”¯æŒã€‚è¿™ä¸€æ­¥ä¸º**å¯é€‰**æ“ä½œï¼š

```bash
/usr/local/gcc-10.3.0/configure --enable-checking=release --enable-languages=c,c++ --disable-multilib
```

å¦‚æœä¸éœ€è¦ç¦ç”¨å¤šè¯­è¨€ç¼–è¯‘æ”¯æŒï¼Œåˆ™ç›´æ¥è¿è¡Œ `configure` å³å¯ï¼š

```bash
/usr/local/gcc-10.3.0/configure
```

æ‰§è¡Œå®Œæˆåï¼Œä¼šåœ¨å½“å‰è·¯å¾„åˆ›å»º `Makefile` æ–‡ä»¶ï¼Œæ‰§è¡Œ `make` å‘½ä»¤ç¼–è¯‘ GCC æºç¨‹åºå³å¯ã€‚

ç¼–è¯‘è¿‡ç¨‹ä¼šå ç”¨å¾ˆå¤§çš„ç©ºé—´ï¼Œè¯·ç¡®ä¿å½“å‰ç›®å½•çš„ç©ºé—´è¶³å¤Ÿä½¿ç”¨ã€‚

è€ƒè™‘åˆ°å•ä½œä¸šæ‰§è¡Œç¼–è¯‘æ“ä½œååˆ†ä¹‹æ…¢ï¼ˆå‚è€ƒæ–‡æ¡£çš„ä½œè€…åœ¨ä»–çš„æœºå™¨ä¸ŠèŠ±è´¹äº† 6 å°æ—¶æ‰å®Œæˆç¼–è¯‘ï¼‰ï¼Œå¯ä»¥è®¾ç½® `-j` é€‰é¡¹æ‰§è¡Œ[å¹¶è¡Œä½œä¸š](https://stackoverflow.com/questions/414714/compiling-with-g-using-multiple-cores)ï¼Œé€‰é¡¹åè¾¹çš„æ•°å­—å»ºè®®ä¸º CPU å†…æ ¸æ•°é‡çš„ 1.5 å€ç”šè‡³ 2 å€ã€‚å¦‚ä¸‹è¿°å‘½ä»¤åŒæ—¶å¯ç”¨ 8 ä¸ªä½œä¸šå¹¶è¡Œç¼–è¯‘ GCCï¼š

```bash
make -j 8
```

ç°åœ¨ï¼Œå¿˜è®°è¿™è¾¹çš„äº‹æƒ…ï¼Œå»åšä¸€äº›å…¶å®ƒçš„äº‹å„¿å§ï¼

---

Tue Apr 20 9:52 CST 2021 - Tue Apr 20 12:33:29 CST 2021.

å¥½ä¹…ä¸è§ï¼æˆ‘çš„æœºå™¨åœ¨ 8 ä¸ªä½œä¸šå¹¶è¡Œç¼–è¯‘çš„æƒ…å†µä¸‹ï¼Œå¤§çº¦èŠ±è´¹äº† 2.5 å°æ—¶å®Œæˆäº†ç¼–è¯‘ã€‚

ç°åœ¨æ‰§è¡Œä¸‹è¿°å‘½ä»¤å®‰è£… GCC å³å¯ï¼š

```bash
make install
```

æ­¤æ—¶ç›´æ¥æ‰§è¡Œ `gcc -v` ä»ä¼šæ˜¾ç¤ºä»¥å‰å®‰è£…çš„ç‰ˆæœ¬ï¼Œåœ¨**é‡å¯ç³»ç»Ÿ**ä¹‹åå°±ä¼šæ˜¾ç¤ºä¸ºå½“å‰å®‰è£…çš„ç‰ˆæœ¬ã€‚

```bash
# é‡å¯å®¹å™¨ç¯å¢ƒ
docker restart ${CONTAINER}

# æ£€æŸ¥å®‰è£…æ˜¯å¦æˆåŠŸ
gcc -v

# æ˜¾ç¤ºå¦‚ä¸‹å†…å®¹è¡¨ç¤ºå®‰è£…æˆåŠŸ
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/local/libexec/gcc/x86_64-pc-linux-gnu/10.3.0/lto-wrapper
Target: x86_64-pc-linux-gnu
Configured with: /usr/local/gcc-10.3.0/configure --enable-checking=release --enable-languages=c,c++ --disable-multilib
Thread model: posix
Supported LTO compression algorithms: zlib
gcc version 10.3.0 (GCC)
```

## æ–‡æœ«ç¢ç¢å¿µ

æˆ‘æ²¡æœ‰åœ¨ Docker å®¹å™¨ç¯å¢ƒé‡Œæ‰§è¡Œ `make install` æ“ä½œï¼Œæ¥ç€ç›´æ¥é‡å¯äº†å½“å‰ä¸»æœºï¼Œå¯¼è‡´ä¸»æœºå‡ºç°é—®é¢˜æ²¡æ³•ç™»é™†ã€‚

ä¸€èˆ¬å»ºè®®ç¼–è¯‘å’Œå®‰è£…æ“ä½œéƒ½åœ¨ Docker å®¹å™¨ç¯å¢ƒé‡Œè¿›è¡Œï¼Œä¸è¦ç›´æ¥æ“ä½œå®¿ä¸»æœºç¯å¢ƒï¼

## å‚è€ƒæ–‡æ¡£

- [GCC ç¼–è¯‘å™¨ä¸‹è½½å’Œå®‰è£…æ•™ç¨‹ï¼ˆé’ˆå¯¹ Linux å‘è¡Œç‰ˆï¼‰](http://c.biancheng.net/view/7933.html)
</content:original-text><content:updated-at>2021-04-20T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[Protobuf å­¦ä¹ ç¬”è®°]]></title><description><![CDATA[å®ä¹ ä¸­å­¦ä¹ ä¸€ä¸‹ Protobuf çš„åŠŸèƒ½å’Œè¯­æ³•ç­‰ï¼Œæ•´ç†ä¸ºæ­¤ç¬”è®°ã€‚ä¸»è¦ä¸ºç¿»è¯‘å®˜æ–¹æ–‡æ¡£è€Œæ¥ã€‚ ä»€ä¹ˆæ˜¯ Protobuf

Protobuf æ˜¯ Google å…¬å¸ç ”å‘çš„ä¸€ç§ç”¨äºåºåˆ—åŒ–ç»“æ„æ•°æ®çš„æœºåˆ¶ï¼Œå…¨ç§°ä¸º Protocol Buffersï¼Œå…·æœ‰è¯­è¨€æ— å…³ã€å¹³å°æ— å…³ä»¥åŠå¯æ‹“å±•çš„ç‰¹æ€§ã€‚

æˆ‘ä»¬å¸¸å¸¸æŠŠ Protobuf ä¸ XML (Extensible Markup Language) ç›¸æ¯”è¾ƒâ€¦]]></description><link>https://blog.towind.fun/posts/protobuf-learning</link><guid isPermaLink="false">protobuf-learning</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Mon, 29 Mar 2021 00:00:00 GMT</pubDate><content:original-text>
å®ä¹ ä¸­å­¦ä¹ ä¸€ä¸‹ Protobuf çš„åŠŸèƒ½å’Œè¯­æ³•ç­‰ï¼Œæ•´ç†ä¸ºæ­¤ç¬”è®°ã€‚ä¸»è¦ä¸ºç¿»è¯‘å®˜æ–¹æ–‡æ¡£è€Œæ¥ã€‚

## ä»€ä¹ˆæ˜¯ Protobuf

Protobuf æ˜¯ Google å…¬å¸ç ”å‘çš„ä¸€ç§ç”¨äºåºåˆ—åŒ–ç»“æ„æ•°æ®çš„æœºåˆ¶ï¼Œå…¨ç§°ä¸º Protocol Buffersï¼Œå…·æœ‰è¯­è¨€æ— å…³ã€å¹³å°æ— å…³ä»¥åŠå¯æ‹“å±•çš„ç‰¹æ€§ã€‚

æˆ‘ä»¬å¸¸å¸¸æŠŠ Protobuf ä¸ XML (Extensible Markup Language) ç›¸æ¯”è¾ƒï¼Œå®ƒä»¬äºŒè€…éƒ½è¢«è®¾è®¡æ¥ä¼ è¾“å’Œå­˜å‚¨ç»“æ„åŒ–æ•°æ®ã€‚ç›¸æ¯”äº XMLï¼ŒProtobuf æœ‰å¦‚ä¸‹ä¼˜åŠ¿ä¸ç¼ºç‚¹ï¼š

- **Protobuf å ç”¨çš„ç©ºé—´æ›´å°**ã€‚Protobuf é‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼å­˜å‚¨æ•°æ®ï¼Œé€‚åˆç½‘ç»œä¼ è¾“å’Œé«˜æ€§èƒ½åœºæ™¯ï¼›è€Œ XML é‡‡ç”¨æ–‡æœ¬æ ¼å¼å­˜å‚¨æ•°æ®ï¼Œæ•°æ®å†—ä½™åº¦è¾ƒé«˜ã€‚
- **Protobuf ç¼–ç å’Œè§£ç æ›´å¿«**ã€‚æµ‹è¯• Protobuf åº“å’Œ tinyxml2 åº“æ‰§è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œï¼ˆ[ç›¸å…³é“¾æ¥](https://zhuanlan.zhihu.com/p/91313277)ï¼‰ï¼ŒProtobuf åºåˆ—åŒ–é€Ÿåº¦å¤§çº¦æ˜¯ XML çš„ 5 - 9 å€ï¼Œååºåˆ—åŒ–é€Ÿåº¦å¤§çº¦æ˜¯ XML çš„ 9 - 12 å€ï¼Œæ›´åŠ é€‚åˆé«˜æ€§èƒ½åœºæ™¯ã€‚
- **Protobuf ä¸å…·æœ‰å¯è¯»æ€§**ã€‚Protobuf ä¼ è¾“çš„å€¼ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œéœ€è¦ä¸“ç”¨å·¥å…·ç”Ÿæˆå’Œè§£æï¼›è€Œ XML è‡ªèº«çš„æ ‡ç­¾å’Œæ–‡æœ¬å†…å®¹å…·æœ‰ä¸€å®šçš„å¯è¯»æ€§ã€‚

&lt;details&gt;
&lt;summary&gt;ä½¿ç”¨ Protobufï¼Œåªéœ€è¦ç¼–å†™ &lt;code&gt;.proto&lt;/code&gt; æ–‡ä»¶æ¥æè¿°éœ€è¦ä¼ è¾“å’Œå­˜å‚¨çš„ç»“æ„æ•°æ®ï¼Œéšåç¼–è¯‘å™¨ä¼šä¸ºä¹‹åˆ›å»ºä¸€ä¸ªç±»ï¼Œå®ç°ç»“æ„æ•°æ®çš„è‡ªåŠ¨ç¼–ç å’Œè§£ç ã€‚&lt;/summary&gt;

With protocol buffers, you write a .proto description of the data structure you wish to store. From that, the protocol buffer compiler creates a class that implements automatic encoding and parsing of the protocol buffer data with an efficient binary format. The generated class provides getters and setters for the fields that make up a protocol buffer and takes care of the details of reading and writing the protocol buffer as a unit.

&lt;/details&gt;

&lt;details&gt;
&lt;summary&gt;æ­¤å¤–ï¼ŒProtobuf æ”¯æŒä½¿ç”¨ç‰¹å®šçš„æ–¹å¼æ¥æ‹“å±•æ ¼å¼ï¼Œä½¿ä»£ç èƒ½å¤Ÿè§£æä»¥å‰æ ¼å¼ç¼–ç å¾—åˆ°çš„æ•°æ®ã€‚&lt;/summary&gt;

Importantly, the protocol buffer format supports the idea of extending the format over time in such a way that the code can still read data encoded with the old format.

&lt;/details&gt;

## å®šä¹‰åè®®æ ¼å¼

ä¸ºäº†åˆ›å»ºåŸºäº Protobuf çš„åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆåˆ›å»ºä¸€ä¸ª `.proto` æ–‡ä»¶å¹¶ä¸”ç»™å‡ºå®šä¹‰ï¼šä¸ºéœ€è¦åºåˆ—åŒ–çš„æ¯ä¸ªç»“æ„æ•°æ®æ·»åŠ ä¸€æ¡ **message** ï¼Œç„¶åä¸º message çš„æ¯ä¸ªå­—æ®µæŒ‡å®šåç§°å’Œç±»å‹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæ¥è‡ªå®˜ç½‘çš„åŸºäº C++ è¯­è¨€çš„ä¾‹å­ï¼Œå¯ä»¥è®©æ‚¨å¯¹ `.proto` æ–‡ä»¶æœ‰ä¸€ä¸ªæ›´åŠ ç›´è§‚çš„äº†è§£ï¼š

```proto
syntax = &quot;proto2&quot;; // åè®®ç‰ˆæœ¬

package tutorial; // ç¨‹åºåŒ…å£°æ˜

message Person {
  optional string name = 1;
  optional int32 id = 2;
  optional string email = 3;

  enum PhoneType {
    MOBILE = 0;
    HOME = 1;
    WORK = 2;
  }

  message PhoneNumber {
    optional string number = 1;
    optional PhoneType type = 2 [default = HOME];
  }

  repeated PhoneNumber phones = 4;
}

message AddressBook {
  repeated Person people = 1;
}
```

åœ¨å¼€å¤´ï¼Œé¦–å…ˆæŒ‡å®šäº†åè®®çš„ç‰ˆæœ¬ï¼Œ`syntax = &quot;proto2&quot;;` è¡¨ç¤ºåº”ä½¿ç”¨ proto2 è¿›è¡Œç¼–ç å’Œè§£ç ã€‚åŒç†ï¼Œå¦‚æœæŒ‡å®šä¸º `syntax = &quot;proto3&quot;;` åˆ™è¡¨ç¤ºåº”ä½¿ç”¨ proto3 è¿›è¡Œç¼–ç å’Œè§£ç ã€‚å¦‚æœä¸æŒ‡å®šåè®®ç‰ˆæœ¬ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šä½¿ç”¨ proto2 è¿›è¡Œç¼–ç å’Œè§£ç ã€‚

ä½¿ç”¨ç¨‹åºåŒ…å£°æ˜ `package tutorial;` æœ‰åŠ©äºé˜²æ­¢ä¸åŒé¡¹ç›®ä¹‹é—´çš„å‘½åå‘ç”Ÿå†²çªã€‚åœ¨ C++ ä¸­ï¼Œç”Ÿæˆçš„ç±»å°†æ”¾ç½®åœ¨ä¸ç¨‹åºåŒ…åç§°åŒ¹é…çš„å‘½åç©ºé—´ä¸­ã€‚

æ¥ä¸‹æ¥å°±æ˜¯æœ€é‡è¦çš„ message å®šä¹‰äº†ã€‚message æ˜¯åŒ…å«ä¸€ç»„å­—æ®µç±»å‹çš„æ€»åˆã€‚æˆ‘ä»¬å°†åŸºäº **proto3** ç‰ˆæœ¬å¯¹ message è¯­æ³•è¿›è¡Œè®²è§£ä¸æè¿°ã€‚

## proto3 åŸºç¡€è¯­æ³•

### [å®šä¹‰æ¶ˆæ¯ç±»å‹](https://developers.google.com/protocol-buffers/docs/proto3#simple)

ä¸‹é¢æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ `.proto` ä¾‹å­ï¼š

```proto
syntax = &quot;proto3&quot;;

message SearchRequest {
  string query = 1;
  int32 page_number = 2;
  int32 result_per_page = 3;
}
```

å…¶ä¸­ç¬¬ä¸€è¡Œéœ€è¦æŒ‡å®šæ­£åœ¨ä½¿ç”¨ `proto3` è¯­æ³•ï¼Œå¦åˆ™ç¼–è¯‘å™¨å°†å‡å®šæ­£åœ¨ä½¿ç”¨ `proto2` è¯­æ³•ã€‚æŒ‡å®šè¯­æ³•ç‰ˆæœ¬å¿…é¡»åœ¨æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªéç©ºã€éæ³¨é‡Šè¡Œã€‚

ä¾‹å­å®šä¹‰äº†ä¸€ä¸ªåä¸º `SearchRequest` çš„ messageï¼Œå­˜å‚¨äº†ä¸‰ä¸ªå­—æ®µï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²ç±»å‹çš„ `query` å’Œæ•´æ•°ç±»å‹çš„ `page_number` ä¸ `result_per_page`. ä¸‰ä¸ªå­—æ®µå‡ä¸ºæ ‡é‡å€¼ç±»å‹ï¼Œæ‰€æœ‰å¯ç”¨çš„æ ‡é‡å€¼ç±»å‹å¯å‚è€ƒ[æ­¤é“¾æ¥](https://developers.google.com/protocol-buffers/docs/proto3#scalar)ã€‚é™¤äº†æ ‡é‡å€¼ç±»å‹ï¼Œå­—æ®µè¿˜å¯ä»¥ä½¿ç”¨æšä¸¾å’Œå…¶å®ƒ message ç±»å‹ã€‚

æ¯ä¸ªå®šä¹‰çš„å­—æ®µéƒ½æœ‰ä¸€ä¸ª**å”¯ä¸€**çš„ç¼–å·ï¼Œç”¨æ¥æ ‡è¯†äºŒè¿›åˆ¶æ ¼å¼ä¸‹çš„å­—æ®µã€‚ä¾‹å¦‚ `query` å­—æ®µçš„å”¯ä¸€ç¼–å·ä¸º `1`. å¯¹å­—æ®µç¼–å·çš„è¡¥å……å¯å‚è€ƒ[æ­¤é“¾æ¥](https://developers.google.com/protocol-buffers/docs/proto3#assigning_field_numbers)ã€‚

### [å­—æ®µè§„åˆ™](https://developers.google.com/protocol-buffers/docs/proto3#specifying_field_rules)

ä¸ proto2 ä¸åŒçš„æ˜¯ï¼Œproto3 åªåŒ…æ‹¬ä¸¤ç§å­—æ®µè§„åˆ™ï¼š

- singular. ä¸€åˆ™ message åªèƒ½æ‹¥æœ‰ä¸è¶…è¿‡ä¸€ä¸ªè¯¥å­—æ®µã€‚æ˜¯**é»˜è®¤**çš„å­—æ®µè§„åˆ™ï¼Œä¸éœ€è¦ç‰¹åˆ«æŒ‡å®šï¼›
- `repeated`. ä¸€åˆ™ message å¯ä»¥æ‹¥æœ‰ä»»æ„ä¸ªè¯¥å­—æ®µã€‚é‡å¤å€¼çš„é¡ºåºå°†è¢«ä¿ç•™ã€‚

```proto
message SearchRequest {
  string query = 1;
  int32 page_number = 2;
  int32 result_per_page = 3;
  repeated string query_extras = 4;
}
```

ä¸Šä¾‹ä¸­å®šä¹‰äº†ä¸‰ä¸ª singular å­—æ®µ `query`, `page_number` å’Œ `result_per_page`ï¼Œä»¥åŠä¸€ä¸ª `repeated` å­—æ®µ `query_extras`.

&lt;details&gt;
&lt;summary&gt;
ä½œä¸ºè¡¥å……ï¼Œproto2 åŒ…æ‹¬ä¸‰ç§å­—æ®µè§„åˆ™ï¼š&lt;code&gt;required&lt;/code&gt;, &lt;code&gt;optional&lt;/code&gt; å’Œ &lt;code&gt;repeated&lt;/code&gt;.
&lt;/summary&gt;

- `required`. ä¸€åˆ™ message ä¸­å¿…é¡»ä¸”åªèƒ½æ‹¥æœ‰ä¸€ä¸ªè¯¥å­—æ®µï¼›
- `optional`. ä¸€åˆ™ message ä¸­åªèƒ½æ‹¥æœ‰ä¸è¶…è¿‡ä¸€ä¸ªè¯¥å­—æ®µï¼Œç›¸å½“äº proto3 çš„ singular.
- `repeated`. ä¸€åˆ™ message å¯ä»¥æ‹¥æœ‰ä»»æ„ä¸ªè¯¥å­—æ®µï¼Œç›¸å½“äº proto3 çš„ `repeated`.

[ç›¸å…³é“¾æ¥](&lt;(https://developers.google.com/protocol-buffers/docs/proto#specifying_field_rules)&gt;)

&lt;/details&gt;

### [ä¿ç•™å­—æ®µ](https://developers.google.com/protocol-buffers/docs/proto3#reserved)

å½“æ›´æ–° message å®šä¹‰éœ€è¦å®Œå…¨ç§»é™¤ä¸€ä¸ªå­—æ®µæ—¶ï¼Œåˆ™å°†æ¥çš„ç”¨æˆ·åœ¨è‡ªå·±å¯¹è¯¥ç±»å‹è¿›è¡Œæ›´æ–°æ—¶å¯ä»¥é‡ç”¨è¯¥å­—æ®µå·ã€‚ä¸ºäº†ä¿è¯åœ¨è¯»å–æ—§ç‰ˆæœ¬çš„ `.proto` æ—¶ä¸å¼•å‘é—®é¢˜ï¼Œéœ€è¦å°†å·²åˆ é™¤å­—æ®µçš„å­—æ®µç¼–å·ï¼ˆæˆ–åç§°ï¼‰æŒ‡å®šä¸º `reserved`ï¼Œè¿™æ ·å°†æ¥ä»»ä½•ç”¨æˆ·åœ¨æ›´æ–° message æ—¶å°è¯•ä½¿ç”¨è¿™äº›å­—æ®µå·ï¼ˆæˆ–åç§°ï¼‰æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚

```proto
message Foo {
  reserved 2, 15, 9 to 11;
  reserved &quot;foo&quot;, &quot;bar&quot;;
}
```

ä¸Šè¿°å†…å®¹æŒ‡å®šäº† 2, 9, 10, 11, 15 ä¸ºä¿ç•™å­—æ®µå·ï¼ŒæŒ‡å®šäº† foo, bar ä¸ºä¿ç•™å­—æ®µåã€‚åœ¨ä»¥åçš„ç¼–å†™ä¸­ä¸åº”å½“è¢«ä½¿ç”¨ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸èƒ½åœ¨ä¸€æ¡ `reserved` è¯­å¥ä¸­åŒæ—¶ä½¿ç”¨å­—æ®µå·å’Œå­—æ®µåã€‚

```proto
reserved 2, 15, &quot;foo&quot;; // wrong!
```

### [ä½¿ç”¨æšä¸¾ç±»å‹](https://developers.google.com/protocol-buffers/docs/proto3#enum)

å½“åªå¸Œæœ›æŸä¸€ä¸ªå­—æ®µçš„å–å€¼ä¸ºé¢„å®šä¹‰å€¼çš„æŸä¸€ä¸ªæ—¶ï¼Œå¯ä»¥ä½¿ç”¨æšä¸¾ã€‚

```proto
message SearchRequest {
  string query = 1;
  int32 page_number = 2;
  int32 result_per_page = 3;
  enum Corpus {
    UNIVERSAL = 0;
    WEB = 1;
    IMAGES = 2;
    LOCAL = 3;
    NEWS = 4;
    PRODUCTS = 5;
    VIDEO = 6;
  }
  Corpus corpus = 4;
}
```

ä¸Šä¾‹ä¸­æˆ‘ä»¬å®šä¹‰äº†åä¸º `Corpus` çš„æšä¸¾ï¼Œå…¶ä¸­åŒ…æ‹¬ 7 ç§å¯èƒ½çš„å–å€¼ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ·»åŠ ä½¿ç”¨ `Corpus` æšä¸¾çš„å­—æ®µ `corpus`.

ä¸ºäº†å®šä¹‰æšä¸¾å¸¸é‡çš„åˆ«åï¼Œæˆ‘ä»¬å¯ä»¥å°†ç›¸åŒçš„å€¼åˆ†é…ç»™ä¸åŒçš„æšä¸¾å¸¸é‡åã€‚ä¸ºæ­¤ï¼Œé¦–å…ˆéœ€è¦å°† `allow_alias` é€‰é¡¹è®¾ç½®ä¸º `true`ï¼Œå¦åˆ™å°†ä¼šæŠ¥é”™ã€‚

```proto
message MyMessage {
  enum EnumAllowingAlias {
    option allow_alias = true;
    UNKNOWN = 0;
    STARTED = 1;
    RUNNING = 1; // It works.
  }
  EnumAllowingAlias enum_allowing_alias = 1;
}
```

ä¸Šä¾‹ä¸­ï¼Œ`STARTED` å’Œ `RUNNING` ä¸ºåŒä¸€æšä¸¾å¸¸é‡çš„ä¸åŒåˆ«åã€‚

### [ä½¿ç”¨ Message ç±»å‹](https://developers.google.com/protocol-buffers/docs/proto3#other)

ä¸ºäº†ä½¿æ¶ˆæ¯ç»“æ„æ›´åŠ æ¸…æ™°ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šå…¶ä»– message ç±»å‹ä½œä¸ºå­—æ®µç±»å‹ï¼Œå®ç°åµŒå¥—ã€‚

```proto
message SearchResponse {
  repeated Result results = 1;
}

message Result {
  string url = 1;
  string title = 2;
  repeated string snippets = 3;
}
```

ä¸Šä¾‹ä¸­å®šä¹‰äº†ä¸¤ç§ä¸åŒçš„ message ç±»å‹ï¼Œ`SearchResponse` å’Œ `Result`. å…¶ä¸­ `SearchResponse` æ‹¥æœ‰ä¸€ä¸ª `results` å­—æ®µï¼Œå…¶å­—æ®µç±»å‹ä¸º message ç±»å‹ `Result`.

### [ä½¿ç”¨åµŒå¥—ç±»å‹](https://developers.google.com/protocol-buffers/docs/proto3#nested)

ä¹Ÿè®¸æ‚¨ä¸éœ€è¦å¤ç”¨ä¸€äº› message ç±»å‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°† message ç±»å‹æ”¾åœ¨ message å½“ä¸­ã€‚

```proto
message SearchResponse {
  message Result {
    string url = 1;
    string title = 2;
    repeated string snippets = 3;
  }
  repeated Result results = 1;
}
```

ä¸Šä¾‹ä¸å‰ä¸€å°æ®µçš„ä¾‹å­æœ‰ç›¸åŒçš„æ•ˆæœã€‚

åµŒå¥—ç±»å‹ä¸é™å®šå±‚æ•°ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œæ·±å±‚åµŒå¥—ã€‚

```proto
message Outer { // Level 0
  message MiddleAA { // Level 1
    message Inner { // Level 2
      int64 ival = 1;
      bool  booly = 2;
    }
  }
  message MiddleBB { // Level 1
    message Inner { // Level 2
      int32 ival = 1;
      bool  booly = 2;
    }
  }
}
```

å…¶ä¸­ï¼Œ`MiddleAA` ä¸­çš„ `Inner` ä¸ `MiddleBB` ä¸­çš„ `Inner` è™½ç„¶æœ‰ç›¸åŒçš„å­—æ®µåï¼Œä½†å­˜å‚¨çš„æ˜¯ä¸åŒçš„å†…å®¹ã€‚

### å…¶å®ƒå­—æ®µç±»å‹

- [Any](https://developers.google.com/protocol-buffers/docs/proto3#any).
- [Oneof](https://developers.google.com/protocol-buffers/docs/proto3#oneof).
- [Maps](https://developers.google.com/protocol-buffers/docs/proto3#maps).

## å®šä¹‰ä¸º RPC æœåŠ¡

å¦‚æœæƒ³è¦å°† message ç±»å‹ç”¨äº RPC ç³»ç»Ÿï¼Œå¯ä»¥åœ¨ `.proto` æ–‡ä»¶ä¸­å®šä¹‰ RPC æœåŠ¡æ¥å£ï¼Œç¼–è¯‘å™¨å°†æ ¹æ®ä½¿ç”¨çš„è¯­è¨€ç”Ÿæˆ RPC æœåŠ¡æ¥å£å¹¶æ‰“æ¡©ã€‚

```proto
service SearchService {
  rpc Search(SearchRequest) returns (SearchResponse);
}
```

ä¸Šä¾‹å®šä¹‰äº†ä¸€ä¸ªåä¸º `SearchService` çš„ RPC æœåŠ¡ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ª `Search` æ–¹æ³•ï¼Œå…¶å‚æ•°ä¸º `SearchRequest` ç±»å‹çš„ messageï¼Œè¿”å›å€¼ä¸º `SearchResponse` ç±»å‹çš„ message.

èƒ½å¤Ÿä¸ Protobuf æœ€ç›´æ¥å¯¹æ¥çš„ RPC ç³»ç»Ÿæ˜¯ gRPCï¼ŒåŒæ ·ç”± Google å…¬å¸å¼€å‘çš„è¯­è¨€æ— å…³ã€å¹³å°æ— å…³çš„å¼€æº RPC ç³»ç»Ÿã€‚å¦‚æœä½¿ç”¨ gRPCï¼Œåªéœ€è¦ä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„ [gRPC æ’ä»¶](https://grpc.io/docs/protoc-installation/)ï¼Œå°±å¯ä»¥æ ¹æ® `.proto` æ–‡ä»¶é‡Œçš„å†…å®¹è‡ªåŠ¨ç”Ÿæˆ RPC ä»£ç ã€‚

## ç¼–è¯‘ .proto æ–‡ä»¶

é¦–å…ˆç¼–è¯‘å¹¶é…ç½®å¥½ Protocï¼Œå¹¶ä¸”å®‰è£…äº† Go è¯­è¨€æ’ä»¶ protoc-gen-go.

å‚è€ƒå®˜ç½‘ç»™å‡ºçš„ä¾‹å­ï¼Œæˆ‘åˆ†åˆ«ç¼–å†™äº† Go å’Œ C++ ç‰ˆæœ¬çš„ `.proto` æ–‡ä»¶ï¼š

```proto
// addressbook-go.proto
syntax = &quot;proto3&quot;;
package tutorial;

import &quot;google/protobuf/timestamp.proto&quot;;

// go_package é€‰é¡¹å®šä¹‰äº†è½¯ä»¶åŒ…çš„å¯¼å…¥è·¯å¾„
// å¯¹äº go ç‰ˆæœ¬ï¼ŒåŒ…å« go_package è®¾ç½®çš„å†…å®¹ï¼›cpp ç‰ˆæœ¬åº”æ³¨é‡Šæ‰
option go_package = &quot;github.com/protocolbuffers/protobuf/examples/go/tutorialpb&quot;;

message Person {
  string name = 1;
  int32 id = 2;
  string email = 3;

  enum PhoneType {
    MOBILE = 0;
    HOME = 1;
    WORK = 2;
  }

  message PhoneNumber {
    string number = 1;
    PhoneType type = 2;
  }

  repeated PhoneNumber phones = 4;

  google.protobuf.Timestamp last_updated = 5;
}

message AddressBook {
  repeated Person people = 1;
}
```

ä½¿ç”¨ `protoc` å‘½ä»¤å¯¹ç¼–å†™çš„ `.protoc` æ–‡ä»¶è¿›è¡Œç¼–è¯‘ã€‚

### Go ç‰ˆæœ¬ç¼–è¯‘

```bash
# ç¼–è¯‘ Go ç‰ˆæœ¬çš„ .protoc æ–‡ä»¶
protoc -I=$SRC_DIR --go_out=$DST_DIR $SRC_DIR/addressbook-go.proto
```

ç¼–è¯‘ Go ç‰ˆæœ¬ï¼Œä¼šåœ¨ `$DST_DIR/github.com/protocolbuffers/protobuf/examples/go/tutorialpb` ç›®å½•ä¸‹ç”Ÿæˆ `addressbook-go.pb.go` æ–‡ä»¶ã€‚

ç¤ºä¾‹ä»£ç  [`list_people.go`](https://github.com/protocolbuffers/protobuf/blob/master/examples/list_people.go) å±•ç¤ºäº†å¦‚ä½•æ‰“å°å‡º AddressBook ä¸­æ‰€æœ‰çš„ Person ä¿¡æ¯ï¼š

```go
func writePerson(w io.Writer, p *pb.Person) {
    fmt.Fprintln(w, &quot;Person ID:&quot;, p.Id)
    fmt.Fprintln(w, &quot;  Name:&quot;, p.Name)
    if p.Email != &quot;&quot; {
        fmt.Fprintln(w, &quot;  E-mail address:&quot;, p.Email)
    }

    for _, pn := range p.Phones {
        switch pn.Type {
        case pb.Person_MOBILE:
            fmt.Fprint(w, &quot;  Mobile phone #: &quot;)
        case pb.Person_HOME:
            fmt.Fprint(w, &quot;  Home phone #: &quot;)
        case pb.Person_WORK:
            fmt.Fprint(w, &quot;  Work phone #: &quot;)
        }
        fmt.Fprintln(w, pn.Number)
    }
}

func listPeople(w io.Writer, book *pb.AddressBook) {
    for _, p := range book.People {
        writePerson(w, p)
    }
}
```

### C++ ç‰ˆæœ¬ç¼–è¯‘

```bash
# ç¼–è¯‘ C++ ç‰ˆæœ¬çš„ .protoc æ–‡ä»¶
protoc -I=$SRC_DIR --cpp_out=$DST_DIR $SRC_DIR/addressbook-cpp.proto
```

ç¼–è¯‘ C++ ç‰ˆæœ¬ï¼Œä¼šåœ¨ `$DST_DIR` ç›®å½•ä¸‹ç”Ÿæˆ `addressbook-cpp.pb.cc` å’Œ `addressbook-cpp.pb.h` ä¸¤ä¸ªæ–‡ä»¶ã€‚

ç¤ºä¾‹ä»£ç  [`list_people.cc`](https://github.com/protocolbuffers/protobuf/blob/master/examples/list_people.cc) å±•ç¤ºäº†å¦‚ä½•æ‰“å°å‡º AddressBook ä¸­æ‰€æœ‰çš„ Person ä¿¡æ¯ï¼š

```cpp
void ListPeople(const tutorial::AddressBook&amp; address_book) {
  for (int i = 0; i &lt; address_book.people_size(); i++) {
    const tutorial::Person&amp; person = address_book.people(i);

    cout &lt;&lt; &quot;Person ID: &quot; &lt;&lt; person.id() &lt;&lt; endl;
    cout &lt;&lt; &quot;  Name: &quot; &lt;&lt; person.name() &lt;&lt; endl;
    if (person.email() != &quot;&quot;) {
      cout &lt;&lt; &quot;  E-mail address: &quot; &lt;&lt; person.email() &lt;&lt; endl;
    }

    for (int j = 0; j &lt; person.phones_size(); j++) {
      const tutorial::Person::PhoneNumber&amp; phone_number = person.phones(j);

      switch (phone_number.type()) {
        case tutorial::Person::MOBILE:
          cout &lt;&lt; &quot;  Mobile phone #: &quot;;
          break;
        case tutorial::Person::HOME:
          cout &lt;&lt; &quot;  Home phone #: &quot;;
          break;
        case tutorial::Person::WORK:
          cout &lt;&lt; &quot;  Work phone #: &quot;;
          break;
        default:
          cout &lt;&lt; &quot;  Unknown phone #: &quot;;
          break;
      }
      cout &lt;&lt; phone_number.number() &lt;&lt; endl;
    }
    if (person.has_last_updated()) {
      cout &lt;&lt; &quot;  Updated: &quot; &lt;&lt; TimeUtil::ToString(person.last_updated()) &lt;&lt; endl;
    }
  }
}
```
</content:original-text><content:updated-at>2021-03-29T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[åœ¨ Nuxt.js ä¸­å¼•å…¥é«˜å¾·åœ°å›¾å¹¶å®ç°å®šä½åŠé€†åœ°ç†ç¼–ç ]]></title><description><![CDATA[è¿·é€”çŸ¥åï¼è…¾è®¯åœ°å›¾çš„ JS API æ–‡æ¡£å®åœ¨è¿‡äºç®€é™‹ï¼Œä¸”åº“å¾ˆä¹…æ²¡æœ‰æ›´æ–°ï¼Œè½¬èº«æŠ•å…¥é«˜å¾·åœ°å›¾çš„æ€€æŠ±ï¼Œäº«å— this moment çš„ç¾å¥½ï¼ é«˜å¾·åœ°å›¾ä¸è…¾è®¯åœ°å›¾å®šä½åŠŸèƒ½åŒºåˆ«

é«˜å¾·åœ°å›¾å°†å®šä½åŠŸèƒ½å’Œé€†åœ°ç†ç¼–ç åŠŸèƒ½åˆ†å¼€ä¸ºä¸¤ä¸ªæ“ä½œï¼Œè€Œè…¾è®¯åœ°å›¾å°†äºŒè€…åˆå¹¶ã€‚

è¿™æ„å‘³ç€ä½¿ç”¨é«˜å¾·åœ°å›¾å®ç°é€†åœ°ç†ç¼–ç ï¼Œé¦–å…ˆéœ€è¦æ‰§è¡Œå®šä½æ“ä½œï¼Œå†å°†å¾—åˆ°çš„ç»“æœä¼ ç»™é€†åœ°ç†ç¼–ç æ’ä»¶è·å¾—æœ€åçš„ç»“æœã€‚

æ­¤å¤–â€¦]]></description><link>https://blog.towind.fun/posts/amap-import-vue</link><guid isPermaLink="false">amap-import-vue</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Wed, 17 Mar 2021 00:00:00 GMT</pubDate><content:original-text>
è¿·é€”çŸ¥åï¼è…¾è®¯åœ°å›¾çš„ JS API æ–‡æ¡£å®åœ¨è¿‡äºç®€é™‹ï¼Œä¸”åº“å¾ˆä¹…æ²¡æœ‰æ›´æ–°ï¼Œè½¬èº«æŠ•å…¥é«˜å¾·åœ°å›¾çš„æ€€æŠ±ï¼Œäº«å— this moment çš„ç¾å¥½ï¼

## é«˜å¾·åœ°å›¾ä¸è…¾è®¯åœ°å›¾å®šä½åŠŸèƒ½åŒºåˆ«

é«˜å¾·åœ°å›¾å°†å®šä½åŠŸèƒ½å’Œé€†åœ°ç†ç¼–ç åŠŸèƒ½åˆ†å¼€ä¸ºä¸¤ä¸ªæ“ä½œï¼Œè€Œè…¾è®¯åœ°å›¾å°†äºŒè€…åˆå¹¶ã€‚

è¿™æ„å‘³ç€ä½¿ç”¨é«˜å¾·åœ°å›¾å®ç°é€†åœ°ç†ç¼–ç ï¼Œé¦–å…ˆéœ€è¦æ‰§è¡Œå®šä½æ“ä½œï¼Œå†å°†å¾—åˆ°çš„ç»“æœä¼ ç»™é€†åœ°ç†ç¼–ç æ’ä»¶è·å¾—æœ€åçš„ç»“æœã€‚

æ­¤å¤–ï¼Œé«˜å¾·åœ°å›¾çš„é€†åœ°ç†ç¼–ç æ— æ³•è§£æä¸­å›½ä»¥å¤–çš„åœ°ç†åæ ‡ï¼Œåªèƒ½è§£æä¸­å›½å¢ƒå†…çœå¸‚åŒºç­‰åœ°ç†åæ ‡ã€‚

## å¼•å…¥é«˜å¾·åœ°å›¾ JS API åº“

è¿™é‡Œæˆ‘ä»¬é€šè¿‡é¡ºåºåŒæ­¥åŠ è½½çš„æ–¹å¼å¼•å…¥ç¬¬ä¸‰æ–¹åº“ã€‚

ç¼–è¾‘ `nuxt.config.js` ä¸­ `head` é¡¹ä»¥å¼•å…¥ JS API åº“ã€‚

```js
// nuxt.config.js
script: [
  {
    type: &apos;text/javascript&apos;,
    // å¼•å…¥é«˜å¾·åœ°å›¾ JavaScript APIï¼šhttps://developer.amap.com/api/jsapi-v2/guide/abc/load
    // YOUR-APP-KEY å³é«˜å¾·ä½ç½®æœåŠ¡åº”ç”¨çš„ key
    // AMap.Geolocation ä¸ºå®šä½æ’ä»¶
    // AMap.Geocoder ä¸ºé€†åœ°ç†ç¼–ç æ’ä»¶
    src:
      &apos;https://webapi.amap.com/maps?v=2.0&amp;key=YOUR-APP-KEY&amp;plugin=AMap.Geolocation,AMap.Geocoder&apos;,
  },
],
```

å¦‚æœè·å–è„šæœ¬å¤±è´¥ï¼Œè¯·å…³é—­æµè§ˆå™¨ä¸­æ‹¦æˆªå¹¿å‘Šçš„æ’ä»¶ç­‰ã€‚

æ­¤å¤–è¦æ³¨æ„ï¼š

- ä¸ºé¿å…åœ°å›¾æ•°æ®åè®®å’Œå‰ç«¯èµ„æºä¸åŒ¹é…å¯¼è‡´é¡µé¢è¿è¡ŒæŠ¥é”™ï¼Œåªå…è®¸åœ¨çº¿åŠ è½½ JS APIï¼Œç¦æ­¢è¿›è¡Œæœ¬åœ°è½¬å­˜ã€ä¸å…¶å®ƒä»£ç æ··åˆæ‰“åŒ…ç­‰ç”¨æ³•ã€‚â€”â€”[JS API çš„åŠ è½½](https://developer.amap.com/api/javascript-api/guide/abc/load)
- ç”±äº Chromeã€IOS10 ç­‰å·²ä¸å†æ”¯æŒéå®‰å…¨åŸŸçš„æµè§ˆå™¨å®šä½è¯·æ±‚ï¼Œä¸ºä¿è¯å®šä½æˆåŠŸç‡å’Œç²¾åº¦ï¼Œè¯·å°½å¿«å‡çº§æ‚¨çš„ç«™ç‚¹åˆ° HTTPSã€‚â€”â€”[AMap.Geolocation æ’ä»¶](https://developer.amap.com/api/javascript-api/reference/location)

## é«˜å¾·åœ°å›¾å®šä½åŠŸèƒ½å®ç°

ç°åœ¨å·²ç»å¼•å…¥äº†éœ€è¦çš„åº“åŠæ’ä»¶ `AMap.Geolocation`ï¼Œé¦–å…ˆè¦æ„å»ºä¸€ä¸ªæµè§ˆå™¨å®šä½å®ä¾‹ `geolocation`ï¼š

```js
// ä»…è¿›è¡Œå®šä½ï¼Œä¸ä¸åœ°å›¾äº¤äº’
const geolocation = new AMap.Geolocation({
  timeout: 10000, // è¶…è¿‡ 10 ç§’ååœæ­¢å®šä½
  noIpLocate: 1, // ç¦æ­¢ç§»åŠ¨ç«¯ä½¿ç”¨ IP å®šä½
  useNative: true, // ä½¿ç”¨å®‰å“å®šä½ sdk ç”¨æ¥è¿›è¡Œå®šä½
});
```

æ›´å¤šçš„æ„é€ é€‰é¡¹å¯å‚è€ƒ [AMap.Geolocation æ’ä»¶å®˜æ–¹æ–‡æ¡£](https://developer.amap.com/api/javascript-api/reference/location)ã€‚

å¯¹äºå®šä½æ–¹æ³• `getCurrentPosition(callback:function(status,result){})`ï¼Œå¯ä»¥ç”¨ callback çš„æ–¹å¼æˆ–äº‹ä»¶ç›‘å¬çš„æ–¹å¼å®ç°å–å¾—è¿”å›å€¼ã€‚ä»¥ callback çš„æ–¹å¼ä¸ºä¾‹ï¼Œå¯ç¼–å†™ï¼š

```js
geolocation.getCurrentPosition((status, result) =&gt; {
  if (status === &quot;complete&quot;) {
    // å®šä½æˆåŠŸ
    console.log(result);
  } else {
    // å®šä½å¤±è´¥
    console.log(result.message);
  }
});
```

ä¸ºäº†å°è£…å‡½æ•°ï¼Œæ— æ³•åœ¨å›è°ƒå‡½æ•°é‡Œæ·»åŠ  `return` è¿›è¡Œè¿”å›ï¼Œå› æ­¤é€‰æ‹©ä½¿ç”¨ `Promise` çš„æ–¹æ³•ï¼š

```js
function getCurrentPosition() {
  return new Promise((resolve, reject) =&gt; {
    geolocation.getCurrentPosition((status, positionResult) =&gt; {
      if (status === &quot;complete&quot;) {
        // å®šä½æˆåŠŸ
        resolve({
          status: 1,
          msg: &quot;è·å–åœ°ç†ä½ç½®æˆåŠŸ&quot;,
          result: positionResult,
        });
      } else {
        // å®šä½å¤±è´¥
        reject(new Error(`è·å–åœ°ç†ä½ç½®å¤±è´¥ï¼š${positionResult.message}`));
      }
    });
  });
}
```

æ¥ä¸‹æ¥åªéœ€è¦è¿›è¡Œæ ‡å‡†çš„ `then()` æˆ– `catch()` å¤„ç†å°±å¯ä»¥äº†ï¼š

```js
getCurrentPosition()
  .then((res) =&gt; {
    console.log(res);
  })
  .catch((err) =&gt; {
    console.log(err);
  });
```

## é«˜å¾·åœ°å›¾é€†åœ°ç†ç¼–ç åŠŸèƒ½å®ç°

[é«˜å¾·åœ°å›¾é€†åœ°ç†ç¼–ç ](https://developer.amap.com/api/javascript-api/reference/lnglat-to-address)ç”± `AMap.Geocoder` æ’ä»¶å®ç°ï¼Œæˆ‘ä»¬ä¹Ÿå·²ç»å¼•å…¥ã€‚

å› æ­¤åªéœ€è¦å°†ä¸Šä¸€æ­¥å¾—åˆ°çš„åœ°ç†ç»çº¬åº¦åæ ‡ä¿¡æ¯ä½œä¸ºå‚æ•°ä¼ å…¥å³å¯ï¼š

```js
function getCurrentAddress() {
  return new Promise((resolve, reject) =&gt; {
    // è°ƒç”¨å®šä½æ–¹æ³•
    getCurrentPosition()
      .then((positionResult) =&gt; {
        // å®šä½æˆåŠŸ
        // è·å¾—ç»çº¬åº¦åæ ‡æ•°ç»„ï¼Œå…ƒç´ é¡ºåºä¸å¯å˜
        const lnglat = [
          positionResult.result.position.lng,
          positionResult.result.position.lat,
        ];
        // æ„é€ åœ°ç†ç¼–ç æˆ–é€†åœ°ç†ç¼–ç åŠŸèƒ½å®ä¾‹
        const geocoder = new AMap.Geocoder();
        // è·å¾—é€†ç¼–ç ä¿¡æ¯
        geocoder.getAddress(lnglat, (addressStatus, addressResult) =&gt; {
          if (addressStatus === &quot;complete&quot; &amp;&amp; addressResult.regeocode) {
            // è·å–æˆåŠŸ
            resolve({
              status: 1,
              msg: &quot;è·å–åœ°ç†ä½ç½®å’Œåœ°åŒºä¿¡æ¯æˆåŠŸ&quot;,
              result: { positionResult: positionResult.result, addressResult },
            });
          } else {
            // è·å–å¤±è´¥
            resolve({
              status: 2,
              msg: &quot;è·å–åœ°ç†ä½ç½®æˆåŠŸï¼Œä½†è·å–åœ°åŒºä¿¡æ¯å¤±è´¥&quot;,
              result: { positionResult: positionResult.result },
            });
          }
        });
      })
      .catch((err) =&gt; {
        // å®šä½å¤±è´¥
        reject(err);
      });
  });
}
```

è°ƒç”¨æ–¹å¼åŒä¸Šæ‰€è¿°ï¼Œä¸å†èµ˜è¿°ã€‚å¯ä»¥æ·»åŠ å¯¹ `status` çš„åˆ¤æ–­éªŒè¯ç»“æœå¹¶è¿›è¡Œç›¸åº”å¤„ç†ã€‚

## å®Œæ•´æºç 

ç¼–å†™å°è£…çš„åŸºäº Nuxt.js + Promise å®ç°é«˜å¾·åœ°å›¾å®šä½åŠé€†åœ°ç†ç¼–ç çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```js
// plugins/amapGeolocation.js
import Vue from &quot;vue&quot;;

const geolocation = new AMap.Geolocation({
  timeout: 10000, // è¶…è¿‡ 10 ç§’ååœæ­¢å®šä½
  noIpLocate: 1, // ç¦æ­¢ç§»åŠ¨ç«¯ä½¿ç”¨ IP å®šä½
  useNative: true, // ä½¿ç”¨å®‰å“å®šä½ sdk ç”¨æ¥è¿›è¡Œå®šä½
});

/**
 * è·å–å½“å‰çš„ç»çº¬åº¦åæ ‡
 * https://developer.amap.com/api/javascript-api/reference/location
 */
function getCurrentPosition() {
  return new Promise((resolve, reject) =&gt; {
    geolocation.getCurrentPosition((status, positionResult) =&gt; {
      if (status === &quot;complete&quot;) {
        // å®šä½æˆåŠŸ
        resolve({
          status: 1,
          msg: &quot;è·å–åœ°ç†ä½ç½®æˆåŠŸ&quot;,
          result: positionResult,
        });
      } else {
        // å®šä½å¤±è´¥
        reject(new Error(`è·å–åœ°ç†ä½ç½®å¤±è´¥ï¼š${positionResult.message}`));
      }
    });
  });
}

/**
 * è·å–å½“å‰åœ°ç†åæ ‡çš„é€†ç¼–ç ç»“æœ
 * https://developer.amap.com/api/javascript-api/reference/lnglat-to-address
 */
function getCurrentAddress() {
  return new Promise((resolve, reject) =&gt; {
    getCurrentPosition()
      .then((positionResult) =&gt; {
        const lnglat = [
          positionResult.result.position.lng,
          positionResult.result.position.lat,
        ];
        const geocoder = new AMap.Geocoder();
        geocoder.getAddress(lnglat, (addressStatus, addressResult) =&gt; {
          if (addressStatus === &quot;complete&quot; &amp;&amp; addressResult.regeocode) {
            // é€†ç¼–ç æˆåŠŸ
            resolve({
              status: 1,
              msg: &quot;è·å–åœ°ç†ä½ç½®å’Œåœ°åŒºä¿¡æ¯æˆåŠŸ&quot;,
              result: { positionResult: positionResult.result, addressResult },
            });
          } else {
            // é€†ç¼–ç å¤±è´¥
            resolve({
              status: 2,
              msg: &quot;è·å–åœ°ç†ä½ç½®æˆåŠŸï¼Œä½†è·å–åœ°åŒºä¿¡æ¯å¤±è´¥&quot;,
              result: { positionResult: positionResult.result },
            });
          }
        });
      })
      .catch((err) =&gt; {
        // å®šä½å¤±è´¥
        reject(err);
      });
  });
}

const amapGeolocation = {
  install(Vue) {
    Vue.prototype.$Geolocation = {
      getCurrentPosition,
      getCurrentAddress,
    };
  },
};

Vue.use(amapGeolocation);
```

å°†æ­¤æ–‡ä»¶ä½œä¸ºæ’ä»¶å¼•å…¥ Nuxt.js åï¼Œå¯ä»¥åœ¨ Vue æ–‡ä»¶ä¸­é€šè¿‡å¦‚ä¸‹ä»£ç è½»æ¾è°ƒç”¨ï¼š

```js
// .vue
// ä»…è·å–åœ°ç†åæ ‡
this.$Geolocation
  .getCurrentPosition()
  .then((res) =&gt; {
    console.log(res);
  })
  .catch((error) =&gt; {
    console.log(error);
  });

// è·å–åœ°ç†åæ ‡åŠæ‰€åœ¨åœ°å€
this.$Geolocation
  .getCurrentAddress()
  .then((res) =&gt; {
    console.log(res);
  })
  .catch((error) =&gt; {
    console.log(error);
  });
```

## ç›¸å…³é“¾æ¥

- &lt;Link to=&quot;/posts/tencent-map-api-get-current-location&quot;&gt;
    ä½¿ç”¨è…¾è®¯ä½ç½®æœåŠ¡è¿›è¡Œ Web å‰ç«¯å®šä½
  &lt;/Link&gt;
</content:original-text><content:updated-at>2021-03-18T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[ä½¿ç”¨è…¾è®¯ä½ç½®æœåŠ¡è¿›è¡Œ Web å‰ç«¯å®šä½]]></title><description><![CDATA[æ­£åœ¨å¼€å‘çš„ Web é¡¹ç›®éœ€è¦è·å–ä½¿ç”¨è€…çš„ä½ç½®ä¿¡æ¯ï¼Œè€Œä½¿ç”¨è€…ä¸»è¦é€šè¿‡ç§»åŠ¨ç«¯è®¿é—®æ­¤ Web æœåŠ¡ã€‚ä½ç½®ä¿¡æ¯éœ€è¦ç²¾ç¡®åˆ°åŒºã€‚åœ¨è…¾è®¯ä½ç½®æœåŠ¡çš„å®šä½è§£å†³æ–¹æ¡ˆé‡Œæƒ³è¦æœç´¢å¯ç”¨çš„ JavaScript åº“ï¼Œåªçœ‹åˆ°äº†æœåŠ¡ç«¯çš„ IP å®šä½å’Œç§»åŠ¨ç«¯çš„å‡ ä¸ª SDK åŒ…ï¼Œç”šå¼‚ä¹‹ã€‚ ç»ˆäºåœ¨ä¸èµ·çœ¼çš„åœ°æ–¹æ‰¾åˆ°äº†å‰ç«¯å®šä½ç»„ä»¶ï¼Œé€‚ç”¨äºæµè§ˆå™¨è¿›è¡Œå®šä½æ“ä½œã€‚

æœ¬æ–‡åŸºäº Nuxt.js å®ç°å‰ç«¯å®šä½åŠŸèƒ½ã€‚

å®ƒèƒ½åšä»€ä¹ˆ

ç»„ä»¶æ—¨åœ¨ä¼˜åŒ–çº¯ HTMâ€¦]]></description><link>https://blog.towind.fun/posts/tencent-map-api-get-current-location</link><guid isPermaLink="false">tencent-map-api-get-current-location</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Tue, 16 Mar 2021 00:00:00 GMT</pubDate><content:original-text>
æ­£åœ¨å¼€å‘çš„ Web é¡¹ç›®éœ€è¦è·å–ä½¿ç”¨è€…çš„ä½ç½®ä¿¡æ¯ï¼Œè€Œä½¿ç”¨è€…ä¸»è¦é€šè¿‡ç§»åŠ¨ç«¯è®¿é—®æ­¤ Web æœåŠ¡ã€‚ä½ç½®ä¿¡æ¯éœ€è¦ç²¾ç¡®åˆ°åŒºã€‚åœ¨è…¾è®¯ä½ç½®æœåŠ¡çš„[å®šä½è§£å†³æ–¹æ¡ˆ](https://lbs.qq.com/location/#anchor)é‡Œæƒ³è¦æœç´¢å¯ç”¨çš„ JavaScript åº“ï¼Œåªçœ‹åˆ°äº†æœåŠ¡ç«¯çš„ IP å®šä½å’Œç§»åŠ¨ç«¯çš„å‡ ä¸ª SDK åŒ…ï¼Œç”šå¼‚ä¹‹ã€‚

ç»ˆäºåœ¨ä¸èµ·çœ¼çš„åœ°æ–¹æ‰¾åˆ°äº†[å‰ç«¯å®šä½ç»„ä»¶](https://lbs.qq.com/webApi/component/componentGuide/componentGeolocation)ï¼Œé€‚ç”¨äºæµè§ˆå™¨è¿›è¡Œå®šä½æ“ä½œã€‚

æœ¬æ–‡åŸºäº Nuxt.js å®ç°å‰ç«¯å®šä½åŠŸèƒ½ã€‚

## å®ƒèƒ½åšä»€ä¹ˆ

ç»„ä»¶æ—¨åœ¨ä¼˜åŒ–çº¯ [HTML5 Geolocation](https://w3c.github.io/geolocation-api) å®šä½èƒ½åŠ›å¼±ï¼Œå®šä½æˆåŠŸç‡ä¸é«˜çš„é—®é¢˜ï¼Œæä¾›ç®€å•ã€æ˜“ç”¨çš„æ¥å£å¸®åŠ©ä¸šåŠ¡å±‚è·å–ç”¨æˆ·å½“å‰çš„ä½ç½®ä¿¡æ¯ï¼ˆéœ€ç”¨æˆ·æˆæƒï¼‰ï¼Œä»¥é™ä½å¼€å‘æˆæœ¬ï¼Œæå‡å®šä½ç²¾å‡†åº¦ã€‚

é™¤äº†å¸¸è§„çš„ç»çº¬åº¦åæ ‡ä»¥å¤–ï¼Œå®ƒè¿”å›çš„ç»“æœé‡Œè¿˜åŒ…å«äº† `city` å’Œ `district` é¡¹ï¼Œéå¸¸æ–¹é¢ã€‚

```js
{
  &quot;module&quot;: &quot;geolocation&quot;,
  &quot;type&quot;: &quot;h5_watch&quot;,
  &quot;adcode&quot;: &quot;&quot;, //è¡Œæ”¿åŒº IDï¼Œå…­ä½æ•°å­—, å‰ä¸¤ä½æ˜¯çœï¼Œä¸­é—´æ˜¯å¸‚ï¼Œåé¢ä¸¤ä½æ˜¯åŒºï¼Œæ¯”å¦‚æ·±åœ³å¸‚ ID ä¸º 440300
  &quot;nation&quot;: &quot;ç¾å›½&quot;,
  &quot;province&quot;: &quot;&quot;,
  &quot;city&quot;: &quot;åŠ åˆ©ç¦å°¼äºšå·&quot;,
  &quot;district&quot;: &quot;æ´›æ‰çŸ¶å¿&quot;,
  &quot;addr&quot;: &quot;&quot;,
  &quot;lat&quot;: 34.035244, //ç«æ˜Ÿåæ ‡ (gcj02)ï¼Œè…¾è®¯ã€Googleã€é«˜å¾·ç­‰åœ°å›¾é€šç”¨
  &quot;lng&quot;: -118.252207,
  &quot;accuracy&quot;: 1441 //è¯¯å·®èŒƒå›´ï¼Œä»¥ç±³ä¸ºå•ä½
}
```

å¯æƒœç›¸å…³é¡µé¢çš„æœ€åä¸€æ¬¡æ›´æ–°æœ€è¿‘å¯èƒ½æ˜¯åœ¨ `2016-02-23`ï¼Œæ–‡æ¡£æ’°å†™ç®€é™‹ä¸å ªï¼Œåªèƒ½åœ¨é¡¹ç›®ä¸­æ…¢æ…¢è¯•é”™ä½¿ç”¨ã€‚

## å¼•å…¥å‰ç«¯å®šä½ç»„ä»¶åº“

é¦–å…ˆéœ€è¦åœ¨è…¾è®¯ä½ç½®æœåŠ¡çš„æ§åˆ¶å°æ·»åŠ åº”ç”¨ï¼Œè·å¾—åº”ç”¨çš„ `key`ã€‚

è¿™é‡Œé€‰æ‹©ä½¿ç”¨å‰ç«¯å®šä½ç»„ä»¶çš„**è°ƒç”¨æ–¹å¼ä¸‰**ã€‚

åœ¨ HTML æ–‡ä»¶çš„ä¸­å¼•å…¥è„šæœ¬ï¼Œå¯¹åº” Nuxt.js åº”ç”¨ä¸­çš„ `nuxt.config.js`ï¼š

```js
// nuxt.config.js
export default {
  head: {
    script: [
      {
        type: &quot;text/javascript&quot;,
        // å¼•å…¥è…¾è®¯åœ°å›¾å‰ç«¯å®šä½ç»„ä»¶
        // YOUR-APP-KEY å³è…¾è®¯ä½ç½®æœåŠ¡åº”ç”¨çš„ key
        // YOUR-APP-NAME å³è…¾è®¯ä½ç½®æœåŠ¡åº”ç”¨çš„åç§°
        src: &quot;https://apis.map.qq.com/tools/geolocation/min?key=YOUR-APP-KEY&amp;referer=YOUR-APP-NAME&quot;,
      },
    ],
  },
};
```

å¦‚æœè·å–è„šæœ¬å¤±è´¥ï¼Œè¯·å…³é—­æµè§ˆå™¨ä¸­æ‹¦æˆªå¹¿å‘Šçš„æ’ä»¶ç­‰ã€‚

æ­¤å¤–ï¼Œç”±äºç”¨æˆ·çš„ä½ç½®ä¿¡æ¯å±äºæ•æ„Ÿä¿¡æ¯ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ `HTTPS` çš„ç½‘é¡µå‘é€è¯·æ±‚ï¼›å¦‚æœåœ¨æœ¬æœºå¼€å‘ï¼Œè¯·ä½¿ç”¨ `localhost:port` çš„å½¢å¼å¼€å‘å’Œè®¿é—®ã€‚

## å®ç° Web å‰ç«¯å®šä½

ç¼–å†™ä»£ç å¦‚ä¸‹ï¼š

```js
const geolocation = new qq.maps.Geolocation();

geolocation.getLocation(
  (position) =&gt; {
    // æˆåŠŸè·å–ä½ç½®ä¿¡æ¯
    console.log(position);
    // å°†ä½ç½®ä¿¡æ¯åºåˆ—åŒ–å­˜å‚¨åœ¨ localStorage ä¸­
    const currentLocation = {
      city: position.city,
      district: position.district,
    };
    localStorage.currentLocation = JSON.stringify(currentLocation);
  },
  (error) =&gt; {
    // è·å–ä½ç½®ä¿¡æ¯å¤±è´¥
    console.log(error);
  },
);
```

æ‰§è¡Œä»£ç ï¼Œå¾—åˆ°ç»“æœå¦‚ä¸‹ï¼ˆå…¶ä¸­ `*` ä¸ºæˆ‘æ‰‹åŠ¨æ‰“ç ï¼‰ï¼š

```js
{
  &quot;module&quot;: &quot;geolocation&quot;,
  &quot;type&quot;: &quot;h5&quot;,
  &quot;adcode&quot;: &quot;510117&quot;,
  &quot;nation&quot;: &quot;ä¸­å›½&quot;,
  &quot;province&quot;: &quot;å››å·çœ&quot;,
  &quot;city&quot;: &quot;æˆéƒ½å¸‚&quot;,
  &quot;district&quot;: &quot;éƒ«éƒ½åŒº&quot;,
  &quot;addr&quot;: &quot;***&quot;,
  &quot;lat&quot;: 30.75****,
  &quot;lng&quot;: 103.92****,
  &quot;accuracy&quot;: 113
}
```

å®šä½æˆåŠŸç²¾ç¡®åˆ°å½“å‰æˆ‘æ‰€å¤„çš„åŒºå’Œåœ°å€ï¼Œæ»¡è¶³é¡¹ç›®å¼€å‘è¦æ±‚ã€‚

å…¶å®ƒç›¸å…³æ–¹æ³•å’Œè¯´æ˜æ•¬è¯·å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://lbs.qq.com/webApi/component/componentGuide/componentGeolocation)çš„â€œæš—ç¤ºâ€ã€‚
</content:original-text><content:updated-at>2021-03-16T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[æç¤º *** is not a symbolic link è§£å†³æ–¹æ¡ˆ]]></title><description><![CDATA[é—®é¢˜æè¿° åœ¨ CentOS ç¯å¢ƒä¸‹æ‰§è¡Œ  å’Œ  å‘½ä»¤æ—¶éƒ½å‡ºç°æç¤ºè­¦å‘Šï¼ŒèŠ‚é€‰å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

é”™è¯¯åˆ†æ

è¿›å…¥åˆ°å¯¹åº”ç›®å½•ä¸‹æŸ¥æ‰¾å¯ä»¥å‘ç°ï¼Œè¿™é‡Œçš„  ä¸  å®é™…ä¸Šæ˜¯ç›¸åŒçš„åŠ¨æ€åº“æ–‡ä»¶ï¼Œè€Œéæˆ‘ä»¬æœŸæœ›çš„ç¬¦å·é“¾æ¥å’ŒåŠ¨æ€åº“æ–‡ä»¶ã€‚

è¿™ä¸ªé”™è¯¯çš„äº§ç”ŸåŸå› æ˜¯ï¼Œ åœ¨æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥æ˜¯ä¸€ä¸ªæŒ‡å‘  æ–‡ä»¶çš„è½¯é“¾æ¥ï¼Œä½†å´å˜æˆäº†ä¸€ä¸ªåŠ¨æ€åº“æ–‡ä»¶ã€‚

åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé”™è¯¯å¹¶ä¸ä¼šå¯¼è‡´ä¸¥é‡çš„é—®é¢˜ï¼›ä½†å‡å¦‚ç›®å½•ä¸‹æœ‰å¤šä¸ªä¸åŒç‰ˆæœ¬çš„åŠ¨æ€åº“æ–‡ä»¶â€¦]]></description><link>https://blog.towind.fun/posts/xxx-is-not-a-symbolic-link</link><guid isPermaLink="false">xxx-is-not-a-symbolic-link</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Wed, 10 Mar 2021 00:00:00 GMT</pubDate><content:original-text>
## é—®é¢˜æè¿°

åœ¨ CentOS ç¯å¢ƒä¸‹æ‰§è¡Œ `yum update` å’Œ `ldconfig` å‘½ä»¤æ—¶éƒ½å‡ºç°æç¤ºè­¦å‘Šï¼ŒèŠ‚é€‰å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```bash
ldconfig: /OSM/lib/librdmacm.so.1 is not a symbolic link
ldconfig: /OSM/lib/libgrpc++_reflection.so.1 is not a symbolic link
ldconfig: /OSM/lib/libupb.so.9 is not a symbolic link
```

## é”™è¯¯åˆ†æ

è¿›å…¥åˆ°å¯¹åº”ç›®å½•ä¸‹æŸ¥æ‰¾å¯ä»¥å‘ç°ï¼Œè¿™é‡Œçš„ `librdmacm.so.1` ä¸ `librdmacm.so.1.1.17.4` å®é™…ä¸Šæ˜¯ç›¸åŒçš„åŠ¨æ€åº“æ–‡ä»¶ï¼Œè€Œéæˆ‘ä»¬æœŸæœ›çš„ç¬¦å·é“¾æ¥å’ŒåŠ¨æ€åº“æ–‡ä»¶ã€‚

```bash
[root@xxx ~]# cd /OSM/lib
[root@xxx lib]# find librdmacm.so.1* | xargs ls -l
-rwx------. 1 root root 442208 Mar  9 16:13 librdmacm.so.1
-rwx------. 1 root root 442208 Mar  9 16:13 librdmacm.so.1.1.17.4
```

è¿™ä¸ªé”™è¯¯çš„äº§ç”ŸåŸå› æ˜¯ï¼Œ`librdmacm.so.1` åœ¨æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥æ˜¯ä¸€ä¸ªæŒ‡å‘ `librdmacm.so.1.1.17.4` æ–‡ä»¶çš„è½¯é“¾æ¥ï¼Œä½†å´å˜æˆäº†ä¸€ä¸ªåŠ¨æ€åº“æ–‡ä»¶ã€‚

åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé”™è¯¯å¹¶ä¸ä¼šå¯¼è‡´ä¸¥é‡çš„é—®é¢˜ï¼›ä½†å‡å¦‚ç›®å½•ä¸‹æœ‰å¤šä¸ªä¸åŒç‰ˆæœ¬çš„åŠ¨æ€åº“æ–‡ä»¶ï¼Œè½¯é“¾æ¥å¯èƒ½æ— æ³•æ­£ç¡®è·å–åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œäº§ç”Ÿéšæ‚£ã€‚

è§£å†³è¿™ä¸ªé—®é¢˜åªéœ€è¦å°† `librdmacm.so.1` ä¿®æ”¹ä¸ºæ­£å¸¸çš„è½¯é“¾æ¥æ–‡ä»¶ï¼Œé‡æ–°é“¾æ¥ä¸¤ä¸ªæ–‡ä»¶å°±å¯ä»¥äº†ã€‚

## è§£å†³æ–¹æ¡ˆ

æ‰§è¡Œ `ln -sf [åŠ¨æ€åº“æ–‡ä»¶æˆ–æºæ–‡ä»¶] [ç¬¦å·é“¾æ¥æˆ–ç›®æ ‡æ–‡ä»¶]` å³å¯ï¼Œå…¶ä¸­ `-s` æŒ‡åˆ›å»ºè½¯é“¾æ¥ï¼Œ`-f` æŒ‡å¼ºåˆ¶æ‰§è¡Œã€‚ä¾‹å¦‚ï¼š

```bash
[root@xxx lib]# ln -sf librdmacm.so.1.1.17.4 librdmacm.so.1
[root@xxx lib]# find librdmacm.so.1* | xargs ls -l
lrwxrwxrwx. 1 root root     21 Mar 10 16:26 librdmacm.so.1 -&gt; librdmacm.so.1.1.17.4
-rwx------. 1 root root 442208 Mar  9 16:13 librdmacm.so.1.1.17.4
```

ç°åœ¨æ­£å¦‚æˆ‘ä»¬é¢„æœŸçš„ï¼Œ`librdmacm.so.1` æ­£ç¡®æŒ‡å‘äº† `librdmacm.so.1.1.17.4`ã€‚

### æ›´å¥½çš„æ–¹å¼

å‡å¦‚åŒæ—¶æŠ¥äº†å¾ˆå¤šä¸ªç±»ä¼¼çš„æç¤ºï¼Œåº”å½“å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ

æˆ‘ä»¬çŸ¥é“æ‰§è¡Œ `ldconfig` å‘½ä»¤æ—¶ï¼Œä¼šè‡ªåŠ¨ä¸ºå…³è”ç›®å½•ä¸‹çš„æ‰€æœ‰åŠ¨æ€åº“æ–‡ä»¶åˆ›å»ºå¯¹åº”çš„è½¯é“¾æ¥ã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦åˆ é™¤æ‰è¿™äº›é‡å¤çš„æ–‡ä»¶ï¼Œå†æ‰§è¡Œå‘½ä»¤å°±å¯ä»¥äº†ã€‚

å°† `ldconfig` å‘½ä»¤çš„é”™è¯¯è¾“å‡ºé‡å®šå‘åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œè¯»å–å†…å®¹ï¼Œç»„åˆä½¿ç”¨ `cut` å’Œ `rm` å‘½ä»¤å³å¯å®ç°åˆ é™¤é‡å¤æ–‡ä»¶ï¼Œæ¥ä¸‹æ¥åˆ é™¤å­˜å‚¨é”™è¯¯ä¿¡æ¯çš„ä¸´æ—¶æ–‡ä»¶ã€‚æœ€åå†æ¬¡æ‰§è¡Œ `ldconfig` åˆ›å»ºè½¯é“¾æ¥ã€‚

```bash
# æ ‡å‡†é”™è¯¯è¾“å‡ºåˆ° dupNote ä¸´æ—¶æ–‡ä»¶ä¸­
ldconfig 2&gt; dupNote
# åˆ é™¤é‡å¤çš„åŠ¨æ€åº“ï¼ˆéè½¯é“¾æ¥ï¼‰æ–‡ä»¶
cat dupNote | cut -c 11- | rev | cut -c 23- | rev | xargs rm -rf
# åˆ é™¤åˆšåˆšåˆ›å»ºçš„ä¸´æ—¶æ–‡ä»¶
rm -rf dupNote
# åˆ›å»ºè½¯é“¾æ¥
ldconfig
```

å½“ç„¶å¯ä»¥åˆèµ·æ¥å˜æˆä¸€æ¡å‘½ä»¤ä½¿ç”¨ï¼š

```bash
ldconfig 2&gt; dupNote ; cat dupNote | cut -c 11- | rev | cut -c 23- | rev | xargs rm -rf ; rm -rf dupNote ; ldconfig
```

ç°åœ¨æ‰§è¡Œ `ldconfig` ä¸å†æç¤º `*** is not a symbolic link` é”™è¯¯ï¼Œé—®é¢˜é¡ºåˆ©è§£å†³ï¼

## ç›¸å…³é“¾æ¥

- [/usr/lib/\*\*\* is not a symbolic link é—®é¢˜è§£å†³ - CSDN](https://blog.csdn.net/qq_34213260/article/details/107399507)
- [Linux ln å‘½ä»¤ - èœé¸Ÿæ•™ç¨‹](https://www.runoob.com/linux/linux-comm-ln.html)
</content:original-text><content:updated-at>2021-03-10T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[å‰ç«¯å·¥ç¨‹é…ç½® ESLint å’Œ Prettier æ£€æŸ¥å¹¶è§„èŒƒä»£ç è´¨é‡ä¸æ ¼å¼]]></title><description><![CDATA[å“ªä½ä»£ç äººä¸å¸Œæœ›è‡ªå·±çš„ä»£ç æ€»æœ‰ç»Ÿä¸€ä¼˜ç¾çš„é£æ ¼ï¼Œä¸ä¼šå› ä¸ºåˆä½œå¼€å‘é¡¹ç›®è€Œæ‚ä¹±å‘¢ï¼Ÿ åœ¨æœ€å¼€å§‹å†™é¡¹ç›®ä»£ç çš„æ—¶å€™æˆ‘å°±ç”¨èµ·äº† ESLint å’Œ Prettierï¼Œå†è£…ä¸€å †é¢„è®¾çš„é…ç½®ï¼Œä¾¿è·‘äº†èµ·æ¥ã€‚ä»¤äººæ²®ä¸§çš„æ˜¯ï¼Œç”¨ ESLint ä¿®å¤äº†ä»£ç è´¨é‡é—®é¢˜ï¼Œè¿˜æ˜¯ä¼šåœ¨ç¼–è¯‘å™¨é‡Œçœ‹åˆ°çº¢è‰²æ³¢æµªçº¿ï¼Œæé†’è¿˜æœ‰äº›ä»£ç é£æ ¼éœ€è¦ä¿®å¤ã€‚ç›´åˆ°è¿™ä¸€æ¬¡ï¼Œæˆ‘æ‰å¿½ç„¶æ„è¯†åˆ° ESLint å’Œ Prettier å…¶å®åˆ†å·¥äº†ä¸åŒé¢†åŸŸï¼ŒååŒä½¿ç”¨ä½“éªŒæå¥½ã€‚

æœ¬â€¦]]></description><link>https://blog.towind.fun/posts/nodejs-eslint-prettier</link><guid isPermaLink="false">nodejs-eslint-prettier</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Wed, 03 Mar 2021 00:00:00 GMT</pubDate><content:original-text>
å“ªä½ä»£ç äººä¸å¸Œæœ›è‡ªå·±çš„ä»£ç æ€»æœ‰ç»Ÿä¸€ä¼˜ç¾çš„é£æ ¼ï¼Œä¸ä¼šå› ä¸ºåˆä½œå¼€å‘é¡¹ç›®è€Œæ‚ä¹±å‘¢ï¼Ÿ

åœ¨æœ€å¼€å§‹å†™é¡¹ç›®ä»£ç çš„æ—¶å€™æˆ‘å°±ç”¨èµ·äº† ESLint å’Œ Prettierï¼Œå†è£…ä¸€å †é¢„è®¾çš„é…ç½®ï¼Œä¾¿è·‘äº†èµ·æ¥ã€‚ä»¤äººæ²®ä¸§çš„æ˜¯ï¼Œç”¨ ESLint ä¿®å¤äº†ä»£ç **è´¨é‡**é—®é¢˜ï¼Œè¿˜æ˜¯ä¼šåœ¨ç¼–è¯‘å™¨é‡Œçœ‹åˆ°çº¢è‰²æ³¢æµªçº¿ï¼Œæé†’è¿˜æœ‰äº›ä»£ç **é£æ ¼**éœ€è¦ä¿®å¤ã€‚ç›´åˆ°è¿™ä¸€æ¬¡ï¼Œæˆ‘æ‰å¿½ç„¶æ„è¯†åˆ° ESLint å’Œ Prettier å…¶å®åˆ†å·¥äº†ä¸åŒé¢†åŸŸï¼ŒååŒä½¿ç”¨ä½“éªŒæå¥½ã€‚

æœ¬æ–‡å°†é˜è¿°ç¬”è€…å¦‚ä½•é…ç½® ESLint + Prettierï¼Œå®ç°å‰ç«¯é¡¹ç›®æ£€æŸ¥å¹¶ä¿®å¤ä»£ç è´¨é‡ä¸æ ¼å¼é—®é¢˜çš„èƒ½åŠ›ã€‚

## ä»‹ç» ESLint ä¸ Prettier

ESLint æ˜¯ä¸€ä¸ªå¼€æºçš„ JavaScript ä»£ç æ£€æŸ¥å·¥å…·ï¼ŒPrettier æ˜¯ä¸€æ¬¾ä»£ç æ ¼å¼å·¥å…·ã€‚å®ƒä»¬çš„åŠŸèƒ½ä¾§é‡å¦‚ä¸‹æ‰€ç¤ºï¼š

- ESLintï¼šä¸»è¦è´Ÿè´£ä»£ç **è´¨é‡**çš„æ ¡éªŒï¼Œå…¶æ¬¡åŒ…å«éƒ¨åˆ†çš„**é£æ ¼**æ£€éªŒã€‚
- Prettierï¼šä¸»è¦è´Ÿè´£ä»£ç **é£æ ¼**çš„æ ¡éªŒã€‚

ESLint è®¤ä¸ºä»£ç é£æ ¼å¹¶æ²¡æœ‰é‚£ä¹ˆé‡è¦ï¼Œå› æ­¤å¹¶æœªå®Œå…¨è§£å†³ä»£ç é£æ ¼é—®é¢˜ã€‚

&gt; Rules are &quot;agenda free&quot; - ESLint does not promote any particular coding style.

è€Œ Prettier åˆ™è®¤ä¸ºè‡ªå·±æ˜¯å›ºæ‰§å·±è§çš„ä»£ç æ ¼å¼åŒ–å·¥å…·ã€‚

&gt; An opinionated code formatter.

ç›®å‰å…¬è®¤çš„ä¸€ä¸ªæœ€ä½³å®è·µæ˜¯ç»“åˆäºŒè€…çš„å¼ºé¡¹ï¼šè®© Prettier ä¸“æ³¨å¤„ç†ä»£ç æ ¼å¼é—®é¢˜ï¼Œè®© ESLint ä¸“æ³¨å¤„ç†ä»£ç è´¨é‡é—®é¢˜ã€‚

## å¼•å…¥ ESLint ä¸ Prettier

é¦–å…ˆï¼Œè‡ªç„¶æ˜¯å®‰è£… ESLint å’Œ Prettier ä½œä¸ºé¡¹ç›®ä¾èµ–ã€‚

```bash
yarn add --dev eslint prettier
```

æ¥ç€ï¼Œè®© ESLint ä¸€å¹¶æ¥ç®¡ Prettier çš„å·¥ä½œï¼Œè¿™å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªåº“å®ç°ï¼š

- [`eslint-plugin-prettier`](https://github.com/prettier/eslint-plugin-prettier)ï¼šESLint æ’ä»¶ï¼ŒåŒ…æ‹¬äº† ESLint éœ€è¦æ£€æŸ¥çš„ä¸€äº›é¢å¤–ä»£ç æ ¼å¼è§„åˆ™ã€‚åœ¨å¹•åï¼Œå®ƒä½¿ç”¨åˆ°äº† Prettierï¼Œç›¸å½“äºå°† Prettier ä½œä¸º ESLint çš„ä¸€éƒ¨åˆ†è¿è¡Œã€‚
- [`eslint-config-prettier`](https://github.com/prettier/eslint-config-prettier)ï¼šESLint é…ç½®ï¼Œå¯ä»¥å…³é—­ ESLint é‡Œæ‰€æœ‰ä¸å¿…è¦æˆ–è€…å¯èƒ½ä¸ Prettier äº§ç”Ÿå†²çªçš„ä»£ç æ ¼å¼è§„åˆ™ã€‚

åœ¨é¡¹ç›®é‡Œå®‰è£…å®ƒä»¬ï¼š

```bash
yarn add --dev eslint-plugin-prettier eslint-config-prettier
```

å°† `eslint-plugin-prettier` çš„æ¨èé…ç½® `plugin:prettier/recommended` æ”¾åˆ° ESLint é…ç½®é‡Œ `extends` çš„æœ€åä¸€é¡¹å³å¯ï¼Œå®ƒå°†è‡ªåŠ¨é…ç½®å¹¶å¯ç”¨ `eslint-config-prettier`ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

```js
// .eslintrc.js
module.exports = {
  extends: [
    // ... æ‚¨ä½¿ç”¨çš„å…¶å®ƒ ESLint æ‹“å±•
    &quot;plugin:prettier/recommended&quot;,
  ],
};
```

å¯¹äºæ–°ç‰ˆæœ¬çš„ ESLint é…ç½®æ–‡ä»¶ `eslint.config.js`ï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·é…ç½®ï¼š

```js
const eslintPluginPrettierRecommended = require(&quot;eslint-plugin-prettier/recommended&quot;);

module.exports = [
  // ... æ‚¨ä½¿ç”¨çš„å…¶å®ƒ ESLint æ‹“å±•
  eslintPluginPrettierRecommended,
];
```

å‚è€ƒ Prettier çš„å®˜æ–¹[é…ç½®æ–‡æ¡£](https://prettier.io/docs/options.html)ï¼Œæ‚¨å¯ä»¥è‡ªç”±åœ°é…ç½®é¡¹ç›®ä»£ç çš„é£æ ¼ã€‚åœ¨é¡¹ç›®ç›®å½•åˆ›å»º `.prettierrc.json` æ–‡ä»¶ï¼Œæ·»åŠ é£æ ¼é…ç½®é¡¹å¦‚ï¼š

```json
{
  // æ³¨é‡Šåªæ˜¯ä¾¿äºç†è§£ï¼Œæ‚¨åº”å½“åˆ é™¤ JSON æ–‡ä»¶é‡Œçš„æ³¨é‡Š
  &quot;semi&quot;: false, // å¥æœ«æ˜¯å¦æ·»åŠ åˆ†å·
  &quot;singleQuote&quot;: true // æ˜¯å¦ä½¿ç”¨å•å¼•å·ï¼ˆè€ŒéåŒå¼•å·ï¼‰
}
```

å½“ç„¶ï¼Œç¬”è€…é€šå¸¸ä¿æŒ Prettier çš„é»˜è®¤é£æ ¼ï¼Œä¸å•ç‹¬å¼•å…¥é…ç½®æ–‡ä»¶ã€‚

## ç°åœ¨å°±æ ¼å¼åŒ–ä»£ç å§

ä¿®æ”¹ `package.json` æ–‡ä»¶ï¼Œæ·»åŠ è„šæœ¬ï¼š

```json
// package.json
{
  &quot;scripts&quot;: {
    &quot;lint&quot;: &quot;eslint .&quot;
  }
}
```

æ ¹æ®ä¸Šé¢çš„é…ç½®ï¼Œå¯ä»¥åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹è„šæœ¬ï¼š

```bash
# æ£€æŸ¥ä»£ç è´¨é‡é—®é¢˜
yarn lint

# æ£€æŸ¥å¹¶ä¿®å¤ä»£ç è´¨é‡é—®é¢˜
yarn lint --fix
```

ç”±äºæˆ‘ä»¬å°† Prettier ä½œä¸ºäº† ESLint çš„æ’ä»¶è¿è¡Œï¼Œæ‰€ä»¥æ— éœ€æ‰‹åŠ¨æ‰§è¡Œ Prettier çš„æ ¼å¼åŒ–å‘½ä»¤äº†ã€‚

åœ¨ VSCode é‡Œï¼Œä¹Ÿåº”å½“å°† ESLint ä½œä¸ºé»˜è®¤çš„æ ¼å¼åŒ–å·¥å…·ã€‚å¦‚æœæ­£ç¡®åœ°å®‰è£…å¹¶å¯ç”¨äº† VSCode çš„ ESLint æ‹“å±•ï¼Œç¼–è¾‘å™¨å°±èƒ½æ­£ç¡®çš„é«˜äº® ESLint ä¸ Prettier æ£€æŸ¥å‡ºæ¥çš„é—®é¢˜äº†ã€‚

æ­¤å¤–ï¼ŒVSCode è¿˜å¯ä»¥è®¾ç½®**ä¿å­˜æ—¶è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜**ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚è¿™æ ·æ‰§è¡Œ `Ctrl + S` ä¿å­˜æ—¶ä¼šè‡ªåŠ¨æ ¼å¼åŒ–ä»£ç æ–‡ä»¶ã€‚

```json
// settings.json
&quot;editor.codeActionsOnSave&quot;: {
  &quot;source.fixAll.eslint&quot;: true
},
```

## å‚è€ƒèµ„æ–™

- [What&apos;s the difference between prettier-eslint, eslint-plugin-prettier and eslint-config-prettier?](https://stackoverflow.com/questions/44690308/whats-the-difference-between-prettier-eslint-eslint-plugin-prettier-and-eslint) - stackoverflow
- [Error: &apos;basePath&apos; should be an absolute path](https://github.com/prettier/prettier-eslint-cli/issues/208#issuecomment-673631308) - mathiaswillburger - 2020.08.14
- [ææ‡‚ ESLint å’Œ Prettier](https://zhuanlan.zhihu.com/p/80574300) - ä¹ƒä¹ - 2019.08.31
- [ESLint+Prettier ä»£ç è§„èŒƒå®è·µ](https://www.jianshu.com/p/dd07cca0a48e) - Bernie ç»´ - 2019.06.04
</content:original-text><content:updated-at>2025-04-11T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[Webpack è¯»å–æœ¬åœ° Markdown æ–‡ä»¶å¹¶è¿›è¡Œé¢„å¤„ç†]]></title><description><![CDATA[åœ¨å¼€å‘ NetUnion çš„å®˜ç½‘é¡µé¢æ—¶ï¼Œæœ‰è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼šè¯»å–æœ¬åœ°ç›®å½•ä¸‹çš„æ–°é—»å’Œåšå®¢æ–‡ä»¶ï¼Œå¹¶åœ¨å‰ç«¯æ¸²æŸ“ï¼Œå…¶ä¸­æ–‡ä»¶å‡ä¸º Markdown æ ¼å¼ã€‚ ä¸å…¨æ ˆå¼€å‘ç›´æ¥è°ƒç”¨åç«¯æ•°æ®åº“ä¸åŒçš„æ˜¯ï¼Œæ²¡æœ‰æ•°æ®è¡¨å­—æ®µæ¥è®°å½•æ–‡ä»¶çš„ä¸åŒå±æ€§ï¼Œä¾‹å¦‚æ–‡ä»¶çš„é¢˜ç›®ã€ä½œè€…ã€æ’°å†™æ—¥æœŸç­‰ï¼Œå› æ­¤è¿™äº›å±æ€§éœ€è¦è®°å½•åœ¨ .md æ–‡ä»¶å½“ä¸­ã€‚

è¿™æ ·çš„æ’°å†™æ–¹å¼æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿæ²¡é”™ï¼Œä¸å°±æ˜¯æˆ‘æ­£åœ¨å†™çš„ Hexo åšå®¢ä¸­ .md æ–‡ä»¶çš„ç¼–å†™æ ¼å¼å˜›ï¼

è‡ªåŠ¨å¯¼å…¥â€¦]]></description><link>https://blog.towind.fun/posts/write-md-parser</link><guid isPermaLink="false">write-md-parser</guid><category><![CDATA[å‰ç«¯å¼€å‘]]></category><pubDate>Tue, 23 Feb 2021 00:00:00 GMT</pubDate><content:original-text>
åœ¨å¼€å‘ NetUnion çš„å®˜ç½‘é¡µé¢æ—¶ï¼Œæœ‰è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼šè¯»å–æœ¬åœ°ç›®å½•ä¸‹çš„æ–°é—»å’Œåšå®¢æ–‡ä»¶ï¼Œå¹¶åœ¨å‰ç«¯æ¸²æŸ“ï¼Œå…¶ä¸­æ–‡ä»¶å‡ä¸º Markdown æ ¼å¼ã€‚

ä¸å…¨æ ˆå¼€å‘ç›´æ¥è°ƒç”¨åç«¯æ•°æ®åº“ä¸åŒçš„æ˜¯ï¼Œæ²¡æœ‰æ•°æ®è¡¨å­—æ®µæ¥è®°å½•æ–‡ä»¶çš„ä¸åŒå±æ€§ï¼Œä¾‹å¦‚æ–‡ä»¶çš„é¢˜ç›®ã€ä½œè€…ã€æ’°å†™æ—¥æœŸç­‰ï¼Œå› æ­¤è¿™äº›å±æ€§éœ€è¦è®°å½•åœ¨ .md æ–‡ä»¶å½“ä¸­ã€‚

è¿™æ ·çš„æ’°å†™æ–¹å¼æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿæ²¡é”™ï¼Œä¸å°±æ˜¯æˆ‘æ­£åœ¨å†™çš„ Hexo åšå®¢ä¸­ .md æ–‡ä»¶çš„ç¼–å†™æ ¼å¼å˜›ï¼

## è‡ªåŠ¨å¯¼å…¥æœ¬åœ°çš„ .md æ–‡ä»¶

å½“ç„¶ï¼Œé¦–å…ˆè¦è¯»å–æŸä¸ªç›®å½•ä¸‹å·²ç»æ’°å†™å¥½çš„ .md æ–‡ä»¶ï¼Œæ‰èƒ½å¯¹å†…å®¹è¿›è¡Œé¢„å¤„ç†ã€‚

ä½†å¦‚æœæ¯æ’°å†™å¥½ä¸€ä¸ªæ–°çš„æ–°é—»æˆ–åšå®¢æ–‡ä»¶ï¼Œå°±å¾—åœ¨ä»£ç ä¸­ `require` å‡ºæ¥ï¼Œå¤ªè¿‡äºéº»çƒ¦ä¸”ä¸ç°å®ï¼Œå› æ­¤å°±éœ€è¦**è‡ªåŠ¨å¯¼å…¥**çš„æ–¹æ³•ã€‚

Webpack æä¾›äº† `require.context()` æ–¹æ³•å¯ä»¥å®Œç¾è§£å†³å¯¼å…¥ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„é—®é¢˜ï¼Œè¯¥æ–¹æ³•å¯ä»¥å¯¼å…¥æŒ‡å®šç›®å½•ï¼ˆä¹Ÿå¯ä»¥åŒ…æ‹¬å­ç›®å½•ï¼‰ä¸‹æŒ‡å®šæ ¼å¼çš„æ‰€æœ‰æ–‡ä»¶ã€‚å…³äºæ­¤æ–¹æ³•çš„æ›´å¤šç»†èŠ‚å¯ä»¥åœ¨ Webpack å®˜æ–¹æ–‡æ¡£ä¸­[äº†è§£](https://webpack.js.org/guides/dependency-management/#requirecontext)ã€‚

æ’°å†™ä»£ç è‡ªåŠ¨è¯»å– `@/docs/blog/` åŠå…¶å­ç›®å½•ä¸‹çš„æ‰€æœ‰ .md æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­ `blogFiles(key)` ä¸ºæ–‡ä»¶å­˜å‚¨çš„å…·ä½“å†…å®¹ï¼š

```js
const blogFiles = require.context(&quot;@/docs/blog/&quot;, true, /\.md$/);
blogFiles.keys().forEach((key) =&gt; {
  console.log(blogFiles(key));
});
```

## å¯¹ .md æ–‡ä»¶è¿›è¡Œé¢„å¤„ç†

å‚è€ƒ Hexo åšå®¢çš„æ’°å†™æ ¼å¼ï¼Œå¯ä»¥è§„å®š NetUnion å®˜ç½‘çš„æ–°é—»å’Œåšå®¢æ’°å†™æ ¼å¼å¦‚ä¸‹ï¼š

```md
---
title: ${title}
date: ${date}
author: ${author}
---

${main-text}
```

å³ç”¨ä¸¤ä¸ª `---` æ¡†ä½**å±æ€§å†…å®¹**ï¼Œåœ¨ç¬¬äºŒä¸ª `---` ä¸‹é¢ä¸º**æ­£æ–‡å†…å®¹**ã€‚

é‚£ä¹ˆé¦–å…ˆï¼Œå¯ä»¥ç”¨ `split()` æ–¹æ³•æ ¹æ® `---` åŠæ¢è¡Œç¬¦å°†æ–‡ç« åˆ’åˆ†ä¸ºé•¿åº¦ä¸å°‘äº 3 ï¼ˆå› ä¸ºåœ¨æ­£æ–‡ä¸­å¯èƒ½å‡ºç° `---`ï¼‰çš„æ•°ç»„ arrã€‚å…¶ä¸­ arr[0] ä¸ºç©ºï¼Œarr[1] å­˜å‚¨æœ‰å±æ€§å†…å®¹ï¼Œarr[2] åŠä¹‹åå­˜å‚¨æ­£æ–‡å†…å®¹ã€‚

```js
// content ä¸ºä¼ å…¥çš„ .md æ–‡ä»¶å†…å®¹
const contentArray = content.split(/---+\r?\n/g);
```

å¯¹å±æ€§å†…å®¹çš„å¤„ç†åŒæ ·å¯ä»¥å…ˆä½¿ç”¨ `split()` æ–¹æ³•æŒ‰æ¢è¡Œç¬¦æ‹†åˆ†ä¸ºæ•°ç»„ã€‚

```js
const contentInfo = contentArray[1];
const contentInfoArray = contentInfo.split(/\r?\n/g);
```

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨ä¸Šé¢ä¸¤æ¬¡æŒ‰æ¢è¡Œç¬¦åˆ†å‰²æ—¶ï¼Œæˆ‘éƒ½ä½¿ç”¨äº† `/\r?\n/g` æ­£åˆ™è¡¨è¾¾å¼ã€‚å…¶å«ä¹‰æ˜¯åŒ¹é… 0 ä¸ªæˆ– 1 ä¸ª `\r` åŠ 1 ä¸ª `\n`ï¼Œç›´åˆ°ç»“æŸã€‚å› ä¸ºåœ¨ `CRLF` è¡Œå°¾åºåˆ—çš„æ–‡ä»¶ä¸­ï¼Œæ¢è¡Œç¬¦ç”± `\r\n` è¡¨ç¤ºï¼›è€Œåœ¨ `LF` è¡Œå°¾åºåˆ—ä¸­ï¼Œæ¢è¡Œç¬¦ç”± `\n` è¡¨ç¤ºã€‚è¿™æ ·å°±ç¡®ä¿äº†åœ¨ Windows å’Œ Unix ä¸¤ç§ä¸åŒçš„ç³»ç»Ÿä¸Šæ’°å†™çš„æ–‡ä»¶ï¼Œå…¶è§£æä¸ä¼šå—è¡Œå°¾åºåˆ—æ‰€å½±å“ã€‚

æ¥ä¸‹æ¥å°±å¯ä»¥æå–å±æ€§å¯¹è±¡äº†ã€‚è¿™é‡Œä½¿ç”¨ `trim()` æ–¹æ³•æ¥åˆ é™¤å±æ€§åå’Œå±æ€§å€¼å‰åå¯èƒ½å‡ºç°çš„å¤šä½™ç©ºæ ¼ã€‚

```js
const contentInfoItem = {};
for (let i = 0; i &lt; contentInfoArray.length - 1; i++) {
  const contentInfoParamArray = contentInfoArray[i].split(&quot;:&quot;);
  let contentInfoParamValue = &quot;&quot;;
  for (let n = 1; n &lt; contentInfoParamArray.length; n++) {
    contentInfoParamValue += contentInfoParamArray[n] + &quot;:&quot;;
  }
  contentInfoItem[contentInfoParamArray[0].trim()] = contentInfoParamValue
    .slice(0, -1)
    .trim();
}
```

å¯¹æ­£æ–‡å†…å®¹çš„å¤„ç†å°±ç›¸å½“ç®€å•äº†ï¼Œåªéœ€è¦æŠŠ arr[2] åŠä¹‹åå­˜å‚¨çš„å†…å®¹ç”¨ `---\n` è¿æ¥èµ·æ¥å°±å¯ä»¥äº†ã€‚

```js
let contentText = contentArray[2];
if (contentArray.length &gt; 3) {
  for (let i = 3; i &lt; contentArray.length; i++) {
    contentText += &quot;---\n&quot;;
    contentText += contentArray[i];
  }
}
```

å°†å±æ€§å¯¹è±¡ä¸æ­£æ–‡å†…å®¹åˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè§£æå°±å®Œæˆäº†ï¼

```js
const result = {
  ...contentInfoItem,
  content: contentText,
};
```

å¦‚æœæ„¿æ„ï¼Œè¿˜å¯ä»¥åœ¨æœ€åå¯¹æ ¼å¼è¿›è¡Œä¸€å®šè§„èŒƒï¼Œä¾‹å¦‚å¯ä»¥å¯¹ date å±æ€§è¿›è¡Œå¤„ç†ï¼š

```js
// æ ¼å¼ä¸º YYYY-MM-DD
if (result.date != null) {
  const dateArray = result.date.split(&quot;-&quot;);
  const dateYear = dateArray[0];
  let dateMonth = dateArray[1];
  let dateDay = dateArray[2];
  if (dateMonth.length == 1) {
    dateMonth = &quot;0&quot; + dateMonth;
  }
  if (dateDay.length == 1) {
    dateDay = &quot;0&quot; + dateDay;
  }
  result.date = dateYear + &quot;-&quot; + dateMonth + &quot;-&quot; + dateDay;
}
```

## è§£æ .md ä¸º HTML

å°†ç»“æœä¸­çš„æ­£æ–‡å†…å®¹äº¤ç»™ç»™ä»»æ„ .md è§£æå™¨å°±å¯ä»¥äº†ï¼Œä¾‹å¦‚ [markdown-it](https://github.com/markdown-it/markdown-it)ã€‚

```js
const md = require(&quot;markdown-it&quot;)({
  linkify: false, // ä¸€äº›è®¾ç½®ï¼Œå¹¶ä¸é‡è¦ï¼Œä¸‹åŒ
  breaks: false,
  typographer: true,
});
const htmlContent = md.render(result.content);
```

å®Œæ•´çš„è§£ææ–‡ä»¶[åœ¨è¿™é‡Œ](https://github.com/uestclug/nu-official/blob/frontend/src/utils/mdParser.js)ã€‚
</content:original-text><content:updated-at>2021-06-26T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[ä¸€é”®å®‰è£…å¹¶é…ç½® MTProto Proxy ä»£ç† Telegram]]></title><description><![CDATA[Telegram å’Œ MTProto æ˜¯ä»€ä¹ˆ Telegramï¼Œä¸­æ–‡åç§°ä¸ºâ€œç”µæŠ¥â€ï¼Œæˆ–ç®€ç§°â€œtgâ€ï¼Œæ˜¯ä¸€æ¬¾è·¨å¹³å°å³æ—¶é€šè®¯è½¯ä»¶ï¼Œå®¢æˆ·ç«¯å®Œå…¨å¼€æºã€‚æˆ‘è§‰å¾—é‡è¦çš„æœ‰å¦‚ä¸‹ Featuresï¼š

ç§å¯†æ€§é«˜ã€‚ä¸å†ä½¿ç”¨çš„è´¦å·æœ€é•¿ä¿ç•™å¹´é™ä¸º 1 å¹´ï¼Œéšæ—¶é”€æ¯èŠå¤©è®°å½•å’Œä¸€åˆ‡è´¦å·èµ„æ–™ã€‚ å®‰å…¨æ€§ã€‚ç«¯å¯¹ç«¯åŠ å¯†ï¼Œä¸å—å®¡æŸ¥ã€‚ å®Œå…¨å…è´¹ã€‚ä¸é™åˆ¶ä¸Šä¼ æ–‡ä»¶ï¼ˆè§†é¢‘ä¼šæœ‰å‹ç¼©ï¼‰ï¼Œç”šè‡³å¯ä»¥æ‹¿æ¥å½“å¤‡ç”¨ç½‘ç›˜ä½¿ç”¨ã€‚ä¸è¿‡å·²ç»ç¡®è®¤ä¼šåœ¨å°†æ¥å¸ƒå±€ç¾¤ç»„å¹¿å‘Šâ€¦]]></description><link>https://blog.towind.fun/posts/tg-mtproto-one-click</link><guid isPermaLink="false">tg-mtproto-one-click</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Sun, 21 Feb 2021 00:00:00 GMT</pubDate><content:original-text>
## Telegram å’Œ MTProto æ˜¯ä»€ä¹ˆ

Telegramï¼Œä¸­æ–‡åç§°ä¸ºâ€œç”µæŠ¥â€ï¼Œæˆ–ç®€ç§°â€œtgâ€ï¼Œæ˜¯ä¸€æ¬¾è·¨å¹³å°å³æ—¶é€šè®¯è½¯ä»¶ï¼Œå®¢æˆ·ç«¯å®Œå…¨å¼€æºã€‚æˆ‘è§‰å¾—é‡è¦çš„æœ‰å¦‚ä¸‹ Featuresï¼š

- ç§å¯†æ€§é«˜ã€‚ä¸å†ä½¿ç”¨çš„è´¦å·æœ€é•¿ä¿ç•™å¹´é™ä¸º 1 å¹´ï¼Œéšæ—¶é”€æ¯èŠå¤©è®°å½•å’Œä¸€åˆ‡è´¦å·èµ„æ–™ã€‚
- å®‰å…¨æ€§ã€‚ç«¯å¯¹ç«¯åŠ å¯†ï¼Œä¸å—å®¡æŸ¥ã€‚
- å®Œå…¨å…è´¹ã€‚ä¸é™åˆ¶ä¸Šä¼ æ–‡ä»¶ï¼ˆè§†é¢‘ä¼šæœ‰å‹ç¼©ï¼‰ï¼Œç”šè‡³å¯ä»¥æ‹¿æ¥å½“å¤‡ç”¨ç½‘ç›˜ä½¿ç”¨ã€‚ä¸è¿‡å·²ç»ç¡®è®¤ä¼šåœ¨å°†æ¥å¸ƒå±€ç¾¤ç»„å¹¿å‘Šï¼Œâ€œé’èƒ½åŠ›â€è¿˜æ˜¯æŠµä¸è¿‡è¶Šæ¥è¶Šå¤šæ¶Œå…¥çš„å„å›½ç”¨æˆ·ã€‚

å½“ç„¶ï¼Œåœ¨è¢«å±è”½çš„åœ°åŸŸéœ€è¦ç¿»å¢™ä½¿ç”¨ã€‚

MTProto æ˜¯ä¸€ç§åè®®ï¼Œæ—¨åœ¨å¸®åŠ©ç§»åŠ¨è®¾å¤‡ä¸Šçš„åº”ç”¨ç¨‹åºè®¿é—®æœåŠ¡å™¨çš„ Api æ¥å£ã€‚

## æˆ‘ä»¬è¦åšä»€ä¹ˆ

æˆ‘ä»¬æƒ³è¦æ­å»ºä¸€ä¸ª Proxyï¼Œæä¾›ç»™ç§»åŠ¨ç«¯ä½¿ç”¨ï¼Œå¯ä»¥å¿«æ·åœ°è®¿é—®åˆ° tg æœåŠ¡å™¨ã€‚

ç§»åŠ¨ç«¯ä¸ç”µè„‘ç«¯ä¸åŒçš„æ˜¯ï¼Œç”µè„‘ç«¯é€šå¸¸ä»£ç†è½¯ä»¶å¸¸å¼€ï¼Œéšæ—¶å¯ä»¥é€šè¿‡ web è®¿é—®åˆ° tg æœåŠ¡å™¨ï¼Œè€Œç§»åŠ¨ç«¯åˆ™ä¸ºäº†çœç”µéœ€è¦ï¼Œä»…åœ¨ä½¿ç”¨æ—¶æ‰æ‰‹åŠ¨å¯ç”¨ä»£ç†ï¼Œç¨æ˜¾éº»çƒ¦ã€‚

å®é™…ä¸Šç”µè„‘ç«¯çš„ tg å®¢æˆ·ç«¯ä¹Ÿéœ€è¦æ‰‹åŠ¨è®¾ç½®ä»£ç†å…¨å±€æ‰èƒ½è®¿é—®ï¼Œé‚£ä¹ˆæœ‰ä¸€ä¸ª Proxy å¯ä»¥çœå¾ˆå¤šäº‹å„¿ã€‚

## å—¨ï¼Œè¿™é‡Œæ˜¯ä¸€é”®è„šæœ¬

åœ¨ Github ä¸Šæœ‰ä¸ºå®ç°ä»¥ä¸ŠåŠŸèƒ½ç¼–å†™çš„åŸºäº Python çš„ Proxy: [mtprotoproxy](https://github.com/alexbers/mtprotoproxy)ã€‚å·ç§°ï¼š

&gt; The proxy performance should be enough to comfortably serve about 4000 simultaneous users on the VDS instance with 1 CPU core and 1024MB RAM.
&gt; ä»£ç†æœåŠ¡å™¨çš„æ€§èƒ½åº”è¯¥è¶³ä»¥åœ¨ä½¿ç”¨ 1 ä¸ª CPU æ ¸å¿ƒå’Œ 1024 MB å†…å­˜çš„ VDS å®ä¾‹ä¸ŠåŒæ—¶ä¸ºå¤§çº¦ 4000 ä¸ªç”¨æˆ·æä¾›èˆ’é€‚çš„æœåŠ¡ã€‚

å½“ç„¶ä¹Ÿæœ‰ç”¨å…¶å®ƒè¯­è¨€å†™çš„ Proxyï¼Œä¸è¿‡æœ€å¦™çš„è¿˜å±ä¸€é”®å®‰è£…é…ç½®è„šæœ¬ï¼š[MTProtoProxyInstaller](https://github.com/HirbodBehnam/MTProtoProxyInstaller)ã€‚ä¸ç”¨è„‘å­ï¼

é‚£ä¹ˆï¼ŒæŒ‰ç…§ä½œè€…ç»™å‡ºçš„æŒ‡å¼•èµ°å°±å¯ä»¥äº†ã€‚

### è´­ä¹°ä¸€å°è‡ªç”±è®¿é—® tg çš„æœåŠ¡å™¨

é˜¿é‡Œäº‘å’Œè…¾è®¯äº‘æä¾›çš„è½»é‡çº§åº”ç”¨æœåŠ¡å™¨å°±å¾ˆä¸é”™ï¼é€‰æ‹©é¦™æ¸¯åœ°åŒºå³å¯ï¼Œæ¯æœˆæœ‰ 1 TB çš„æµé‡ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤ä¸€é”®è„šæœ¬ä»…æ”¯æŒå¦‚ä¸‹ Linux ç³»ç»Ÿï¼š

- Centos 7/8
- Ubuntu 16 æˆ–æ›´æ–°ç‰ˆæœ¬
- Debian 8/9

### é€‰æ‹©ä»£ç†ç‰ˆæœ¬

é¦–å…ˆæ˜ç¡®è‡ªå·±è¦ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„ä»£ç†ï¼Œå®˜æ–¹çš„ï¼ŒåŸºäº Python è¯­è¨€çš„ï¼Œäº¦æˆ–æ˜¯åŸºäº Go è¯­è¨€çš„ã€‚

ä½œè€…å»ºè®®åœ¨å¦‚ä¸‹æƒ…å†µä½¿ç”¨åŸºäº Python è¯­è¨€çš„ä»£ç†ï¼š

- æœåŠ¡å™¨ CPU åªæœ‰ä¸€ä¸ªå†…æ ¸ï¼Œæˆ–è€…åªæƒ³åœ¨ä¸€ä¸ªå†…æ ¸ä¸Šè¿è¡Œä»£ç†ã€‚
- æœåŠ¡å™¨æ¯”è¾ƒä½ç«¯ã€‚
- ä¸ºä¸€å°ç¾¤äººæä¾›æœåŠ¡ï¼Œæ¯”å¦‚å®¶åº­æˆ–å°å…¬å¸ã€‚
- æƒ³è¦é™åˆ¶ç”¨æˆ·çš„è¿æ¥ã€‚
- è¿˜å°†åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œå…¶å®ƒåº”ç”¨ç¨‹åºæˆ–æœåŠ¡ï¼Œä¾‹å¦‚ OpenVPNï¼ŒShadowsocksï¼ŒNginx ç­‰ã€‚

å¦åˆ™ä½¿ç”¨å®˜æ–¹ä»£ç†ã€‚

è¿™é‡Œæˆ‘é€‰æ‹©ä½¿ç”¨**åŸºäº Python è¯­è¨€**çš„ä»£ç†ï¼Œæ•…ä¸‹æ–‡å°†åŸºäºæ­¤ç‰ˆæœ¬é˜è¿°ï¼Œè‹¥æƒ³ä½¿ç”¨å…¶å®ƒç‰ˆæœ¬å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ä½œè€…çš„[æ•™ç¨‹æ–‡æ¡£](https://github.com/HirbodBehnam/MTProtoProxyInstaller#official-script)ã€‚

### éƒ¨ç½²ä¸€é”®è„šæœ¬

æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…ï¼š

```bash
curl -o MTProtoProxyInstall.sh -L https://git.io/fjo34 &amp;&amp; bash MTProtoProxyInstall.sh
```

æ ¹æ®æç¤ºè¿›è¡Œé…ç½®ï¼Œè§‰å¾—ä¸å¦¥è¿˜å¯ä»¥é‡æ–°æ‰§è¡Œä¸Šè¿°å‘½ä»¤é‡è£…ä»£ç†æœåŠ¡ã€‚

å‡å¦‚åªæ·»åŠ äº†ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œåœ¨å®‰è£…å®Œæˆåä¼šå‡ºç°å¦‚ä¸‹æ–‡æœ¬ï¼š

```text
Ok it must be done. I created a service to run or stop the proxy.
Use &quot;systemctl start mtprotoproxy&quot; or &quot;systemctl stop mtprotoproxy&quot; to start or stop it

Use these links to connect to your proxy:
${username}: tg://proxy?server=${ip}&amp;port=${port}&amp;secret=${secret}
```

å…¶ä¸­ \$\{username\} ä¸ºä¹‹å‰è¾“å…¥çš„ç”¨æˆ·åï¼ˆå¹¶ä¸é‡è¦ï¼Œåªæ˜¯æ ‡è¯†ï¼‰ï¼Œ\$\{ip\} æ˜¯æœåŠ¡å™¨çš„å…¬ç½‘ IP æˆ–åŸŸåï¼Œ\$\{port\} æ˜¯è®¾ç½®çš„è®¿é—®ä»£ç†çš„ç«¯å£ï¼Œ\$\{secret\} æ˜¯è®¾ç½®æˆ–è‡ªåŠ¨ç”Ÿæˆçš„å¯†é’¥ã€‚

è¿™é‡Œä½œè€…æç¤ºå¯ä»¥ç”¨ `systemctl start mtprotoproxy` æ¥å¯åŠ¨ä»£ç†æœåŠ¡äº†ï¼Œä½œä¸ºè¡¥å……ï¼Œ`systemctl` æ˜¯ `Systemd` è¿›ç¨‹ç®¡ç†å‘½ä»¤ï¼Œè€Œ `Systemd` æ˜¯ä¸€ç§ Linux çš„ç³»ç»Ÿå·¥å…·ï¼Œç”¨æ¥å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼ˆå³ä¸€ç›´åœ¨åå°è¿è¡Œçš„è¿›ç¨‹ï¼Œdaemonï¼‰ã€‚è¿™è¯´æ˜å½“å‰ `mtprotoproxy` å·²ç»æ˜¯å¯ä»¥å¯åŠ¨çš„æœåŠ¡äº†ï¼Œåœ¨åç»­çš„è¿‡ç¨‹ä¸­åªéœ€è¦å¯¹æ­¤æœåŠ¡è¿›è¡Œç®¡ç†å°±å¯ä»¥äº†ã€‚

é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ‰§è¡Œè¯¥å‘½ä»¤æ¥å¯åŠ¨æœåŠ¡ï¼š

```bash
systemctl start mtprotoproxy # å¯åŠ¨ä»£ç†æœåŠ¡
```

å¤åˆ¶ä¹‹å‰çš„é“¾æ¥ `tg://proxy?server=${ip}&amp;port=${port}&amp;secret=${secret}` åˆ°å‰ªåˆ‡æ¿ï¼Œåœ¨æ‰‹æœºç«¯çš„ Telegram ä¸Šé€šè¿‡ `è®¾ç½® - æ•°æ®å’Œå­˜å‚¨ - ä»£ç†è®¾ç½® - æ·»åŠ ä»£ç† - ä»å‰ªè´´æ¿å¯¼å…¥` å³å¯å®Œæˆè®¾ç½®ã€‚å»ºè®®æŠŠè¿™ä¸ªé“¾æ¥è®°ä¸‹æ¥å¹¶ä¿å­˜ã€‚

### Opsï¼Œä¸€ç‚¹å°éº»çƒ¦

å‘ƒï¼Œä¼¼ä¹è¿æ¥äº†åŠå¤©ä¹Ÿ ping ä¸é€šï¼Œè¿™å¯å¦‚ä½•æ˜¯å¥½ï¼Œå“ªä¸€æ­¥åšé”™äº†å—ï¼Ÿ

å¯ä»¥å…ˆæŸ¥é˜…ä¸€ä¸‹æ—¥å¿—ä¿¡æ¯ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š

```bash
systemctl status mtprotoproxy -l # æŸ¥çœ‹ä»£ç†æœåŠ¡æ—¥å¿—ä¿¡æ¯
```

æŸ¥è¯¢åˆ°å¦‚ä¸‹ç»“æœï¼š

```text
â— mtprotoproxy.service - MTProto Proxy Service
     Loaded: loaded (/etc/systemd/system/mtprotoproxy.service; enabled; vendor preset: enabled)
     Active: active (running) since Sun 2021-02-21 15:12:39 CST; 43s ago
   Main PID: 39895 (python3.8)
      Tasks: 5 (limit: 1111)
     Memory: 23.7M
     CGroup: /system.slice/mtprotoproxy.service
             â””â”€39895 /usr/bin/python3.8 /opt/mtprotoproxy/mtprotoproxy.py

Feb 21 15:13:18 ******** python3.8[39895]: Unable to connect to ****:***:****:****::a *
Feb 21 15:13:18 ******** python3.8[39895]: Unable to connect to ****:***:****:****::a *
Feb 21 15:13:19 ******** python3.8[39895]: Unable to connect to ****:***:****:****::a *
Feb 21 15:13:19 ******** python3.8[39895]: Unable to connect to ****:***:****:****::a *
Feb 21 15:13:19 ******** python3.8[39895]: Unable to connect to ****:***:****:****::a *
Feb 21 15:13:19 ******** python3.8[39895]: Unable to connect to ****:***:****:****::a *
Feb 21 15:13:20 ******** python3.8[39895]: Unable to connect to ****:***:****:****::a *
Feb 21 15:13:20 ******** python3.8[39895]: Unable to connect to ****:***:****:****::a *
Feb 21 15:13:23 ******** python3.8[39895]: Unable to connect to ****:***:****:****::a *
Feb 21 15:13:23 ******** python3.8[39895]: Unable to connect to ****:***:****:****::a *
```

å¹¸è¿çš„æ˜¯ï¼Œåœ¨è¯¥ä»“åº“ä¸‹çš„ Issues é‡Œæˆ‘æ‰¾åˆ°äº†é‡è§ç›¸åŒé—®é¢˜çš„äººï¼ˆ[#34](https://github.com/HirbodBehnam/MTProtoProxyInstaller/issues/34)ï¼‰ã€‚

åŸæ¥åœ¨æœ€æ–°ç‰ˆæœ¬çš„ Python ä»£ç†è½¯ä»¶ä¸­ï¼Œé»˜è®¤ä½¿ç”¨ IPv6ï¼Œè¿›è€Œå¯¼è‡´ MTProto æ— æ³•æ­£å¸¸è¿æ¥ã€‚ä½œè€…æå‡ºå¯ä»¥åœ¨è®¾ç½®æ–‡ä»¶ä¸­æ‰‹åŠ¨è®¾ç½®ç¦ç”¨ä¼˜å…ˆ IPv6 è¿æ¥ã€‚æ“ä½œå¦‚ä¸‹ï¼š

```bash
cd /opt/mtprotoproxy # é»˜è®¤å®‰è£…ç›®å½•
vi config.py # ç¼–è¾‘é…ç½®æ–‡ä»¶
```

åœ¨æ–‡ä»¶ä¸­æ·»åŠ ä¸€è¡Œé…ç½®ä¿¡æ¯ `PREFER_IPV6 = False` å³å¯ã€‚

ç”±äºæœåŠ¡æ²¡æœ‰çƒ­é‡è½½æœºåˆ¶ï¼Œå› æ­¤åœ¨æœ€åéœ€è¦é‡å¯æœåŠ¡ï¼š

```bash
systemctl restart mtprotoproxy # é‡å¯ä»£ç†æœåŠ¡
```

### ä¸€åˆ‡æå®š

ç°åœ¨å·²ç»å¯ä»¥æ­£å¸¸è®¿é—® tg å®¢æˆ·ç«¯å•¦ï¼å‡å¦‚æ„¿æ„ï¼Œå¯ä»¥å°†åˆšåˆšå¾—åˆ°çš„é“¾æ¥åˆ†äº«ç»™å¥½å‹ï¼Œenjoy tg world!

æˆ–è®¸ä½ ä¼šæ„¿æ„å†æ¬¡æ‰“å°ä¸€ä¸‹æ—¥å¿—ä¿¡æ¯ï¼Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```text
â— mtprotoproxy.service - MTProto Proxy Service
     Loaded: loaded (/etc/systemd/system/mtprotoproxy.service; enabled; vendor preset: enabled)
     Active: active (running) since Sun 2021-02-21 15:17:25 CST; 4s ago
   Main PID: 39940 (python3.8)
      Tasks: 5 (limit: 1111)
     Memory: 17.8M
     CGroup: /system.slice/mtprotoproxy.service
             â””â”€39940 /usr/bin/python3.8 /opt/mtprotoproxy/mtprotoproxy.py

Feb 21 15:17:25 ******** systemd[1]: Started MTProto Proxy Service.
Feb 21 15:17:25 ******** python3.8[39940]: *: tg://proxy?server=*&amp;port=*&amp;secret=*&gt;
Feb 21 15:17:25 ******** python3.8[39940]: *: tg://proxy?server=*&amp;port=*&amp;secret=*&gt;
Feb 21 15:17:25 ******** python3.8[39940]: Found uvloop, using it for optimal performance
Feb 21 15:17:25 ******** python3.8[39940]: Got cert from the MASK_HOST www.cloudflare.com, its length is 1828
```

é™¤äº†å‰æ–‡å·²å‡ºç°è¿‡çš„å‘½ä»¤ï¼Œåˆ«å¿˜äº†æ­¤ä»£ç†æœåŠ¡è¿˜å¯ä»¥æš‚åœï¼Œä¾æ—§æ˜¯ä½œä¸ºæœåŠ¡è¿›è¡Œç®¡ç†å°±å¯ä»¥äº†ï¼š

```bash
systemctl stop mtprotoproxy # æš‚åœä»£ç†æœåŠ¡
```
</content:original-text><content:updated-at>2021-02-23T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[ä½¿ç”¨ Github Actions æŒç»­é›†æˆä¸éƒ¨ç½² Hexo åšå®¢]]></title><description><![CDATA[è¿™æ˜¯æˆ‘æ’°å†™çš„ç¬¬ä¸€ç¯‡ä¸ Github Actions æœ‰å…³çš„åšå®¢ï¼Œé‚£ä¹ˆå°±é¦–å…ˆå¯¹ Github Actions åšä¸€ä¸ªç®€çŸ­çš„ä»‹ç»å§ã€‚ Github Actions æ˜¯ Github äº 2018 å¹´ 10 æœˆæ¨å‡ºçš„æŒç»­é›†æˆæœåŠ¡ï¼ˆCIï¼‰ã€‚

å¤§å®¶çŸ¥é“ï¼ŒæŒç»­é›†æˆç”±å¾ˆå¤šæ“ä½œç»„æˆï¼Œæ¯”å¦‚æŠ“å–ä»£ç ã€è¿è¡Œæµ‹è¯•ã€ç™»å½•è¿œç¨‹æœåŠ¡å™¨ï¼Œå‘å¸ƒåˆ°ç¬¬ä¸‰æ–¹æœåŠ¡ç­‰ç­‰ã€‚GitHub æŠŠè¿™äº›æ“ä½œå°±ç§°ä¸º actionsâ€¦]]></description><link>https://blog.towind.fun/posts/hexo-github-actions-ci-cd</link><guid isPermaLink="false">hexo-github-actions-ci-cd</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Fri, 19 Feb 2021 00:00:00 GMT</pubDate><content:original-text>
è¿™æ˜¯æˆ‘æ’°å†™çš„ç¬¬ä¸€ç¯‡ä¸ Github Actions æœ‰å…³çš„åšå®¢ï¼Œé‚£ä¹ˆå°±é¦–å…ˆå¯¹ Github Actions åšä¸€ä¸ªç®€çŸ­çš„ä»‹ç»å§ã€‚

Github Actions æ˜¯ Github äº 2018 å¹´ 10 æœˆæ¨å‡ºçš„æŒç»­é›†æˆæœåŠ¡ï¼ˆCIï¼‰ã€‚

&gt; å¤§å®¶çŸ¥é“ï¼ŒæŒç»­é›†æˆç”±å¾ˆå¤šæ“ä½œç»„æˆï¼Œæ¯”å¦‚æŠ“å–ä»£ç ã€è¿è¡Œæµ‹è¯•ã€ç™»å½•è¿œç¨‹æœåŠ¡å™¨ï¼Œå‘å¸ƒåˆ°ç¬¬ä¸‰æ–¹æœåŠ¡ç­‰ç­‰ã€‚GitHub æŠŠè¿™äº›æ“ä½œå°±ç§°ä¸º actionsã€‚
&gt; å¾ˆå¤šæ“ä½œåœ¨ä¸åŒé¡¹ç›®é‡Œé¢æ˜¯ç±»ä¼¼çš„ï¼Œå®Œå…¨å¯ä»¥å…±äº«ã€‚GitHub æ³¨æ„åˆ°äº†è¿™ä¸€ç‚¹ï¼Œæƒ³å‡ºäº†ä¸€ä¸ªå¾ˆå¦™çš„ç‚¹å­ï¼Œå…è®¸å¼€å‘è€…æŠŠæ¯ä¸ªæ“ä½œå†™æˆç‹¬ç«‹çš„è„šæœ¬æ–‡ä»¶ï¼Œå­˜æ”¾åˆ°ä»£ç ä»“åº“ï¼Œä½¿å¾—å…¶ä»–å¼€å‘è€…å¯ä»¥å¼•ç”¨ã€‚
&gt; å¦‚æœä½ éœ€è¦æŸä¸ª actionï¼Œä¸å¿…è‡ªå·±å†™å¤æ‚çš„è„šæœ¬ï¼Œç›´æ¥å¼•ç”¨ä»–äººå†™å¥½çš„ action å³å¯ï¼Œæ•´ä¸ªæŒç»­é›†æˆè¿‡ç¨‹ï¼Œå°±å˜æˆäº†ä¸€ä¸ª actions çš„ç»„åˆã€‚è¿™å°±æ˜¯ GitHub Actions æœ€ç‰¹åˆ«çš„åœ°æ–¹ã€‚
&gt; â€”â€” [GitHub Actions å…¥é—¨æ•™ç¨‹](http://www.ruanyifeng.com/blog/2019/09/getting-started-with-github-actions.html)

ä¸è¿‡åœ¨ Github Actions çš„å‘å±•çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒæ—©å·²ä¸å±€é™äº CI ç­‰åŠŸèƒ½ï¼Œè¿˜å¯ä»¥ç”¨äºå„ç§è‡ªåŠ¨åŒ–æ“ä½œï¼Œä¾‹å¦‚[ç™¾åº¦è´´å§è‡ªåŠ¨ç­¾åˆ°](https://github.com/srcrs/TiebaSignIn)ï¼ˆæ³¨ï¼šå·²å¤±æ•ˆã€‚Github å®˜æ–¹ä¼šå¯¹æ­¤ç±»åˆ©ç”¨æœåŠ¡å™¨å®ç°ç­¾åˆ°åŠŸèƒ½çš„ä»“åº“è¿›è¡Œå°ç¦æ‰“å‡»ï¼Œè¿˜æ˜¯ä¸è¦ä½¿ç”¨äº†å§ï¼‰ç­‰ã€‚

## æŒç»­é›†æˆä¸éƒ¨ç½² Hexo åšå®¢

åœ¨&lt;Link to=&quot;/posts/hello-hexo-world&quot;&gt;æ­å»ºè‡ªå·±çš„ Hexo åšå®¢&lt;/Link&gt;é‚£ç¯‡æ–‡ç« çš„æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ [hexo-deployer-git ä¸€é”®éƒ¨ç½²åˆ°ä»“åº“](https://hexo.io/zh-cn/docs/github-pages#%E7%A7%81%E6%9C%89-Repository)çš„æ–¹å¼ï¼Œå®ç°æ‰‹åŠ¨æ„å»ºä¸ªäººåšå®¢ç½‘é¡µå¹¶é€šè¿‡è„šæœ¬æ¨é€éƒ¨ç½²åˆ°è‡ªå·±çš„ Github Pages.

äº‹å®ä¸Šï¼Œåˆ©ç”¨ Github Actions å°±å†ä¹Ÿä¸ç”¨å¤šæ­¤ä¸€ä¸¾ï¼šæ¯æ¬¡æäº¤ä»£ç åˆ° Github åï¼Œå°±å¯ä»¥è§¦å‘ Github Actions å¹¶è‡ªåŠ¨éƒ¨ç½²æ–°çš„åšå®¢å†…å®¹ã€‚

### æ–‡æ¡£æ˜¯æ‚¨æœ€æœ‰ç”¨çš„å¸®æ‰‹

æ›´ç¡®åˆ‡çš„è¯´ï¼Œè‹±æ–‡æ–‡æ¡£æ˜¯æ‚¨æœ€æœ‰ç”¨çš„å¸®æ‰‹ï¼

åœ¨æ­¤å¤„è®°ä¸€ä¸ªå°æ’æ›²ï¼Œåœ¨æœ¬åšå®¢åˆæ¬¡æ’°å†™çš„æ—¶å€™ï¼Œä¸­æ–‡çš„ Hexo æ–‡æ¡£é¡µé¢ä»åœ¨ä½¿ç”¨ Travis CI å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œè€Œè‹±æ–‡çš„ Hexo æ–‡æ¡£å·²ç»æ›´æ–°åˆ°æ¨èä½¿ç”¨ Github Actions å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²æ“ä½œäº†ã€‚

ä½¿ç”¨ Travis CI å¯¹å…è´¹ç”¨æˆ·æœ‰ 10000 åˆ†é’Ÿæ‰§è¡Œæ—¶é—´çš„é™é¢ï¼Œä¸ºäº†ä»¥åä¸å†è¿ç§»ï¼Œè¿˜æ˜¯ä½¿ç”¨ Github Actions å§ï¼

æ¥ä¸‹æ¥çš„å†…å®¹ä¸»è¦å‚è€ƒäº†[è‹±æ–‡æ–‡æ¡£](https://hexo.io/docs/github-pages)ï¼Œåœ¨æ­¤åŸºç¡€ä¸ŠåŠ ä¸Šäº†è‡ªå·±çš„ä¸€äº›æ“ä½œä¸ç†è§£ã€‚

å‡è®¾æ‚¨å·²ç»åˆ›å»ºäº†ä¸€ä¸ª **username.github.io** ä»“åº“ï¼Œå…¶ä¸­ username æ˜¯æ‚¨åœ¨ Github ä¸Šçš„ç”¨æˆ·åã€‚

### åˆ›å»ºå­˜æ”¾ Hexo æºçš„åˆ†æ”¯

ä¼—æ‰€å‘¨çŸ¥ï¼ŒHexo é¦–å…ˆé€šè¿‡ `Hexo generate` æ–¹æ³•æ„å»ºäº†åšå®¢æ‰€æœ‰çš„ HTML, JS å’Œ CSS æ–‡ä»¶ï¼Œåªéœ€è¦å°†è¿™äº›æ–‡ä»¶ä¸Šä¼ åˆ° **username.github.io** ä»“åº“ï¼Œå¹¶åœ¨ä»“åº“è®¾ç½®ä¸­ä¿®æ”¹ `GitHub Pages` é¡¹çš„ç›¸åº”å†…å®¹ï¼Œå°±å¯ä»¥é€šè¿‡ `username.github.io` è®¿é—®åˆ°æ‚¨çš„åšå®¢äº†ã€‚

å› æ­¤æˆ‘ä»¬å¯ä»¥å•ç‹¬å°†æ„å»ºå‰çš„æ‰€æœ‰æ–‡ä»¶æ”¾ç½®åœ¨ **username.github.io** ä»“åº“ä¸­çš„ä¸€ä¸ªåˆ†æ”¯ä¸Šï¼Œæ¯æ¬¡æ›´æ–°æ­¤åˆ†æ”¯åï¼Œè‡ªåŠ¨é€šè¿‡ Github Actions å°†æ„å»ºå‡ºçš„æ‰€æœ‰æ–‡ä»¶æ¨é€åˆ°å±•ç¤ºçš„åˆ†æ”¯ä¸Šå»ã€‚

è¿™é‡Œï¼Œå‡è®¾æ‚¨å±•ç¤ºçš„åšå®¢æ–‡ä»¶å­˜æ”¾åœ¨ `master` åˆ†æ”¯ï¼Œè€Œ Hexo æºæ–‡ä»¶å­˜æ”¾åœ¨æ–°å»ºçš„ `source` åˆ†æ”¯ã€‚

### ç¼–å†™ Github Actions

å…‹éš†æ­¤ä»“åº“åˆ°æœ¬åœ°ï¼Œåˆ‡æ¢åˆ° `source` åˆ†æ”¯ï¼Œåœ¨æ ¹ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å¤¹ `.github/workflows`ï¼Œåœ¨æ­¤ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å¦‚ `main.yml`. åå­—å¹¶ä¸é‡è¦ã€‚

æ‚¨ä¹Ÿå¯ä»¥åœ¨ Github çš„ä»“åº“é¡µé¢ä¸Šç‚¹å‡» `Actions` å¹¶åˆ›å»ºæ–°çš„å·¥ä½œæµ `main.yml`ã€‚

ç¼–å†™å·¥ä½œæµæ–‡ä»¶ `main.yml` å¦‚ä¸‹æ‰€ç¤ºï¼š

```yml
name: Hexo Blog CI &amp; CD

on:
  push:
    branches:
      - source # å­˜æ”¾ Hexo æºæ–‡ä»¶çš„åˆ†æ”¯

jobs:
  pages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js 12.x
        uses: actions/setup-node@v1
        with:
          node-version: &quot;12.x&quot;
      - name: Cache NPM dependencies
        uses: actions/cache@v2
        with:
          path: node_modules
          key: ${{ runner.OS }}-npm-cache
          restore-keys: |
            ${{ runner.OS }}-npm-cache
      - name: Install Dependencies
        run: npm install
      - name: Build
        run: npm run build
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }} # æ— éœ€ä¿®æ”¹
          publish_dir: ./public # hexo generate ç”Ÿæˆçš„åšå®¢æ–‡ä»¶é»˜è®¤å­˜æ”¾åœ¨ /public ç›®å½•ä¸‹
          publish_branch: master # å­˜æ”¾å±•ç¤ºçš„åšå®¢æ–‡ä»¶çš„åˆ†æ”¯
```

å·¥ä½œæµé‡‡ç”¨äº†åˆ«äººç¼–å†™å¥½çš„ [actions-gh-pages@v3](https://github.com/peaceiris/actions-gh-pages)ï¼Œå…¶ä¸­ `GITHUB_TOKEN` ä¸º Github Actions åœ¨è¿è¡Œä¸­è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œç”¨äºéªŒè¯èº«ä»½çš„ Tokenï¼Œæ— éœ€ä¿®æ”¹ã€‚å…³äº `GITHUB_TOKEN` çš„æ›´å¤šä»‹ç»ï¼Œå¯ä»¥æŸ¥çœ‹[æ­¤æ–‡æ¡£](https://docs.github.com/en/actions/reference/authentication-in-a-workflow)ã€‚

æäº¤ä¿®æ”¹æˆ–ä¿å­˜æ­¤å·¥ä½œæµæ–‡ä»¶ï¼Œå¾ˆå¿« Github Actions å°±ä¼šå¼€å§‹è‡ªåŠ¨æ‰§è¡Œï¼Œå¹¶å°†æœ€æ–°çš„åšå®¢æ–‡ä»¶æ¨é€åˆ°ä»“åº“çš„ `master` åˆ†æ”¯ã€‚

æœ€åï¼Œç­‰åˆ° Github Pages ä¹Ÿæ›´æ–°å®Œæ¯•åï¼Œå°±å¯ä»¥è®¿é—®æ‚¨çš„åšå®¢å•¦ï¼

### å‡å¦‚æ‚¨é‡‡ç”¨äº†è´¦æˆ·ä¸¤é‡éªŒè¯

Ops, ä¹Ÿè®¸æ‚¨çš„é‚®ç®±æ”¶åˆ°äº†ä¸€ä»½æ–°çš„é‚®ä»¶ï¼Œé—æ†¾åœ°é€šçŸ¥æ‚¨ Github Actions æ‰§è¡Œå¤±è´¥ã€‚è¿™æ—¶æ‚¨å¯ä»¥æƒ³ä¸€æƒ³è‡ªå·±æ˜¯å¦å¯ç”¨äº† Github è´¦å·çš„åŒé‡éªŒè¯æˆ–å…¶å®ƒå®‰å…¨è®¿é—®éªŒè¯ã€‚è¿™éƒ½å¯èƒ½å¯¼è‡´è‡ªåŠ¨éƒ¨ç½²å¤±è´¥ã€‚

ä½†æ˜¯åˆ«æ‹…å¿ƒï¼Œæ‚¨å¯ä»¥é€šè¿‡[æ·»åŠ  SSH èº«ä»½éªŒè¯](https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-create-ssh-deploy-key)æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

é¦–å…ˆï¼Œä½¿ç”¨ `ssh-keygen -t rsa -C &quot;YOUR USERNAME&quot;` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ SSH key å…¬é’¥å¯†é’¥å¯¹ã€‚

ç„¶ååœ¨ Github ä¸Šçš„ **Account settings** ä¸­çš„ **SSH and GPG keys** è®¾ç½®ä¸­ä¿å­˜å¸¦æœ‰ `.pub` åç¼€çš„å…¬é’¥ï¼Œå¹¶åœ¨å½“å‰é¡¹ç›®ä»“åº“çš„ `secrets` ä¸­å­˜æ”¾ä¸å¸¦ä»»ä½•åç¼€çš„å¯†é’¥ã€‚

æœ€åä¿®æ”¹åˆšåˆšçš„ `main.yml` æ–‡ä»¶ï¼Œæ·»åŠ  `deploy_key` è®¾ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```yml
name: Hexo Blog CI &amp; CD

on:
  push:
    branches:
      - source

jobs:
  pages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js 12.x
        uses: actions/setup-node@v1
        with:
          node-version: &quot;12.x&quot;
      - name: Cache NPM dependencies
        uses: actions/cache@v2
        with:
          path: node_modules
          key: ${{ runner.OS }}-npm-cache
          restore-keys: |
            ${{ runner.OS }}-npm-cache
      - name: Install Dependencies
        run: npm install
      - name: Build
        run: npm run build
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          deploy_key: ${{ secrets.ACCESS_TOKEN }} # æ·»åŠ  ACCESS_TOKEN
          publish_dir: ./public
          publish_branch: master
```

å…¶ä¸­ `ACCESS_TOKEN` ä¸ºæ–°å»ºçš„ `secret` çš„åå­—ï¼Œæ‚¨åº”å½“ä¿®æ”¹ä¸ºåˆšåˆšæ‚¨åˆ›å»º `secret` æ—¶æŒ‡å®šçš„åå­—ã€‚

å½“ç„¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥ç”Ÿæˆ Github personal access tokenï¼Œæœ¬æ–‡ä¸å†èµ˜è¿°ã€‚

æœ€åï¼Œæäº¤æ‚¨çš„ä¿®æ”¹ï¼Œä¸€åˆ‡éƒ½å·¥ä½œå¾—å¦‚æ­¤å®Œç¾ã€‚
</content:original-text><content:updated-at>2021-02-19T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[IEEE 1471ï¼ˆISO/IEC/IEEE 42010ï¼‰æ¶æ„æè¿°æ–¹æ³•]]></title><description><![CDATA[å…³äº æœ¬æ–‡å¯¹è½¯ä»¶ä½“ç³»æ¶æ„çš„æè¿°æ–¹æ³•çš„ç ”ç©¶åŸºäº ISO/IEC/IEEE 42010. ISO/IEC/IEEE 42010 äº 2011 å¹´æ‰¹å‡†ä½¿ç”¨å¹¶å‘å¸ƒï¼Œè¯¥æ ‡å‡†æ˜¯ç»§ 2006 å¹´ ISO å¿«é€Ÿé‡‡ç”¨ IEEE æ ‡å‡†åï¼ŒISO å’Œ IEEE è”åˆåˆ¶å®šçš„ä¿®è®¢ IEEE Std 1471:2000 çš„äº§ç‰©ã€‚

æœ¬æ–‡ç»å¤§å¤šæ•°å†…å®¹é€šè¿‡ DeepL ç¿»è¯‘ ISO/IEC/IEEE 42010 åŸæ–‡å¾—æ¥ã€‚

æœ¬æ–‡ç³»â€¦]]></description><link>https://blog.towind.fun/posts/ISO-IEC-IEEE-42010-des</link><guid isPermaLink="false">ISO-IEC-IEEE-42010-des</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Tue, 29 Dec 2020 00:00:00 GMT</pubDate><content:original-text>
## å…³äº

æœ¬æ–‡å¯¹è½¯ä»¶ä½“ç³»æ¶æ„çš„æè¿°æ–¹æ³•çš„ç ”ç©¶åŸºäº ISO/IEC/IEEE 42010. ISO/IEC/IEEE 42010 äº 2011 å¹´æ‰¹å‡†ä½¿ç”¨å¹¶å‘å¸ƒï¼Œè¯¥æ ‡å‡†æ˜¯ç»§ 2006 å¹´ ISO å¿«é€Ÿé‡‡ç”¨ IEEE æ ‡å‡†åï¼ŒISO å’Œ IEEE è”åˆåˆ¶å®šçš„ä¿®è®¢ IEEE Std 1471:2000 çš„äº§ç‰©ã€‚

æœ¬æ–‡ç»å¤§å¤šæ•°å†…å®¹é€šè¿‡ DeepL ç¿»è¯‘ ISO/IEC/IEEE 42010 åŸæ–‡å¾—æ¥ã€‚

æœ¬æ–‡ç³»è½¯ä»¶ä½“ç³»æ¶æ„ä¸è®¾è®¡æ¨¡å¼è¯¾ç¨‹ä¸­ä¸€é¡¹ä½œä¸šã€‚

è®¿é—®[æˆ‘çš„ CSDN åšå®¢](https://blog.csdn.net/qq_43374102/article/details/111935815)ä»¥æŸ¥çœ‹æ­¤æ–‡ç« ã€‚
</content:original-text><content:updated-at>2021-02-19T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[Windows è¿œç¨‹æ¡Œé¢è¿æ¥æŒ‡å—]]></title><description><![CDATA[ç¯å¢ƒ æœ¬æ–‡ä»¥ç”µå­ç§‘æŠ€å¤§å­¦ï¼ˆæ²™æ²³æ ¡åŒºï¼‰çš„æ ¡å›­ç½‘ä¸ºä¾‹ã€‚å®¶ç”¨åœºåˆå¯èƒ½éœ€è¦æ‹¨æ‰“ç½‘ç»œè¿è¥å•†å¼€å…¬ç½‘ IPï¼Œæˆ–é€šè¿‡ FRP ç­‰æŠ€æœ¯å®ç°ã€‚

æ¼”ç¤ºçš„ç³»ç»Ÿå¦‚ä¸‹ï¼š

æ¥å—è¿æ¥çš„ä¸»æœºï¼š Windows 10 ä¸“ä¸šç‰ˆ è¿›è¡Œè¿æ¥çš„ä¸»æœºï¼š Windows 10 ä»»æ„ç‰ˆæœ¬
é…ç½®è¿œç¨‹æ¡Œé¢
é…ç½®æ¥å—è¿æ¥çš„ä¸»æœº

é¦–å…ˆéœ€è¦ç›®çš„ä¸»æœºæ‰“å¼€å…è®¸è¿œç¨‹ååŠ©çš„é€‰é¡¹ã€‚è¿›å…¥é«˜çº§ç³»ç»Ÿè®¾ç½®-è¿œç¨‹ï¼Œå‹¾é€‰å³å¯ã€‚

æ‚¨å¯ä»¥é€‰æ‹©å…è®¸è¿›è¡Œè¿œç¨‹ç™»å½•çš„è´¦å·â€¦]]></description><link>https://blog.towind.fun/posts/connect-remote-desktop</link><guid isPermaLink="false">connect-remote-desktop</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Mon, 07 Dec 2020 00:00:00 GMT</pubDate><content:original-text>
## ç¯å¢ƒ

æœ¬æ–‡ä»¥ç”µå­ç§‘æŠ€å¤§å­¦ï¼ˆæ²™æ²³æ ¡åŒºï¼‰çš„æ ¡å›­ç½‘ä¸ºä¾‹ã€‚å®¶ç”¨åœºåˆå¯èƒ½éœ€è¦æ‹¨æ‰“ç½‘ç»œè¿è¥å•†å¼€å…¬ç½‘ IPï¼Œæˆ–é€šè¿‡ FRP ç­‰æŠ€æœ¯å®ç°ã€‚

æ¼”ç¤ºçš„ç³»ç»Ÿå¦‚ä¸‹ï¼š

- **æ¥å—è¿æ¥çš„ä¸»æœºï¼š** Windows 10 ä¸“ä¸šç‰ˆ
- **è¿›è¡Œè¿æ¥çš„ä¸»æœºï¼š** Windows 10 ä»»æ„ç‰ˆæœ¬

## é…ç½®è¿œç¨‹æ¡Œé¢

### é…ç½®æ¥å—è¿æ¥çš„ä¸»æœº

é¦–å…ˆéœ€è¦ç›®çš„ä¸»æœºæ‰“å¼€å…è®¸è¿œç¨‹ååŠ©çš„é€‰é¡¹ã€‚è¿›å…¥é«˜çº§ç³»ç»Ÿè®¾ç½®-è¿œç¨‹ï¼Œå‹¾é€‰å³å¯ã€‚

![æœç´¢é«˜çº§ç³»ç»Ÿè®¾ç½®](./connect-remote-desktop/æœç´¢é«˜çº§ç³»ç»Ÿè®¾ç½®.png)

![å¯ç”¨è¿œç¨‹ååŠ©åŠŸèƒ½](./connect-remote-desktop/å¯ç”¨è¿œç¨‹ååŠ©.png)

æ‚¨å¯ä»¥é€‰æ‹©å…è®¸è¿›è¡Œè¿œç¨‹ç™»å½•çš„è´¦å·ï¼Œé€šå¸¸æƒ…å†µä¸‹æ‚¨åªéœ€è¦è¿æ¥è‡ªå·±çš„å¾®è½¯è´¦å·å°±å¯ä»¥äº†ã€‚

![æ·»åŠ è¿œç¨‹æ¡Œé¢å¯è®¿é—®ç”¨æˆ·](./connect-remote-desktop/æ·»åŠ å¯è®¿é—®ç”¨æˆ·.png)

æ­¤æ—¶ï¼Œå¦‚æœæ‚¨çš„ä¸¤å°ä¸»æœºéƒ½åœ¨ä¸€ä¸ªå±€åŸŸç½‘ä¸‹ï¼ˆå¦‚å¯å®¤é‡Œçš„æ ¡å›­ç½‘ï¼‰ï¼Œåˆ™å¯ä»¥é€šè¿‡ç›®çš„ä¸»æœºçš„è®¡ç®—æœºåç§°è¿›è¡Œè¿œç¨‹æ¡Œé¢æ§åˆ¶äº†ã€‚

![æœç´¢è¿œç¨‹æ¡Œé¢è¿æ¥](./connect-remote-desktop/æœç´¢è¿œç¨‹æ¡Œé¢è¿æ¥.png)

![è¿æ¥è¿œç¨‹æ¡Œé¢ï¼šå±€åŸŸç½‘](./connect-remote-desktop/è¿æ¥è¿œç¨‹æ¡Œé¢ï¼šå±€åŸŸç½‘.png)

æ‚¨å¯ä»¥åœ¨è®¾ç½®-å…³äºä¸­æ‰¾åˆ°æ‚¨çš„è®¾å¤‡åç§°ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è®¾å¤‡çš„å†…ç½‘ IP åœ°å€è¿æ¥ã€‚

![æŸ¥çœ‹ç›®çš„ä¸»æœºè®¾å¤‡åç§°](./connect-remote-desktop/æŸ¥çœ‹è®¾å¤‡åç§°.png)

### è·å–æ¥å—è¿æ¥çš„ä¸»æœºå…¬ç½‘è®¿é—®åœ°å€

ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯ä¸ºäº†èƒ½åœ¨ä»»ä½•è¿æ¥æœ‰äº’è”ç½‘çš„ä½ç½®éƒ½å¯ä»¥è®¿é—®åˆ°ç›®çš„ä¸»æœºï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ‹¿åˆ°ç›®çš„ä¸»æœºæ‰€è¿æ¥è·¯ç”±å™¨çš„å…¬ç½‘ IP åœ°å€ï¼Œåœ¨åœ°å€æ é”®å…¥ `192.168.1.1` è¿›å…¥è·¯ç”±å™¨ç®¡ç†é¡µé¢æŸ¥è¯¢ã€‚æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ç™¾åº¦æœç´¢ `ip` è·å–å…¬ç½‘ IP åœ°å€ã€‚

ä»¥ TP-LINK ä¸ºä¾‹ï¼Œå¦‚ä¸‹å›¾ `IP åœ°å€` å¤„å³ä¸ºå…¬ç½‘ IP åœ°å€ `210.41.103.31`ã€‚

![æŸ¥è¯¢å…¬ç½‘ IP åœ°å€](./connect-remote-desktop/æŸ¥è¯¢å…¬ç½‘%20IP.png)

ä¸€èˆ¬å®¶åº­ç”¨æˆ·é»˜è®¤æ²¡æœ‰å¼€æ”¾å…¬ç½‘ IP åœ°å€ï¼Œæ‚¨å¯ä»¥è‡´ç”µç½‘ç»œè¿è¥å•†ï¼Œç”³è¯·å¼€æ”¾å…¬ç½‘ IP åœ°å€ï¼Œå‡ åˆ†é’Ÿå°±å¯ä»¥æå®šã€‚

åˆ©ç”¨è·¯ç”±å™¨çš„è™šæ‹ŸæœåŠ¡å™¨åŠŸèƒ½ï¼Œå°†å†…ç½‘çš„ IP åœ°å€ä¸Šçš„æŸç«¯å£é€šè¿‡ç«¯å£æ˜ å°„æä¾›ç»™å…¬ç½‘ï¼Œä½¿å¾—å…¬ç½‘èƒ½å¤Ÿè®¿é—®åˆ°ç›®çš„ä¸»æœºçš„è¿œç¨‹æ¡Œé¢æœåŠ¡ã€‚

åœ¨æ­¤ä¹‹å‰ï¼Œéœ€è¦è·å–ç›®çš„ä¸»æœºçš„å†…ç½‘ IP åœ°å€ã€‚åŒæ ·å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œä¸­çš„ `ipconfig` å‘½ä»¤è·å–ã€‚

ä»¥ TP-LINK ä¸ºä¾‹ï¼Œå¦‚ä¸‹å›¾ `IP` å¤„çš„ `192.168.1.105` å³ä¸ºç›®çš„ä¸»æœºçš„å†…ç½‘ IP åœ°å€ã€‚

![æŸ¥è¯¢ç›®çš„ä¸»æœºå†…ç½‘ IP åœ°å€](./connect-remote-desktop/æŸ¥è¯¢å†…ç½‘%20IP%20åœ°å€.png)

ä¸€èˆ¬æ¥è¯´ï¼Œè·¯ç”±å™¨ä¼šæŒ‰ç…§äº’è”ç½‘è¿æ¥çš„é¡ºåºåˆ†é…å†…ç½‘ IP åœ°å€ï¼Œå› æ­¤ç«¯å£æ˜ å°„æ—¶å¯èƒ½å°†é”™è¯¯çš„ä¸»æœºè®¾å¤‡æ˜ å°„åˆ°å…¬ç½‘ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è·¯ç”±å™¨çš„ `IP ä¸ MAC ç»‘å®š` åŠŸèƒ½ï¼Œå°†ç›®çš„ä¸»æœº MAC åœ°å€å’Œä»»æ„å†…ç½‘ IP åœ°å€ç»‘å®šï¼Œç¡®ä¿è¯¥ IP åœ°å€å¯¹åº”ç›®çš„ä¸»æœºã€‚

ä»¥ TP-LINK ä¸ºä¾‹ï¼Œå¦‚ä¸‹å›¾å°†å†…ç½‘çš„ `IP` åœ°å€ `192.168.1.105` ä¸ `MAC` åœ°å€ä¸º `F6-A2-6C-58-B5-A4` çš„ä¸»æœºç»‘å®šã€‚

![ç»‘å®šç›®çš„ä¸»æœº MAC åœ°å€å’Œå†…ç½‘ IP åœ°å€](./connect-remote-desktop/ç»‘å®š%20IP%20ä¸%20MAC%20åœ°å€.png)

è®°å¾—è¦åœ¨ç›®çš„ä¸»æœºè¿æ¥çš„ç½‘ç»œçš„ç½‘ç»œè®¾ç½®ä¸­å…³é—­éšæœºç¡¬ä»¶åœ°å€é€‰é¡¹ï¼

![å…³é—­éšæœºç¡¬ä»¶åœ°å€](./connect-remote-desktop/å…³é—­éšæœºç¡¬ä»¶åœ°å€.png)

æœ€åä¸€æ­¥ï¼Œé€šè¿‡è·¯ç”±å™¨çš„è™šæ‹ŸæœåŠ¡å™¨åŠŸèƒ½ï¼Œå°†ç›®çš„ä¸»æœºçš„ 3389 ç«¯å£æ˜ å°„ä¸ºå…¬ç½‘ç«¯å£ã€‚3389 ç«¯å£ä¸ºé»˜è®¤çš„è¿œç¨‹æ¡Œé¢æœåŠ¡ç«¯å£ï¼Œå‡å¦‚æ‚¨æœ‰æ›´æ”¹è¿‡ç«¯å£å·ï¼Œè¯·ä¿®æ”¹ä¸ºå¯¹åº”çš„æ˜ å°„ç«¯å£ã€‚**æ³¨æ„ï¼Œç”±äºç”µå­ç§‘æŠ€å¤§å­¦ä¿¡æ¯ä¸­å¿ƒçš„å®‰å…¨è€ƒè™‘ï¼Œé»˜è®¤å…³æ‰äº†æ ¡å›­ç½‘çš„ 3389 å¤–éƒ¨ç«¯å£ï¼Œæ‚¨éœ€è¦ä»»æ„è®¾ç½®ä¸€ä¸ªå…¶å®ƒå¤–éƒ¨ç«¯å£ï¼Œå¦‚ 3390ã€‚**

ä»¥ TP-LINK ä¸ºä¾‹ï¼Œå¦‚ä¸‹å›¾å°†å†…ç½‘çš„ `IP` åœ°å€ä¸º `192.168.1.105` çš„ä¸»æœºçš„ `å†…éƒ¨ç«¯å£` 3389 ä¸ `å¤–éƒ¨ç«¯å£` 3390 ç»‘å®šã€‚

![è™šæ‹ŸæœåŠ¡å™¨æ˜ å°„ç«¯å£](./connect-remote-desktop/æ˜ å°„ç«¯å£.png)

åœ¨é‡å¯è·¯ç”±å™¨æ—¶ï¼Œåˆ†é…åˆ°çš„å…¬ç½‘ IP å¯èƒ½å‘ç”Ÿæ”¹å˜ï¼Œæ­¤æ—¶éœ€è¦é€šè¿‡æ–°çš„å…¬ç½‘ IP è¿æ¥åˆ°ç›®çš„ä¸»æœºã€‚ç”µå­ç§‘æŠ€å¤§å­¦é‡‡ç”¨å“ˆå¸Œè¡¨çš„æ–¹å¼åˆ†é…å¯å®¤ç½‘çš„å…¬ç½‘ IPï¼Œå› æ­¤ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚

### è¿œç¨‹è¿æ¥åˆ°ä¸»æœº

ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨ä»»æ„è¿æ¥äº’è”ç½‘çš„è®¾å¤‡é€šè¿‡è¿œç¨‹æ¡Œé¢æœåŠ¡è®¿é—®ç›®çš„ä¸»æœºï¼å¦‚ä¸‹å›¾æœç´¢ `210.41.103.31:3390` æ‰€å¯¹åº”çš„è¿œç¨‹æ¡Œé¢æœåŠ¡ã€‚

![è¿æ¥è¿œç¨‹æ¡Œé¢](./connect-remote-desktop/è¿æ¥è¿œç¨‹æ¡Œé¢.png)
</content:original-text><content:updated-at>2024-05-10T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[PyTorch åœ¨ Windows 10 ç³»ç»Ÿä¸‹çš„ç¯å¢ƒé…ç½®åŠå®‰è£…]]></title><description><![CDATA[å…³äº PyTorch æ˜¯ä¸€ä¸ªå¼€æºçš„ Python æœºå™¨å­¦ä¹ åº“ï¼ŒåŸºäº Torchï¼Œç”¨äºè‡ªç„¶è¯­è¨€å¤„ç†ç­‰åº”ç”¨ç¨‹åºã€‚

æœ¬æ–‡åŸºäº Windows 10 ç³»ç»Ÿå®ç° PyTorch çš„å®‰è£…ä¸é…ç½®ï¼Œå¹¶ä¸”æ¼”ç¤ºäº†å¦‚ä½•å®‰è£…å¯ç”¨ NVIDIA æ˜¾å¡çš„ GPU åŠ é€Ÿã€‚

è®¿é—®æˆ‘çš„ CSDN åšå®¢ä»¥æŸ¥çœ‹æ­¤æ–‡ç« ã€‚]]></description><link>https://blog.towind.fun/posts/pytorch-install-windows-10</link><guid isPermaLink="false">pytorch-install-windows-10</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Mon, 28 Sep 2020 00:00:00 GMT</pubDate><content:original-text>
## å…³äº

PyTorch æ˜¯ä¸€ä¸ªå¼€æºçš„ Python æœºå™¨å­¦ä¹ åº“ï¼ŒåŸºäº Torchï¼Œç”¨äºè‡ªç„¶è¯­è¨€å¤„ç†ç­‰åº”ç”¨ç¨‹åºã€‚

æœ¬æ–‡åŸºäº Windows 10 ç³»ç»Ÿå®ç° PyTorch çš„å®‰è£…ä¸é…ç½®ï¼Œå¹¶ä¸”æ¼”ç¤ºäº†å¦‚ä½•å®‰è£…å¯ç”¨ NVIDIA æ˜¾å¡çš„ GPU åŠ é€Ÿã€‚

è®¿é—®[æˆ‘çš„ CSDN åšå®¢](https://blog.csdn.net/qq_43374102/article/details/108857215)ä»¥æŸ¥çœ‹æ­¤æ–‡ç« ã€‚
</content:original-text><content:updated-at>2021-02-19T00:00:00.000Z</content:updated-at></item><item><title><![CDATA[Hello Hexo World]]></title><description><![CDATA[æ­å»ºä¸€ä¸ªè‡ªå·±çš„åšå®¢æ˜¯å¤šå°‘æŠ•èº«äº IT è¡Œä¸šçš„ç”·äººå¥³äººä»¬çš„æ¢¦æƒ³ï¼æ’‡å¼€ç»´æŠ¤æ‰€èŠ±è´¹çš„å·¨é‡æ—¶é—´å¼€é”€ä¸çœ‹ï¼Œèƒ½å¤Ÿåœ¨ç½‘ç»œä¸Šåˆ’å¾—ä¸€ç‰‡å‡€åœŸå»ä¼ é€’è‡ªå·±çš„æ•…äº‹ä¸æ€è€ƒï¼Œæ˜¯ä¸€ä»¶ä½•ç­‰å¿«ä¹çš„äº‹æƒ…ï¼ æ­£å¦‚è®¸å¤šäººçš„ç¬¬ä¸€ç¯‡åšå®¢é‚£æ ·ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸‹æ­å»ºåšå®¢çš„æµç¨‹ï¼Œä¹Ÿè®¸èƒ½å¸¦ç»™ä½ äº›è®¸å†³æ„å’Œå¸®åŠ©ã€‚

å¼€å§‹å‰

å‡è®¾ä½ å·²äº†è§£ä½•ä¸º Github Pagesï¼Œå¹¶å……åˆ†è®¤è¯†åˆ°å®ƒå¯¹äºä¸€ä¸ªæ¸´æœ›æ­å»ºåšå®¢çš„ä¸­å›½äººçš„éš¾ä»¥æ›¿ä»£æ€§ï¼ˆæ˜¯çš„ï¼Œæˆ‘ä¸æ„¿æ„å¤‡æ¡ˆï¼‰ã€‚åœ¨å¼€å§‹ä¹‹å‰â€¦]]></description><link>https://blog.towind.fun/posts/hello-hexo-world</link><guid isPermaLink="false">hello-hexo-world</guid><category><![CDATA[æŠ€æœ¯çäº‹]]></category><pubDate>Fri, 27 Dec 2019 00:00:00 GMT</pubDate><content:original-text>
æ­å»ºä¸€ä¸ªè‡ªå·±çš„åšå®¢æ˜¯å¤šå°‘æŠ•èº«äº IT è¡Œä¸šçš„ç”·äººå¥³äººä»¬çš„æ¢¦æƒ³ï¼æ’‡å¼€ç»´æŠ¤æ‰€èŠ±è´¹çš„å·¨é‡æ—¶é—´å¼€é”€ä¸çœ‹ï¼Œèƒ½å¤Ÿåœ¨ç½‘ç»œä¸Šåˆ’å¾—ä¸€ç‰‡å‡€åœŸå»ä¼ é€’è‡ªå·±çš„æ•…äº‹ä¸æ€è€ƒï¼Œæ˜¯ä¸€ä»¶ä½•ç­‰å¿«ä¹çš„äº‹æƒ…ï¼

æ­£å¦‚è®¸å¤šäººçš„ç¬¬ä¸€ç¯‡åšå®¢é‚£æ ·ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸‹æ­å»ºåšå®¢çš„æµç¨‹ï¼Œä¹Ÿè®¸èƒ½å¸¦ç»™ä½ äº›è®¸å†³æ„å’Œå¸®åŠ©ã€‚

## å¼€å§‹å‰

å‡è®¾ä½ å·²äº†è§£ä½•ä¸º Github Pagesï¼Œå¹¶å……åˆ†è®¤è¯†åˆ°å®ƒå¯¹äºä¸€ä¸ªæ¸´æœ›æ­å»ºåšå®¢çš„ä¸­å›½äººçš„éš¾ä»¥æ›¿ä»£æ€§ï¼ˆæ˜¯çš„ï¼Œæˆ‘ä¸æ„¿æ„å¤‡æ¡ˆï¼‰ã€‚åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦é€‰æ‹©åšå®¢æ¡†æ¶ï¼Œå¹¶ä¸‹è½½ä¸ä¹‹å¯¹åº”çš„ä¾èµ–è½¯ä»¶ã€‚

### Hello, Hexo

Hexo åŸºäº Node.jsï¼Œæ˜¯ä¸€ä¸ªå¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„åšå®¢æ¡†æ¶ã€‚Hexo ä½¿ç”¨ Markdownï¼ˆæˆ–å…¶ä»–æ¸²æŸ“å¼•æ“ï¼‰è§£ææ–‡ç« ï¼Œåœ¨å‡ ç§’å†…ï¼Œå³å¯åˆ©ç”¨é“ä¸½çš„ä¸»é¢˜ç”Ÿæˆé™æ€ç½‘é¡µã€‚

ç±»ä¼¼çš„ç”Ÿæˆé™æ€ç½‘é¡µçš„æ¡†æ¶è¿˜æœ‰ Hugoã€Jekyllã€Ghost ç­‰ï¼Œå„æœ‰æ‰€é•¿ã€‚æƒè¡¡åˆ©å¼Šï¼Œæˆ‘æœ€ç»ˆé€‰æ‹©äº†ç®€å•ä¸”é«˜æ•ˆçš„ Hexo æ¡†æ¶ã€‚

è®¿é—® [Hexo å®˜ç½‘](https://hexo.io/zh-cn)æ€»æ˜¯å¼€å§‹çš„ä¸äºŒä¹‹é€‰ã€‚

### ä¾èµ–ç¨‹åº

å®‰è£… Hexo ååˆ†ç®€å•ï¼Œåªéœ€è¦å…ˆå®‰è£…ä¸‹åˆ—åº”ç”¨ç¨‹åºï¼š

- [Node.js](https://nodejs.org/en/)ï¼ˆç‰ˆæœ¬ä¸ä½äº 10.13.0ï¼‰
- [Git](https://git-scm.com/)

é€šå¸¸é€‰æ‹©æœ€æ–°ç‰ˆæœ¬å³å¯ã€‚

### å®‰è£… Hexo

å®‰è£…å®Œæ¯•ä¾èµ–ç¨‹åºåï¼Œæ‰“å¼€ Git bashï¼Œä½¿ç”¨ npm å‘½ä»¤ä¸€é”®å®‰è£… Hexo 5.x ç‰ˆæœ¬ä»¥åŠæ‰€éœ€ä¾èµ–ã€‚

```bash
npm install -g hexo-cli
```

## æ­å»ºåšå®¢

### åˆå§‹åŒ–

é¦–å…ˆåœ¨ Git bash çš„å·¥ä½œç›®å½•æ–°å»ºå­˜æ”¾ Hexo æ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼Œè¿›å…¥è¯¥æ–‡ä»¶å¤¹å¹¶åˆå§‹åŒ–ã€‚

```bash
hexo init [æ–‡ä»¶å¤¹å]
cd [æ–‡ä»¶å¤¹å]
npm install
```

### ä¿®æ”¹é…ç½®æ–‡ä»¶

åœ¨ Hexo ç›®å½•ä¸‹çš„ `_config.yml` ä¿®æ”¹å¤§éƒ¨åˆ†çš„é…ç½®ï¼ŒåŒ…æ‹¬ç½‘ç«™æ ‡é¢˜ã€å‰¯æ ‡é¢˜ã€æ‚¨çš„åå­—ã€ç½‘ç«™è¯­è¨€å’Œç½‘ç«™æ—¶åŒºç­‰ç­‰ã€‚

å¯ä»¥å‚è§ [Hexo é…ç½®å®˜æ–¹æ–‡æ¡£](https://hexo.io/zh-cn/docs/configuration)ï¼ŒæŒ‰ç…§è‡ªå·±çš„éœ€æ±‚è¿›è¡Œæ›´æ”¹ã€‚

### éƒ¨ç½²åˆ° Github Pages

ç™»å½•ä½ çš„ Githubï¼Œæ–°å»ºä¸€ä¸ª Repositoryï¼Œå‘½åä¸º **ä½ çš„ Github ç”¨æˆ·å.github.io**ã€‚

ç°åœ¨ä½ å¯ä»¥éšæ—¶é€šè¿‡æµè§ˆå™¨è®¿é—® `https://ä½ çš„Githubç”¨æˆ·å.github.io` çš„æ–¹å¼ï¼Œè¿›å…¥åˆ°åº“ä¸­æ ¹ç›®å½•ä¸‹çš„ `index.html` é¡µé¢ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚

Hexo æä¾›äº†å¿«é€Ÿæ–¹ä¾¿çš„ä¸€é”®éƒ¨ç½²åŠŸèƒ½ï¼Œé…ç½®å®Œæˆä»¥ååªéœ€è¦ä¸€æ¡å‘½ä»¤å°±å¯ä»¥å°†ç½‘ç«™åˆ·æ–°å¹¶éƒ¨ç½²åˆ°ç½‘ç«™ä¸Šï¼

1.å®‰è£… hexo-deployer-gitã€‚

```bash
npm install hexo-deployer-git --save
```

2.ä¿®æ”¹ Hexo ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ `_config.yml` ä¸­ deploy çš„å†…å®¹å¦‚ä¸‹ã€‚

```json
deploy:
  type: git
  repo: ä½ çš„ Github Pages é“¾æ¥ # ä¾‹å¦‚https://bitbucket.org/JohnSmith/johnsmith.bitbucket.io
  branch: master
```

3.ç”Ÿæˆç«™ç‚¹æ–‡ä»¶å¹¶æ¨é€è‡³ Github åº“ã€‚

```bash
hexo clean &amp;&amp; hexo deploy
```

è‡³æ­¤ï¼Œåšå®¢ä¾¿å·²ç»æ­å»ºå®Œæ¯•äº†ï¼Hexo æ‹¥æœ‰ä¸€ä¸ª landscape çš„åˆå§‹ä¸»é¢˜ï¼Œæ„å‘³ç€ç°åœ¨ä½ å°±å¯ä»¥è®¿é—®ä½ è‡ªå·±çš„ Github Pages äº†ï¼

æ›´å¤šçš„ä¸»é¢˜å¯ä»¥åœ¨ [Hexo å®˜æ–¹ä¸»é¢˜é¡µé¢](https://hexo.io/themes)ä¸Šé€‰æ‹©ã€‚

### ç»´æŠ¤ä¸æ›´æ–°åšå®¢

å½“æ‰§è¡Œ `hexo deploy` æ—¶ï¼ŒHexo ä¼šå°† `public` ç›®å½•ä¸­çš„æ–‡ä»¶å’Œç›®å½•æ¨é€è‡³ `_config.yml` ä¸­æŒ‡å®šçš„è¿œç«¯ä»“åº“å’Œåˆ†æ”¯ä¸­ï¼Œå¹¶ä¸”**å®Œå…¨è¦†ç›–**è¯¥åˆ†æ”¯ä¸‹çš„å·²æœ‰å†…å®¹ã€‚

ç¼–å†™å¥½åšå®¢æ¨é€ä»¥åï¼Œåªéœ€è¦ç”¨ Git bash ç§»åŠ¨åˆ° Hexo ç›®å½•ï¼Œä½¿ç”¨ `hexo clean &amp;&amp; hexo deploy` å‘½ä»¤ï¼ˆåœ¨ windows terminal ä¸Šè¯·ä½¿ç”¨ `hexo clean ; hexo deploy`ï¼‰ï¼Œå³å¯å®Œæˆåšå®¢é¡µé¢çš„æ›´æ–°ä¸åŒæ­¥äº†ã€‚

## å…³äº

ä¸Šè¿°æ­¥éª¤ç”± [Hexo å®˜æ–¹æ–‡æ¡£](https://hexo.io/docs/)ç®€åŒ–è€Œæ¥ã€‚

æ‚¨å¯ä»¥éšæ—¶è®¿é—®å®˜æ–¹æ–‡æ¡£è·å–æœ€æ–°çš„æ­å»ºåšå®¢æ–¹æ³•å’Œæ›´å¤šé‡è¦çš„ä½¿ç”¨æ–¹æ³•ã€‚
</content:original-text><content:updated-at>2021-02-19T00:00:00.000Z</content:updated-at></item></channel></rss>