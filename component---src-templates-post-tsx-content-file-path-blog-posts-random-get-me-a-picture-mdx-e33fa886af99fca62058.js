"use strict";(self.webpackChunkhomepage=self.webpackChunkhomepage||[]).push([[857],{509:function(n,a,s){s.r(a),s.d(a,{Head:function(){return f},default:function(){return h}});var t=s(8453),p=s(6540);function e(n){const a=Object.assign({p:"p",a:"a",span:"span",h2:"h2",h3:"h3",h4:"h4",strong:"strong",ul:"ul",li:"li"},(0,t.R)(),n.components);return p.createElement(p.Fragment,null,p.createElement(a.p,null,"笔者自高中到现在，游走于 Pixiv 若干载，不慎收藏了许多名家雅作。"),"\n",p.createElement(a.p,null,"独乐乐不如众乐乐！笔者想做一个 web 页面来随机访问我的收藏，不过在此之前，可以先实现服务端上的内容。再之后做网页时，不过是简单的读取数据库罢了！"),"\n",p.createElement(a.p,null,"最初，笔者以为得将我的库存全部放到服务器上项目中去，然后随机访问其中的图片实现功能，但这样做很难得同步，遂搁置。不过，笔者在最近发现有一个 ",p.createElement(a.a,{href:"https://pixiv.re/"},"Pixiv 图片代理网站")," 可以快速下载到图片，大喜，于是开始了这个小工程。"),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/eb06a9acfb6c6905fff1abc711cc8e16/3a188/pixiv-cat.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 48.71794871794871%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABJ0AAASdAHeZh94AAAA/0lEQVR42qWS6W6EMAyE8/5P2NVCoYc4chCOnBCYOqjan9sVjfTJlhNZY2eYUgoZIQTmeYIx5sRai2VZqDYjxvgU59z5znsPVo0B74NDIQ1KZc9YSPvIP+n+a4pP+Z4jPiiadQe7lTVaoRAS4LcEFxMs4VaKhN/2l3BE2g+wsrjDWYd8UtpwHAf+c1jTduBSQ/ccsmnh9ITkwvWGwzBgHDU45+dSkRXu+/WGVVWhrmvc325QXCCtG3Yireu1hllZVjkrQiokH2hkf3ls1jQNtB5hyHeW/GSdRSBv5Tz7ayWlmRDCSx/G+r4/9yeEhJTyYfJM13VQvzWuRmzp793+AMMuC+PRYvzIAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="请求需包含 Referer"\n        title=""\n        src="/static/eb06a9acfb6c6905fff1abc711cc8e16/39c09/pixiv-cat.png"\n        srcset="/static/eb06a9acfb6c6905fff1abc711cc8e16/680fe/pixiv-cat.png 156w,\n/static/eb06a9acfb6c6905fff1abc711cc8e16/17474/pixiv-cat.png 312w,\n/static/eb06a9acfb6c6905fff1abc711cc8e16/39c09/pixiv-cat.png 624w,\n/static/eb06a9acfb6c6905fff1abc711cc8e16/6d2da/pixiv-cat.png 936w,\n/static/eb06a9acfb6c6905fff1abc711cc8e16/5a791/pixiv-cat.png 1248w,\n/static/eb06a9acfb6c6905fff1abc711cc8e16/3a188/pixiv-cat.png 1623w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",p.createElement(a.p,null,"实现此功能分为两个阶段：一，为本地的图片生成数据库索引条目。二，开发 Telegram Bot 接口，随机从数据库索引中获取一张图片转发给聊天。"),"\n",p.createElement(a.h2,null,"为本地的 Pixiv 图片建立索引"),"\n",p.createElement(a.h3,null,"初始化数据库 Pixiv 图片索引信息"),"\n",p.createElement(a.p,null,"如果使用 Pixiv 图片代理的方法，只需要将 Artwork 的基本信息上传给我们的数据库即可。"),"\n",p.createElement(a.p,null,"根据",p.createElement(a.a,{href:"https://core.telegram.org/bots/api#sending-files"},"官方文档"),"，当发送图片文件时，Telegram API 对图片的大小有限制：直接使用 HTTP URL 的方式不超过 5 MB，服务器上传图片的方式不超过 10 MB（以",p.createElement(a.a,{href:"https://core.telegram.org/bots/api#senddocument"},"文件的格式"),"发送时，不超过 50 MB，本文不采用文件的格式发送）。因此，在设计数据库时，还需要考虑图片的大小。"),"\n",p.createElement(a.p,null,"设计 Sequenlize 数据库模型 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ServicePixivCollection.js</code>'}})," 如下："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> DataTypes <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sequelize"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Pixiv artwork ID. Example: 95400283 for for 95400283_p${picIndex}.${picType}</span>\n  <span class="token literal-property property">picId</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Artwork index. Example: 1 for ${pixivId}_p1.${picType}</span>\n  <span class="token literal-property property">picIndex</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Artwork suffix type. Example: jpg for ${pixivId}_p${picIndex}.jpg</span>\n  <span class="token literal-property property">picType</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Artwork size, MB</span>\n  <span class="token literal-property property">picSize</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Artwork save date</span>\n  <span class="token literal-property property">picCreatedAt</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"如采用最小实现，也可以将上面的 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">picId</code>'}}),", ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">picIndex</code>'}})," 和 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">picType</code>'}})," 合并为一个数据项，例如 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">picName</code>'}}),"，直接保存图片的名字。笔者考虑到后续可能会增添新的功能，于是将它们单独拎出来储存。"),"\n",p.createElement(a.p,null,"处理不同路径下的图片时，可能需要保存执行的情况。例如 A 目录在当前时间点进行维护，获取了所有的图片，下次读取 A 目录时，应当从上次维护的时间开始获取最新的图片。现在新加了 B 目录，如果从上次维护 A 的时间点开始读取图片的话，在时间点之前的图片将无法上传。因此，针对不同文件夹的维护，可以分别建立一个单独的数据项。"),"\n",p.createElement(a.p,null,"设计数据库模型 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ServiceProcess.js</code>'}})," 如下："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> DataTypes <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sequelize"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">serviceId</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">UUID</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">UUIDV4</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">serviceName</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">serviceConfig</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">serviceSharedData</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">lastExecAt</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">haveExecTime</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"为 Sequelize 添加该模型，向 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">sequelize.js</code>'}})," 添加如下代码："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> servicePixivCollectionModel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path/to/ServicePixivCollection"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> serviceProcessModel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path/to/ServiceProcess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nsequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"ServicePixivCollection"</span><span class="token punctuation">,</span> servicePixivCollectionModel<span class="token punctuation">)</span><span class="token punctuation">;</span>\nsequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"ServiceProcess"</span><span class="token punctuation">,</span> serviceProcessModel<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"配置扫描图片的间隔时间和本地图片路径，编写 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">config.js</code>'}})," 如下:"),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">pixiv</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">randomGetFromCollection</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">3600</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"C:\\\\path\\\\to\\\\collection"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"扫描指定目录的图片文件，图片文件名称应满足从 Pixiv 下载图片的名称格式。例如：",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">95400283_p0.jpg</code>'}}),"，",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">95400283</code>'}})," 为数据库中的 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">picId</code>'}}),"，",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">_p0</code>'}})," 的 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">0</code>'}})," 为 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">picIndex</code>'}}),"，",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.jpg</code>'}})," 中的 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">jpg</code>'}})," 为 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">picType</code>'}}),"。编写生成图片索引的代码 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">pixiv.js</code>'}})," 如下："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> readdir<span class="token punctuation">,</span> stat <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs/promises"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path/to/config"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pixiv<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> Sequelize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path/to/sequelize"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">generateCollectionIndex</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> serviceName <span class="token operator">=</span> <span class="token string">"Generate Collection Index"</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> bToMB <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// File size with decimal places</span>\n  <span class="token keyword">const</span> fileSizeReservedDecimalPlace <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> fileSizeReservedDecimalNum <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">**</span> fileSizeReservedDecimalPlace<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">Sequelize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> ServicePixivCollection <span class="token operator">=</span> sequelize<span class="token punctuation">.</span>models<span class="token punctuation">.</span>ServicePixivCollection<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> ServiceProcess <span class="token operator">=</span> sequelize<span class="token punctuation">.</span>models<span class="token punctuation">.</span>ServiceProcess<span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> collectionPaths <span class="token operator">=</span> config<span class="token punctuation">.</span>generateCollectionIndex<span class="token punctuation">.</span>path<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>collectionPaths<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    collectionPaths <span class="token operator">=</span> <span class="token punctuation">[</span>collectionPaths<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// Get filenames in collection paths</span>\n  <span class="token keyword">let</span> allFiles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> collectionPath <span class="token keyword">of</span> collectionPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    files <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">readdir</span><span class="token punctuation">(</span>collectionPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Only keep files with Pixiv naming style</span>\n    <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\\d+_p\\d+.(jpg|png|gif)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>\n    files <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Get file stat and resolve file info</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> files<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> filename <span class="token operator">=</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>collectionPath<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> picIdSplitArr <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"_p"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> picId <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>picIdSplitArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> picIndexSplitArr <span class="token operator">=</span> picIdSplitArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> picIndex <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>picIndexSplitArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> picType <span class="token operator">=</span> picIndexSplitArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> picStat <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> picSize <span class="token operator">=</span>\n        Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>picStat<span class="token punctuation">.</span>size <span class="token operator">/</span> bToMB<span class="token punctuation">)</span> <span class="token operator">*</span> fileSizeReservedDecimalNum<span class="token punctuation">)</span> <span class="token operator">/</span>\n        fileSizeReservedDecimalNum<span class="token punctuation">;</span> <span class="token comment">// MB</span>\n      <span class="token keyword">const</span> picCreatedAt <span class="token operator">=</span> picStat<span class="token punctuation">.</span>mtimeMs<span class="token punctuation">;</span> <span class="token comment">// ms</span>\n\n      files<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n        <span class="token literal-property property">picName</span><span class="token operator">:</span> filename<span class="token punctuation">,</span>\n        picId<span class="token punctuation">,</span>\n        picIndex<span class="token punctuation">,</span>\n        picType<span class="token punctuation">,</span>\n        picSize<span class="token punctuation">,</span>\n        picCreatedAt<span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// Only keep files that recently saved</span>\n    <span class="token keyword">const</span> serviceProcess <span class="token operator">=</span> <span class="token keyword">await</span> ServiceProcess<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> serviceName<span class="token punctuation">,</span> <span class="token literal-property property">serviceConfig</span><span class="token operator">:</span> collectionPath <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceProcess<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// Only update or create Pixiv artwork that saved after last time this service is done</span>\n      <span class="token keyword">let</span> lastUpdateIndexTime <span class="token operator">=</span> serviceProcess<span class="token punctuation">.</span>dataValues<span class="token punctuation">.</span>lastExecAt<span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>lastUpdateIndexTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        lastUpdateIndexTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>lastUpdateIndexTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        files <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pic</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> pic<span class="token punctuation">.</span>picCreatedAt <span class="token operator">></span> lastUpdateIndexTime<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token keyword">await</span> ServiceProcess<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        serviceName<span class="token punctuation">,</span>\n        <span class="token literal-property property">serviceConfig</span><span class="token operator">:</span> collectionPath<span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    allFiles <span class="token operator">=</span> allFiles<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> updateIndexAt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Update or create pic index</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> picFile <span class="token keyword">of</span> allFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 注意：此处的 updateOrCreate() 为笔者自定义的方法</span>\n    <span class="token comment">// 其作用为：当存在 item 时，更新 item；不存在时，创建 item</span>\n    <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">updateOrCreate</span><span class="token punctuation">(</span>\n      ServicePixivCollection<span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        <span class="token literal-property property">picId</span><span class="token operator">:</span> picFile<span class="token punctuation">.</span>picId<span class="token punctuation">,</span>\n        <span class="token literal-property property">picIndex</span><span class="token operator">:</span> picFile<span class="token punctuation">.</span>picIndex<span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      picFile<span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// Update service process record</span>\n  ServiceProcess<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>\n    <span class="token punctuation">{</span>\n      <span class="token literal-property property">lastExecAt</span><span class="token operator">:</span> updateIndexAt<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> serviceName <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  ServiceProcess<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">"haveExecTime"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> serviceName <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  generateCollectionIndex<span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"设置定时扫描图片，基于 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">toad-scheduler</code>'}})," 库编写服务代码如下："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>\n  ToadScheduler<span class="token punctuation">,</span>\n  SimpleIntervalJob<span class="token punctuation">,</span>\n  AsyncTask<span class="token punctuation">,</span>\n<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"toad-scheduler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> pixivTask <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path/to/pixiv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path/to/config"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pixiv<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">initService</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> taskGenerateCollectionIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncTask</span><span class="token punctuation">(</span>\n    <span class="token string">"Generate Pixiv Collection Index"</span><span class="token punctuation">,</span>\n    <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">await</span> pixivTask<span class="token punctuation">.</span><span class="token function">generateCollectionIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> jobGenerateCollectionIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleIntervalJob</span><span class="token punctuation">(</span>\n    <span class="token punctuation">{</span>\n      <span class="token literal-property property">seconds</span><span class="token operator">:</span> config<span class="token punctuation">.</span>generateCollectionIndex<span class="token punctuation">.</span>duration<span class="token punctuation">,</span>\n      <span class="token literal-property property">runImmediately</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    taskGenerateCollectionIndex<span class="token punctuation">,</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> scheduler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToadScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  scheduler<span class="token punctuation">.</span><span class="token function">addSimpleIntervalJob</span><span class="token punctuation">(</span>jobGenerateCollectionIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> initService<span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"程序启动时，运行 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">initService()</code>'}})," 即可。服务器将自动读取指定目录下的 Pixiv 图片文件，并在数据库中建立索引。",p.createElement(a.a,{href:"#%E9%9A%8F%E6%9C%BA%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E4%B8%80%E4%B8%AA-pixiv-%E5%9B%BE%E7%89%87%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80"},"下一步"),"，我们将随机从数据库中读取一张作品的信息。"),"\n",p.createElement(a.h3,null,"思路：爬取 Pixiv 图片的源文件地址"),"\n",p.createElement(a.p,null,"如果使用亲自获取图片并转发的方法，除了前面需要初始化数据库的图片索引信息外，还需要构建 Axios 请求，爬取网页源代码，从中读取 Artwork 的下载链接等信息，再上传到数据库。"),"\n",p.createElement(a.p,null,"例如，对于下载 ",p.createElement(a.a,{href:"https://www.pixiv.net/artworks/95400283"},p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">95400283_p0.jpg</code>'}})),"，最少需要获取其源文件链接 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://i.pximg.net/img-original/img/2022/01/09/07/27/17/95400283_p0.jpg</code>'}})," 中的 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/2022/01/09/07/27/17</code>'}})," 部分，并上传到数据库中。"),"\n",p.createElement(a.p,null,"更多的，在爬取源代码时，可以记录下图片的作者信息，图片是否可以在工作时安全观看（登录后才能爬取此类内容，可能需要在请求时添加个人账户信息）等，对日后处理展示内容大有裨益。"),"\n",p.createElement(a.p,null,"处理网页源代码时，可以使用 ",p.createElement(a.a,{href:"https://github.com/cheeriojs/cheerio"},"cheerio")," 库增加效率。"),"\n",p.createElement(a.h2,null,"为 Telegram Bot 添加随机获取 Pixiv 图片的接口"),"\n",p.createElement(a.h3,null,"随机获取数据库中的一个 Pixiv 图片访问地址"),"\n",p.createElement(a.p,null,"编写 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">randomGetPixivCollection.js</code>'}})," 代码如下："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> Sequelize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path/to/sequelize"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">randomGetPixivCollection</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">Sequelize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> ServicePixivCollection <span class="token operator">=</span> sequelize<span class="token punctuation">.</span>models<span class="token punctuation">.</span>ServicePixivCollection<span class="token punctuation">;</span>\n\n    <span class="token comment">// Gain the total number of Pixiv artworks</span>\n    <span class="token keyword">const</span> artworksCount <span class="token operator">=</span> <span class="token keyword">await</span> ServicePixivCollection<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Generate a random value</span>\n    <span class="token keyword">const</span> randomArtworkId <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> artworksCount<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Get random artwork</span>\n    <span class="token keyword">const</span> artwork <span class="token operator">=</span> <span class="token keyword">await</span> ServicePixivCollection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> randomArtworkId <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Resolve artwork object</span>\n    <span class="token keyword">const</span> data <span class="token operator">=</span> artwork<span class="token punctuation">.</span>dataValues<span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> picId <span class="token operator">=</span> data<span class="token punctuation">.</span>picId<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> picIndex <span class="token operator">=</span> data<span class="token punctuation">.</span>picIndex<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> picType <span class="token operator">=</span> data<span class="token punctuation">.</span>picType<span class="token punctuation">;</span>\n\n    data<span class="token punctuation">.</span>picName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_p</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n    data<span class="token punctuation">.</span>picNameMD <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\\\_p</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\\\.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n    data<span class="token punctuation">.</span>picUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://www.pixiv.net/artworks/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n    <span class="token keyword">let</span> picProxyUrlParam<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>picIndex <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      picProxyUrlParam <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      picProxyUrlParam <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    data<span class="token punctuation">.</span>picProxyUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://pixiv.cat/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picProxyUrlParam<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      <span class="token literal-property property">ok</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      data<span class="token punctuation">,</span>\n      <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      <span class="token literal-property property">ok</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>\n      error<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> randomGetPixivCollection<span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"根据 Pixiv.cat 网站的使用说明，对单张图片的 Pixiv 作品，应访问 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://pixiv.cat/${picId}.${picType}</code>'}}),"。而对于多张图片的 Pixiv 作品（漫画），应访问 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://pixiv.cat/${picId}-${picIndex + 1}.${picType}</code>'}}),"。"),"\n",p.createElement(a.p,null,"可能会影响体验，需要改进的地方是：当作品名为 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">${picId}_p0.${picType}</code>'}})," 时，我们不知道该作品是否为单张图片，还是漫画作品，无法正确判断应该访问的 URL 链接。",p.createElement(a.a,{href:"#%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8-pixiv-%E5%9B%BE%E7%89%87%E4%BB%A3%E7%90%86"},"在后面"),"，我们将针对此情况做处理。"),"\n",p.createElement(a.h3,null,"添加 Telegram Bot 命令"),"\n",p.createElement(a.p,null,"接下来为 Bot 添加指令，以调用随机获取图片的接口。同样，这里给出使用 Pixiv 图片代理的具体实现，以及亲自获取图片并转发的可能思路。"),"\n",p.createElement(a.h4,null,"直接使用 Pixiv 图片代理"),"\n",p.createElement(a.p,null,"注意，使用这种方式上传的图片",p.createElement(a.strong,null,"不超过 5 MB"),"。"),"\n",p.createElement(a.p,null,"编写 Bot 的配置如下："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">bot<span class="token punctuation">.</span><span class="token function">onText</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\/random_pixiv</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> chatId <span class="token operator">=</span> msg<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>id<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">randomGetPixivCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>ok <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Send placeholder message</span>\n    <span class="token keyword">const</span> placeholderMessage <span class="token operator">=</span> <span class="token keyword">await</span> bot<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>\n      chatId<span class="token punctuation">,</span>\n      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Geeeeting a random Pixiv artwork ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> data <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span>\n      id<span class="token punctuation">,</span>\n      picNameMD<span class="token punctuation">,</span>\n      picUrl<span class="token punctuation">,</span>\n      picSize<span class="token punctuation">,</span>\n      picProxyUrl<span class="token punctuation">,</span>\n      picId<span class="token punctuation">,</span>\n      picIndex<span class="token punctuation">,</span>\n      picType<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> caption <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[source](</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n    <span class="token keyword">let</span> msgReplied <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>picSize <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// Artwork size is smaller than 5 MB, send photo message</span>\n      <span class="token keyword">const</span> sendPhotoOptions <span class="token operator">=</span> <span class="token punctuation">{</span>\n        caption<span class="token punctuation">,</span>\n        <span class="token literal-property property">parse_mode</span><span class="token operator">:</span> <span class="token string">"MarkdownV2"</span><span class="token punctuation">,</span>\n        <span class="token literal-property property">disable_web_page_preview</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token keyword">await</span> bot<span class="token punctuation">.</span><span class="token function">sendPhoto</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> picProxyUrl<span class="token punctuation">,</span> sendPhotoOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        msgReplied <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>picIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token comment">// Comic mode artwork with index=0 may send failed</span>\n            <span class="token comment">// Use comic mode url instead</span>\n            <span class="token keyword">const</span> picProxyUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://pixiv.cat/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-1.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>picType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n            <span class="token keyword">await</span> bot<span class="token punctuation">.</span><span class="token function">sendPhoto</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> picProxyUrl<span class="token punctuation">,</span> sendPhotoOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            msgReplied <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">//</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// Artwork size is not smaller than 5 MB or send failed again,</span>\n    <span class="token comment">// send caption message</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>msgReplied<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">await</span> bot<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> caption<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n        <span class="token literal-property property">parse_mode</span><span class="token operator">:</span> <span class="token string">"MarkdownV2"</span><span class="token punctuation">,</span>\n        <span class="token literal-property property">disable_web_page_preview</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// Remove placeholder message</span>\n    bot<span class="token punctuation">.</span><span class="token function">deleteMessage</span><span class="token punctuation">(</span>chatId<span class="token punctuation">,</span> placeholderMessage<span class="token punctuation">.</span>message_id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    bot<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>\n      chatId<span class="token punctuation">,</span>\n      <span class="token string">"Get random pixiv artwork failed. You may try to call it again later!"</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"在上面这段代码中，当以 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">bot.sendPhoto()</code>'}})," 的方法尝试发送 5 MB 以下的图片失败时，首先重新构建请求 URL 为 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://pixiv.cat/${data.picId}-1.${data.picType}</code>'}}),"，再次进行发送。如果还是失败（可能图片被作者删除），则发送简单的链接文本。由此，解决了前面提到的无法判断作品是否为漫画作品的问题。"),"\n",p.createElement(a.p,null,"与 Telegram 上的机器人对话，发送命令 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">\\random_pixiv</code>'}}),"，结果如下："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/c9dcfa09ee8cc8c2f2392dd2f3a930ef/a2b88/bot-service.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 116.02564102564101%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABJ0AAASdAHeZh94AAAEXElEQVR42p2VbUyTVxiG3w2VtoAtLYxKW1poSy0tWLAUZAhEdKggjAgqKChUqQoosgl+xI/oYIIxcRI2dY44Fw04F3UapsEoE50JMFwk02xz/9iPZXFZzJYsZnrttMRl2XTBneTKmzznPfc55znPh2SblYNrzgISs1/DkTUPTXwiKrMd/QyPIB1dUiq6RPdz0Yv52JkZWNKyMCanI6kMZkI1EYSqI4iMNlBasZqislXIVWrkSjX+eY3Vicbi+A+cRFjHkYJVEUx6SUI+OYj97YcY/GqMnvPD5C8qQ5IkFJHRKE3TmRoTPyEkRXgkk16WcNps9Jwd4N3OM2zd1kFNfQvBkych02hRxdpRGm0TQpKLE8qmBGHSR1O/vplrJ47zcedhcgt8qCOiCBYbhscmvJigQjYFjSqExYtXMHCpn659bTRsamVDbSNBYWrC4/6HoFqpYEWFj0Od3Wxt2seu5hZOHunCZHcRoregEn6coKAGZYgMo0FH08YtfPLeUa70Xqd8qY8Du1pJmDkLeXTcxAXNNhESYTJWVlbx808P+fXBQ37/7QnrVm9ka+0bxM9wo9CZJy64e08bzXW1vNm4matne/n0xCmGbwxRuGAxc9JzMMQ7CTVYUU3Uhz7fBr4dGaWhro69zds5fqiTXTt2UFK4nPx5RcKHM17Mh3l5RRze38Ho0B3OfNjD5dMXaN2yl0pvEzVVdbg8mchexIdZ2fMpL1zKzb4Bxr4f45vbX9O+s42chUspzC8la24Bsmmxzxb02/6BZEjOwF2whBwRg/PLveRXrSejeDkmTzbxs/OwpuWIAuBBJdIqXCx46supwq+h2pgAYVrj+FcXhxQm0irELBJ7ejKR9hTkpgQUcU5khniUlkTkeisKQXCUKUCY326woHF6MC2qxFRQgXGhOEDhSrQZeUhpuQuort2E1Z2OPiGBZdVrWFFTS+XaeuYVL6HM66PCV0/5mvVUCJvVnYlCuCAyaRaWkpoAccVerKVr0WUXIh07cZKh0Tu84jQS5Yjm/eMd+MfZvj6iUix4G6t5/McjnjwJmFnmXUdQhEFc3/bsK3/wUTcXrlwmM9fNq3NT2dO+PbDwdZ+X5Ox0Fhbnc/X6JZ6OZd61QlCPWuS3ymT/C2UA8SjvHDkW+PFe/0UGTnUycuMmPIaKxjoOth6g5+gpNu/e9DfBdeOCzylp0kGRu/5x99Z3DJ7vZvizfsa+fEB13UYKSoto2dOKyhbJuYunA/+Vrqp5pqD/1f1IHce6ePTLI+723+fO56OMXL3NDyM/0rTtLQwpJuobG9C7zHg3VI4LVvn+JegX0jrcTEtMRdrxdjv37t2np+scvd3XOH/yMn1nrguhnZg9DhqbGyipLMMx28WtwS8oFj1nSpQRjdkhCq9d1Ep7IOi1jplMc7qRrKJbWTyzA53Lj79zxYhA1iWJjiZ2jHF5MLrS0CYkC1yBLhftFIsdKePdLjWTOKFhEIkQm5LOn5upQa0t52CWAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Bot service"\n        title=""\n        src="/static/c9dcfa09ee8cc8c2f2392dd2f3a930ef/39c09/bot-service.png"\n        srcset="/static/c9dcfa09ee8cc8c2f2392dd2f3a930ef/680fe/bot-service.png 156w,\n/static/c9dcfa09ee8cc8c2f2392dd2f3a930ef/17474/bot-service.png 312w,\n/static/c9dcfa09ee8cc8c2f2392dd2f3a930ef/39c09/bot-service.png 624w,\n/static/c9dcfa09ee8cc8c2f2392dd2f3a930ef/a2b88/bot-service.png 908w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",p.createElement(a.h4,null,"思路：获取 Pixiv 图片并转发"),"\n",p.createElement(a.p,null,"注意，使用这种方式上传的图片",p.createElement(a.strong,null,"不超过 10 MB"),"。"),"\n",p.createElement(a.p,null,"我们无法直接在 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">bot.sendPhoto()</code>'}})," 方法中使用 Pixiv 源站图片的获取链接，这是因为 Pixiv 设置了反爬虫机制，只接收请求头的 Referer 包含 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://www.pixiv.net/</code>'}})," 的请求。"),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/62dbc84a41dc64b10cc5ba3494ed81c4/5f4af/pixiv-request-referer.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 46.15384615384615%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABJ0AAASdAHeZh94AAABrUlEQVR42lVS2XKjMBDkPzY+gGBscwkQiMPGxkm8TlK5SMpJ7N3K/v9P9M7IDlV56JoWSD2jbhllvcLxzxeub7aYuB48P4IzmRGmms+9ELN5QDXAdO7DtBxYtgvbmWs+Ni9/wLBtE3Up8Ny9Y/9+wOH4D79396iXLQ7UqHvbo9t/4PP4hc/DX0iZww0KJNUdLMfDxWCMwcjCYHiCIUSC6+0ORVkjywuNXJU9l5lCGMUIwoiq6HkQCvgBVYJ/BnOjJKHt7g43u1s8PD7h8ekZL90rute3E3/psNlcYbVaE1o0XNctls0K6/XmVNtW88WigTEa20izElEsYdoO3JmvPQtF2nP2NIySHkJI/d2devpfnGSEXK8NNpYXQZgQYhKSZH6I4cjEr4shVUubPRiamjPYMx7kG/yPwdyw7AlEomjCDHm5QFE3ero0VUjSXCfJm1mUD3yL9uJnoT5lFpSqRlE1UOWSsIDUgZSo6ElxWBE1EGRJTEikohtJfU1umOkAK73mZ3aeMMeSzNYHeBOJpfQ8eMqmaSlpaqAqKEJKqRfUlPdwY/aUfbx0pmCt/4UpHIu1kbwGAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="请求需包含 Referer"\n        title=""\n        src="/static/62dbc84a41dc64b10cc5ba3494ed81c4/39c09/pixiv-request-referer.png"\n        srcset="/static/62dbc84a41dc64b10cc5ba3494ed81c4/680fe/pixiv-request-referer.png 156w,\n/static/62dbc84a41dc64b10cc5ba3494ed81c4/17474/pixiv-request-referer.png 312w,\n/static/62dbc84a41dc64b10cc5ba3494ed81c4/39c09/pixiv-request-referer.png 624w,\n/static/62dbc84a41dc64b10cc5ba3494ed81c4/5f4af/pixiv-request-referer.png 665w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",p.createElement(a.p,null,"因此，我们需要在自己的服务器上构造 Axios 请求，设置 Referer 请求头，然后发送请求向 Pixiv 服务器获取图片，再将图片转为 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">multipart/form-data</code>'}})," 格式发送给 Telegram 会话。"),"\n",p.createElement(a.h2,null,"为 Koa 添加随机获取 Pixiv 图片的接口"),"\n",p.createElement(a.p,null,"Koa 应用程序本身也提供了路由功能，在这里可以很轻松地将获取随机 Pixiv 图片的服务对接到 Koa 上去。"),"\n",p.createElement(a.p,null,"编写路由文件如下："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"koa-router"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> randomGetPixivCollection <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path/to/randomGetPixivCollection"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nrouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/random"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">randomGetPixivCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>ok <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ctx<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>picProxyUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">"Get random Pixiv artwork failed."</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"然而，这里并没有解决前面提到的漫画作品问题，留待用户在跳转后自行操作。"),"\n",p.createElement(a.h2,null,"参考文章"),"\n",p.createElement(a.ul,null,"\n",p.createElement(a.li,null,p.createElement(a.a,{href:"https://blog.csdn.net/weixin_45826022/article/details/109406389"},"爬取 pixiv 每日推荐")),"\n"))}var o=function(n){void 0===n&&(n={});const{wrapper:a}=Object.assign({},(0,t.R)(),n.components);return a?p.createElement(a,n,p.createElement(e,n)):e(n)},c=s(197),l=s(4353),u=s.n(l),i=s(4794),r=s(6947),k=s(4017),d=s(1042),m=s(1038);const g={a:n=>{let{href:a="",children:s}=n;const t=!(null!=a&&a.startsWith("#")),e=t?a:`#${encodeURIComponent(a.slice(1))}`;return p.createElement("a",{href:e,target:t?"_blank":void 0,rel:"noreferrer"},s)},img:n=>{const{alt:a="The author is too lazy to give an alt",src:s,...t}=n;return p.createElement("a",{href:s,"data-fancybox":"gallery","data-caption":a},p.createElement("img",Object.assign({src:s,alt:a},t)))},Card:r.A,Link:i.Link},y=n=>{let{children:a,data:s}=n;const{mdx:{frontmatter:{title:e,date:o,updated:l,categories:i,tags:r,timeliness:d=!0}}}=s,y=p.useRef(null),f=u()(o),h=l?u()(l):f,x=u()().diff(h,"days");return p.useEffect((()=>{var n;const a=null===(n=y.current)||void 0===n?void 0:n.querySelectorAll("a.gatsby-resp-image-link");return null==a||a.forEach((n=>{const a=n.children.item(1);n.setAttribute("data-fancybox","gallery"),n.setAttribute("data-caption",a.alt)})),c.lX.bind("[data-fancybox]"),()=>c.lX.unbind("[data-fancybox]")}),[]),p.createElement("div",{className:"mx-auto flex max-w-xl flex-col gap-y-12"},p.createElement("div",{className:"flex flex-col gap-4"},(null==i?void 0:i.length)&&p.createElement(k.A,{name:i[0],className:"item-selectable"}),p.createElement("h1",{className:"text-3xl font-bold"},e),p.createElement("div",{className:"item-secondary flex flex-col gap-2 lg:flex-row"},o&&p.createElement("span",{title:`首次发布于：${f.toString()}\n最后更新于：${h.toString()}`},f.format("MM 月 DD 日 YYYY 年")),(null==r?void 0:r.length)&&p.createElement("div",{className:"flex flex-1 flex-wrap gap-2 lg:before:content-['•']"},r.map((n=>p.createElement(m.A,{key:n,name:n,className:"item-secondary item-selectable"})))))),p.createElement("article",{ref:y,className:"heti post-entry"},d&&x>365&&p.createElement("blockquote",{className:"border-l-4 border-orange-400"},"这是一篇",p.createElement("strong",null,"最后更新于 ",x," 天前"),"的博客，内容可能随着时间的推移而变得不再适用，建议您仔细评估信息的有效性。"),p.createElement(t.x,{components:g},a)))},f=n=>{let{data:a}=n;return p.createElement(d.A,{title:String(a.mdx.frontmatter.title)})};function h(n){return p.createElement(y,n,p.createElement(o,n))}}}]);
//# sourceMappingURL=component---src-templates-post-tsx-content-file-path-blog-posts-random-get-me-a-picture-mdx-e33fa886af99fca62058.js.map