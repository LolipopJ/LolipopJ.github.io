"use strict";(self.webpackChunkhomepage=self.webpackChunkhomepage||[]).push([[3412],{9108:function(e,n,a){a.r(n),a.d(n,{Head:function(){return b},default:function(){return E}});var t=a(8453),l=a(6540);function s(e){const n=Object.assign({p:"p",h2:"h2",span:"span",blockquote:"blockquote",h3:"h3",h4:"h4",a:"a",strong:"strong",img:"img",ul:"ul",li:"li"},(0,t.R)(),e.components);return l.createElement(l.Fragment,null,l.createElement(n.p,null,"这些天在阿里云的 ECS 服务器上捣鼓自己的东西，通过 Nginx 转发请求，允许以域名的方式访问到笔者开设的不同站点、服务。"),"\n",l.createElement(n.p,null,"笔者撰写本篇文章，晒晒在服务器上都做了哪些工作，也希望能为您提供一些启发。"),"\n",l.createElement(n.h2,null,"安装最新版本的 Nginx"),"\n",l.createElement(n.p,null,"笔者使用的服务器为 CentOS 7 系统，默认的 yum 源中包含的 Nginx 版本为 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">1.20.1</code>'}}),"（2021-05-21）。"),"\n",l.createElement(n.p,null,"更新 yum 源，添加 Nginx 的官方源："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</code></pre></div>'}}),"\n",l.createElement(n.p,null,"确认 Nginx 官方源拉取成功："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ yum repolist\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n * centos-sclo-rh: mirrors.ustc.edu.cn\n * centos-sclo-sclo: mirrors.ustc.edu.cn\nnginx                                                                        <span class="token operator">|</span> <span class="token number">2.9</span> kB  00:00:00\nnginx/x86_64/primary_db                                                      <span class="token operator">|</span>  <span class="token number">91</span> kB  00:00:00\nrepo <span class="token function">id</span>                            repo name                                                  status\nnginx/x86_64                       nginx repo                                                   <span class="token number">338</span></code></pre></div>'}}),"\n",l.createElement(n.p,null,"重新安装 Nginx："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">yum <span class="token function">install</span> nginx</code></pre></div>'}}),"\n",l.createElement(n.p,null,"查看当前的 Nginx 版本："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ nginx <span class="token parameter variable">-v</span>\nnginx version: nginx/1.26.0</code></pre></div>'}}),"\n",l.createElement(n.h2,null,"提供静态内容服务"),"\n",l.createElement(n.blockquote,null,"\n",l.createElement(n.p,null,"Web 服务器的一个重要任务是提供文件（比如图片或者静态 HTML 页面）服务。"),"\n"),"\n",l.createElement(n.h3,null,"静态站点服务"),"\n",l.createElement(n.h4,null,"部署静态站点"),"\n",l.createElement(n.p,null,"要对外提供静态站点非常简单，只需要将站点的静态资源放置在服务器上，再通过 Nginx 暴露出去。"),"\n",l.createElement(n.p,null,"一个简单的例子是："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="conf"><pre class="language-conf"><code class="language-conf"># /etc/nginx/nginx.conf\nhttp {\n  server {\n    listen 443 ssl;\n    http2 on;\n\n    ssl_certificate /etc/letsencrypt/live/towind.fun/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/towind.fun/privkey.pem;\n\n    server_name towind.fun www.towind.fun blog.towind.fun;\n    root /var/www/towind.fun/blog;\n  }\n}</code></pre></div>'}}),"\n",l.createElement(n.p,null,"通过上面的配置，笔者只需要将自己博客的静态资源放置在 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/var/www/towind.fun/blog</code>'}})," 目录，就可以通过 ",l.createElement(n.a,{href:"https://towind.fun"},"https://towind.fun")," 等域名访问到啦。"),"\n",l.createElement(n.p,null,"当然，笔者不希望有这么多个域名显示完全一样的东西，我们可以配置域名跳转，将请求重定向到一个域名上："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="conf"><pre class="language-conf"><code class="language-conf"># /etc/nginx/nginx.conf\nhttp {\n  server {\n    # ...https configurations\n    server_name towind.fun www.towind.fun;\n    rewrite ^/(.*)$ https://blog.towind.fun/$1 permanent;\n  }\n}</code></pre></div>'}}),"\n",l.createElement(n.p,null,"现在，访问 ",l.createElement(n.a,{href:"https://towind.fun"},"https://towind.fun")," 和 ",l.createElement(n.a,{href:"https://www.towind.fun"},"https://www.towind.fun")," 时，浏览器将自动 301 重定向到 ",l.createElement(n.a,{href:"https://blog.towind.fun%E3%80%82"},"https://blog.towind.fun。")),"\n",l.createElement(n.p,null,"此外，笔者为了更好的 SEO，缩短了链接的级数，即从 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/YYYY/MM/DD/blog-title</code>'}})," -> ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/YYYYMMDD/blog-title</code>'}}),"。那么就需要将过去被搜索引擎收录的链接，重定向到新的链接，避免用户访问到 404 页面。可以编写配置如下："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="conf"><pre class="language-conf"><code class="language-conf"># /etc/nginx/nginx.conf\nhttp {\n  server {\n    # ...https configurations\n    server_name blog.towind.fun;\n    rewrite &quot;^/(\\d{4})/(\\d{2})/(\\d{2})/(.+)$&quot; /$1$2$3/$4 permanent;\n  }\n}</code></pre></div>'}}),"\n",l.createElement(n.p,null,"通过简单的正则匹配即可实现链接重定向。"),"\n",l.createElement(n.h4,null,"抽取通用配置"),"\n",l.createElement(n.p,null,"Nginx 配置中存在大量重复的内容，我们可以将这些内容提取出来，单独放置在某个目录下，通过 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">include</code>'}})," 指令引入。"),"\n",l.createElement(n.p,null,"例如对于 HTTPS 配置，可以提取为："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="conf"><pre class="language-conf"><code class="language-conf"># /etc/nginx/conf.shared.d/https.conf\nlisten 443 ssl;\nhttp2 on;\n\nssl_certificate /etc/letsencrypt/live/towind.fun/fullchain.pem;\nssl_certificate_key /etc/letsencrypt/live/towind.fun/privkey.pem;</code></pre></div>'}}),"\n",l.createElement(n.p,null,"在需要的 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">server</code>'}})," 块中引入："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="conf"><pre class="language-conf"><code class="language-conf"># /etc/nginx/nginx.conf\nhttp {\n  server {\n    include /etc/nginx/conf.shared.d/https.conf;\n    server_name blog.towind.fun;\n  }\n}</code></pre></div>'}}),"\n",l.createElement(n.p,null,"又如希望用户在访问 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">http://</code>'}})," 时自动跳转到 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://</code>'}}),"，可以提取为："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="conf"><pre class="language-conf"><code class="language-conf"># /etc/nginx/conf.shared.d/http.conf\nlisten 80;\nreturn 301 https://$http_host$request_uri;</code></pre></div>'}}),"\n",l.createElement(n.p,null,"像这样抽取出不同服务里重复的配置，能够有效地降低后续的维护成本。"),"\n",l.createElement(n.h4,null,"静态站点持续部署"),"\n",l.createElement(n.p,null,"由于静态站点的源码均托管在 Github 上，当新的代码提交后，希望能够自动更新服务器上的静态资源内容。笔者通过 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">crontab</code>'}})," 配置定时任务来实现这个需求："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token number">0</span> <span class="token number">0,12</span>,18 * * * /path/to/update-blog.sh <span class="token operator">>></span> /path/to/update-blog.log <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span></code></pre></div>'}}),"\n",l.createElement(n.p,null,"上面的配置表示：在每天的 0, 12, 18 点整自动执行更新博客的脚本 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/path/to/update-blog.sh</code>'}}),"，执行的标准输出和错误输出重定向到指定日志文件 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/path/to/update-blog.log</code>'}}),"。"),"\n",l.createElement(n.p,null,"至于更新脚本的实现则颇为简单，如果构建后的静态文件已经存放到了 Github 仓库的某个分支，那么只需要到本地的目录执行 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">git pull</code>'}})," 命令即可。例如："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># /path/to/update-blog.sh</span>\n<span class="token builtin class-name">cd</span> /var/www/towind.fun/blog\n<span class="token function">git</span> pull</code></pre></div>'}}),"\n",l.createElement(n.p,null,"如果没有存放构建后的静态文件，或构建后的静态文件无法直接使用（例如 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">bashPath</code>'}})," 不同），那么额外执行一次构建命令即可。例如："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># /path/to/update-example.sh</span>\n<span class="token builtin class-name">cd</span> /path/to/example\n<span class="token function">git</span> pull\n<span class="token function">npm</span> run build</code></pre></div>'}}),"\n",l.createElement(n.p,null,"考虑到我们不会在服务器上编写代码并推送，可以使用 HTTPS 协议的远程地址，而不用经过 SSH 验证："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /path/to/example\n<span class="token comment"># Change from git@github.com:username/example.git</span>\n<span class="token function">git</span> remote set-url origin https://github.com/username/example.git</code></pre></div>'}}),"\n",l.createElement(n.h3,null,"静态站点访问性能优化"),"\n",l.createElement(n.p,null,"针对静态站点的访问性能优化，笔者主要配置了 Nginx 中",l.createElement(n.strong,null,"压缩"),"和",l.createElement(n.strong,null,"缓存"),"两部分内容，另外关闭了负优化的 Cloudflare CDN。"),"\n",l.createElement(n.h4,null,"Gzip 压缩"),"\n",l.createElement(n.p,null,"配置 Nginx 启用 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">gzip</code>'}})," 压缩，能够",l.createElement(n.strong,null,"显著减少"),"发送给客户端的静态文件体积。配置内容如下："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="conf"><pre class="language-conf"><code class="language-conf"># /etc/nginx/nginx.conf\nhttp {\n  # 启用 gzip 压缩功能\n  gzip on;\n  # 压缩文件的最小大小为 10KB\n  gzip_min_length 10K;\n  # 压缩等级为 6。等级越低压缩速度越快，文件压缩比越小；反之速度越慢，压缩比越大\n  gzip_comp_level 6;\n  # 压缩的 MIME 类型\n  gzip_types text/plain text/css application/json text/javascript application/javascript application/x-javascript text/xml application/xml application/xml+rss;\n}</code></pre></div>'}}),"\n",l.createElement(n.p,null,"对于原来 1151KB 的脚本文件："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ ll --block-size<span class="token operator">=</span>k <span class="token operator">|</span> <span class="token function">grep</span> main.js\n-rw-r--r-- <span class="token number">1</span> root root 1151K main.js</code></pre></div>'}}),"\n",l.createElement(n.p,null,"压缩后发送给客户端只有 442KB 大小，减少了大约 62% 的体积："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/e722279cc3ed1dedecc99b42401b0506/eafa0/assets-gzip.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 30.76923076923077%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWElEQVR42j2P627TQBCF/RSlJWmVi+Mk9t5y8a2OnbgNJCGl8KOqBEIFClJegPf/GDuIH6PZc843s7tenhmSRcrD9h0f7mr0eMxCReyqFZs0Ro18UmvYr0vKeN7qYjHnUFdkTqODEessEb1mqSZ46fuCvPpEkt5TFjXOLtGhgKHBKteWiSw60jh9PhvJmnymm1yyqcbMljh5iDfpvCHqXRD2LkmCa6zfRQ+7RP23GOmq30ENOq1WUk121h304F/Wu5Kf9XGTId5xnTELegJ0ZdkNdnjdLtksDSs7pY4tK9d0x2N9y/TmklSNWM1CtumcomUMdWLbOe90yPh1LPm+y6Vu+XkoeKocP/YF37YJL+I33uux4s/Xj/x+KFv+9LjhRZjTPuf5yxO751c+xz5eMh1QmDG5DshVQCa3J+GQNPTPPfLPfjQSZvyfzcRr8ky42IRY44gnff4Crie/0py7cj0AAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="assets-gzip"\n        title=""\n        src="/static/e722279cc3ed1dedecc99b42401b0506/39c09/assets-gzip.png"\n        srcset="/static/e722279cc3ed1dedecc99b42401b0506/680fe/assets-gzip.png 156w,\n/static/e722279cc3ed1dedecc99b42401b0506/17474/assets-gzip.png 312w,\n/static/e722279cc3ed1dedecc99b42401b0506/39c09/assets-gzip.png 624w,\n/static/e722279cc3ed1dedecc99b42401b0506/6d2da/assets-gzip.png 936w,\n/static/e722279cc3ed1dedecc99b42401b0506/eafa0/assets-gzip.png 939w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",l.createElement(n.p,null,"在启用 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">gzip</code>'}})," 压缩之前，笔者从访问自己的博客到文章内容显示出来，要等待大约 5 秒钟的时间。说实话，若不是自己家的站点，早已不耐烦地 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ctrl + w</code>'}})," 关闭了。如今只需大约 2 秒钟的时间，给访问体验带来了质的提升。"),"\n",l.createElement(n.p,null,"实际观察 Github Pages 的网络响应就会发现，返回给客户端的脚本或样式等文件也都经过了压缩（",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">br</code>'}})," 编码），可惜笔者到现在才知道去配置，知识积累的重要性不言而喻。"),"\n",l.createElement(n.h4,null,"Cache-Control 缓存"),"\n",l.createElement(n.p,null,"配置 Nginx 启用 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">Cache-Control</code>'}})," 缓存，由客户端控制是否使用本地已缓存的文件。配置内容如下："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="conf"><pre class="language-conf"><code class="language-conf"># /etc/nginx/conf.shared.d/cache.conf\n# 协商缓存验证 .html 文件\nlocation ~* .(html)$ {\n  add_header Cache-Control &quot;no-cache&quot;;\n}\n# 缓存 .css, .js 文件，缓存过期时间为 1 天，缓存过期时确保获取到最新文件\nlocation ~* .(css|js)$ {\n  add_header Cache-Control &quot;public, must-revalidate, max-age=86400&quot;;\n}\n# 缓存图片、视频等文件，缓存过期时间为 1 年，不得对文件进行转换\nlocation ~* .(png|jpg|jpeg|gif|ico|svg|mp4|ogg|ogv|webm|htc|xml|woff|gz|zip|7z)$ {\n  add_header Cache-Control &quot;public, no-transform, max-age=31536000&quot;;\n}</code></pre></div>'}}),"\n",l.createElement(n.h4,null,"CDN 服务"),"\n",l.createElement(n.p,null,"笔者使用 Cloudflare 作为 DNS 解析服务器，但考虑到站点面向的用户主要来自中国，且访问量不会很大，因此关闭了 Cloudflare 提供的 DNS 代理服务。"),"\n",l.createElement(n.img,{src:"https://i.imgur.com/9H8utju.png",alt:"cloudflare-cdn-speed-down-for-me"}),"\n",l.createElement(n.h3,null,"静态文件服务"),"\n",l.createElement(n.p,null,"笔者也对外提供的静态文件下载的服务，配置形如："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="conf"><pre class="language-conf"><code class="language-conf"># /etc/nginx/conf.d/download.conf\nserver {\n  include /etc/nginx/conf.shared.d/http.conf;\n  server_name download.towind.fun;\n}\n\nserver {\n  include /etc/nginx/conf.shared.d/https.conf;\n  server_name download.towind.fun;\n  root /var/www/towind.fun/download;\n  # 允许浏览静态文件目录\n  autoindex on;\n  # 显示静态文件大小\n  autoindex_exact_size on;\n  # 显示文件时间为服务器时间\n  autoindex_localtime on;\n  # 设置字符集为 utf-8，避免中文乱码\n  charset utf-8;\n}</code></pre></div>'}}),"\n",l.createElement(n.p,null,"上面的配置表明：笔者将对外提供下载的静态文件放置在服务器的 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/var/www/towind.fun/download</code>'}})," 目录下；当访问 ",l.createElement(n.a,{href:"https://download.towind.fun"},"https://download.towind.fun")," 时，就可以看见所有可下载的静态文件。"),"\n",l.createElement(n.h2,null,"提供代理服务器"),"\n",l.createElement(n.blockquote,null,"\n",l.createElement(n.p,null,"Nginx 的一个常见用途是作为一个代理服务器，作用是接收请求并转发给被代理的服务器，从中取得响应，并将其发送回客户端。"),"\n"),"\n",l.createElement(n.h3,null,"访问内网服务"),"\n",l.createElement(n.p,null,"笔者将一些服务部署在了没有公网 IP 地址的内网服务器上，为了能通过域名访问到这些服务，首先使用了 frp 进行内网穿透：将拥有公网 IP 地址的服务器（公网服务器）作为 frp 服务端，将内网服务器作为 frp 客户端即可。"),"\n",l.createElement(n.p,null,"配置 Nginx，将特定域名的请求转发到对应的 frp 服务端端口："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="conf"><pre class="language-conf"><code class="language-conf"># /etc/nginx/conf.d/xxx.conf\nserver {\n  include /etc/nginx/conf.shared.d/https.conf;\n  server_name xxx.towind.fun;\n  location = / {\n    proxy_pass http://127.0.0.1:15244;\n  }\n}</code></pre></div>'}}),"\n",l.createElement(n.p,null,"上面的配置表示：当通过 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://xxx.towind.fun</code>'}})," 访问公网服务器时，请求将转发至本地的 15244 端口，再经由 frp 访问到内网服务器上对应的服务。"),"\n",l.createElement(n.h3,null,"内网服务访问性能优化"),"\n",l.createElement(n.p,null,"Nginx 提供了服务端的 Proxy 缓存功能，如果从内网服务器返回的响应头上包含缓存控制的信息，Nginx 将自动缓存资源到公网服务器，而无需每次都去请求内网服务器。"),"\n",l.createElement(n.p,null,"核心的配置内容如下："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="conf"><pre class="language-conf"><code class="language-conf"># /etc/nginx/nginx.conf\nhttp {\n  proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=defaultcache:10m max_size=1g;\n\n  server {\n    proxy_cache defaultcache;\n    # （非必要）响应头添加自定义的 Nginx-Proxy-Cache 字段，如果值为 HIT 则表示命中了公网服务器本地的缓存\n    add_header Nginx-Proxy-Cache $upstream_cache_status;\n  }\n}</code></pre></div>'}}),"\n",l.createElement(n.p,null,"上面的配置表示："),"\n",l.createElement(n.ul,null,"\n",l.createElement(n.li,null,"缓存文件保存在 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/var/cache/nginx</code>'}})," 目录。"),"\n",l.createElement(n.li,null,"缓存文件使用 2 级目录存储，第一级目录包含最多 16^1 个文件夹，第二级目录包含最多 16^2 个文件夹。即总共最多包含 16^1 * 16^2 = 4096 个文件夹。"),"\n",l.createElement(n.li,null,"在共享内存中设置了一块别名为 ",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">defaultcache</code>'}}),"，大小为 10MB 的存储区域，用于存储 key 字符串。有助于 Nginx 快速判断请求是否命中本地的缓存。"),"\n",l.createElement(n.li,null,"缓存文件占用的最大空间为 1GB。达到配额时，Nginx 会自动删除掉使用频率最低的缓存文件。"),"\n"),"\n",l.createElement(n.p,null,"这样可以有效降低内网服务器（源服务器）的负担。"),"\n",l.createElement(n.p,null,"一个命中 Proxy 缓存的例子如下："),"\n",l.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/0d5bca22380169f48912d3374b2af54c/2c95d/proxy-cache-hit.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 51.28205128205129%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB5ElEQVR42m1Sy3KbQBDUfzi2HiABgmWB5bUgwIskkIIiJfYtqRxSuTn/f+4MG0tlp3zommJqpunu2UmXeMhcA9Izkbsm+irDcxXgnFoYMpewxpBTlS6OqY1DQogtKH+O9hVbvsAuMLAPl5j86gq8PPf4Q/h9avDUK/z8ekLmWXBmd1jP7xAsZ6gjhjJYYxO52IQemtgnMKgs1H2X5nxrgcnnLMLQZLi0Bc6PEn1T4vv5qJdsImTGFCEzsVc5cuYgtA3w1fyGgEjG6hkP4JaByWi1Fj4SsiscA7u6wI/LgMMmQ8psGpwicBbo6KfbXKDga937H+xKWHELXZmQIhc+NRuZ4Etboi8EKbLgLT4hXM1QcgfSt8CXDxq++R7MuNdqJ0PKcKxzfNtV2OcRVJHipEpUlFXBbSJdgY1LROLqCO71T8b6IWEb2tjJGB0p8qmpigxPB4VdEdMBGBHNKDcTTRJAkt0RNR1EOKbOjZlTjVuGNTNomKNNOSJrDkWWh0ZiqHIowbSqhJbH70ZwIqNZOqSkCK5k7wj3caAtX7ZkWUZoFdXDFjEdQKQhvMBFSOpataEnEmk3I+H4XCK6+FXljbAR/zKshAdhk0JVY7gckZcpJF3aJ9sjoWo3+tn4r8tv1b0l/Aui1jvVjLpSmQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="assets-gzip"\n        title=""\n        src="/static/0d5bca22380169f48912d3374b2af54c/39c09/proxy-cache-hit.png"\n        srcset="/static/0d5bca22380169f48912d3374b2af54c/680fe/proxy-cache-hit.png 156w,\n/static/0d5bca22380169f48912d3374b2af54c/17474/proxy-cache-hit.png 312w,\n/static/0d5bca22380169f48912d3374b2af54c/39c09/proxy-cache-hit.png 624w,\n/static/0d5bca22380169f48912d3374b2af54c/6d2da/proxy-cache-hit.png 936w,\n/static/0d5bca22380169f48912d3374b2af54c/2c95d/proxy-cache-hit.png 1099w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}))}var c=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,t.R)(),e.components);return n?l.createElement(n,e,l.createElement(s,e)):s(e)},r=a(197),o=a(4353),g=a.n(o),i=a(4810),p=a(6947),d=a(4017),u=a(1042),m=a(1038);const h={a:e=>{let{href:n="",children:a}=e;const t=!(null!=n&&n.startsWith("#")),s=t?n:`#${encodeURIComponent(n.slice(1))}`;return l.createElement("a",{href:s,target:t?"_blank":void 0,rel:"noreferrer"},a)},img:e=>{const{alt:n="The author is too lazy to give an alt",src:a,...t}=e;return l.createElement("a",{href:a,"data-fancybox":"gallery","data-caption":n},l.createElement("img",Object.assign({src:a,alt:n},t)))},Card:p.A,Link:i.N_},f=e=>{let{children:n,data:a}=e;const{mdx:{frontmatter:{title:s,date:c,updated:o,categories:i,tags:p,timeliness:u=!0}}}=a,f=l.useRef(null),b=g()(c),E=o?g()(o):b,x=g()().diff(E,"days");return l.useEffect((()=>{var e;const n=null===(e=f.current)||void 0===e?void 0:e.querySelectorAll("a.gatsby-resp-image-link");return null==n||n.forEach((e=>{const n=e.children.item(1);e.setAttribute("data-fancybox","gallery"),e.setAttribute("data-caption",n.alt)})),r.lX.bind("[data-fancybox]"),()=>r.lX.unbind("[data-fancybox]")}),[]),l.createElement("div",{className:"mx-auto flex max-w-xl flex-col gap-y-12"},l.createElement("div",{className:"flex flex-col gap-4"},(null==i?void 0:i.length)&&l.createElement(d.A,{name:i[0],className:"item-selectable"}),l.createElement("h1",{className:"text-3xl font-bold"},s),l.createElement("div",{className:"item-secondary flex flex-col gap-2 lg:flex-row"},c&&l.createElement("span",{title:`首次发布于：${b.toString()}\n最后更新于：${E.toString()}`},b.format("MM 月 DD 日 YYYY 年")),(null==p?void 0:p.length)&&l.createElement("div",{className:"flex flex-1 flex-wrap gap-2 lg:before:content-['•']"},p.map((e=>l.createElement(m.A,{key:e,name:e,className:"item-secondary item-selectable"})))))),l.createElement("article",{ref:f,className:"heti post-entry"},u&&x>365&&l.createElement("blockquote",{className:"border-l-4 border-orange-400"},"这是一篇",l.createElement("strong",null,"最后更新于 ",x," 天前"),"的博客，内容可能随着时间的推移而变得不再适用，建议您仔细评估信息的有效性。"),l.createElement(t.x,{components:h},n)))},b=e=>{let{data:n}=e;return l.createElement(u.A,{title:String(n.mdx.frontmatter.title)})};function E(e){return l.createElement(f,e,l.createElement(c,e))}}}]);
//# sourceMappingURL=component---src-templates-post-tsx-content-file-path-blog-posts-nginx-services-mdx-374b683c85ae90f1e6c6.js.map