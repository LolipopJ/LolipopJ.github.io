"use strict";(self.webpackChunkhomepage=self.webpackChunkhomepage||[]).push([[9017],{9941:function(n,s,a){a.r(s),a.d(s,{Head:function(){return f},default:function(){return w}});var t=a(8453),e=a(6540);function p(n){const s=Object.assign({p:"p",span:"span",h2:"h2",strong:"strong",h3:"h3",a:"a",ol:"ol",li:"li",blockquote:"blockquote",ul:"ul"},(0,t.R)(),n.components);return e.createElement(e.Fragment,null,e.createElement(s.p,null,"业务上有这样一个需求：「若用户不活跃超过 12 个小时，自动退出当前页面，并切换路由到首页」。"),"\n",e.createElement(s.p,null,"想都没想，直接在 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">useEffect()</code>'}})," 里用 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">setTimeout()</code>'}})," 定个时，12 个小时后触发相应跳转事件："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="tsx"><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">LEAVE_PAGE_COUNTDOWN</span> <span class="token operator">=</span> <span class="token number">12</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// 12h</span>\n\n<span class="token comment">/** 离开页面的方法 */</span>\n<span class="token keyword">const</span> <span class="token function-variable function">leavePage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...离开当前页面的业务代码</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 初始化时设置定时器</span>\n    <span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">leavePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">LEAVE_PAGE_COUNTDOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 页面卸载时清除定时器</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"没想到，今天上班来，切换到没有关闭的标签页，发现还在当前页面，掐指一算怎么也有 12 个小时了，这是怎么一回事儿……？"),"\n",e.createElement(s.p,null,"昨天晚上走的时候还在和前辈探讨页面卸载（",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">unload</code>'}}),"）事件与浏览器后台优化的坑，于是首先就想到了可能是浏览器优化的缘故，导致定时器没有正常执行。以「setTimeout」和「后台失效」为搜索关键词，很快找到了原因和优化解决方案。"),"\n",e.createElement(s.h2,null,"失效原因"),"\n",e.createElement(s.p,null,"系现代浏览器为了节能与性能优化做的处理。"),"\n",e.createElement(s.p,null,"若页面处于非激活的状态，那么此页面中通过 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">setTimeout()</code>'}})," 或 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">setInterval()</code>'}})," 创建的定时器可能会",e.createElement(s.strong,null,"停止工作"),"或",e.createElement(s.strong,null,"以较慢的速度工作"),"。页面的非激活状态包括不限于：切换到其它标签页、最小化窗口和息屏等。在移动端，这样的性能优化尤为常见。"),"\n",e.createElement(s.p,null,"因此会发生另外一种常见的现象：如果浏览器页面里有一个基于 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">setInterval()</code>'}})," 实现的计时器，当用户切换页面或回到桌面后，计时器将停止计时或计时频率减慢，导致计时功能异常。"),"\n",e.createElement(s.h2,null,"基于 SetTimeout / SetInterval 的解决方案"),"\n",e.createElement(s.p,null,"定时器失效带来的最直接影响是：JavaScript 代码不再能够正确获取定时器",e.createElement(s.strong,null,"计划执行的时间"),"或",e.createElement(s.strong,null,"已经执行的次数"),"。"),"\n",e.createElement(s.p,null,"一个很容易想到的解决方案是，当页面切回前台时，重新校准 SetTimeout 定时器时间。"),"\n",e.createElement(s.h3,null,"使用 SetTimeout + 监听 visibilitychange 事件"),"\n",e.createElement(s.p,null,"通过监听窗口的 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">visibilitychange</code>'}})," 事件（兼容性",e.createElement(s.a,{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Document/visibilitychange_event#browser_compatibility"},"见于此"),"），可以判断页面是否切换到前台："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"visibilitychange"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>visibilityState<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> <span class="token string">"visible"</span><span class="token operator">:</span>\n      <span class="token comment">// 当前页面被切换到前台（可见或部分可见）</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> <span class="token string">"hidden"</span><span class="token operator">:</span>\n      <span class="token comment">// 当前页面被切换到后台（不可见）</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> <span class="token string">"prerender"</span><span class="token operator">:</span>\n      <span class="token comment">// 当前页面被预渲染，且用户不可见</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> <span class="token string">"unloaded"</span><span class="token operator">:</span>\n      <span class="token comment">// 当前页面被卸载</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"对于这次业务上遇到的 12 小时自动切换路由这一需求，对即时性和定时器的精度要求并不高，且重新校准的逻辑容易编写，可以码出 React 代码如下："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="tsx"><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">LEAVE_PAGE_TIMESTAMP</span> <span class="token operator">=</span> <span class="token string">"__leave_page_timestamp"</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">LEAVE_PAGE_COUNTDOWN</span> <span class="token operator">=</span> <span class="token number">12</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>\n\n<span class="token comment">/** 离开页面的方法 */</span>\n<span class="token keyword">const</span> <span class="token function-variable function">leavePage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...离开当前页面的业务代码</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">/** 获得倒计时时间 */</span>\n<span class="token keyword">const</span> getLeavePageCountdown <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> timestamp <span class="token operator">=</span> sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token constant">LEAVE_PAGE_TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> countdown <span class="token operator">=</span> timestamp\n    <span class="token operator">?</span> <span class="token function">Number</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token operator">:</span> <span class="token constant">LEAVE_PAGE_COUNTDOWN</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> countdown <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> countdown <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">/** 获得离开页面定时器 */</span>\n<span class="token keyword">const</span> getLeavePageTimeout <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>Timeout <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">leavePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getLeavePageCountdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 初始化时设置离开页面的时间</span>\n    sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>\n      <span class="token constant">LEAVE_PAGE_TIMESTAMP</span><span class="token punctuation">,</span>\n      <span class="token function">String</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">LEAVE_PAGE_COUNTDOWN</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 页面卸载时清除 SessionStorage</span>\n      sessionStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token constant">LEAVE_PAGE_TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 初始化时设置定时器</span>\n    <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token function">getLeavePageTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">onWindowVisibilityChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 重新校准定时器</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>visibilityState <span class="token operator">===</span> <span class="token string">"visible"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 清除已有定时器</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 设置新的定时器</span>\n        timer <span class="token operator">=</span> <span class="token function">getLeavePageTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token comment">// 添加页面可见性变化监听器</span>\n    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"visibilitychange"</span><span class="token punctuation">,</span> onWindowVisibilityChange<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 页面卸载时清除定时器和监听器</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"visibilitychange"</span><span class="token punctuation">,</span> onWindowVisibilityChange<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"上面的代码做了这些事情："),"\n",e.createElement(s.ol,null,"\n",e.createElement(s.li,null,"当用户进入到页面时，在 SessionStorage 存储了应当执行业务需求的时间戳。"),"\n",e.createElement(s.li,null,"启动一个定时器，在指定时间以后执行业务需求。"),"\n",e.createElement(s.li,null,"启动一个监听器，当页面可见性发生改变，变为「可见」时，校准定时器：清除已有的定时器，然后启动一个新的定时器，在新的指定时间以后执行业务需求。其中，新的指定时间由存储的时间戳和当前的时间计算得来。"),"\n"),"\n",e.createElement(s.h3,null,"使用 SetInterval 轮训"),"\n",e.createElement(s.p,null,"哇噻，有够麻烦。换一种思路，使用轮训的实现方式，基于 SetInterval 不断比较当前的时间戳和应当离开页面的时间戳，若当前的时间戳大于应当离开页面的时间戳，执行离开页面的业务方法就好了。这种实现方式无需费力地重新校准时间，是一个讨巧的选择："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="tsx"><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">LEAVE_PAGE_COUNTDOWN</span> <span class="token operator">=</span> <span class="token number">12</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>\n\n<span class="token comment">/** 离开页面的方法 */</span>\n<span class="token keyword">const</span> <span class="token function-variable function">leavePage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...离开当前页面的业务代码</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 获取执行业务需求的时间戳</span>\n    <span class="token keyword">const</span> timestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">LEAVE_PAGE_COUNTDOWN</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 初始化时设置轮询器</span>\n    <span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">>=</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">leavePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 页面卸载时清除轮询器</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.h3,null,"似乎都不太优雅"),"\n",e.createElement(s.p,null,"但是，以上的实现都会导致一些体验上的问题：用户从后台切换到该页面时，若超过了 12 个小时，定时器或轮询器一运行，唰的一下子路由发生改变，用户会感到非常奇怪。"),"\n",e.createElement(s.p,null,"虽然加上一些 Notification 告知刚刚发生了啥会减少用户的不适，但终究我们还是会希望浏览器能",e.createElement(s.strong,null,"完全正常"),"地运行定时器方法（这是我们不想要被后台优化的功能），而不需要做这些带来额外开销且",e.createElement(s.strong,null,"不符合直觉"),"的适配（下一任程序员看到代码就头疼）。"),"\n",e.createElement(s.p,null,"此外，这样的做法并不能满足对",e.createElement(s.strong,null,"准确度要求高"),"的定时器需求。"),"\n",e.createElement(s.p,null,"基于以上需求，本文的主角 ",e.createElement(s.strong,null,"Web Worker")," 给出了现代、普适的解决方案。"),"\n",e.createElement(s.h2,null,"生产实践的解决方案：使用 Web Worker"),"\n",e.createElement(s.blockquote,null,"\n",e.createElement(s.p,null,"Web Worker 为 Web 内容在后台线程中运行脚本提供了一种简单的方法。线程可以执行任务而不干扰用户界面……一个 worker 是使用一个构造函数创建的一个对象运行一个命名的 JavaScript 文件：这个文件包含将在工作线程中运行的代码；workers 运行在另一个全局上下文中，不同于当前的 window。"),"\n",e.createElement(s.p,null,"-- ",e.createElement(s.a,{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers"},"MDN")),"\n"),"\n",e.createElement(s.p,null,"Web Worker 能够为 JavaScript 创建多线程环境，允许将主线程中的任务分配给 Worker 线程处理，主线程和 Worker 线程之间可以进行通信。当遇到计算密集型或高延迟的任务时，常使用 Web Worker 进行性能优化：在 Worker 线程进行复杂的计算操作，进而避免主线程阻塞或卡死。"),"\n",e.createElement(s.p,null,"Worker 线程一旦创建成功，将",e.createElement(s.strong,null,"始终运行"),"，不会被主线程上的活动中断。但是，这也意味着 Worker 使用完毕后应当立即关闭，避免造成额外的系统开销。"),"\n",e.createElement(s.p,null,"只需要了解 Web Worker 的基本用法，就能很好地实现本次业务上的需求。将 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">setTimeout()</code>'}})," 方法移动到 Worker 中去，只要浏览器不关闭，Worker 将保持运行的状态，在正确的时机向主线程返回离开页面的消息。"),"\n",e.createElement(s.h3,null,"Webpack 的方式"),"\n",e.createElement(s.p,null,"首先编写一个 Web Worker 脚本文件 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">leavePage.worker.js</code>'}}),"："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> timer<span class="token punctuation">;</span>\n\nself<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// console.log("Received message from main thread", event.data);</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 向主线程发出消息</span>\n    self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Time to leave page </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// event.data 即离开页面的倒计时（ms）</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"如果您的项目基于 Webpack 4.x，那么需要配置 ",e.createElement(s.a,{href:"https://github.com/webpack-contrib/worker-loader"},e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">worker-loader</code>'}}))," 或 ",e.createElement(s.a,{href:"https://github.com/GoogleChromeLabs/worker-plugin"},e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">worker-plugin</code>'}}))," 等 loader 或插件才能通过 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">new Worker(url)</code>'}})," 的方式正常引入 Web Worker。"),"\n",e.createElement(s.p,null,"在 React 代码里读取脚本文件，即可创建 Worker 线程并监听它返回的消息："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="tsx"><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>\n\n<span class="token comment">/** 离开页面的方法 */</span>\n<span class="token keyword">const</span> <span class="token function-variable function">leavePage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...离开当前页面的业务代码</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 新建 Worker 线程</span>\n    <span class="token comment">// const worker = new Worker("path/to/leavePage.worker.js");</span>\n\n    <span class="token comment">// 向 Worker 线程发出消息，设定 12h 后返回消息</span>\n    worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token number">12</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 监听 Worker 返回的消息</span>\n    worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 一旦接收到消息，执行离开页面的业务代码</span>\n      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Received message from worker thread"</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">leavePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 一旦完成响应，关闭 Worker 线程</span>\n      worker<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 页面卸载时关闭 Worker 线程</span>\n      worker<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"对于 Webpack 5.x 以上的项目，Webpack 已内置了对 Web Worker 的支持，可",e.createElement(s.a,{href:"https://webpack.js.org/guides/web-workers"},"查阅文档"),"使用。"),"\n",e.createElement(s.h3,null,"动态加载的方式"),"\n",e.createElement(s.p,null,"如果不想在 Webpack 上加 loader 或插件，也可以考虑「动态」地加载脚本文件，这需要一点点小技巧。首先将 Worker 包含的具体内容以字符串的形式导出："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// leavePage.worker.js</span>\n<span class="token keyword">const</span> leavePageWorker <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\nvar timer;\nself.onmessage = function (event) {\n  // ...\n};\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> leavePageWorker<span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"在主线程的代码里导入字符串并创建真正的 Worker 线程："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">import</span> LeavePageWorker <span class="token keyword">from</span> <span class="token string">"path/to/leavePage.worker.js"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> loadWebWorker <span class="token operator">=</span> <span class="token punctuation">(</span>code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> Worker <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"("</span> <span class="token operator">+</span> code <span class="token operator">+</span> <span class="token string">")()"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> leavePageWorker <span class="token operator">=</span> <span class="token function">loadWebWorker</span><span class="token punctuation">(</span>LeavePageWorker<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"需注意的是，使用动态加载的方式意味着 Worker 的代码将不经 Webpack 而直接调用，所以应当使用兼容性更好的「古早 JavaScript 语法」，例如 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">var</code>'}})," ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">function(){}</code>'}})," 等。"),"\n",e.createElement(s.p,null,"由于浏览器的 Content Security Policy (CSP) 策略，通过此方法创建 Worker 可能会失败，可以参考",e.createElement(s.a,{href:"https://stackoverflow.com/questions/30280370/how-does-content-security-policy-csp-work"},"此介绍"),"进行解决。"),"\n",e.createElement(s.h3,null,"Umi 项目的方式"),"\n",e.createElement(s.p,null,"根据 ",e.createElement(s.a,{href:"https://v3.umijs.org/config#workerloader"},"Umi 文档"),"，对于 Umi 3.4.1+ 的项目，可以进行如下配置启用对 Web Worker 的支持："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// config.ts</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  workerLoader<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"然而 Umi 文档并没有提 Web Worker 的引入方式，不过查阅 ",e.createElement(s.a,{href:"https://github.com/umijs/umi/blob/3.x/packages/bundler-webpack/src/getConfig/getConfig.ts#L364-L372"},"Umi 源码"),"发现："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>workerLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  webpackConfig<span class="token punctuation">.</span>module\n    <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*worker.(ts|js)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span> <span class="token comment">// Web Worker 文件命名规则</span>\n    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"worker-loader"</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">loader</span><span class="token punctuation">(</span><span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"@umijs/deps/compiled/worker-loader"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>workerLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"可知 Umi 基于 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">worker-loader</code>'}}),"，将 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">worker.ts</code>'}})," 或 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">worker.js</code>'}})," 结尾的文件当作 Web Worker 处理。那么可以这样编写主线程的代码："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="tsx"><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> LeavePageWorker <span class="token keyword">from</span> <span class="token string">"path/to/leavePage.worker.js"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 新建 Worker 线程</span>\n    <span class="token keyword">const</span> worker<span class="token operator">:</span> Worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LeavePageWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 像之前一样监听 worker 事件即可</span>\n    <span class="token comment">// ...</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 别忘了使用完后关闭 Worker 线程</span>\n      worker<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"Worker 的编译和运行均在后台执行，这意味着即使出现报错也不会显式提醒您。您可以随时在开发者工具里找到编译得到的 Worker 的代码："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/a5564164559988f60d79f78896c14f68/2bfae/webworker-source.jpg"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 87.17948717948718%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAeVc0iBQgP/EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEAAQUCH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CH//EABsQAAICAwEAAAAAAAAAAAAAAAEQACERMUFh/9oACAEBAAE/IezNIG4T6ht//9oADAMBAAIAAwAAABCoL77/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/EB//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/EB//xAAdEAACAgIDAQAAAAAAAAAAAAABEQAhMUEQUXFh/9oACAEBAAE/ELWwQsDUZAgfYz2vDDZGodqw+Hm2YZ//2Q==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="在开发者工具中查看 Worker 源码"\n        title=""\n        src="/static/a5564164559988f60d79f78896c14f68/a3695/webworker-source.jpg"\n        srcset="/static/a5564164559988f60d79f78896c14f68/acd68/webworker-source.jpg 156w,\n/static/a5564164559988f60d79f78896c14f68/f556e/webworker-source.jpg 312w,\n/static/a5564164559988f60d79f78896c14f68/a3695/webworker-source.jpg 624w,\n/static/a5564164559988f60d79f78896c14f68/38044/webworker-source.jpg 936w,\n/static/a5564164559988f60d79f78896c14f68/9a8cd/webworker-source.jpg 1248w,\n/static/a5564164559988f60d79f78896c14f68/2bfae/webworker-source.jpg 1654w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",e.createElement(s.p,null,"对于 Umi 3.4.1 以前版本的项目，可以通过 ",e.createElement(s.a,{href:"https://v3.umijs.org/config#chainwebpack"},e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">chainWebpack</code>'}}))," 添加 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">worker-loader</code>'}})," 或 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">worker-plugin</code>'}})," 插件的支持。"),"\n",e.createElement(s.p,null,"Umi 4.x 内置 Webpack 5.x 作为默认 Bundler，因此",e.createElement(s.a,{href:"https://webpack.js.org/guides/web-workers"},"查阅文档"),"使用即可。"),"\n",e.createElement(s.h3,null,"三方库的方式"),"\n",e.createElement(s.p,null,"如果不介意 Web Worker 编写是否原生（笔者从不介意！），更推荐选用封装了 Web Worker 能力的三方库，例如 ",e.createElement(s.a,{href:"https://github.com/alewin/useWorker"},e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">alewin/useWorker</code>'}}))," 和 ",e.createElement(s.a,{href:"https://github.com/developit/greenlet/"},e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">developit/greenlet</code>'}}))," 等。"),"\n",e.createElement(s.p,null,"它们降低了使用 Web Worker 的心智成本，使得调用 Web Worker 就像编写普通的 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">async</code>'}})," 异步函数一样；重要的是，不必再担心引入 Web Worker 时带来的各种各样的奇怪问题（CDN 部署时，可能发生同源问题）。"),"\n",e.createElement(s.p,null,"以 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">alewin/useWorker</code>'}})," 为例，可以这样改进前面的代码："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="tsx"><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useWorker <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@koale/useworker"</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * 休眠 @timeout 毫秒\n */</span>\n<span class="token keyword">const</span> <span class="token function-variable function">setTimeoutAsync</span> <span class="token operator">=</span> <span class="token punctuation">(</span>timeout<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=></span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>setTimeoutWorker<span class="token punctuation">,</span> <span class="token punctuation">{</span> kill<span class="token operator">:</span> killSetTimeoutWorker <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token operator">=</span>\n    <span class="token function">useWorker</span><span class="token punctuation">(</span>setTimeoutAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">runLeavePageWorker</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">await</span> <span class="token function">setTimeoutWorker</span><span class="token punctuation">(</span><span class="token number">12</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// ... 在此处执行离开页面的业务代码</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token function">runLeavePageWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">killSetTimeoutWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.h2,null,"参考文章"),"\n",e.createElement(s.ul,null,"\n",e.createElement(s.li,null,e.createElement(s.a,{href:"https://www.ruanyifeng.com/blog/2018/07/web-worker.html"},"Web Worker 使用教程 - 阮一峰")),"\n",e.createElement(s.li,null,e.createElement(s.a,{href:"https://juejin.cn/post/6855583384375132174"},"记一次定时器问题的优雅解决")),"\n",e.createElement(s.li,null,e.createElement(s.a,{href:"https://stackoverflow.com/questions/49171791/web-worker-onmessage-uncaught-syntaxerror-unexpected-token"},"web worker onmessage - Uncaught SyntaxError: Unexpected token <")),"\n",e.createElement(s.li,null,e.createElement(s.a,{href:"https://stackoverflow.com/questions/33289726/combination-of-async-function-await-settimeout"},"Combination of async function + await + setTimeout")),"\n"))}var o=function(n){void 0===n&&(n={});const{wrapper:s}=Object.assign({},(0,t.R)(),n.components);return s?e.createElement(s,n,e.createElement(p,n)):p(n)},c=a(197),l=a(4353),u=a.n(l),k=a(4794),r=a(6947),i=a(4017),m=a(1042),g=a(1038);const d={a:n=>{let{href:s="",children:a}=n;const t=!(null!=s&&s.startsWith("#")),p=t?s:`#${encodeURIComponent(s.slice(1))}`;return e.createElement("a",{href:p,target:t?"_blank":void 0,rel:"noreferrer"},a)},img:n=>{const{alt:s="The author is too lazy to give an alt",src:a,...t}=n;return e.createElement("a",{href:a,"data-fancybox":"gallery","data-caption":s},e.createElement("img",Object.assign({src:a,alt:s},t)))},Card:r.A,Link:k.Link},A=n=>{let{children:s,data:a}=n;const{mdx:{frontmatter:{title:p,date:o,updated:l,categories:k,tags:r,timeliness:m}}}=a,A=e.useRef(null),f=u()(o),w=l?u()(l):f,E=u()().diff(w,"days");return e.useEffect((()=>{var n;const s=null===(n=A.current)||void 0===n?void 0:n.querySelectorAll("a.gatsby-resp-image-link");return null==s||s.forEach((n=>{const s=n.children.item(1);n.setAttribute("data-fancybox","gallery"),n.setAttribute("data-caption",s.alt)})),c.lX.bind("[data-fancybox]"),()=>c.lX.unbind("[data-fancybox]")}),[]),e.createElement("div",{className:"mx-auto flex max-w-xl flex-col gap-y-12"},e.createElement("div",{className:"flex flex-col gap-4"},(null==k?void 0:k.length)&&e.createElement(i.A,{name:k[0],className:"item-selectable"}),e.createElement("h1",{className:"text-3xl font-bold"},p),e.createElement("div",{className:"item-secondary flex flex-col gap-2 lg:flex-row"},o&&e.createElement("span",{title:`首次发布于：${f.toString()}\n最后更新于：${w.toString()}`},f.format("MM 月 DD 日 YYYY 年")),(null==r?void 0:r.length)&&e.createElement("div",{className:"flex flex-1 flex-wrap gap-2 lg:before:content-['•']"},r.map((n=>e.createElement(g.A,{key:n,name:n,className:"item-secondary item-selectable"})))))),e.createElement("article",{ref:A,className:"heti post-entry"},!1!==m&&E>365&&e.createElement("blockquote",{className:"border-l-4 border-orange-400"},"这是一篇",e.createElement("strong",null,"最后更新于 ",E," 天前"),"的博客，内容可能随着时间的推移而变得不再适用，建议您仔细评估信息的有效性。"),e.createElement(t.x,{components:d},s)))},f=n=>{let{data:s}=n;return e.createElement(m.A,{title:String(s.mdx.frontmatter.title)})};function w(n){return e.createElement(A,n,e.createElement(o,n))}}}]);
//# sourceMappingURL=component---src-templates-post-tsx-content-file-path-blog-posts-js-webworker-settimeout-mdx-78a409a2ce029eb77d9a.js.map