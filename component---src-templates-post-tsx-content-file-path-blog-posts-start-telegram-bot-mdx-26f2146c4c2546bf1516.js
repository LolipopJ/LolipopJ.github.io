"use strict";(self.webpackChunkhomepage=self.webpackChunkhomepage||[]).push([[2229],{2700:function(n,s,a){a.r(s),a.d(s,{Head:function(){return y},default:function(){return b}});var t=a(8453),e=a(6540);function p(n){const s=Object.assign({p:"p",blockquote:"blockquote",a:"a",h2:"h2",span:"span",h3:"h3",strong:"strong",ul:"ul",li:"li"},(0,t.R)(),n.components);return e.createElement(e.Fragment,null,e.createElement(s.p,null,"本文基于 Koa 从零开始搭建一个简单的 Telegram Bot 应用服务，支持获取 Github Issues 的评论并转发到 Telegram 频道，帮助笔者更好地将捣玩 Telegram！"),"\n",e.createElement(s.blockquote,null,"\n",e.createElement(s.p,null,"时间推移至 2024 年，笔者现在更建议使用 ",e.createElement(s.a,{href:"https://bun.sh"},"Bun")," 开发应用服务，开箱即用的高性能服务以及完备的 TypeScript 支持，能大大提升开发体验。下面为撰写于 2022 年初的原文。"),"\n"),"\n",e.createElement(s.p,null,"本文假设您已对 Node.js 和 Koa 有一定的了解。"),"\n",e.createElement(s.h2,null,"初始化 Koa 项目"),"\n",e.createElement(s.p,null,e.createElement(s.a,{href:"https://koajs.com/"},"Koa")," 是为 Node.js 设计的下一代 Web 框架，其幕后开发者主要来自知名的 Express 团队。"),"\n",e.createElement(s.p,null,"尽管使用 ",e.createElement(s.a,{href:"https://github.com/i5ting/koa-generator"},"koa-generator")," 来初始化 Koa 项目是一个不错的选择，但笔者还是喜欢从头开始的感觉。"),"\n",e.createElement(s.p,null,"那么首先，新建文件夹并进入，使用 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">npm init</code>'}})," 初始化 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">package.json</code>'}}),"。"),"\n",e.createElement(s.p,null,"安装必要的依赖："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> koa koa-router koa-bodyparser dotenv</code></pre></div>'}}),"\n",e.createElement(s.p,null,"安装开发依赖："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-D</span> nodemon</code></pre></div>'}}),"\n",e.createElement(s.p,null,"安装服务器部署时使用的依赖："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> pm2</code></pre></div>'}}),"\n",e.createElement(s.p,null,"为了简便，这里笔者使用了别人进行封装后的 Telegram Bot API 库 ",e.createElement(s.a,{href:"https://github.com/yagop/node-telegram-bot-api"},"node-telegram-bot-api"),"："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> node-telegram-bot-api</code></pre></div>'}}),"\n",e.createElement(s.p,null,"规划项目目录结构大致如下："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="plaintext"><pre class="language-plaintext"><code class="language-plaintext">.\n├── .env\n├── app.js\n├── package.json\n├── bin\n│   └── www.js\n└── routes\n│   └── index.js\n└── service\n    ├── bot.js\n    └── index.js</code></pre></div>'}}),"\n",e.createElement(s.p,null,"其中，",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.env</code>'}})," 为环境配置文件，包括 Telegram Bot Token 在内的信息在此处配置；",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">bin/www.js</code>'}})," 为项目启动时执行的文件，这意味着在配置脚本命令时，应当使用 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">nodemon bin/www</code>'}})," 及 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">pm2 start bin/www</code>'}}),"；",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">routes</code>'}})," 目录为路由目录，用来存放可调用的接口；最后，",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">service</code>'}})," 目录为服务目录，在这里连接 Bot 和数据库，并执行定时任务。"),"\n",e.createElement(s.h2,null,"连接到 Telegram Bot"),"\n",e.createElement(s.h3,null,"创建新的 Bot"),"\n",e.createElement(s.p,null,"首先，通过在 Telegram 上与 ",e.createElement(s.a,{href:"https://core.telegram.org/bots#6-botfather"},"BotFather")," 交互，创建一个新的 Telegram Bot。"),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/360086b0b82a989507840ff37bc86ed4/142fb/create-bot.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 109.61538461538463%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABJ0AAASdAHeZh94AAAD7ElEQVR42oWVSW/bRhiGeWxQy5Yt2xIpkqIsSpRIkdROUpK175LXeImXuHWD9NSmQNNLW/RUBD0YaNFf/PabsWK0Th0fHsxwxHn57RKc9hBuawDJKkE0i7QW+Z6T/5S4XfkPslNFstKA7rWguDUIUrmJRHsGqz2G25/D6M5gtCdQSg2IBQ8x14Pk+pAKAWcz4yCSMhHRrQe20jZnM52HEPd7yB5+BXPvEpWDC1T3X8GcnWFneAx99JLEp5CrHYilXUiVNsI7JlaVNFbVzCesJQyysNaFvrhAenIKd3qC4uwENlEi4fLiDM5wH2qNCTZJsIX1HQtry8uPCWtZCGq1jeyALvkk3BxC8vpQgz526n1oXhcxJsQo73KeFUzQZevgGunOHO5gD7nREfJkaYrOo4X6g9CTgiTykXAyB0EOBjCOb8nNM+weUQz3TmFPKH7NEXcx/oj1lLWMF4moFEs5dU98B+FEBkLMrUNrz5GoD5BrjaAHPejkfoqIOT6itsdhe5lbaJJYhlu5rjvYdCjzts/XiFGEwL4WknWsLPmYrdUn4nQfK5NbJTWncN59gPX2V9jf/Q51fAYh6bVRmhzBpWza/QWM3TGyrQnMzpSv2daYw84VSiBzOUTufSlqWJGStP+3y1Q229kiZCrcuONBzFfJ7ML/sknvxeh3ZmGs0kFqwmr1JVLjE6j9Y8iDE0RLLQgsJhupPDb0PCKs2qkTtgwXWxkGxYjOtuk5otvLotah9A5hf/0e1tU75F//AOPyexg37yF3DyCkKAlVKuAcazlyk3VGrkst2JnxPWtD9qzvjqhWe/zjIXL1RUTEF+tRIsb3LzaidK6RhVQ7zMpV1UCIJehhvWeFoWR4nTExVi4sYenDWxTe/gLn9ifkbn5E7s3PkMlyIWqW+SBIEBoNCoUGgFoMoNGzSvtkmZ03sE3vsTiy4mWCInWU1juA2l5Abs0R7+xjm/pd0KgjSsevUTq8QnH/ApW9c9QWp/D3z+ERtaMr1A8veE9Ly8JmNRiSKNOxBCfEMk7rGsVXSFFcGgev4FMcAxILmMj8lBPQgKguzuHTeWV6jAyVTjhpcsHwstUeI6i1BvIjSkSPgt8fwxpOYQ0mtN4/G11qzd4ASq1NdO475XPDIaO9QaD8jap0h4p4h5p8h3riT+IvFGN/wN3+AFv6DWppCJFi+ey0yZQW8Dvfoty6ht+/hdf9Bo5/ibx3ATe4hlW5guvdQG+MSbD5EMMnBZVaE+ZkAWu0gMmZIzucQe8MkOkOIfuU4TJ1EQ0GNrmfFRRp5iUaI5o2Q2jLNbnsW5n9r7gBnzRiwYdCFm6QYHh5+TGspv8BkOuh0eYeWqMAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="create a new bot"\n        title=""\n        src="/static/360086b0b82a989507840ff37bc86ed4/39c09/create-bot.png"\n        srcset="/static/360086b0b82a989507840ff37bc86ed4/680fe/create-bot.png 156w,\n/static/360086b0b82a989507840ff37bc86ed4/17474/create-bot.png 312w,\n/static/360086b0b82a989507840ff37bc86ed4/39c09/create-bot.png 624w,\n/static/360086b0b82a989507840ff37bc86ed4/142fb/create-bot.png 907w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",e.createElement(s.p,null,"记录下当中的 ",e.createElement(s.strong,null,"HTTP API")," 的值即 Telegram Bot Token，作为项目的环境变量保存，切勿上传到远程代码仓库中。"),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> token <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TELEGRAM_BOT_TOKEN</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.h3,null,"与 Bot 建立连接"),"\n",e.createElement(s.p,null,"我们的项目可能无法直接访问到 Telegram 的服务器，可以使用 ",e.createElement(s.a,{href:"https://github.com/mattcg/socks5-https-client"},e.createElement(s.strong,null,"SOCKS5 代理")),"解决这个问题："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> TelegramBot <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node-telegram-bot-api"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> proxySocks5Agent <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"socks5-https-client/lib/Agent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nrequestOptions <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">agentClass</span><span class="token operator">:</span> proxySocks5Agent<span class="token punctuation">,</span>\n  <span class="token literal-property property">agentOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">socksHost</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROXY_SOCKS5_HOST</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">socksPort</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROXY_SOCKS5_PORT</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">socksUsername</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROXY_SOCKS5_USERNAME</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">socksPassword</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROXY_SOCKS5_PASSWORD</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> bot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelegramBot</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">polling</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">request</span><span class="token operator">:</span> requestOptions<span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"如何 SOCKS5 工作不正常（",e.createElement(s.a,{href:"https://github.com/yagop/node-telegram-bot-api/issues/696#issuecomment-613023532"},"这是"),"一个可能的原因），也可以尝试使用 ",e.createElement(s.strong,null,"HTTP 代理"),"："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> TelegramBot <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node-telegram-bot-api"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nrequestOptions <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">proxy</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROXY_HTTP</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> bot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelegramBot</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">polling</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">request</span><span class="token operator">:</span> requestOptions<span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"对 Bot 进行测试，添加如下代码："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">bot<span class="token punctuation">.</span><span class="token function">onText</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\/start</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// console.log(msg)</span>\n  bot<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"Hi, this is Telly Bot!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"打开 Telegram，对 Bot 发送 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/start</code>'}}),"，看看是否会得到 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">Hi, this is Telly Bot!</code>'}})," 的回应。"),"\n",e.createElement(s.h3,null,"使用网络钩子与 Bot 交互"),"\n",e.createElement(s.p,null,"Telegram Bot 可以通过轮询（polling）和网络钩子（webhook）两种不同的方式来获取用户发送的消息，在前面的代码中，我们使用的是轮询的方式。"),"\n",e.createElement(s.p,null,"轮询的方式无需额外的配置，更适合本地快速进行开发测试；而网络钩子的方式更适合项目部署。那么，一个健全的 Telegram Bot 应当使用",e.createElement(s.strong,null,"网络钩子"),"的方式来实现。"),"\n",e.createElement(s.p,null,"为了接收用户对 Telegram Bot 发送的消息，在网络钩子的方式中，我们需要一个 ",e.createElement(s.strong,null,"HTTPS 协议的公网地址"),"，除了直接使用自己的服务器，还可以怎么办呢？别急，有 ",e.createElement(s.a,{href:"https://ngrok.com/"},"ngrok")," 为我们排忧解难：它是一款反向代理工具，可以将本地的地址映射到公网上去。"),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/f7bd64a5a398e1539a12e62a0fb98cbe/c1b63/ngrok.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 35.8974358974359%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABJ0AAASdAHeZh94AAABMklEQVR42n2QS0/CQBSFRw2hpTPttEALwbZQXlIWII24IDHorxIMC5T/fThTA4FIXHy5M/dx7pkRu/UaB7J//8A32b0ssZnPsX1eYDub42tRMM6wmeTY5NM/fDK/Z89h+Yofzopm1sZDUINwLAjbxp1twY2bsH0NW2tUaqxVKhAW69XqNSZH7tlzQrytVkiTBNrzIB2HUaMoCkzzHE/jMR47HfgUPhH4Phr1eolSCkrKK8R0MkGv14PkxaGg67rIsgyj0QiDwQBpmmI4HCLhUnM2tX6/X0bTa2bM7AkR00Gr1Sq3SUeW0aMTl061pptGA1EUlYRhiDqdWXxmjc+7FDoLZt1uuT0IAm77TWqtCN0qp8wZF5fcEjoLpnGMgFvN35iEUhJJHKIdefxPCvwzfEvwCIsStRB+XqwxAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="ngrok"\n        title=""\n        src="/static/f7bd64a5a398e1539a12e62a0fb98cbe/39c09/ngrok.png"\n        srcset="/static/f7bd64a5a398e1539a12e62a0fb98cbe/680fe/ngrok.png 156w,\n/static/f7bd64a5a398e1539a12e62a0fb98cbe/17474/ngrok.png 312w,\n/static/f7bd64a5a398e1539a12e62a0fb98cbe/39c09/ngrok.png 624w,\n/static/f7bd64a5a398e1539a12e62a0fb98cbe/6d2da/ngrok.png 936w,\n/static/f7bd64a5a398e1539a12e62a0fb98cbe/c1b63/ngrok.png 1200w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",e.createElement(s.p,null,"如上图所示，当 ngrok 运行时，Telegram Bot 发向 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://a75b-182-141-75-13.ngrok.io</code>'}})," 的请求，将转发给运行在本地 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">http://localhost:4000</code>'}})," 上的程序。"),"\n",e.createElement(s.p,null,"这样，只需要同时运行我们的项目和 ngrok，我们就可以正常地接收到信息并进行处理了。修改连接 Bot 的代码如下："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> bot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TelegramBot</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">request</span><span class="token operator">:</span> requestOptions<span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nbot<span class="token punctuation">.</span><span class="token function">setWebHook</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">WEBHOOK_HOST</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/bot</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nglobalThis<span class="token punctuation">.</span>bot <span class="token operator">=</span> bot<span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"现在，Telegram 上机器人收到的消息会立即发送给我们的服务器。最后，在服务器需要处理接收到的 POST 类型请求 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/bot${TELEGRAM_BOT_TOKEN}</code>'}}),"，告知 Telegram 我们已经收到新的消息了。可以在 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">routes/index.js</code>'}})," 中添加代码如下："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bot</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  globalThis<span class="token punctuation">.</span>bot<span class="token punctuation">.</span><span class="token function">processUpdate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"需要补充的是，通过上面代码中 Bot API 库提供的 ",e.createElement(s.a,{href:"https://github.com/yagop/node-telegram-bot-api/blob/master/doc/api.md#telegrambotprocessupdateupdate"},e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">processUpdate</code>'}}))," 方法，可以对接收到的消息进行相应的处理，触发正确的事件并执行回调方法。"),"\n",e.createElement(s.p,null,"现在，我们的机器人将不再笨拙地轮询 Telegram 服务器，查看是否有未处理的消息，而是静静等待 Telegram 服务器发送过来的请求。"),"\n",e.createElement(s.h2,null,"转发 Github Issues 到 Telegram 频道"),"\n",e.createElement(s.p,null,e.createElement(s.a,{href:"https://billc.io/"},"Chen 先生"),"自己的 Telegram 频道会定时发送他更新的推文，笔者也想整一个，最简单的实现方式是申请一个 Twitter 开发者账号，定时调用 API 获取最新推文信息即可 —— 但是没能申请到。暂退一步，先把笔者在 Github Issues 上的碎碎念同步给频道吧。"),"\n",e.createElement(s.p,null,"接下来的内容假设您已对 PostgreSQL 和数据库 ORM 工具有一定的了解。"),"\n",e.createElement(s.h3,null,"连接到数据库"),"\n",e.createElement(s.p,null,"同步功能需要数据库的支持，当然也为了未来更多功能的实现，在这里，先与本机的数据库建立连接。以 ",e.createElement(s.a,{href:"https://www.enterprisedb.com/downloads/postgres-postgresql-downloads"},"PostgreSQL")," 为例，首先安装 ",e.createElement(s.a,{href:"https://github.com/brianc/node-postgres"},"node-postgres")," 库："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> pg</code></pre></div>'}}),"\n",e.createElement(s.p,null,"新建文件 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">config.js</code>'}})," 来存储连接到数据库的配置："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">postgresql</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">5432</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">"telly_bot_db"</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">"telly_bot_db_user"</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">"telly_bot_db_pwd"</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">timezone</span><span class="token operator">:</span> <span class="token string">"+08:00"</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> config<span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.h3,null,"使用 ORM 管理数据库"),"\n",e.createElement(s.p,null,"通过 ORM 工具来对数据库进行管理与查询，可以避免手动运维的窘境。这里选用 ",e.createElement(s.a,{href:"https://github.com/sequelize/sequelize"},"Sequelize")," 库，安装必要的依赖："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> sequelize pg-hstore</code></pre></div>'}}),"\n",e.createElement(s.p,null,"修改 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">db/index.js</code>'}})," 代码如下："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> Sequelize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sequelize"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> pgsqlConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../config"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>database<span class="token punctuation">.</span>postgresql<span class="token punctuation">;</span>\n<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">timezone</span><span class="token operator">:</span> pgsqlConfig<span class="token punctuation">.</span>timezone <span class="token operator">||</span> <span class="token string">"+08:00"</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequelize</span><span class="token punctuation">(</span>\n  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">postgres://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pgsqlConfig<span class="token punctuation">.</span>user<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pgsqlConfig<span class="token punctuation">.</span>password<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pgsqlConfig<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pgsqlConfig<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pgsqlConfig<span class="token punctuation">.</span>database<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n  options<span class="token punctuation">,</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>\n      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Connection with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pgsqlConfig<span class="token punctuation">.</span>database<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> has been established successfully.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">alter</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"All models were synchronized successfully."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>\n      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unable to connect to the database </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pgsqlConfig<span class="token punctuation">.</span>database<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n      error<span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> sequelize<span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"为了实现自动转发 Github Issues 中的评论，我们需要一张数据表来存储上一次转发的评论（或编辑记录）的",e.createElement(s.strong,null,"最后更新日期"),"（",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">lastUpdateCommentAt</code>'}}),")。这样，下一次执行任务时，只需要查看该日期之后是否有新的评论（或编辑记录）就可以了。对于每一个 Issue，都会在该表中创建一条数据。为 Sequelize 添加模型 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">db/model/ServiceGithubIssueComment.js</code>'}})," 如下："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> DataTypes <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sequelize"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// The ID of the forwarding Github Issue service</span>\n  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Url of Github Issue. Example: ${USERNAME}/${REPOSITORY}/issues/${ISSUE_NUM}</span>\n  <span class="token literal-property property">issueUrl</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Only forward the comments of these users, empty means forward all</span>\n  <span class="token literal-property property">issueUserId</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">ARRAY</span><span class="token punctuation">(</span>DataTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// The ID of the channel to which the comment was forwarded</span>\n  <span class="token literal-property property">forwardChannelId</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// The last date the issue comments were updated</span>\n  <span class="token literal-property property">lastUpdateCommentAt</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Date the service was last run</span>\n  <span class="token literal-property property">lastExecServiceAt</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">type</span><span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"一个模型将成为数据库中的一张数据表。向 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">db/index.js</code>'}})," 中添加如下代码："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> serviceGithubIssueCommentModel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./model/ServiceGithubIssueComment"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nsequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"ServiceGithubIssueComment"</span><span class="token punctuation">,</span> serviceGithubIssueCommentModel<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// sequelize.sync({ alter: true })</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"注意，将模型绑定给 sequelize 对象的操作 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">sequelize.define()</code>'}})," 需要放在 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">sequelize.sync()</code>'}})," 方法之前。"),"\n",e.createElement(s.p,null,"当 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">sequelize.define()</code>'}})," 执行完成后，我们可以随时使用 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">sequelize.models.ServiceGithubIssueComment</code>'}})," 来获取模型实例。通过模型实例，我们就可以在对应的数据表中执行各种 SQL 查询语句了。"),"\n",e.createElement(s.h3,null,"获取指定 Issue 中的最新评论"),"\n",e.createElement(s.p,null,"Github REST API 文档推荐使用 ",e.createElement(s.a,{href:"https://github.com/octokit/core.js"},"@octokit/core")," 库来执行请求："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @octokit/core</code></pre></div>'}}),"\n",e.createElement(s.p,null,"向 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">config.js</code>'}})," 中添加相应的配置。以获取笔者的",e.createElement(s.a,{href:"https://github.com/LolipopJ/LolipopJ/issues/2"},"碎碎念"),"为例："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">github</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">forwardIssueComment</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">3600</span><span class="token punctuation">,</span>\n      <span class="token literal-property property">task</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n        <span class="token punctuation">{</span>\n          <span class="token literal-property property">owner</span><span class="token operator">:</span> <span class="token string">"LolipopJ"</span><span class="token punctuation">,</span>\n          <span class="token literal-property property">repo</span><span class="token operator">:</span> <span class="token string">"LolipopJ"</span><span class="token punctuation">,</span>\n          <span class="token literal-property property">issueNumber</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n          <span class="token literal-property property">issueUserId</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">42314340</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          <span class="token literal-property property">forwardChannelId</span><span class="token operator">:</span> <span class="token string">"@lolipop_thoughts"</span><span class="token punctuation">,</span>\n          <span class="token literal-property property">since</span><span class="token operator">:</span> <span class="token string">"2022-01-01T00:00:00.000Z"</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"其中，",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">duration</code>'}})," 为两次执行期间间隔的时间（秒）。此外，配置中存在 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">issueUserId</code>'}})," 项，这是因为我们可能只想要转发自己发送的评论，在后面只需要根据该项过滤该用户 ID 的评论即可（可以通过 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://api.github.com/users/your_github_user_name</code>'}})," 查看指定 Github 账户的 ID）。"),"\n",e.createElement(s.p,null,e.createElement(s.a,{href:"https://docs.github.com/en/rest/reference/issues#list-issue-comments"},"这里"),"是获取指定 Issues 中的评论的方法。编写 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">service/github.js</code>'}})," 代码如下（",e.createElement(s.strong,null,"仅做参考"),"：代码截取实现功能的部分，刨除提高鲁棒性的部分，也去除了第一次执行的部分）："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> Octokit <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"@octokit/core"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../config"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>github<span class="token punctuation">;</span>\n<span class="token keyword">const</span> octokit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Octokit</span><span class="token punctuation">(</span>octokitOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> bot <span class="token operator">=</span> globalThis<span class="token punctuation">.</span>bot<span class="token punctuation">;</span>\n<span class="token keyword">const</span> sequelize <span class="token operator">=</span> globalThis<span class="token punctuation">.</span>sequelize<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">forwardGithubIssueComment</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> issues <span class="token operator">=</span> config<span class="token punctuation">.</span>forwardIssueComment<span class="token punctuation">.</span>task<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> ServiceGithubIssueComment <span class="token operator">=</span> sequelize<span class="token punctuation">.</span>models<span class="token punctuation">.</span>ServiceGithubIssueComment<span class="token punctuation">;</span>\n\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> issue <span class="token keyword">of</span> issues<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> owner <span class="token operator">=</span> issue<span class="token punctuation">.</span>owner<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> repo <span class="token operator">=</span> issue<span class="token punctuation">.</span>repo<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> issueNumber <span class="token operator">=</span> issue<span class="token punctuation">.</span>issueNumber<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> forwardChannelId <span class="token operator">=</span> issue<span class="token punctuation">.</span>forwardChannelId<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> issueUserId <span class="token operator">=</span> issue<span class="token punctuation">.</span>issueUserId<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> issueUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>owner<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>repo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/issues/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>issueNumber<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> queryConfig <span class="token operator">=</span> <span class="token punctuation">{</span>\n      issueUrl<span class="token punctuation">,</span>\n      issueUserId<span class="token punctuation">,</span>\n      forwardChannelId<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> perPage <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> page <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 查询 Github Issues 的评论的最后更新日期 lastUpdateCommentAt</span>\n    <span class="token keyword">const</span> issueServiceInfo <span class="token operator">=</span> <span class="token keyword">await</span> ServiceGithubIssueComment<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      <span class="token literal-property property">where</span><span class="token operator">:</span> queryConfig<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> lastUpdateCommentDate <span class="token operator">=</span>\n      issueServiceInfo<span class="token punctuation">.</span>dataValues<span class="token punctuation">.</span>lastUpdateCommentAt<span class="token punctuation">;</span>\n\n    <span class="token comment">// 将 lastUpdateCommentAt 加上 1ms 作为下一次查询的起始日期</span>\n    <span class="token keyword">const</span> since <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>\n      <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>lastUpdateCommentDate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 调用 Github API 获取指定 issue 的评论信息</span>\n    <span class="token comment">// 查询的评论更新日期从 since 开始</span>\n    <span class="token keyword">let</span> issueComments <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">while</span> <span class="token punctuation">(</span>issueComments<span class="token punctuation">.</span>length <span class="token operator">===</span> perPage <span class="token operator">*</span> page<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token operator">++</span>page<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> octokit<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>\n        <span class="token string">"GET /repos/{owner}/{repo}/issues/{issue_number}/comments"</span><span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          owner<span class="token punctuation">,</span>\n          repo<span class="token punctuation">,</span>\n          <span class="token literal-property property">issue_number</span><span class="token operator">:</span> issueNumber<span class="token punctuation">,</span>\n          since<span class="token punctuation">,</span>\n          <span class="token literal-property property">per_page</span><span class="token operator">:</span> perPage<span class="token punctuation">,</span>\n          page<span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      issueComments <span class="token operator">=</span> issueComments<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 如果设置了 issueUserId 项，则只保留数组中用户 ID 的评论</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>issueUserId<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> issueUserId<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      issueComments <span class="token operator">=</span> issueComments<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">comment</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> commentUserId <span class="token operator">=</span> comment<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>issueUserId<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>commentUserId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"如果 Issue 存放在私人仓库中，则需要用到 ",e.createElement(s.a,{href:"https://github.com/settings/tokens/new?scopes=repo"},"Personal Access Token")," 进行鉴权。在创建 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">octokit</code>'}})," 对象时传递相应参数："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> octokitOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> authToken <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">GITHUB_PERSONAL_ACCESS_TOKEN</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>authToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  octokitOptions<span class="token punctuation">.</span>auth <span class="token operator">=</span> authToken<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">const</span> octokit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Octokit</span><span class="token punctuation">(</span>octokitOptions<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.h3,null,"定时转发评论到 Telegram 频道"),"\n",e.createElement(s.p,null,"由于 Github Issues 中的评论为 Markdown 格式，在转发到频道时，就需要对内容进行解析。幸运的是，Telegram Bot 的 ",e.createElement(s.a,{href:"https://core.telegram.org/bots/api#sendmessage"},e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">sendMessage()</code>'}}))," 方法可以设置 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">parse_mode</code>'}})," 选项，可以将",e.createElement(s.strong,null,"大部分"),"的 Markdown 内容顺利解析为正确的消息样式。但不幸的是，由于 Telegram 本身的一些限制，对于一些无法解析的符号会报错，针对这一部分评论，笔者选择直接发送评论的网页地址作为替代。"),"\n",e.createElement(s.p,null,"继续编写 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">service/github.js</code>'}})," 代码如下（",e.createElement(s.strong,null,"仅做参考"),"）："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>issueComments<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> lastUpdateCommentAt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 转发评论到 Telegram 频道</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> issueComment <span class="token keyword">of</span> issueComments<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">await</span> bot<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>forwardChannelId<span class="token punctuation">,</span> issueComment<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n        <span class="token literal-property property">parse_mode</span><span class="token operator">:</span> <span class="token string">"MarkdownV2"</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">await</span> bot<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>forwardChannelId<span class="token punctuation">,</span> issueComment<span class="token punctuation">.</span>html_url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> issueCommentUpdatedAt <span class="token operator">=</span> issueComment<span class="token punctuation">.</span>updated_at<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>issueCommentUpdatedAt <span class="token operator">></span> lastUpdateCommentAt<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      lastUpdateCommentAt <span class="token operator">=</span> issueCommentUpdatedAt<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 维护数据库，保存 Github Issue 评论的最后更新日期</span>\n  <span class="token keyword">await</span> ServiceGithubIssueComment<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>\n    <span class="token punctuation">{</span>\n      lastUpdateCommentAt<span class="token punctuation">,</span>\n      <span class="token literal-property property">lastExecServiceAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token literal-property property">where</span><span class="token operator">:</span> queryConfig<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"到这里，我们已经基本实现了所需要的全部功能。最后需要做的事情，就是设置每隔一定时间自动运行此服务，持续获取最新的评论信息。这里笔者用到了 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">toad-scheduler</code>'}})," 库："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> toad-scheduler</code></pre></div>'}}),"\n",e.createElement(s.p,null,"在 ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">service/index.js</code>'}})," 中编写计划任务代码如下："),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>\n  ToadScheduler<span class="token punctuation">,</span>\n  SimpleIntervalJob<span class="token punctuation">,</span>\n  AsyncTask<span class="token punctuation">,</span>\n<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"toad-scheduler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> githubService <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./github"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> scheduler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToadScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> taskForwardGithubIssueComment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncTask</span><span class="token punctuation">(</span>\n  <span class="token string">"Forward Github Issue Comment"</span><span class="token punctuation">,</span>\n  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">await</span> githubService<span class="token punctuation">.</span><span class="token function">forwardGithubIssueComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> jobForwardGithubIssueComment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleIntervalJob</span><span class="token punctuation">(</span>\n  <span class="token punctuation">{</span>\n    <span class="token literal-property property">seconds</span><span class="token operator">:</span> config<span class="token punctuation">.</span>github<span class="token punctuation">.</span>forwardIssueComment<span class="token punctuation">.</span>duration<span class="token punctuation">,</span>\n    <span class="token literal-property property">runImmediately</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  taskForwardGithubIssueComment<span class="token punctuation">,</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nscheduler<span class="token punctuation">.</span><span class="token function">addSimpleIntervalJob</span><span class="token punctuation">(</span>jobForwardGithubIssueComment<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(s.p,null,"一切就绪，运行我们的 Bot 程序！"),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> run pm2</code></pre></div>'}}),"\n",e.createElement(s.p,null,"笔者的频道顺利收到了来自 Github Issue 中的评论信息！"),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/808e8295abd12139fb28e3547b49d239/6029f/forward-to-my-channel.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 116.02564102564101%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABJ0AAASdAHeZh94AAADmklEQVR42o1VWW8aVxTmNaoB72bYhhn2GQbDsA8wrDabsU1xmihJY6tCjbqor81zpEpVH/o7qvzJr9+9kLSNwO7D0b33nDvfPct3znjSjR4qozmc2QJ5t4eQZSNolf8lJQSMAhSjSFv5P7bweRVauYlkvYNEzUU4X4HnMG7iKGFhX8tKEed/xMBxyoJedaGWW7yX+8JuftatVwMeXzQFIf7N+lnUNPZCcQTMMoqXt8j1ZzhJF7AXTkib78v7QiJJePw0bhNx4ZCvmr0J8sM5QW+Q4/5AN+TjW7+jfiegX03hQDOgM9Rqf4RCq4+Y7UidsD0OGMtI2Rfrxij2z4JxpIp1fPzrIz58+A3PTqLru7ucEIC+aBJe5sob1LGnaPAyD75NSF9RH8+X8f7X9/jz9z+gstIih/u7QAXgcZY0qZIu9QuozUsouRKOsyUcZYo4NcTehmKWkKx1ELCqkgmPeqjVe6gt32K8+gXDhx9gj2/Q/vo13OUbGL0pzMEV8qNbZLlPdyfwE1BEsRMwXHRguCNkW0MStAeNXsbdMXRngGCpjbOCA8VuIdZYnyO8HzDs7aACUDlvIDW8RXK4gDFeQifrFdtFgPqQ3USQAGECRiuuPJ8yFUcksm8bdQSgWu3AmjyHOblDefEK5cmC3JvB6E8Z/gKZzgS5wRxp4XVzCC8L4mVhtlZbAIoQ0u1LaATWKapzwQINECg2oWwkKDys9Rhy6+mQz1g5rT1GvHuFRP8KERI5VHI34a5DDhFQrXWpbz8dssaXq3f3cF6u0Hm9Quv2Bas7g8V2K1xer9tOVJkVznan2Bet91iVo6Wm/CBPepxLkBtojT6SLVa7M4VGMUmZFNMSKrcl4JO0EYDiI5NexFsj6CIFLECMe5WSoT5D7wRtovb/yGGEHIs0RzKXYeYwIHJl1SBsQk7zNepdmcuTTEHOP/9u2nQxuP8Rvfuf0P32HXM2QYx5FTTJkjKCKqJj8sNr6HxYdIrvsZBjzItz/QL12RIVctDih4km+5pdk2TeEsyl7gyRYjeJ88Eu7z4BxunN6M1K9u707fcYvHzAxavvMOS6WP0sdWPa5w/vUGCuZZUfm4dapY3KdCk7xLn+Bjap0pg/R/3qjmOfVaanKXqZYq8r7OujpMUhm+Hkzko55ANiih8mTHn2xCtk/3kN0UKNf7WKXBXTxhlnX4Ai9gG555jL8W/H8fZJhE3lAI6JDiPxtWIdfwO6HrTNpZgd0wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Forward Github Issue&#39;s comments to my channel"\n        title=""\n        src="/static/808e8295abd12139fb28e3547b49d239/39c09/forward-to-my-channel.png"\n        srcset="/static/808e8295abd12139fb28e3547b49d239/680fe/forward-to-my-channel.png 156w,\n/static/808e8295abd12139fb28e3547b49d239/17474/forward-to-my-channel.png 312w,\n/static/808e8295abd12139fb28e3547b49d239/39c09/forward-to-my-channel.png 624w,\n/static/808e8295abd12139fb28e3547b49d239/6029f/forward-to-my-channel.png 906w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",e.createElement(s.p,null,"当然，该服务还有许多可以优化的地方，例如：当评论发生更新时，应编辑已发送的频道消息为最新评论内容，而不是重新发一条新的消息等。不再在此文赘述。"),"\n",e.createElement(s.h2,null,"参考文章"),"\n",e.createElement(s.ul,null,"\n",e.createElement(s.li,null,e.createElement(s.a,{href:"https://www.wandouip.com/t5i13823/"},"开发一个 Telegram Bot")),"\n",e.createElement(s.li,null,e.createElement(s.a,{href:"https://github.com/yagop/node-telegram-bot-api/blob/master/doc/usage.md"},"node-telegram-bot-api usage")),"\n",e.createElement(s.li,null,e.createElement(s.a,{href:"https://github.com/leobloise/node-telegram-bot-api-wb-tutorial"},"How to set webhooks using express local server and NGROK")),"\n"))}var o=function(n){void 0===n&&(n={});const{wrapper:s}=Object.assign({},(0,t.R)(),n.components);return s?e.createElement(s,n,e.createElement(p,n)):p(n)},c=a(197),l=a(4353),u=a.n(l),r=a(4794),i=a(6947),k=a(4017),g=a(1042),m=a(1038);const d={a:n=>{let{href:s="",children:a}=n;const t=!(null!=s&&s.startsWith("#")),p=t?s:`#${encodeURIComponent(s.slice(1))}`;return e.createElement("a",{href:p,target:t?"_blank":void 0,rel:"noreferrer"},a)},img:n=>{const{alt:s="The author is too lazy to give an alt",src:a,...t}=n;return e.createElement("a",{href:a,"data-fancybox":"gallery","data-caption":s},e.createElement("img",Object.assign({src:a,alt:s},t)))},Card:i.A,Link:r.Link},h=n=>{let{children:s,data:a}=n;const{mdx:{frontmatter:{title:p,date:o,updated:l,categories:r,tags:i,timeliness:g=!0}}}=a,h=e.useRef(null),y=u()(o),b=l?u()(l):y,f=u()().diff(b,"days");return e.useEffect((()=>{var n;const s=null===(n=h.current)||void 0===n?void 0:n.querySelectorAll("a.gatsby-resp-image-link");return null==s||s.forEach((n=>{const s=n.children.item(1);n.setAttribute("data-fancybox","gallery"),n.setAttribute("data-caption",s.alt)})),c.lX.bind("[data-fancybox]"),()=>c.lX.unbind("[data-fancybox]")}),[]),e.createElement("div",{className:"mx-auto flex max-w-xl flex-col gap-y-12"},e.createElement("div",{className:"flex flex-col gap-4"},(null==r?void 0:r.length)&&e.createElement(k.A,{name:r[0],className:"item-selectable"}),e.createElement("h1",{className:"text-3xl font-bold"},p),e.createElement("div",{className:"item-secondary flex flex-col gap-2 lg:flex-row"},o&&e.createElement("span",{title:`首次发布于：${y.toString()}\n最后更新于：${b.toString()}`},y.format("MM 月 DD 日 YYYY 年")),(null==i?void 0:i.length)&&e.createElement("div",{className:"flex flex-1 flex-wrap gap-2 lg:before:content-['•']"},i.map((n=>e.createElement(m.A,{key:n,name:n,className:"item-secondary item-selectable"})))))),e.createElement("article",{ref:h,className:"heti post-entry"},g&&f>365&&e.createElement("blockquote",{className:"border-l-4 border-orange-400"},"这是一篇",e.createElement("strong",null,"最后更新于 ",f," 天前"),"的博客，内容可能随着时间的推移而变得不再适用，建议您仔细评估信息的有效性。"),e.createElement(t.x,{components:d},s)))},y=n=>{let{data:s}=n;return e.createElement(g.A,{title:String(s.mdx.frontmatter.title)})};function b(n){return e.createElement(h,n,e.createElement(o,n))}}}]);
//# sourceMappingURL=component---src-templates-post-tsx-content-file-path-blog-posts-start-telegram-bot-mdx-26f2146c4c2546bf1516.js.map