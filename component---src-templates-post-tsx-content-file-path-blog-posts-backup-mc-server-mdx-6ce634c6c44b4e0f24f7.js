"use strict";(self.webpackChunkhomepage=self.webpackChunkhomepage||[]).push([[6128],{1636:function(n,a,s){s.r(a),s.d(a,{Head:function(){return y},default:function(){return h}});var t=s(8453),p=s(6540);function e(n){const a=Object.assign({p:"p",a:"a",h2:"h2",h3:"h3",span:"span",blockquote:"blockquote"},(0,t.R)(),n.components);return p.createElement(p.Fragment,null,p.createElement(a.p,null,"笔者最近在 OpenWRT 软路由上部署了一个 Minecraft 服务器，出于对数据安全的焦虑，于是折腾了一下存档备份的相关事宜，记录为此文。"),"\n",p.createElement(a.p,null,"在 CurseForge 等模组站上已有方便好用的 Minecraft 服务器存档备份插件，除非您喜欢折腾或高自由度的定制，不用像笔者这样编写一整个脚本。"),"\n",p.createElement(a.p,null,"完整的脚本",p.createElement(a.a,{href:"https://github.com/LolipopJ/LolipopJ.github.io/blob/cd9d45af2a97f596ec6b3ada4c069f88a9e9bbd7/source/static/scripts/backup-mc-server.js"},"可见此"),"。"),"\n",p.createElement(a.h2,null,"编写备份脚本"),"\n",p.createElement(a.h3,null,"前置准备"),"\n",p.createElement(a.p,null,"为了脚本编写方便，约定应该在 Minecraft 服务器的根目录执行脚本。校验当前脚本的执行目录："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cwd <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">"eula.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>\n    <span class="token string">"You should execute this script at root dir of MineCraft server where `eula.txt` exists."</span><span class="token punctuation">,</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"支持指定备份文件存储的目录 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">BACKUP_DIR</code>'}}),"，同时 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">checkupDir()</code>'}})," 确保目录存在："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">BACKUP_DIR</span> <span class="token operator">=</span> <span class="token string">"backups"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">checkupDir</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">recursive</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> backupDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token constant">BACKUP_DIR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">checkupDir</span><span class="token punctuation">(</span>backupDir<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.h3,null,"生成备份文件"),"\n",p.createElement(a.p,null,"支持指定备份文件的列表，除了最重要的 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">world/</code>'}})," 以外，还可以备份 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">server.properties</code>'}}),"、",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">world_nether/</code>'}})," 和 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">world_the_end/</code>'}})," 等文件或目录。"),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">BACKUP_FILES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token string">"banned-ips.json"</span><span class="token punctuation">,</span>\n  <span class="token string">"banned-players.json"</span><span class="token punctuation">,</span>\n  <span class="token string">"config"</span><span class="token punctuation">,</span>\n  <span class="token string">"mods"</span><span class="token punctuation">,</span>\n  <span class="token string">"ops.json"</span><span class="token punctuation">,</span>\n  <span class="token string">"server.properties"</span><span class="token punctuation">,</span>\n  <span class="token string">"whitelist.json"</span><span class="token punctuation">,</span>\n  <span class="token string">"world"</span><span class="token punctuation">,</span>\n  <span class="token string">"world_nether"</span><span class="token punctuation">,</span>\n  <span class="token string">"world_the_end"</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> resolvedBackupFiles <span class="token operator">=</span> <span class="token constant">BACKUP_FILES</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"原生 Node 并没有提供打包压缩的方法，为了避免引入其它的依赖，考虑使用系统自带的 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">tar</code>'}})," 命令实现。为此，需要使用到 Node 的 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">child_process</code>'}}),"："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"child_process"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"util"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> exec <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>child_process<span class="token punctuation">.</span>exec<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"现在，可以通过 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">exec()</code>'}})," 来执行系统上的命令了。可编写文件备份方法如下："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> backupFilename <span class="token operator">=</span> <span class="token function">genFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 省略文件名生成方法...</span>\n<span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">tar -czf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>backupFilename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resolvedBackupFiles<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"需注意的是，我们在执行 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">tar</code>'}})," 命令时，常传入 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">-v</code>'}})," 标识，在屏幕上打印压缩或解压的文件列表（很酷）。但是，在使用 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">exec()</code>'}})," 时，子进程会将命令的标准输出或错误一并返回，如果文件数量过多，标准输出超过预设大小，会导致报错：",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">RangeError [ERR_CHILD_PROCESS_STDIO_MAXBUFFER]: stdout maxBuffer length exceeded</code>'}}),"。用 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">child_process.spawn()</code>'}})," 可以避免这个问题，但考虑到我们并不在乎压缩命令的执行过程，最好的办法就是去掉 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">-v</code>'}})," 标识。"),"\n",p.createElement(a.p,null,"到此为止，已经能够将所需的 Minecraft 服务器存档文件打包压缩，备份到系统本地了。"),"\n",p.createElement(a.h3,null,"移除历史备份文件"),"\n",p.createElement(a.p,null,"即使每天执行一次备份任务，长久累积也将占用大量的空间，更何况一个备份的大小已然几百 MB 起步。因此需考虑本地保留的备份文件数量，及时移除历史的备份文件。"),"\n",p.createElement(a.p,null,"首先需要获取备份目录下已有的备份文件信息："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> filenames <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>backupDir<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> backupFileList <span class="token operator">=</span> filenames<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n  fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>backupDir<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"支持指定保存的备份文件数量，得到需要移除的文件列表："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">BACKUP_MAX_NUM</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">// 保留最新的 N 个备份文件，此处为 7 个</span>\n\n<span class="token keyword">const</span> backupFiles <span class="token operator">=</span> backupFileList\n  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> file<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> b<span class="token punctuation">.</span>mtimeMs <span class="token operator">-</span> a<span class="token punctuation">.</span>mtimeMs<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> oldBackupFiles <span class="token operator">=</span> backupFiles<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token constant">BACKUP_MAX_NUM</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"移除这些文件即可："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> oldBackupFilenames <span class="token operator">=</span> oldBackupFiles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> file<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>\noldBackupFilenames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  fs<span class="token punctuation">.</span><span class="token function">rmSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>backupDir<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"这样在每次执行脚本时，都会自动清理掉本地多余的备份文件，保证文件系统容量健康。"),"\n",p.createElement(a.h2,null,"设置定时任务"),"\n",p.createElement(a.p,null,"基于 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">crontab</code>'}})," 实现定时任务调度，使用 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">crontab -e</code>'}})," 命令编写任务列表："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token number">0</span> <span class="token number">4</span> * * * <span class="token builtin class-name">cd</span> /path/to/mc-server <span class="token operator">&amp;&amp;</span> <span class="token function">node</span> /path/to/backup-mc-server.js</code></pre></div>'}}),"\n",p.createElement(a.p,null,"笔者发现定时任务实际执行时间是正午 12 点，而非预期的凌晨 4 点，推测系服务器使用的 UTC 时区导致。"),"\n",p.createElement(a.p,null,"尽管配置了 OpenWRT 的时区为 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">Asia/Shanghai</code>'}}),"，但仍然不生效："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">date</span> <span class="token parameter variable">-R</span>\nWed, <span class="token number">15</span> May <span class="token number">2024</span> 07:00:00 +0000</code></pre></div>'}}),"\n",p.createElement(a.p,null,"笔者通过安装 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">zoneinfo-asia</code>'}})," 解决了问题："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ opkg update\n$ opkg <span class="token function">install</span> zoneinfo-asia\nInstalling zoneinfo-asia <span class="token punctuation">(</span>2023c-2<span class="token punctuation">)</span> to root<span class="token punctuation">..</span>.\nDownloading https://mirrors.vsean.net/openwrt/releases/23.05.2/packages/x86_64/packages/zoneinfo-asia_2023c-2_x86_64.ipk\nInstalling zoneinfo-core <span class="token punctuation">(</span>2023c-2<span class="token punctuation">)</span> to root<span class="token punctuation">..</span>.\nDownloading https://mirrors.vsean.net/openwrt/releases/23.05.2/packages/x86_64/packages/zoneinfo-core_2023c-2_x86_64.ipk\nConfiguring zoneinfo-core.\nConfiguring zoneinfo-asia.\n$ /etc/init.d/system restart\n$ <span class="token function">date</span> <span class="token parameter variable">-R</span>\nWed, <span class="token number">15</span> May <span class="token number">2024</span> <span class="token number">15</span>:00:00 +0800</code></pre></div>'}}),"\n",p.createElement(a.p,null,"这样，在北京时间凌晨 4 点，系统将自动调用备份脚本。如果彼时仍有用户在游玩，脚本可能会运行失败，可以在执行脚本之前关闭 Minecraft 服务器，完成后重新启动。"),"\n",p.createElement(a.h2,null,"（可选）通过 Alist 上传到云端"),"\n",p.createElement(a.blockquote,null,"\n",p.createElement(a.p,null,"为了这盘醋，包了这顿饺子。"),"\n"),"\n",p.createElement(a.p,null,"万一硬盘挂了呢？笔者认为保存在软路由本地丝毫没有安全感，于是决定在备份后即时上传到云端。"),"\n",p.createElement(a.p,null,"笔者已经在软路由上安装并配置好了 Alist，连接到了自己的 OneDrive。下面将进一步实现上传备份文件到 OneDrive 或任何其他的云盘。"),"\n",p.createElement(a.h3,null,"获取 Alist token"),"\n",p.createElement(a.p,null,"调用 Alist 接口时需要传入 token，因此首先需要获取 token："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">ALIST_ADDRESS</span> <span class="token operator">=</span> <span class="token string">"YOUR_ALIST_ADDRESS"</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">ALIST_USERNAME</span> <span class="token operator">=</span> <span class="token string">"YOUR_ALIST_USERNAME"</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">ALIST_PASSWORD</span> <span class="token operator">=</span> <span class="token string">"YOUR_ALIST_PASSWORD"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nheaders<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> raw <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token constant">ALIST_USERNAME</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token constant">ALIST_PASSWORD</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> requestOptions <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>\n  headers<span class="token punctuation">,</span>\n  <span class="token literal-property property">body</span><span class="token operator">:</span> raw<span class="token punctuation">,</span>\n  <span class="token literal-property property">redirect</span><span class="token operator">:</span> <span class="token string">"follow"</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">ALIST_ADDRESS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/auth/login</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> requestOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> resText <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> resObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>resText<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> alistToken <span class="token operator">=</span> resObj<span class="token punctuation">.</span>data<span class="token punctuation">.</span>token<span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.h3,null,"上传备份文件到云盘"),"\n",p.createElement(a.p,null,"现在，编写 Alist 上传文件的方法："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">ALIST_BACKUP_DIR</span> <span class="token operator">=</span> <span class="token string">"/path/to/mc-backups"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> backupFile <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>backupFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> backupFileBasename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>backupFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> alistFilePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">ALIST_BACKUP_DIR</span><span class="token punctuation">,</span> backupFileBasename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nheaders<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span> alistToken<span class="token punctuation">)</span><span class="token punctuation">;</span>\nheaders<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"As-Task"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nheaders<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>backupFile<span class="token punctuation">.</span>size<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nheaders<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"File-Path"</span><span class="token punctuation">,</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>alistFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fileStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>backupFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> requestOptions <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"PUT"</span><span class="token punctuation">,</span>\n  headers<span class="token punctuation">,</span>\n  <span class="token literal-property property">body</span><span class="token operator">:</span> fileStream<span class="token punctuation">,</span>\n  <span class="token literal-property property">redirect</span><span class="token operator">:</span> <span class="token string">"follow"</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">duplex</span><span class="token operator">:</span> <span class="token string">"half"</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">ALIST_ADDRESS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/fs/put</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> requestOptions<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"通过 ",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">headers.append("As-Task", "true");</code>'}})," 将文件上传设为任务，避免阻塞其它命令的执行。在 Alist 管理后台可以看到上传的进度："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/56bd3a0983c8f0f3ca6a30b43eb440df/5dded/upload-to-alist.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 21.153846153846153%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAy0lEQVR42nXOzXKDIBQFYJ8hP2IRFFTkR5k0McF02kW26fu/z+mVTKerLr6Bc8/A3IKPZ/CwggsBLhvowcBYh360eBMy4xvqfvO/lEPh4wkdPa5qmT9J9zuW24rTZcH+yEiZ7fJJuWQ4sOql/LMnO8ZQWO+guxacVxjDjPT1wGC2LS22zgYPFwKmGOG8R2cGiFaSBkKprCaaGNGgaOMnhvSNg34H7yf4jyd0XKHmhHa6QU0p3/VMM8pNuEK6BdKeIXtHLGpi+xEXpfEDQfpv4fwGtJQAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="upload-to-alist"\n        title=""\n        src="/static/56bd3a0983c8f0f3ca6a30b43eb440df/39c09/upload-to-alist.png"\n        srcset="/static/56bd3a0983c8f0f3ca6a30b43eb440df/680fe/upload-to-alist.png 156w,\n/static/56bd3a0983c8f0f3ca6a30b43eb440df/17474/upload-to-alist.png 312w,\n/static/56bd3a0983c8f0f3ca6a30b43eb440df/39c09/upload-to-alist.png 624w,\n/static/56bd3a0983c8f0f3ca6a30b43eb440df/6d2da/upload-to-alist.png 936w,\n/static/56bd3a0983c8f0f3ca6a30b43eb440df/5a791/upload-to-alist.png 1248w,\n/static/56bd3a0983c8f0f3ca6a30b43eb440df/5dded/upload-to-alist.png 1588w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",p.createElement(a.p,null,"到这一步，执行备份脚本时，将自动把新生成的备份文件上传到云盘。"),"\n",p.createElement(a.h3,null,"移除云盘历史备份文件"),"\n",p.createElement(a.p,null,"同样，云盘的空间也不是无限的，我们采取与移除本地历史备份文件相同的策略。"),"\n",p.createElement(a.p,null,"首先获取云盘上已有的备份文件列表："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nheaders<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span> alistToken<span class="token punctuation">)</span><span class="token punctuation">;</span>\nheaders<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> raw <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token constant">ALIST_BACKUP_DIR</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> requestOptions <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">headers</span><span class="token operator">:</span> headers<span class="token punctuation">,</span>\n  <span class="token literal-property property">body</span><span class="token operator">:</span> raw<span class="token punctuation">,</span>\n  <span class="token literal-property property">redirect</span><span class="token operator">:</span> <span class="token string">"follow"</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">ALIST_ADDRESS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/fs/list</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> requestOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> resText <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> resObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>resText<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> backupDirFileList <span class="token operator">=</span> resObj<span class="token punctuation">.</span>data<span class="token punctuation">.</span>content <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"获取需要移除的备份文件列表："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> backupFiles <span class="token operator">=</span> backupDirFileList\n  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span>file<span class="token punctuation">.</span>is_dir<span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>modified <span class="token operator">></span> b<span class="token punctuation">.</span>modified<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>modified <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>modified<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 由于新的备份文件正在上传中，因此应当保留最新的 BACKUP_MAX_NUM - 1 个备份文件</span>\n<span class="token keyword">const</span> oldBackupFiles <span class="token operator">=</span> backupFiles<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token constant">BACKUP_MAX_NUM</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> oldBackupFilenames <span class="token operator">=</span> oldBackupFiles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> file<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"最后，移除这些文件即可："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nheaders<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span> alistToken<span class="token punctuation">)</span><span class="token punctuation">;</span>\nheaders<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> raw <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token literal-property property">names</span><span class="token operator">:</span> oldBackupFilenames<span class="token punctuation">,</span>\n  <span class="token literal-property property">dir</span><span class="token operator">:</span> <span class="token constant">ALIST_BACKUP_DIR</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> requestOptions <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">headers</span><span class="token operator">:</span> headers<span class="token punctuation">,</span>\n  <span class="token literal-property property">body</span><span class="token operator">:</span> raw<span class="token punctuation">,</span>\n  <span class="token literal-property property">redirect</span><span class="token operator">:</span> <span class="token string">"follow"</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">ALIST_ADDRESS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/fs/remove</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> requestOptions<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"这样在每次执行脚本时，云盘的系统容量健康也得到了保障。"),"\n",p.createElement(a.h2,null,"结尾"),"\n",p.createElement(a.p,null,"稍微润色优化一下备份脚本，执行的输出结果如下："),"\n",p.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">node</span> /path/to/backup-mc-server.js\nCreate <span class="token function">dir</span> <span class="token variable"><span class="token variable">`</span>/path/to/mc-server/backups<span class="token variable">`</span></span> successfully.\nCreating backup <span class="token function">file</span> <span class="token variable"><span class="token variable">`</span>/path/to/mc-server/backups/backup-mcserver-2024-05-11-11-10-51.tar.gz<span class="token variable">`</span></span> <span class="token punctuation">..</span>.\nCreate backup <span class="token function">file</span> <span class="token variable"><span class="token variable">`</span>/path/to/mc-server/backups/backup-mcserver-2024-05-11-11-10-51.tar.gz<span class="token variable">`</span></span> successfully.\nLog <span class="token keyword">in</span> alist successfully.\nStart upload task successfully: <span class="token builtin class-name">local</span> <span class="token function">file</span> <span class="token variable"><span class="token variable">`</span>/path/to/mc-server/backups/backup-mcserver-2024-05-11-11-10-51.tar.gz<span class="token variable">`</span></span> <span class="token operator">==</span><span class="token operator">></span> alist <span class="token variable"><span class="token variable">`</span>/path/to/alist/backups/backup-mcserver-2024-05-11-11-10-51.tar.gz<span class="token variable">`</span></span><span class="token builtin class-name">.</span>\n\n<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>\nBackup <span class="token function">file</span> is generated: <span class="token boolean">true</span>\nOld backup files are removed: <span class="token boolean">true</span>\nTask that upload backup <span class="token function">file</span> to alist is started: <span class="token boolean">true</span>\nOld backup files <span class="token keyword">in</span> alist are removed: <span class="token boolean">true</span>\n<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span></code></pre></div>'}}),"\n",p.createElement(a.p,null,"啊，满满的安心感！收工。"))}var o=function(n){void 0===n&&(n={});const{wrapper:a}=Object.assign({},(0,t.R)(),n.components);return a?p.createElement(a,n,p.createElement(e,n)):e(n)},c=s(197),l=s(4353),u=s.n(l),r=s(4794),i=s(6947),k=s(4017),d=s(1042),g=s(1038);const m={a:n=>{let{href:a="",children:s}=n;const t=!(null!=a&&a.startsWith("#")),e=t?a:`#${encodeURIComponent(a.slice(1))}`;return p.createElement("a",{href:e,target:t?"_blank":void 0,rel:"noreferrer"},s)},img:n=>{const{alt:a="The author is too lazy to give an alt",src:s,...t}=n;return p.createElement("a",{href:s,"data-fancybox":"gallery","data-caption":a},p.createElement("img",Object.assign({src:s,alt:a},t)))},Card:i.A,Link:r.Link},f=n=>{let{children:a,data:s}=n;const{mdx:{frontmatter:{title:e,date:o,updated:l,categories:r,tags:i,timeliness:d=!0}}}=s,f=p.useRef(null),y=u()(o),h=l?u()(l):y,b=u()().diff(h,"days");return p.useEffect((()=>{var n;const a=null===(n=f.current)||void 0===n?void 0:n.querySelectorAll("a.gatsby-resp-image-link");return null==a||a.forEach((n=>{const a=n.children.item(1);n.setAttribute("data-fancybox","gallery"),n.setAttribute("data-caption",a.alt)})),c.lX.bind("[data-fancybox]"),()=>c.lX.unbind("[data-fancybox]")}),[]),p.createElement("div",{className:"mx-auto flex max-w-xl flex-col gap-y-12"},p.createElement("div",{className:"flex flex-col gap-4"},(null==r?void 0:r.length)&&p.createElement(k.A,{name:r[0],className:"item-selectable"}),p.createElement("h1",{className:"text-3xl font-bold"},e),p.createElement("div",{className:"item-secondary flex flex-col gap-2 lg:flex-row"},o&&p.createElement("span",{title:`首次发布于：${y.toString()}\n最后更新于：${h.toString()}`},y.format("MM 月 DD 日 YYYY 年")),(null==i?void 0:i.length)&&p.createElement("div",{className:"flex flex-1 flex-wrap gap-2 lg:before:content-['•']"},i.map((n=>p.createElement(g.A,{key:n,name:n,className:"item-secondary item-selectable"})))))),p.createElement("article",{ref:f,className:"heti post-entry"},d&&b>365&&p.createElement("blockquote",{className:"border-l-4 border-orange-400"},"这是一篇",p.createElement("strong",null,"最后更新于 ",b," 天前"),"的博客，内容可能随着时间的推移而变得不再适用，建议您仔细评估信息的有效性。"),p.createElement(t.x,{components:m},a)))},y=n=>{let{data:a}=n;return p.createElement(d.A,{title:String(a.mdx.frontmatter.title)})};function h(n){return p.createElement(f,n,p.createElement(o,n))}}}]);
//# sourceMappingURL=component---src-templates-post-tsx-content-file-path-blog-posts-backup-mc-server-mdx-6ce634c6c44b4e0f24f7.js.map