"use strict";(self.webpackChunkhomepage=self.webpackChunkhomepage||[]).push([[7497],{6422:function(n,a,s){s.r(a),s.d(a,{Head:function(){return E},default:function(){return y}});var t=s(8453),e=s(6540);function p(n){const a=Object.assign({p:"p",blockquote:"blockquote",h2:"h2",a:"a",span:"span",strong:"strong"},(0,t.R)(),n.components);return e.createElement(e.Fragment,null,e.createElement(a.p,null,"请注意，本文讨论的“动态加密”是指后端不直接返回视频文件的密钥，而非后端动态生成新的密钥与播放列表的分片文件。"),"\n",e.createElement(a.p,null,"但正如资深的程序员所说的那样："),"\n",e.createElement(a.blockquote,null,"\n",e.createElement(a.p,null,"任何客户端的加解密都是不安全的。我们都应该认为，任何在客户端进行的加解密操作都可能被逆向工程或破解。"),"\n"),"\n",e.createElement(a.p,null,"如果你能够在浏览器中播放视频文件，那么你就应该能够下载它到本地。"),"\n",e.createElement(a.p,null,"本文仅供学习和研究使用，使用请遵守相关法律法规和网站服务条款。本文将隐去测试站点的一切信息。不同命令行解释器的语法可能有所不同，请注意甄别更替。"),"\n",e.createElement(a.h2,null,"前置准备"),"\n",e.createElement(a.p,null,"笔者依赖 ",e.createElement(a.a,{href:"https://ffmpeg.org/"},"ffmpeg")," 来下载和合并视频文件。请确保你已经安装了 ffmpeg，并且将其可执行文件路径添加到系统的 Path 环境变量中，以便可以在命令行中访问它。"),"\n",e.createElement(a.h2,null,"获取 m3u8 播放列表"),"\n",e.createElement(a.p,null,"在浏览器控制台的“网络”标签页中，过滤找到获取 m3u8 播放列表的请求，它通常以 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.m3u8</code>'}})," 结尾。可以在请求的“预览”标签页中看到类似如下的内容："),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="m3u8"><pre class="language-m3u8"><code class="language-m3u8">#EXTM3U\n#EXT-X-VERSION:3\n#EXT-X-TARGETDURATION:12\n#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-PLAYLIST-TYPE:VOD\n#EXT-X-KEY:METHOD=AES-128,URI=&quot;https://path/to/key/${uid}&quot;,IV=0x00000000000000000000000000000000\n#EXTINF:12.500000,\nvideo-00000.ts\n#EXTINF:12.500000,\nvideo-00001.ts\n#EXTINF:3.550000,\nvideo-00002.ts\n#EXT-X-ENDLIST</code></pre></div>'}}),"\n",e.createElement(a.p,null,"将它保存到本地文件中，例如命名为 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">playlist.m3u8</code>'}}),"。"),"\n",e.createElement(a.p,null,"当然，笔者更推荐使用命令行的方式下载 m3u8 播放列表。使用 CMD 时，命令形如："),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="command"><pre class="language-command"><code class="language-command">curl ^&quot;https://path/to/playlist.m3u8^&quot; ^\n  -o ^&quot;playlist.m3u8^&quot; ^\n  -H ^&quot;accept: */*^&quot; ^\n  -H ^&quot;origin: https://origin^&quot; ^\n  -H ^&quot;referer: https://origin/^&quot; ^\n  -H ^&quot;sec-ch-ua: ^\\^&quot;Not;A=Brand^\\^&quot;;v=^\\^&quot;99^\\^&quot;, ^\\^&quot;Google Chrome^\\^&quot;;v=^\\^&quot;139^\\^&quot;, ^\\^&quot;Chromium^\\^&quot;;v=^\\^&quot;139^\\^&quot;^&quot; ^\n  -H ^&quot;sec-ch-ua-mobile: ?0^&quot; ^\n  -H ^&quot;sec-ch-ua-platform: ^\\^&quot;Windows^\\^&quot;^&quot; ^\n  -H ^&quot;sec-fetch-dest: empty^&quot; ^\n  -H ^&quot;sec-fetch-mode: cors^&quot; ^\n  -H ^&quot;sec-fetch-site: cross-site^&quot; ^\n  -H ^&quot;user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36^&quot; ^\n  -H ^&quot;x-auth: m3bDiQ9IPHr54TdVjgUNJmLQLmmWJFTSOhjR0E8Y9kU^&quot;</code></pre></div>'}}),"\n",e.createElement(a.p,null,"请根据实际情况替换 URL 和请求标头。一般来说必要的请求标头是防止被服务器拒绝的 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">referer</code>'}}),"，和用于用户鉴权的 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">cookie</code>'}}),"（本例中为服务端自定义的 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">x-auth</code>'}})," 字段），其它标头用于模拟请求来自于健康的浏览器。当然，直接在“网络”标签页里复制请求内容准没有错。"),"\n",e.createElement(a.p,null,"特别的，可以将请求头单独保存在一个文本文件里，方便后续其它请求使用。例如命名为 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">headers.txt</code>'}}),"："),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="txt"><pre class="language-txt"><code class="language-txt">accept: */*\norigin: https://origin\nreferer: https://origin/\nsec-ch-ua: "Not;A=Brand";v="99", "Google Chrome";v="139", "Chromium";v="139"\nsec-ch-ua-mobile: ?0\nsec-ch-ua-platform: "Windows"\nsec-fetch-dest: empty\nsec-fetch-mode: cors\nsec-fetch-site: cross-site\nuser-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36\nx-auth: m3bDiQ9IPHr54TdVjgUNJmLQLmmWJFTSOhjR0E8Y9kU</code></pre></div>'}}),"\n",e.createElement(a.p,null,"CMD 没有简易的读取文件并拼接命令的语法，但 PowerShell 和其它命令行解释器有相应的工具函数可以读取 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">headers.txt</code>'}})," 进而拼装 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">curl</code>'}})," 请求，不再赘述。"),"\n",e.createElement(a.h2,null,"获取密钥"),"\n",e.createElement(a.p,null,"在下载得到的 m3u8 播放列表中，有一行类似如下的内容："),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">#EXT-X-KEY:METHOD=AES-128,URI="https://path/to/key/${uid}",IV=0x00000000000000000000000000000000</code></pre></div>'}}),"\n",e.createElement(a.p,null,"它表示视频分片文件基于 AES-128 加密，其中 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">URI</code>'}})," 指向的就是密钥的地址，",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">IV</code>'}})," 是初始化向量。理论上我们只需要再使用 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">curl</code>'}})," 命令下载这个密钥文件到本地，然后对应修改 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">URI</code>'}})," 字段为本地文件路径即可。"),"\n",e.createElement(a.p,null,"但本文想要探讨的正是另外一种情况：",e.createElement(a.strong,null,e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">URI</code>'}})," 指向的并不是直接可用的密钥，而是一个加密后的密钥，我们需要基于约定好的算法解密得到真正的密钥。")),"\n",e.createElement(a.p,null,"那么，这个“约定好的算法”我们要如何得知呢？答案就是去找！去分析网站的前端代码，去找出它是如何解密并获取真正的密钥的！通常来说，这个解密算法会被打包混淆在某个 JavaScript 文件里。"),"\n",e.createElement(a.p,null,"以笔者测试的站点为例，它首先会调用签名接口 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://path/to/key/${uid}/sign</code>'}}),"，响应值为一个 JSON 对象，包含一个随机生成的参数 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">nonce</code>'}}),"："),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"nonce"</span><span class="token operator">:</span> <span class="token string">"1757046701749:hC45ZHCJ"</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",e.createElement(a.p,null,"接着用某种算法生成的参数 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">sign</code>'}}),"，将它和刚刚得到的参数 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">nonce</code>'}})," 一齐调用获取密钥的接口 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https://path/to/key/${uid}?nonce=${nonce}&amp;sign=${sign}</code>'}}),"，响应值是另一个 JSON 对象，包含您可能以为的视频密钥："),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"j3Nmzd7BabJRRKCKm16NPrbmEaEyVhZZr4mamyUqjgo="</span>\n<span class="token punctuation">}</span></code></pre></div>'}}),"\n",e.createElement(a.p,null,"笔者也很高兴，看到 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">key</code>'}})," 字段的值很像是 Base64 编码后的字符串，解码后肯定正好是需要的 128 位的 AES 密钥。但拿去解密却报错说字符串并非 Base64 编码，说明它使用了另一种加密方案。"),"\n",e.createElement(a.p,null,"这样，笔者就不得不去翻找前端代码了。在前面的过程里，笔者知道与视频播放相关的代码调用了 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">/sign</code>'}})," 接口，所以就从这个关键字入手，搜索打包混淆后的 JavaScript 代码，找到了如下代码片段："),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">return</span> a<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>\n      <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>prev <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// ...</span>\n        <span class="token keyword">case</span> <span class="token number">28</span><span class="token operator">:</span>\n          <span class="token keyword">return</span> <span class="token punctuation">(</span>\n            <span class="token punctuation">(</span>_ <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token punctuation">(</span>b <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">keys\\/.*"</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// b 为 m3u8 文件里 #EXT-X-KEY:URI 的 ${uid} 部分</span>\n            <span class="token punctuation">(</span><span class="token constant">T</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// T 为截取后的 b</span>\n            <span class="token punctuation">(</span>e<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            c<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>_ <span class="token operator">+</span> <span class="token string">"/sign"</span><span class="token punctuation">)</span>\n          <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">case</span> <span class="token number">33</span><span class="token operator">:</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>\n            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">S</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>sent<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token constant">S</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>w <span class="token operator">=</span> k<span class="token punctuation">.</span>nonce<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// w 为调用 /sign 接口时随机生成的参数 ${nonce}</span>\n          <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">38</span><span class="token punctuation">;</span>\n            <span class="token keyword">break</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">abrupt</span><span class="token punctuation">(</span><span class="token string">"return"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">case</span> <span class="token number">38</span><span class="token operator">:</span>\n          <span class="token keyword">return</span> <span class="token punctuation">(</span>\n            <span class="token punctuation">(</span><span class="token constant">C</span> <span class="token operator">=</span> h<span class="token punctuation">.</span>default\n              <span class="token punctuation">.</span><span class="token constant">MD5</span><span class="token punctuation">(</span>w <span class="token operator">+</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token comment">// 拼接 w 和 T 后进行 MD5 哈希</span>\n              <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n              <span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 截取前 16 个字符</span>\n            <span class="token punctuation">(</span><span class="token constant">E</span> <span class="token operator">=</span> h<span class="token punctuation">.</span>default<span class="token punctuation">.</span>enc<span class="token punctuation">.</span>Utf8<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 将字符串 C 按 UTF-8 编码转换为二进制数据，作为后续 AES 加解密使用的对称密钥</span>\n            <span class="token punctuation">(</span>x <span class="token operator">=</span> _ <span class="token operator">+</span> <span class="token string">"?nonce="</span> <span class="token operator">+</span> w <span class="token operator">+</span> <span class="token string">"&amp;sign="</span> <span class="token operator">+</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token punctuation">(</span>e<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">43</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            c<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">// 将前端生成的密钥发送给后端，后端对视频密钥进行加密</span>\n          <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">case</span> <span class="token number">43</span><span class="token operator">:</span>\n          <span class="token punctuation">(</span><span class="token constant">A</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>sent<span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token punctuation">(</span><span class="token constant">P</span> <span class="token operator">=</span> <span class="token constant">A</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 后端返回加密后的视频密钥</span>\n            <span class="token punctuation">(</span><span class="token constant">O</span> <span class="token operator">=</span> <span class="token constant">P</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// O 就是经过加密后的视频密钥</span>\n            <span class="token comment">// 调用 AES 模块的解密方法，对视频密钥进行解密</span>\n            <span class="token punctuation">(</span><span class="token constant">L</span> <span class="token operator">=</span> h<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token constant">AES</span><span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>\n              <span class="token constant">O</span><span class="token punctuation">,</span> <span class="token comment">// 待解密的视频密钥</span>\n              <span class="token constant">E</span><span class="token punctuation">,</span> <span class="token comment">// 前面的代码里前端生成的密钥</span>\n              <span class="token punctuation">{</span>\n                <span class="token literal-property property">mode</span><span class="token operator">:</span> h<span class="token punctuation">.</span>default<span class="token punctuation">.</span>mode<span class="token punctuation">.</span><span class="token constant">ECB</span><span class="token punctuation">,</span> <span class="token comment">// 指定加密模式为 ECB（电子密码本模式）</span>\n                <span class="token literal-property property">padding</span><span class="token operator">:</span> h<span class="token punctuation">.</span>default<span class="token punctuation">.</span>pad<span class="token punctuation">.</span>Pkcs7<span class="token punctuation">,</span> <span class="token comment">// 指定填充方式为 PKCS#7 填充</span>\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token constant">L</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>default<span class="token punctuation">.</span>enc<span class="token punctuation">.</span>Utf8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// j 即为我们解密视频分片所需要的视频密钥</span>\n            <span class="token function">n</span><span class="token punctuation">(</span><span class="token function">i</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">case</span> <span class="token number">49</span><span class="token operator">:</span>\n        <span class="token keyword">case</span> <span class="token string">"end"</span><span class="token operator">:</span>\n          <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  e<span class="token punctuation">,</span>\n  <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>'}}),"\n",e.createElement(a.p,null,"从上面的代码可知，第二次请求时携带的参数 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">sign</code>'}})," 其实就是用于加密视频密钥所使用的另一个 AES 密钥。而整个过程就是站点为了不让视频密钥直接暴露在网络请求里而设计的一个“动态加密”方案。"),"\n",e.createElement(a.p,null,"那末，获取代码片段里 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">j</code>'}})," 变量的值，就是笔者想要的视频密钥了！终极的自动化方案肯定是编写脚本来实现从发送请求到拼接字符串最后解密的全过程，但笔者懒得折腾，就直接在源代码里打断点完成了："),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 624px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/c2ab0db6ec0d24a6857370f0aa67bf9d/898f6/breakpoint.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 40.38461538461539%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABYklEQVR42nWSW0/CQBCF+w9M0EdfjLL37YXeS1tAaEEoIb764o/yBx9nCzEG8eHL2UyzZ2fO1BNSQmsDpRSUVEj8CtW8RVX4yGOONJyhimdo8xxtkaPJspG2KFAnCZo0RU20VHPqCSGhtCZTBTmaSyRJhm4ZYllxesQgMBq+tQhGzEUtfOO+mbO6GikZCurut6FGEERoSoNFKdHkDHXBSKfUNV0KQ0iahjEGTncZ5z/q8Dhn53HJVF5wXQ5rNna520Q4rBWOncaetMzUaMBpslt4Oqpgg4TaZfA1Q+gLZC6vtkB33GE17LE5DXjd79BWFEP5jCoV0HIKq/7i1R9fyPpPdNkd3soJhvoJ29MG7/0LDotH9MUEffmAbXlPTHCYEzWdqX5Nn09chjQubdll6Lac2xUWaYks9GGMgDUSQvALNCo/48638Nxv47bscnQLMcYi1jkimyKNJWHGbP4zuDb8BpKd+PtjjokAAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="获取视频密钥"\n        title=""\n        src="/static/c2ab0db6ec0d24a6857370f0aa67bf9d/39c09/breakpoint.png"\n        srcset="/static/c2ab0db6ec0d24a6857370f0aa67bf9d/680fe/breakpoint.png 156w,\n/static/c2ab0db6ec0d24a6857370f0aa67bf9d/17474/breakpoint.png 312w,\n/static/c2ab0db6ec0d24a6857370f0aa67bf9d/39c09/breakpoint.png 624w,\n/static/c2ab0db6ec0d24a6857370f0aa67bf9d/898f6/breakpoint.png 798w"\n        sizes="(max-width: 624px) 100vw, 624px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",e.createElement(a.p,null,"可知，解密视频分片文件所需的视频密钥为 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">a1c18f6619b84605</code>'}}),"。"),"\n",e.createElement(a.h2,null,"下载并拼装视频文件"),"\n",e.createElement(a.p,null,"剩下的工作就非常简单了，将视频密钥保存为本地的文件 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">key.bin</code>'}}),"，对应修改 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">playlist.m3u8</code>'}})," 里 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">#EXT-X-KEY</code>'}})," 行的 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">URI</code>'}})," 字段为本地文件路径："),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="m3u8"><pre class="language-m3u8"><code class="language-m3u8">#EXT-X-KEY:METHOD=AES-128,URI=&quot;key.bin&quot;,IV=0x00000000000000000000000000000000</code></pre></div>'}}),"\n",e.createElement(a.p,null,"然后将 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">playlist.m3u8</code>'}})," 里的所有视频分片文件 URL 修改为完整的 URL 地址："),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="m3u8"><pre class="language-m3u8"><code class="language-m3u8">#EXTINF:12.500000,\nhttps://path/to/video-00000.ts\n#EXTINF:12.500000,\nhttps://path/to/video-00001.ts\n#EXTINF:3.550000,\nhttps://path/to/video-00002.ts\n#EXT-X-ENDLIST</code></pre></div>'}}),"\n",e.createElement(a.p,null,"一切就绪，执行 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ffmpeg</code>'}})," 命令下载并拼装视频文件："),"\n",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">ffmpeg <span class="token parameter variable">-protocol_whitelist</span> <span class="token string">"file,crypto,data,http,https,tcp,tls"</span> <span class="token parameter variable">-allowed_extensions</span> ALL <span class="token parameter variable">-i</span> playlist.m3u8 <span class="token parameter variable">-c</span> copy output.mp4</code></pre></div>'}}),"\n",e.createElement(a.p,null,"其中，ffmpeg 默认只支持从安全的协议（包括 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">file,crypto,data</code>'}}),"）获取视频分片文件，不支持 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">https</code>'}})," 等其它协议，因此设置了命令行参数 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">-protocol_whitelist "file,crypto,data,http,https,tcp,tls"</code>'}}),"；同理，ffmpeg 默认只支持读取 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.ts</code>'}})," 和 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">.m3u8</code>'}})," 等常见扩展名的文件，因此设置了命令行参数 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">-allowed_extensions ALL</code>'}})," 来允许读取秘钥文件 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">key.bin</code>'}}),"。"),"\n",e.createElement(a.p,null,"执行完成后，当前目录下就会生成合并后的 ",e.createElement(a.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">output.mp4</code>'}})," 文件。可喜可贺，可喜可贺！"))}var o=function(n){void 0===n&&(n={});const{wrapper:a}=Object.assign({},(0,t.R)(),n.components);return a?e.createElement(a,n,e.createElement(p,n)):p(n)},c=s(197),l=s(4353),u=s.n(l),r=s(4794),i=s(6947),k=s(4017),m=s(1042),g=s(1038);const d={a:n=>{let{href:a="",children:s}=n;const t=!(null!=a&&a.startsWith("#")),p=t?a:`#${encodeURIComponent(a.slice(1))}`;return e.createElement("a",{href:p,target:t?"_blank":void 0,rel:"noreferrer"},s)},img:n=>{const{alt:a="The author is too lazy to give an alt",src:s,...t}=n;return e.createElement("a",{href:s,"data-fancybox":"gallery","data-caption":a},e.createElement("img",Object.assign({src:s,alt:a},t)))},Card:i.A,Link:r.Link},h=n=>{let{children:a,data:s}=n;const{mdx:{fields:{isDraft:p},frontmatter:{title:o,date:l,updated:r,categories:i,tags:m,timeliness:h}}}=s,E=e.useRef(null),y=u()(l),b=r?u()(r):y,f=u()().diff(b,"days");return e.useEffect((()=>{var n;const a=null===(n=E.current)||void 0===n?void 0:n.querySelectorAll("a.gatsby-resp-image-link");return null==a||a.forEach((n=>{const a=n.children.item(1);n.setAttribute("data-fancybox","gallery"),n.setAttribute("data-caption",a.alt)})),c.lX.bind("[data-fancybox]"),()=>c.lX.unbind("[data-fancybox]")}),[]),e.createElement("div",{className:"mx-auto flex max-w-xl flex-col gap-y-12"},e.createElement("div",{className:"flex flex-col gap-4"},(null==i?void 0:i.length)&&e.createElement(k.A,{name:i[0],className:"item-selectable"}),e.createElement("h1",{className:"text-3xl font-bold"},o),e.createElement("div",{className:"item-secondary flex flex-col gap-2 lg:flex-row"},l&&e.createElement("span",{title:`首次发布于：${y.toString()}\n最后更新于：${b.toString()}`},y.format("MM 月 DD 日 YYYY 年")),(null==m?void 0:m.length)&&e.createElement("div",{className:"flex flex-1 flex-wrap gap-2 lg:before:content-['•']"},m.map((n=>e.createElement(g.A,{key:n,name:n,className:"item-secondary item-selectable"})))))),e.createElement("article",{ref:E,className:"heti post-entry"},p&&e.createElement("blockquote",{className:"!border-red-400"},"这是一篇",e.createElement("strong",null,"未正式发布"),"的博客，内容可能尚未撰写完全或存在一些纰漏，建议您仔细评估信息的有效性。"),!1!==h&&f>365&&e.createElement("blockquote",{className:"!border-orange-400"},"这是一篇",e.createElement("strong",null,"最后更新于 ",f," 天前"),"的博客，内容可能随着时间的推移而变得不再适用，建议您仔细评估信息的有效性。"),e.createElement(t.x,{components:d},a)))},E=n=>{let{data:a}=n;return e.createElement(m.A,{title:String(a.mdx.frontmatter.title)})};function y(n){return e.createElement(h,n,e.createElement(o,n))}}}]);
//# sourceMappingURL=component---src-templates-post-tsx-content-file-path-blog-posts-download-encrypted-m-3-u-8-mdx-3546553e8a784aa9c6ef.js.map